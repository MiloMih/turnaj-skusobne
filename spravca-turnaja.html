<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Správca turnaja</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="style.css">

<style>
        /* --- General Styles --- */
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-top: 20px;
            margin-bottom: 20px; /* Added margin-bottom for separation */
        }

        h2 {
            margin-top: 0; /* Reset margin-top, controlled by section padding */
            margin-bottom: 10px;
            color: #555;
        }

         h3 { /* Style for category headings in Manage Teams modal */
            margin-top: 15px;
            margin-bottom: 8px;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
         }


        .add-button {
            display: block;
            margin: 20px auto;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #28a745;
            color: white;
            font-size: 2em;
            border: none;
            cursor: pointer;
            text-align: center;
            line-height: 50px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.3s ease;
            position: sticky;
            top: 20px;
            z-index: 10;
        }

        .add-button:hover {
            background-color: #218838;
        }

        .content-wrapper {
            display: flex;
            margin-top: 20px;
            padding: 0 20px;
        }

        .left-menu {
            width: 200px;
            margin-right: 20px;
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky;
            top: 90px;
            align-self: flex-start;
            max-height: calc(100vh - 110px);
            overflow-y: auto;
        }

        .left-menu ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .left-menu li {
            margin-bottom: 10px;
        }

        .left-menu a {
            text-decoration: none;
            color: #007bff;
            font-weight: bold;
            display: block;
            padding: 5px 0;
            transition: color 0.3s ease;
        }

        .left-menu a:hover {
            color: #0056b3;
        }

        main {
            flex-grow: 1;
            padding: 0;
            box-shadow: none;
            background-color: transparent;
        }

        /* --- Section Block Style --- */
        .section-block {
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px; /* Space below each block */
        }


        /* --- Table Styles --- */
        /* Styles for the table element itself, regardless of the wrapper */
        #categoryTable, .category-group-table, #clubsTable, #createdTeamsTable {
            border-collapse: collapse;
            width: 100%; /* Keep 100% width for these tables */
            border: none;
            overflow: hidden;
        }

         /* Specific style for tables in #timy-do-skupin and manage teams modal */
        .group-clubs-table {
            border-collapse: collapse;
             /* Allow width to be flexible within its flex container parent */
             /* width: 100%; /* Removed 100% width */
            border: none;
            overflow: hidden;
             /* Added table-layout: auto to make columns fit content */
            table-layout: auto;
        }


        /* Style for the section wrapping category heading and group table */
        .category-group-section {
            /* Inherits background, padding, radius, shadow from .section-block */
            /* Flex properties only for group sections when inside #groupsContent */
            min-width: 300px;
            flex-grow: 1;
            flex-basis: 0;
        }

        /* Style for the main container of group sections (the flex container) */
        #groupsContent {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: flex-start;
            padding: 0;
            margin-bottom: 20px;
        }
         #groupsContent .section-block {
             margin-bottom: 0; /* Override margin for flex items */
         }


        /* Remove margin-top from the first element inside a section block */
        .section-block h2:first-child,
        .section-block table:first-child {
            margin-top: 0;
        }

         /* Style for tables within the manage teams modal */
         #manageTeamsModal .group-clubs-table {
             margin-bottom: 15px; /* Space below each category table in the modal */
             width: 100%; /* Set 100% width inside modal for these tables */
         }


        /* Table Header and Cell Styles - apply to all relevant table types */
        #categoryTable th, #clubsTable th, .category-group-table th, .group-clubs-table th, #createdTeamsTable th,
         #manageTeamsModal .group-clubs-table th /* Also apply to modal tables */
         {
            background-color: #f2f2f2;
            color: #333;
            font-weight: bold;
            text-align: left;
            padding: 12px 15px;
            border-bottom: 2px solid #ddd;
        }

        #categoryTable td, #clubsTable td, .category-group-table td, .group-clubs-table td, #createdTeamsTable td,
         #manageTeamsModal .group-clubs-table td /* Also apply to modal tables */
         {
            text-align: left;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
        }

        /* Center align quantity cells in Created Teams table */
         #createdTeamsTable tbody td:not(:first-child):not(:last-child) {
             text-align: center;
         }

         /* Center align order column in group-clubs-table */
         .group-clubs-table tbody td:first-child {
             text-align: center;
         }
         #manageTeamsModal .group-clubs-table tbody td:first-child {
             text-align: center; /* Also for modal tables */
         }


        /* Remove bottom border from last row in tbody for all tables */
        #categoryTable tbody tr:last-child td,
        #clubsTable tbody tr:last-child td,
        .category-group-table tbody tr:last-child td,
        .group-clubs-table tbody tr:last-child td,
        #createdTeamsTable tbody tr:last-child td,
         #manageTeamsModal .group-clubs-table tbody tr:last-child td
         {
             border-bottom: none;
         }

        /* Hover effect for all table rows */
        #categoryTable tbody tr:hover,
        #clubsTable tbody tr:hover,
        .category-group-table tbody tr:hover,
        .group-clubs-table tbody tr:hover,
        #createdTeamsTable tbody tr:hover,
         #manageTeamsModal .group-clubs-table tbody tr:hover
         {
            background-color: #f9f9f9;
            cursor: pointer;
        }

        /* Ensure last cell in row doesn't wrap buttons */
        #categoryTable td:last-child,
        #clubsTable td:last-child,
        .category-group-table td:last-child,
        .group-clubs-table td:last-child,
        #createdTeamsTable td:last-child,
         #manageTeamsModal .group-clubs-table td:last-child /* Also for tables in modal */
         {
             white-space: nowrap;
         }

        /* --- NEW: Styles for #timy-do-skupin layout (Flexbox) --- */
        /* Container for tables in #timy-do-skupin */
        #clubsContent {
            display: flex; /* Enable flexbox */
            flex-wrap: wrap; /* Allow items to wrap to the next line */
            gap: 20px; /* Space between flex items */
            justify-content: flex-start; /* Align items to the start */
            padding: 20px; /* Add padding around the flex container */
            margin-bottom: 20px; /* Keep space below the section */
        }

        /* Individual table containers in #timy-do-skupin */
        #clubsContent .section-block {
             /* flex-grow, flex-shrink, flex-basis */
            /* Zmenená flex-basis na zmenšenie šírky */
            flex: 1 1 calc(25% - 30px); /* Menšia základná šírka */
            min-width: 180px; /* Prispôsobená minimálna šírka */
            box-sizing: border-box; /* Include padding and border in element's total width */
             margin-bottom: 0; /* Override the default .section-block margin when inside flex */
        }

        /* Adjust table inside section-block if needed, but width: 100% should handle it */
        #clubsContent .section-block table {
             width: 100%; /* Table fills its flex item container */
        }

        #teamCreationContentSection table {
             /* Ensure table within section block takes full width */
             width: 100%;
         }


        /* --- Action Button Styles --- */
        .action-button {
            padding: 5px 10px;
            margin-right: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
        }

        .action-button:not(.delete-button) {
            background-color: #007bff;
            color: white;
        }

        .action-button.delete-button {
            background-color: #dc3545;
            color: white;
        }

        .action-button:not(.delete-button):hover { background-color: #0056b3; }
        .action-button.delete-button:hover { background-color: #c82333; }


        /* --- Modal Styles --- */
         .modal {
             display: none;
             position: fixed;
             z-index: 1001; /* Adjusted z-index to be higher than add button */
             left: 0;
             top: 0;
             width: 100%;
             height: 100%;
             overflow: auto;
             background-color: rgba(0,0,0,0.4);
             padding-top: 60px;
         }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
            position: relative;
        }

        .modal-content h2 {
             margin-top: 0;
             margin-bottom: 20px;
             color: #333;
        }

        .close {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover, .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-content form label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

         .modal-content form input[type="text"],
         .modal-content form input[type="number"],
         .modal-content form select {
             width: calc(100% - 22px);
             padding: 10px;
             margin-bottom: 20px;
             border: 1px solid #ccc;
             border-radius: 4px;
             box-sizing: border-box;
         }
         /* Adjust select height for multiple */
         .modal-content form select[multiple] {
              min-height: 100px; /* Or adjust as needed */
         }


        .modal-content form button[type="submit"] { /* Target the submit button */
            background-color: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }

         .modal-content form button[type="submit"]:hover { /* Target the submit button */
             background-color: #218838;
         }

         /* Style for the container divs around specific form elements */
         .modal-content form div {
             margin-bottom: 20px; /* Add spacing below input groups */
         }
         .modal-content form div:last-of-type {
              margin-bottom: 0; /* Remove bottom margin for the last one before the button */
         }
          .modal-content form label,
          .modal-content form input[type="text"],
          .modal-content form input[type="number"],
          .modal-content form select {
               margin-bottom: 0; /* Remove margin from elements inside the div */
           }

         /* Optional CSS for dynamically added category/count pairs */
          .category-count-pair {
               border: 1px solid #eee;
               padding: 10px;
               margin-bottom: 15px; /* Space below each pair */
               border-radius: 5px;
               background-color: #f9f9f9;
           }

           .category-count-pair label {
               display: inline-block; /* Make labels inline */
               margin-bottom: 5px;
               margin-right: 10px; /* Space between label and input/select */
               font-weight: normal; /* Less bold than section titles */
               min-width: 80px; /* Align labels (adjust as needed) */
           }

           .category-count-pair select,
           .category-count-pair input[type="number"] {
                display: inline-block; /* Make inputs/selects inline */
                width: auto; /* Allow size based on content/min-width */
                margin-bottom: 0; /* Remove bottom margin */
                margin-right: 10px; /* Space between elements */
                padding: 5px; /* Smaller padding */
            }

           /* Style for the remove button within the pair */
           .category-count-pair .action-button.delete-button {
               padding: 3px 8px; /* Smaller padding */
               font-size: 0.8em; /* Smaller font */
           }

           /* Adjust spacing within the container div */
           #teamCategoryCountContainer div {
               margin-bottom: 10px; /* Space between inner divs (label+element) */
           }

           /* Ensure remove button is not on a new line if space allows */
           .category-count-pair div:last-of-type { /* This targets the last div within a pairDiv */
                margin-bottom: 0;
           }


        /* --- Responsive adjustments for clubsContent --- */
        @media (max-width: 992px) { /* Example breakpoint for medium screens */
             #clubsContent .section-block {
                  flex: 1 1 calc(45% - 20px); /* Upravená šírka pre 2 stĺpce */
             }
        }

        @media (max-width: 576px) { /* Example breakpoint for small screens */
             #clubsContent .section-block {
                  flex: 1 1 100%; /* Jeden stĺpec */
             }
        }

    </style>

</head>
<body>
    <script>
        // Basic check for admin, redirect if not
        const userName = localStorage.getItem('username');
        if (userName !== 'admin') {
             window.location.href = 'login.html';
        }
    </script>

    <h1>Správca turnaja</h1>

    <button class="add-button" id="addButton" title="Pridať položku">+</button>

    <div class="modal" id="categoryModal">
        <div class="modal-content">
            <span class="close category-modal-close">&times;</span>
            <h2 id="categoryModalTitle">Pridať kategóriu</h2>
            <form id="categoryForm">
                <div>
                    <label for="categoryName">Názov kategórie:</label>
                    <input type="text" id="categoryName" name="categoryName" required>
                </div>
                <button type="submit">Uložiť</button>
            </form>
        </div>
    </div>

     <div class="modal" id="groupModal">
         <div class="modal-content">
                 <span class="close group-modal-close">&times;</span>
                 <h2 id="groupModalTitle">Pridať skupinu</h2>
                 <form id="groupForm">
                     <div>
                          <label for="groupCategory">Kategória:</label>
                          <select id="groupCategory" name="groupCategory" required>
                               <option value="">-- Vyberte kategóriu --</option>
                               </select>
                     </div>

                     <div>
                          <label for="groupName">Názov skupiny:</label>
                          <input type="text" id="groupName" name="groupName" required>
                     </div>

                     <button type="submit">Uložiť</button>
                 </form>
         </div>
     </div>

    <div class="modal" id="clubModal">
         <div class="modal-content">
                 <span class="close club-modal-close">&times;</span>
                 <h2 id="clubModalTitle">Priradiť tím do skupiny</h2>
                 <form id="clubForm">
                       <div id="unassignedClubSelectContainer">
                          <label for="unassignedClubSelect">Vyberte existujúci tím:</label>
                          <select id="unassignedClubSelect">
                               <option value="">-- Vyberte tím na priradenie --</option>
                           </select>
                      </div>

                      <div id="clubNameInputContainer">
                          <label for="clubName">Názov klubu:</label>
                          <input type="text" id="clubName" name="clubName">
                       </div>

                      <div>
                          <label for="clubCategory">Kategória:</label>
                          <select id="clubCategory" name="clubCategory" required>
                               <option value="">-- Vyberte kategóriu --</option>
                               </select>
                      </div>

                      <div>
                           <label for="clubGroup">Skupina:</label>
                           <select id="clubGroup" name="clubGroup" required disabled>
                                <option value="">-- Najprv vyberte kategóriu --</option>
                            </select>
                      </div>

                       <div id="orderInputContainer">
                            <label for="orderInGroup">Poradové číslo v skupine:</label>
                            <input type="number" id="orderInGroup" name="orderInGroup" min="1">
                       </div>

                       <button type="submit">Uložiť</button>
                  </form>
         </div>
     </div>

    <div class="modal" id="teamCreationModal">
        <div class="modal-content">
            <span class="close team-creation-modal-close">&times;</span>
            <h2 id="teamCreationModalTitle">Vytvoriť tímy</h2>
            <form id="teamCreationForm">
                <div>
                    <label for="teamNameInput">Základný názov tímu:</label>
                    <input type="text" id="teamNameInput" name="teamName" required>
                </div>

                <div id="teamCategoryCountContainer">
                     </div>

                 <button type="button" id="addCategoryCountPairButton" class="action-button" style="margin-bottom: 15px;">Pridať ďalšiu kategóriu</button> <button type="submit">Vytvoriť tímy</button> </form>
        </div>
    </div>

    <div class="modal" id="manageTeamsModal">
        <div class="modal-content" style="max-width: 700px;"> <span class="close manage-teams-modal-close">&times;</span>
            <h2 id="manageTeamsModalTitle"><span id="baseTeamNameInModal"></span></h2>

            <div id="teamsListInModal">
                <p>Načítavam tímy...</p> </div>


            <!--
            <div style="text-align: right; margin-top: 20px;">
                 <button class="action-button" onclick="closeManageTeamsModal()">Zatvoriť</button>
            </div>
            //-->
        </div>
    </div>


    <div class="content-wrapper">
        <nav class="left-menu">
            <ul>
                <li><a href="#kategorie">Vytvorenie kategórií</a></li>
                <li><a href="#skupiny">Vytvorenie skupín</a></li>
                <li><a href="#zoznam-timov">Zoznam tímov</a></li>
                <li><a href="#timy-do-skupin">Tímy do skupín</a></li>
                <li><a href="#sportove-haly">Športové haly</a></li>
                <li><a href="#sprava-turnaja">Správa turnaja</a></li>
                <li><a href="#nastavenia">Nastavenia</a></li>
            </ul>
        </nav>

        <main>
            <div id="categoriesContentSection" class="section-block" style="display: none;">
                 <h2>Vytvorenie kategórií</h2>
                <table id="categoryTable">
                    <thead>
                        <tr>
                            <th>Názov</th>
                            <th style="width: 150px;"></th>
                        </tr>
                    </thead>
                    <tbody id="categoryTableBody">
                        </tbody>
                </table>
            </div>

            <div id="groupsContent" style="display: none;">
                </div>

            <div id="clubsContent" style="display: none;">
                 </div>

             <div id="teamCreationContentSection" class="section-block" style="display: none;">
                 <h2>Zoznam tímov</h2>
                 <table id="createdTeamsTable">
                     <thead>
                         <tr id="createdTeamsTableHeader"> <th>Názov tímu</th>
                             <th style="width: 150px;"></th>
                         </tr>
                     </thead>
                     <tbody id="createdTeamsTableBody">
                         </tbody>
                 </table>
            </div>

            </main>
    </div>


<script type="module">
        // Import potrebných Firebase Firestore funkcií priamo z CDN
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, query, where, addDoc, updateDoc, writeBatch } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';
        // Import FieldPath pre query podľa ID dokumentu v clubForm submit handleri
        // ODSTRÁNENÝ IMPORT FieldPath PRETOŽE SPÔSOBOVAL CHYBU
        // import { FieldPath } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';


        // Tvoja Firebase konfigurácia
        const firebaseConfig = {
            apiKey: "AIzaSyD0h0rQZiIGi0-UDb4-YU_JihRGpIlfz40", // ZMEŇ ZA SVOJ SKUTOČNÝ API KĽÚČ
            authDomain: "turnaj-a28c5.firebaseapp.com", // ZMEŇ ZA SVOJ SKUTOČNÝ authDomain
            projectId: "turnaj-a28c5", // ZMEŇ ZA SVOJ SKUTOČNÝ projectId
            storageBucket: "turnaj-a28c5.firebasestorage.app", // ZMEŇ ZA SVOJ SKUTOČNÝ storageBucket
            messagingSenderId: "13732191148", // ZMEŇ ZA SVOJ SKUTOČNÝ messagingSenderId
            appId: "1:13732191148:web:5ad78eaef2ad452a10f809" // ZMEŇ ZA SVOJ SKUTOČNÝ appId
        };

        // Inicializácia Firebase aplikácie
        const app = initializeApp(firebaseConfig);
        // Získanie inštancie Firestore databázy
        const db = getFirestore(app);

        // Referencia na kolekcie
        const categoriesCollectionRef = collection(db, 'tournamentData', 'mainTournamentData', 'categories');
        const groupsCollectionRef = collection(db, 'tournamentData', 'mainTournamentData', 'groups'); // Groups use composite IDs
        const clubsCollectionRef = collection(db, 'tournamentData', 'mainTournamentData', 'clubs'); // Clubs now use auto-generated IDs


        // Získame referencie na DOM elementy
        const addButton = document.getElementById('addButton');

        // Modál Kategórie
        const categoryModal = document.getElementById('categoryModal');
        const categoryModalCloseBtn = categoryModal.querySelector('.category-modal-close');
        const categoryForm = document.getElementById('categoryForm');
        const categoryNameInput = document.getElementById('categoryName');
        const categoryModalTitle = document.getElementById('categoryModalTitle');

        // Modál Skupiny
        const groupModal = document.getElementById('groupModal');
        const groupModalCloseBtn = groupModal.querySelector('.group-modal-close');
        const groupForm = document.getElementById('groupForm');
        const groupCategorySelect = document.getElementById('groupCategory');
        const groupNameInput = document.getElementById('groupName');
        const groupModalTitle = document.getElementById('groupModalTitle');
        const groupFormSubmitButton = groupForm.querySelector('button[type="submit]');

        // Modál Kluby (pre priradenie do skupín / úpravu priradených)
        const clubModal = document.getElementById('clubModal');
        const clubModalCloseBtn = clubModal.querySelector('.club-modal-close');
        const clubForm = document.getElementById('clubForm');
        const clubNameInput = document.getElementById('clubName'); // Existing name input (used when editing assigned)
        const clubCategorySelect = document.getElementById('clubCategory');
        const clubGroupSelect = document.getElementById('clubGroup');
        const clubModalTitle = document.getElementById('clubModalTitle');
        // const clubFormSubmitButton = clubForm.querySelector('button[type="submit]');

        // Modál Vytvorenie Tímov
        const teamCreationModal = document.getElementById('teamCreationModal');
        const teamCreationModalCloseBtn = teamCreationModal.querySelector('.team-creation-modal-close'); // <--- Tento riadok sem pridaj

        // Nový Modal pre správu individuálnych tímov
        const manageTeamsModal = document.getElementById('manageTeamsModal'); // Referencia na samotný modál
        const baseTeamNameInModalSpan = document.getElementById('baseTeamNameInModal'); // Referencia na element v modáli
        const teamsListInModalDiv = document.getElementById('teamsListInModal'); // Referencia na element v modáli
        // Referencia na zatváracie tlačidlo modálu pre správu tímov:
        const manageTeamsModalCloseBtn = manageTeamsModal.querySelector('.manage-teams-modal-close'); // <-- Tento riadok musí byť definovaný tu (alebo pred jeho použitím)

        // REFERENCES FOR CLUB MODAL CHANGES (add/edit assigned)
        const unassignedClubSelectContainer = document.getElementById('unassignedClubSelectContainer');
        const unassignedClubSelect = document.getElementById('unassignedClubSelect');
        const clubNameInputContainer = document.getElementById('clubNameInputContainer');
         const orderInputContainer = document.getElementById('orderInputContainer'); // Reference to the new order input container
        const orderInGroupInput = document.getElementById('orderInGroup'); // Reference to the new order input field

        // --- DEBUG LOG: Check element references on script load ---
        console.log('clubModalTitle element reference:', clubModalTitle);
        console.log('unassignedClubSelectContainer element reference:', unassignedClubSelectContainer);
        console.log('clubNameInputContainer element reference:', clubNameInputContainer);
        console.log('orderInputContainer element reference:', orderInputContainer);
        // --- END DEBUG LOG ---


        // Zobrazované sekcie (obalové divy)
        const categoriesContentSection = document.getElementById('categoriesContentSection'); // Obalový div pre kategórie
        const groupsContentDiv = document.getElementById('groupsContent'); // Flex kontajner pre skupiny
        const clubsContentDiv = document.getElementById('clubsContent'); // Flex kontajner pre kluby v skupinách (priradené)
        // Obalový div pre sekciu Vytvorenie Tímov (nepriradené)
        const teamCreationContentSection = document.getElementById('teamCreationContentSection');


        // Referencie na samotné tabuľky (pre manipuláciu s tbody)
        const categoryTable = document.getElementById('categoryTable');
        const categoryTableBody = document.getElementById('categoryTableBody');

        // Referencia na tbody tabuľky Vytvorenie Tímov
        const createdTeamsTableBody = document.getElementById('createdTeamsTableBody');
        // Referencia na hlavičku tabuľky Vytvorenie Tímov (pre dynamické stĺpce)
        const createdTeamsTableHeader = document.getElementById('createdTeamsTableHeader');


        // Premenné stavu modálov
        let currentCategoryModalMode = 'add';
        let editingCategoryName = null;

        let currentGroupModalMode = 'add';
        let editingGroupId = null; // Kompozitné ID upravovanej skupiny

        // Premenné stavu pre modál Kluby (Priradenie/Úprava)
        let currentClubModalMode = 'add-assign'; // Default mode: 'add-assign' or 'edit-assigned'
        let editingClubId = null; // Auto-generated ID of the club document being edited


        // Premenné stavu pre modál Vytvorenie Tímov (zatiaľ len 'add')
        let currentTeamCreationModalMode = 'add';

        // Premenná na uloženie všetkých dostupných kategórií pre dynamické selecty
        let allAvailableCategories = [];


        // --- Funkcie pre Kategórie ---
        function addCategoryRowToTable(categoryName) {
             const tr = document.createElement('tr');
             const nameTd = document.createElement('td');
             nameTd.textContent = categoryName;
             const actionsTd = document.createElement('td');
             actionsTd.style.whiteSpace = 'nowrap';

             const renameButton = document.createElement('button');
             renameButton.textContent = 'Premenovať';
             renameButton.classList.add('action-button');
             renameButton.onclick = function() {
                 currentCategoryModalMode = 'edit';
                 editingCategoryName = categoryName;
                 if (!categoryModalTitle) { console.error('FATAL ERROR: categoryModalTitle is null in edit mode!'); return; } // Safety check
                 categoryModalTitle.textContent = 'Premenovať kategóriu';
                 categoryNameInput.value = categoryName;
                 categoryModal.style.display = 'block';
                 categoryNameInput.focus();
             };


             const deleteButton = document.createElement('button');
             deleteButton.textContent = 'Vymazať';
             deleteButton.classList.add('action-button', 'delete-button');
             deleteButton.onclick = async function() {
                  const categoryToDelete = this.closest('tr').querySelector('td:first-child').textContent;

                  if (!confirm(`Naozaj chcete vymazať kategóriu "${categoryToDelete}"? Akékoľvek priradené skupiny a kluby prídu o svoju kategóriu (categoryId a groupId sa nastavia na null)!`)) {
                      return;
                  }

                  try {
                      // Pred zmazaním kategórie, nájdi a aktualizuj všetky kluby a skupiny, ktoré na ňu odkazujú
                      const batch = writeBatch(db);

                      // Nájdi a aktualizuj skupiny s touto kategóriou
                      const groupsQuery = query(groupsCollectionRef, where('categoryId', '==', categoryToDelete));
                      const groupsSnapshot = await getDocs(groupsQuery);

                       // Fetch clubs related to groups being deleted *before* starting the batch queries within the loop
                       const clubUpdates = [];
                       for (const groupDoc of groupsSnapshot.docs) {
                           const clubsInGroupQuery = query(clubsCollectionRef, where('groupId', '==', groupDoc.id));
                           const clubsSnapshot = await getDocs(clubsInGroupQuery);
                           clubsSnapshot.forEach(clubDoc => {
                                // Let's simplify: if category deleted, clubs lose both references.
                               batch.update(clubDoc.ref, { categoryId: null, groupId: null, orderInGroup: null }); // Update club with null references
                                console.log(`Klub "${clubDoc.id}" odpriradený kvôli zmazaniu skupiny "${groupDoc.id}".`); // Clarified log
                           });
                            // Add group deletion to batch
                           batch.delete(groupDoc.ref); // Delete old group doc
                           console.log(`Stará skupina "${groupDoc.id}" zmazaná pri mazaní kategórie.`); // Clarified log
                       }

                       // Nájdi a aktualizuj kluby s touto kategóriou, ktoré už nemusia byť priradené k skupine (groupId == null)
                       const unassignedClubsQuery = query(clubsCollectionRef, where('categoryId', '==', categoryToDelete), where('groupId', '==', null));
                        const unassignedClubsSnapshot = await getDocs(unassignedClubsQuery);
                        unassignedClubsSnapshot.forEach(doc => {
                           batch.update(doc.ref, { categoryId: null }); // Just update categoryId to null
                           console.log(`Nepriradený klub "${doc.id}" aktualizovaný (categoryId = null).`);
                        });


                      // Nakoniec zmaž samotnú kategóriu
                      batch.delete(doc(categoriesCollectionRef, categoryToDelete)); // Delete old category doc using old name

                      await batch.commit();

                      console.log(`Kategória "${categoryToDelete}" a súvisiace referencie boli úspešne zmazané/aktualizované.`);

                      // Refresh displays that might be affected
                       loadCategoriesTable(); // Always refresh category table
                       if (window.location.hash === '#skupiny') {
                           groupsContentDiv.innerHTML = '';
                           displayGroupsByCategory();
                       }
                       // Refresh created teams list regardless of hash, as categories affect its header and grouping
                       displayCreatedTeams();

                       if (window.location.hash === '#timy-do-skupin') displayClubs();


                  } catch (error) {
                      console.error('Chyba pri mazaní kategórie a súvisiacich dát: ', error);
                      alert('Chyba pri mazaní kategórie! Prosím, skúste znova.');
                      // Close modal and reset state on error
                      categoryModal.style.display = 'none'; categoryForm.reset();
                      currentCategoryModalMode = 'add'; editingCategoryName = null;
                  }
             };

             actionsTd.appendChild(renameButton);
             actionsTd.appendChild(deleteButton);
             tr.appendChild(nameTd);
             tr.appendChild(actionsTd);
             categoryTableBody.appendChild(tr); // Append directly to tbody
         }

         async function loadCategoriesTable() {
             try {
                 categoryTableBody.innerHTML = ''; // Clear existing rows
                 const querySnapshot = await getDocs(categoriesCollectionRef);
                 if (querySnapshot.empty) {
                     console.log("Žiadne kategórie nenájdené.");
                     const noDataRow = document.createElement('tr');
                     const td = document.createElement('td');
                     td.colSpan = 2;
                     td.textContent = "Žiadne kategórie zatiaľ pridané.";
                     td.style.textAlign = 'center';
                     noDataRow.appendChild(td);
                     categoryTableBody.appendChild(noDataRow);
                 } else {
                     // Sort categories alphabetically by name (doc.id)
                     const sortedDocs = querySnapshot.docs.sort((a, b) => a.id.localeCompare(b.id));
                     sortedDocs.forEach((doc) => {
                         const categoryName = doc.id;
                         addCategoryRowToTable(categoryName);
                     });
                     console.log(`Načítaných kategórií: ${sortedDocs.length}`);
                 }
             } catch (error) {
                 console.error('Chyba pri načítaní kategórií: ', error);
                 alert('Chyba pri načítaní kategórií!');
                  const errorRow = document.createElement('tr');
                  const td = document.createElement('td');
                  td.colSpan = 2;
                  td.textContent = "Chyba pri načítaní kategórií.";
                  td.style.textAlign = 'center';
                  errorRow.appendChild(td);
                  categoryTableBody.appendChild(errorRow);
             }
         }


         // --- Funkcia na naplnenie selectboxu kategórií ---
         async function populateCategorySelect(selectElement, selectedCategoryId = null) {
             console.log(`DEBUG: Populating categories for select: ${selectElement.id || 'Unnamed Select'}`);
              selectElement.innerHTML = '<option value="">-- Vyberte kategóriu --</option>'; // Clear and add placeholder

              selectElement.disabled = true; // Disable while loading

              try {
                  const querySnapshot = await getDocs(categoriesCollectionRef);
                  if (querySnapshot.empty) {
                      const option = document.createElement('option');
                      option.value = '';
                      option.textContent = '-- Žiadne kategórie --';
                       option.disabled = true; // Make it non-selectable
                      selectElement.appendChild(option);
                       selectElement.disabled = true; // Keep disabled if no categories
                       console.warn("No categories found in Firestore.");
                  } else {
                       selectElement.disabled = false; // Enable if categories are found
                       const sortedDocs = querySnapshot.docs.sort((a, b) => a.id.localeCompare(b.id));
                       // allAvailableCategories = sortedDocs.map(doc => doc.id); // Update global list if needed elsewhere
                       sortedDocs.forEach((doc) => {
                            const categoryName = doc.id;
                            const option = document.createElement('option');
                            option.value = categoryName;
                            option.textContent = categoryName;
                            selectElement.appendChild(option);
                       });

                       // Set the selected value if provided
                       if (selectedCategoryId) {
                           selectElement.value = selectedCategoryId;
                       }
                   }
               } catch (error) {
                   console.error('Chyba pri načítaní kategórií: ', error);
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = '-- Chyba pri načítaní --';
                    option.disabled = true;
                    selectElement.appendChild(option);
                    selectElement.disabled = true; // Keep disabled on error
               } finally {
                   // --- PRIDAŤ VOLANIE NA ODSTRÁNENIE DUPLICÍT PO NAPLNENÍ ---
                   // Túto funkciu voláme vždy po naplnení, ako poistku
                   if (selectElement.id === 'clubCategory') { // Only call for the specific selectbox
                        removeDuplicateOptions(selectElement);
                   }
                   // ------------------------------------------------------
               }
            }


             // --- Funkcia na naplnenie selectboxu skupín ---
         async function populateGroupSelect(selectedCategoryId, selectElement, selectedGroupId = null) {
              console.log(`DEBUG: Populating groups for select: ${selectElement.id || 'Unnamed Select'} based on category: ${selectedCategoryId}`);
              selectElement.innerHTML = '<option value="">-- Vyberte skupinu --</option>'; // Clear and add placeholder

              selectElement.disabled = true; // Disable while loading


              if (!selectedCategoryId || selectedCategoryId === '' || selectedCategoryId === '-- Vyberte kategóriu --') {
                   // Ak nie je vybraná platná kategória, len resetujeme select skupín a necháme ho zablokovaný
                   console.log("DEBUG: populateGroupSelect called with no valid category selected. Resetting group select.");
                   // Select už bol resetovaný na placeholder na začiatku funkcie
                    // Zabezpečíme, že zostane zablokovaný
                    selectElement.disabled = true; // Ponechať zablokovaný
                   return; // Ukončiť funkciu
              }


              try {
                   // Query groups for the selected category
                   const groupsQuery = query(groupsCollectionRef, where('categoryId', '==', selectedCategoryId));
                  const querySnapshot = await getDocs(groupsQuery);

                  if (querySnapshot.empty) {
                       const option = document.createElement('option');
                       option.value = '';
                       option.textContent = '-- Žiadne skupiny v kategórii --';
                       option.disabled = true;
                       selectElement.appendChild(option);
                       selectElement.disabled = true; // Keep disabled if no groups found for category
                       console.warn(`No groups found for category: ${selectedCategoryId}`);
                  } else {
                       selectElement.disabled = false; // Enable if groups are found
                       const sortedDocs = querySnapshot.docs.sort((a, b) => a.id.localeCompare(b.id));
                       sortedDocs.forEach((doc) => {
                            const groupName = doc.id; // Group ID is the document ID
                            const option = document.createElement('option');
                            option.value = groupName; // Use document ID as value
                            option.textContent = groupName; // Use document ID as text
                            selectElement.appendChild(option);
                       });

                       // Set the selected value if provided
                       if (selectedGroupId) {
                           selectElement.value = selectedGroupId;
                       }
                   }
               } catch (error) {
                   console.error(`Chyba pri načítaní skupín pre kategóriu ${selectedCategoryId}: `, error);
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = '-- Chyba pri načítaní --';
                    option.disabled = true;
                    selectElement.appendChild(option);
                    selectElement.disabled = true; // Keep disabled on error
               } finally {
                   // --- PRIDAŤ VOLANIE NA ODSTRÁNENIE DUPLICÍT PO NAPLNENÍ ---
                   // Túto funkciu voláme vždy po naplnení, ako poistku
                   if (selectElement.id === 'clubGroup') { // Only call for the specific selectbox
                       removeDuplicateOptions(selectElement);
                   }
                    // ------------------------------------------------------
               }
         }


 // Funkcia na otvorenie modálu skupiny (pre pridanie alebo úpravu)
  //groupId je kompozitné ID, groupData má name, categoryId
 async function openGroupModal(groupId = null, groupData = null) {
      groupModal.style.display = 'block';

      // Resetuj stav modálu a formulár
      currentGroupModalMode = 'add';
      editingGroupId = null; // Vymaž ID upravovanej skupiny
      groupForm.reset(); // Vyčisti polia formulára
      groupNameInput.disabled = false; // Uisti sa, že vstup pre názov je povolený
      groupFormSubmitButton.textContent = 'Uložiť'; // Default button text


      // Naplň select kategórií pre modál skupiny
      groupCategorySelect.value = ""; // Resetuj výber kategórie


      if (groupId && groupData) {
          // Režim úpravy
          currentGroupModalMode = 'edit';
          editingGroupId = groupId; // Ulož kompozitné ID skupiny, ktorá sa upravuje
          if (!groupModalTitle) { console.error('FATAL ERROR: groupModalTitle is null in edit mode!'); return; } // Safety check
          groupModalTitle.textContent = 'Premenovať skupinu';
          groupFormSubmitButton.textContent = 'Uložiť zmeny';

          // Naplň select kategórií a potom nastav zvolenú hodnotu
          await populateCategorySelect(groupCategorySelect, groupData.categoryId); // Pass select element first

          // Vyplň polia formulára
          groupNameInput.value = groupData.name; // Použi pole 'name' z dát
          // Hodnota groupCategorySelect sa nastaví funkciou populateCategorySelect

      } else {
          // Režim pridania (počiatočný stav už nastavený vyššie)
          if (!groupModalTitle) { console.error('FATAL ERROR: groupModalTitle is null in add mode!'); return; } // Safety check
          groupModalTitle.textContent = 'Pridať skupinu';

          await populateCategorySelect(groupCategorySelect, null); // Naplň select kategórií
      }

      groupNameInput.focus(); // Nastav focus na pole pre názov
     }


             // Funkcia na zobrazenie skupín usporiadaných podľa kategórií
             async function displayGroupsByCategory() {
                  groupsContentDiv.innerHTML = ''; // Clear container

                  try {
                     // 1. Načítať všetky kategórie
                     const categoriesSnapshot = await getDocs(categoriesCollectionRef);
                     // Sort categories by name (doc.id)
                     const sortedCategoriesDocs = categoriesSnapshot.docs.sort((a, b) => a.id.localeCompare(b.id));
                     const categories = sortedCategoriesDocs.map(doc => doc.id);


                     if (categories.length === 0) {
                          const message = document.createElement('p');
                          message.textContent = "Pridajte kategórie v sekcii 'Kategórie' pre zobrazenie skupín.";
                          groupsContentDiv.appendChild(message);
                          return;
                     }

                     // 2. Načítať všetky skupiny
                     const groupsSnapshot = await getDocs(groupsCollectionRef);

                     // 3. Zoskupiť skupiny podľa categoryId
                     const groupsByCategory = {};
                     groupsSnapshot.forEach(doc => {
                          const groupData = doc.data();
                          const groupId = doc.id; // This je kompozitné ID
                          const categoryId = groupData.categoryId;

                          if (categoryId) {
                              if (!groupsByCategory[categoryId]) {
                                  // OPRAVENÉ: Inicializuj ako prázdne POLE
                                  groupsByCategory[categoryId] = [];
                              }
                              // Uložíme ID a dáta do poľa
                              groupsByCategory[categoryId].push({ id: groupId, data: groupData });
                          } else {
                              console.warn(`Skupina ${groupId} nemá priradenú categoryId.`);
                              // Optional: Handle groups without a category
                          }
                     });

                     // 4. Pre každú kategóriu vytvoriť sekciu (div) s nadpisom a tabuľkou so skupinami
                     categories.forEach(categoryName => {
                          const groupsForThisCategory = groupsByCategory[categoryName] || [];

                          // Použijeme triedu section-block pre konzistentný vzhľad
                          const categorySectionDiv = document.createElement('div');
                          categorySectionDiv.classList.add('category-group-section', 'section-block');

                          const categoryHeading = document.createElement('h2');
                          categoryHeading.textContent = `${categoryName}`;
                          categorySectionDiv.appendChild(categoryHeading);

                          const categoryGroupsTable = document.createElement('table');
                          categoryGroupsTable.classList.add('category-group-table');

                          const thead = document.createElement('thead');
                          const headerRow = document.createElement('tr');
                          const groupNameTh = document.createElement('th');
                          groupNameTh.textContent = 'Názov';
                          const actionsTh = document.createElement('th');
                          actionsTh.textContent = ''; // Changed to Akcie
                          actionsTh.style.width = '150px';

                          headerRow.appendChild(groupNameTh);
                          headerRow.appendChild(actionsTh);
                          thead.appendChild(headerRow);
                          categoryGroupsTable.appendChild(thead);

                          const tbody = document.createElement('tbody');

                          if (groupsForThisCategory.length === 0) {
                              const noGroupsRow = document.createElement('tr');
                              const td = document.createElement('td');
                               // Adjusted colspan for table in groupsContentDiv (no order column here)
                              td.colSpan = 2;
                              td.textContent = `V kategórii "${categoryName}" zatiaľ nie sú žiadne skupiny.`;
                              td.style.textAlign = 'center';
                              noGroupsRow.appendChild(td);
                              tbody.appendChild(noGroupsRow);
                          } else {
                              // Sort groups by name before displaying
                              groupsForThisCategory.sort((a, b) => (a.data.name || '').localeCompare(b.data.name || ''));

                              groupsForThisCategory.forEach(group => {
                                   const groupRow = document.createElement('tr');
                                   const groupNameTd = document.createElement('td');
                                   groupNameTd.textContent = group.data.name; // Použi pole 'name' z dát


                                   const groupActionsTd = document.createElement('td');
                                   groupActionsTd.style.whiteSpace = 'nowrap';

                                   // TLAČIDLO ÚPRAVA SKUPINY - VOLÁ openGroupModal
                                    const editGroupButton = document.createElement('button');
                                    editGroupButton.textContent = 'Premenovať';
                                    editGroupButton.classList.add('action-button');
                                    editGroupButton.onclick = () => {
                                         openGroupModal(group.id, group.data); // Pass the composite group ID and its data
                                    };


                                   // TLAČIDLO VYMAZAŤ SKUPINU
                                    const deleteGroupButton = document.createElement('button'); // Corrected variable name
                                    deleteGroupButton.textContent = 'Vymazať';
                                    deleteGroupButton.classList.add('action-button', 'delete-button');
                                    deleteGroupButton.onclick = async () => {
                                         if (!confirm(`Naozaj chcete vymazať skupinu "${group.data.name}" z kategórie "${group.data.categoryId}"? Tímy priradené k tejto skupine prídu o priradenie (groupId a orderInGroup sa nastavia na null)!`)) { // Updated warning
                                              return;
                                         }
                                         try {
                                              // Pred zmazaním skupiny nájdi všetky kluby, ktoré na ňu odkazujú a aktualizuj ich
                                              const batch = writeBatch(db);

                                              const clubsInGroupQuery = query(clubsCollectionRef, where('groupId', '==', group.id));
                                              const clubsSnapshot = await getDocs(clubsInGroupQuery); // Use await here
                                              clubsSnapshot.forEach(doc => {
                                                   batch.update(doc.ref, { groupId: null, orderInGroup: null }); // Nastav groupId a orderInGroup na null
                                                   console.log(`Klub "${doc.id}" odpriradený zo skupiny "${group.id}".`);
                                              });

                                              // Nakoniec zmaž samotnú skupinu
                                              batch.delete(doc(groupsCollectionRef, group.id));

                                              await batch.commit();

                                              console.log(`Skupina "${group.data.name}" (ID: ${group.id}) a súvisiace kluby boli úspešne zmazané/aktualizované.`);

                                              // Refresh displays that might be affected
                                              displayGroupsByCategory(); // Reload display
                                               // Refresh created teams list regardless of hash, as removing groups can affect assignments
                                               displayCreatedTeams();
                                              if (window.location.hash === '#timy-do-skupin') displayClubs();


                                          } catch (error) {
                                              console.error('Chyba pri mazaní skupiny a súvisiacich dát: ', error);
                                              alert('Chyba pri mazaní skupiny! Prosím, skúste znova.');
                                          }
                                     };

                                     groupActionsTd.appendChild(editGroupButton);
                                     groupActionsTd.appendChild(deleteGroupButton); // Corrected variable name

                                     groupRow.appendChild(groupNameTd);
                                     groupRow.appendChild(groupActionsTd);
                                     tbody.appendChild(groupRow);
                               });
                            }

                            categoryGroupsTable.appendChild(tbody);
                            categorySectionDiv.appendChild(categoryGroupsTable); // OPRAVENÝ PREKLEP
                            groupsContentDiv.appendChild(categorySectionDiv); // Append the section div to the main container
                         });


                      } catch (error) {
                          console.error('Chyba pri načítaní alebo zobrazovaní skupín: ', error);
                          const errorMessage = document.createElement('p');
                          errorMessage.textContent = 'Chyba pri načítaní dát skupín.';
                          groupsContentDiv.appendChild(errorMessage);
                      }
             }


             // --- Funkcia na naplnenie selectboxu nepriradených tímov ---
         async function populateUnassignedClubsSelect(selectElement, selectedClubId = null) {
              console.log(`DEBUG: Populating unassigned clubs for select: ${selectElement.id || 'Unnamed Select'}`);
             selectElement.innerHTML = '<option value="">-- Vyberte tím na priradenie --</option>'; // Clear and add placeholder

             selectElement.disabled = true; // Disable while loading

             try {
                  // Filter clubs where groupId is null (or not set)
                 const unassignedQuery = query(clubsCollectionRef, where('groupId', '==', null)); // Filter by groupId == null
                 const querySnapshot = await getDocs(unassignedQuery);

                 if (querySnapshot.empty) {
                       const option = document.createElement('option');
                       option.value = '';
                       option.textContent = '-- Žiadne nepriradené tímy --';
                       option.disabled = true;
                       selectElement.appendChild(option);
                       selectElement.disabled = true; // Keep disabled if no unassigned teams
                       console.log("No unassigned clubs found.");
                 } else {
                      selectElement.disabled = false; // Enable if unassigned clubs are found
                       // Sort by name for easier finding
                       const sortedDocs = querySnapshot.docs.sort((a, b) => (a.data().name || '').localeCompare(b.data().name || ''));

                       sortedDocs.forEach((doc) => {
                           const club = doc.data();
                           const option = document.createElement('option');
                           option.value = doc.id; // Use document ID as value (auto-generated)
                           option.textContent = club.name || 'Bez názvu'; // Use club name as text
                           selectElement.appendChild(option);
                       });

                       // Set the selected value if provided
                       if (selectedClubId) {
                           selectElement.value = selectedClubId;
                       }
                 }
             } catch (error) {
                  console.error('Chyba pri načítaní nepriradených tímov: ', error);
                   const option = document.createElement('option');
                   option.value = '';
                   option.textContent = '-- Chyba pri načítaní --';
                   option.disabled = true;
                   selectElement.appendChild(option);
                   selectElement.disabled = true; // Keep disabled on error
             }
              // No need to call removeDuplicateOptions here, duplicates reported in category/group selects
         }


         // --- Funkcia na odstránenie duplicitných <option> elementov zo selectboxu ---
         // Túto funkciu pridávame na žiadosť používateľa ako dodatočnú poistku proti duplicitám,
         // aj keď by ich správna logika napĺňania a spúšťania udalostí mala eliminovať.
         function removeDuplicateOptions(selectElement) {
              if (!selectElement) {
                  console.error("Attempted to remove duplicates from a null select element.");
                  return;
              }
              console.log(`DEBUG: Removing duplicates from select: ${selectElement.id || 'Unnamed Select'}`);
              const seenValues = new Set();
              // Iterate in reverse to safely remove elements
              for (let i = selectElement.options.length - 1; i >= 0; i--) {
                   const option = selectElement.options[i];
                   // Use option.value for checking uniqueness
                   if (seenValues.has(option.value)) {
                        console.log(`DEBUG: Removing duplicate option with value: "${option.value}" and text: "${option.textContent}"`);
                       selectElement.removeChild(option);
                   } else {
                        seenValues.add(option.value);
                   }
              }
              console.log(`DEBUG: Finished removing duplicates. Remaining options: ${selectElement.options.length}`);
         }

// --- Funkcia na otvorenie modálu klubu (clubModal) ---
        // Táto funkcia zostáva nezmenená oproti predošlému kódu, s výnimkou počiatočného stavu category selectu
             async function openClubModal(clubId = null, clubData = null) {
                 console.log('openClubModal called. clubId:', clubId, 'clubData:', clubData);

                 if (!clubForm) { console.error("FATAL ERROR: clubForm not found!"); if (clubModal) clubModal.style.display = 'none'; return; }
                 clubForm.reset();
                 const clubFormSubmitButton = clubForm.querySelector('button[type="submit"]');
                 if (!clubFormSubmitButton) { console.error("FATAL ERROR: Submit button not found in clubForm!"); if (clubModal) clubModal.style.display = 'none'; return; }


                  // Reset visibility of name input vs select and order input
                  unassignedClubSelectContainer.style.display = 'block';
                  clubNameInputContainer.style.display = 'none';
                  orderInputContainer.style.display = 'none';


                  // Reset group select visibility and disabled state
                  clubGroupSelect.parentElement.style.display = 'block';
                  clubGroupSelect.disabled = true; // Zablokuje select skupín predvolene


                  // === NASTAVENIE POČIATOČNÉHO STAVU SELECTOV PRI OTVORENÍ ===
                  // Kategórie aj skupiny sú na začiatku ZABLOKOVANÉ v režime priradzovania
                  if (clubCategorySelect) {
                      clubCategorySelect.disabled = true; // Zablokovať category select na začiatku
                      clubCategorySelect.value = ''; // Reset hodnoty na placeholder
                      // populateCategorySelect sa volá nižšie, aby sa naplnili možnosti, ale select zostane zablokovaný
                  } else { console.error("FATAL ERROR: clubCategorySelect not found!"); if (clubModal) clubModal.style.display = 'none'; return; }

                  // Populate kategórie hneď (ale select zostáva zablokovaný)
                   await populateCategorySelect(clubCategorySelect, true);


                  if (clubId && clubData) {
                     // Edit mode (Úprava existujúceho klubu)
                     currentClubModalMode = 'edit-assigned'; // Zmenené na 'edit-assigned' pre lepšie rozlíšenie
                     editingClubId = clubId;

                      // V edit móde je category select povolený a hodnota nastavená
                      if (clubCategorySelect) {
                           clubCategorySelect.disabled = false; // Povoliť category select v edit móde
                           clubCategorySelect.value = clubData.categoryId || ''; // Nastaviť hodnotu
                            // Následne sa volá populateGroupSelect, ktorý spraví disable/enable group select
                             // Ak tím nie je priradený k skupine (groupId === null), skryjeme aj select skupín
                            if (clubData.groupId === null) {
                                 clubGroupSelect.parentElement.style.display = 'none'; // Skry skupinu
                                  orderInputContainer.style.display = 'none'; // Skry poradie
                                   orderInGroupInput.required = false;
                            } else {
                                 clubGroupSelect.parentElement.style.display = 'block';
                                 orderInputContainer.style.display = 'block';
                                 orderInGroupInput.required = true;
                            }
                            // Naplní skupiny na základe nastavenej kategórie. Disable/Enable group select rieši populateGroupSelect.
                            await populateGroupSelect(clubCategorySelect.value, clubGroupSelect, clubData.groupId);

                      } else { console.error("FATAL ERROR: clubCategorySelect not found in edit mode!"); if (clubModal) clubModal.style.display = 'none'; return; }


                      // Zobrazí input pre názov a nastaví jeho hodnotu
                      clubNameInputContainer.style.display = 'block';
                      unassignedClubSelectContainer.style.display = 'none'; // Skry select nepriradených v edit móde
                      clubNameInput.value = clubData.name || '';
                       orderInGroupInput.value = typeof clubData.orderInGroup === 'number' ? clubData.orderInGroup : '';


                     if (!clubModalTitle) { console.error('FATAL ERROR: clubModalTitle is null in edit mode!'); if (clubModal) clubModal.style.display = 'none'; return; }
                     clubModalTitle.textContent = 'Upraviť tím';
                     clubFormSubmitButton.textContent = 'Uložiť zmeny';


                  } else { // Add mode (Priradenie UNASSIGNED klubu do skupiny)
                     currentClubModalMode = 'add-assign'; // Default mode: 'add-assign' or 'edit-assigned' zostáva 'add-assign' pre nové priradenie
                     editingClubId = null;

                     // V add-assign móde zobrazujeme select pre výber nepriradeného klubu
                     unassignedClubSelectContainer.style.display = 'block';
                     clubNameInputContainer.style.display = 'none'; // Input názvu je skrytý
                     orderInputContainer.style.display = 'none'; // Poradie je skryté
                      orderInGroupInput.required = false;

                      // Category select je už naplnený z úvodu funkcie, ale ZOSTÁVA ZABLOKOVANÝ
                      // Skupinový select je zobrazený, ale zablokovaný


                     // Naplní select nepriradených klubov (môže spustiť 'change' ak je predvolená hodnota)
                     await populateUnassignedClubsSelect(unassignedClubSelect);


                     if (!clubModalTitle) { console.error('FATAL ERROR: clubModalTitle is null in add mode!'); if (clubModal) clubModal.style.display = 'none'; return; }
                     clubModalTitle.textContent = 'Priradiť tím do skupiny';
                     clubFormSubmitButton.textContent = 'Priradiť';
                  }

                  // Reset any previous validation messages (spoločné pre oba režimy)
                  const validationMessages = clubForm.querySelectorAll('.validation-message');
                  validationMessages.forEach(msg => msg.textContent = '');

                  // Zobraz modál až po nastavení obsahu
                  clubModal.style.display = 'block';

                  // Set focus to the first relevant input/select
                   if (currentClubModalMode === 'add-assign' && unassignedClubSelect) {
                       unassignedClubSelect.focus();
                   } else if (currentClubModalMode === 'edit-assigned' && clubNameInput) { // Adjusted focus for edit mode
                       clubNameInput.focus();
                   } else if (clubCategorySelect && !clubCategorySelect.disabled) { // Fallback focus (len ak nie je zablokovaný)
                       clubCategorySelect.focus();
                   } else {
                        console.warn("Could not set focus in club modal.");
                   }
             } // Koniec openClubModal


             // --- Event Listener pre zmenu kategórie v modáli klubu (pre priradenie do skupiny A úpravu) ---
            if (clubCategorySelect) {
                console.log("Attaching clubCategorySelect change listener"); // DEBUG LOG: Check listener attachment
                clubCategorySelect.addEventListener('change', async () => { // Made async to use await for populateGroupSelect
                     console.log("clubCategorySelect change event fired"); // DEBUG LOG: Check event firing
                    const selectedCategoryId = clubCategorySelect.value;

                    // Reset order input when category changes (applies to both add-assign and edit)
                     if (orderInGroupInput) orderInGroupInput.value = '';
                     if (orderInputContainer) orderInputContainer.style.display = 'none'; // Skryjeme poradie kým sa nevyberie skupina
                     if (orderInGroupInput) orderInGroupInput.required = false; // Poradie nie je povinné

                    // Populate the group select based on the newly selected category
                     // Len ak je vybraná platná kategória a select skupín je viditeľný
                     // A LEN ak select kategórie NIE JE ZABLOKOVANÝ (tzn. nie je v režime výberu nepriradeného tímu kde je kategória automatická)
                     if (selectedCategoryId && selectedCategoryId !== '' && selectedCategoryId !== '-- Vyberte kategóriu --' &&
                         clubGroupSelect && clubGroupSelect.parentElement && clubGroupSelect.parentElement.style.display !== 'none' &&
                         !clubCategorySelect.disabled // Add this check
                         ) {

                           clubGroupSelect.disabled = true; // Zablokuj select skupín počas načítania
                           await populateGroupSelect(selectedCategoryId, clubGroupSelect); // Pass category ID and select element
                           clubGroupSelect.disabled = false; // Povol select skupín po načítaní

                           // Ak po naplnení nie sú v kategórii žiadne skupiny, zablokuj ho úplne a zobraz správu
                           if (clubGroupSelect.options.length <= 1) { // Contains only the placeholder option
                                clubGroupSelect.disabled = true;
                                clubGroupSelect.innerHTML = '<option value="">-- Žiadne skupiny v kategórii --</option>';
                                console.warn(`Žiadne skupiny nájdené pre kategóriu: ${selectedCategoryId}`);
                           }

                     } else {
                          // Ak sa vybrala neplatná kategória (placeholder) alebo select skupín nie je viditeľný,
                          // alebo je select kategórie ZABLOKOVANÝ (napr. po výbere nepriradeného tímu)
                          // vyprázdnime a zablokujeme select skupín
                           if (clubGroupSelect) {
                                // !!! DÔLEŽITÉ: Tu sa nesmie vymazať vybratá skupina ak je select kategórie zablokovaný,
                                // pretože v režime add-assign po výbere tímu sa nastaví kategória, select sa zablokuje,
                                // spustí sa tento poslucháč, ale skupinový select má zostať prázdny pre nový výber.
                                // Toto platí IBA ak je select kategórie ZABLOKOVANÝ.
                                if (clubCategorySelect.disabled) {
                                     // Ak je kategória zablokovaná (kvôli výberu nepriradeného tímu),
                                     // resetuj select skupín a zablokuj ho, pretože používateľ má vybrať novú skupinu
                                      clubGroupSelect.innerHTML = '<option value="">-- Vyberte skupinu --</option>'; // Reset na počiatočný stav pre NOVÝ výber
                                      clubGroupSelect.disabled = true;
                                      console.log("DEBUG: Kategória je zablokovaná, resetujem select skupín na počiatočný stav.");
                                } else {
                                    // Ak kategória NIE JE zablokovaná (napr. režim úpravy existujúceho priradeného tímu
                                    // a zmenil sa select kategórie), resetuj select skupín
                                     clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kategóriu --</option>'; // Reset na počiatočný stav
                                     clubGroupSelect.disabled = true;
                                      console.log("DEBUG: Kategória nie je zablokovaná, resetujem select skupín.");
                                }


                           }
                     }
                });
            } else { console.error("Club category select not found!"); }


             // Event listener for change in the club group select (in clubModal) - handles order input visibility and required state
             if (clubGroupSelect) {
                 console.log("Attaching clubGroupSelect change listener"); // DEBUG LOG: Check listener attachment
                 clubGroupSelect.addEventListener('change', () => {
                      console.log("clubGroupSelect change event fired"); // DEBUG LOG: Check event firing
                      const selectedGroupId = clubGroupSelect.value;
                      // Show/hide order input and set required based on whether a group is selected
                      if (selectedGroupId && selectedGroupId !== '' && selectedGroupId !== '-- Vyberte skupinu --' && selectedGroupId !== '-- Žiadne skupiny v kategórii --') {
                           if (orderInputContainer) orderInputContainer.style.display = 'block';
                           if (orderInGroupInput) orderInGroupInput.required = true; // Order is required when a group is selected
                           // Automaticky nastavíme focus na pole poradia po výbere skupiny
                            if (orderInGroupInput) orderInGroupInput.focus();
                      } else {
                           if (orderInputContainer) orderInputContainer.style.display = 'none';
                           if (orderInGroupInput) orderInGroupInput.required = false;
                           if (orderInGroupInput) orderInGroupInput.value = ''; // Clear value when group is deselected
                      }
                 });
             } else { console.error("Club group select not found!"); }


             // Event listener for change in the unassigned club select (in clubModal) - handles category/group selects update
             if (unassignedClubSelect) {
                 console.log("Attaching unassignedClubSelect change listener"); // DEBUG LOG: Check listener attachment
                 unassignedClubSelect.addEventListener('change', async () => {
                      console.log("unassignedClubSelect change event fired"); // DEBUG LOG: Check event firing
                      const selectedClubId = unassignedClubSelect.value;

                      // Keď sa vyberie nepriradený tím v režime priradzovania, nastavíme kategóriu a spustíme jej change event
                      if (currentClubModalMode === 'add-assign' && selectedClubId && selectedClubId !== '-- Vyberte tím na priradenie --') {
                           try {
                               const clubDoc = await getDoc(doc(clubsCollectionRef, selectedClubId));
                               if (clubDoc.exists()) {
                                   const clubData = clubDoc.data();
                                   if (clubCategorySelect && clubGroupSelect) { // Ensure both selects exist

                                       // *** Nastaviť hodnotu kategórie a ZABLOKOVAŤ select box (požadovaná úprava) ***
                                        const categoryIdToSet = clubData.categoryId || '';
                                        clubCategorySelect.value = categoryIdToSet;
                                        clubCategorySelect.disabled = true; // !!! ZABLOKOVAŤ SELECT KATEGÓRIE !!!
                                        console.log("unassignedClubSelect change: Nastavená hodnota clubCategorySelect na:", clubCategorySelect.value, "a zablokovaný.");


                                        // *** NOVÁ LOGIKA: Povolíme a naplníme select skupín pre túto kategóriu ***
                                        // Naplni skupiny pre zvolenu kategoriu
                                         await populateGroupSelect(categoryIdToSet, clubGroupSelect, null);
                                         clubGroupSelect.disabled = false; // !!! POVOLIŤ SELECT SKUPÍN !!!
                                        console.log("unassignedClubSelect change: populated and ENABLED clubGroupSelect for category:", categoryIdToSet);


                                        // Spustíme change udalosť na clubCategorySelect
                                        // Odstránený dispatchEvent, aby sa neblokoval select skupiny, ktorý sme práve povolili.
                                        // const event = new Event('change');
                                        // clubCategorySelect.dispatchEvent(event);
                                        // console.log("unassignedClubSelect change: Spustený dispatchEvent na clubCategorySelect (zablokovaný).");


                                        // Po výbere tímu a nastavení kategórie/skupín, zobrazíme pole poradia, ak existuje skupina
                                         // Logika pre zobrazenie poľa poradia a nastavenie required je už v poslucháči zmeny skupiny,
                                         // ktorý sa spustí po výbere skupiny.
                                         // Zabezpečíme len focus na select skupiny.
                                         setTimeout(() => {
                                              if (clubGroupSelect && clubGroupSelect.parentElement && clubGroupSelect.parentElement.style.display !== 'none' && !clubGroupSelect.disabled) {
                                                   clubGroupSelect.focus();
                                              } else if (orderInGroupInput && orderInputContainer && orderInputContainer.style.display !== 'none') { // Ak je skupina neaktívna, ale poradie zobrazené (edge case?)
                                                   orderInGroupInput.focus();
                                              }
                                         }, 0); // Použite timeout 0 na odloženie spustenia na ďalší event loop tick


                                   } else { console.error("clubCategorySelect or clubGroupSelect not found after selecting unassigned club."); }

                               } else {
                                    console.warn(`Vybraný nepriradený tím ${selectedClubId} už neexistuje.`);
                                    // Reset selects if the selected team is no longer found
                                    unassignedClubSelect.value = "";
                                    if (clubCategorySelect) { clubCategorySelect.value = ""; clubCategorySelect.disabled = true; } // Reset category select value and disable
                                    if (clubGroupSelect) { clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kategóriu --</option>'; clubGroupSelect.disabled = true; } // Reset group select and disable

                                     // Spustíme change event na kategórii, aby sa resetovali skupiny a poradie (pre istotu)
                                     const event = new Event('change');
                                     if (clubCategorySelect) clubCategorySelect.dispatchEvent(event);
                                }
                            } catch (error) {
                               console.error('Chyba pri načítaní detailov vybraného nepriradeného tímu:', error);
                               alert('Chyba pri načítaní detailov tímu.');
                               unassignedClubSelect.value = "";
                               if (clubCategorySelect) { clubCategorySelect.value = ""; clubCategorySelect.disabled = true; } // Reset category select value and disable
                               if (clubGroupSelect) { clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kategóriu --</option>'; clubGroupSelect.disabled = true; } // Reset group select and disable
                                // Spustíme change event na kategórii aj pri chybe, aby sa resetovali skupiny a poradie (pre istotu)
                                 const event = new Event('change');
                                 if (clubCategorySelect) clubCategorySelect.dispatchEvent(event);
                            }
                       } else if (currentClubModalMode === 'add-assign' && (!selectedClubId || selectedClubId === '-- Vyberte tím na priradenie --')) {
                           console.log("Unassigned club select reset or placeholder selected."); // DEBUG LOG
                           // No team selected in unassigned select (back to placeholder), reset category and group selects and order input visibility/required
                           if (clubCategorySelect) { clubCategorySelect.value = ""; clubCategorySelect.disabled = true; } // Reset category select value to placeholder and disable
                            // Spustíme change event na kategórii, aby sa resetovali skupiny a poradie
                            const event = new Event('change');
                            if (clubCategorySelect) clubCategorySelect.dispatchEvent(event);
                       }
                        // If not in add-assign mode, this listener should not trigger changes
                 });
             } else { console.error("Unassigned club select not found!"); }


             // Event listener for change in the club group select (in clubModal) - handles order input visibility and required state
             if (clubGroupSelect) {
                 console.log("Attaching clubGroupSelect change listener"); // DEBUG LOG: Check listener attachment
                 clubGroupSelect.addEventListener('change', () => {
                      console.log("clubGroupSelect change event fired"); // DEBUG LOG: Check event firing
                      const selectedGroupId = clubGroupSelect.value;
                      // Show/hide order input and set required based on whether a group is selected
                      if (selectedGroupId && selectedGroupId !== '' && selectedGroupId !== '-- Vyberte skupinu --' && selectedGroupId !== '-- Žiadne skupiny v kategórii --') {
                           if (orderInputContainer) orderInputContainer.style.display = 'block';
                           if (orderInGroupInput) orderInGroupInput.required = true; // Order is required when a group is selected
                           // Automaticky nastavíme focus na pole poradia po výbere skupiny
                            if (orderInGroupInput) orderInGroupInput.focus();
                      } else {
                           if (orderInputContainer) orderInputContainer.style.display = 'none';
                           if (orderInGroupInput) orderInGroupInput.required = false;
                           if (orderInGroupInput) orderInGroupInput.value = ''; // Clear value when group is deselected
                      }
                 });
             } else { console.error("Club group select not found!"); }


            // --- Obsluha formulára Kluby (Priradenie do skupín ALEBO Úprava priradených/nepriradených) ---
            if (clubForm) {
                clubForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const selectedCategoryId = clubCategorySelect.value;
                    // Get the selected group ID only if the group select is NOT disabled and has a value
                    const selectedGroupId = (clubGroupSelect && !clubGroupSelect.disabled && clubGroupSelect.value !== '' && clubGroupSelect.value !== '-- Vyberte skupinu --' && clubGroupSelect.value !== '-- Žiadne skupiny v kategórii --') ? clubGroupSelect.value : null;
                    // Get the order number value, convert to number. Use null if empty, invalid, or if no group is selected.
                     const orderInGroupValue = parseInt(orderInGroupInput && orderInGroupInput.value, 10);
                     const orderInGroup = (selectedGroupId !== null && orderInputContainer && orderInputContainer.style.display !== 'none' && orderInGroupInput && orderInGroupInput.value.trim() !== '' && !isNaN(orderInGroupValue) && orderInGroupValue >= 1) ? orderInGroupValue : null;


                    // Validate selects based on mode and visibility
                    // Kategória je povinná, ak nie je zablokovaná (platí pre edit mode)
                    if (clubCategorySelect && clubCategorySelect.disabled === false && (selectedCategoryId === '' || selectedCategoryId === '-- Vyberte kategóriu --')) {
                        alert('Prosím, vyberte platnú kategóriu.');
                        return;
                    }
                     // Skupina je povinná len ak je select skupiny viditeľný a povolený (tzn. priradzujeme alebo upravujeme priradený)
                    if (clubGroupSelect && clubGroupSelect.parentElement && clubGroupSelect.parentElement.style.display !== 'none' && clubGroupSelect.disabled === false && selectedGroupId === null) { // Check if selectedGroupId is null after potential assignment
                         alert('Prosím, vyberte platnú skupinu.');
                         return;
                     }
                    // Poradie je povinné len ak je pole poradia viditeľné (ktoré je viditeľné len ak je vybraná skupina)
                     if (orderInputContainer && orderInputContainer.style.display !== 'none' && orderInGroup === null) {
                          alert('Prosím, zadajte platné poradové číslo väčšie ako 0.');
                          return;
                     }


                    try {
                        if (currentClubModalMode === 'add-assign') {
                            // === LOGIKA PRIRADENIA TÍMU DO SKUPINY (VYMAZAŤ STARÝ, VYTVORIŤ NOVÝ S NOVÝM ID ALEBO PREPÍSAŤ EXISTUJÚCI S CIEĽOVÝM ID) ===
                            const selectedUnassignedClubId = unassignedClubSelect && unassignedClubSelect.value;

                            // Validate the selected unassigned club
                            if (unassignedClubSelectContainer && unassignedClubSelectContainer.style.display !== 'none' && (selectedUnassignedClubId === '' || selectedUnassignedClubId === '-- Vyberte tím na priradenie --')) {
                                alert('Prosím, vyberte tím na priradenie.');
                                return;
                            }
                             // We also need a valid group selected for assignment
                             if (selectedGroupId === null) { // Use the result of selectedGroupId assignment
                                  alert('Pre priradenie tímu je potrebné vybrať kategóriu aj skupinu.');
                                  return;
                             }

                            // Fetch the selected unassigned club document to confirm it exists and is unassigned
                            const clubRefToAssign = doc(clubsCollectionRef, selectedUnassignedClubId);
                            const clubDocToAssign = await getDoc(clubRefToAssign);

                            if (!clubDocToAssign.exists()) {
                                alert('Vybraný tím nebol nájdený alebo už bol priradený/zmazaný.');
                                // Refresh the unassigned list and close modal
                                populateUnassignedClubsSelect(unassignedClubSelect, null);
                                if (clubModal) clubModal.style.display = 'none';
                                if (clubForm) clubForm.reset();
                                 // Reset visibility and required states
                                if (unassignedClubSelectContainer) unassignedClubSelectContainer.style.display = 'block';
                                if (clubNameInputContainer) clubNameInputContainer.style.display = 'none';
                                if (clubGroupSelect && clubGroupSelect.parentElement) clubGroupSelect.parentElement.style.display = 'block';
                                 if (orderInputContainer) orderInputContainer.style.display = 'none';
                                 if (orderInGroupInput) orderInGroupInput.required = false;
                                return;
                            }

                            const clubDataToAssign = clubDocToAssign.data();
                             // Kontrola, či tím naozaj nie je už priradený - pre istotu
                            if (clubDataToAssign.groupId !== null) {
                                alert(`Tím "${clubDataToAssign.name}" je už priradený do skupiny "${clubDataToAssign.groupId}".`);
                                // Refresh the unassigned list and close modal
                                populateUnassignedClubsSelect(unassignedClubSelect, null);
                                if (clubModal) clubModal.style.display = 'none';
                                if (clubForm) clubForm.reset();
                                 // Reset visibility and required states
                                if (unassignedClubSelectContainer) unassignedClubSelectContainer.style.display = 'block';
                                if (clubNameInputContainer) clubNameInputContainer.style.display = 'none';
                                if (clubGroupSelect && clubGroupSelect.parentElement) clubGroupSelect.parentElement.style.display = 'block';
                                 if (orderInputContainer) orderInputContainer.style.display = 'none';
                                 if (orderInGroupInput) orderInGroupInput.required = false;
                                return;
                            }

                            // --- DEFINÍCIA NOVÝCH DÁT A NOVÉHO CIEĽOVÉHO ID PRE PRIRADENÝ TÍM ---
                            const newCategoryId = selectedCategoryId;
                            const newName = clubDataToAssign.name; // Názov tímu zostáva rovnaký
                            const newGroupId = selectedGroupId;
                            const newOrderInGroup = orderInGroup; // Môže byť null, ak nebolo zadané

                             // *** KONŠTRUKCIA NOVÉHO CIEĽOVÉHO ID DOKUMENTU ***
                             // Formát: "Kategória - Celý Názov Tímu"
                             const newDocumentId = `${newCategoryId} - ${newName}`;
                             const newClubDocRef = doc(clubsCollectionRef, newDocumentId);

                             // --- KONTROLA DUPLICITNÉHO PORADIA V CIEĽOVEJ SKUPINE ---
                             // Vykonáme kontrolu len ak bolo zadané poradie A je vybraná skupina
                            if (newGroupId !== null && newOrderInGroup !== null) {
                                 // Pred kontrolou duplicity poradia zistíme, či dokument na cieľovom ID už existuje
                                 const targetDocSnapshotForOrderCheck = await getDoc(newClubDocRef);

                                  const existingOrderQuery = query(clubsCollectionRef,
                                       where('groupId', '==', newGroupId), // Cieľová skupina
                                       where('orderInGroup', '==', newOrderInGroup),
                                       // Ak cieľový dokument existuje, vylúčime ho z kontroly duplicity poradia
                                       ...(targetDocSnapshotForOrderCheck.exists() ? [where('__name__', '!=', newDocumentId)] : [])
                                  );
                                  const existingOrderSnapshot = await getDocs(existingOrderQuery);
                                  if (!existingOrderSnapshot.empty) {
                                       alert(`Tím s poradovým číslom "${newOrderInGroup}" už v skupine "${newGroupId}" existuje! Prosím, zvoľte iné poradové číslo.`);
                                       return;
                                  }
                            }


                            // --- Vykonať BATCH operácie (mazanie starého, vytvorenie/prepísanie nového) ---
                            const batch = writeBatch(db);

                            // 1. Zmazať pôvodný nepriradený dokument
                            batch.delete(clubRefToAssign);
                             console.log(`Pôvodný nepriradený dokument tímu (ID: ${selectedUnassignedClubId}) označený na zmazanie.`);

                            // 2. Vytvoriť alebo prepísať dokument s novým cieľovým ID a priradenými dátami
                            // setDoc s konkrétnym ID buď vytvorí nový dokument, alebo prepíše existujúci
                            batch.set(newClubDocRef, {
                                name: newName, // Uložíme plný názov
                                categoryId: newCategoryId,
                                groupId: newGroupId, // Priradený k skupine
                                orderInGroup: newOrderInGroup // Uložíme poradie (môže byť null)
                                // prípadné ďalšie polia z pôvodného dokumentu by bolo potrebné preniesť, ak existujú
                                // Pre jednoduchosť prenášame len tie, ktoré sú definované pri novom sete
                            });
                             console.log(`Nový priradený dokument tímu (ID: ${newDocumentId}) označený na vytvorenie/prepísanie.`);


                            await batch.commit(); // Odoslať batch operácie

                             console.log(`Tím "${newName}" úspešne priradený do skupiny "${newGroupId}" s poradím ${newOrderInGroup}. Pôvodný záznam zmazaný, nový vytvorený/prepísaný.`);
                            alert(`Tím "${newName}" úspešne priradený.`);


                        } else if (currentClubModalMode === 'edit-assigned') {
                            // === LOGIKA ÚPRAVY PRIRADENÉHO ALEBO NEPRIRADENÉHO KLUBU (PÔVODNÁ LOGIKA UPDATE) ===
                            // Táto časť zostáva takmer nezmenená, len sa uistite, že používa novú validáciu pre orderInGroup
                            // a že kontrola duplicity poradia správne vylučuje aktuálne upravovaný dokument.

                            const clubIdToEdit = editingClubId;
                            const updatedClubName = clubNameInput && clubNameInput.value.trim();

                            if (!clubIdToEdit) {
                                  console.error("Chyba: Režim úpravy klubu bez platného editingClubId.");
                                  alert("Chyba pri úprave klubu. Prosím, obnovte stránku.");
                                  // Reset stavu a zatvorenie modálu
                                   if (clubModal) clubModal.style.display = 'none'; if (clubForm) clubForm.reset(); currentClubModalMode = 'add-assign'; editingClubId = null;
                                  // Reset visibility a required states
                                   if (unassignedClubSelectContainer) unassignedClubSelectContainer.style.display = 'block';
                                   if (clubNameInputContainer) clubNameInputContainer.style.display = 'none';
                                   if (clubGroupSelect && clubGroupSelect.parentElement) clubGroupSelect.parentElement.style.display = 'block';
                                   if (orderInputContainer) orderInputContainer.style.display = 'none';
                                   if (orderInGroupInput) orderInGroupInput.required = false;
                                  return;
                             }
                             if (clubNameInputContainer.style.display !== 'none' && (!updatedClubName || updatedClubName === '')) { // Validate name only if input is visible
                                  alert('Názov klubu nemôže byť prázdny.');
                                  return;
                             }

                            const clubRefToEdit = doc(clubsCollectionRef, clubIdToEdit);
                            const clubDocToEdit = await getDoc(clubRefToEdit);
                            if (!clubDocToEdit.exists()) {
                                console.error(`Chyba: Dokument klubu ${clubIdToEdit} nenájdený na úpravu.`);
                                alert("Klub na úpravu nebol nájdený.");
                                // Reset stavu a zatvorenie modálu
                                if (clubModal) clubModal.style.display = 'none'; if (clubForm) clubForm.reset(); currentClubModalMode = 'add-assign'; editingClubId = null;
                                displayClubs(); // Refresh display as the club might be gone
                                displayCreatedTeams(); // Refresh created teams list
                                return;
                            }
                            const originalClubData = clubDocToEdit.data();


                            // === Podmienené kontroly duplicity pre režim úpravy ===
                            const targetGroupIdForCheck = selectedGroupId; // Toto je nová groupId (môže byť null)
                             const originalGroupId = originalClubData.groupId || null; // Ensure null if undefined
                             const originalName = originalClubData.name;
                             const originalOrder = typeof originalClubData.orderInGroup === 'number' ? originalClubData.orderInGroup : null; // Ensure null if not a number or undefined

                            // Check if the targetGroupId is NOT null (it's assigned or moved to a group)
                            if (targetGroupIdForCheck !== null) {
                                 // Check if a *different* club with the same updated name already exists IN THE TARGET GROUP
                                 // Táto kontrola sa robí len ak sa zmenil názov ALEBO cieľová skupina je iná ako pôvodná
                                 // Ak cieľová skupina zostáva rovnaká a názov sa mení, alebo ak sa mení skupina
                                 if (updatedClubName !== originalName || targetGroupIdForCheck !== originalGroupId) {
                                      const existingClubInTargetGroupQuery = query(clubsCollectionRef,
                                           where('groupId', '==', targetGroupIdForCheck), // Cieľová skupina (môže byť rovnaká ako pôvodná)
                                           where('name', '==', updatedClubName),     // Nový názov
                                           where('__name__', '!=', clubIdToEdit) // Vylúčime upravovaný dokument
                                      );
                                      const existingClubInTargetGroupSnapshot = await getDocs(existingClubInTargetGroupQuery);
                                      if (!existingClubInTargetGroupSnapshot.empty) {
                                           alert(`Klub s názvom "${updatedClubName}" už v cieľovej skupine "${targetGroupIdForCheck}" existuje! Prosím, zvoľte iný názov alebo skupinu.`);
                                           return;
                                      }
                                 }

                                 // Check if a *different* team with the same updated order number already exists IN THE TARGET GROUP
                                  // Only perform this check if an order number was provided (is not null) and the target group is not null
                                 // Táto kontrola sa robí len ak sa zmenilo poradie ALEBO cieľová skupina je iná ako pôvodná
                                 // A ak cieľová skupina nie je null A bolo zadané nové poradie
                                if (targetGroupIdForCheck !== null && orderInGroup !== null) {
                                      if (orderInGroup !== originalOrder || targetGroupIdForCheck !== originalGroupId) {
                                           const existingOrderQuery = query(clubsCollectionRef,
                                                where('groupId', '==', targetGroupIdForCheck), // Cieľová skupina (môže byť rovnaká ako pôvodná)
                                                where('orderInGroup', '==', orderInGroup),
                                                where('__name__', '!=', clubIdToEdit) // Vylúčime upravovaný dokument
                                           );
                                           const existingOrderSnapshot = await getDocs(existingOrderQuery);
                                           if (!existingOrderSnapshot.empty) {
                                                alert(`Tím s poradovým číslom "${orderInGroup}" už v skupine "${targetGroupIdForCheck}" existuje! Prosím, zvoľte iné poradové číslo.`);
                                                return;
                                           }
                                      }
                                 }

                             } else { // The targetGroupId IS null (remains unassigned or is being unassigned)
                                  // Ak sa mení názov nepriradeného tímu, skontroluj duplicity medzi ostatnými nepriradenými
                                  // Túto kontrolu robíme len ak pôvodne bol tím nepriradený A zmenil sa jeho názov
                                  if (updatedClubName !== originalName && originalGroupId === null) {
                                      const existingUnassignedClubQuery = query(clubsCollectionRef,
                                           where('groupId', '==', null), // Hľadaj len medzi nepriradenými
                                           where('name', '==', updatedClubName),
                                           where('__name__', '!=', clubIdToEdit) // Vylúčime upravovaný dokument
                                      );
                                      const existingUnassignedClubSnapshot = await getDocs(existingUnassignedClubQuery);
                                      if (!existingUnassignedClubSnapshot.empty) {
                                          alert(`Iný nepriradený klub s názvom "${updatedClubName}" už existuje!`);
                                          return;
                                      }
                                  }
                                   // Order number is not relevant for unassigned teams, no duplication check needed here
                               }


                             // Update the assigned/unassigned club document
                             await updateDoc(clubRefToEdit, {
                                  name: updatedClubName, // Update name
                                 categoryId: selectedCategoryId, // Allow changing category even for unassigned
                                 groupId: selectedGroupId, // This will be null if the group select was hidden/disabled or 'Nepriradená' was chosen (ak by bola taká možnosť)
                                  orderInGroup: selectedGroupId !== null ? orderInGroup : null // Save order only if assigned to a group (groupId is not null)
                                 // Update other fields if they were in the form
                             });

                             console.log(`Klub "${updatedClubName}" (ID: ${clubIdToEdit}) úspešne upravený. Nová skupina: ${selectedGroupId}, Nové poradie: ${orderInGroup}.`);
                             alert(`Klub úspešne upravený.`);

                         }

                         // --- Common logic after successful add/assign or edit ---
                         if (clubModal) clubModal.style.display = 'none';
                         if (clubForm) clubForm.reset();
                         currentClubModalMode = 'add-assign'; // Reset state to add-assign
                         editingClubId = null; // Clear editing ID

                         // Reset visibility of name input vs select for next time
                          if (unassignedClubSelectContainer) unassignedClubSelectContainer.style.display = 'block';
                          if (clubNameInputContainer) clubNameInputContainer.style.display = 'none';
                          // Reset group select visibility for club modal
                          if (clubGroupSelect && clubGroupSelect.parentElement) clubGroupSelect.parentElement.style.display = 'block';
                          // Reset order input visibility for club modal
                          if (orderInputContainer) orderInputContainer.style.display = 'none';
                          if (orderInGroupInput) orderInGroupInput.required = false;


                         // Refresh displays that might be affected
                         // Refresh main 'Created Teams' display (shows all teams now)
                          displayCreatedTeams();
                          // Refresh clubs-in-groups display if visible, as an assigned team was edited/assigned/unassigned
                          if (window.location.hash === '#timy-do-skupin') {
                               displayClubs(); // Refresh assigned clubs display
                          }


                     } catch (error) {
                         console.error('Chyba pri ukladaní alebo priradzovaní klubu: ', error);
                         alert(`Chyba pri ukladaní alebo priradzovaní klubu! Detail: ${error.message}`);
                          // Zatvor modál a resetuj stav pri chybe
                          if (clubModal) clubModal.style.display = 'none';
                          if (clubForm) clubForm.reset();
                          currentClubModalMode = 'add-assign'; editingClubId = null;
                           // Reset visibility of name input vs select on error
                          if (unassignedClubSelectContainer) unassignedClubSelectContainer.style.display = 'block';
                          if (clubNameInputContainer) clubNameInputContainer.style.display = 'none';
                           // Reset group select visibility for club modal on error
                          if (clubGroupSelect && clubGroupSelect.parentElement) clubGroupSelect.parentElement.style.display = 'block';
                           // Reset order input visibility on error
                          if (orderInputContainer) orderInputContainer.style.display = 'none';
                          if (orderInGroupInput) orderInGroupInput.required = false; // Ensure required is false on error
                     }
                });
            } else { console.error("Club form not found!"); }


            // Funkcia na zobrazenie klubov usporiadaných podľa kategórií a skupín (PRIRADENÉ tímy)
            // fetchuje kluby s groupId != null
             // Funkcia na zobrazenie klubov usporiadaných podľa kategórií a skupín (PRIRADENÉ tímy)
             // fetchuje kluby s groupId != null
             async function displayClubs() {
                clubsContentDiv.innerHTML = ''; // Vyčistiť kontajner

                try {
                    // Načítať všetky kluby, ktoré SÚ priradené do skupín (groupId != null)
                     const q = query(clubsCollectionRef, where('groupId', '!=', null));
                    const clubsSnapshot = await getDocs(q);

                    const clubs = clubsSnapshot.docs.map(clubDoc => ({ id: clubDoc.id, data: clubDoc.data() })); // Get club data with auto-generated ID

                    if (clubs.length === 0) {
                        console.log("Žiadne kluby priradené do skupín nenájdené.");
                        const message = document.createElement('p');
                        message.textContent = "Žiadne kluby zatiaľ neboli priradené do skupín.";
                        clubsContentDiv.appendChild(message); // Správu pridáme do kontajnera div
                        return;
                    }

                    // Zoskupenie klubov najprv podľa categoryId a potom podľa groupId
                    const clubsByCategoryAndGroup = {};
                    clubs.forEach(club => {
                        const categoryId = club.data.categoryId;
                        const groupId = club.data.groupId; // Toto je kompozitné ID skupiny (NázovKategórie - NázovSkupiny)

                        // Ensure categoryId and groupId exist for grouping
                         if (categoryId && groupId && categoryId !== 'null' && groupId !== 'null') { // Added check against 'null' strings
                             if (!clubsByCategoryAndGroup[categoryId]) {
                                 clubsByCategoryAndGroup[categoryId] = {};
                             }
                             if (!clubsByCategoryAndGroup[categoryId][groupId]) {
                                 clubsByCategoryAndGroup[categoryId][groupId] = [];
                             }
                              clubsByCategoryAndGroup[categoryId][groupId].push(club); // Uložíme celý objekt { id: auto-generated, data }
                         } else {
                             console.warn(`Klub ${club.id} priradený do skupiny (groupId != null) nemá platnú categoryId (${categoryId}) alebo groupId (${groupId}).`);
                         }
                    });

                    // Získaj zotriedené názvy kategórií
                    const sortedCategories = Object.keys(clubsByCategoryAndGroup).sort();

                     if (sortedCategories.length === 0 && clubs.length > 0) {
                         // This case happens if clubs exist but none have valid categoryId/groupId for grouping
                          console.warn("Kluby boli nájdené, ale žiadne nemajú platné categoryId/groupId na zobrazenie v skupinách.");
                          const message = document.createElement('p');
                          errorMessage.textContent = "Existujú kluby, ale žiadne nemajú priradenú kategóriu a skupinu pre zobrazenie tu."; // Used errorMessage variable name accidentally, corrected
                           message.textContent = "Existujú kluby, ale žiadne nemajú priradenú kategóriu a skupinu pre zobrazenie tu.";
                          clubsContentDiv.appendChild(message);
                          return;
                     }


                    // Iteruj cez kategórie a skupiny, aby si vytvoril/a sekcie a tabuľky
                    sortedCategories.forEach(categoryId => {
                        // Získaj zotriedené kompozitné ID skupín v danej kategórii
                        const sortedGroups = Object.keys(clubsByCategoryAndGroup[categoryId]).sort();

                        sortedGroups.forEach(groupId => {
                            const clubsInThisGroup = clubsByCategoryAndGroup[categoryId][groupId];

                            // Vytvor section block pre túto kombináciu kategória-skupina
                            const groupClubSectionDiv = document.createElement('div');
                            groupClubSectionDiv.classList.add('section-block');

                            // Vytvor nadpis pre túto sekciu
                            const groupNameParts = groupId.split(' - ');
                            const groupName = groupNameParts.length > 1 ? groupNameParts.slice(1).join(' - ') : groupId;

                            const sectionHeading = document.createElement('h2');
                            sectionHeading.textContent = `${categoryId} - ${groupName}`;
                            groupClubSectionDiv.appendChild(sectionHeading);

                            // Vytvor tabuľku pre kluby v tejto skupine
                            const clubTable = document.createElement('table');
                       // Môžete použiť existujúce štýly tabuliek alebo pridať nové
                      clubTable.classList.add('group-clubs-table'); // Re-use class for basic styling


                            // Vytvor hlavičku tabuľky - PRIDANÝ STĹPEC PORADIE
                            const thead = document.createElement('thead');
                            const headerRow = document.createElement('tr');
                            const orderTh = document.createElement('th'); // New header for order
                            orderTh.textContent = '';
                            // Removed explicit width: orderTh.style.width = '80px';
                            const clubNameTh = document.createElement('th');
                            clubNameTh.textContent = 'Názov klubu';
                             const actionsTh = document.createElement('th');
                             actionsTh.textContent = ''; // Changed header to Akcie
                             // Removed explicit width: actionsTh.style.width = '150px';

                             headerRow.appendChild(orderTh); // Add order header
                             headerRow.appendChild(clubNameTh);
                             headerRow.appendChild(actionsTh);
                             thead.appendChild(headerRow);
                             clubTable.appendChild(thead);


                            // Vytvor telo tabuľky
                            const tbody = document.createElement('tbody');

                            if (clubsInThisGroup.length === 0) {
                                 const noClubsRow = document.createElement('tr');
                                 const td = document.createElement('td');
                                 td.colSpan = 3; // Adjusted colspan
                                 td.textContent = `Žiadne kluby v tejto skupine.`;
                                 td.style.textAlign = 'center';
                                 tbody.appendChild(noClubsRow); // Corrected this line
                            } else {
                                 // Sort clubs WITHIN THIS GROUP by orderInGroup (numeric)
                                 // Fallback: if orderInGroup is missing, treat as larger than any number to sort last
                                 clubsInThisGroup.sort((a, b) => {
                                     const orderA = a.data.orderInGroup;
                                     const orderB = b.data.orderInGroup;

                                     // Convert to number, handle non-numeric or missing values
                                     const numA = typeof orderA === 'number' ? orderA : Infinity;
                                     const numB = typeof orderB === 'number' ? orderB : Infinity;

                                     if (numA !== numB) {
                                          return numA - numB; // Sort numerically
                                     } else {
                                          // If order is the same or both are non-numeric/missing, sort by name as a fallback
                                         return (a.data.name || '').localeCompare(b.data.name || '');
                                     }
                                 });


                                 // Pridaj riadky pre každý klub v tejto skupine
                                 clubsInThisGroup.forEach(club => {
                                     const tr = document.createElement('tr');

                                     const orderTd = document.createElement('td'); // New cell for order
                                      // Display order number, or '-' if not set
                                     orderTd.textContent = typeof club.data.orderInGroup === 'number' ? club.data.orderInGroup : '-';
                                     // orderTd.style.textAlign = 'center'; /* This style is now handled by CSS rule .group-clubs-table tbody td:first-child */


                                     const nameTd = document.createElement('td');
                                     nameTd.textContent = club.data.name; // Zobraz názov klubu z dát

                                     const actionsTd = document.createElement('td');
                                     actionsTd.style.whiteSpace = 'nowrap';

                                     // === TLAČIDLO ÚPRAVA KLUBU (ZMENIŤ SKUPINU/KATEGÓRIU/NÁZOV) ===
                                     // Otvorí clubModal v režime úpravy priradeného
                                      const editClubButton = document.createElement('button');
                                      editClubButton.textContent = 'Upraviť';
                                      editClubButton.classList.add('action-button');
                                      editClubButton.onclick = () => {
                                           // Open the club modal with the current club data for editing
                                          // Pass the auto-generated ID and data
                                           openClubModal(club.id, club.data);
                                       };


                                     // === TLAČIDLO ODOBRAŤ KLUBU (ZMAZAŤ PRIRADENIE) ===
                                     // ZMENENÉ SPRÁVANIE: NEMAŽE DOKUMENT, IBA ODSTRÁNI PRIRADENIE K SKUPINE
                                       const unassignClubButton = document.createElement('button');
                                       unassignClubButton.textContent = 'Odobrať'; // Changed text
                                       unassignClubButton.classList.add('action-button', 'delete-button'); // Reusing delete-button style
                                       unassignClubButton.onclick = async () => {
                                           if (!confirm(`Naozaj chcete odobrať klub "${club.data.name}" zo skupiny "${groupName}" v kategórii "${categoryId}"? Tím sa vráti medzi nepriradené tímy.`)) { // Updated confirmation
                                               return;
                                           }
                                           try {
                                                // Update the existing club document to remove group and order assignment
                                                await updateDoc(doc(clubsCollectionRef, club.id), {
                                                    groupId: null, // Set groupId to null
                                                    orderInGroup: null // Set orderInGroup to null
                                                });
                                                console.log(`Klub "${club.data.name}" (ID: ${club.id}) úspešne odpriradený.`); // Updated log message

                                                // Refresh displays that might be affected
                                                displayClubs(); // Refresh assigned clubs display (this team will disappear)
                                                // Refresh main 'Created Teams' display because an unassigned team was created (it will reappear there)
                                                // Always refresh created teams list regardless of hash, as assignments change which teams are unassigned
                                                displayCreatedTeams();


                                           } catch (error) {
                                                console.error('Chyba pri odpriradzovaní klubu: ', error); // Updated error message
                                                alert('Chyba pri odpriradzovaní klubu! Prosím, skúste znova.'); // Updated alert
                                           }
                                       };

                                        actionsTd.appendChild(editClubButton);
                                        actionsTd.appendChild(unassignClubButton); // Use the new unassign button

                                       tr.appendChild(orderTd); // Add order cell
                                       tr.appendChild(nameTd);
                                       tr.appendChild(actionsTd);

                                       tbody.appendChild(tr);
                                    });
                                 }

                                 clubTable.appendChild(tbody);
                                 groupClubSectionDiv.appendChild(clubTable); // OPRAVENÝ PREKLEP
                                 clubsContentDiv.appendChild(groupClubSectionDiv);
                              });
                         });

                         console.log("Kluby priradené do skupín boli načítané a zobrazené.");

                    } catch (error) {
                        console.error('Chyba pri načítaní alebo zobrazovaní klubov: ', error);
                        const errorMessage = document.createElement('p');
                        errorMessage.textContent = 'Chyba pri načítaní dát klubov priradených do skupín.';
                        clubsContentDiv.appendChild(errorMessage);
                    }
             }

             // Funkcia na zobrazenie vytvorených tímov (klubov) - teraz zobrazuje VŠETKY tímy, zoskupené podľa základného názvu a kategórie
             async function displayCreatedTeams() {
                  createdTeamsTableBody.innerHTML = ''; // Clear existing rows
                  createdTeamsTableHeader.innerHTML = ''; // Clear existing header (except first and last columns)


                  try {
                      // 1. Načítať všetky kategórie pre dynamickú hlavičku
                      const categoriesSnapshot = await getDocs(categoriesCollectionRef);
                      const categories = categoriesSnapshot.docs.map(doc => doc.id).sort((a, b) => a.localeCompare(b, 'sk-SK')); // Získaj a zotried názvy kategórií

                      // Vytvoriť prvý stĺpec hlavičky
                      const teamNameTh = document.createElement('th');
                      teamNameTh.textContent = 'Názov tímu';
                      createdTeamsTableHeader.appendChild(teamNameTh);

                      // Vytvoriť stĺpce hlavičky pre každú kategóriu
                      categories.forEach(categoryName => {
                          const categoryTh = document.createElement('th');
                          categoryTh.textContent = categoryName;
                          categoryTh.style.textAlign = 'center'; // Zarovnanie pre počty
                          createdTeamsTableHeader.appendChild(categoryTh);
                      });

                      // Vytvoriť posledný stĺpec hlavičky
                      const actionsTh = document.createElement('th');
                      actionsTh.textContent = ''; // Changed header to Akcie
                      actionsTh.style.width = '150px';
                      createdTeamsTableHeader.appendChild(actionsTh);


                      // 2. Načítať VŠETKY tímy (kluby), nie len nepriradené
                      const q = query(clubsCollectionRef); // Removed where('groupId', '==', null)
                      const querySnapshot = await getDocs(q);

                      // 3. Zoskupiť tímy podľa základného názvu a spočítať pre kategórie
                      const teamsByBaseName = {};
                      querySnapshot.docs.forEach(doc => {
                          const clubData = doc.data();
                           // OPRAVENÁ LOGIKA EXTRAKCIE ZÁKLADNÉHO NÁZVU PRE ZOSKUPENIE
                           // Pre nový formát ID "Kategória - Základný Názov Tímu [Suffix]"
                          let baseTeamName = 'Neznámy názov'; // Default
                           const idParts = doc.id.split(' - ');
                           if (idParts.length >= 2) {
                               const secondPart = idParts.slice(1).join(' - '); // Get the part after the first ' - ' (e.g., "HC Tatran Stupava A")
                                // Attempt to remove trailing space + single uppercase letter (like " A")
                               const suffixMatch = secondPart.match(/^(.*)\s[A-Z]$/);
                                baseTeamName = suffixMatch ? suffixMatch[1] : secondPart; // Use the part before suffix if found, otherwise use the whole second part
                           } else {
                                // Fallback pre staré ID formáty alebo neočakávané ID: skús extrahovať suffix z názvu tímu
                               const fullTeamName = clubData.name || 'Neznámy názov';
                               const nameSuffixMatch = fullTeamName.match(/^(.*)\s[A-Z]$/);
                                baseTeamName = nameSuffixMatch ? nameSuffixMatch[1] : fullTeamName;
                           }


                          const categoryId = clubData.categoryId || 'Nepriradená'; // Ak tím nemá kategóriu


                          if (!teamsByBaseName[baseTeamName]) {
                              teamsByBaseName[baseTeamName] = {
                                  categories: {},
                                  originalTeams: [] // Uložíme originálne dokumenty pre akcie
                              };
                          }

                          if (!teamsByBaseName[baseTeamName].categories[categoryId]) {
                               teamsByBaseName[baseTeamName].categories[categoryId] = 0;
                          }
                          teamsByBaseName[baseTeamName].categories[categoryId]++;
                          teamsByBaseName[baseTeamName].originalTeams.push({ id: doc.id, data: clubData }); // Uložíme info o pôvodnom tíme
                      });

                       console.log("Zoskupené tímy (všetky):", teamsByBaseName);


                      // 4. Vygenerovať riadky tabuľky na základe zoskupených dát
                      // POUŽITIE localeCompare PRE ZORADENIE SO SLOVENSKOU DIAKRITIKOU
                      const sortedBaseNames = Object.keys(teamsByBaseName).sort((a, b) => a.localeCompare(b, 'sk-SK'));

                      if (sortedBaseNames.length === 0) {
                          const noDataRow = document.createElement('tr');
                          const td = document.createElement('td');
                          td.colSpan = 2 + categories.length; // Názov + Počet kategórií + Akcie
                          td.textContent = "Žiadne tímy zatiaľ pridané.";
                          td.style.textAlign = 'center';
                          noDataRow.appendChild(td);
                          createdTeamsTableBody.appendChild(noDataRow);
                      } else {
                          sortedBaseNames.forEach(baseTeamName => {
                              const teamSummary = teamsByBaseName[baseTeamName];
                              const tr = document.createElement('tr');

                              // Bunka pre názov tímu
                              const nameTd = document.createElement('td');
                              nameTd.textContent = baseTeamName; // Zobraz základný názov
                              tr.appendChild(nameTd);

                              // Bunky pre počty tímov v kategóriách
                              categories.forEach(categoryName => {
                                  const countTd = document.createElement('td');
                                  // Zobraz počet tímov pre túto kategóriu a tento základný názov
                                  const count = teamSummary.categories[categoryName] || 0;
                                  countTd.textContent = count > 0 ? count : '-'; // Zobraz '-' ak je počet 0
                                  countTd.style.textAlign = 'center'; // Zarovnanie pre počty
                                  tr.appendChild(countTd);
                              });

                              // Bunka pre akcie
                              const actionsTd = document.createElement('td');
                              actionsTd.style.whiteSpace = 'nowrap';

                              // === Akcie (Spravovať tímy / Vymazať VŠETKY) ===
                               const manageTeamsButton = document.createElement('button');
                               manageTeamsButton.textContent = 'Spravovať tímy';
                               manageTeamsButton.classList.add('action-button');
                               manageTeamsButton.onclick = () => {
                                   // Otvoriť nový modál a zobraziť v ňom individuálne tímy
                                   openManageTeamsModal(baseTeamName, teamSummary.originalTeams);
                               };
                               actionsTd.appendChild(manageTeamsButton);


                               // Tlačidlo na hromadné vymazanie všetkých tímov s týmto základným názvom
                               const deleteAllButton = document.createElement('button');
                               deleteAllButton.textContent = 'Vymazať';
                               deleteAllButton.classList.add('action-button', 'delete-button');
                               deleteAllButton.onclick = async () => {
                                   if (!confirm(`Naozaj chcete vymazať VŠETKY tímy s názvom "${baseTeamName}" (${teamSummary.originalTeams.length} ks)?`)) {
                                       return;
                                   }
                                   try {
                                        const batch = writeBatch(db);
                                        // Pre každý originálny tím dokument pod týmto základným názvom, pridaj operáciu mazania do batchu
                                        teamSummary.originalTeams.forEach(team => {
                                            batch.delete(doc(clubsCollectionRef, team.id)); // Použi auto-generované ID
                                        });

                                       await batch.commit();
                                       console.log(`Všetky tímy s názvom "${baseTeamName}" (${teamSummary.originalTeams.length} ks) boli úspešne zmazané.`);
                                       displayCreatedTeams(); // Refresh the list
                                        // Refresh clubs-in-groups display if visible, as some assigned teams might have been deleted
                                       if (window.location.hash === '#timy-do-skupin') { displayClubs(); }

                                        // Po zmazaní tímov môže byť potrebné aktualizovať aj ponuky kategórií
                                        if (teamCreationModal.style.display === 'block') {
                                             loadAllCategoriesForDynamicSelects(); // Načítaj znovu kategórie, čo zavolá aj updateDynamicCategorySelects a checkIfAddCategoryButtonShouldBeVisible
                                        }


                                   } catch (error) {
                                       console.error(`Chyba pri mazaní tímov s názvom "${baseTeamName}": `, error);
                                       alert('Chyba pri mazaní tímov!');
                                   }
                                };
                                actionsTd.appendChild(deleteAllButton);


                              tr.appendChild(actionsTd);
                              createdTeamsTableBody.appendChild(tr);
                          });
                      }

                      console.log(`Načítaných základných názvov tímov (všetky): ${sortedBaseNames.length}`);

                  } catch (error) {
                      console.error('Chyba pri načítaní alebo zobrazovaní vytvorených tímov: ', error);
                      const errorMessage = document.createElement('tr'); // Use tr to fit in table body
                      const td = document.createElement('td');
                      // Výpočet colspan: 1 (Názov tímu) + počet kategórií + 1 (Akcie)
                      td.colSpan = 2 + categories.length;
                      td.textContent = 'Chyba pri načítaní dát tímov.';
                      td.style.textAlign = 'center';
                      errorMessage.appendChild(td);
                      createdTeamsTableBody.appendChild(errorMessage);
                  }
             }

             // Funkcia na zatvorenie modálu pre správu individuálnych tímov
              function closeManageTeamsModal() {
                  manageTeamsModal.style.display = 'none';
                  teamsListInModalDiv.innerHTML = ''; // Vyčistiť obsah pri zatvorení
              }

             // Funkcia na otvorenie modálu a zobrazenie individuálnych tímov
             // baseTeamName: základný názov tímu (string)
             // individualTeams: pole objektov { id: teamId, data: teamData } pre tímy s týmto názvom
             async function openManageTeamsModal(baseTeamName, individualTeams) {
                  manageTeamsModal.style.display = 'block';
                  if (!baseTeamNameInModalSpan) { console.error('FATAL ERROR: baseTeamNameInModalSpan is null!'); return; } // Safety check
                  baseTeamNameInModalSpan.textContent = baseTeamName; // Nastav základný názov v nadpise modálu
                  if (!teamsListInModalDiv) { console.error('FATAL ERROR: teamsListInModalDiv is null!'); return; } // Safety check
                  teamsListInModalDiv.innerHTML = ''; // Vyčistiť pred naplnením

                  if (!individualTeams || individualTeams.length === 0) {
                      teamsListInModalDiv.innerHTML = '<p>Žiadne individuálne tímy nájdené pre tento názov.</p>';
                      return;
                  }

                  // Zoskupiť individuálne tímy podľa kategórie pre zobrazenie
                  const teamsByCategory = {};
                  individualTeams.forEach(team => {
                      const category = team.data.categoryId || 'Nepriradená';
                      if (!teamsByCategory[category]) {
                          teamsByCategory[category] = [];
                      }
                      teamsByCategory[category].push(team);
                  });

                  // Získaj zotriedené názvy kategórií
                  const sortedCategories = Object.keys(teamsByCategory).sort();

                  // Pre každú kategóriu vytvoriť menšiu tabuľku alebo zoznam v modáli
                  sortedCategories.forEach(categoryName => {
                      const teamsInThisCategory = teamsByCategory[categoryName];

                      const categoryHeading = document.createElement('h3');
                      categoryHeading.textContent = `${categoryName}`;
                      teamsListInModalDiv.appendChild(categoryHeading);

                      // Vytvoriť menšiu tabuľku pre tímy v tejto kategórii
                      const categoryTeamsTable = document.createElement('table');
                       // Môžete použiť existujúce štýly tabuliek alebo pridať nové
                      categoryTeamsTable.classList.add('group-clubs-table'); // Re-use class for basic styling


                      const thead = document.createElement('thead');
                      const headerRow = document.createElement('tr');
                      const teamNameTh = document.createElement('th');
                      teamNameTh.textContent = 'Názov tímu (celý)'; // Indicate it's the full name
                       const groupTh = document.createElement('th'); // New header for Group
                       groupTh.textContent = 'Skupina';
                        const orderTh = document.createElement('th'); // New header for Order
                        orderTh.textContent = '';
                       const actionsTh = document.createElement('th');
                       actionsTh.textContent = ''; // Changed header to Akcie
                       actionsTh.style.width = '150px'; // Ensure width for buttons

                       headerRow.appendChild(teamNameTh);
                       headerRow.appendChild(groupTh); // Add Group header
                       headerRow.appendChild(orderTh); // Add Order header
                       headerRow.appendChild(actionsTh);
                       thead.appendChild(headerRow);
                       categoryTeamsTable.appendChild(thead);


                      const tbody = document.createElement('tbody');

                      // Zotriediť tímy v kategórii podľa názvu
                       // Zotriediť tímy WITHIN THIS CATEGORY najprv podľa stavu priradenia (nepriradené prvé), potom podľa názvu
                       teamsInThisCategory.sort((a, b) => {
                            const isAssignedA = a.data.groupId !== null;
                            const isAssignedB = b.data.groupId !== null;

                            // Nepriradené tímy (groupId === null) idú prvé
                            if (isAssignedA !== isAssignedB) {
                                 return isAssignedA ? 1 : -1; // Ak je A priradené a B nepriradené, A ide po B (+1)
                            }

                             // Ak sú oba priradené alebo oba nepriradené, zoradiť podľa názvu
                             return (a.data.name || '').localeCompare(b.data.name || '');
                       });


                      teamsInThisCategory.forEach(team => {
                          const tr = document.createElement('tr');

                          const nameTd = document.createElement('td');
                          nameTd.textContent = team.data.name || 'Neznámy názov';
                          tr.appendChild(nameTd);

                           const groupTd = document.createElement('td'); // New cell for Group
                           // Display group name if assigned, otherwise 'Nepriradené'
                           const groupNameParts = (team.data.groupId || '').split(' - ');
                           groupTd.textContent = team.data.groupId ? (groupNameParts.length > 1 ? groupNameParts.slice(1).join(' - ') : team.data.groupId) : 'Nepriradené';
                           tr.appendChild(groupTd);


                           const orderTd = document.createElement('td'); // New cell for Order
                            // Display order number if assigned, otherwise '-'
                           orderTd.textContent = team.data.groupId !== null && typeof team.data.orderInGroup === 'number' ? team.data.orderInGroup : '-';
                           orderTd.style.textAlign = 'center';
                           tr.appendChild(orderTd);


                          const actionsTd = document.createElement('td');
                          actionsTd.style.whiteSpace = 'nowrap';


                          // === TLAČIDLO ÚPRAVA INDIVIDUÁLNEHO TÍMU ===
                           // Toto by malo otvoriť existujúci clubModal, ale v špecifickom režime
                           // pre úpravu NEPRIRADENÉHO tímu (zmeniť názov, prípadne kategóriu)
                          const editIndividualTeamButton = document.createElement('button');
                          editIndividualTeamButton.textContent = 'Upraviť';
                          editIndividualTeamButton.classList.add('action-button');
                          editIndividualTeamButton.onclick = () => {
                              // Pred otvorením clubModal musíme nastaviť jeho stav a dáta
                              // clubModal je primárne na priradzovanie do skupín/úpravu priradených.
                              // Potrebujeme režim úpravy nepriradeného tímu.
                              // Musíme si byť istí, že clubModal formulár a logika to zvládne.
                              console.log("Pokus o úpravu individuálneho tímu:", team);

                              // Zatvoriť manageTeamsModal pred otvorením clubModal
                              closeManageTeamsModal();

                              // Otvoríme existujúci clubModal s dátami tohto tímu
                              // Potrebujeme ho otvoriť v režime, kde sa nedá vybrať skupina, len zmeniť názov/kategória.
                              // Použijeme režim 'edit-assigned', ale prispôsobíme ho v openClubModal
                              openClubModal(team.id, team.data); // Zavoláme openClubModal s ID a dátami

                          };
                          actionsTd.appendChild(editIndividualTeamButton);


                          // === TLAČIDLO VYMAZAŤ INDIVIDUÁLNY TÍM ===
                          // Tento button v tomto modali ZMAŽE dokument úplne
                          const deleteIndividualTeamButton = document.createElement('button');
                          deleteIndividualTeamButton.textContent = 'Vymazať';
                          deleteIndividualTeamButton.classList.add('action-button', 'delete-button');
                          deleteIndividualTeamButton.onclick = async () => {
                              if (!confirm(`Naozaj chcete vymazať tím "${team.data.name}" z kategórie "${categoryName}"? Táto akcia vymaže tím úplne.`)) { // Clarified confirmation
                                  return;
                              }
                              try {
                                  // Na zmazanie použi auto-generované ID tohto konkrétneho tímu
                                  await deleteDoc(doc(clubsCollectionRef, team.id));
                                  console.log(`Individuálny tím "${team.data.name}" (ID: ${team.id}) úspešne zmazaný.`);

                                  // Po zmazaní refreshnúť ZOBRAZENIE v manageTeamsModal
                                  // a tiež zobrazenie v hlavnej sekcii #zoznam-timov
                                   // A simpler approach: close the modal and force refresh of the main #zoznam-timov list
                                   closeManageTeamsModal(); // Zatvor modál

                                  // Refresh the main 'Created Teams' section display (shows all teams now)
                                   displayCreatedTeams();
                                   // Refresh clubs-in-groups display if visible, as some assigned teams might have been deleted
                                  if (window.location.hash === '#timy-do-skupin') { displayClubs(); }


                              } catch (error) {
                                  console.error(`Chyba pri mazaní individuálneho tímu "${team.data.name}" (ID: ${team.id}): `, error);
                                  alert('Chyba pri mazaní tímu!');
                              }
                          };
                          actionsTd.appendChild(deleteIndividualTeamButton);

                          tr.appendChild(actionsTd); // Add actions cell

                          tbody.appendChild(tr);
                      });

                      categoryTeamsTable.appendChild(tbody); // Toto je v modáli pre správu individuálnych tímov - tu je názov categoryTeamsTable správny
                      teamsListInModalDiv.appendChild(categoryTeamsTable); // Toto je v modáli pre správu individuálnych tímov - tu je názov categoryTeamsTable správny
                  });

                  // Môžete nastaviť focus na prvé tlačidlo alebo prvý input v modáli, ak je to potrebné
                  // manageTeamsModalCloseBtn.focus();
             }

             // --- Funkcia na načítanie všetkých kategórií pre dynamické selecty v modáli Vytvorenie Tímov ---
             async function loadAllCategoriesForDynamicSelects() {
                 try {
                     const querySnapshot = await getDocs(categoriesCollectionRef);
                     allAvailableCategories = querySnapshot.docs.map(doc => doc.id).sort((a, b) => a.localeCompare(b, 'sk-SK')); // Sort alphabetically
                     console.log("Načítané kategórie pre dynamické selecty:", allAvailableCategories);
                     // Po načítaní, ak je modál otvorený, aktualizuj selecty
                      if (teamCreationModal.style.display === 'block') {
                           updateDynamicCategorySelects();
                           checkIfAddCategoryButtonShouldBeVisible(); // Aj po načítaní kategórií treba skontrolovať viditeľnosť tlačidla
                      }
                 } catch (error) {
                     console.error('Chyba pri načítaní kategórií pre dynamické selecty: ', error);
                     allAvailableCategories = []; // Vyčistiť na chybu
                      // Ak nastala chyba pri načítaní, skryť tlačidlo na pridanie kategórie
                      checkIfAddCategoryButtonShouldBeVisible(); // Kontrola viditeľnosti tlačidla
                 }
            }

            // Pomocná funkcia na naplnenie jedného dynamického selectu kategórií
            // s vylúčením kategórií, ktoré sú už vybraté v iných selectoch
            function populateDynamicCategorySelect(selectElement, currentSelectedId, allCategories, categoriesToExclude) {
                 selectElement.innerHTML = '<option value="">-- Vyberte kategóriu --</option>'; // Reset
                 selectElement.disabled = allCategories.length === 0; // Disable if no categories

                 // Pridaj možnosť pre aktuálne vybranú kategóriu, ak existuje a nie je null/prázdna
                 if (currentSelectedId && allCategories.includes(currentSelectedId)) {
                      const currentOption = document.createElement('option');
                      currentOption.value = currentSelectedId;
                      currentOption.textContent = currentSelectedId;
                      currentOption.selected = true;
                      selectElement.appendChild(currentOption);
                 }


                 allCategories.forEach(categoryName => {
                     // Pridaj kategóriu ako možnosť, ak to nie je aktuálne vybraná kategória
                     // A ak nie je v zozname kategórií na vylúčenie
                     if (categoryName !== currentSelectedId && !categoriesToExclude.includes(categoryName)) {
                         const option = document.createElement('option');
                         option.value = categoryName;
                         option.textContent = categoryName;
                         selectElement.appendChild(option);
                     }
                 });

                 // Ak po pridaní možností nie je žiadna vybraná (napr. currentSelectedId už neexistuje),
                 // zabezpečíme, že select má defaultnú hodnotu
                  if (!selectElement.value) {
                      selectElement.value = ""; // Nastaví na prázdnu možnosť/placeholder
                  }
            }

            // Funkcia na aktualizáciu všetkých dynamických selectov kategórií v modáli Vytvorenie Tímov
            function updateDynamicCategorySelects() {
                 const allSelectElements = teamCategoryCountContainer.querySelectorAll('.team-category-select-dynamic');
                 // Získaj aktuálne vybraté kategórie zo VŠETKÝCH selectov
                 const currentSelections = Array.from(allSelectElements)
                     .map(select => select.value)
                     .filter(value => value !== ''); // Ignoruj prázdne hodnoty


                 console.log("Aktuálne vybraté kategórie pre vylúčenie:", currentSelections);


                 allSelectElements.forEach(selectElement => {
                     const currentSelectedIdInThisSelect = selectElement.value; // Kategória vybratá v tomto konkrétnom selecte

                      // Všetky vybraté kategórie od ostatných selectov (okrem tej, čo je v tomto selecte)
                     const categoriesToExcludeForThisSelect = currentSelections.filter(cat => cat !== currentSelectedIdInThisSelect);

                      // Znovu naplň tento select s vylúčením potrebných kategórií
                     populateDynamicCategorySelect(
                         selectElement,
                         currentSelectedIdInThisSelect, // Aktuálne vybraná ID
                         allAvailableCategories,      // Zoznam všetkých kategórií
                         categoriesToExcludeForThisSelect // Kategórie na vylúčenie
                     );
                 });

                 // Po aktualizácii selectov skontroluj, či zobraziť/skryť tlačidlo Pridať ďalšiu kategóriu
                 checkIfAddCategoryCountPairButtonShouldBeVisible();
            }


             // --- Funkcia na manažovanie viditeľnosti tlačidiel "Odstrániť" ---
             function updateRemoveButtonVisibility() {
                  const allRemoveButtons = teamCategoryCountContainer.querySelectorAll('.category-count-pair .delete-button');
                  if (allRemoveButtons.length > 0) {
                       // Skryť tlačidlo na prvom riadku, zobraziť na ostatných
                       allRemoveButtons.forEach((button, index) => {
                            if (index === 0) {
                                 button.style.display = 'none';
                            } else {
                                 button.style.display = 'inline-block'; // Alebo 'block' podľa želaného rozloženia
                            }
                       });
                  }
             }


             // --- Funkcia na kontrolu, či má byť viditeľné tlačidlo "Pridať ďalšiu kategóriu" ---
             function checkIfAddCategoryCountPairButtonShouldBeVisible() {
                  const allSelectElements = teamCategoryCountContainer.querySelectorAll('.team-category-select-dynamic');
                  const currentSelections = Array.from(allSelectElements)
                      .map(select => select.value)
                      .filter(value => value !== ''); // Získaj neprázdne zvolené hodnoty

                  // Ak je počet zvolených kategórií rovný celkovému počtu dostupných kategórií,
                  // skryť tlačidlo 'Pridať ďalšiu kategóriu'. Inak ho zobraziť.
                  // Tiež skontroluj, či allAvailableCategories nie je prázdne (napr. chyba načítania)
                  if (allAvailableCategories.length > 0 && currentSelections.length >= allAvailableCategories.length) {
                       addCategoryCountPairButton.style.display = 'none';
                       console.log("Všetky kategórie sú už vybraté, tlačidlo 'Pridať ďalšiu kategóriu' skryté.");
                  } else if (allAvailableCategories.length === 0) {
                       // Ak nie sú žiadne dostupné kategórie, tiež skryť tlačidlo
                       addCategoryCountPairButton.style.display = 'none';
                       console.log("Žiadne dostupné kategórie, tlačidlo 'Pridať ďalšiu kategóriu' skryté.");
                  }
                   else {
                       if (addCategoryCountPairButton) addCategoryCountPairButton.style.display = 'inline-block'; // Alebo 'block'
                       console.log(`Vybratých kategórií: ${currentSelections.length}, celkovo dostupných: ${allAvailableCategories.length}. Tlačidlo 'Pridať ďalšiu kategóriu' zobrazené.`);
                   }
             }


             // --- Funkcia na dynamické pridanie dvojice select kategória + input počet tímov ---
             async function addCategoryCountPair(initialCategory = null) { // Optional: pre-select category if provided
                 const container = document.getElementById('teamCategoryCountContainer');

                 const pairDiv = document.createElement('div');
                 pairDiv.classList.add('category-count-pair'); // Optional class for styling


                 // Vytvorenie selectboxu pre kategóriu
                 const categorySelectLabel = document.createElement('label');
                 categorySelectLabel.textContent = 'Kategória:';
                 const categorySelect = document.createElement('select');
                 categorySelect.classList.add('team-category-select-dynamic');
                 categorySelect.name = 'category';
                 categorySelect.required = true;

                 // Pridať event listener na zmenu, ktorý spustí aktualizáciu ostatných selectov
                 categorySelect.addEventListener('change', updateDynamicCategorySelects);


                 // Vytvorenie inputu pre počet tímov
                 const teamCountLabel = document.createElement('label');
                 teamCountLabel.textContent = 'Počet tímov:';
                 const teamCountInput = document.createElement('input');
                 teamCountInput.classList.add('team-count-input-dynamic');
                 teamCountInput.type = 'number';
                 teamCountInput.name = 'count';
                 teamCountInput.min = '1';
                 teamCountInput.value = '1'; // Default value
                 teamCountInput.required = true;


                 // Tlačidlo na odstránenie tejto dvojice
                 const removeButton = document.createElement('button');
                 removeButton.textContent = 'Odstrániť';
                 removeButton.classList.add('action-button', 'delete-button');
                 removeButton.type = 'button'; // Dôležité: aby sa nespustil submit formulára
                 removeButton.style.marginLeft = '10px'; // Add some spacing


                  removeButton.onclick = () => {
                      pairDiv.remove();
                      updateDynamicCategorySelects(); // Aktualizuje selecty (volá checkIfAddCategoryCountPairButtonShouldBeVisible)
                      updateRemoveButtonVisibility(); // Aktualizuje viditeľnosť tlačidiel Odstrániť
                  };


                 // Poskladať elementy do divu
                 const selectContainer = document.createElement('div');
                 selectContainer.style.marginBottom = '10px'; // Spacing between select/input pairs
                 selectContainer.appendChild(categorySelectLabel);
                 selectContainer.appendChild(categorySelect);

                  const inputContainer = document.createElement('div');
                  inputContainer.style.marginBottom = '10px'; // Spacing below input
                 inputContainer.appendChild(teamCountLabel);
                 inputContainer.appendChild(teamCountInput);


                  pairDiv.appendChild(selectContainer);
                  pairDiv.appendChild(inputContainer);
                  pairDiv.appendChild(removeButton); // Pridáme tlačidlo, jeho viditeľnosť sa nastaví neskôr


                 container.appendChild(pairDiv);

                 // Naplň nový select s ohľadom na už vybraté kategórie v ostatných selectoch
                 // Získaj aktuálne vybraté kategórie zo VŠETKÝCH EXISTUJÚCICH selectov pred pridaním nového
                 const allSelectElementsBeforeAdding = container.querySelectorAll('.team-category-select-dynamic');
                 const categoriesSelectedInOthers = Array.from(allSelectElementsBeforeAdding)
                     .map(select => select.value)
                     .filter(value => value !== '' && value !== initialCategory); // Ignoruj prázdne a počiatočnú kategóriu tohto selectu


                 populateDynamicCategorySelect(
                    categorySelect,
                    initialCategory, // Počiatočne zvolená kategória (ak je)
                    allAvailableCategories, // Zoznam všetkých kategórií
                    categoriesSelectedInOthers // Kategórie vybraté v iných selectoch
                 );

                  // Po pridaní novej dvojice a jej naplnení aktualizovať všetky ostatné selecty a tlačidlá
                  // updateDynamicCategorySelects(); // Táto funkcia volá aj checkIfAddCategoryCountPairButtonShouldBeVisible()
                  updateRemoveButtonVisibility(); // Aktualizuje viditeľnosť tlačidiel Odstrániť
                  // updateDynamicCategorySelects() je volané event listenerom change na categorySelect alebo v openTeamCreationModal
                  // Ak pridávame prvý riadok, updateDynamicCategorySelects sa zavolá v openTeamCreationModal
                  // Ak pridávame ďalšie riadky, updateDynamicCategorySelects sa zavolá pri zmene výberu v novom selecte
                  // alebo by sa malo zavolať explicitne, aby sa ostatné selecty hneď aktualizovali.
                   // Zvolíme explicitné volanie tu, aby sa ostatné selecty aktualizovali ihneď po pridaní nového riadku.
                   updateDynamicCategorySelects(); // Explicitne volanie
            }


            // Funkcia na otvorenie modálu Vytvorenie Tímov
            async function openTeamCreationModal() {
                 teamCreationModal.style.display = 'block';

                 // Resetuj stav modálu a formulár
                 currentTeamCreationModalMode = 'add'; // Zatiaľ len 'add'
                 if (!teamCreationModalTitle) { console.error('FATAL ERROR: teamCreationModalTitle is null!'); return; } // Safety check
                 teamCreationModalTitle.textContent = 'Vytvoriť tímy';
                 teamCreationForm.reset();

                 // Vyčisti kontajner dynamických polí a pridaj prvú dvojicu
                 if (!teamCategoryCountContainer) { console.error('FATAL ERROR: teamCategoryCountContainer je null!'); return; } // Safety check
                 teamCategoryCountContainer.innerHTML = '';
                 // Zabezpeč, že všetky kategórie sú načítané pred pridaním prvej dvojice
                 if (allAvailableCategories.length === 0) {
                      await loadAllCategoriesForDynamicSelects(); // Načítaj kategórie ak ešte nie sú (volá updateDynamicCategorySelects a checkIfAddCategoryCountPairButtonShouldBeVisible)
                 } else {
                       // Ak už sú kategórie načítané, len aktualizuj selecty a tlačidlá
                       updateDynamicCategorySelects(); // Volá checkIfAddCategoryCountPairButtonShouldBeVisible
                       updateRemoveButtonVisibility(); // Volá sa po pridaní prvej dvojice
                   }

                 // Vždy pridaj prvú dvojicu pri otvorení modálu
                 await addCategoryCountPair(); // Táto funkcia volá updateDynamicCategorySelects a updateRemoveButtonVisibility na konci

                 if (!teamNameInput) { console.error('FATAL ERROR: teamNameInput je null!'); return; } // Safety check
                 teamNameInput.focus(); // Nastav focus na názov tímu
            }


            // --- Funkcia na prepínanie zobrazenia obsahu ---

            function toggleContentDisplay() {
                 const hash = window.location.hash;
                 console.log("Navigating to hash:", hash);

                 // Skryť všetky dynamické oblasti a modály
                 addButton.style.display = 'none';
                 if (categoriesContentSection) categoriesContentSection.style.display = 'none';
                 if (groupsContentDiv) groupsContentDiv.style.display = 'none';
                 if (clubsContentDiv) clubsContentDiv.style.display = 'none';
                 if (teamCreationContentSection) teamCreationContentSection.style.display = 'none';

                 if (categoryModal) categoryModal.style.display = 'none';
                 if (groupModal) groupModal.style.display = 'none';
                 if (clubModal) clubModal.style.display = 'none';
                 if (teamCreationModal) teamCreationModal.style.display = 'none';
                 if (manageTeamsModal) manageTeamsModal.style.display = 'none'; // Skryť aj nový modál


                 // Vyčistiť obsah dynamických oblastí
                 if (categoryTableBody) categoryTableBody.innerHTML = '';
                 if (groupsContentDiv) groupsContentDiv.innerHTML = '';
                 if (clubsContentDiv) clubsContentDiv.innerHTML = '';
                 if (createdTeamsTableBody) createdTeamsTableBody.innerHTML = '';
                 if (createdTeamsTableHeader) createdTeamsTableHeader.innerHTML = ''; // Clear header for dynamic generation
                 if (teamsListInModalDiv) teamsListInModalDiv.innerHTML = ''; // Clear manage teams modal content
                 //teamCategoryCountContainer.innerHTML = ''; // NEČISTIŤ pri prepínaní, aby sa zachoval stav modálu
                                                          // Ak by sa modál pri prepnutí hašu zatváral (čo sa deje),
                                                          // potom by sa vyčistilo pri zatvorení modálu.


                 // Reset modal states and forms when navigating away
                  currentCategoryModalMode = 'add'; editingCategoryName = null;
                  if (categoryForm) categoryForm.reset();

                  currentGroupModalMode = 'add'; editingGroupId = null;
                  if (groupForm) groupForm.reset();

                  // Reset club modal state (add/edit assigned)
                  currentClubModalMode = 'add-assign'; editingClubId = null; // Reset to add-assign mode
                  if (clubForm) clubForm.reset();
                  // Ensure the correct input/select is shown/hidden when modal opens next time
                   if (unassignedClubSelectContainer) unassignedClubSelectContainer.style.display = 'block';
                   if (clubNameInputContainer) clubNameInputContainer.style.display = 'none';
                   // Reset group select visibility for club modal
                   if (clubGroupSelect && clubGroupSelect.parentElement) clubGroupSelect.parentElement.style.display = 'block';
                   // Reset order input visibility for club modal
                   if (orderInputContainer) orderInputContainer.style.display = 'none';
                   if (orderInGroupInput) orderInGroupInput.required = false;

                  // Reset category select enabled state for next club modal open
                   if (clubCategorySelect) clubCategorySelect.disabled = true; // Reset to disabled by default


                  // Reset team creation modal state and clear dynamic fields
                  currentTeamCreationModalMode = 'add';
                  if (teamCreationForm) teamCreationForm.reset();
                   // Vyčistiť dynamické polia len pri zmene sekcie/zatvorení modálu
                   if (teamCategoryCountContainer) teamCategoryCountContainer.innerHTML = '';
                   // Reset allAvailableCategories when leaving the section
                  allAvailableCategories = [];
                   // Skryť tlačidlo Pridať ďalšiu kategóriu pri odchode zo sekcie
                  if (addCategoryCountPairButton) addCategoryCountPairButton.style.display = 'none';


                 if (hash === '#kategorie') { // Opravený hash pre kategórie
                     if (addButton) addButton.style.display = 'block';
                     if (categoriesContentSection) categoriesContentSection.style.display = 'block';
                     loadCategoriesTable();
                     if (addButton) addButton.title = "Pridať kategóriu";
                 } else if (hash === '#skupiny') {
                     if (addButton) addButton.style.display = 'block';
                     if (groupsContentDiv) groupsContentDiv.style.display = 'flex';
                     if (groupsContentDiv) groupsContentDiv.innerHTML = '';
                     displayGroupsByCategory();
                     if (addButton) addButton.title = "Pridať skupinu";
                 } else if (hash === '#zoznam-timov') {
                     if (addButton) addButton.style.display = 'block';
                     if (teamCreationContentSection) teamCreationContentSection.style.display = 'block';
                     displayCreatedTeams(); // This now loads all teams
                     if (addButton) addButton.title = "Vytvoriť tímy";
                     // Načítaj kategórie pri vstupe do sekcie "Vytvorenie tímov"
                     loadAllCategoriesForDynamicSelects(); // Volá updateDynamicCategorySelects a checkIfAddCategoryCountPairButtonShouldBeVisible
                 }
                 else if (hash === '#timy-do-skupin') {
                     if (addButton) addButton.style.display = 'block';
                     if (clubsContentDiv) clubsContentDiv.style.display = 'flex';
                     displayClubs(); // Load and display assigned clubs
                     // The '+' button in this section is for assigning an UNASSIGNED team
                     if (addButton) addButton.title = "Priradiť tím do skupiny";
                 }
                 // Add cases for other sections if needed (#sportove-haly, #sprava-turnaja, #nastavenia)
                 // else if (hash === '#sportove-haly') { ... }
                 // else if (hash === '#sprava-turnaja') { ... }
                 // else if (hash === '#nastavenia') { ... }
                 else {
                     // Default or unimplemented sections
                     if (addButton) addButton.style.display = 'none';
                     if (addButton) addButton.title = "Pridať položku"; // Default title
                     console.log("Neznáma alebo neimplementovaná sekcia, zobrazujem prázdny obsah.");
                 }
            }


            // --- Event Listeners ---

            // Spoločná obsluha kliknutia na tlačidlo Pridať (+)
            if (addButton) {
                addButton.addEventListener('click', () => {
                    const hash = window.location.hash;
                    console.log("Add button clicked in hash:", hash); // Added log
                    if (hash === '#kategorie') { // Opravený hash pre kategórie
                         // Open category modal in add mode
                         currentCategoryModalMode = 'add';
                         editingCategoryName = null;
                         if (!categoryModalTitle) { console.error('FATAL ERROR: categoryModalTitle is null in add mode!'); return; } // Safety check
                         categoryModalTitle.textContent = 'Pridať kategóriu';
                         if (categoryForm) categoryForm.reset();
                         if (categoryModal) categoryModal.style.display = 'block';
                         if (categoryNameInput) categoryNameInput.focus();
                         console.log("Opening category modal (add mode)."); // Added log
                    } else if (hash === '#skupiny') {
                         // Open group modal in add mode
                         openGroupModal(); // Call openGroupModal without arguments for add mode
                         console.log("Opening group modal (add mode)."); // Added log
                    } else if (hash === '#zoznam-timov') {
                         // Open team creation modal
                         openTeamCreationModal(); // Call the updated function
                         console.log("Opening team creation modal."); // Added log
                    }
                    else if (hash === '#timy-do-skupin') {
                         // Open club modal in add-assign mode (to assign an UNASSIGNED team)
                         openClubModal(); // Call openClubModal without arguments for add-assign mode
                         console.log("Opening club modal (add-assign mode)."); // Added log
                    }
                });
            } else {
                console.error("Add button not found!");
            }


            // Obsluha zatvorenia modálov (kliknutie na X)
            if (categoryModalCloseBtn) {
                categoryModalCloseBtn.addEventListener('click', () => {
                     if (categoryModal) categoryModal.style.display = 'none';
                     currentCategoryModalMode = 'add'; editingCategoryName = null;
                     if (categoryForm) categoryForm.reset();
                     console.log("Closing category modal."); // Added log
                     // Ak sa zatvára kategória modál a bol otvorený Team Creation Modal, aktualizuj jeho selecty
                      if (teamCreationModal && teamCreationModal.style.display === 'block') {
                          loadAllCategoriesForDynamicSelects(); // Pre istotu znovu načítaj kategórie (volá updateDynamicCategorySelects a checkIfAddCategoryCountPairButtonShouldBeVisible)
                      }
                });
            }
            if (groupModalCloseBtn) {
                groupModalCloseBtn.addEventListener('click', () => {
                     if (groupModal) groupModal.style.display = 'none';
                     currentGroupModalMode = 'add'; editingGroupId = null;
                     if (groupForm) groupForm.reset();
                     console.log("Closing group modal."); // Added log
                });
            }
            if (clubModalCloseBtn) {
                 clubModalCloseBtn.addEventListener('click', () => { // Club Modal Close
                     if (clubModal) clubModal.style.display = 'none';
                     currentClubModalMode = 'add-assign'; editingClubId = null; // Reset club modal state
                     if (clubForm) clubForm.reset();
                     console.log("Closing club modal."); // Added log
                      // Reset visibility of name input vs select for next open
                       if (unassignedClubSelectContainer) unassignedClubSelectContainer.style.display = 'block';
                       if (clubNameInputContainer) clubNameInputContainer.style.display = 'none';
                       // Reset group select visibility for club modal
                       if (clubGroupSelect && clubGroupSelect.parentElement) clubGroupSelect.parentElement.style.display = 'block';
                       // Reset order input visibility for club modal
                       if (orderInputContainer) orderInputContainer.style.display = 'none';
                       if (orderInGroupInput) orderInGroupInput.required = false;
                       // Reset category select disabled state
                       if (clubCategorySelect) clubCategorySelect.disabled = true; // Reset to disabled
                 });
            }


             // Team Creation Modal Close
             if (teamCreationModalCloseBtn) {
                 teamCreationModalCloseBtn.addEventListener('click', () => {
                     if (teamCreationModal) teamCreationModal.style.display = 'none';
                     currentTeamCreationModalMode = 'add';
                     if (teamCreationForm) teamCreationForm.reset();
                     if (teamCategoryCountContainer) teamCategoryCountContainer.innerHTML = ''; // Clear dynamic fields on close
                     console.log("Closing team creation modal."); // Added log
                      // Skryť tlačidlo Pridať ďalšiu kategóriu pri zatvorení modálu
                     if (addCategoryCountPairButton) addCategoryCountPairButton.style.display = 'none';
                      // Optional: add back an initial empty pair for next open
                      // addCategoryCountPair(); // If you want one pair ready on open
                 });
             }


            // Nový Modal pre správu individuálnych tímov - Zatvorenie na X
            if (manageTeamsModalCloseBtn) {
                manageTeamsModalCloseBtn.addEventListener('click', closeManageTeamsModal);
            }


            // Obsluha zatvorenia modálov (kliknutie mimo modal)
            window.addEventListener('click', (e) => {
                if (e.target === categoryModal) {
                     if (categoryModal) categoryModal.style.display = 'none';
                     currentCategoryModalMode = 'add'; editingCategoryName = null;
                     if (categoryForm) categoryForm.reset();
                     console.log("Clicked outside, closing category modal."); // Added log
                     // Ak sa zatvára kategória modál a bol otvorený Team Creation Modal, aktualizuj jeho selecty
                      if (teamCreationModal && teamCreationModal.style.display === 'block') {
                          loadAllCategoriesForDynamicSelects(); // Pre istotu znovu načítaj kategórie (volá updateDynamicCategorySelects a checkIfAddCategoryCountPairButtonShouldBeVisible)
                      }
                }
                if (e.target === groupModal) {
                     if (groupModal) groupModal.style.display = 'none';
                     currentGroupModalMode = 'add'; editingGroupId = null;
                     if (groupForm) groupForm.reset();
                      console.log("Clicked outside, closing group modal."); // Added log
                }
                 if (e.target === clubModal) { // Club Modal Close
                     if (clubModal) clubModal.style.display = 'none';
                     currentClubModalMode = 'add-assign'; editingClubId = null; // Reset club modal state
                     if (clubForm) clubForm.reset();
                      console.log("Clicked outside, closing club modal."); // Added log
                      // Reset visibility of name input vs select for next open
                     if (unassignedClubSelectContainer) unassignedClubSelectContainer.style.display = 'block';
                     if (clubNameInputContainer) clubNameInputContainer.style.display = 'none';
                      // Reset group select visibility for club modal
                     if (clubGroupSelect && clubGroupSelect.parentElement) clubGroupSelect.parentElement.style.display = 'block';
                      // Reset order input visibility for club modal
                     if (orderInputContainer) orderInputContainer.style.display = 'none';
                     if (orderInGroupInput) orderInGroupInput.required = false;
                     // Reset category select disabled state
                      if (clubCategorySelect) clubCategorySelect.disabled = true; // Reset to disabled
                 }
                 // Team Creation Modal Close
                 if (e.target === teamCreationModal) {
                     if (teamCreationModal) teamCreationModal.style.display = 'none';
                     currentTeamCreationModalMode = 'add';
                     if (teamCreationForm) teamCreationForm.reset();
                      if (teamCategoryCountContainer) teamCategoryCountContainer.innerHTML = ''; // Clear dynamic fields on close
                       console.log("Clicked outside, closing team creation modal."); // Added log
                       // Skryť tlačidlo Pridať ďalšiu kategóriu pri zatvorení modálu
                      if (addCategoryCountPairButton) addCategoryCountPairButton.style.display = 'none';
                      // Optional: add back an initial empty pair for next open
                      // addCategoryCountPair(); // If you want one pair ready on open
                 }
                 // Nový Modal pre správu individuálnych tímov - Zatvorenie kliknutím mimo
                 if (e.target === manageTeamsModal) {
                      closeManageTeamsModal();
                       console.log("Clicked outside, closing manage teams modal."); // Added log
                 }
            });


            // Spustíme toggleContentDisplay pri načítaní stránky a zmene hašu
            window.addEventListener('hashchange', toggleContentDisplay);
            window.addEventListener('load', () => {
                 // Set initial hash if none is present, e.g., to #kategorie
                 if (!window.location.hash || window.location.hash === '#') { // Also handle empty hash
                      window.location.hash = '#kategorie'; // Opravený hash pre počiatočnú stránku
                 } else {
                     // If hash is present, call toggleContentDisplay
                     toggleContentDisplay();
                 }
            });


            // Obsluha formulára na pridanie/úpravu kategórie
            if (categoryForm) {
                categoryForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const categoryName = categoryNameInput.value.trim();
                    if (categoryName === '') { alert('Názov kategórie nemôže byť prázdny.'); return; }

                    if (currentCategoryModalMode === 'add') {
                         const categoryDocRef = doc(categoriesCollectionRef, categoryName);
                         try {
                              const existingDoc = await getDoc(categoryDocRef);
                              if (existingDoc.exists()) { alert(`Kategória "${categoryName}" už existuje!`); return; }
                              await setDoc(categoryDocRef, { /* optional data like createdAt: new Date() */ });
                              console.log(`Kategória "${categoryName}" bola úspešne pridaná.`);
                              if (categoryModal) categoryModal.style.display = 'none'; if (categoryForm) categoryForm.reset();
                              currentCategoryModalMode = 'add'; editingCategoryName = null;
                              // Refresh displays that might be affected
                              loadCategoriesTable(); // Always refresh category table
                              if (window.location.hash === '#skupiny') {
                                  if (groupsContentDiv) groupsContentDiv.innerHTML = '';
                                  displayGroupsByCategory();
                              }
                              // Refresh created teams list regardless of hash, as categories affect its header and grouping
                              displayCreatedTeams();
                              if (window.location.hash === '#timy-do-skupin') displayClubs();


                         } catch (error) {
                              console.error('Chyba pri pridávaní kategórie: ', error);
                              alert('Chyba pri pridávaní kategórie!');
                              // Close modal and reset state on error
                              if (categoryModal) categoryModal.style.display = 'none'; if (categoryForm) categoryForm.reset();
                              currentCategoryModalMode = 'add'; editingCategoryName = null;
                         }
                    } else if (currentCategoryModalMode === 'edit') {
                         const oldCategoryName = editingCategoryName;
                         const newCategoryName = categoryName;
                         if (!oldCategoryName) { console.error("Chyba: Chýba pôvodný názov kategórie."); alert("Chyba pri úprave kategórie."); if (categoryModal) categoryModal.style.display = 'none'; if (categoryForm) categoryForm.reset(); currentCategoryModalMode = 'add'; editingCategoryName = null; return; }
                         if (newCategoryName === oldCategoryName) { console.log("Názov kategórie sa nezmenil."); if (categoryModal) categoryModal.style.display = 'none'; if (categoryForm) categoryForm.reset(); return; }

                         const newCategoryDocRef = doc(categoriesCollectionRef, newCategoryName);
                         try {
                              const existingDoc = await getDoc(newCategoryDocRef);
                              if (existingDoc.exists()) { alert(`Kategória s názvom "${newCategoryName}" už existuje!`); return; }

                              const oldCategoryDocRef = doc(categoriesCollectionRef, oldCategoryName);
                              const oldDocSnapshot = await getDoc(oldCategoryDocRef);
                              if (!oldDocSnapshot.exists()) { console.error(`Chyba: Pôvodný dokument kategórie ${oldCategoryName} nenájdený.`); alert("Pôvodná kategória na úpravu nebola nájdená."); if (categoryModal) categoryModal.style.display = 'none'; if (categoryForm) categoryForm.reset(); currentCategoryModalMode = 'add'; editingCategoryName = null; loadCategoriesTable(); return; }
                              const oldDocData = oldDocSnapshot.data();

                              const batch = writeBatch(db);
                              batch.set(newCategoryDocRef, oldDocData); // Create new doc with new ID
                              // Note: We delete the old doc after processing references to ensure it exists during lookups
                              // Update group and club references before deleting the old category document

                              // Groups first
                              const groupsQuery = query(groupsCollectionRef, where('categoryId', '==', oldCategoryName));
                              const groupsSnapshot = await getDocs(groupsQuery);

                          // Fetch clubs related to groups being deleted *before* starting the batch queries within the loop
                          const clubUpdates = [];
                          for (const groupDoc of groupsSnapshot.docs) {
                              const clubsInGroupQuery = query(clubsCollectionRef, where('groupId', '==', groupDoc.id));
                              const clubsSnapshot = await getDocs(clubsInGroupQuery);
                              clubsSnapshot.forEach(clubDoc => {
                                   // Use the new composite group ID for the update
                                  const oldGroupId = groupDoc.id; // e.g., "OldCategory - GroupA"
                                  const groupData = groupDoc.data(); // Get group data to reconstruct the name part
                                  const newGroupId = `${newCategoryName} - ${groupData.name}`; // Construct new group ID using new category name and old group name

                                  batch.update(clubDoc.ref, { categoryId: newCategoryName, groupId: newGroupId }); // Update club with new categoryId and new groupId
                                   console.log(`Klub "${clubDoc.id}" aktualizovaný (categoryId, groupId) kvôli zmene kategórie skupiny.`);
                              });
                               // Add group deletion to batch
                              batch.delete(groupDoc.ref); // Delete old group doc
                              console.log(`Stará skupina "${groupDoc.id}" zmazaná po premenovaní kategórie.`); // Clarified log
                          }

                          // Nájdi a aktualizuj kluby s touto kategóriou, ktoré už nemusia byť priradené k skupine (groupId == null)
                          const unassignedClubsQuery = query(clubsCollectionRef, where('categoryId', '==', oldCategoryName), where('groupId', '==', null));
                           const unassignedClubsSnapshot = await getDocs(unassignedClubsQuery);
                           unassignedClubsSnapshot.forEach(doc => {
                              batch.update(doc.ref, { categoryId: newCategoryName }); // Just update categoryId to new name
                              console.log(`Nepriradený klub "${doc.id}" aktualizovaný (categoryId).`);
                           });


                          // Nakoniec zmaž samotnú pôvodnú kategóriu
                          batch.delete(oldCategoryDocRef); // Delete old category doc using old name


                          await batch.commit();

                          console.log(`Premenovanie kategórie "${oldCategoryName}" na "${newCategoryName}" a aktualizácia referencií bolo úspešné.`);

                          currentCategoryModalMode = 'add'; editingCategoryName = null;
                          if (categoryModal) categoryModal.style.display = 'none'; if (categoryForm) categoryForm.reset();

                          // Refresh displays that might be affected
                          loadCategoriesTable();
                          if (window.location.hash === '#skupiny') displayGroupsByCategory();
                          // Refresh created teams list regardless of hash, as categories affect its header and grouping
                          displayCreatedTeams();
                          if (window.location.hash === '#timy-do-skupin') displayClubs();


                          } catch (error) {
                               console.error('Chyba pri premenovaní kategórie a aktualizácii referencií: ', error);
                               alert('Chyba pri premenovaní kategórie! Prosím, skúste znova.');
                               // Reset state and close modal on error
                               currentCategoryModalMode = 'add'; editingCategoryName = null;
                               if (categoryModal) categoryModal.style.display = 'none'; if (categoryForm) categoryForm.reset();
                          }
                     }
                });
            } else { console.error("Category form not found!"); }


             // --- Obsluha formulára Skupiny (používa kompozitné ID) ---
             if (groupForm) {
                 groupForm.addEventListener('submit', async (e) => {
                     e.preventDefault();
                     const selectedCategoryId = groupCategorySelect.value;
                     const groupName = groupNameInput.value.trim();

                     if (selectedCategoryId === '' || selectedCategoryId === '-- Vyberte kategóriu --' || (groupCategorySelect && groupCategorySelect.disabled)) { alert('Prosím, vyberte platnú kategóriu pre skupinu.'); return; }
                     if (groupName === '') { alert('Názov skupiny nemôže byť prázdny.'); return; }

                     const compositeGroupId = `${selectedCategoryId} - ${groupName}`;
                     const groupDocRef = doc(groupsCollectionRef, compositeGroupId);

                     try {
                         const existingDoc = await getDoc(groupDocRef);

                         if (currentGroupModalMode === 'add') {
                             // === LOGIKA PRIDÁVANIA SKUPINY ===
                             if (existingDoc.exists()) {
                                  alert(`Skupina s názvom "${groupName}" už v kategórii "${selectedCategoryId}" existuje! Názvy skupín musia byť unikátne v rámci kategórie.`);
                                  return;
                             }
                             await setDoc(groupDocRef, { name: groupName, categoryId: selectedCategoryId });
                             console.log(`Skupina "${groupName}" (ID: ${compositeGroupId}) bola úspešne pridaná do kategórie "${selectedCategoryId}".`);

                         } else if (currentGroupModalMode === 'edit') {
                             // === LOGIKA ÚPRAVY SKUPINY (PREMENOVANIE / ZMENA KATEGÓRIE) ===
                             const oldGroupId = editingGroupId;
                             if (!oldGroupId) { console.error("Chyba: Režim úpravy skupiny bez platného editingGroupId."); alert("Chyba pri úprave skupiny. Prosím, obnovte stránku."); if (groupModal) groupModal.style.display = 'none'; if (groupForm) groupForm.reset(); currentGroupModalMode = 'add'; editingGroupId = null; return; }

                             const oldGroupDocRef = doc(groupsCollectionRef, oldGroupId);
                             const oldDocSnapshot = await getDoc(oldGroupDocRef);
                             if (!oldDocSnapshot.exists()) { console.error(`Chyba: Pôvodný dokument skupiny ${oldGroupId} nenájdený.`); alert("Pôvodná skupina na úpravu nebola nájdená."); if (groupModal) groupModal.style.display = 'none'; if (groupForm) groupForm.reset(); currentGroupModalMode = 'add'; editingGroupId = null; displayGroupsByCategory(); return; }
                             const oldGroupData = oldDocSnapshot.data();


                             // Check if the composite ID has changed (name or category)
                             if (oldGroupId !== compositeGroupId) {
                                  console.log(`Premenovanie/presun skupiny z "${oldGroupId}" na "${compositeGroupId}".`);
                                  // Check if the NEW composite ID already exists (another group with this name/category)
                                  if (existingDoc.exists()) {
                                     alert(`Skupina s názvom "${groupName}" už v kategórii "${selectedCategoryId}" existuje (iná skupina)! Názvy skupín musia byť unikátne v rámci kategórie.`);
                                     return;
                                  }
                                  // If ID changes, we need to delete the old document and create a new one
                                  const batch = writeBatch(db);
                                  // Use the current data from the form for the new document
                                  batch.set(groupDocRef, { name: groupName, categoryId: selectedCategoryId }); // Create new group doc with new ID
                                  // Note: Delete the old doc after processing references
                                  // batch.delete(oldGroupDocRef); // This will be done after club updates below

                                  // Update clubs that referenced the OLD group ID
                                  const clubsInGroupQuery = query(clubsCollectionRef, where('groupId', '==', oldGroupId));
                                  const clubsSnapshot = await getDocs(clubsInGroupQuery); // Use await here
                                  clubsSnapshot.forEach(clubDoc => {
                                       // Update the club's groupId to the new composite ID
                                       // Keep the original orderInGroup if it exists, only update groupId and categoryId
                                       batch.update(clubDoc.ref, { groupId: compositeGroupId, categoryId: selectedCategoryId }); // Ensure categoryId is also updated on club
                                       console.log(`Klub "${clubDoc.id}" aktualizovaný (groupId, categoryId) kvôli zmene skupiny.`);
                                  });

                                   // Now delete the old group document
                                   batch.delete(oldGroupDocRef);


                                  await batch.commit();

                                  console.log(`Skupina úspešne premenovaná/presunutá z ID "${oldGroupId}" na "${compositeGroupId}" a súvisiace kluby aktualizované.`);

                              } else {
                                  // If the composite ID hasn't changed, just update the existing document
                                  console.log(`Úprava údajov pre skupinu s ID "${oldGroupId}". Kompozitné ID sa nemení.`);
                                  // Use updateDoc on the document with the current ID
                                  await updateDoc(groupDocRef, {
                                      name: groupName,
                                      categoryId: selectedCategoryId
                                  });
                                  console.log(`Skupina s ID "${oldGroupId}" úspešne upravená.`);
                              }
                         }

                         // --- Common logic after successful add or edit ---
                         if (groupModal) groupModal.style.display = 'none'; if (groupForm) groupForm.reset();
                         currentGroupModalMode = 'add'; editingGroupId = null;

                         // Refresh displays that might be affected
                         if (window.location.hash === '#skupiny') displayGroupsByCategory();
                         // Refresh created teams list regardless of hash, as modifying groups can affect team display in manage teams modal
                         displayCreatedTeams();
                         if (window.location.hash === '#timy-do-skupin') displayClubs();


                      } catch (error) {
                          console.error('Chyba pri ukladaní skupiny: ', error);
                          alert(`Chyba pri ukladaní skupiny! Detail: ${error.message}`);
                           // Reset state and close modal on error
                          if (groupModal) groupModal.style.display = 'none';
                          if (groupForm) groupForm.reset();
                          currentGroupModalMode = 'add'; editingGroupId = null;
                       }
                  });
             } else { console.error("Group form not found!"); }


            // --- Obsluha formulára Vytvorenie Tímov - UPRAVENÉ PRE VIAC KATEGÓRIÍ S POČTOM ---
            if (teamCreationForm) {
                teamCreationForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const teamNameBase = teamNameInput && teamNameInput.value.trim();
                    if (!teamNameInput || teamNameBase === '') {
                        alert('Základný názov tímu nemôže byť prázdny.');
                        return;
                    }

                    // Získať všetky dynamicky pridané dvojice kategória + počet
                    const categoryCountPairs = teamCategoryCountContainer && teamCategoryCountContainer.querySelectorAll('.category-count-pair');

                    if (!categoryCountPairs || categoryCountPairs.length === 0) {
                        alert('Pridajte aspoň jednu kategóriu a počet tímov.');
                        return;
                    }

                    // Zbieranie dát a validácia pre každú dvojicu
                    const teamsToProcess = []; // Pole pre uchovanie { categoryId, count } pre každú platnú dvojicu
                    const seenCategories = new Set(); // Na kontrolu duplicitných kategórií

                    for (const pairDiv of categoryCountPairs) {
                         const categorySelect = pairDiv.querySelector('.team-category-select-dynamic');
                         const teamCountInput = pairDiv.querySelector('.team-count-input-dynamic');

                         const categoryId = categorySelect && categorySelect.value;
                         const teamCount = parseInt(teamCountInput && teamCountInput.value, 10);

                         // Validácia dvojice
                         if (!categorySelect || categoryId === '' || categorySelect.disabled) {
                             alert('Prosím, vyberte kategóriu pre každý riadok.');
                             // Môžete voliteľne pridať označenie chybného riadku
                             return; // Zastaviť spracovanie pri prvej chybe
                         }
                          if (!teamCountInput || isNaN(teamCount) || teamCount < 1) {
                             alert('Počet tímov musí byť platné číslo väčšie ako 0 pre každú kategóriu.');
                             // Môžete voliteľne pridať označenie chybného riadku
                             return; // Zastaviť spracovanie pri prvej chybe
                          }
                          // Kontrola duplicitnej kategórie v rámci formulára
                           if (seenCategories.has(categoryId)) {
                               alert(`Kategória "${categoryId}" bola vybraná viackrát. Pre každú kategóriu môžete zadať iba jeden počet.`);
                                // Môžete voliteľne pridať označenie chybného riadku
                               return; // Zastaviť spracovanie pri prvej chybe
                           }
                           seenCategories.add(categoryId);

                          // Kontrola, či počet tímov neprekročí počet písmen abecedy (A-Z)
                           if (teamCount > 26) {
                                alert(`Pre kategóriu "${categoryId}": Pre abecedné označenie je možné vytvoriť maximálne 26 tímov naraz (A-Z).`);
                                 // Môžete voliteľne pridať označenie chybného riadku
                                return; // Zastaviť spracovanie pri prvej chybe
                           }


                         // Ak je dvojica platná, pridaj ju do zoznamu na vytvorenie
                         teamsToProcess.push({ categoryId: categoryId, count: teamCount });
                    }

                    console.log("Plánované vytvorenie tímov:", teamNameBase, teamsToProcess);


                    const batch = writeBatch(db);
                    let successfullyAddedCount = 0;
                    const failedCreations = []; // To store details of teams that failed creation


                    try {
                        // Iterovať cez plánované tímy na vytvorenie ({ categoryId, count })
                        for (const teamPlan of teamsToProcess) {
                             const categoryId = teamPlan.categoryId;
                             const teamCount = teamPlan.count;

                             // Pre každú kategóriu a počet, vytvoriť špecifikovaný počet tímov
                             for (let i = 1; i <= teamCount; i++) {
                                  // Vytvoriť názov tímu (napr. "Hádzaná Trenčín A")
                                  let teamName;
                                  if (teamCount > 1) {
                                       const letter = String.fromCharCode(65 + (i - 1));
                                       teamName = `${teamNameBase} ${letter}`;
                                  } else {
                                       teamName = teamNameBase; // Ak je počet 1, názov je len základný názov
                                  }

                                  // *** KONŠTRUKCIA ID DOKUMENTU PODĽA POŽIADAVKY ***
                                  // Pôvodný formát: "Kategória [Suffix] - Základný Názov Tímu"
                                  // const teamSuffix = teamCount > 1 ? ' ' + String.fromCharCode(65 + (i - 1)) : ''; // " A", " B", ... alebo ""
                                  // const documentId = `${categoryId}${teamSuffix} - ${teamNameBase}`;

                                  // *** NOVÝ FORMÁT: "Kategória - Základný Názov Tímu [Suffix]" ***
                                  const teamSuffixForId = teamCount > 1 ? ' ' + String.fromCharCode(65 + (i - 1)) : ''; // " A", " B", ... alebo ""
                                  const documentId = `${categoryId} - ${teamNameBase}${teamSuffixForId}`;


                                  const teamDocRef = doc(clubsCollectionRef, documentId);

                                  // *** KONTROLA EXISTENCIE DOKUMENTU PRED PRIDANÍM DO BATCHU ***
                                  const existingDoc = await getDoc(teamDocRef);

                                   if (existingDoc.exists()) {
                                       console.warn(`Dokument s ID "${documentId}" už existuje. Tím sa nebude znovu vytvárať.`);
                                       failedCreations.push({ id: documentId, reason: 'Už existuje' });
                                       continue; // Skip to the next iteration
                                   }


                                  // Ak dokument neexistuje, pridaj operáciu setDoc do batchu
                                  batch.set(teamDocRef, {
                                      name: teamName, // Uložíme plný názov (napr. "Hádzaná Trenčín A")
                                      categoryId: categoryId,
                                      groupId: null, // Pôvodne nepriradený
                                      orderInGroup: null // Novovytvorené tímy nemajú poradie
                                      // voliteľné polia
                                  });
                                  successfullyAddedCount++; // Inkremetovať počítadlo úspešne pridaných
                             }
                        }


                        await batch.commit(); // Odoslať batch operácie

                         // --- Zobrazenie výsledku po batchi ---
                         let resultMessage = `Pokus o vytvorenie tímov dokončený. Úspešne vytvorených: ${successfullyAddedCount}.`;
                         if (failedCreations.length > 0) {
                             resultMessage += ` Niektoré tímy boli preskočené, pretože dokumenty s príslušnými ID už existovali (${failedCreations.length} ks).`;
                             console.warn("Preskočené tímy:", failedCreations);
                             // Môžete voliteľne zobraziť detailnejší zoznam preskočených tímov užívateľovi
                             // alert(resultMessage + "\nPreskočené ID: " + failedCreations.map(f => f.id).join(", "));
                         } else {
                             resultMessage += " Všetky plánované tímy boli úspešne vytvorené.";
                         }

                         alert(resultMessage); // Zachováme alert pre spätnú väzbu


                        // --- Spoločná logika po úspešnom vytvorení ---
                        if (teamCreationModal) teamCreationModal.style.display = 'none';
                        if (teamCreationForm) teamCreationForm.reset();
                        if (teamCategoryCountContainer) teamCategoryCountContainer.innerHTML = '';
                        // loadAllCategoriesForDynamicSelects(); // No longer needed here, called on modal open
                        // addCategoryCountPair(); // No longer needed here, called on modal open
                        // updateDynamicCategorySelects(); // No longer needed here
                        // updateRemoveButtonVisibility(); // No longer needed here

                        // --- NOVÁ LOGIKA: Zabrániť dialógovému oknu "Správa z webu" ---
                        history.replaceState({}, '', window.location.href); // Nahradí aktuálny záznam v histórii


                        // Obnoviť zobrazenia, ktoré môžu byť ovplyvnené
                        // Always refresh created teams list after creation (shows all teams now)
                        displayCreatedTeams();
                         // Zobrazenie priradených klubov (timy-do-skupin) sa nemení, lebo boli vytvorené nepriradené tímy
                         // if (window.location.hash === '#timy-do-skupin') { displayClubs(); }


                    } catch (error) {
                        console.error('Chyba pri vytváraní tímov: ', error);
                        alert(`Chyba pri vytváraní tímov! Detail: ${error.message}`);
                         // Close modal and reset state on error (nemusíme čistiť dynamické polia, aby užívateľ videl, čo zadal)
                         if (teamCreationModal) teamCreationModal.style.display = 'none';
                         if (teamCreationForm) teamCreationForm.reset(); // Vyčistí aspoň základný názov
                         // Nečistíme teamCategoryCountContainer, aby užívateľ videl, čo zadal
                         // Ak nastane chyba, môžeme znova načítat kategórie a aktualizovať selecty
                         loadAllCategoriesForDynamicSelects(); // Pre istotu znovu načítaj kategórie (volá updateDynamicCategorySelects a checkIfAddCategoryCountPairButtonShouldBeVisible)
                    }
                });
            } else { console.error("Team creation form not found!"); }


             // Event listener pre tlačidlo "Pridať ďalšiu kategóriu" - PRIDANÝ KDE SÚ OSTATNÉ LISTENERY
            if (addCategoryCountPairButton) {
                addCategoryCountPairButton.addEventListener('click', async () => {
                     // Pred pridaním novej dvojice zabezpečiť, že kategórie sú načítané
                     if (allAvailableCategories.length === 0) {
                          await loadAllCategoriesForDynamicSelects(); // Načítaj kategórie ak ešte nie sú (volá updateDynamicCategorySelects a checkIfAddCategoryCountPairButtonShouldBeVisible)
                     }
                     await addCategoryCountPair(); // Volaj funkciu na pridanie ďalšej dvojice (volá updateDynamicCategorySelects a updateRemoveButtonVisibility)
                });
            } else { console.error("Add category count pair button not found!"); }

    </script>
    
</body>
</html>
