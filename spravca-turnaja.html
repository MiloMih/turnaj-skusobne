<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spr√°vca turnaja</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="style.css">

    <style>
        /* --- General Styles --- */
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-top: 20px;
            margin-bottom: 20px; /* Added margin-bottom for separation */
        }

        h2 {
            margin-top: 0; /* Reset margin-top, controlled by section padding */
            margin-bottom: 10px;
            color: #555;
        }

         h3 { /* Style for category headings in Manage Teams modal */
            margin-top: 15px;
            margin-bottom: 8px;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
         }


        .add-button {
            display: block;
            margin: 20px auto;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #28a745;
            color: white;
            font-size: 2em;
            border: none;
            cursor: pointer;
            text-align: center;
            line-height: 50px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.3s ease;
            position: sticky;
            top: 20px;
            z-index: 10;
        }

        .add-button:hover {
            background-color: #218838;
        }

        .content-wrapper {
            display: flex;
            margin-top: 20px;
            padding: 0 20px;
        }

        .left-menu {
            width: 200px;
            margin-right: 20px;
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky;
            top: 90px;
            align-self: flex-start;
            max-height: calc(100vh - 110px);
            overflow-y: auto;
        }

        .left-menu ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .left-menu li {
            margin-bottom: 10px;
        }

        .left-menu a {
            text-decoration: none;
            color: #007bff;
            font-weight: bold;
            display: block;
            padding: 5px 0;
            transition: color 0.3s ease;
        }

        .left-menu a:hover {
            color: #0056b3;
        }

        main {
            flex-grow: 1;
            padding: 0;
            box-shadow: none;
            background-color: transparent;
        }

        /* --- Section Block Style --- */
        .section-block {
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px; /* Space below each block */
        }


        /* --- Table Styles --- */
        /* Styles for the table element itself, regardless of the wrapper */
        #categoryTable, .category-group-table, #clubsTable, #createdTeamsTable {
            border-collapse: collapse;
            width: 100%; /* Keep 100% width for these tables */
            border: none;
            overflow: hidden;
        }

         /* Specific style for tables in #timy-do-skupin and manage teams modal */
        .group-clubs-table {
            border-collapse: collapse;
             /* Allow width to be flexible within its flex container parent */
             /* width: 100%; /* Removed 100% width */
            border: none;
            overflow: hidden;
             /* Added table-layout: auto to make columns fit content */
            table-layout: auto;
        }


        /* Style for the section wrapping category heading and group table */
        .category-group-section {
            /* Inherits background, padding, radius, shadow from .section-block */
            /* Flex properties only for group sections when inside #groupsContent */
            min-width: 300px;
            flex-grow: 1;
            flex-basis: 0;
        }

        /* Style for the main container of group sections (the flex container) */
        #groupsContent {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: flex-start;
            padding: 0;
            margin-bottom: 20px;
        }
         #groupsContent .section-block {
             margin-bottom: 0; /* Override margin for flex items */
         }


        /* Remove margin-top from the first element inside a section block */
        .section-block h2:first-child,
        .section-block table:first-child {
            margin-top: 0;
        }

         /* Style for tables within the manage teams modal */
         #manageTeamsModal .group-clubs-table {
             margin-bottom: 15px; /* Space below each category table in the modal */
             width: 100%; /* Set 100% width inside modal for these tables */
         }


        /* Table Header and Cell Styles - apply to all relevant table types */
        #categoryTable th, #clubsTable th, .category-group-table th, .group-clubs-table th, #createdTeamsTable th,
         #manageTeamsModal .group-clubs-table th /* Also apply to modal tables */
         {
            background-color: #f2f2f2;
            color: #333;
            font-weight: bold;
            text-align: left;
            padding: 12px 15px;
            border-bottom: 2px solid #ddd;
        }

        #categoryTable td, #clubsTable td, .category-group-table td, .group-clubs-table td, #createdTeamsTable td,
         #manageTeamsModal .group-clubs-table td /* Also apply to modal tables */
         {
            text-align: left;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
        }

        /* Center align quantity cells in Created Teams table */
         #createdTeamsTable tbody td:not(:first-child):not(:last-child) {
              text-align: center;
         }

         /* Center align order column in group-clubs-table */
         .group-clubs-table tbody td:first-child {
              text-align: center;
         }
         #manageTeamsModal .group-clubs-table tbody td:first-child {
             text-align: center; /* Also for modal tables */
         }


        /* Remove bottom border from last row in tbody for all tables */
        #categoryTable tbody tr:last-child td,
        #clubsTable tbody tr:last-child td,
        .category-group-table tbody tr:last-child td,
        .group-clubs-table tbody tr:last-child td,
        #createdTeamsTable tbody tr:last-child td,
         #manageTeamsModal .group-clubs-table tbody tr:last-child td
         {
             border-bottom: none;
        }

        /* Hover effect for all table rows */
        #categoryTable tbody tr:hover,
        #clubsTable tbody tr:hover,
        .category-group-table tbody tr:hover,
        .group-clubs-table tbody tr:hover,
        #createdTeamsTable tbody tr:hover,
         #manageTeamsModal .group-clubs-table tbody tr:hover
         {
            background-color: #f9f9f9;
            cursor: pointer;
        }

        /* Ensure last cell in row doesn't wrap buttons */
        #categoryTable td:last-child,
        #clubsTable td:last-child,
        .category-group-table td:last-child,
        .group-clubs-table td:last-child,
        #createdTeamsTable td:last-child,
         #manageTeamsModal .group-clubs-table td:last-child /* Also for tables in modal */
         {
             white-space: nowrap;
        }

        #clubsContent {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: flex-start;
            padding: 0;
            margin-bottom: 20px;
        }

        /* Style for container divs that wrap club sections when inside #clubsContent */
        #clubsContent .section-block {
            /* Inherits background, padding, radius, shadow from .section-block */
             /* Remove min-width and flex-basis to allow content to dictate width better */
            /* min-width: 300px; */
            flex-grow: 1; /* Allow growing to fill space */
            flex-basis: 0; /* Reset flex-basis */
            margin-bottom: 0; /* Override the default .section-block margin when inside flex */
        }

        #teamCreationContentSection table {
            /* Ensure table within section block takes full width */
             width: 100%;
        }


        /* --- Action Button Styles --- */
        .action-button {
            padding: 5px 10px;
            margin-right: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
        }

        .action-button:not(.delete-button) {
            background-color: #007bff;
            color: white;
        }

        .action-button.delete-button {
            background-color: #dc3545;
            color: white;
        }

        .action-button:not(.delete-button):hover { background-color: #0056b3; }
        .action-button.delete-button:hover { background-color: #c82333; }


        /* --- Modal Styles --- */
         .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            padding-top: 60px;
         }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
            position: relative;
        }

        .close {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover, .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-content form label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

         .modal-content form input[type="text"],
         .modal-content form input[type="number"],
         .modal-content form select {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
         }
         /* Adjust select height for multiple */
         .modal-content form select[multiple] {
              min-height: 100px; /* Or adjust as needed */
         }


        .modal-content form button[type="submit"] { /* Target the submit button */
            background-color: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }

         .modal-content form button[type="submit"]:hover { /* Target the submit button */
            background-color: #218838;
         }

         /* Style for the container divs around specific form elements */
         .modal-content form div {
             margin-bottom: 20px; /* Add spacing below input groups */
         }
         .modal-content form div:last-of-type {
              margin-bottom: 0; /* Remove bottom margin for the last one before the button */
         }
          .modal-content form label,
          .modal-content form input[type="text"],
          .modal-content form input[type="number"],
          .modal-content form select {
              margin-bottom: 0; /* Remove margin from elements inside the div */
          }

          /* Optional CSS for dynamically added category/count pairs */
            .category-count-pair {
                border: 1px solid #eee;
                padding: 10px;
                margin-bottom: 15px; /* Space below each pair */
                border-radius: 5px;
                background-color: #f9f9f9;
            }

            .category-count-pair label {
                display: inline-block; /* Make labels inline */
                margin-bottom: 5px;
                margin-right: 10px; /* Space between label and input/select */
                font-weight: normal; /* Less bold than section titles */
                min-width: 80px; /* Align labels (adjust as needed) */
            }

            .category-count-pair select,
            .category-count-pair input[type="number"] {
                 display: inline-block; /* Make inputs/selects inline */
                 width: auto; /* Allow size based on content/min-width */
                 margin-bottom: 0; /* Remove bottom margin */
                 margin-right: 10px; /* Space between elements */
                 padding: 5px; /* Smaller padding */
            }

            /* Style for the remove button within the pair */
            .category-count-pair .action-button.delete-button {
                padding: 3px 8px; /* Smaller padding */
                font-size: 0.8em; /* Smaller font */
            }

            /* Adjust spacing within the container div */
            #teamCategoryCountContainer div {
                margin-bottom: 10px; /* Space between inner divs (label+element) */
            }

            /* Ensure remove button is not on a new line if space allows */
            .category-count-pair div:last-of-type { /* This targets the last div within a pairDiv */
                 margin-bottom: 0;
            }


    </style>
</head>
<body>
    <script>
        // Basic check for admin, redirect if not
        const userName = localStorage.getItem('username');
        if (userName !== 'admin') {
             window.location.href = 'login.html';
        }
    </script>

    <h1>Spr√°vca turnaja</h1>

    <button class="add-button" id="addButton" title="Prida≈• polo≈æku">+</button>

    <div class="modal" id="categoryModal">
        <div class="modal-content">
            <span class="close category-modal-close">&times;</span>
            <h2 id="categoryModalTitle">Prida≈• kateg√≥riu</h2>
            <form id="categoryForm">
                <div>
                    <label for="categoryName">N√°zov kateg√≥rie:</label>
                    <input type="text" id="categoryName" name="categoryName" required>
                </div>
                <button type="submit">Ulo≈æi≈•</button>
            </form>
        </div>
    </div>

     <div class="modal" id="groupModal">
         <div class="modal-content">
                 <span class="close group-modal-close">&times;</span>
                 <h2 id="groupModalTitle">Prida≈• skupinu</h2>
                 <form id="groupForm">
                     <div>
                          <label for="groupCategory">Kateg√≥ria:</label>
                          <select id="groupCategory" name="groupCategory" required>
                               <option value="">-- Vyberte kateg√≥riu --</option>
                               </select>
                     </div>

                     <div>
                          <label for="groupName">N√°zov skupiny:</label>
                          <input type="text" id="groupName" name="groupName" required>
                     </div>

                     <button type="submit">Ulo≈æi≈•</button>
                 </form>
         </div>
     </div>

    <div class="modal" id="clubModal">
         <div class="modal-content">
                 <span class="close club-modal-close">&times;</span>
                 <h2 id="clubModalTitle">Priradi≈• t√≠m do skupiny</h2>
                 <form id="clubForm">
                       <div id="unassignedClubSelectContainer">
                          <label for="unassignedClubSelect">Vyberte existuj√∫ci t√≠m:</label>
                          <select id="unassignedClubSelect">
                               <option value="">-- Vyberte t√≠m na priradenie --</option>
                           </select>
                      </div>

                      <div id="clubNameInputContainer">
                          <label for="clubName">N√°zov klubu:</label>
                          <input type="text" id="clubName" name="clubName">
                       </div>

                      <div>
                          <label for="clubCategory">Kateg√≥ria:</label>
                          <select id="clubCategory" name="clubCategory" required>
                               <option value="">-- Vyberte kateg√≥riu --</option>
                               </select>
                      </div>

                      <div>
                           <label for="clubGroup">Skupina:</label>
                           <select id="clubGroup" name="clubGroup" required disabled>
                                <option value="">-- Najprv vyberte kateg√≥riu --</option>
                            </select>
                      </div>

                       <div id="orderInputContainer">
                            <label for="orderInGroup">Poradov√© ƒç√≠slo v skupine:</label>
                            <input type="number" id="orderInGroup" name="orderInGroup" min="1">
                       </div>

                       <button type="submit">Ulo≈æi≈•</button>
                  </form>
         </div>
     </div>

    <div class="modal" id="teamCreationModal">
        <div class="modal-content">
            <span class="close team-creation-modal-close">&times;</span>
            <h2 id="teamCreationModalTitle">Vytvori≈• t√≠my</h2>
            <form id="teamCreationForm">
                <div>
                    <label for="teamNameInput">Z√°kladn√Ω n√°zov t√≠mu:</label>
                    <input type="text" id="teamNameInput" name="teamName" required>
                </div>

                <div id="teamCategoryCountContainer">
                     </div>

                 <button type="button" id="addCategoryCountPairButton" class="action-button" style="margin-bottom: 15px;">Prida≈• ƒèal≈°iu kateg√≥riu</button> <button type="submit">Vytvori≈• t√≠my</button> </form>
        </div>
    </div>

    <div class="modal" id="manageTeamsModal">
        <div class="modal-content" style="max-width: 700px;"> <span class="close manage-teams-modal-close">&times;</span>
            <h2 id="manageTeamsModalTitle"><span id="baseTeamNameInModal"></span></h2>

            <div id="teamsListInModal">
                <p>Naƒç√≠tavam t√≠my...</p> </div>

            <div style="text-align: right; margin-top: 20px;">
                 <button class="action-button" onclick="closeManageTeamsModal()">Zatvori≈•</button>
            </div>
        </div>
    </div>


    <div class="content-wrapper">
        <nav class="left-menu">
            <ul>
                <li><a href="#kategorie">Vytvorenie kateg√≥ri√≠</a></li>
                <li><a href="#skupiny">Vytvorenie skup√≠n</a></li>
                <li><a href="#zoznam-timov">Zoznam t√≠mov</a></li>
                <li><a href="#timy-do-skupin">T√≠my do skup√≠n</a></li>
                <li><a href="#sportove-haly">≈†portov√© haly</a></li>
                <li><a href="#sprava-turnaja">Spr√°va turnaja</a></li>
                <li><a href="#nastavenia">Nastavenia</a></li>
            </ul>
        </nav>

        <main>
            <div id="categoriesContentSection" class="section-block" style="display: none;">
                 <h2>Vytvorenie kateg√≥ri√≠</h2>
                <table id="categoryTable">
                    <thead>
                        <tr>
                            <th>N√°zov</th>
                            <th style="width: 150px;"></th>
                        </tr>
                    </thead>
                    <tbody id="categoryTableBody">
                        </tbody>
                </table>
            </div>

            <div id="groupsContent" style="display: none;">
                </div>

            <div id="clubsContent" style="display: none;">
                 </div>

             <div id="teamCreationContentSection" class="section-block" style="display: none;">
                 <h2>Zoznam t√≠mov</h2>
                 <table id="createdTeamsTable">
                     <thead>
                         <tr id="createdTeamsTableHeader"> <th>N√°zov t√≠mu</th>
                             <th style="width: 150px;"></th>
                         </tr>
                     </thead>
                     <tbody id="createdTeamsTableBody">
                         </tbody>
                 </table>
            </div>

            </main>
    </div>


<script type="module">
        // Import potrebn√Ωch Firebase Firestore funkci√≠ priamo z CDN
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, query, where, addDoc, updateDoc, writeBatch } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';

        // Tvoja Firebase konfigur√°cia
        const firebaseConfig = {
            apiKey: "AIzaSyD0h0rQZiIGi0-UDb4-YU_JihRGpIlfz40", // ZME≈á ZA SVOJ SKUTOƒåN√ù API KƒΩ√öƒå
            authDomain: "turnaj-a28c5.firebaseapp.com", // ZME≈á ZA SVOJ SKUTOƒåN√ù authDomain
            projectId: "turnaj-a28c5", // ZME≈á ZA SVOJ SKUTOƒåN√ù projectId
            storageBucket: "turnaj-a28c5.firebasestorage.app", // ZME≈á ZA SVOJ SKUTOƒåN√ù storageBucket
            messagingSenderId: "131088352981", // ZME≈á ZA SVOJ SKUTOƒåN√ù messagingSenderId
            appId: "1:131088352981:web:4a2b2c3d4e5f6g7h8i9j0", // ZME≈á ZA SVOJ SKUTOƒåN√ù appId
            measurementId: "G-XXXXXXXXXX" // ZME≈á ZA SVOJ SKUTOƒåN√ù measurementId, ak pou≈æ√≠va≈° Google Analytics
        };

        // Inicializ√°cia Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Referencie na hlavn√© kolekcie v datab√°ze Firestore
        // Predpoklad√°me, ≈æe v≈°etky d√°ta turnaja s√∫ pod jedn√Ωm dokumentom 'mainTournamentData' v kolekcii 'tournamentData'
        const tournamentDataRef = doc(db, 'tournamentData', 'mainTournamentData');
        const categoriesCollectionRef = collection(tournamentDataRef, 'categories');
        const groupsCollectionRef = collection(tournamentDataRef, 'groups');
        const clubsCollectionRef = collection(tournamentDataRef, 'clubs');


        // --- GLOB√ÅLNE PREMENN√â PRE MOD√ÅLY A D√ÅTA ---
        // Premenn√© pre mod√°l kateg√≥ri√≠
        const categoryModal = document.getElementById('categoryModal');
        const categoryModalCloseBtn = categoryModal.querySelector('.close');
        const categoryForm = document.getElementById('categoryForm');
        const categoryNameInput = document.getElementById('categoryName');
        const categorySubmitButton = categoryForm.querySelector('button[type="submit"]');
        let currentCategoryModalMode = 'add'; // 'add' alebo 'edit'
        let editingCategoryId = null; // Uchov√°va ID kateg√≥rie v re≈æime √∫pravy

        // Premenn√© pre mod√°l skup√≠n
        const groupModal = document.getElementById('groupModal');
        const groupModalCloseBtn = groupModal.querySelector('.close');
        const groupForm = document.getElementById('groupForm');
        const groupNameInput = document.getElementById('groupName');
        const groupCategorySelect = document.getElementById('groupCategory'); // Select pre v√Ωber kateg√≥rie v mod√°li skupiny
        const groupSubmitButton = groupForm.querySelector('button[type="submit"]');
        let currentGroupModalMode = 'add'; // 'add' alebo 'edit'
        let editingGroupId = null; // Uchov√°va ID skupiny v re≈æime √∫pravy

        // Premenn√© pre mod√°l klubov/t√≠mov (priradenie do skup√≠n & √∫prava)
        const clubModal = document.getElementById('clubModal');
        const clubModalCloseBtn = clubModal.querySelector('.club-modal-close');
        const clubForm = document.getElementById('clubForm');
        const clubNameInput = document.getElementById('clubName'); // Pre √∫pravu n√°zvu (v edit m√≥de)
        const clubCategorySelect = document.getElementById('clubCategory'); // Select pre v√Ωber kateg√≥rie v mod√°li klubu
        const clubGroupSelect = document.getElementById('clubGroup'); // Select pre v√Ωber skupiny v mod√°li klubu
        const clubModalTitle = document.getElementById('clubModalTitle');

        // Referencie pre zmeny viditeƒænosti v CLUB MOD√ÅLI (pre Add/Assign vs Edit)
        const unassignedClubSelectContainer = document.getElementById('unassignedClubSelectContainer');
        const unassignedClubSelect = document.getElementById('unassignedClubSelect'); // Select pre v√Ωber nepriraden√©ho t√≠mu
        const clubNameInputContainer = document.getElementById('clubNameInputContainer'); // Kontajner pre input n√°zvu (viditeƒæn√Ω len pri Edit)
         const orderInputContainer = document.getElementById('orderInputContainer'); // Kontajner pre poradie
        const orderInGroupInput = document.getElementById('orderInGroup'); // Input pre poradie

        // Stavov√© premenn√© pre CLUB MODAL
        let currentClubModalMode = 'add-assign'; // 'add-assign' alebo 'edit'
        let editingClubId = null; // Uchov√°va ID t√≠mu v re≈æime √∫pravy


        // Premenn√© pre mod√°l hromadn√©ho vytv√°rania t√≠mov
        const teamCreationModal = document.getElementById('teamCreationModal');
        const teamCreationModalCloseBtn = teamCreationModal.querySelector('.close');
        const teamCreationForm = document.getElementById('teamCreationForm');
        const teamNameInput = document.getElementById('teamNameInput');
        const teamCategoryCountContainer = document.getElementById('teamCategoryCountContainer'); // Kontajner pre dynamick√© dvojice kateg√≥ria/poƒçet
        const addCategoryCountPairButton = document.getElementById('addCategoryCountPairButton'); // Tlaƒçidlo na pridanie ƒèal≈°ej dvojice
        const teamCreationSubmitButton = teamCreationForm.querySelector('button[type="submit"]');

        // Premenn√© pre mod√°l spr√°vy jednotliv√Ωch t√≠mov (z Create Teams listu)
        const manageTeamsModal = document.getElementById('manageTeamsModal');
        const manageTeamsModalCloseBtn = manageTeamsModal.querySelector('.close');
        const manageTeamsContent = document.getElementById('manageTeamsContent');


        // Glob√°lne zoznamy d√°t pre plnenie selectboxov atƒè.
        let allAvailableCategories = []; // Zoznam v≈°etk√Ωch kateg√≥ri√≠ ID
        // let allAvailableGroups = []; // Zoznam v≈°etk√Ωch skup√≠n ID (ak by bol potrebn√Ω)
        // let allAvailableClubs = []; // Zoznam v≈°etk√Ωch klubov ID (ak by bol potrebn√Ω)


        // --- Pomocn√© funkcie ---

        // Funkcia na naplnenie selectboxu kateg√≥ri√≠ (pou≈æ√≠va sa vo viacer√Ωch mod√°loch)
        async function populateCategorySelect(selectElement, includePlaceholder = true) {
             console.log(`DEBUG: Populating categories for select: ${selectElement.id || 'Unnamed Select'}`);
              selectElement.innerHTML = ''; // Clear before adding options
               if (includePlaceholder) {
                 selectElement.innerHTML = '<option value="">-- Vyberte kateg√≥riu --</option>'; // Add placeholder
              }


              selectElement.disabled = true; // Disable while loading

              try {
                  const querySnapshot = await getDocs(categoriesCollectionRef);
                  if (querySnapshot.empty) {
                      const option = document.createElement('option');
                      option.value = '';
                      option.textContent = '-- ≈Ωiadne kateg√≥rie --';
                       option.disabled = true; // Make it non-selectable
                      selectElement.appendChild(option);
                       selectElement.disabled = true; // Keep disabled if no categories
                       console.warn("No categories found in Firestore.");
                  } else {
                       selectElement.disabled = false; // Enable if categories are found
                       const sortedDocs = querySnapshot.docs.sort((a, b) => a.id.localeCompare(b.id));
                       allAvailableCategories = sortedDocs.map(doc => doc.id); // Update global list
                       sortedDocs.forEach((doc) => {
                            const categoryName = doc.id; // Kateg√≥ria ID je n√°zov dokumentu
                            const option = document.createElement('option');
                            option.value = categoryName;
                            option.textContent = categoryName;
                            selectElement.appendChild(option);
                       });

                       // Po naplnen√≠ mo≈ænost√≠ nastav√≠me selectedCategoryId, ak bol poskytnut√Ω
                       // Toto sa pou≈æ√≠va napr. pri √∫prave skupiny/klubu
                        // Ak includePlaceholder = true a selectedCategoryId nie je n√°jden√Ω, zostane vybran√Ω placeholder
                        if (selectedCategoryId) {
                            selectElement.value = selectedCategoryId;
                        }
                   }
               } catch (error) {
                   console.error('Chyba pri naƒç√≠tan√≠ kateg√≥ri√≠: ', error);
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = '-- Chyba pri naƒç√≠tan√≠ --';
                    option.disabled = true;
                    selectElement.appendChild(option);
                    selectElement.disabled = true; // Keep disabled on error
               } finally {
                   // --- Prida≈• volanie na odstr√°nenie duplic√≠t po naplnen√≠ ---
                   // T√∫to funkciu vol√°me v≈ædy po naplnen√≠, ako poistku (pre clubCategorySelect)
                   if (selectElement.id === 'clubCategory') {
                        removeDuplicateOptions(selectElement);
                   }
                   // ------------------------------------------------------
               }
            }


         // Funkcia na naplnenie selectboxu skup√≠n pre dan√∫ kateg√≥riu
         async function populateGroupSelect(selectedCategoryId, selectElement, selectedGroupId = null) {
              console.log(`DEBUG: Populating groups for select: ${selectElement.id || 'Unnamed Select'} based on category: ${selectedCategoryId}`);
              selectElement.innerHTML = '<option value="">-- Vyberte skupinu --</option>'; // Clear and add placeholder

              selectElement.disabled = true; // Disable while loading


              if (!selectedCategoryId || selectedCategoryId === '' || selectedCategoryId === '-- Vyberte kateg√≥riu --') {
                   // Ak nie je vybran√° platn√° kateg√≥ria, len resetujeme select skup√≠n a nech√°me ho zablokovan√Ω
                   console.log("DEBUG: populateGroupSelect called with no valid category selected. Resetting group select.");
                   // Select u≈æ bol resetovan√Ω na placeholder na zaƒçiatku funkcie
                    // Zabezpeƒç√≠me, ≈æe zostane zablokovan√Ω
                    selectElement.disabled = true; // Ponecha≈• zablokovan√Ω
                   return; // Ukonƒçi≈• funkciu
              }


              try {
                   // Query groups for the selected category
                   const groupsQuery = query(groupsCollectionRef, where('categoryId', '==', selectedCategoryId));
                  const querySnapshot = await getDocs(groupsQuery);

                  if (querySnapshot.empty) {
                       const option = document.createElement('option');
                       option.value = '';
                       option.textContent = '-- ≈Ωiadne skupiny v kateg√≥rii --';
                       option.disabled = true;
                       selectElement.appendChild(option);
                       selectElement.disabled = true; // Keep disabled if no groups found for category
                       console.warn(`No groups found for category: ${selectedCategoryId}`);
                  } else {
                       selectElement.disabled = false; // Enable if groups are found
                       const sortedDocs = querySnapshot.docs.sort((a, b) => a.id.localeCompare(b.id));
                       sortedDocs.forEach((doc) => {
                            const groupName = doc.id; // Group ID je n√°zov dokumentu
                            const option = document.createElement('option');
                            option.value = groupName; // Pou≈æi≈• ID dokumentu ako value
                            option.textContent = groupName; // Pou≈æi≈• ID dokumentu ako text (alebo pou≈æi≈• in√© pole z dokumentu skupiny ak existuje, napr. group.name)
                            selectElement.appendChild(option);
                       });

                       // Set the selected value if provided
                       if (selectedGroupId) {
                           selectElement.value = selectedGroupId;
                       }
                   }
               } catch (error) {
                   console.error(`Chyba pri naƒç√≠tan√≠ skup√≠n pre kateg√≥riu ${selectedCategoryId}: `, error);
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = '-- Chyba pri naƒç√≠tan√≠ --';
                    option.disabled = true;
                    selectElement.appendChild(option);
                    selectElement.disabled = true; // Keep disabled on error
               } finally {
                   // --- Prida≈• volanie na odstr√°nenie duplic√≠t po naplnen√≠ ---
                   // T√∫to funkciu vol√°me v≈ædy po naplnen√≠, ako poistku (pre clubGroupSelect)
                   if (selectElement.id === 'clubGroup') {
                       removeDuplicateOptions(selectElement);
                   }
                    // ------------------------------------------------------
               }
         }


         // Funkcia na naplnenie selectboxu nepriraden√Ωch t√≠mov (pre clubModal v add-assign m√≥de)
         async function populateUnassignedClubsSelect(selectElement, selectedClubId = null) {
              console.log(`DEBUG: Populating unassigned clubs for select: ${selectElement.id || 'Unnamed Select'}`);
             selectElement.innerHTML = '<option value="">-- Vyberte t√≠m na priradenie --</option>'; // Clear and add placeholder

             selectElement.disabled = true; // Disable while loading

             try {
                  // Filtrova≈• kluby, kde groupId je null (alebo nie je nastaven√©)
                 const unassignedQuery = query(clubsCollectionRef, where('groupId', '==', null)); // Filtrova≈• podƒæa groupId == null
                 const querySnapshot = await getDocs(unassignedQuery);

                 if (querySnapshot.empty) {
                       const option = document.createElement('option');
                       option.value = '';
                       option.textContent = '-- ≈Ωiadne nepriraden√© t√≠my --';
                       option.disabled = true;
                       selectElement.appendChild(option);
                       selectElement.disabled = true; // Keep disabled if no unassigned teams
                       console.log("No unassigned clubs found.");
                 } else {
                      selectElement.disabled = false; // Enable if unassigned clubs are found
                       // Zoradi≈• podƒæa n√°zvu pre ƒæah≈°ie n√°jdenie
                       const sortedDocs = querySnapshot.docs.sort((a, b) => (a.data().name || '').localeCompare(b.data().name || ''));

                       sortedDocs.forEach((doc) => {
                           const club = doc.data();
                           const option = document.createElement('option');
                           option.value = doc.id; // Pou≈æi≈• ID dokumentu ako value (auto-generovan√©)
                           option.textContent = club.name || 'Bez n√°zvu'; // Pou≈æi≈• n√°zov klubu ako text
                           selectElement.appendChild(option);
                       });

                       // Nastavi≈• vybran√∫ hodnotu, ak bola poskytnut√°
                       if (selectedClubId) {
                           selectElement.value = selectedClubId;
                       }
                 }
             } catch (error) {
                  console.error('Chyba pri naƒç√≠tan√≠ nepriraden√Ωch t√≠mov: ', error);
                   const option = document.createElement('option');
                   option.value = '';
                   option.textContent = '-- Chyba pri naƒç√≠tan√≠ --';
                   option.disabled = true;
                   selectElement.appendChild(option);
                   selectElement.disabled = true; // Keep disabled on error
             }
              // Pri tomto selecte neoƒçak√°vame duplicity n√°zvov v r√°mci nepriraden√Ωch,
              // tak≈æe funkciu removeDuplicateOptions tu nevol√°me.
         }


        // Funkcia na naƒç√≠tanie v≈°etk√Ωch kateg√≥ri√≠ pre dynamick√© selectboxy (v mod√°li vytv√°rania t√≠mov)
        async function loadAllCategoriesForDynamicSelects() {
            console.log("DEBUG: loading all categories for dynamic selects...");
            try {
                const querySnapshot = await getDocs(categoriesCollectionRef);
                if (querySnapshot.empty) {
                    allAvailableCategories = []; // Reset
                    console.warn("No categories found for dynamic selects.");
                } else {
                     const sortedDocs = querySnapshot.docs.sort((a, b) => a.id.localeCompare(b.id));
                    allAvailableCategories = sortedDocs.map(doc => doc.id); // Fill the global array
                }
                // Po naƒç√≠tan√≠, aktualizujeme dynamicky pridan√© selecty
                updateDynamicCategorySelects(); // T√°to funkcia mus√≠ pou≈æi≈• allAvailableCategories na naplnenie selectov
                 checkIfAddCategoryButtonShouldBeVisible(); // T√°to funkcia pou≈æ√≠va allAvailableCategories
                 console.log("DEBUG: All categories loaded and dynamic selects/button updated.");

            } catch (error) {
                console.error('Chyba pri naƒç√≠tan√≠ kateg√≥ri√≠ pre dynamick√© selectboxy: ', error);
                 allAvailableCategories = []; // Reset on error
                 // Aj pri chybe sa pok√∫sime aktualizova≈• selecty a viditeƒænos≈• tlaƒçidla
                 updateDynamicCategorySelects();
                  checkIfAddCategoryButtonShouldBeVisible();
                  console.log("DEBUG: Error loading categories, dynamic selects/button updated with empty list.");
            }
             console.log("DEBUG: finished loading all categories for dynamic selects. allAvailableCategories:", allAvailableCategories);
        }

         // Funkcia na aktualiz√°ciu mo≈ænost√≠ v dynamicky pridan√Ωch category selectoch (v mod√°li vytv√°rania t√≠mov)
         function updateDynamicCategorySelects() {
              console.log("DEBUG: updateDynamicCategorySelects called.");
             const dynamicCategorySelects = teamCategoryCountContainer.querySelectorAll('.team-category-select-dynamic');
             dynamicCategorySelects.forEach(selectElement => {
                  const currentValue = selectElement.value; // Zapam√§t√°me si aktu√°lnu hodnotu

                  selectElement.innerHTML = '<option value="">-- Vyberte kateg√≥riu --</option>'; // Vyƒçist√≠me a prid√°me placeholder
                  selectElement.disabled = true; // Zablokujeme poƒças aktualiz√°cie

                 if (allAvailableCategories.length > 0) {
                      allAvailableCategories.forEach(categoryName => {
                           const option = document.createElement('option');
                           option.value = categoryName;
                           option.textContent = categoryName;
                           selectElement.appendChild(option);
                      });
                       selectElement.disabled = false; // Povol√≠me, ak s√∫ kateg√≥rie

                       // Pok√∫sime sa nastavi≈• sp√§≈• zapam√§tan√∫ hodnotu
                       if (currentValue && allAvailableCategories.includes(currentValue)) {
                           selectElement.value = currentValue;
                       }

                 } else {
                       const option = document.createElement('option');
                       option.value = '';
                       option.textContent = '-- ≈Ωiadne kateg√≥rie --';
                       option.disabled = true;
                       selectElement.appendChild(option);
                       selectElement.disabled = true; // Zostane zablokovan√Ω
                 }
                  // Pri dynamick√Ωch selectoch neoƒçak√°vame duplicity generovan√© k√≥dom
                  // tak≈æe funkciu removeDuplicateOptions tu nevol√°me
             });
             console.log(`DEBUG: Updated ${dynamicCategorySelects.length} dynamic category selects.`);
         }

        // Funkcia na mana≈æovanie viditeƒænosti tlaƒçidla "Prida≈• ƒèal≈°iu kateg√≥riu" (v mod√°li vytv√°rania t√≠mov)
        function checkIfAddCategoryButtonShouldBeVisible() {
             console.log("DEBUG: checkIfAddCategoryButtonShouldBeVisible called.");
            // Tlaƒçidlo by malo by≈• viditeƒæn√©, len ak existuj√∫ nejak√© kateg√≥rie
            if (addCategoryCountPairButton) {
                if (allAvailableCategories.length > 0) {
                    addCategoryCountPairButton.style.display = 'inline-block'; // Alebo 'block'
                     console.log("DEBUG: Add category button visible.");
                } else {
                    addCategoryCountPairButton.style.display = 'none';
                     console.log("DEBUG: Add category button hidden (no categories).");
                }
            }
        }

         // Funkcia na pridanie novej dvojice Kateg√≥ria/Poƒçet do formul√°ra vytv√°rania t√≠mov
         async function addCategoryCountPair() {
              console.log("DEBUG: addCategoryCountPair called.");
             if (!teamCategoryCountContainer || !allAvailableCategories) {
                  console.error("Cannot add category count pair: container or categories list not found.");
                  return;
             }

             const pairDiv = document.createElement('div');
             pairDiv.classList.add('category-count-pair'); // Pridaj triedu pre ≈°t√Ωlovanie/v√Ωber

             const categorySelect = document.createElement('select');
             categorySelect.classList.add('team-category-select-dynamic');
              categorySelect.setAttribute('required', ''); // Select kateg√≥rie je povinn√Ω

             const countInput = document.createElement('input');
             countInput.type = 'number';
             countInput.value = '1'; // Predvolen√° hodnota
             countInput.min = '1';
             countInput.classList.add('team-count-input-dynamic');
              countInput.setAttribute('required', ''); // Input poƒçtu je povinn√Ω

              const removeButton = document.createElement('button');
              removeButton.type = 'button'; // D√¥le≈æit√©: aby nesp√∫≈°≈•alo submit formul√°ra
              removeButton.textContent = 'Odstr√°ni≈•';
              removeButton.classList.add('remove-pair-button'); // Trieda pre ≈°t√Ωlovanie
              removeButton.style.marginLeft = '10px'; // Mal√Ω odstup


              // Napln√≠me nov√Ω select kateg√≥ri√≠ dostupn√Ωmi kateg√≥riami
              updateDynamicCategorySelects(); // Re-run this to populate the new select (and update others)

              // Pridaj listener na tlaƒçidlo odstr√°ni≈•
              removeButton.addEventListener('click', () => {
                   console.log("DEBUG: removePairButton clicked.");
                  pairDiv.remove(); // Odstr√°ni cel√∫ dvojicu
                  updateRemoveButtonVisibility(); // Aktualizuje viditeƒænos≈• tlaƒçidiel odstr√°ni≈•
              });

             pairDiv.appendChild(categorySelect);
             pairDiv.appendChild(countInput);
             pairDiv.appendChild(removeButton); // Pridaj tlaƒçidlo odstr√°ni≈•
             teamCategoryCountContainer.appendChild(pairDiv);

             updateRemoveButtonVisibility(); // Zabezpeƒç√≠ spr√°vnu viditeƒænos≈• tlaƒçidiel odstr√°ni≈• po pridan√≠
              console.log("DEBUG: Category count pair added.");
         }

         // Funkcia na mana≈æovanie viditeƒænosti tlaƒçidiel "Odstr√°ni≈•" pri dvojiciach kateg√≥ria/poƒçet
         function updateRemoveButtonVisibility() {
              console.log("DEBUG: updateRemoveButtonVisibility called.");
             const removeButtons = teamCategoryCountContainer.querySelectorAll('.remove-pair-button');
             // Zobraz tlaƒçidlo Odstr√°ni≈•, len ak existuje viac ako jedna dvojica
             if (removeButtons.length > 1) {
                  removeButtons.forEach(button => button.style.display = 'inline-block');
                  console.log("DEBUG: Showing remove buttons.");
             } else {
                  removeButtons.forEach(button => button.style.display = 'none');
                  console.log("DEBUG: Hiding remove buttons (only one pair left).");
             }
         }


         // Funkcia na odstr√°nenie duplicitn√Ωch <option> elementov zo selectboxu
         // Pou≈æ√≠vame ju ako poistku po naplnen√≠ selectboxov kateg√≥ri√≠ a skup√≠n
         function removeDuplicateOptions(selectElement) {
              if (!selectElement) {
                  console.error("DEBUG: Attempted to remove duplicates from a null select element.");
                  return;
              }
              console.log(`DEBUG: Removing duplicates from select: ${selectElement.id || 'Unnamed Select'}`);
              const seenValues = new Set();
              // Iterova≈• od konca, aby bolo odstra≈àovanie bezpeƒçn√© pre indexy
              for (let i = selectElement.options.length - 1; i >= 0; i--) {
                   const option = selectElement.options[i];
                   // Pou≈æijeme option.value na kontrolu jedineƒçnosti
                   if (seenValues.has(option.value)) {
                        console.log(`DEBUG: Removing duplicate option with value: "${option.value}" and text: "${option.textContent}"`);
                       selectElement.removeChild(option);
                   } else {
                        seenValues.add(option.value);
                   }
              }
              console.log(`DEBUG: Finished removing duplicates. Remaining options: ${selectElement.options.length}`);
         }


        // --- Funkcia na zobrazenie klubov priraden√Ωch do skup√≠n v sekcii #timy-do-skupin ---
        // Pridan√Ω pr√≠znak isDisplayingClubs na zabr√°nenie viacn√°sobn√©mu spusteniu
        let isDisplayingClubs = false;
        async function displayClubs() {
            console.log("DEBUG: displayClubs called.");

            // --- Kontrola, ƒçi funkcia u≈æ be≈æ√≠ ---
            if (isDisplayingClubs) {
                 console.log("DEBUG: displayClubs is already running, skipping.");
                 return; // Ak u≈æ be≈æ√≠, preskoƒç√≠me
            }
             isDisplayingClubs = true; // Nastav√≠me pr√≠znak na zaƒçiatku vykon√°vania


            const clubsContentSection = document.getElementById('clubsContent');
            const clubsTableBody = document.getElementById('clubsTableBody');

            if (!clubsContentSection || !clubsTableBody) {
                 console.error("FATAL ERROR: Required DOM elements for displayClubs not found!");
                 isDisplayingClubs = false; // Reset pr√≠znaku aj pri chybe hƒæadania elementov
                 return;
            }

            // Vymaza≈• telo tabuƒæky PRED naƒç√≠tan√≠m nov√Ωch d√°t
            clubsTableBody.innerHTML = '';
            console.log("DEBUG: clubsTableBody cleared.");


            try {
                // Naƒç√≠tanie klubov, ktor√© s√∫ priraden√© do skupiny (groupId nie je null)
                console.log("DEBUG: Fetching assigned clubs...");
                // Pou≈æijeme where('groupId', '!=', null) na filtrovanie priraden√Ωch t√≠mov
                const assignedClubsQuery = query(clubsCollectionRef, where('groupId', '!=', null));
                const querySnapshot = await getDocs(assignedClubsQuery);

                console.log(`DEBUG: Found ${querySnapshot.size} assigned clubs.`);

                if (querySnapshot.empty) {
                    const row = clubsTableBody.insertRow();
                    const cell = row.insertCell(0);
                    cell.colSpan = 4; // Predpoklad√°me 4 stƒ∫pce: N√°zov, Kateg√≥ria, Skupina, Poradie
                    cell.textContent = '≈Ωiadne t√≠my zatiaƒæ nie s√∫ priraden√© do skup√≠n.';
                    cell.style.textAlign = 'center';
                     console.log("DEBUG: No assigned clubs found. Table populated with message.");
                } else {
                    // Zoradenie priraden√Ωch klubov podƒæa skupiny a n√°sledne podƒæa poradia v skupine
                     const sortedClubs = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                         .sort((a, b) => {
                             // Zoradenie podƒæa groupId
                             const groupComparison = (a.groupId || '').localeCompare(b.groupId || '');
                             if (groupComparison !== 0) {
                                 return groupComparison;
                             }
                             // Potom zoradenie podƒæa orderInGroup (o≈°etrenie null/undefined a numerick√© porovnanie)
                             const orderA = typeof a.orderInGroup === 'number' ? a.orderInGroup : Infinity; // null/undefined id√∫ nakoniec
                             const orderB = typeof b.orderInGroup === 'number' ? b.orderInGroup : Infinity;
                             return orderA - orderB;
                         });

                    console.log(`DEBUG: Populating table with ${sortedClubs.length} sorted clubs.`);
                    sortedClubs.forEach((club) => {
                        const row = clubsTableBody.insertRow();
                        row.insertCell(0).textContent = club.name || 'Bez n√°zvu';
                         row.insertCell(1).textContent = club.categoryId || 'N/A';
                         row.insertCell(2).textContent = club.groupId || 'N/A'; // Toto by malo by≈• v≈ædy groupId v tejto query
                         row.insertCell(3).textContent = typeof club.orderInGroup === 'number' ? club.orderInGroup : '-'; // Zobraz '-' ak nie je poradie
                        // Tlaƒçidl√° na √∫pravu/zmazanie priraden√Ωch t√≠mov by sa pridali tu, ak s√∫ v tomto pohƒæade povolen√©
                        // Napr.: Pridanie bunky s tlaƒçidlami √öprava/Zmaza≈•
                         /*
                         const actionsCell = row.insertCell(4); // Pridaj ƒèal≈°√≠ stƒ∫pec
                         const editButton = document.createElement('button');
                         editButton.textContent = 'Upravi≈•';
                         editButton.addEventListener('click', () => {
                              // Logic to open clubModal in edit mode for this club
                              openClubModal(club.id, club); // Pou≈æi≈• ID dokumentu a naƒç√≠tan√© d√°ta
                         });
                         const deleteButton = document.createElement('button');
                         deleteButton.textContent = 'Zmaza≈•';
                         deleteButton.addEventListener('click', async () => {
                              if (confirm(`Naozaj chcete zmaza≈• t√≠m "${club.name}" zo skupiny "${club.groupId}"?`)) {
                                   try {
                                        await deleteDoc(doc(clubsCollectionRef, club.id));
                                        alert('T√≠m √∫spe≈°ne zmazan√Ω.');
                                        displayClubs(); // Refresh table
                                        displayCreatedTeams(); // Refresh created teams list
                                        if (unassignedClubSelect) populateUnassignedClubsSelect(unassignedClubSelect, null); // Refresh unassigned list
                                   } catch (error) {
                                        console.error('Chyba pri mazan√≠ t√≠mu: ', error);
                                        alert('Chyba pri mazan√≠ t√≠mu.');
                                   }
                              }
                         });
                         actionsCell.appendChild(editButton);
                         actionsCell.appendChild(deleteButton);
                         */
                    });
                     console.log("DEBUG: Table population complete.");
                }
            } catch (error) {
                console.error('Chyba pri naƒç√≠tan√≠ priraden√Ωch klubov: ', error);
                 clubsTableBody.innerHTML = ''; // Vymaza≈• tabuƒæku pri chybe
                 const row = clubsTableBody.insertRow();
                 const cell = row.insertCell(0);
                 cell.colSpan = 4; // Predpoklad√°me 4 stƒ∫pce
                 cell.textContent = 'Chyba pri naƒç√≠tan√≠ d√°t.';
                 cell.style.textAlign = 'center';
                 console.log("DEBUG: Error displayed in table.");
            } finally {
                 isDisplayingClubs = false; // V≈ædy resetova≈• pr√≠znak na konci
                 console.log("DEBUG: displayClubs finished and flag reset.");
            }
        }


        // Funkcia na zobrazenie v≈°etk√Ωch vytvoren√Ωch t√≠mov (v sekcii #zoznam-timov)
        // Pridan√Ω pr√≠znak isDisplayingCreatedTeams na zabr√°nenie viacn√°sobn√©mu spusteniu
         let isDisplayingCreatedTeams = false;
         async function displayCreatedTeams() {
              console.log("DEBUG: displayCreatedTeams called.");
              if (isDisplayingCreatedTeams) {
                   console.log("DEBUG: displayCreatedTeams is already running, skipping.");
                   return;
              }
              isDisplayingCreatedTeams = true;

              const createdTeamsContentSection = document.getElementById('createdTeamsContentSection');
              const createdTeamsTableBody = document.getElementById('createdTeamsTableBody'); // Predpoklad√°me existenciu tbody pre t√∫to tabuƒæku

               if (!createdTeamsContentSection || !createdTeamsTableBody) {
                   console.error("FATAL ERROR: Required DOM elements for displayCreatedTeams not found!");
                   isDisplayingCreatedTeams = false;
                   return;
               }

               createdTeamsTableBody.innerHTML = ''; // Vyƒçisti telo tabuƒæky
               console.log("DEBUG: createdTeamsTableBody cleared.");


              try {
                   // Naƒç√≠taj V≈†ETKY kluby bez ohƒæadu na priradenie do skup√≠n
                   const allClubsQuery = query(clubsCollectionRef);
                   const querySnapshot = await getDocs(allClubsQuery);

                   console.log(`DEBUG: Found ${querySnapshot.size} total clubs.`);

                   if (querySnapshot.empty) {
                       const row = createdTeamsTableBody.insertRow();
                       const cell = row.insertCell(0);
                       cell.colSpan = 5; // Predpoklad√°me 5 stƒ∫pcov: Z√°kladn√Ω n√°zov, Kateg√≥ria, Poƒçet, Skupina, Akcie
                       cell.textContent = 'Zatiaƒæ nie s√∫ vytvoren√© ≈æiadne t√≠my.';
                       cell.style.textAlign = 'center';
                        console.log("DEBUG: No created teams found. Table populated with message.");
                   } else {
                       // Zoskupenie t√≠mov podƒæa z√°kladn√©ho n√°zvu a kateg√≥rie
                       // Z√°kladn√Ω n√°zov sa pok√∫sime z√≠ska≈• z ID "Kateg√≥ria - Z√°kladn√Ω N√°zov [Suffix]" alebo pou≈æijeme cel√Ω n√°zov
                       const teamsData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                       // Mapa pre zoskupenie: { "Z√°kladn√Ω n√°zov_Kateg√≥ria": [t√≠m1, t√≠m2, ...], ... }
                       const groupedTeams = teamsData.reduce((acc, team) => {
                            const teamName = team.name || 'Bez n√°zvu';
                            const category = team.categoryId || 'N/A';
                            // Sk√∫sme extrahova≈• z√°kladn√Ω n√°zov z ID, ak m√° form√°t "Kateg√≥ria - Z√°kladn√Ω N√°zov [Suffix]"
                             // Toto je komplexn√© a nemus√≠ fungova≈• pre v≈°etky ID/form√°ty
                             // Jednoduch≈°ie: Zoskupme len podƒæa PLNEHO n√°zvu a kateg√≥rie, alebo len podƒæa kateg√≥rie a n√°zvu.
                             // Ak chceme zoskupova≈• ako "Z√°kladn√Ω n√°zov (Kateg√≥ria)", mus√≠me extrahova≈• z√°kladn√Ω n√°zov.
                             // Predpokladajme, ≈æe z√°kladn√Ω n√°zov je ƒças≈• n√°zvu pred poslednou medzerou a ƒç√≠slom/p√≠smenom, alebo cel√Ω n√°zov
                             // Ak sa t√≠m vytvor√≠ cez modal "Vytvori≈• t√≠my", jeho n√°zov by mal by≈• Z√°kladn√Ω n√°zov + Suffix (napr. H√°dzan√° Trenƒç√≠n 1)
                             // Ak sa prirad√≠ nepriraden√Ω t√≠m, jeho n√°zov ostane p√¥vodn√Ω (napr. FC Juniori B)
                             // Najjednoduch≈°ie a najbezpeƒçnej≈°ie je zoskupi≈• len podƒæa KATEG√ìRIE a v r√°mci kateg√≥rie zobrazi≈• t√≠my.
                             // Alebo zoskupova≈• podƒæa PLNEHO n√°zvu a kateg√≥rie.

                             // Ak chceme zoskupova≈• ako "Z√°kladn√Ω n√°zov" a zobrazi≈• kateg√≥rie/poƒçet, mus√≠me ma≈• konzistentn√Ω sp√¥sob extrakcie.
                             // Sk√∫sme zoskupi≈• podƒæa team.name a team.categoryId ako jedineƒçn√Ω kƒæ√∫ƒç pre agreg√°ciu
                             const groupKey = `${teamName}_${category}`; // Unik√°tny kƒæ√∫ƒç pre zoskupenie

                             if (!acc[groupKey]) {
                                  acc[groupKey] = {
                                       name: teamName, // Ulo≈æ√≠me pln√Ω n√°zov
                                       categoryId: category,
                                       teams: [] // Zoznam t√≠mov s t√Ωmto n√°zvom a kateg√≥riou
                                  };
                             }
                              acc[groupKey].teams.push(team); // Pridaj t√≠m do skupiny
                            return acc;
                       }, {});

                       console.log("DEBUG: Grouped teams data:", groupedTeams);

                       // Zobrazenie zoskupen√Ωch d√°t v tabuƒæke
                       // Zorad√≠me zoskupen√© skupiny (napr. podƒæa n√°zvu)
                       const sortedGroupKeys = Object.keys(groupedTeams).sort();

                       sortedGroupKeys.forEach(key => {
                            const groupInfo = groupedTeams[key];
                             const teamsInGroup = groupInfo.teams; // Zoznam t√≠mov pre toto zoskupenie

                             // Zorad√≠me t√≠my v r√°mci zoskupenia (napr. podƒæa ID alebo n√°zvu, alebo orderInGroup ak by bolo konzistentn√©)
                             // Ak ide o t√≠my z "Vytvori≈• t√≠my" (napr. H√°dzan√° Trenƒç√≠n 1, H√°dzan√° Trenƒç√≠n 2), chceme ich zoradi≈• podƒæa suffixu
                             // Toto vy≈æaduje inteligentnej≈°ie zoradenie
                              teamsInGroup.sort((a, b) => {
                                  // Jednoduch√© zoradenie podƒæa ID alebo n√°zvu
                                  return (a.name || '').localeCompare(b.name || ''); // Zoradi≈• podƒæa n√°zvu
                              });

                            // Zobraz√≠me riadok pre ka≈æd√© zoskupenie (napr. "Z√°kladn√Ω n√°zov (Kateg√≥ria) - Poƒçet: X")
                            // Alebo zobraz√≠me riadok pre KA≈ΩD√ù t√≠m, ale zoskupen√© vizu√°lne?
                            // Ak chceme tabuƒæku podobn√∫ Manage Teams modal, potrebujeme n√°zov, kateg√≥riu, poƒçet (1), skupinu, poradie, akcie
                            // Zobrazme riadok pre KA≈ΩD√ù t√≠m, zoraden√Ω podƒæa kateg√≥rie a n√°zvu, a pridajme stƒ∫pec Skupina/Poradie.

                             teamsInGroup.forEach(team => {
                                  const row = createdTeamsTableBody.insertRow();
                                  row.insertCell(0).textContent = team.name || 'Bez n√°zvu'; // N√°zov t√≠mu
                                   row.insertCell(1).textContent = team.categoryId || 'N/A'; // Kateg√≥ria
                                  // Stƒ∫pec "Poƒçet" - V tomto pohƒæade je ka≈æd√Ω riadok 1 t√≠m, tak≈æe poƒçet je v≈ædy 1
                                   row.insertCell(2).textContent = '1';
                                   // Zobrazi≈• inform√°cie o priraden√≠ do skupiny a poradie
                                   row.insertCell(3).textContent = team.groupId ? `${team.groupId} (${typeof team.orderInGroup === 'number' ? team.orderInGroup : '-'})` : 'Nepriraden√Ω'; // Skupina (Poradie) alebo Nepriraden√Ω

                                  // Stƒ∫pec Akcie - tu by sa pridali tlaƒçidl√° Upravi≈•/Zmaza≈•/Presun√∫≈• (napr. do nepriraden√Ωch)
                                   const actionsCell = row.insertCell(4); // Predpokladaj 5. stƒ∫pec pre akcie
                                   // Tlaƒçidlo √∫pravy
                                    const editButton = document.createElement('button');
                                    editButton.textContent = 'Upravi≈•';
                                    editButton.addEventListener('click', () => {
                                         // Otvor modal na √∫pravu tohto konkr√©tneho t√≠mu
                                         // clubId je document.id, clubData s√∫ naƒç√≠tan√© d√°ta
                                         openClubModal(team.id, team); // Zmena: vol√°me openClubModal v edit m√≥de s ID a d√°tami t√≠mu
                                    });
                                    actionsCell.appendChild(editButton);

                                   // Tlaƒçidlo zmazania
                                    const deleteButton = document.createElement('button');
                                    deleteButton.textContent = 'Zmaza≈•';
                                     deleteButton.classList.add('delete-button'); // Pre ≈°t√Ωlovanie
                                    deleteButton.addEventListener('click', async () => {
                                         if (confirm(`Naozaj chcete zmaza≈• t√≠m "${team.name}"?`)) {
                                              try {
                                                   await deleteDoc(doc(clubsCollectionRef, team.id));
                                                   alert('T√≠m √∫spe≈°ne zmazan√Ω.');
                                                   // Po zmazan√≠ obnov tabuƒæky, ktor√© sa mohli zmeni≈•
                                                   displayCreatedTeams(); // Obnov tento zoznam
                                                   // Ak bol t√≠m priraden√Ω, treba obnovi≈• aj tabuƒæku priraden√Ωch t√≠mov
                                                   if (team.groupId) {
                                                        // Aby sa predi≈°lo viacn√°sobn√©mu volaniu, len skontroluj hash
                                                        if (window.location.hash === '#timy-do-skupin') {
                                                             displayClubs(); // Obnov tabuƒæku priraden√Ωch, ak je viditeƒæn√°
                                                        }
                                                   }
                                                    // Ak bol nepriraden√Ω, treba obnovi≈• zoznam nepriraden√Ωch v mod√°li
                                                    if (!team.groupId) {
                                                         if (unassignedClubSelect) populateUnassignedClubsSelect(unassignedClubSelect, null);
                                                    }


                                              } catch (error) {
                                                   console.error('Chyba pri mazan√≠ t√≠mu: ', error);
                                                   alert('Chyba pri mazan√≠ t√≠mu.');
                                              }
                                         }
                                    });
                                     actionsCell.appendChild(deleteButton);


                                   // Tlaƒçidlo "Presun√∫≈• do nepriraden√Ωch" (len ak je priraden√Ω)
                                    if (team.groupId) {
                                         const unassignButton = document.createElement('button');
                                         unassignButton.textContent = 'Nepriradi≈•';
                                          unassignButton.classList.add('unassign-button'); // Pre ≈°t√Ωlovanie
                                         unassignButton.addEventListener('click', async () => {
                                              if (confirm(`Naozaj chcete t√≠m "${team.name}" odpriradi≈• zo skupiny "${team.groupId}"?`)) {
                                                   try {
                                                        // Odpriradenie t√≠mu = nastavenie groupId a orderInGroup na null
                                                        await updateDoc(doc(clubsCollectionRef, team.id), {
                                                             groupId: null,
                                                             orderInGroup: null
                                                        });
                                                        alert('T√≠m √∫spe≈°ne odpriraden√Ω.');
                                                        // Po odpriraden√≠ obnov tabuƒæky
                                                        displayCreatedTeams(); // Obnov tento zoznam
                                                        // Ak bol priraden√Ω, treba obnovi≈• aj tabuƒæku priraden√Ωch t√≠mov
                                                         if (window.location.hash === '#timy-do-skupin') {
                                                              displayClubs(); // Obnov tabuƒæku priraden√Ωch, ak je viditeƒæn√°
                                                         }
                                                         // Obnovi≈• zoznam nepriraden√Ωch v mod√°li
                                                         if (unassignedClubSelect) populateUnassignedClubsSelect(unassignedClubSelect, null);


                                                   } catch (error) {
                                                        console.error('Chyba pri odpriraden√≠ t√≠mu: ', error);
                                                        alert('Chyba pri odpriraden√≠ t√≠mu.');
                                                   }
                                              }
                                         });
                                         actionsCell.appendChild(unassignButton);
                                    }

                             });


                       });

                   }
              } catch (error) {
                  console.error('Chyba pri naƒç√≠tan√≠ vytvoren√Ωch t√≠mov: ', error);
                   createdTeamsTableBody.innerHTML = ''; // Vyƒçisti tabuƒæku pri chybe
                   const row = createdTeamsTableBody.insertRow();
                   const cell = row.insertCell(0);
                   cell.colSpan = 5;
                   cell.textContent = 'Chyba pri naƒç√≠tan√≠ d√°t.';
                   cell.style.textAlign = 'center';
                    console.log("DEBUG: Error displayed in created teams table.");
              } finally {
                  isDisplayingCreatedTeams = false;
                  console.log("DEBUG: displayCreatedTeams finished and flag reset.");
              }
         }



        // --- Funkcia na prep√≠nanie zobrazenia obsahu na z√°klade URL hashu ---
        function toggleContentDisplay() {
             console.log("DEBUG: toggleContentDisplay called. Current hash:", window.location.hash);
            const hash = window.location.hash || '#kategorie'; // Default to #kategorie

            // Skry≈• v≈°etky obsahov√© sekcie prv
            document.querySelectorAll('main section').forEach(section => {
                section.style.display = 'none';
            });

            // Zobrazi≈• sekciu zodpovedaj√∫cu hashu
            const targetSectionId = `${hash.substring(1)}ContentSection`; // Predpoklad√° ID sekcie ako #hash -> hashContentSection
            // Oprava: N√°zvy ID sekci√≠ s√∫ r√¥zne, nie v≈ædy 'hashContentSection'. Potrebujeme mapovanie alebo konzistentn√© ID.
            // Predpokladajme, ≈æe ID sekci√≠ s√∫: categoriesContentSection, groupsContent, clubsContent, createdTeamsContentSection
            let actualTargetSectionId;
            if (hash === '#kategorie') actualTargetSectionId = 'categoriesContentSection';
            else if (hash === '#skupiny') actualTargetSectionId = 'groupsContent'; // Potrebn√© implementova≈• zobrazenie skup√≠n
            else if (hash === '#timy-do-skupin') actualTargetSectionId = 'clubsContent';
            else if (hash === '#zoznam-timov') actualTargetSectionId = 'createdTeamsContentSection';
            // else if (hash === '#vytvorit-timy') actualTargetSectionId = 'teamCreationContentSection'; // Toto je modal, nie sekcia?

             console.log("DEBUG: Resolved target section ID:", actualTargetSectionId);

            const targetSection = document.getElementById(actualTargetSectionId);

            if (targetSection) {
                 console.log("DEBUG: Showing section:", actualTargetSectionId);
                targetSection.style.display = 'block';

                // Zavola≈• ≈°pecifick√∫ funkciu na zobrazenie obsahu pre dan√∫ sekciu
                if (hash === '#kategorie') {
                    console.log("DEBUG: Calling loadCategoriesTable from toggleContentDisplay");
                    loadCategoriesTable(); // Predpoklad√° existenciu loadCategoriesTable
                } else if (hash === '#skupiny') {
                     console.log("DEBUG: Handling #skupiny from toggleContentDisplay - needs specific display logic.");
                     // Sem by pri≈°la logika na zobrazenie skup√≠n, napr. naƒç√≠tanie kateg√≥ri√≠ pre filter, zobrazenie prvej kateg√≥rie skup√≠n
                     // Napr.: populateCategorySelect(groupCategoryFilterSelect, true); // Napln√≠ filter kateg√≥ri√≠ v sekcii skup√≠n
                     // loadGroupsForCategory(groupCategoryFilterSelect.value); // Naƒç√≠ta skupiny pre predvolen√∫/vybran√∫ kateg√≥riu
                } else if (hash === '#timy-do-skupin') {
                     console.log("DEBUG: Handling #timy-do-skupin from toggleContentDisplay.");
                     // --- ODSTR√ÅNEN√â: displayClubs() sa u≈æ nebude vola≈• z toggleContentDisplay pri ka≈ædej zmene hashu ---
                     // DisplayClubs sa zavol√° pri prvom naƒç√≠tan√≠ str√°nky s t√Ωmto hashom alebo po √∫spe≈°nom submite formul√°ra
                     // Toto by malo by≈• o≈°etren√© extern√Ωm volan√≠m
                     console.log("DEBUG: Relying on external call for displayClubs.");

                } else if (hash === '#zoznam-timov') {
                     console.log("DEBUG: Handling #zoznam-timov from toggleContentDisplay.");
                     // --- ODSTR√ÅNEN√â: displayCreatedTeams() sa u≈æ nebude vola≈• z toggleContentDisplay pri ka≈ædej zmene hashu ---
                     // DisplayCreatedTeams sa zavol√° pri prvom naƒç√≠tan√≠ str√°nky s t√Ωmto hashom alebo po √∫spe≈°nom submite formul√°ra
                      console.log("DEBUG: Relying on external call for displayCreatedTeams.");
                }
                // Pridaj ƒèal≈°ie sekcie tu, ak nejak√© existuj√∫ (napr. #statistiky, #nastavenia)
            } else {
                 console.warn("No content section found for hash:", hash);
                 // Voliteƒæne presmerova≈• na predvolen√∫ str√°nku alebo zobrazi≈• chybov√∫ spr√°vu
                 // window.location.hash = '#kategorie'; // Presmerova≈• na predvolen√∫
            }
        }

        // --- Spr√°va zobrazenia sekci√≠ pri naƒç√≠tan√≠ str√°nky a zmene hashu ---

        // Inicializova≈• stav zobrazenia pri naƒç√≠tan√≠ str√°nky
        // Toto sa spust√≠ raz pri prvom naƒç√≠tan√≠
        console.log("DEBUG: Initial page load display setup.");
        const initialHash = window.location.hash || '#kategorie';

        // Volanie pr√≠slu≈°nej zobrazovacej funkcie pre poƒçiatoƒçn√Ω hash
        if (initialHash === '#kategorie') {
             console.log("DEBUG: Initial display for #kategorie.");
            toggleContentDisplay(); // Spust√≠ toggleContentDisplay, ktor√Ω zobraz√≠ sekciu a zavol√° loadCategoriesTable
        } else if (initialHash === '#skupiny') {
             console.log("DEBUG: Initial display for #skupiny.");
             toggleContentDisplay(); // Spust√≠ toggleContentDisplay, ktor√Ω zobraz√≠ sekciu (logika zobrazenia skup√≠n mus√≠ by≈• v toggleContentDisplay alebo inde)
        } else if (initialHash === '#timy-do-skupin') {
             console.log("DEBUG: Initial display for #timy-do-skupin. Calling toggleContentDisplay and displayClubs.");
             toggleContentDisplay(); // Zobraz√≠ sekciu #timy-do-skupin
             displayClubs(); // Zavol√° displayClubs pre prvotn√© naplnenie tabuƒæky priraden√Ωch t√≠mov
        } else if (initialHash === '#zoznam-timov') {
             console.log("DEBUG: Initial display for #zoznam-timov. Calling toggleContentDisplay and displayCreatedTeams.");
             toggleContentDisplay(); // Zobraz√≠ sekciu #zoznam-timov
             displayCreatedTeams(); // Zavol√° displayCreatedTeams pre prvotn√© naplnenie tabuƒæky v≈°etk√Ωch t√≠mov
        } else {
             console.warn(`DEBUG: Initial hash ${initialHash} does not match any known section. Defaulting to #kategorie.`);
             window.location.hash = '#kategorie'; // Presmeruje na #kategorie, ƒço spust√≠ hashchange listener
        }


        // Prida≈• posluch√°ƒça udalosti 'hashchange', ktor√Ω zavol√° toggleContentDisplay
        // Toto sa spust√≠ pri KA≈ΩDEJ zmene hashu (kliknutie na navigaƒçn√© linky, programov√° zmena hashu)
        console.log("DEBUG: Adding hashchange listener.");
        window.addEventListener('hashchange', toggleContentDisplay);


        // --- Inicializ√°cia d√°t pri naƒç√≠tan√≠ skriptu ---
        // Tieto d√°ta s√∫ potrebn√© pre plnenie selectboxov v mod√°loch hneƒè pri ich otvoren√≠
        loadAllCategoriesForDynamicSelects(); // Naƒç√≠ta kateg√≥rie pre mod√°l vytv√°rania t√≠mov a vol√° updateDynamicCategorySelects/checkIfAddCategoryButtonShouldBeVisible
        // populateCategorySelect(clubCategorySelect, true); // Toto volanie je presunut√© do openClubModal
        // populateUnassignedClubsSelect(unassignedClubSelect, null); // Toto volanie je presunut√© do openClubModal

        // Naƒç√≠tanie poƒçiatoƒçn√Ωch d√°t pre hlavn√© pohƒæady (u≈æ o≈°etren√© vy≈°≈°ie v logike inicializ√°cie podƒæa hashu)
        // displayClubs(); // Nechceme vola≈• displayClubs() tu, vol√° sa na z√°klade hashu pri inicializ√°cii alebo po submite
        // displayCreatedTeams(); // Nechceme vola≈• displayCreatedTeams() tu, vol√° sa na z√°klade hashu pri inicializ√°cii alebo po submite


        // --- Spr√°va mod√°lov (otv√°ranie/zatv√°ranie) ---

        // Funkcia na otvorenie mod√°lu kateg√≥ri√≠ (pou≈æ√≠va sa pri + a √öprava kateg√≥rie)
        async function openCategoryModal(categoryId = null, categoryData = null) {
            console.log('DEBUG: openCategoryModal called. categoryId:', categoryId, 'categoryData:', categoryData);
            if (!categoryForm) { console.error("FATAL ERROR: categoryForm not found!"); if (categoryModal) categoryModal.style.display = 'none'; return; }

            categoryForm.reset();
             if (!categorySubmitButton) { console.error("FATAL ERROR: categorySubmitButton not found!"); if (categoryModal) categoryModal.style.display = 'none'; return; }


            if (categoryId && categoryData) {
                // Re≈æim √∫pravy
                currentCategoryModalMode = 'edit';
                editingCategoryId = categoryId;
                categoryNameInput.value = categoryData.name || categoryId; // N√°zov je ID dokumentu
                categorySubmitButton.textContent = 'Ulo≈æi≈• zmeny';
            } else {
                // Re≈æim pridania
                currentCategoryModalMode = 'add';
                editingCategoryId = null;
                categorySubmitButton.textContent = 'Prida≈•';
            }

            if (categoryModal) categoryModal.style.display = 'block';
             // Nastavenie focusu po kr√°tkej pauze
             setTimeout(() => {
                  if (categoryNameInput) categoryNameInput.focus();
             }, 50);
        }

        // Funkcia na otvorenie mod√°lu skupiny (pou≈æ√≠va sa pri + a √öprava skupiny)
        async function openGroupModal(groupId = null, groupData = null) { // groupId je ID dokumentu skupiny
            console.log('DEBUG: openGroupModal called. groupId:', groupId, 'groupData:', groupData);
            if (!groupForm) { console.error("FATAL ERROR: groupForm not found!"); if (groupModal) groupModal.style.display = 'none'; return; }

            groupForm.reset();
             if (!groupSubmitButton) { console.error("FATAL ERROR: groupSubmitButton not found!"); if (groupModal) groupModal.style.display = 'none'; return; }
             if (!groupCategorySelect) { console.error("FATAL ERROR: groupCategorySelect not found!"); if (groupModal) groupModal.style.display = 'none'; return; }


            // Napln√≠me select kateg√≥ri√≠ pred zobrazen√≠m mod√°lu
            await populateCategorySelect(groupCategorySelect, true); // Napln√≠ select kateg√≥ri√≠, vr√°tane placeholderu

            if (groupId && groupData) {
                // Re≈æim √∫pravy
                currentGroupModalMode = 'edit';
                editingGroupId = groupId;
                groupNameInput.value = groupData.name || groupId; // N√°zov je ID dokumentu
                groupSubmitButton.textContent = 'Ulo≈æi≈• zmeny';

                // Nastav√≠me vybran√∫ kateg√≥riu podƒæa d√°t skupiny
                groupCategorySelect.value = groupData.categoryId || '';
                // V re≈æime √∫pravy by sa kateg√≥ria skupiny nemala meni≈•, tak≈æe zablokujeme select
                 groupCategorySelect.disabled = true;


            } else {
                // Re≈æim pridania
                currentGroupModalMode = 'add';
                editingGroupId = null;
                groupNameInput.value = '';
                groupSubmitButton.textContent = 'Prida≈•';
                // V re≈æime pridania je category select povolen√Ω
                 groupCategorySelect.disabled = false;
                // Predvolene je vybran√Ω placeholder
                 groupCategorySelect.value = '';
            }

            if (groupModal) groupModal.style.display = 'block';
             // Nastavenie focusu
             setTimeout(() => {
                  if (groupNameInput) groupNameInput.focus();
             }, 50);
        }


        // Funkcia na otvorenie mod√°lu klubu (pre priradenie do skup√≠n ALEBO √∫pravu priraden√©ho/nepriraden√©ho)
             async function openClubModal(clubId = null, clubData = null) {
                 console.log('DEBUG: openClubModal called. clubId:', clubId, 'clubData:', clubData);

                 if (!clubForm) { console.error("FATAL ERROR: clubForm not found!"); if (clubModal) clubModal.style.display = 'none'; return; }
                 clubForm.reset();
                 const clubFormSubmitButton = clubForm.querySelector('button[type="submit"]');
                 if (!clubFormSubmitButton) { console.error("FATAL ERROR: Submit button not found in clubForm!"); if (clubModal) clubModal.style.display = 'none'; return; }


                  // Reset visibility of name input vs select and order input
                  unassignedClubSelectContainer.style.display = 'block';
                  clubNameInputContainer.style.display = 'none';
                  orderInputContainer.style.display = 'none';


                  // Reset group select visibility and disabled state
                  clubGroupSelect.parentElement.style.display = 'block';
                  clubGroupSelect.disabled = true; // Zablokuje select skup√≠n predvolene


                  // === NASTAVENIE POƒåIATOƒåN√âHO STAVU SELECTOV PRI OTVOREN√ç ===
                  // Kateg√≥rie sa naplnia hneƒè, ale ich stav (disabled) z√°vis√≠ od re≈æimu. Skupiny s√∫ v≈ædy zablokovan√© na zaƒçiatku.
                   await populateCategorySelect(clubCategorySelect, true); // Napln√≠ kateg√≥rie, vr√°tane placeholderu


                  if (clubId && clubData) {
                     // Edit mode (√öprava existuj√∫ceho klubu)
                     currentClubModalMode = 'edit';
                     editingClubId = clubId;

                      // V edit m√≥de je category select povolen√Ω a hodnota nastaven√°
                      if (clubCategorySelect) {
                           clubCategorySelect.disabled = false; // Povoli≈• category select v edit m√≥de
                           clubCategorySelect.value = clubData.categoryId || ''; // Nastavi≈• hodnotu
                            // N√°sledne sa vol√° populateGroupSelect, ktor√Ω sprav√≠ disable/enable group select
                             // Ak t√≠m nie je priraden√Ω k skupine (groupId === null), skryjeme aj select skup√≠n
                            if (clubData.groupId === null) {
                                 clubGroupSelect.parentElement.style.display = 'none'; // Skry skupinu
                                  orderInputContainer.style.display = 'none'; // Skry poradie
                                   orderInGroupInput.required = false;
                            } else {
                                 clubGroupSelect.parentElement.style.display = 'block';
                                 orderInputContainer.style.display = 'block';
                                 orderInGroupInput.required = true;
                            }
                            // Napln√≠ skupiny na z√°klade nastavenej kateg√≥rie. Disable/Enable group select rie≈°i populateGroupSelect.
                            await populateGroupSelect(clubCategorySelect.value, clubGroupSelect, clubData.groupId);

                      } else { console.error("FATAL ERROR: clubCategorySelect not found in edit mode!"); if (clubModal) clubModal.style.display = 'none'; return; }


                      // Zobraz√≠ input pre n√°zov a nastav√≠ jeho hodnotu
                      clubNameInputContainer.style.display = 'block';
                      unassignedClubSelectContainer.style.display = 'none'; // Skry select nepriraden√Ωch v edit m√≥de
                      clubNameInput.value = clubData.name || '';
                       orderInGroupInput.value = typeof clubData.orderInGroup === 'number' ? clubData.orderInGroup : '';


                     if (!clubModalTitle) { console.error('FATAL ERROR: clubModalTitle is null in edit mode!'); if (clubModal) clubModal.style.display = 'none'; return; }
                     clubModalTitle.textContent = 'Upravi≈• t√≠m';
                     clubFormSubmitButton.textContent = 'Ulo≈æi≈• zmeny';


                  } else { // Add mode (Priradenie UNASSIGNED klubu do skupiny)
                     currentClubModalMode = 'add-assign';
                     editingClubId = null;

                     // V add-assign m√≥de zobrazujeme select pre v√Ωber nepriraden√©ho klubu
                     unassignedClubSelectContainer.style.display = 'block';
                     clubNameInputContainer.style.display = 'none'; // Input n√°zvu je skryt√Ω
                     orderInputContainer.style.display = 'none'; // Poradie je skryt√©
                      orderInGroupInput.required = false;

                      // Category select je u≈æ naplnen√Ω z √∫vodu funkcie, ale ZOST√ÅVA ZABLOKOVAN√ù
                      if (clubCategorySelect) {
                           clubCategorySelect.disabled = true; // !!! Zablokova≈• category select na zaƒçiatku add-assign !!!
                           clubCategorySelect.value = ''; // Reset hodnoty na placeholder
                      } else { console.error("FATAL ERROR: clubCategorySelect not found in add mode!"); if (clubModal) clubModal.style.display = 'none'; return; }

                     // Skupinov√Ω select je zobrazen√Ω, ale zablokovan√Ω
                     clubGroupSelect.parentElement.style.display = 'block';
                     clubGroupSelect.disabled = true;


                     // Napln√≠ select nepriraden√Ωch klubov (m√¥≈æe spusti≈• 'change' ak je predvolen√° hodnota)
                     await populateUnassignedClubsSelect(unassignedClubSelect);


                     if (!clubModalTitle) { console.error('FATAL ERROR: clubModalTitle is null in add mode!'); if (clubModal) clubModal.style.display = 'none'; return; }
                     clubModalTitle.textContent = 'Priradi≈• t√≠m do skupiny';
                     clubFormSubmitButton.textContent = 'Priradi≈•';
                  }

                  // Reset any previous validation messages (spoloƒçn√© pre oba re≈æimy)
                  const validationMessages = clubForm.querySelectorAll('.validation-message');
                  validationMessages.forEach(msg => msg.textContent = '');

                  // Zobraz mod√°l a≈æ po nastaven√≠ obsahu
                  clubModal.style.display = 'block';

                  // Set focus to the first relevant input/select
                   if (currentClubModalMode === 'add-assign' && unassignedClubSelect) {
                       unassignedClubSelect.focus();
                   } else if (currentClubModalMode === 'edit' && clubNameInput) {
                       clubNameInput.focus();
                   } else if (clubCategorySelect && !clubCategorySelect.disabled) { // Fallback focus (len ak nie je zablokovan√Ω)
                       clubCategorySelect.focus();
                   } else {
                        console.warn("Could not set focus in club modal.");
                   }
             } // Koniec openClubModal


        // Funkcia na otvorenie mod√°lu hromadn√©ho vytv√°rania t√≠mov (z sekcie #zoznam-timov)
        async function openTeamCreationModal() {
             console.log('DEBUG: openTeamCreationModal called.');
             if (!teamCreationModal) { console.error("FATAL ERROR: teamCreationModal not found!"); return; }
             if (!teamCreationForm) { console.error("FATAL ERROR: teamCreationForm not found!"); if (teamCreationModal) teamCreationModal.style.display = 'none'; return; }
             if (!teamCategoryCountContainer) { console.error("FATAL ERROR: teamCategoryCountContainer not found!"); if (teamCreationModal) teamCreationModal.style.display = 'none'; return; }


             // Reset formul√°ra
             teamCreationForm.reset();
             // Vyma≈æ v≈°etky dynamicky pridan√© dvojice kateg√≥ria/poƒçet
             teamCategoryCountContainer.innerHTML = '';

             // Zabezpeƒçi≈•, ≈æe kateg√≥rie s√∫ naƒç√≠tan√© pred pridan√≠m prvej dvojice
             if (allAvailableCategories.length === 0) {
                  await loadAllCategoriesForDynamicSelects(); // Naƒç√≠taj kateg√≥rie ak e≈°te nie s√∫
             }

             // Pridaj prv√∫ dvojicu kateg√≥ria/poƒçet automaticky
             await addCategoryCountPair(); // T√°to funkcia vol√° updateDynamicCategorySelects()


             if (teamCreationModal) teamCreationModal.style.display = 'block';
             // Nastav focus na n√°zov t√≠mu
             setTimeout(() => {
                  if (teamNameInput) teamNameInput.focus();
             }, 50);
        }

        // Funkcia na otvorenie mod√°lu spr√°vy jednotliv√Ωch t√≠mov (v sekcii #zoznam-timov, kliknut√≠m na z√°kladn√Ω n√°zov)
        async function openManageTeamsModal(baseTeamName, categoryId) {
            console.log('DEBUG: openManageTeamsModal called for baseName:', baseTeamName, 'categoryId:', categoryId);
             if (!manageTeamsModal) { console.error("FATAL ERROR: manageTeamsModal not found!"); return; }
             if (!manageTeamsContent) { console.error("FATAL ERROR: manageTeamsContent not found!"); if (manageTeamsModal) manageTeamsModal.style.display = 'none'; return; }


            // Vyƒçisti obsah mod√°lu
            manageTeamsContent.innerHTML = '<h3>Spr√°va t√≠mov: ' + baseTeamName + ' (' + categoryId + ')</h3>';
             const teamsListDiv = document.createElement('div'); // Kontajner pre zoznam t√≠mov
             teamsListDiv.classList.add('manage-teams-list'); // Trieda pre ≈°t√Ωlovanie


            try {
                 // Naƒç√≠taj t√≠my, ktor√© zodpovedaj√∫ z√°kladn√©mu n√°zvu a kateg√≥rii
                 // Predpoklad√°me, ≈æe "Z√°kladn√Ω n√°zov" + "Suffix" tvor√≠ cel√Ω n√°zov t√≠mu
                 // Toto je komplexn√©, ak nem√°me v DB ulo≈æen√Ω aj "baseName" a "suffix" samostatne.
                 // Pou≈æijeme query na z√°klade cel√©ho n√°zvu a kateg√≥rie, alebo sk√∫sime query podƒæa ID ak m√° form√°t "Kateg√≥ria - Z√°kladn√Ω N√°zov [Suffix]"
                 // Najspoƒæahlivej≈°ie je query podƒæa categoryId a pok√∫si≈• sa filtrova≈• n√°zvy na strane klienta, alebo ma≈• baseName ako pole v DB.
                 // Ak ID dokumentu je "Kateg√≥ria - Cel√Ω N√°zov", m√¥≈æeme filtrova≈• podƒæa prefixu ID.
                 // Sk√∫sme filtrova≈• podƒæa categoryId a n√°zvu zaƒç√≠naj√∫ceho na baseTeamName.

                 const teamsQuery = query(clubsCollectionRef,
                      where('categoryId', '==', categoryId)
                      // Ak m√°me pole 'baseName' v DB, mohli by sme pou≈æi≈•:
                      // where('baseName', '==', baseTeamName)
                     // Ak nem√°me baseName v DB, mus√≠me naƒç√≠ta≈• v≈°etky v kateg√≥rii a filtrova≈• n√°zov na strane klienta
                 );
                 const querySnapshot = await getDocs(teamsQuery);

                 if (querySnapshot.empty) {
                      teamsListDiv.textContent = '≈Ωiadne t√≠my n√°jden√© pre toto zoskupenie.';
                       console.warn("No teams found for managing under baseName/category.");
                 } else {
                      const teams = querySnapshot.docs
                          .map(doc => ({ id: doc.id, ...doc.data() }))
                           // Filter na strane klienta podƒæa n√°zvu zaƒç√≠naj√∫ceho na baseTeamName (ak nem√°me baseName v DB)
                           .filter(team => (team.name || '').startsWith(baseTeamName));


                       if (teams.length === 0) {
                            teamsListDiv.textContent = '≈Ωiadne t√≠my n√°jden√© s t√Ωmto z√°kladn√Ωm n√°zvom v kateg√≥rii.';
                             console.warn("No teams found after client-side filtering.");
                       } else {
                           console.log(`DEBUG: Found ${teams.length} teams for managing.`);
                            // Zoradi≈• t√≠my v r√°mci zoznamu (napr. podƒæa n√°zvu/suffixu)
                            teams.sort((a, b) => (a.name || '').localeCompare(b.name || ''));

                            const teamList = document.createElement('ul'); // Zoznam pre jednotliv√© t√≠my
                             teamList.classList.add('manage-teams-ul');

                            teams.forEach(team => {
                                 const listItem = document.createElement('li');
                                  listItem.classList.add('manage-teams-li'); // Trieda pre ≈°t√Ωlovanie

                                 const teamNameSpan = document.createElement('span');
                                  teamNameSpan.textContent = team.name || 'Bez n√°zvu';
                                  listItem.appendChild(teamNameSpan);

                                 // Pridaj inform√°ciu o priraden√≠ do skupiny a porad√≠
                                  const assignmentInfo = document.createElement('span');
                                  assignmentInfo.classList.add('assignment-info');
                                  assignmentInfo.textContent = team.groupId ? ` (Skupina: ${team.groupId}, Poradie: ${typeof team.orderInGroup === 'number' ? team.orderInGroup : '-'})` : ' (Nepriraden√Ω)';
                                  listItem.appendChild(assignmentInfo);


                                 // Pridaj tlaƒçidl√° akci√≠ pre jednotliv√© t√≠my
                                  const actionsDiv = document.createElement('div');
                                   actionsDiv.classList.add('manage-team-actions'); // Trieda pre tlaƒçidl√°

                                 // Tlaƒçidlo √öprava (otvor√≠ clubModal v edit m√≥de)
                                  const editButton = document.createElement('button');
                                  editButton.textContent = 'Upravi≈•';
                                  editButton.addEventListener('click', () => {
                                       // Otvor modal na √∫pravu tohto konkr√©tneho t√≠mu
                                       // team.id je document.id, team s√∫ naƒç√≠tan√© d√°ta
                                       openClubModal(team.id, team);
                                        // Po otvoren√≠ in√©ho mod√°lu zatvor√≠me tento manageTeamsModal
                                        if (manageTeamsModal) manageTeamsModal.style.display = 'none';
                                  });
                                  actionsDiv.appendChild(editButton);

                                 // Tlaƒçidlo Zmaza≈•
                                  const deleteButton = document.createElement('button');
                                  deleteButton.textContent = 'Zmaza≈•';
                                   deleteButton.classList.add('delete-button');
                                  deleteButton.addEventListener('click', async () => {
                                       if (confirm(`Naozaj chcete zmaza≈• t√≠m "${team.name}"?`)) {
                                            try {
                                                 await deleteDoc(doc(clubsCollectionRef, team.id));
                                                 alert('T√≠m √∫spe≈°ne zmazan√Ω.');
                                                 // Po zmazan√≠ obnov mod√°ly a tabuƒæky, ktor√© sa mohli zmeni≈•
                                                 // Znovu naƒç√≠ta≈• Manage Teams modal (ak zoskupenie st√°le existuje)
                                                  // Ak bol posledn√Ω t√≠m v zoskupen√≠, zoskupenie zmizne
                                                 // Najbezpeƒçnej≈°ie je zatvori≈• tento modal a obnovi≈• hlavn√Ω zoznam
                                                  if (manageTeamsModal) manageTeamsModal.style.display = 'none';
                                                  displayCreatedTeams(); // Obnov√≠ zoznam v≈°etk√Ωch t√≠mov
                                                  // Ak bol t√≠m priraden√Ω, treba obnovi≈• aj tabuƒæku priraden√Ωch t√≠mov
                                                  if (team.groupId) {
                                                       if (window.location.hash === '#timy-do-skupin') {
                                                            displayClubs(); // Obnov tabuƒæku priraden√Ωch, ak je viditeƒæn√°
                                                       }
                                                  }
                                                   // Ak bol nepriraden√Ω, treba obnovi≈• zoznam nepriraden√Ωch v club mod√°li
                                                   if (!team.groupId) {
                                                        if (unassignedClubSelect) populateUnassignedClubsSelect(unassignedClubSelect, null);
                                                   }

                                            } catch (error) {
                                                 console.error('Chyba pri mazan√≠ t√≠mu: ', error);
                                                 alert('Chyba pri mazan√≠ t√≠mu.');
                                            }
                                       }
                                  });
                                   actionsDiv.appendChild(deleteButton);

                                  // Tlaƒçidlo "Presun√∫≈• do nepriraden√Ωch" (len ak je priraden√Ω)
                                   if (team.groupId) {
                                        const unassignButton = document.createElement('button');
                                        unassignButton.textContent = 'Nepriradi≈•';
                                         unassignButton.classList.add('unassign-button');
                                        unassignButton.addEventListener('click', async () => {
                                             if (confirm(`Naozaj chcete t√≠m "${team.name}" odpriradi≈• zo skupiny "${team.groupId}"?`)) {
                                                  try {
                                                       await updateDoc(doc(clubsCollectionRef, team.id), {
                                                            groupId: null,
                                                            orderInGroup: null
                                                       });
                                                       alert('T√≠m √∫spe≈°ne odpriraden√Ω.');
                                                       // Po odpriraden√≠ obnov mod√°ly a tabuƒæky
                                                       // Znovu naƒç√≠ta≈• Manage Teams modal (zobraz√≠ t√≠m ako nepriraden√Ω)
                                                        // openManageTeamsModal(baseTeamName, categoryId); // Mohlo by by≈• rekurz√≠vne/zacykli≈•? Rad≈°ej len obnovi≈• hlavn√Ω zoznam
                                                        if (manageTeamsModal) manageTeamsModal.style.display = 'none'; // Zatvori≈• tento modal
                                                        displayCreatedTeams(); // Obnov√≠ zoznam v≈°etk√Ωch t√≠mov
                                                        // Ak bol t√≠m priraden√Ω, treba obnovi≈• aj tabuƒæku priraden√Ωch t√≠mov
                                                        if (window.location.hash === '#timy-do-skupin') {
                                                             displayClubs(); // Obnov tabuƒæku priraden√Ωch, ak je viditeƒæn√°
                                                        }
                                                        // Obnovi≈• zoznam nepriraden√Ωch v club mod√°li
                                                        if (unassignedClubSelect) populateUnassignedClubsSelect(unassignedClubSelect, null);


                                                  } catch (error) {
                                                       console.error('Chyba pri odpriraden√≠ t√≠mu: ', error);
                                                       alert('Chyba pri odpriraden√≠ t√≠mu.');
                                                  }
                                             }
                                        });
                                        actionsDiv.appendChild(unassignButton);
                                   }

                                  listItem.appendChild(actionsDiv); // Pridaj div s tlaƒçidlami do li
                                 teamList.appendChild(listItem); // Pridaj li do ul
                            });

                            teamsListDiv.appendChild(teamList); // Pridaj zoznam do kontajnera
                       }
                   }
            } catch (error) {
                 console.error('Chyba pri naƒç√≠tan√≠ t√≠mov na spr√°vu: ', error);
                 teamsListDiv.textContent = 'Chyba pri naƒç√≠tan√≠ d√°t.';
            }


             manageTeamsContent.appendChild(teamsListDiv); // Pridaj kontajner zoznamu do mod√°lu

             // Zobraz mod√°l
             manageTeamsModal.style.display = 'block';
        }


        // --- Spr√°va mod√°lov (zatv√°ranie) ---

        // Funkcia na zatvorenie mod√°lu (spoloƒçn√°)
         function closeModal(modal) {
              if (modal) {
                   modal.style.display = 'none';
                   // Optional: Reset form associated with the modal if needed
                   // if (modal.id === 'categoryModal' && categoryForm) categoryForm.reset();
                   // if (modal.id === 'groupModal' && groupForm) groupForm.reset();
                   // if (modal.id === 'clubModal' && clubForm) clubForm.reset(); // Form is reset in submit handler
                   // if (modal.id === 'teamCreationModal' && teamCreationForm) { teamCreationForm.reset(); teamCategoryCountContainer.innerHTML = ''; }
                   // if (modal.id === 'manageTeamsModal' && manageTeamsContent) manageTeamsContent.innerHTML = '';
              }
         }


        // Pridanie posluch√°ƒçov na zatv√°ranie mod√°lov
        if (categoryModalCloseBtn && categoryModal) { categoryModalCloseBtn.addEventListener('click', () => closeModal(categoryModal)); }
        if (groupModalCloseBtn && groupModal) { groupModalCloseBtn.addEventListener('click', () => closeModal(groupModal)); }
        if (clubModalCloseBtn && clubModal) { clubModalCloseBtn.addEventListener('click', () => closeModal(clubModal)); }
        if (teamCreationModalCloseBtn && teamCreationModal) { teamCreationModalCloseBtn.addEventListener('click', () => closeModal(teamCreationModal)); }
        if (manageTeamsModalCloseBtn && manageTeamsModal) { manageTeamsModalCloseBtn.addEventListener('click', () => closeModal(manageTeamsModal)); }


        // Zatvorenie mod√°lu kliknut√≠m mimo neho (spoloƒçn√© pre v≈°etky mod√°ly s triedou .modal)
        window.addEventListener('click', (event) => {
            if (event.target.classList.contains('modal')) {
                closeModal(event.target);
            }
        });


        // --- Event Listeners pre tlaƒçidl√° a formul√°re ---

        // Listener pre tlaƒçidlo "+" v r√¥znych sekci√°ch (pou≈æije sa class="add-button")
        const addButton = document.querySelector('.add-button');
        if (addButton) {
            addButton.addEventListener('click', () => {
                const currentHash = window.location.hash;
                if (currentHash === '#kategorie') {
                    openCategoryModal();
                } else if (currentHash === '#skupiny') {
                    openGroupModal();
                } else if (currentHash === '#timy-do-skupin') {
                     // Otvori≈• club modal v re≈æime priradenia (Add/Assign)
                     openClubModal(); // Vol√° sa bez argumentov pre re≈æim priradenia
                } else if (currentHash === '#zoznam-timov') {
                     // Otvori≈• modal na vytv√°ranie t√≠mov
                     openTeamCreationModal();
                }
                // Pridaj ƒèal≈°ie podmienky pre in√© sekcie
            });
        } else { console.error("Add button not found!"); }


        // --- Event Listener pre zmenu kateg√≥rie v mod√°li klubu ---
             if (clubCategorySelect) {
                console.log("Attaching clubCategorySelect change listener");
                clubCategorySelect.addEventListener('change', async () => {
                     console.log("clubCategorySelect change event fired");
                    const selectedCategoryId = clubCategorySelect.value;

                    // Reset order input when category changes (applies to both add-assign and edit)
                     if (orderInGroupInput) orderInGroupInput.value = '';
                     if (orderInputContainer) orderInputContainer.style.display = 'none'; // Skryjeme poradie k√Ωm sa nevyberie skupina
                     if (orderInGroupInput) orderInGroupInput.required = false; // Poradie nie je povinn√©

                    // Populate the group select based on the newly selected category
                     // Len ak je vybran√° platn√° kateg√≥ria a select skup√≠n je viditeƒæn√Ω
                     if (selectedCategoryId && selectedCategoryId !== '' && selectedCategoryId !== '-- Vyberte kateg√≥riu --' &&
                         clubGroupSelect && clubGroupSelect.parentElement && clubGroupSelect.parentElement.style.display !== 'none') {

                           clubGroupSelect.disabled = true; // Zablokuj select skup√≠n poƒças naƒç√≠tania
                           await populateGroupSelect(selectedCategoryId, clubGroupSelect); // Pass category ID and select element
                           clubGroupSelect.disabled = false; // Povol select skup√≠n po naƒç√≠tan√≠

                           // Ak po naplnen√≠ nie s√∫ v kateg√≥rii ≈æiadne skupiny, zablokuj ho √∫plne a zobraz spr√°vu
                           if (clubGroupSelect.options.length <= 1) { // Contains only the placeholder option
                                clubGroupSelect.disabled = true;
                                clubGroupSelect.innerHTML = '<option value="">-- ≈Ωiadne skupiny v kateg√≥rii --</option>';
                                console.warn(`No groups found for category: ${selectedCategoryId}`);
                           }

                     } else {
                          // Ak sa vybrala neplatn√° kateg√≥ria (placeholder) alebo select skup√≠n nie je viditeƒæn√Ω,
                          // vypr√°zdnime a zablokujeme select skup√≠n
                           if (clubGroupSelect) {
                                clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kateg√≥riu --</option>'; // Reset na poƒçiatoƒçn√Ω stav
                                clubGroupSelect.disabled = true;
                           }
                     }
                });
            } else { console.error("Club category select not found!"); }


             // Event listener pre zmenu skupiny v mod√°li klubu - mana≈æuje pole poradia
             if (clubGroupSelect) {
                 console.log("Attaching clubGroupSelect change listener");
                 clubGroupSelect.addEventListener('change', () => {
                      console.log("clubGroupSelect change event fired");
                      const selectedGroupId = clubGroupSelect.value;
                      // Show/hide order input and set required based on whether a group is selected
                      if (selectedGroupId && selectedGroupId !== '' && selectedGroupId !== '-- Vyberte skupinu --' && selectedGroupId !== '-- ≈Ωiadne skupiny v kateg√≥rii --') {
                           if (orderInputContainer) orderInputContainer.style.display = 'block';
                           if (orderInGroupInput) orderInGroupInput.required = true; // Order is required when a group is selected
                           // Automaticky nastav√≠me focus na pole poradia po v√Ωbere skupiny
                            if (orderInGroupInput) orderInGroupInput.focus();
                      } else {
                           if (orderInputContainer) orderInputContainer.style.display = 'none';
                           if (orderInGroupInput) orderInGroupInput.required = false;
                           if (orderInGroupInput) orderInGroupInput.value = ''; // Clear value when group is deselected
                      }
                 });
             } else { console.error("Club group select not found!"); }


             // Event listener pre zmenu nepriraden√©ho t√≠mu (Vyberte existuj√∫ci t√≠m)
             if (unassignedClubSelect) {
                 console.log("Attaching unassignedClubSelect change listener");
                 unassignedClubSelect.addEventListener('change', async () => {
                      console.log("unassignedClubSelect change event fired");
                      const selectedClubId = unassignedClubSelect.value;

                      // === LOGIKA PO V√ùBERE NEPRIRADEN√âHO T√çMU ===
                      if (currentClubModalMode === 'add-assign' && selectedClubId && selectedClubId !== '-- Vyberte t√≠m na priradenie --') {
                           try {
                               const clubDoc = await getDoc(doc(clubsCollectionRef, selectedClubId));
                               if (clubDoc.exists()) {
                                   const clubData = clubDoc.data();
                                   if (clubCategorySelect) {
                                       // Povol√≠me category select a nastav√≠me hodnotu
                                        clubCategorySelect.disabled = false; // !!! Povoli≈• category select po v√Ωbere t√≠mu !!!
                                        clubCategorySelect.value = clubData.categoryId || '';
                                        console.log("unassignedClubSelect change: Nastaven√° hodnota clubCategorySelect na:", clubCategorySelect.value);

                                        // Spust√≠me change udalos≈• na clubCategorySelect, aby sa spustil jeho posluch√°ƒç a naplnil skupiny
                                        const event = new Event('change');
                                        clubCategorySelect.dispatchEvent(event);
                                        console.log("unassignedClubSelect change: Spusten√Ω dispatchEvent na clubCategorySelect");

                                        // Nastav√≠me focus na select skupiny (ak je povolen√Ω po naplnen√≠)
                                         setTimeout(() => {
                                              if (clubGroupSelect && clubGroupSelect.parentElement && clubGroupSelect.parentElement.style.display !== 'none' && !clubGroupSelect.disabled) {
                                                   clubGroupSelect.focus();
                                              } // Ak nie je skupina, focus zostane na category selecte alebo p√¥jde na ƒèal≈°ie pole
                                         }, 0);


                                   } else { console.error("clubCategorySelect not found after selecting unassigned club."); }

                               } else {
                                    console.warn(`Vybran√Ω nepriraden√Ω t√≠m ${selectedClubId} u≈æ neexistuje.`);
                                    // Reset selects if the selected team is no longer found
                                    unassignedClubSelect.value = "";
                                    // Zablokova≈• a resetova≈• category select
                                    if (clubCategorySelect) { clubCategorySelect.disabled = true; clubCategorySelect.value = ""; } // !!! Zablokova≈• a resetova≈• !!!
                                     // Spust√≠me change event na kateg√≥rii, aby sa resetovali skupiny a poradie
                                     const event = new Event('change');
                                     if (clubCategorySelect) clubCategorySelect.dispatchEvent(event);
                                }
                            } catch (error) {
                               console.error('Chyba pri naƒç√≠tan√≠ detailov vybran√©ho nepriraden√©ho t√≠mu:', error);
                               alert('Chyba pri naƒç√≠tan√≠ detailov t√≠mu.');
                               unassignedClubSelect.value = "";
                               // Zablokova≈• a resetova≈• category select aj pri chybe
                               if (clubCategorySelect) { clubCategorySelect.disabled = true; clubCategorySelect.value = ""; } // !!! Zablokova≈• a resetova≈• !!!
                                // Spust√≠me change event na kateg√≥rii aj pri chybe
                                 const event = new Event('change');
                                 if (clubCategorySelect) clubCategorySelect.dispatchEvent(event);
                            }
                       } else if (currentClubModalMode === 'add-assign' && (!selectedClubId || selectedClubId === '-- Vyberte t√≠m na priradenie --')) {
                           console.log("Unassigned club select reset or placeholder selected.");
                           // Ak sa vybral placeholder, zablokova≈• a resetova≈• category select
                           if (clubCategorySelect) { clubCategorySelect.disabled = true; clubCategorySelect.value = ""; } // !!! Zablokova≈• a resetova≈• !!!
                            // Spust√≠me change event na kateg√≥rii, aby sa resetovali skupiny a poradie
                            const event = new Event('change');
                            if (clubCategorySelect) clubCategorySelect.dispatchEvent(event);
                       }
                 });
             } else { console.error("Unassigned club select not found!"); }


            // --- Obsluha formul√°ra Kluby (clubForm submit) ---
            if (clubForm) {
                clubForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    console.log("DEBUG: clubForm submit event fired."); // Log

                    const selectedCategoryId = clubCategorySelect.value;
                    const selectedGroupId = (clubGroupSelect && !clubGroupSelect.disabled && clubGroupSelect.value !== '' && clubGroupSelect.value !== '-- Vyberte skupinu --' && clubGroupSelect.value !== '-- ≈Ωiadne skupiny v kateg√≥rii --') ? clubGroupSelect.value : null;
                    const orderInGroupValue = parseInt(orderInGroupInput && orderInGroupInput.value, 10);
                     const orderInGroup = (selectedGroupId !== null && orderInputContainer && orderInputContainer.style.display !== 'none' && orderInGroupInput && orderInGroupInput.value.trim() !== '' && !isNaN(orderInGroupValue) && orderInGroupValue >= 1) ? orderInGroupValue : null;


                    // Validate selects based on mode and visibility
                    // Kateg√≥ria je povinn√° len ak nie je zablokovan√°
                    if (clubCategorySelect && !clubCategorySelect.disabled && (selectedCategoryId === '' || selectedCategoryId === '-- Vyberte kateg√≥riu --')) {
                        alert('Pros√≠m, vyberte platn√∫ kateg√≥riu.');
                        console.log("DEBUG: Validation failed: Invalid category.");
                        return;
                    }
                     // Skupina je povinn√° len ak je select skupiny viditeƒæn√Ω a povolen√Ω
                    if (clubGroupSelect && clubGroupSelect.parentElement && clubGroupSelect.parentElement.style.display !== 'none' && clubGroupSelect.disabled === false && selectedGroupId === null) {
                         alert('Pros√≠m, vyberte platn√∫ skupinu.');
                         console.log("DEBUG: Validation failed: Invalid group.");
                         return;
                     }
                    // Poradie je povinn√© len ak je pole poradia viditeƒæn√©
                     if (orderInputContainer && orderInputContainer.style.display !== 'none' && orderInGroup === null) {
                          alert('Pros√≠m, zadajte platn√© poradov√© ƒç√≠slo v√§ƒç≈°ie ako 0.');
                          console.log("DEBUG: Validation failed: Invalid order.");
                          return;
                     }

                     // Dodatoƒçn√° kontrola: V add-assign m√≥de mus√≠ by≈• vybran√Ω aj t√≠m na priradenie
                     if (currentClubModalMode === 'add-assign') {
                         const selectedUnassignedClubId = unassignedClubSelect && unassignedClubSelect.value;
                         if (!selectedUnassignedClubId || selectedUnassignedClubId === '-- Vyberte t√≠m na priradenie --') {
                             alert('Pros√≠m, vyberte t√≠m na priradenie.');
                             console.log("DEBUG: Validation failed: No unassigned team selected in add-assign mode.");
                             return;
                         }
                          // V add-assign m√≥de musia by≈• vybran√© aj kateg√≥ria a skupina (u≈æ o≈°etren√© vy≈°≈°ie, ale pre istotu)
                          if (selectedCategoryId === '' || selectedGroupId === null) {
                               // T√°to kontrola by sa nemala spusti≈•, ak predo≈°l√© pre≈°li, ale pre istotu
                               alert('Pros√≠m, vyberte kateg√≥riu aj skupinu pre priradenie.');
                               console.log("DEBUG: Validation failed: Category or group missing in add-assign mode.");
                               return;
                          }
                     }


                    try {
                         console.log("DEBUG: Validation successful. Proceeding with submit logic.");
                        if (currentClubModalMode === 'add-assign') {
                            // === LOGIKA PRIRADENIA T√çMU DO SKUPINY ===
                             const selectedUnassignedClubId = unassignedClubSelect.value; // U≈æ vieme, ≈æe nie je placeholder

                            const clubRefToAssign = doc(clubsCollectionRef, selectedUnassignedClubId);
                            const clubDocToAssign = await getDoc(clubRefToAssign);

                            if (!clubDocToAssign.exists()) { alert('Vybran√Ω t√≠m nebol n√°jden√Ω alebo u≈æ bol priraden√Ω/zmazan√Ω.'); console.log("DEBUG: Team to assign not found."); if (unassignedClubSelect) populateUnassignedClubsSelect(unassignedClubSelect, null); if (clubModal) closeModal(clubModal); if (clubForm) clubForm.reset(); currentClubModalMode = 'add-assign'; editingClubId = null; if (unassignedClubSelectContainer) unassignedClubSelectContainer.style.display = 'block'; if (clubNameInputContainer) clubNameInputContainer.style.display = 'none'; if (clubCategorySelect) { clubCategorySelect.disabled = true; clubCategorySelect.value = ''; } if (clubGroupSelect && clubGroupSelect.parentElement) clubGroupSelect.parentElement.style.display = 'block'; if (clubGroupSelect) { clubGroupSelect.disabled = true; clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kateg√≥riu --</option>'; } if (orderInputContainer) orderInputContainer.style.display = 'none'; if (orderInGroupInput) orderInGroupInput.required = false; return; }
                            const clubDataToAssign = clubDocToAssign.data();

                            if (clubDataToAssign.groupId !== null) { alert(`T√≠m "${clubDataToAssign.name}" je u≈æ priraden√Ω do skupiny "${clubDataToAssign.groupId}".`); console.log("DEBUG: Team already assigned."); if (unassignedClubSelect) populateUnassignedClubsSelect(unassignedClubSelect, null); if (clubModal) closeModal(clubModal); if (clubForm) clubForm.reset(); currentClubModalMode = 'add-assign'; editingClubId = null; if (unassignedClubSelectContainer) unassignedClubSelectContainer.style.display = 'block'; if (clubNameInputContainer) clubNameInputContainer.style.display = 'none'; if (clubCategorySelect) { clubCategorySelect.disabled = true; clubCategorySelect.value = ''; } if (clubGroupSelect && clubGroupSelect.parentElement) clubGroupSelect.parentElement.style.display = 'block'; if (clubGroupSelect) { clubGroupSelect.disabled = true; clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kateg√≥riu --</option>'; } if (orderInputContainer) orderInputContainer.style.display = 'none'; if (orderInGroupInput) orderInGroupInput.required = false; return; }

                            // --- DEFIN√çCIA NOV√ùCH D√ÅT A NOV√âHO CIEƒΩOV√âHO ID ---
                            const newCategoryId = selectedCategoryId;
                            const newName = clubDataToAssign.name;
                            const newGroupId = selectedGroupId;
                            const newOrderInGroup = orderInGroup;

                             const newDocumentId = `${newCategoryId} - ${newName}`;
                             const newClubDocRef = doc(clubsCollectionRef, newDocumentId);

                             // --- KONTROLA DUPLICITN√âHO PORADIA V CIEƒΩOVEJ SKUPINE ---
                            if (newGroupId !== null && newOrderInGroup !== null) {
                                 const targetDocSnapshotForOrderCheck = await getDoc(newClubDocRef);
                                  const existingOrderQuery = query(clubsCollectionRef, where('groupId', '==', newGroupId), where('orderInGroup', '==', newOrderInGroup), ...(targetDocSnapshotForOrderCheck.exists() ? [where('__name__', '!=', newDocumentId)] : []));
                                  const existingOrderSnapshot = await getDocs(existingOrderQuery);
                                  if (!existingOrderSnapshot.empty) { alert(`T√≠m s poradov√Ωm ƒç√≠slom "${newOrderInGroup}" u≈æ v skupine "${newGroupId}" existuje! Pros√≠m, zvoƒæte in√© poradov√© ƒç√≠slo.`); console.log("DEBUG: Duplicate order found in target group."); return; }
                            }

                            // --- Vykona≈• BATCH oper√°cie (mazanie star√©ho, vytv√°ranie/prep√≠sanie nov√©ho) ---
                             console.log("DEBUG: Starting batch write: delete old, set new.");
                            const batch = writeBatch(db);
                            batch.delete(clubRefToAssign);
                            batch.set(newClubDocRef, {
                                name: newName,
                                categoryId: newCategoryId,
                                groupId: newGroupId,
                                orderInGroup: newOrderInGroup
                            });

                            await batch.commit();
                            console.log("DEBUG: Batch commit successful.");

                            alert(`T√≠m "${newName}" √∫spe≈°ne priraden√Ω.`);


                        } else if (currentClubModalMode === 'edit') {
                            // === LOGIKA √öPRAVY EXISTUJ√öCEHO KLUBU ===
                             console.log("DEBUG: Edit mode logic.");

                            const clubIdToEdit = editingClubId;
                            const updatedClubName = clubNameInput && clubNameInput.value.trim();
                             const updatedCategoryId = selectedCategoryId;
                            const updatedGroupId = selectedGroupId;
                            const updatedOrderInGroup = orderInGroup;


                            if (!clubIdToEdit) { console.error("Chyba: Re≈æim √∫pravy klubu bez platn√©ho editingClubId."); alert("Chyba pri √∫prave klubu. Pros√≠m, obnovte str√°nku."); if (clubModal) closeModal(clubModal); if (clubForm) clubForm.reset(); currentClubModalMode = 'add-assign'; editingClubId = null; if (unassignedClubSelectContainer) unassignedClubSelectContainer.style.display = 'block'; if (clubNameInputContainer) clubNameInputContainer.style.display = 'none'; if (clubCategorySelect) { clubCategorySelect.disabled = true; clubCategorySelect.value = ''; } if (clubGroupSelect && clubGroupSelect.parentElement) clubGroupSelect.parentElement.style.display = 'block'; if (clubGroupSelect) { clubGroupSelect.disabled = true; clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kateg√≥riu --</option>'; } if (orderInputContainer) orderInputContainer.style.display = 'none'; if (orderInGroupInput) orderInGroupInput.required = false;} return; }
                             if (clubNameInputContainer.style.display !== 'none' && (!updatedClubName || updatedClubName === '')) { alert('N√°zov klubu nem√¥≈æe by≈• pr√°zdny.'); console.log("DEBUG: Validation failed: Name is empty in edit mode."); return; }

                            const clubRefToEdit = doc(clubsCollectionRef, clubIdToEdit);
                            const clubDocToEdit = await getDoc(clubRefToEdit);
                            if (!clubDocToEdit.exists()) { console.error(`Chyba: Dokument klubu ${clubIdToEdit} nen√°jdent na √∫pravu.`); alert("Klub na √∫pravu nebol n√°jden√Ω."); console.log("DEBUG: Team to edit not found."); if (clubModal) closeModal(clubModal); if (clubForm) clubForm.reset(); currentClubModalMode = 'add-assign'; editingClubId = null; displayClubs(); displayCreatedTeams(); if (unassignedClubSelectContainer) unassignedClubSelectContainer.style.display = 'block'; if (clubNameInputContainer) clubNameInputContainer.style.display = 'none'; if (clubCategorySelect) { clubCategorySelect.disabled = true; clubCategorySelect.value = ''; } if (clubGroupSelect && clubGroupSelect.parentElement) clubGroupSelect.parentElement.style.display = 'block'; if (clubGroupSelect) { clubGroupSelect.disabled = true; clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kateg√≥riu --</option>'; } if (orderInputContainer) orderInputContainer.style.display = 'none'; if (orderInGroupInput) orderInGroupInput.required = false;} return; }
                            const originalClubData = clubDocToEdit.data();


                            // === Podmienen√© kontroly duplicity pre re≈æim √∫pravy ===
                            const nameHasChanged = updatedClubName !== originalClubData.name;
                            const groupHasChanged = updatedGroupId !== (originalClubData.groupId || null);
                            const orderHasChanged = updatedOrderInGroup !== (typeof originalClubData.orderInGroup === 'number' ? originalClubData.orderInGroup : null);


                            if (updatedGroupId !== null) { // Ak sa upravuje v skupine alebo sa pres√∫va DO skupiny
                                 if (nameHasChanged || groupHasChanged) {
                                      const existingClubInTargetGroupQuery = query(clubsCollectionRef, where('groupId', '==', updatedGroupId), where('name', '==', updatedClubName), where('__name__', '!=', clubIdToEdit));
                                      const existingClubInTargetGroupSnapshot = await getDocs(existingClubInTargetGroupQuery);
                                      if (!existingClubInTargetGroupSnapshot.empty) { alert(`Klub s n√°zvom "${updatedClubName}" u≈æ v cieƒæovej skupine "${updatedGroupId}" existuje! Pros√≠m, zvoƒæte in√Ω n√°zov alebo skupinu.`); console.log("DEBUG: Duplicate name found in target group during edit."); return; }
                                 }
                                if (updatedGroupId !== null && updatedOrderInGroup !== null) { // Kontroluj poradie len ak je skupina zadan√° a poradie zadan√©
                                      if (orderHasChanged || groupHasChanged) { // Kontroluj ak sa zmenilo poradie ALEBO skupina
                                           const existingOrderQuery = query(clubsCollectionRef, where('groupId', '==', updatedGroupId), where('orderInGroup', '==', updatedOrderInGroup), where('__name__', '!=', clubIdToEdit));
                                           const existingOrderSnapshot = await getDocs(existingOrderQuery);
                                           if (!existingOrderSnapshot.empty) { alert(`T√≠m s poradov√Ωm ƒç√≠slom "${updatedOrderInGroup}" u≈æ v skupine "${updatedGroupId}" existuje! Pros√≠m, zvoƒæte in√© poradov√© ƒç√≠slo.`); console.log("DEBUG: Duplicate order found in target group during edit."); return; }
                                      }
                                 }

                             } else { // Ak sa upravuje NEPRIRADEN√ù t√≠m alebo sa pres√∫va Z skupiny (updatedGroupId === null)
                                  // Ak sa men√≠ n√°zov nepriraden√©ho t√≠mu, skontroluj duplicity medzi ostatn√Ωmi nepriraden√Ωmi
                                  if (nameHasChanged && (originalClubData.groupId === null || originalClubData.groupId === undefined)) {
                                      const existingUnassignedClubQuery = query(clubsCollectionRef, where('groupId', '==', null), where('name', '==', updatedClubName), where('__name__', '!=', clubIdToEdit));
                                      const existingUnassignedClubSnapshot = await getDocs(existingUnassignedClubQuery);
                                      if (!existingUnassignedClubSnapshot.empty) { alert(`In√Ω nepriraden√Ω klub s n√°zvom "${updatedClubName}" u≈æ existuje!`); console.log("DEBUG: Duplicate name found among unassigned during edit."); return; }
                                  }
                               }


                             console.log(`DEBUG: Updating club document: ${clubIdToEdit}`);
                             await updateDoc(clubRefToEdit, {
                                  name: updatedClubName,
                                 categoryId: updatedCategoryId,
                                 groupId: updatedGroupId,
                                  orderInGroup: updatedGroupId !== null ? updatedOrderInGroup : null
                             });

                             console.log(`SUCCESS: Klub "${updatedClubName}" (ID: ${clubIdToEdit}) √∫spe≈°ne upraven√Ω.`);
                             alert(`Klub √∫spe≈°ne upraven√Ω.`);

                         }

                         // --- Spoloƒçn√° logika po √∫spechu ---
                         console.log("DEBUG: Common success logic started.");
                         if (clubModal) closeModal(clubModal); // Pou≈æi≈• funkciu closeModal
                         if (clubForm) clubForm.reset();
                         currentClubModalMode = 'add-assign';
                         editingClubId = null;

                         // Reset visibility a disabled states pre ƒèal≈°ie otvorenie
                          if (unassignedClubSelectContainer) unassignedClubSelectContainer.style.display = 'block';
                          if (clubNameInputContainer) clubNameInputContainer.style.display = 'none';
                          if (clubCategorySelect) { clubCategorySelect.disabled = true; clubCategorySelect.value = ''; } // Zablokova≈• a resetova≈• kateg√≥rie
                          if (clubGroupSelect && clubGroupSelect.parentElement) clubGroupSelect.parentElement.style.display = 'block';
                          if (clubGroupSelect) { clubGroupSelect.disabled = true; clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kateg√≥riu --</option>'; } // Zablokova≈• a resetova≈• skupiny
                          if (orderInputContainer) orderInputContainer.style.display = 'none';
                          if (orderInGroupInput) orderInGroupInput.required = false;


                         // Refresh displays that might be affected
                         // !!! ODSTR√ÅNEN√â EXPLICITN√â VOLANIA displayCreatedTeams a displayClubs !!!
                         // Spoliehame sa na to, ≈æe toggleContentDisplay (spusten√Ω hashchange listenerom alebo inak)
                         // sa postar√° o zobrazenie spr√°vnej sekcie a volanie jej display funkcie.
                         // displayCreatedTeams();
                         // if (window.location.hash === '#timy-do-skupin') {
                         //      displayClubs();
                         // }
                         // -------------------------------------------------------------------

                          // Obnov√≠me len zoznam nepriraden√Ωch t√≠mov, ak je to relevantn√©
                           if (unassignedClubSelect) {
                               console.log("DEBUG: Calling populateUnassignedClubsSelect after submit success.");
                               populateUnassignedClubsSelect(unassignedClubSelect, null); // Obnov√≠ zoznam nepriraden√Ωch
                           }

                         console.log("DEBUG: Submit success handler finished. Check console for subsequent display calls from toggleContentDisplay."); // Final log in handler


                     } catch (error) {
                         console.error('Chyba pri ukladan√≠ alebo priradzovan√≠ klubu: ', error);
                         alert(`Chyba pri ukladan√≠ alebo priradzovan√≠ klubu! Detail: ${error.message}`);
                          // Zatvor mod√°l a resetuj stav pri chybe
                          if (clubModal) closeModal(clubModal); // Pou≈æi≈• funkciu closeModal
                          if (clubForm) clubForm.reset();
                          currentClubModalMode = 'add-assign'; editingClubId = null;
                           // Reset visibility a disabled states pri chybe
                          if (unassignedClubSelectContainer) unassignedClubSelectContainer.style.display = 'block';
                          if (clubNameInputContainer) clubNameInputContainer.style.display = 'none';
                           if (clubCategorySelect) { clubCategorySelect.disabled = true; clubCategorySelect.value = ''; }
                          if (clubGroupSelect && clubGroupSelect.parentElement) clubGroupSelect.parentElement.style.display = 'block';
                           if (clubGroupSelect) { clubGroupSelect.disabled = true; clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kateg√≥riu --</option>'; }
                           if (orderInputContainer) orderInputContainer.style.display = 'none';
                          if (orderInGroupInput) orderInGroupInput.required = false;
                          console.log("DEBUG: Submit error handler finished.");
                     }
                });
            } else { console.error("Club form not found!"); }


        // --- Event Listener pre formul√°r kateg√≥ri√≠ ---
        if (categoryForm) {
            categoryForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                 console.log("DEBUG: categoryForm submit event fired."); // Log

                const categoryName = categoryNameInput.value.trim();
                if (!categoryName) {
                    alert('N√°zov kateg√≥rie nem√¥≈æe by≈• pr√°zdny.');
                     console.log("DEBUG: Validation failed: Category name is empty.");
                    return;
                }

                try {
                    if (currentCategoryModalMode === 'add') {
                        // Re≈æim pridania
                        const categoryRef = doc(categoriesCollectionRef, categoryName); // ID dokumentu je n√°zov kateg√≥rie

                        // Kontrola, ƒçi kateg√≥ria u≈æ existuje (dokument s dan√Ωm ID)
                        const docSnap = await getDoc(categoryRef);
                        if (docSnap.exists()) {
                            alert(`Kateg√≥ria s n√°zvom "${categoryName}" u≈æ existuje!`);
                             console.log("DEBUG: Validation failed: Category already exists.");
                            return;
                        }

                        // Pridanie novej kateg√≥rie
                        await setDoc(categoryRef, {
                            name: categoryName // M√¥≈æeme ulo≈æi≈• n√°zov aj v poli, aj keƒè ID je to ist√©
                            // Pr√≠padn√© ƒèal≈°ie polia pre kateg√≥riu
                        });

                        alert(`Kateg√≥ria "${categoryName}" √∫spe≈°ne pridan√°.`);
                         console.log("DEBUG: Category added successfully.");

                    } else if (currentCategoryModalMode === 'edit') {
                        // Re≈æim √∫pravy (premenovanie kateg√≥rie)
                        const oldCategoryId = editingCategoryId;
                        const newCategoryId = categoryName; // Nov√Ω n√°zov = nov√© ID

                        if (oldCategoryId === newCategoryId) {
                             alert('N√°zov kateg√≥rie nebol zmenen√Ω.');
                              console.log("DEBUG: Edit skipped: Name is the same.");
                             if (categoryModal) closeModal(categoryModal); // Zavrie≈• mod√°l ak sa niƒç nezmenilo
                             if (categoryForm) categoryForm.reset();
                             currentCategoryModalMode = 'add'; editingCategoryId = null;
                             return;
                        }

                        // Kontrola, ƒçi nov√° kateg√≥ria u≈æ existuje
                        const newCategoryRef = doc(categoriesCollectionRef, newCategoryId);
                        const newDocSnap = await getDoc(newCategoryRef);
                        if (newDocSnap.exists()) {
                             alert(`Kateg√≥ria s nov√Ωm n√°zvom "${newCategoryId}" u≈æ existuje!`);
                              console.log("DEBUG: Validation failed: New category name already exists.");
                            return;
                        }

                        // Z√≠skanie d√°t starej kateg√≥rie
                         const oldCategoryRef = doc(categoriesCollectionRef, oldCategoryId);
                         const oldDocSnap = await getDoc(oldCategoryRef);
                         if (!oldDocSnap.exists()) {
                              console.error(`Chyba: Star√° kateg√≥ria ${oldCategoryId} nen√°jden√° pri premenovan√≠.`);
                              alert('Chyba pri premenovan√≠ kateg√≥rie: P√¥vodn√° kateg√≥ria nebola n√°jden√°.');
                               if (categoryModal) closeModal(categoryModal); // Zavrie≈• mod√°l
                               if (categoryForm) categoryForm.reset();
                               currentCategoryModalMode = 'add'; editingCategoryId = null;
                               loadCategoriesTable(); // Obnovi≈• tabuƒæku
                              return;
                         }
                         const oldCategoryData = oldDocSnap.data();


                        // === Vykonanie BATCH oper√°cie pre premenovanie ===
                        // Premenovanie kateg√≥rie = zmazanie star√©ho dokumentu, vytvorenie nov√©ho s nov√Ωm ID,
                        // a AKTUALIZ√ÅCIA categoryId vo V≈†ETK√ùCH skupin√°ch a kluboch patriacich pod star√∫ kateg√≥riu.
                        console.log(`DEBUG: Starting batch write for renaming category "${oldCategoryId}" to "${newCategoryId}".`);
                        const batch = writeBatch(db);

                        // 1. Zmaza≈• star√Ω dokument kateg√≥rie
                        batch.delete(oldCategoryRef);
                        console.log(`DEBUG: Batch: Old category document (ID: ${oldCategoryId}) marked for deletion.`);


                        // 2. Vytvori≈• nov√Ω dokument kateg√≥rie s nov√Ωm ID a p√¥vodn√Ωmi d√°tami
                         batch.set(newCategoryRef, {
                              name: newCategoryId, // Nov√Ω n√°zov = nov√© ID
                             // Prenies≈• ostatn√© d√°ta zo starej kateg√≥rie, ak existuj√∫
                             ...oldCategoryData
                         });
                         console.log(`DEBUG: Batch: New category document (ID: ${newCategoryId}) marked for creation.`);


                        // 3. Aktualizova≈• categoryId vo V≈†ETK√ùCH skupin√°ch, ktor√© mali star√∫ kateg√≥riu
                         const groupsToUpdateQuery = query(groupsCollectionRef, where('categoryId', '==', oldCategoryId));
                         const groupsSnapshot = await getDocs(groupsToUpdateQuery);
                         groupsSnapshot.docs.forEach(groupDoc => {
                              const groupRef = doc(groupsCollectionRef, groupDoc.id);
                              batch.update(groupRef, { categoryId: newCategoryId });
                              console.log(`DEBUG: Batch: Updating categoryId for group "${groupDoc.id}" to "${newCategoryId}".`);
                         });


                        // 4. Aktualizova≈• categoryId vo V≈†ETK√ùCH kluboch, ktor√© mali star√∫ kateg√≥riu
                         const clubsToUpdateQuery = query(clubsCollectionRef, where('categoryId', '==', oldCategoryId));
                         const clubsSnapshot = await getDocs(clubsToUpdateQuery);
                         clubsSnapshot.docs.forEach(clubDoc => {
                              const clubRef = doc(clubsCollectionRef, clubDoc.id);
                              batch.update(clubRef, { categoryId: newCategoryId });
                              console.log(`DEBUG: Batch: Updating categoryId for club "${clubDoc.id}" to "${newCategoryId}".`);
                         });

                        await batch.commit();
                        console.log("DEBUG: Batch commit successful for category rename.");

                        alert(`Kateg√≥ria √∫spe≈°ne premenovan√° na "${newCategoryId}".`);
                         console.log("DEBUG: Category renamed successfully.");

                    }

                     // Spoloƒçn√° logika po √∫spe≈°nom pridan√≠/√∫prave kateg√≥rie
                    if (categoryModal) closeModal(categoryModal); // Pou≈æi≈• funkciu closeModal
                    if (categoryForm) categoryForm.reset();
                    currentCategoryModalMode = 'add'; editingCategoryId = null;

                    // Refresh tabuƒæku kateg√≥ri√≠ (v sekcii #kategorie)
                     console.log("DEBUG: Calling loadCategoriesTable after category submit success."); // Log
                    loadCategoriesTable(); // Toto vol√° display, ktor√Ω zobrazuje #kategorie
                    // Aktualizova≈• selectboxy kateg√≥ri√≠ vo V≈†ETK√ùCH mod√°loch a sekci√°ch, kde sa pou≈æ√≠vaj√∫
                    loadAllCategoriesForDynamicSelects(); // Pre mod√°l vytv√°rania t√≠mov
                     // Pre ostatn√© mod√°ly sa kateg√≥rie naƒç√≠taj√∫ pri ich otvoren√≠ (populateCategorySelect)
                } catch (error) {
                    console.error('Chyba pri ukladan√≠ kateg√≥rie: ', error);
                    alert(`Chyba pri ukladan√≠ kateg√≥rie! Detail: ${error.message}`);
                     console.log("DEBUG: Category submit error handler finished.");
                }
            });
        } else { console.error("Category form not found!"); }


        // --- Event Listener pre formul√°r skup√≠n ---
        if (groupForm) {
            groupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                 console.log("DEBUG: groupForm submit event fired."); // Log

                const groupName = groupNameInput.value.trim();
                const categoryId = groupCategorySelect.value;

                // Valid√°cia
                if (!groupName) { alert('N√°zov skupiny nem√¥≈æe by≈• pr√°zdny.'); console.log("DEBUG: Validation failed: Group name is empty."); return; }
                if (!categoryId) { alert('Pros√≠m, vyberte kateg√≥riu.'); console.log("DEBUG: Validation failed: Category not selected."); return; }

                // ID dokumentu skupiny bude kombin√°cia kateg√≥rie a n√°zvu
                const groupId = `${categoryId} - ${groupName}`; // Napr. "U12 - Skupina A"

                try {
                    if (currentGroupModalMode === 'add') {
                        // Re≈æim pridania
                        const groupRef = doc(groupsCollectionRef, groupId); // ID dokumentu je kombin√°cia kateg√≥rie a n√°zvu

                        // Kontrola, ƒçi skupina s dan√Ωm ID u≈æ existuje
                        const docSnap = await getDoc(groupRef);
                        if (docSnap.exists()) {
                             alert(`Skupina s n√°zvom "${groupName}" v kateg√≥rii "${categoryId}" u≈æ existuje!`);
                             console.log("DEBUG: Validation failed: Group already exists.");
                            return;
                        }

                        // Pridanie novej skupiny
                        await setDoc(groupRef, {
                            name: groupName, // M√¥≈æeme ulo≈æi≈• n√°zov skupiny samostatne
                            categoryId: categoryId // Ulo≈æ√≠me aj ID kateg√≥rie pre filtrovanie
                            // Pr√≠padn√© ƒèal≈°ie polia pre skupinu
                        });

                        alert(`Skupina "${groupName}" v kateg√≥rii "${categoryId}" √∫spe≈°ne pridan√°.`);
                         console.log("DEBUG: Group added successfully.");

                    } else if (currentGroupModalMode === 'edit') {
                        // Re≈æim √∫pravy (premenovanie skupiny)
                        // Premenovanie skupiny je mo≈æn√© len v r√°mci tej istej kateg√≥rie (category select je v edit m√≥de disabled)
                        const oldGroupId = editingGroupId; // ID star√©ho dokumentu skupiny
                        const newGroupName = groupName; // Nov√Ω n√°zov skupiny
                        const currentCategoryId = groupCategorySelect.value; // Kateg√≥ria (nemala by sa da≈• zmeni≈•)

                        // Nov√© ID dokumentu skupiny
                        const newGroupId = `${currentCategoryId} - ${newGroupName}`;

                        if (oldGroupId === newGroupId) {
                             alert('N√°zov skupiny nebol zmenen√Ω.');
                             console.log("DEBUG: Edit skipped: Group name is the same.");
                             if (groupModal) closeModal(groupModal); // Zavrie≈• mod√°l ak sa niƒç nezmenilo
                             if (groupForm) groupForm.reset();
                             currentGroupModalMode = 'add'; editingGroupId = null;
                            return;
                        }

                         // Kontrola, ƒçi skupina s nov√Ωm ID u≈æ existuje
                         const newGroupRef = doc(groupsCollectionRef, newGroupId);
                         const newDocSnap = await getDoc(newGroupRef);
                         if (newDocSnap.exists()) {
                             alert(`Skupina s nov√Ωm n√°zvom "${newGroupName}" v kateg√≥rii "${currentCategoryId}" u≈æ existuje!`);
                             console.log("DEBUG: Validation failed: New group name already exists.");
                             return;
                         }

                         // Z√≠skanie d√°t starej skupiny
                          const oldGroupRef = doc(groupsCollectionRef, oldGroupId);
                          const oldDocSnap = await getDoc(oldGroupRef);
                           if (!oldDocSnap.exists()) {
                                console.error(`Chyba: Star√° skupina ${oldGroupId} nen√°jden√° pri premenovan√≠.`);
                                alert('Chyba pri premenovan√≠ skupiny: P√¥vodn√° skupina nebola n√°jden√°.');
                                 if (groupModal) closeModal(groupModal);
                                 if (groupForm) groupForm.reset();
                                currentGroupModalMode = 'add'; editingGroupId = null;
                                 // loadGroupsForCategory(currentCategoryId); // Obnovi≈• zobrazenie skup√≠n
                                return;
                           }
                           const oldGroupData = oldDocSnap.data();


                        // === Vykonanie BATCH oper√°cie pre premenovanie skupiny ===
                        // Premenovanie skupiny = zmazanie star√©ho dokumentu, vytvorenie nov√©ho s nov√Ωm ID,
                        // a AKTUALIZ√ÅCIA groupId vo V≈†ETK√ùCH kluboch patriacich pod star√∫ skupinu.
                        console.log(`DEBUG: Starting batch write for renaming group "${oldGroupId}" to "${newGroupId}".`);
                        const batch = writeBatch(db);

                        // 1. Zmaza≈• star√Ω dokument skupiny
                        batch.delete(oldGroupRef);
                         console.log(`DEBUG: Batch: Old group document (ID: ${oldGroupId}) marked for deletion.`);


                        // 2. Vytvori≈• nov√Ω dokument skupiny s nov√Ωm ID a p√¥vodn√Ωmi d√°tami
                         batch.set(newGroupRef, {
                              name: newGroupName, // Nov√Ω n√°zov
                             categoryId: currentCategoryId, // Kateg√≥ria zost√°va rovnak√°
                             // Prenies≈• ostatn√© d√°ta zo starej skupiny, ak existuj√∫
                             ...oldGroupData
                         });
                         console.log(`DEBUG: Batch: New group document (ID: ${newGroupId}) marked for creation.`);


                        // 3. Aktualizova≈• groupId vo V≈†ETK√ùCH kluboch, ktor√© patrili pod star√∫ skupinu
                         const clubsToUpdateQuery = query(clubsCollectionRef, where('groupId', '==', oldGroupId));
                         const clubsSnapshot = await getDocs(clubsToUpdateQuery);
                         clubsSnapshot.docs.forEach(clubDoc => {
                              const clubRef = doc(clubsCollectionRef, clubDoc.id);
                              batch.update(clubRef, { groupId: newGroupId });
                              console.log(`DEBUG: Batch: Updating groupId for club "${clubDoc.id}" to "${newGroupId}".`);
                         });


                        await batch.commit();
                        console.log("DEBUG: Batch commit successful for group rename.");

                        alert(`Skupina √∫spe≈°ne premenovan√° na "${newGroupName}".`);
                         console.log("DEBUG: Group renamed successfully.");

                    }

                    // Spoloƒçn√° logika po √∫spe≈°nom pridan√≠/√∫prave skupiny
                    if (groupModal) closeModal(groupModal); // Pou≈æi≈• funkciu closeModal
                    if (groupForm) groupForm.reset();
                    currentGroupModalMode = 'add'; editingGroupId = null;

                    // Refresh zobrazenia skup√≠n v sekcii #skupiny
                    // Predpoklad√°, ≈æe sekcia #skupiny zobrazuje skupiny filtrovan√© podƒæa kateg√≥rie
                    // Ak je v sekcii filter kateg√≥ri√≠, mus√≠me obnovi≈• zobrazenie skup√≠n pre aktu√°lne vybran√∫ kateg√≥riu
                     console.log("DEBUG: Calling logic to refresh groups display after submit success.");
                     // TODO: Implementova≈• logiku obnovenia zobrazenia skup√≠n v sekcii #skupiny
                     // Napr. ak existuje filter kateg√≥ri√≠ v sekcii #skupiny s ID 'groupCategoryFilterSelect':
                     // loadGroupsForCategory(document.getElementById('groupCategoryFilterSelect').value);
                     // Ak #skupiny zobrazuje skupiny nejako inak, volajte pr√≠slu≈°n√∫ funkciu.
                     // Ak #skupiny zobrazuje v≈°etky skupiny naraz, volajte funkciu, ktor√° to rob√≠.
                     // Doƒçasne: Ak je aktu√°lny hash #timy-do-skupin, obnov√≠ aj priraden√© t√≠my (pre pr√≠pad zmeny n√°zvu skupiny)
                      if (window.location.hash === '#timy-do-skupin') {
                           displayClubs();
                      }
                       // Ak je aktu√°lny hash #zoznam-timov, obnov√≠ aj zoznam v≈°etk√Ωch t√≠mov (pre pr√≠pad zmeny n√°zvu skupiny v inform√°cii o priraden√≠)
                       if (window.location.hash === '#zoznam-timov') {
                            displayCreatedTeams();
                       }

                } catch (error) {
                    console.error('Chyba pri ukladan√≠ skupiny: ', error);
                    alert(`Chyba pri ukladan√≠ skupiny! Detail: ${error.message}`);
                     console.log("DEBUG: Group submit error handler finished.");
                }
            });
        } else { console.error("Group form not found!"); }


        // --- Event Listener pre formul√°r hromadn√©ho vytv√°rania t√≠mov ---
        if (teamCreationForm) {
            teamCreationForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                 console.log("DEBUG: teamCreationForm submit event fired."); // Log

                const baseTeamName = teamNameInput.value.trim();
                if (!baseTeamName) {
                     alert('Z√°kladn√Ω n√°zov t√≠mu nem√¥≈æe by≈• pr√°zdny.');
                     console.log("DEBUG: Validation failed: Base team name is empty.");
                    return;
                }

                const pairs = teamCategoryCountContainer.querySelectorAll('.category-count-pair');
                const teamsToCreate = [];

                // Valid√°cia a zber d√°t z dynamick√Ωch dvoj√≠c
                for (const pair of pairs) {
                    const categorySelect = pair.querySelector('.team-category-select-dynamic');
                    const countInput = pair.querySelector('.team-count-input-dynamic');

                    const category = categorySelect.value;
                    const count = parseInt(countInput.value, 10);

                    if (!category) { alert('Pros√≠m, vyberte kateg√≥riu pre v≈°etky dvojice.'); console.log("DEBUG: Validation failed: Category missing in pair."); return; }
                    if (isNaN(count) || count <= 0) { alert('Pros√≠m, zadajte platn√Ω poƒçet t√≠mov (aspo≈à 1) pre v≈°etky dvojice.'); console.log("DEBUG: Validation failed: Invalid count in pair."); return; }

                    teamsToCreate.push({ category, count });
                }

                if (teamsToCreate.length === 0) {
                     alert('Pros√≠m, pridajte aspo≈à jednu dvojicu kateg√≥rie a poƒçtu.');
                      console.log("DEBUG: Validation failed: No pairs added.");
                    return;
                }

                 console.log("DEBUG: Teams to create:", teamsToCreate);


                try {
                    // === Vytvorenie t√≠mov pomocou BATCH oper√°cie ===
                    console.log("DEBUG: Starting batch write for creating teams.");
                    const batch = writeBatch(db);

                    for (const teamInfo of teamsToCreate) {
                        const { category, count } = teamInfo;

                        for (let i = 1; i <= count; i++) {
                            // Kon≈°trukcia n√°zvu t√≠mu a ID dokumentu
                            const teamSuffix = count > 1 ? ` ${i}` : ''; // Pridaj suffix ak je viac ako 1 t√≠m
                             const fullTeamName = `${baseTeamName}${teamSuffix}`; // Cel√Ω n√°zov t√≠mu
                             // ID dokumentu bude "Kateg√≥ria - Cel√Ω N√°zov T√≠mu"
                            const teamDocumentId = `${category} - ${fullTeamName}`; // Pou≈æi≈• konzistentn√Ω form√°t ID


                            const teamDocRef = doc(clubsCollectionRef, teamDocumentId); // Referencia na dokument s urƒçen√Ωm ID

                            // D√°ta pre nov√Ω t√≠m
                            const newTeamData = {
                                name: fullTeamName, // Ulo≈æ√≠me cel√Ω n√°zov
                                categoryId: category,
                                groupId: null, // Nov√© t√≠my s√∫ nepriraden√©
                                orderInGroup: null // Nemaj√∫ poradie k√Ωm nie s√∫ priraden√©
                                // Pr√≠padn√© ƒèal≈°ie predvolen√© polia pre t√≠m
                            };

                            // Kontrola, ƒçi dokument s t√Ωmto ID u≈æ existuje (ak by napr. u≈æ bol vytvoren√Ω/priraden√Ω t√≠m s rovnak√Ωm ID)
                             // T√°to kontrola je d√¥le≈æit√°, aby sme nepremazali existuj√∫ci z√°znam nechtiac.
                             // Ak chceme dovoli≈• prep√≠sanie, t√∫to kontrolu vynech√°me, ale setDoc s konkr√©tnym ID prepisuje.
                             // Predpoklad√°me, ≈æe nechceme prepisova≈• existuj√∫ce t√≠my s t√Ωmto ID.
                             const existingTeamSnap = await getDoc(teamDocRef);
                             if (existingTeamSnap.exists()) {
                                 console.warn(`DEBUG: Team with ID "${teamDocumentId}" already exists. Skipping creation for this specific team.`);
                                 // M√¥≈æeme preskoƒçi≈• t√∫to konkr√©tnu iter√°ciu alebo informova≈• pou≈æ√≠vateƒæa
                                 alert(`T√≠m s n√°zvom "${fullTeamName}" v kateg√≥rii "${category}" u≈æ existuje. Tento t√≠m nebol znovu vytvoren√Ω.`);
                                 continue; // Preskoƒçi≈• pridanie do batchu pre tento t√≠m
                             }


                            // Pridanie oper√°cie vytvorenia dokumentu do batchu
                            batch.set(teamDocRef, newTeamData);
                             console.log(`DEBUG: Batch: Team "${teamDocumentId}" marked for creation.`);

                        }
                    }

                    await batch.commit();
                    console.log("DEBUG: Batch commit successful for team creation.");

                    alert('T√≠my √∫spe≈°ne vytvoren√©.');
                     console.log("DEBUG: Teams created successfully.");

                     // Spoloƒçn√° logika po √∫spe≈°nom vytvoren√≠ t√≠mov
                    if (teamCreationModal) closeModal(teamCreationModal); // Pou≈æi≈• funkciu closeModal
                     // Formul√°r sa resetuje v catch bloku alebo po √∫spechu priamo pred resetovan√≠m stavu mod√°lu

                    // Refresh tabuƒæku so zoznamom v≈°etk√Ωch t√≠mov (v sekcii #zoznam-timov)
                     console.log("DEBUG: Calling displayCreatedTeams after team creation submit success."); // Log
                     // !!! ODSTR√ÅNEN√â: displayCreatedTeams() sa u≈æ nebude vola≈• explicitne po submite !!!
                     // displayCreatedTeams();
                    // --------------------------------------------------------------------------

                     // Tie≈æ treba aktualizova≈• zoznam nepriraden√Ωch t√≠mov pre club modal, ak je relevantn√©
                      if (unassignedClubSelect) {
                           console.log("DEBUG: Calling populateUnassignedClubsSelect after team creation submit success.");
                           populateUnassignedClubsSelect(unassignedClubSelect, null);
                      }

                } catch (error) {
                     console.error('Chyba pri vytv√°ran√≠ t√≠mov: ', error);
                     alert(`Chyba pri vytv√°ran√≠ t√≠mov! Detail: ${error.message}`);
                      console.log("DEBUG: Team creation submit error handler finished.");

                     // Reset formul√°ra pri chybe (alebo nech√°me, aby u≈æ√≠vateƒæ videl, ƒço zadal?)
                     // Ak bol cel√Ω batch zlyhan√Ω, pravdepodobne chceme necha≈• formul√°r vyplnen√Ω, aby u≈æ√≠vateƒæ mohol sk√∫si≈• znova.
                      // Ak nastala chyba pri getDoc (kontrola existencie), tie≈æ necha≈• formul√°r.
                     // Resetovanie formul√°ra by sa malo dia≈• len pri √öSPECHU.

                     // Reset formul√°ra len ak chceme zaƒça≈• odznova po chybe
                     // if (teamCreationForm) teamCreationForm.reset(); // Vyƒçist√≠ aspo≈à z√°kladn√Ω n√°zov
                     // if (teamCategoryCountContainer) teamCategoryCountContainer.innerHTML = ''; // Vyƒçist√≠ dynamick√© dvojice
                     // loadAllCategoriesForDynamicSelects(); // Pre istotu znovu naƒç√≠taj kateg√≥rie a aktualizuj selecty
                }
            });
        } else { console.error("Team creation form not found!"); }


        // --- Event listener pre tlaƒçidlo "Prida≈• ƒèal≈°iu kateg√≥riu" (v mod√°li vytv√°rania t√≠mov) ---
        if (addCategoryCountPairButton) {
            addCategoryCountPairButton.addEventListener('click', async () => {
                 console.log("DEBUG: addCategoryCountPairButton clicked.");
                 // Pred pridan√≠m novej dvojice zabezpeƒçi≈•, ≈æe kateg√≥rie s√∫ naƒç√≠tan√©
                 if (allAvailableCategories.length === 0) {
                      await loadAllCategoriesForDynamicSelects(); // Naƒç√≠taj kateg√≥rie ak e≈°te nie s√∫ (vol√° updateDynamicCategorySelects a checkIfAddCategoryButtonShouldBeVisible)
                 }
                 await addCategoryCountPair(); // Volaj funkciu na pridanie ƒèal≈°ej dvojice (vol√° updateDynamicCategorySelects a updateRemoveButtonVisibility)
            });
        } else { console.error("Add category count pair button not found!"); }


        // --- Event Listener pre kliknutie na riadok t√≠mu v tabuƒæke Zoznam t√≠mov (pre otvorenie Manage Teams modal) ---
        // Predpoklad√°me, ≈æe tabuƒæka Zoznam t√≠mov m√° ID 'createdTeamsTable' a riadky s d√°tami maj√∫ triedu 'team-row'
        // A klik√°me napr. na prv√∫ bunku (n√°zov t√≠mu)
        // Ak je v displayCreatedTeams generovan√° in√° ≈°trukt√∫ra, tento listener treba prisp√¥sobi≈•
        // V aktu√°lnej displayCreatedTeams generujeme priamo riadky (<tr>) s bunkami (<td>)
        // Sk√∫sme prida≈• listener na telo tabuƒæky a delegova≈• kliknutie na riadky

        const createdTeamsTableBody = document.getElementById('createdTeamsTableBody'); // Referencia z√≠skan√° u≈æ vy≈°≈°ie
        if (createdTeamsTableBody) {
            // Pou≈æijeme event delegation na telo tabuƒæky
            createdTeamsTableBody.addEventListener('click', (event) => {
                console.log("DEBUG: Click event on createdTeamsTableBody."); // Log
                const clickedRow = event.target.closest('tr'); // N√°jdeme najbli≈æ≈°√≠ rodiƒçovsk√Ω riadok (<tr>)

                // Uist√≠me sa, ≈æe sme klikli na riadok a ≈æe to nie je riadok s chybou/pr√°zdnou spr√°vou
                if (clickedRow && !clickedRow.classList.contains('no-data-row') && !clickedRow.classList.contains('error-row')) { // Pridajte triedy pre riadky s info/chybou ak existuj√∫
                     // Z√≠skame d√°ta z riadku alebo z elementov v riadku, ktor√© identifikuj√∫ zoskupenie
                     // V aktu√°lnej displayCreatedTeams generujeme riadky PRE KA≈ΩD√ù T√çM.
                     // Ak chceme otvori≈• Manage Teams modal pre zoskupenie (Z√°kladn√Ω n√°zov + Kateg√≥ria),
                     // mus√≠me z riadku z√≠ska≈• Z√°kladn√Ω n√°zov a Kateg√≥riu.
                     // V aktu√°lnej displayCreatedTeams, stƒ∫pec 0 je N√°zov, stƒ∫pec 1 je Kateg√≥ria.
                     // Toto zoskupenie je zalo≈æen√© na PLNOM n√°zve a kateg√≥rii.
                     // Tak≈æe kliknutie na riadok t√≠mu by malo otvori≈• spr√°vu pre toto zoskupenie (pln√Ω n√°zov + kateg√≥ria).
                     // ALEBO, ak chceme zoskupova≈• v modali spr√°vu podƒæa Z√°kladn√©ho n√°zvu + Kateg√≥rie,
                     // potrebujeme ma≈• sp√¥sob, ako z pln√©ho n√°zvu t√≠mu z√≠ska≈• z√°kladn√Ω n√°zov.

                     // Predpokladajme, ≈æe kliknutie na prv√∫ bunku (n√°zov t√≠mu) v riadku spust√≠ spr√°vu pre toto zoskupenie
                     // N√°jdime prv√∫ bunku v riadku
                      const firstCell = clickedRow.querySelector('td:first-child');
                      const categoryCell = clickedRow.querySelector('td:nth-child(2)'); // Druh√° bunka pre kateg√≥riu

                     if (firstCell && categoryCell) {
                          const fullTeamName = firstCell.textContent; // Cel√Ω n√°zov z prvej bunky
                          const category = categoryCell.textContent; // Kateg√≥ria z druhej bunky

                         // !!! D√¥le≈æit√©: Ak chceme otvori≈• Manage Teams modal ZOSKUPEN√ù podƒæa Z√°kladn√©ho n√°zvu,
                         // potrebujeme Z√ÅKLADN√ù n√°zov, nie cel√Ω n√°zov.
                         // V displayCreatedTeams je stƒ∫pec 0 "N√°zov t√≠mu" (cel√Ω n√°zov).
                         // Ak Manage Teams modal zobrazuje t√≠my podƒæa Z√°kladn√©ho n√°zvu a Kateg√≥rie,
                         // potrebujeme pri kliknut√≠ na riadok t√≠mu vypoƒç√≠ta≈• Z√°kladn√Ω n√°zov z cel√©ho n√°zvu.
                         // Toto je problematick√©, ak nem√°me konzistentn√© suffixy alebo ulo≈æen√Ω baseName.
                         // AKO SA TERAZ V DISPLAYCREATEDTEAMS ZOBRAZUJE "Z√ÅKLADN√ù N√ÅZOV"?
                         // displayCreatedTeams zoskupuje podƒæa team.name a team.categoryId.
                         // Riadok zobrazuje team.name (cel√Ω n√°zov) a team.categoryId.
                         // Manage Teams modal otv√°rame s baseTeamName a categoryId.
                         // AK Manage Teams modal ZOBRAZUJE TIIMY PODLA Z√°kladn√©ho n√°zvu a Kateg√≥rie,
                         // MUS√çME Z√çSKA≈§ Z√°kladn√Ω n√°zov z kliknut√©ho riadku.
                         // Ak displayCreatedTeams zobrazuje "Z√°kladn√Ω n√°zov (Kateg√≥ria)", a klikneme na to,
                         // mus√≠me z textu extrahova≈• Z√°kladn√Ω n√°zov a Kateg√≥riu.
                         // Alebo, ak displayCreatedTeams zobrazuje Riadky pre KA≈ΩD√ù T√çM (ako v mojej √∫prave displayCreatedTeams),
                         // kliknutie na riadok by malo otvori≈• Manage Teams modal pre ZOSKUPENIE zalo≈æen√© na
                         // Z√ÅKLADNOM N√ÅZVE (vypoƒç√≠tanom z cel√©ho n√°zvu) a KATEG√ìRII.

                         // Predpokladajme, ≈æe Manage Teams modal sa otv√°ra s PLNYM n√°zvom t√≠mu a Kateg√≥riou
                         // (to by zodpovedalo tomu, ako zoskupujeme teraz v displayCreatedTeams pre zobrazenie).
                         // Teda openManageTeamsModal(fullTeamName, category);

                          // Alebo, ak Manage Teams modal ZOBRAZUJE t√≠my so Z√°kladn√Ωm n√°zvom HORE a potom zoznam t√≠my
                          // a otvor√≠me ho kliknut√≠m na Zoskupenie "Z√°kladn√Ω n√°zov (Kateg√≥ria)",
                          // potrebujeme z√≠ska≈• Z√°kladn√Ω n√°zov z riadku zoskupenia.
                          // V AKTU√ÅLNEJ displayCreatedTeams ZOBRAZUJEM Riadok pre KA≈ΩD√ù T√çM.
                          // Tak≈æe kliknutie na riadok by malo otvori≈• Manage Teams pre ZOSKUPENIE tohto t√≠mu.
                          // Z√°kladn√Ω n√°zov sa mus√≠ vypoƒç√≠ta≈•.

                          // Vypoƒç√≠tanie Z√°kladn√©ho n√°zvu z Cel√©ho n√°zvu je neist√© bez ulo≈æenia baseName v DB.
                          // Ak je cel√Ω n√°zov "H√°dzan√° Trenƒç√≠n 1", z√°kladn√Ω n√°zov je "H√°dzan√° Trenƒç√≠n".
                          // Ak je cel√Ω n√°zov "FC Juniori B", z√°kladn√Ω n√°zov je "FC Juniori B" (alebo "FC Juniori" ak suffix je B?)
                          // AK ID JE "Kateg√≥ria - Cel√Ω N√°zov", potom "Cel√Ω N√°zov" je team.name.
                          // Ak chceme zoskupova≈• v modale podƒæa "Z√°kladn√Ω n√°zov (Kateg√≥ria)", mus√≠me ma≈• baseName.

                          // Zme≈àme to tak, ≈æe kliknutie na riadok v displayCreatedTeams otvor√≠ CLUB MODAL V EDIT M√ìDE pre dan√Ω t√≠m.
                          // To je jednoduch≈°ie a konzistentnej≈°ie. Spr√°va jednotliv√Ωch t√≠mov sa bude dia≈• cez Club Modal.
                          // Funkciu openManageTeamsModal budeme vola≈• len pri kliknut√≠ na ZOSKUPENIE (ak by displayCreatedTeams zobrazoval zoskupenia inak).
                          // Alebo, ak chceme ZACHOVA≈§ Manage Teams Modal, mus√≠me mu nejako poveda≈•, ktor√© t√≠my m√° zobrazi≈•.
                          // M√¥≈æeme mu preda≈• Zoznam ID t√≠mov z dan√©ho zoskupenia?
                          // Alebo mu preda≈• Z√°kladn√Ω n√°zov a Kateg√≥riu, a Manage Teams Modal si ich naƒç√≠ta?

                          // V aktu√°lnom k√≥de, kliknutie na riadok v displayCreatedTeams vol√° openManageTeamsModal(fullTeamName, category).
                          // Toto vol√° modal s PLNYM n√°zvom t√≠mu a kateg√≥riou.
                          // Funkcia openManageTeamsModal n√°sledne query firestore na t√≠my s TOUTO kateg√≥riou a FILTRUJE na tie,
                          // ktor√Ωch n√°zov ZACINA na baseTeamName (ƒço je tu fullTeamName).
                          // Toto nie je spr√°vne, ak chceme vidie≈• t√≠my s ROVNAKYM Z√°kladn√Ωm n√°zvom.

                          // Zme≈àme posluch√°ƒç kliknutia v displayCreatedTeams tak, aby volal openClubModal v edit m√≥de pre dan√Ω t√≠m.
                          // Odstr√°nime Manage Teams modal a jeho logiku, ak jeho √∫ƒçelom bola len hromadn√° √∫prava/mazanie (ktor√© sa d√° robi≈• jednotlivo cez Club Modal).
                          // Ak chceme hromadn√∫ √∫pravu/mazanie zoskupenia, Manage Teams modal je potrebn√Ω, ale jeho logika naƒç√≠tania sa mus√≠ zmeni≈•.

                           // Zatiaƒæ ponech√°me volanie openManageTeamsModal, ale treba si uvedomi≈• jeho obmedzenia s extrakciou baseName.
                           // AKTU√ÅLNE sa otv√°ra Manage Teams modal pre zoskupenie = "Cel√Ω N√°zov T√≠mu" + Kateg√≥ria.
                           // A vn√∫tri Manage Teams modalu sa hƒæadaj√∫ t√≠my, ktor√Ωch n√°zov ZACINA na "Cel√Ω N√°zov T√≠mu".
                           // Toto by malo vr√°ti≈• len samotn√Ω kliknut√Ω t√≠m, ak jeho n√°zov nezaƒç√≠na na in√Ω n√°zov.
                           // Je to m√§t√∫ce.


                           // Presu≈àme logiku √∫pravy/mazania z displayCreatedTeams do ManageTeamsModal.
                           // A kliknutie na riadok v displayCreatedTeams BUDE vola≈• openManageTeamsModal.

                           // Ponech√°me aktu√°lne volanie openManageTeamsModal(fullTeamName, category);
                           // A budeme pracova≈• s t√Ωm, ≈æe Manage Teams modal zobraz√≠ t√≠my, ktor√Ωch n√°zov zaƒç√≠na na 'fullTeamName' v danej kateg√≥rii.
                           // Toto je st√°le problematick√© pre extrakciu z√°kladn√©ho n√°zvu.

                           // Alternat√≠va: Upravi≈• displayCreatedTeams tak, aby zoskupoval a zobrazoval "Z√°kladn√Ω n√°zov (Kateg√≥ria)" riadky.
                           // A kliknutie na TIE riadky by volalo openManageTeamsModal(baseName, category).
                           // Potom by sa upravil openManageTeamsModal, aby naƒç√≠tal t√≠my podƒæa baseName a category.

                           // Zatiaƒæ nech√°me p√¥vodn√∫ logiku volania openManageTeamsModal z displayCreatedTeams,
                           // ale s vedom√≠m, ≈æe zoskupovanie a filtrovanie v Manage Teams modali nemus√≠ by≈• presne podƒæa oƒçak√°vania.

                             const fullTeamName = firstCell.textContent; // Cel√Ω n√°zov t√≠mu z prvej bunky
                             const category = categoryCell.textContent; // Kateg√≥ria z druhej bunky

                             console.log("DEBUG: Clicked team row in createdTeamsTableBody. Calling openManageTeamsModal.");
                            // Volanie openManageTeamsModal s PLNYM n√°zvom t√≠mu a Kateg√≥riou
                            openManageTeamsModal(fullTeamName, category);

                        } else {
                             console.log("DEBUG: Clicked on createdTeamsTableBody, but not a data row.");
                        }
                    });
                } else { console.error("Created teams table body not found!"); }


        // --- Event Listener pre formul√°r Manage Teams (v mod√°li spr√°vy jednotliv√Ωch t√≠mov) ---
        // Ak Manage Teams modal obsahuje formul√°r na hromadn√∫ √∫pravu/mazanie, treba prida≈• jeho listener.
        // V aktu√°lnom HTML tam formul√°r nie je, s√∫ tam len tlaƒçidl√° pre jednotliv√© t√≠my v zozname.
        // Ak by tam bol formul√°r, tu by bol jeho addEventListener('submit', ...)


        // --- Inicializ√°cia d√°t pri naƒç√≠tan√≠ str√°nky ---
        // Toto sa spust√≠ raz pri prvom naƒç√≠tan√≠ scriptu
        console.log("DEBUG: Script loaded. Starting initial display setup.");
        // Initializova≈• stav zobrazenia pri naƒç√≠tan√≠ str√°nky
        const initialHash = window.location.hash || '#kategorie';

        // Volanie pr√≠slu≈°nej zobrazovacej funkcie pre poƒçiatoƒçn√Ω hash
        if (initialHash === '#kategorie') {
             console.log("DEBUG: Initial display for #kategorie.");
            toggleContentDisplay(); // Spust√≠ toggleContentDisplay, ktor√Ω zobraz√≠ sekciu a zavol√° loadCategoriesTable
        } else if (initialHash === '#skupiny') {
             console.log("DEBUG: Initial display for #skupiny.");
             toggleContentDisplay(); // Spust√≠ toggleContentDisplay, ktor√Ω zobraz√≠ sekciu
             // TODO: Zavola≈• funkciu na zobrazenie skup√≠n v sekcii #skupiny
             // Napr. loadGroupsForCategory(document.getElementById('groupCategoryFilterSelect').value);
        } else if (initialHash === '#timy-do-skupin') {
             console.log("DEBUG: Initial display for #timy-do-skupin. Calling toggleContentDisplay and displayClubs.");
             toggleContentDisplay(); // Zobraz√≠ sekciu #timy-do-skupin
             displayClubs(); // !!! Zavol√° displayClubs pre prvotn√© naplnenie tabuƒæky priraden√Ωch t√≠mov pri naƒç√≠tan√≠ strany !!!
        } else if (initialHash === '#zoznam-timov') {
             console.log("DEBUG: Initial display for #zoznam-timov. Calling toggleContentDisplay and displayCreatedTeams.");
             toggleContentDisplay(); // Zobraz√≠ sekciu #zoznam-timov
             displayCreatedTeams(); // !!! Zavol√° displayCreatedTeams pre prvotn√© naplnenie tabuƒæky v≈°etk√Ωch t√≠mov pri naƒç√≠tan√≠ strany !!!
        } else {
             console.warn(`DEBUG: Initial hash ${initialHash} does not match any known section. Defaulting to #kategorie.`);
             // Ak hash nezn√°my, presmerujeme na #kategorie, ƒço spust√≠ hashchange listener
             window.location.hash = '#kategorie';
        }


        // Prida≈• posluch√°ƒça udalosti 'hashchange', ktor√Ω zavol√° toggleContentDisplay
        // Toto sa spust√≠ pri KA≈ΩDEJ zmene hashu (kliknutie na navigaƒçn√© linky, programov√° zmena hashu)
        console.log("DEBUG: Adding hashchange listener.");
        window.addEventListener('hashchange', toggleContentDisplay);


        // --- Inicializ√°cia d√°t pri naƒç√≠tan√≠ skriptu ---
        // Tieto d√°ta s√∫ potrebn√© pre plnenie selectboxov v mod√°loch hneƒè pri ich otvoren√≠
        console.log("DEBUG: Initial data loading for modals.");
        loadAllCategoriesForDynamicSelects(); // Naƒç√≠ta kateg√≥rie pre mod√°l vytv√°rania t√≠mov a vol√° updateDynamicCategorySelects/checkIfAddCategoryButtonShouldBeVisible
        // Ostatn√© potrebn√© d√°ta pre mod√°ly (kateg√≥rie, nepriraden√© t√≠my, skupiny) sa naƒç√≠taj√∫ v pr√≠slu≈°n√Ωch openModal funkci√°ch alebo v change listeneroch.


    </script>
    
</body>
</html>
