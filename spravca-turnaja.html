<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spr√°vca turnaja</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="style.css">

    <style>
        /* --- General Styles --- */
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-top: 20px;
            margin-bottom: 20px; /* Added margin-bottom for separation */
        }

        h2 {
            margin-top: 0; /* Reset margin-top, controlled by section padding */
            margin-bottom: 10px;
            color: #555;
        }

         h3 { /* Style for category headings in Manage Teams modal */
            margin-top: 15px;
            margin-bottom: 8px;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
         }


        .add-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 30px;
            line-height: 60px;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            z-index: 100; /* Ensure button is above other content */
        }

        .container {
            display: flex;
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            min-height: calc(100vh - 40px); /* Adjusted to account for h1 margin */
        }

        .sidebar {
            width: 250px;
            background-color: #f8f9fa;
            padding: 20px;
            border-right: 1px solid #e9ecef;
        }

        .sidebar nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar nav ul li {
            margin-bottom: 10px;
        }

        .sidebar nav ul li a {
            text-decoration: none;
            color: #007bff;
            font-weight: bold;
            display: block;
            padding: 8px 10px;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .sidebar nav ul li a:hover {
            background-color: #e9ecef;
        }

        .sidebar nav ul li a.active {
             background-color: #007bff;
             color: white;
        }

        .content {
            flex-grow: 1;
            padding: 20px;
        }

        /* --- Table Styles --- */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        /* --- Modal Styles --- */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0, 0, 0, 0.4); /* Black w/ opacity */
            padding-top: 60px;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; /* 15% from the top and centered */
            padding: 20px;
            border: 1px solid #888;
            width: 80%; /* Could be more or less, depending on screen size */
            max-width: 500px; /* Max width for smaller modals */
            border-radius: 8px;
            position: relative; /* Needed for the close button positioning */
        }

        /* Adjust max-width for the manage teams modal */
        .modal-content[style*="max-width: 700px"] {
             max-width: 700px;
        }


        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 15px;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        /* --- Form Styles --- */
        form {
            margin-top: 15px; /* Add space above the form */
        }

        form div {
            margin-bottom: 15px; /* Space between form groups */
        }

        label {
            display: block; /* Label on its own line */
            margin-bottom: 5px; /* Space between label and input */
            font-weight: bold;
            color: #555;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: calc(100% - 22px); /* Full width minus padding and border */
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1rem;
        }

        button[type="submit"],
        button[type="button"] {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button[type="submit"]:hover,
        button[type="button"]:hover {
            background-color: #0056b3;
        }

        button[type="button"].close-button { /* Style for modal close buttons if used inside form */
             background-color: #6c757d;
             margin-left: 10px; /* Space between submit and close buttons */
        }

        button[type="button"].close-button:hover {
             background-color: #545b62;
        }


        /* Specific style for the remove button in addCategoryCountPair */
         .remove-category-pair-button {
            background-color: #dc3545;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-left: 10px; /* Space from the input/select */
         }

        .remove-category-pair-button:hover {
            background-color: #c82333;
        }

        /* Style for container holding category/count pairs */
        .category-count-pair {
            display: flex;
            align-items: center;
            margin-bottom: 10px; /* Space between pairs */
        }

        .category-count-pair select,
        .category-count-pair input[type="number"] {
             width: auto; /* Allow elements to size based on content */
             flex-grow: 1; /* Allow inputs/selects to take available space */
             margin-right: 10px; /* Space between select/input */
        }

        .category-count-pair input[type="number"] {
            max-width: 80px; /* Limit width for count input */
        }


        /* Validation message style */
         .validation-message {
             color: #dc3545; /* Red color for errors */
             font-size: 0.85rem;
             margin-top: 5px;
             display: block; /* Ensure it's on a new line */
         }


         /* Manage Teams Modal Specific Styles */
        .team-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }

        .team-list-item:last-child {
            border-bottom: none;
        }

        .team-list-item span {
            flex-grow: 1;
            margin-right: 10px;
        }

        .team-list-item button {
            padding: 4px 8px;
            font-size: 0.8rem;
            margin-left: 5px;
        }

        .team-list-item button.edit-team-button {
             background-color: #ffc107;
             color: #212529;
        }

        .team-list-item button.edit-team-button:hover {
             background-color: #e0a800;
        }


        .team-list-item button.unassign-team-button {
            background-color: #dc3545;
            color: white;
        }

         .team-list-item button.unassign-team-button:hover {
             background-color: #c82333;
        }

         .manage-teams-form-actions {
             margin-top: 20px;
             text-align: right; /* Align buttons to the right */
         }

         .manage-teams-form-actions button[type="button"].close-button {
              /* Use already defined style */
         }


         /* Style for the drag handle */
         .drag-handle {
            cursor: grab;
            margin-right: 10px;
            font-size: 1.2em;
            color: #888;
         }

         .drag-handle:active {
            cursor: grabbing;
         }

         /* Style for items being dragged */
        .dragging {
            opacity: 0.5;
        }

        /* Style for the drag over area */
        .drag-over {
            border-top: 2px dashed #007bff;
        }


        /* Message area for displaying status or errors */
        .message-area {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            display: none; /* Hidden by default */
        }

        .message-area.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message-area.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }


    </style>
</head>
<body>

    <h1>Spr√°vca turnaja</h1>

    <button class="add-button" id="addButton">+</button>

    <div class="container">
        <aside class="sidebar">
            <nav>
                <ul>
                    <li><a href="#kategorie" id="nav-kategorie">Vytvorenie kateg√≥ri√≠</a></li>
                    <li><a href="#skupiny" id="nav-skupiny">Vytvorenie skup√≠n</a></li>
                    <li><a href="#zoznam-timov" id="nav-zoznam-timov">Zoznam t√≠mov</a></li>
                    <li><a href="#timy-do-skupin" id="nav-timy-do-skupin">T√≠my do skup√≠n</a></li>
                     <li><a href="#sportove-haly" id="nav-sportove-haly">≈†portov√© haly</a></li>
                      <li><a href="#sprava-turnaja" id="nav-sprava-turnaja">Spr√°va turnaja</a></li>
                       <li><a href="#nastavenia" id="nav-nastavenia">Nastavenia</a></li>
                </ul>
            </nav>
        </aside>

        <main class="content">
            <section id="kategorie" style="display: none;">
                <h2>Vytvorenie kateg√≥ri√≠</h2>
                 <p>Spr√°va kateg√≥ri√≠ pre turnaj.</p>
                <table id="categoriesTable">
                    <thead>
                        <tr>
                            <th>N√°zov Kateg√≥rie</th>
                            <th>Akcie</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </section>

            <section id="skupiny" style="display: none;">
                <h2>Vytvorenie skup√≠n</h2>
                 <p>Spr√°va skup√≠n pre jednotliv√© kateg√≥rie.</p>
                <table id="groupsTable">
                    <thead>
                        <tr>
                            <th>Kateg√≥ria</th>
                            <th>N√°zov Skupiny</th>
                            <th>Akcie</th>
                        </tr>
                    </thead>
                    <tbody>
                         </tbody>
                </table>
            </section>

            <section id="zoznam-timov" style="display: none;">
                 <h2>Zoznam t√≠mov</h2>
                 <p>Prehƒæad v≈°etk√Ωch vytvoren√Ωch t√≠mov.</p>
                 <table id="teamsListTable">
                     <thead>
                          <tr>
                                <th>Z√°kladn√Ω N√°zov</th>
                                <th>Kateg√≥ria</th>
                                <th>Poƒçet T√≠mov</th>
                                <th>Akcie</th>
                          </tr>
                     </thead>
                     <tbody>
                          </tbody>
                 </table>
            </section>


             <section id="timy-do-skupin" style="display: none;">
                 <h2>T√≠my do skup√≠n</h2>
                 <p>Priradenie existuj√∫cich t√≠mov do vytvoren√Ωch skup√≠n.</p>
                 <p>Nepriraden√© t√≠my:</p>
                 <table id="unassignedClubsTable">
                    <thead>
                         <tr>
                             <th>N√°zov T√≠mu</th>
                              <th>Kateg√≥ria</th>
                              <th>Akcie</th>
                         </tr>
                    </thead>
                    <tbody>
                         </tbody>
                 </table>

                  <h3>T√≠my priraden√© do skup√≠n:</h3>
                  <p>T√≠my v r√°mci skup√≠n je mo≈æn√© pres√∫va≈• potiahnut√≠m (drag & drop) a meni≈• tak ich poradie.</p>
                  <div id="assignedClubsContainer">
                       </div>

            </section>

             <section id="sportove-haly" style="display: none;">
                 <h2>≈†portov√© haly</h2>
                 <p>Spr√°va ≈°portov√Ωch h√°l pre turnaj.</p>
                 <p>T√°to sekcia zatiaƒæ nie je implementovan√°.</p>
            </section>

             <section id="sprava-turnaja" style="display: none;">
                 <h2>Spr√°va turnaja</h2>
                 <p>Celkov√° spr√°va turnaja (rozlosovanie, ƒçasy, atƒè.).</p>
                 <p>T√°to sekcia zatiaƒæ nie je implementovan√°.</p>
            </section>

             <section id="nastavenia" style="display: none;">
                 <h2>Nastavenia</h2>
                 <p>Nastavenia turnaja (n√°zov, d√°tum, atƒè.).</p>
                  <div id="admin-auth-section">
                      <h3>Admin Prihl√°senie</h3>
                       <button id="admin-logout-button" style="display: none;">Odhl√°si≈• Admina</button>
                 </div>

                 <p>T√°to sekcia zatiaƒæ nie je plne implementovan√°.</p>
            </section>


        </main>
    </div>

    <div class="modal" id="categoryModal">
        <div class="modal-content">
            <span class="close category-modal-close">&times;</span>
            <h2 id="categoryModalTitle">Prida≈• Kateg√≥riu</h2>
            <form id="categoryForm">
                <div>
                    <label for="categoryName">N√°zov Kateg√≥rie:</label>
                    <input type="text" id="categoryName" name="categoryName" required>
                </div>
                <button type="submit">Ulo≈æi≈• Kateg√≥riu</button>
                 <button type="button" class="close-button category-modal-close">Zru≈°i≈•</button> </form>
        </div>
    </div>

     <div class="modal" id="groupModal">
         <div class="modal-content">
              <span class="close group-modal-close">&times;</span>
             <h2 id="groupModalTitle">Prida≈• Skupinu</h2>
             <form id="groupForm">
                 <div>
                     <label for="groupCategory">Kateg√≥ria:</label>
                     <select id="groupCategory" name="groupCategory" required>
                         <option value="">-- Vyberte kateg√≥riu --</option>
                         </select>
                 </div>
                 <div>
                     <label for="groupName">N√°zov Skupiny:</label>
                     <input type="text" id="groupName" name="groupName" required>
                 </div>
                  <button type="submit">Ulo≈æi≈• Skupinu</button>
                  <button type="button" class="close-button group-modal-close">Zru≈°i≈•</button> </form>
         </div>
     </div>


     <div class="modal" id="clubModal">
           <div class="modal-content">
               <span class="close club-modal-close">&times;</span>
               <h2 id="clubModalTitle">Priradi≈• t√≠m do skupiny</h2>
               <form id="clubForm">
                   <div id="unassignedClubSelectContainer">
                        <label for="unassignedClubSelect">Vyberte existuj√∫ci t√≠m:</label>
                        <select id="unassignedClubSelect">
                           <option value="">-- Vyberte t√≠m na priradenie --</option>
                         </select>
                   </div>

                   <div id="clubNameInputContainer">
                        <label for="clubName">N√°zov klubu:</label>
                        <input type="text" id="clubName" name="clubName" required>
                       <span class="validation-message" id="clubNameValidationMessage"></span>
                   </div>

                   <div>
                        <label for="clubCategory">Kateg√≥ria:</label>
                        <select id="clubCategory" name="clubCategory" required>
                           <option value="">-- Vyberte kateg√≥riu --</option>
                           </select>
                        <span class="validation-message" id="clubCategoryValidationMessage"></span>
                   </div>

                   <div>
                         <label for="clubGroup">Skupina:</label>
                         <select id="clubGroup" name="clubGroup" required disabled>
                            <option value="">-- Najprv vyberte kateg√≥riu --</option>
                         </select>
                         <span class="validation-message" id="clubGroupValidationMessage"></span>
                   </div>

                    <div id="orderInputContainer">
                          <label for="orderInGroup">Poradov√© ƒç√≠slo v skupine:</label>
                          <input type="number" id="orderInGroup" name="orderInGroup" min="1">
                          <span class="validation-message" id="orderInGroupValidationMessage"></span>
                    </div>

                    <button type="submit">Ulo≈æi≈•</button>
                    <button type="button" class="close-button club-modal-close">Zru≈°i≈•</button>
               </form>
           </div>
       </div>


    <div class="modal" id="teamCreationModal">
         <div class="modal-content" style="max-width: 600px;"> <span class="close team-creation-modal-close">&times;</span>
              <h2>Vytvorenie T√≠mov</h2>
              <p>Vytvorte viacero t√≠mov pre r√¥zne kateg√≥rie naraz.</p>
              <form id="teamCreationForm">
                   <div>
                       <label for="baseTeamName">Z√°kladn√Ω n√°zov t√≠mu:</label>
                       <input type="text" id="baseTeamName" name="baseTeamName" required placeholder="Napr. Lokomot√≠va Ko≈°ice">
                       <span class="validation-message" id="baseTeamNameValidationMessage"></span>
                   </div>

                   <div id="teamCategoryCountContainer">
                        </div>

                   <button type="button" id="addCategoryCountPairButton">Prida≈• ƒèal≈°iu kateg√≥riu</button>

                   <button type="submit">Vytvori≈• T√≠my</button>
                   <button type="button" class="close-button team-creation-modal-close">Zru≈°i≈•</button>
              </form>
             <div class="message-area" id="teamCreationMessageArea"></div> </div>
    </div>

     <div class="modal" id="manageTeamsModal">
        <div class="modal-content" style="max-width: 700px;"> <span class="close manage-teams-modal-close">&times;</span>
            <h2>Spr√°va t√≠mov: <span id="baseTeamNameInModal"></span></h2>
            <p>Individu√°lna spr√°va t√≠mov vytvoren√Ωch pod t√Ωmto n√°zvom.</p>

            <div id="teamsListInModal">
                 </div>

             <div class="manage-teams-form-actions">
                  <button type="button" class="close-button manage-teams-modal-close">Zavrie≈•</button>
             </div>
        </div>
    </div>


    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, where, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"; // Import Auth

        // Tvoja Firebase konfigur√°cia
        const firebaseConfig = {
            apiKey: "AIzaSyD0h0rQZiIGi0-UDb4-YU_JihRGpIlfz40", // ZME≈á ZA SVOJ SKUTOƒåN√ù API KƒΩ√öƒå
            authDomain: "turnaj-a28c5.firebaseapp.com", // ZME≈á ZA SVOJ SKUTOƒåN√ù authDomain
            projectId: "turnaj-a28c5", // ZME≈á ZA SVOJ SKUTOƒåN√ù projectId
            storageBucket: "turnaj-a28c5.firebasestorage.app", // ZME≈á ZA SVOJ SKUTOƒåN√ù storageBucket
            messagingSenderId: "13732191148", // ZME≈á ZA SVOJ SKUTOƒåN√ù messagingSenderId
            appId: "1:13732191148:web:5ad78eaef2ad452a10f809" // ZME≈á ZA SVOJ SKUTOƒåN√ù appId
        };

        // Inicializ√°cia Firebase aplik√°cie
        const app = initializeApp(firebaseConfig);
        // Z√≠skanie in≈°tancie Firestore datab√°zy
        const db = getFirestore(app);
         // Z√≠skanie in≈°tancie Auth
        const auth = getAuth(app);


        // Referencia na kolekcie
        // ≈†trukt√∫ra: tournamentData -> mainTournamentData (dokument) -> categories (kolekcia)
        const tournamentDataDocRef = doc(db, 'tournamentData', 'mainTournamentData');
        const categoriesCollectionRef = collection(tournamentDataDocRef, 'categories');
        const groupsCollectionRef = collection(tournamentDataDocRef, 'groups'); // Groups use composite IDs
        const clubsCollectionRef = collection(tournamentDataDocRef, 'clubs'); // Clubs now use auto-generated IDs

        // Referencia na dokument s nastaveniami turnaja (napr. n√°zov, atƒè.)
        const tournamentSettingsDocRef = doc(db, 'tournamentData', 'mainTournamentData', 'settings', 'general');


        // Glob√°lne premenn√© pre ulo≈æenie kateg√≥ri√≠ a t√≠mov pre dynamick√© select boxy
        let allAvailableCategories = [];
        let allAvailableClubs = []; // Used for populating the unassigned clubs select


        // === Autentik√°cia Admina ===
        let isAdmin = false; // Default state

        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in. Check if it's the admin user (anonymous for now)
                 console.log("Firebase Auth state changed. User signed in.", user.uid);
                 // For simplicity, we assume the anonymous user created is the admin
                 // In a real app, you'd check user roles or email etc.
                 isAdmin = true; // Assume any logged in user is admin for this simple case
                 console.log("Admin status:", isAdmin);
                 // TODO: Show admin-only UI elements, hide login form if it existed
                  document.getElementById('admin-logout-button').style.display = 'block';

                 // Redirect away from login page if admin is logged in (if login page existed)
                 // if (window.location.pathname.endsWith('login.html')) {
                 //      window.location.href = 'index.html'; // Redirect to main page
                 // }

            } else {
                // User is signed out
                 console.log("Firebase Auth state changed. User signed out.");
                 isAdmin = false; // Not admin
                 console.log("Admin status:", isAdmin);
                 // TODO: Hide admin-only UI elements, show login form if it existed
                  document.getElementById('admin-logout-button').style.display = 'none';

                 // Redirect to login page if not admin (if login page existed)
                 // if (!window.location.pathname.endsWith('login.html')) {
                 //      window.location.href = 'login.html'; // Redirect to login
                 // }

                 // For THIS simple app, if not logged in, try to log in anonymously
                 // signInAnonymously(auth)
                 //     .then(() => {
                 //          console.log("Attempting anonymous sign-in...");
                 //      })
                 //      .catch((error) => {
                 //          console.error("Error during anonymous sign-in:", error);
                 //          // Handle errors (e.g., display message to user)
                 //      });
                  // === TEMPORARY: Auto sign in anonymously for testing ===
                  // In a real app, this would be triggered by a login form
                   signInAnonymously(auth).catch(error => console.error("Anonymous sign-in failed:", error));
                   // === END TEMPORARY ===
            }
            // After checking auth state, ensure correct content is displayed based on hash and admin status
             toggleContentDisplay(); // Call this after auth state is known
        });

        document.getElementById('admin-logout-button').addEventListener('click', () => {
            signOut(auth).then(() => {
                console.log("Admin signed out.");
                // onAuthStateChanged listener handles UI updates and potential redirect
            }).catch((error) => {
                console.error("Error signing out:", error);
            });
        });


        // === Z√≠skame referencie na DOM elementy ===

        const addButton = document.getElementById('addButton');

        // Mod√°l Kateg√≥rie
        const categoryModal = document.getElementById('categoryModal');
        const categoryModalCloseBtn = categoryModal ? categoryModal.querySelector('.category-modal-close') : null; // Added null check
        const categoryForm = document.getElementById('categoryForm');
        const categoryNameInput = document.getElementById('categoryName');
        const categoryModalTitle = document.getElementById('categoryModalTitle');
        let editingCategoryId = null; // Store the ID of the category being edited

        // Mod√°l Skupiny
        const groupModal = document.getElementById('groupModal');
        const groupModalCloseBtn = groupModal ? groupModal.querySelector('.group-modal-close') : null; // Added null check
        const groupForm = document.getElementById('groupForm');
        const groupCategorySelect = document.getElementById('groupCategory');
        const groupNameInput = document.getElementById('groupName');
        const groupModalTitle = document.getElementById('groupModalTitle');
        const groupFormSubmitButton = groupForm ? groupForm.querySelector('button[type="submit"]') : null; // Added null check
        let editingGroupId = null; // Store the composite ID "categoryId-groupName" of the group being edited


        // Mod√°l Kluby (pre priradenie do skup√≠n / √∫pravu priraden√Ωch)
        const clubModal = document.getElementById('clubModal');
        const clubModalCloseBtn = clubModal ? clubModal.querySelector('.club-modal-close') : null; // Added null check
        const clubForm = document.getElementById('clubForm');
        const clubNameInput = document.getElementById('clubName'); // Existing name input (used when editing assigned)
        const clubCategorySelect = document.getElementById('clubCategory'); // Category select within club modal form
        const clubGroupSelect = document.getElementById('clubGroup'); // Group select within club modal form
        const clubModalTitle = document.getElementById('clubModalTitle');
        const clubFormSubmitButton = clubForm ? clubForm.querySelector('button[type="submit"]') : null; // Added null check

        // Mod√°l Vytvorenie T√≠mov
        const teamCreationModal = document.getElementById('teamCreationModal');
        const teamCreationModalCloseBtn = teamCreationModal ? teamCreationModal.querySelector('.team-creation-modal-close') : null; // Added null check
        const teamCreationForm = document.getElementById('teamCreationForm');
        const baseTeamNameInput = document.getElementById('baseTeamName');
        const teamCategoryCountContainer = document.getElementById('teamCategoryCountContainer');
        const addCategoryCountPairButton = document.getElementById('addCategoryCountPairButton');
        const teamCreationMessageArea = document.getElementById('teamCreationMessageArea');


        // Nov√Ω Modal pre spr√°vu individu√°lnych t√≠mov
        const manageTeamsModal = document.getElementById('manageTeamsModal');
        const baseTeamNameInModalSpan = document.getElementById('baseTeamNameInModal');
        const teamsListInModalDiv = document.getElementById('teamsListInModal');
        const manageTeamsModalCloseBtn = manageTeamsModal ? manageTeamsModal.querySelector('.manage-teams-modal-close') : null; // Added null check


        // REFERENCES FOR CLUB MODAL CHANGES (add/edit assigned)
        const unassignedClubSelectContainer = document.getElementById('unassignedClubSelectContainer');
        const unassignedClubSelect = document.getElementById('unassignedClubSelect');
        const clubNameInputContainer = document.getElementById('clubNameInputContainer');
         const orderInputContainer = document.getElementById('orderInputContainer'); // Reference to the new order input container
        const orderInGroupInput = document.getElementById('orderInGroup'); // Reference to the new order input field

        let currentClubModalMode = 'add-assign'; // 'add-assign' or 'edit'
        let editingClubId = null; // Store the ID of the club being edited when mode is 'edit'


        // === Navigaƒçn√° logika a zobrazenie sekci√≠ ===

        // Skryje v≈°etky sekcie obsahu
        function hideAllSections() {
            document.querySelectorAll('main .content section').forEach(section => {
                section.style.display = 'none';
            });
             // Skryje v≈°etky mod√°ly
             document.querySelectorAll('.modal').forEach(modal => {
                 modal.style.display = 'none';
             });
             // Skryje tlaƒçidlo pridania, ak nie je pou≈æiteƒæn√© v aktu√°lnej sekcii
             if (addButton) {
                  addButton.style.display = 'none';
             }

             // Reset modal state when changing sections
             currentClubModalMode = 'add-assign'; // Default mode
             editingClubId = null; // No club being edited
              // Reset form inputs to default states (optional, but good practice)
               if (categoryForm) categoryForm.reset();
               if (groupForm) groupForm.reset();
               if (clubForm) clubForm.reset();
               if (teamCreationForm) {
                    teamCreationForm.reset();
                    // Clear dynamically added category/count pairs except the first one
                    if (teamCategoryCountContainer) {
                         teamCategoryCountContainer.innerHTML = ''; // Clear all pairs
                         addCategoryCountPair(false); // Add back the first empty pair without focusing
                    }
               }


              // Remove active class from all nav links
             document.querySelectorAll('.sidebar nav ul li a').forEach(link => {
                  link.classList.remove('active');
             });

        }

        // Zobraz√≠ sekciu na z√°klade hashu
        async function toggleContentDisplay() {
            hideAllSections(); // Najprv skryje v≈°etko

            if (!isAdmin) {
                 console.warn("Nie je prihl√°sen√Ω admin. Zobrazujem len z√°kladn√Ω obsah alebo presmerov√°vam.");
                 // TODO: Implement actual redirect or limited view if not admin
                 // Presmeruj na login, ak nie je admin a nie si u≈æ na login str√°nke (ak existuje)
                 // if (!window.location.pathname.endsWith('login.html')) {
                 //     window.location.href = 'login.html';
                 // }
                  // Doƒçasne len nelogovan√©mu adminovi nezobrazujeme obsah sekci√≠
                 return; // Zastav√≠ vykon√°vanie funkcie, ak nie je admin
            }

            const hash = window.location.hash;
            console.log("Navigating to hash:", hash); // Debug log

            // Z√≠skaj referenciu na aktu√°lny navigaƒçn√Ω link a oznaƒç ho ako akt√≠vny
            const activeNavLink = document.querySelector(`.sidebar nav ul li a[href="${hash}"]`);
             if(activeNavLink) {
                 activeNavLink.classList.add('active');
             }


            // Zobraz√≠ pr√≠slu≈°n√∫ sekciu a naƒç√≠ta d√°ta
            switch (hash) {
                case '#kategorie':
                     const kategorieSection = document.getElementById('kategorie');
                     if (kategorieSection) {
                          kategorieSection.style.display = 'block';
                           if (addButton) addButton.style.display = 'block'; // Tlaƒçidlo pridania je viditeƒæn√© v sekcii kateg√≥ri√≠
                           loadCategories(); // Naƒç√≠taj a zobraz kateg√≥rie v tabuƒæke
                     } else { console.error("Section #kategorie not found!"); }
                    break;
                case '#skupiny':
                     const skupinySection = document.getElementById('skupiny');
                     if (skupinySection) {
                          skupinySection.style.display = 'block';
                          if (addButton) addButton.style.display = 'block'; // Tlaƒçidlo pridania je viditeƒæn√© v sekcii skup√≠n
                          loadGroups(); // Naƒç√≠taj a zobraz skupiny v tabuƒæke
                     } else { console.error("Section #skupiny not found!"); }
                    break;
                 case '#zoznam-timov':
                     const zoznamTimovSection = document.getElementById('zoznam-timov');
                     if (zoznamTimovSection) {
                          zoznamTimovSection.style.display = 'block';
                          // Tlaƒçidlo pridania je viditeƒæn√© len pre hromadn√© vytvorenie v sekcii t√≠mov
                          if (addButton) addButton.style.display = 'block'; // Tlaƒçidlo pridania je viditeƒæn√© v sekcii zoznamu t√≠mov
                          loadTeamsList(); // Naƒç√≠taj a zobraz zoznam t√≠mov v tabuƒæke
                     } else { console.error("Section #zoznam-timov not found!"); }
                    break;
                 case '#timy-do-skupin':
                     const timyDoSkupinSection = document.getElementById('timy-do-skupin');
                      if (timyDoSkupinSection) {
                           timyDoSkupinSection.style.display = 'block';
                            if (addButton) addButton.style.display = 'block'; // Tlaƒçidlo pridania je viditeƒæn√© v sekcii t√≠mov do skup√≠n (pre priradenie)
                            loadUnassignedClubs(); // Naƒç√≠taj a zobraz nepriraden√© kluby
                            loadAssignedClubs(); // Naƒç√≠taj a zobraz priraden√© kluby
                      } else { console.error("Section #timy-do-skupin not found!"); }
                    break;
                  case '#sportove-haly':
                     const sportoveHalySection = document.getElementById('sportove-haly');
                      if (sportoveHalySection) {
                           sportoveHalySection.style.display = 'block';
                            if (addButton) addButton.style.display = 'none'; // Tlaƒçidlo pridania nie je viditeƒæn√© v tejto sekcii (zatiaƒæ)
                      } else { console.error("Section #sportove-haly not found!"); }
                    break;
                   case '#sprava-turnaja':
                     const spravaTurnajaSection = document.getElementById('sprava-turnaja');
                      if (spravaTurnajaSection) {
                           spravaTurnajaSection.style.display = 'block';
                           if (addButton) addButton.style.display = 'none'; // Tlaƒçidlo pridania nie je viditeƒæn√© v tejto sekcii (zatiaƒæ)
                      } else { console.error("Section #sprava-turnaja not found!"); }
                    break;
                   case '#nastavenia':
                     const nastaveniaSection = document.getElementById('nastavenia');
                      if (nastaveniaSection) {
                           nastaveniaSection.style.display = 'block';
                           if (addButton) addButton.style.display = 'none'; // Tlaƒçidlo pridania nie je viditeƒæn√© v tejto sekcii (zatiaƒæ)
                           // TODO: Load/handle settings data
                      } else { console.error("Section #nastavenia not found!"); }
                    break;
                default:
                    // Ak hash ch√Ωba alebo je nezn√°my, presmeruj na #kategorie
                    window.location.hash = '#kategorie';
            }
             // Po zmene sekcie znova naƒç√≠taj kateg√≥rie pre v≈°etky dynamick√© selecty (ak s√∫ potrebn√©)
            await loadAllCategoriesForDynamicSelects(); // T√°to funkcia vol√° updateDynamicCategorySelects
        }

        // Vol√° sa pri naƒç√≠tan√≠ str√°nky a zmene hashu
        window.addEventListener('hashchange', toggleContentDisplay);
        window.addEventListener('load', () => {
             // Pri prvom naƒç√≠tan√≠ str√°nky (alebo po refreshi) nastav hash, ak nie je nastaven√Ω
             if (!window.location.hash) {
                 window.location.hash = '#kategorie'; // Defaultn√° sekcia
             } else {
                 // Ak hash u≈æ je, spust√≠ toggleContentDisplay (listener na hashchange to aj tak urob√≠)
                 // toggleContentDisplay();
             }
        });


        // === Funkcie pre pr√°cu s d√°tami (Firebase Firestore) ===

        // Naƒç√≠tanie v≈°etk√Ωch kateg√≥ri√≠ pre dynamick√© select boxy
        async function loadAllCategoriesForDynamicSelects() {
             if (allAvailableCategories.length > 0) {
                 // Kateg√≥rie u≈æ s√∫ naƒç√≠tan√©, nemus√≠me ich znovu naƒç√≠tava≈• z datab√°zy
                 // M√¥≈æeme rovno aktualizova≈• selecty
                 updateDynamicCategorySelects();
                 checkIfAddCategoryButtonShouldBeVisible(); // Skontroluje viditeƒænos≈• tlaƒçidla
                 console.log("Kateg√≥rie u≈æ boli naƒç√≠tan√©. Aktualizujem selecty.");
                 return;
             }
             console.log("Naƒç√≠tavam kateg√≥rie pre dynamick√© selecty...");
             try {
                 const querySnapshot = await getDocs(query(categoriesCollectionRef));
                 allAvailableCategories = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 console.log("Naƒç√≠tan√© kateg√≥rie pre v≈°etky selecty:", allAvailableCategories.map(cat => cat.name));

                 // Po naƒç√≠tan√≠ kateg√≥ri√≠ aktualizuj v≈°etky selecty, ktor√© ich pou≈æ√≠vaj√∫
                 updateDynamicCategorySelects();
                 checkIfAddCategoryButtonShouldBeVisible(); // Skontroluje viditeƒænos≈• tlaƒçidla
             } catch (e) {
                 console.error("Chyba pri naƒç√≠tan√≠ kateg√≥ri√≠ pre dynamick√© selecty: ", e);
             }
        }

         // Aktualizuje v≈°etky select boxy, ktor√© maj√∫ zobrazova≈• kateg√≥rie
         function updateDynamicCategorySelects() {
              // Zoznam ID select elementov, ktor√© sa maj√∫ naplni≈• kateg√≥riami
             const selectIdsToUpdate = [
                 'groupCategory', // Vytvorenie Skup√≠n mod√°l
                 'clubCategory',  // Kluby mod√°l
                 // Pridaj sem ƒèal≈°ie ID selectov, ak bud√∫ potrebn√© na in√Ωch miestach
             ];

              selectIdsToUpdate.forEach(selectId => {
                 const selectElement = document.getElementById(selectId);
                 if (selectElement) {
                      // Vol√°me populateCategorySelect pre ka≈æd√Ω tak√Ωto select
                      // selectedCategoryId je null, lebo len pln√≠me select, nevyber√°me konkr√©tnu kateg√≥riu z d√°t
                      populateCategorySelect(selectElement, true); // true = include default option
                 } else {
                     // console.warn(`Select element s ID "${selectId}" nebol n√°jden√Ω na aktualiz√°ciu kateg√≥riami.`);
                      // Je ok, ak select nie je na aktu√°lne zobrazenej str√°nke
                 }
              });

             // ≈†peci√°lne naplnenie pre dynamicky prid√°van√© selecty v teamCreationModal
             // Toto je volan√© aj pri addCategoryCountPair
             updateTeamCreationCategorySelects();

         }


        // Funkcia na naplnenie select boxu kateg√≥riami
        // Zvoliteƒæne nastav√≠ vybran√∫ kateg√≥riu, ak je provided selectedCategoryId
        async function populateCategorySelect(selectElement, includeDefaultOption = false, selectedCategoryId = null) {
            if (!selectElement) {
                console.error("Chyba: Cieƒæov√Ω select element nebol n√°jden√Ω pre kateg√≥rie.");
                return;
            }
            // --- PRIDAN√Å KONTROLA PRE NEOƒåAK√ÅVAN√ö HODNOTU SELECTEDCATEGORYID ---
            if (selectedCategoryId !== null && typeof selectedCategoryId !== 'string') { // Kateg√≥rie ID by mali by≈• stringy
                 console.warn(`populateCategorySelect: Neoƒçak√°van√° hodnota alebo typ pre selectedCategoryId:`, selectedCategoryId, `(Typ: ${typeof selectedCategoryId}). Nastavujem na null.`);
                 selectedCategoryId = null; // Resetujeme na null, ak je hodnota neoƒçak√°van√°
            }
             // --- KONIEC KONTROLY ---


            // Clear current options except maybe a default one if needed
            selectElement.innerHTML = ''; // Clear existing options

            if (includeDefaultOption) {
                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = "-- Vyberte kateg√≥riu --";
                selectElement.appendChild(defaultOption);
            }

            // Ensure all categories are loaded before populating
            if (allAvailableCategories.length === 0) {
                 console.warn("populateCategorySelect: Kateg√≥rie e≈°te nie s√∫ naƒç√≠tan√© do allAvailableCategories. Naƒç√≠tavam...");
                 await loadAllCategoriesForDynamicSelects(); // T√°to funkcia vol√° updateDynamicCategorySelects, ƒço by mohlo sp√¥sobi≈• rekurziu, ale populateCategorySelect by mala by≈• volan√° a≈æ PO naplnen√≠ allAvailableCategories
                 // Pre istotu skontrolujeme znovu po await
                  if (allAvailableCategories.length === 0) {
                      console.error("populateCategorySelect: Naƒç√≠tanie kateg√≥ri√≠ zlyhalo.");
                       // M√¥≈æeme sem prida≈• zobrazenie chybovej spr√°vy pre pou≈æ√≠vateƒæa
                       return;
                  }
            }


            // Sort categories alphabetically by name
            allAvailableCategories.sort((a, b) => a.name.localeCompare(b.name));


            allAvailableCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id; // Document ID is the value
                option.textContent = category.name;
                // Set selected if this option matches the selectedCategoryId
                 if (selectedCategoryId && category.id === selectedCategoryId) { // Check if selectedCategoryId is provided and matches
                     option.selected = true;
                 }
                selectElement.appendChild(option);
            });

            // Log if selectedCategoryId was provided but not found among options (useful for debugging edit mode)
            if (selectedCategoryId && !allAvailableCategories.find(cat => cat.id === selectedCategoryId)) {
                 console.warn(`populateCategorySelect: Kateg√≥ria s ID "${selectedCategoryId}" pre zvolen√∫ polo≈æku nen√°jden√° v zozname kateg√≥ri√≠.`, allAvailableCategories.map(cat => ({id: cat.id, name: cat.name}))); // <--- P√¥vodn√° logovacia spr√°va bola tu (riadok 908)
            }

        }

         // Funkcia na naplnenie select boxu skupinami pre dan√∫ kateg√≥riu
         async function populateGroupSelect(selectElement, categoryId, includeDefaultOption = false, selectedGroupId = null) {
              if (!selectElement) {
                 console.error("Chyba: Cieƒæov√Ω select element pre skupiny nebol n√°jden√Ω.");
                 return;
              }
              if (!categoryId) {
                  console.log("populateGroupSelect: Category ID ch√Ωba, nem√¥≈æem naƒç√≠ta≈• skupiny.");
                   selectElement.innerHTML = includeDefaultOption ? '<option value="">-- Najprv vyberte kateg√≥riu --</option>' : '';
                   selectElement.disabled = true; // Zablokuj, k√Ωm sa nevyberie kateg√≥ria
                   return;
              }
              console.log(`populateGroupSelect: Naƒç√≠tavam skupiny pre kateg√≥riu ID: ${categoryId}`);
              selectElement.disabled = true; // Zablokuj poƒças naƒç√≠tavania
              selectElement.innerHTML = includeDefaultOption ? '<option value="">-- Naƒç√≠tavam skupiny --</option>' : ''; // Loading message

              try {
                  // Skupiny s√∫ podkolekciou dokumentu kateg√≥rie
                 const groupQuery = query(collection(categoriesCollectionRef, categoryId, 'groups'));
                 const querySnapshot = await getDocs(groupQuery);
                 const groups = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                  console.log(`Naƒç√≠tan√© skupiny pre kateg√≥riu ${categoryId}:`, groups.map(g => g.name));

                  // Clear current options
                  selectElement.innerHTML = '';

                  if (includeDefaultOption) {
                     const defaultOption = document.createElement('option');
                     defaultOption.value = "";
                     defaultOption.textContent = "-- Vyberte skupinu --";
                     selectElement.appendChild(defaultOption);
                  }

                  groups.forEach(group => {
                     const option = document.createElement('option');
                     option.value = group.id; // Use group document ID as value
                     option.textContent = group.name;
                      if (selectedGroupId && group.id === selectedGroupId) { // Set selected if needed
                         option.selected = true;
                     }
                     selectElement.appendChild(option);
                  });

                 selectElement.disabled = false; // Povoƒæ select box po naƒç√≠tan√≠
                 // Log if selectedGroupId was provided but not found
                 if (selectedGroupId && !groups.find(g => g.id === selectedGroupId)) {
                     console.warn(`populateGroupSelect: Skupina s ID "${selectedGroupId}" pre zvolen√∫ polo≈æku nen√°jden√° v zozname skup√≠n kateg√≥rie ${categoryId}.`);
                 }


              } catch (e) {
                 console.error(`Chyba pri naƒç√≠tan√≠ skup√≠n pre kateg√≥riu ${categoryId}: `, e);
                 selectElement.innerHTML = includeDefaultOption ? '<option value="">-- Chyba pri naƒç√≠tan√≠ skup√≠n --</option>' : '';
                 selectElement.disabled = true;
              }
         }


         // Funkcia na naƒç√≠tanie nepriraden√Ωch klubov (pre select box v clubModal v add-assign m√≥de)
         async function loadUnassignedClubsForSelect() {
              if (!unassignedClubSelect) {
                 console.error("Chyba: Select element pre nepriraden√© kluby nebol n√°jden√Ω.");
                 return;
              }
             console.log("Naƒç√≠tavam nepriraden√© kluby pre select...");
             unassignedClubSelect.disabled = true; // Zablokuj poƒças naƒç√≠tavania
              unassignedClubSelect.innerHTML = '<option value="">-- Naƒç√≠tavam t√≠my --</option>'; // Loading message


             try {
                 // Naƒç√≠taj v≈°etky kluby, ktor√© nemaj√∫ groupId
                 const q = query(clubsCollectionRef, where("groupId", "==", null)); // Filter for clubs where groupId is null
                 const querySnapshot = await getDocs(q);
                 allAvailableClubs = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                 console.log("Naƒç√≠tan√© nepriraden√© kluby:", allAvailableClubs.map(club => club.name));

                 // Clear current options
                 unassignedClubSelect.innerHTML = '';

                 // Add default option
                 const defaultOption = document.createElement('option');
                 defaultOption.value = "";
                 defaultOption.textContent = "-- Vyberte t√≠m na priradenie --";
                 unassignedClubSelect.appendChild(defaultOption);

                  // Sort unassigned clubs by name (and category maybe?)
                 allAvailableClubs.sort((a, b) => a.name.localeCompare(b.name)); // Sort by name

                 allAvailableClubs.forEach(club => {
                     const option = document.createElement('option');
                     option.value = club.id; // Use club document ID as value
                     option.textContent = `${club.name} (${allAvailableCategories.find(cat => cat.id === club.categoryId)?.name || 'Nezn√°ma kateg√≥ria'})`; // Display name and category
                     option.dataset.categoryId = club.categoryId; // Store categoryId in dataset
                     unassignedClubSelect.appendChild(option);
                 });

                 unassignedClubSelect.disabled = false; // Povoƒæ select box po naƒç√≠tan√≠

                 // Ak nie s√∫ ≈æiadne nepriraden√© kluby, zobraz spr√°vu
                 if (allAvailableClubs.length === 0) {
                     const noClubsOption = document.createElement('option');
                     noClubsOption.value = "";
                     noClubsOption.textContent = "-- ≈Ωiadne nepriraden√© t√≠my --";
                     noClubsOption.disabled = true;
                     unassignedClubSelect.appendChild(noClubsOption);
                      unassignedClubSelect.disabled = true; // Zablokuj, ak nie s√∫ t√≠my
                 }


             } catch (e) {
                 console.error("Chyba pri naƒç√≠tan√≠ nepriraden√Ωch klubov pre select: ", e);
                 unassignedClubSelect.innerHTML = '<option value="">-- Chyba pri naƒç√≠tan√≠ t√≠mov --</option>';
                 unassignedClubSelect.disabled = true;
             }
         }



        // === Funkcie pre otv√°ranie/zatv√°ranie mod√°lov ===

         // Funkcia na zatvorenie v≈°etk√Ωch mod√°lov
         function closeAllModals() {
             document.querySelectorAll('.modal').forEach(modal => {
                 modal.style.display = 'none';
             });
             // Reset modal state
             currentClubModalMode = 'add-assign'; // Default mode
             editingClubId = null; // No club being edited
              // Reset forms (optional, but good practice)
             if (categoryForm) categoryForm.reset();
             if (groupForm) groupForm.reset();
             if (clubForm) clubForm.reset();
             if (teamCreationForm) {
                 teamCreationForm.reset();
                 // Clear dynamically added category/count pairs except the first one
                 if (teamCategoryCountContainer) {
                      teamCategoryCountContainer.innerHTML = ''; // Clear all pairs
                      addCategoryCountPair(false); // Add back the first empty pair without focusing
                 }
              }
              // Reset message area visibility
              if(teamCreationMessageArea) {
                  teamCreationMessageArea.style.display = 'none';
                  teamCreationMessageArea.className = 'message-area'; // Reset classes
              }

         }


        // Funkcia na otvorenie mod√°lu kateg√≥rie (pre pridanie alebo √∫pravu)
        function openCategoryModal(categoryId = null, categoryData = null) {
            if (!categoryModal) { console.error("Category modal element not found!"); return; }
            if (!categoryForm) { console.error("Category form element not found!"); return; }
             if (!categoryNameInput) { console.error("Category name input element not found!"); return; }
             if (!categoryModalTitle) { console.error("Category modal title element not found!"); return; }


            categoryForm.reset(); // Reset form fields
            editingCategoryId = categoryId; // Store ID if editing

            if (categoryId && categoryData) {
                // Edit mode
                categoryModalTitle.textContent = 'Upravi≈• Kateg√≥riu';
                categoryNameInput.value = categoryData.name;
            } else {
                // Add mode
                categoryModalTitle.textContent = 'Prida≈• Kateg√≥riu';
            }

            categoryModal.style.display = 'block';
             categoryNameInput.focus(); // Set focus to the input field
        }


         // Funkcia na otvorenie mod√°lu skupiny (pre pridanie alebo √∫pravu)
        async function openGroupModal(groupId = null, groupData = null) { // groupId is composite ID
             if (!groupModal) { console.error("Group modal element not found!"); return; }
             if (!groupForm) { console.error("Group form element not found!"); return; }
             if (!groupCategorySelect) { console.error("Group category select element not found!"); return; }
             if (!groupNameInput) { console.error("Group name input element not found!"); return; }
             if (!groupModalTitle) { console.error("Group modal title element not found!"); return; }
             if (!groupFormSubmitButton) { console.error("Group form submit button element not found!"); return; } // Check submit button


             groupForm.reset(); // Reset form fields
             editingGroupId = groupId; // Store ID if editing

             // V≈ædy napl≈à select kateg√≥ri√≠
             // Ak editujeme, selectCategory bude disabled a nastaven√Ω na aktu√°lnu kateg√≥riu skupiny
             // Ak prid√°vame, selectCategory bude enabled a s predvolenou mo≈ænos≈•ou
             await populateCategorySelect(groupCategorySelect, true, groupData ? groupData.categoryId : null);


             if (groupId && groupData) {
                 // Edit mode
                 groupModalTitle.textContent = 'Upravi≈• Skupinu';
                 groupCategorySelect.value = groupData.categoryId;
                 groupNameInput.value = groupData.name;

                 // V edit m√≥de nedovol√≠me meni≈• kateg√≥riu skupiny
                 groupCategorySelect.disabled = true;
                 groupNameInput.readOnly = false; // N√°zov skupiny m√¥≈æeme zmeni≈•

                 groupFormSubmitButton.textContent = 'Ulo≈æi≈• zmeny';

             } else {
                 // Add mode
                 groupModalTitle.textContent = 'Prida≈• Skupinu';
                 groupCategorySelect.disabled = false; // Povol√≠me v√Ωber kateg√≥rie
                 groupNameInput.readOnly = false;
                 groupFormSubmitButton.textContent = 'Ulo≈æi≈• Skupinu';
             }

             groupModal.style.display = 'block';
              // Nastav focus na kateg√≥riu alebo n√°zov skupiny
              if (groupCategorySelect && !groupCategorySelect.disabled) {
                 groupCategorySelect.focus();
              } else if (groupNameInput) {
                 groupNameInput.focus();
              }

         }

          // Funkcia na otvorenie mod√°lu klubu (pre priradenie do skup√≠n ALEBO √∫pravu priraden√©ho/nepriraden√©ho)
         // clubId je auto-generovan√© ID dokumentu
         async function openClubModal(clubId = null, clubData = null) { // clubId is auto-generated ID
             // --- DEBUG LOG: Check function call arguments ---
             console.log('openClubModal called. clubId:', clubId, 'clubData:', clubData);
             console.log('Checking DOM elements at start of openClubModal...'); // New log
             // PRIDAN√â KONTROLY EXISTENCIE DOM ELEMENTOV NA ZAƒåIATKU FUNKCIE
              if (!clubModal) { console.error("FATAL ERROR: clubModal element not found!"); return; }
              if (!clubForm) { console.error("FATAL ERROR: clubForm element not found!"); return; }
              if (!clubModalTitle) { console.error("FATAL ERROR: clubModalTitle element not found!"); return; }
              if (!clubFormSubmitButton) { console.error("FATAL ERROR: clubFormSubmitButton element not found!"); return; }
              if (!unassignedClubSelectContainer) { console.error("FATAL ERROR: unassignedClubSelectContainer element not found!"); return; }
              if (!unassignedClubSelect) { console.error("FATAL ERROR: unassignedClubSelect element not found!"); return; }
              if (!clubNameInputContainer) { console.error("FATAL ERROR: clubNameInputContainer element not found!"); return; }
              if (!clubNameInput) { console.error("FATAL ERROR: clubNameInput element not found!"); return; }
              if (!clubCategorySelect) { console.error("FATAL ERROR: clubCategorySelect element not found!"); return; }
              if (!clubGroupSelect) { console.error("FATAL ERROR: clubGroupSelect element not found!"); return; }
              if (!orderInputContainer) { console.error("FATAL ERROR: orderInputContainer element not found!"); return; }
              if (!orderInGroupInput) { console.error("FATAL ERROR: orderInGroupInput element not found!"); return; }

              console.log('All required DOM elements for clubModal found.'); // Confirmation log


              // --- END DEBUG LOG ---

               // Clear any previous validation messages in the form
             const validationMessages = clubForm.querySelectorAll('.validation-message');
             validationMessages.forEach(msg => msg.textContent = '');


             clubForm.reset(); // Reset form fields (will reset selects too)
             editingClubId = clubId; // Store ID if editing

              // Reset visibility of name input vs select and order input
             unassignedClubSelectContainer.style.display = 'block'; // Default to showing select for add-assign
             clubNameInputContainer.style.display = 'none';
             orderInputContainer.style.display = 'none'; // Hide order input by default

              // Reset group select visibility and disabled state
             clubGroupSelect.parentElement.style.display = 'block'; // Default to showing group select parent
             clubGroupSelect.disabled = true; // Disable group select initially


              // Populate the category select in the club modal
              // In add-assign mode, selectedCategoryId is null
              // In edit mode, we pass the clubData.categoryId
             await populateCategorySelect(clubCategorySelect, true, clubData ? clubData.categoryId : null);


             if (clubId && clubData) {
                // Edit mode
                currentClubModalMode = 'edit';

                 console.log("Opening club modal in edit mode for club ID:", clubId, "Data:", clubData);

                 clubModalTitle.textContent = 'Upravi≈• t√≠m'; // Specific title
                 clubFormSubmitButton.textContent = 'Ulo≈æi≈• zmeny'; // Specific button text

                 // Hide select for unassigned clubs, show name input (read-only)
                 unassignedClubSelectContainer.style.display = 'none';
                 clubNameInputContainer.style.display = 'block';
                 clubNameInput.value = clubData.name || '';
                 clubNameInput.readOnly = true; // Cannot change name in edit mode (only category/group/order)


                 // Set the category select value and populate groups for that category
                 if (clubCategorySelect) {
                      clubCategorySelect.value = clubData.categoryId || '';
                      clubCategorySelect.disabled = true; // Cannot change category in edit mode
                       // Populate and enable group select based on the club's category
                       if (clubData.categoryId) {
                           await populateGroupSelect(clubGroupSelect, clubData.categoryId, true, clubData.groupId);
                           clubGroupSelect.disabled = false; // Enable group select
                       } else {
                           console.warn("Edit mode: clubData has no categoryId.");
                            clubGroupSelect.disabled = true; // Keep disabled if no category
                            clubGroupSelect.innerHTML = '<option value="">-- Kateg√≥ria nezn√°ma --</option>';
                       }

                 } else {
                    console.error("FATAL ERROR: clubCategorySelect not found in edit mode!");
                 }


                 // Show and set the order input value
                 orderInputContainer.style.display = 'block';
                 orderInGroupInput.value = clubData.orderInGroup || '';
                 orderInGroupInput.disabled = false; // Order can be changed


             } else { // Add mode (Assigning an UNASSIGNED club to a group)
                currentClubModalMode = 'add-assign';
                // editingClubId is already null by default

                 console.log("Opening club modal in add-assign mode.");

                 // V add-assign m√≥de zobrazujeme select pre v√Ωber nepriraden√©ho klubu
                unassignedClubSelectContainer.style.display = 'block';
                clubNameInputContainer.style.display = 'none'; // N√°zov sa vezme zo selectu
                 clubNameInput.readOnly = false; // Reset readOnly state

                 // Order input by default hidden in add-assign mode, only shown when category/group is chosen
                 orderInputContainer.style.display = 'none';
                 orderInGroupInput.disabled = true; // Disable order input initially


                 // Populate the unassigned clubs select
                 await loadUnassignedClubsForSelect(); // This function populates unassignedClubSelect

                 // DEBUG log from previous attempts - kept for context
                 console.log('DEBUG: Value of clubModalTitle right before setting textContent:', clubModalTitle);


                clubModalTitle.textContent = 'Priradi≈• t√≠m do skupiny'; // Tento riadok bol predt√Ωm bl√≠zko chyby

                // --- P√îVODN√ù RIADOK 1356, KTOR√ù SP√îSOBOVAL CHYBU ---
                // Pridan√° bezpeƒçnostn√° kontrola je tesne nad t√Ωmto riadkom na riadku ~1371 (v star≈°ej verzii)
                // Teraz je tu:
                // --- PRIDAN√Å BEZPEƒåNOS≈§N√Å KONTROLA Z PREDCH√ÅDZAJ√öCEJ √öPRAVY ---
                if (!clubFormSubmitButton) {
                    console.error('FATAL ERROR: clubFormSubmitButton is null in add mode!');
                    // U≈æ sme logovali na zaƒçiatku, ale pre istotu zopakujeme a vr√°time sa
                    return; // Zastav√≠me funkciu, ak tlaƒçidlo neexistuje
                }
                // --- KONIEC KONTROLY ---

                // Debug log pred problematick√Ωm riadkom
                console.log('DEBUG: Value of clubFormSubmitButton right before setting textContent:', clubFormSubmitButton); // Pridana logovacia sprava pre submit button (teraz riadok ~1370)

                clubFormSubmitButton.textContent = 'Priradi≈•'; // P√¥vodn√Ω problemov√Ω riadok (teraz riadok ~1371)


                // Skupinov√Ω select je predvolene zapnut√Ω, ale disabled
                clubGroupSelect.parentElement.style.display = 'block'; // Ensure the parent div is visible
                clubGroupSelect.disabled = true;

                // Category select is used to filter groups - must be enabled and populated
                 if (clubCategorySelect) {
                       clubCategorySelect.disabled = false;
                       // populateCategorySelect bola volan√° na zaƒçiatku funkcie, len sa uist√≠me, ≈æe je povolen√°
                       // await populateCategorySelect(clubCategorySelect, true); // Netreba vola≈• znovu, u≈æ bola volan√° na zaƒçiatku
                  } else {
                       console.error("FATAL ERROR: clubCategorySelect not found in add mode!");
                  }
             }

             // Uist√≠me sa, ≈æe mod√°l je viditeƒæn√Ω (ak nebol vr√°ten√Ω kv√¥li chybe)
             clubModal.style.display = 'block';


             // Set focus to the first relevant input/select
             // Priorita: unassignedClubSelect (add-assign) -> clubNameInput (edit) -> clubCategorySelect
              if (currentClubModalMode === 'add-assign' && unassignedClubSelect) {
                  unassignedClubSelect.focus();
              } else if (currentClubModalMode === 'edit' && clubNameInput) {
                  clubNameInput.focus();
              } else if (clubCategorySelect && !clubCategorySelect.disabled) { // Fallback focus if enabled
                  clubCategorySelect.focus();
              } else {
                   // Ak sa nepodarilo nastavi≈• focus, zalogujeme to
                   console.warn("Could not set focus in club modal.");
              }


         } // Koniec openClubModal


         // Funkcia na otvorenie mod√°lu pre hromadn√© vytvorenie t√≠mov
         async function openTeamCreationModal() {
             if (!teamCreationModal) { console.error("Team Creation modal element not found!"); return; }
             if (!teamCreationForm) { console.error("Team Creation form element not found!"); return; }
             if (!teamCategoryCountContainer) { console.error("teamCategoryCountContainer element not found!"); return; }
             if (!addCategoryCountPairButton) { console.error("addCategoryCountPairButton element not found!"); return; }
              if (!baseTeamNameInput) { console.error("baseTeamNameInput element not found!"); return; }


             teamCreationForm.reset(); // Reset form (base name)
             // Clear previous category/count pairs except the first one
             teamCategoryCountContainer.innerHTML = '';
             addCategoryCountPair(false); // Add the first pair (don't focus immediately)


              // Ensure categories are loaded before populating the first select
             if (allAvailableCategories.length === 0) {
                  console.log("Kateg√≥rie nie s√∫ naƒç√≠tan√© pre Team Creation Modal, naƒç√≠tavam...");
                 await loadAllCategoriesForDynamicSelects(); // Toto vol√° updateDynamicCategorySelects, ƒço aktualizuje aj selecty v teamCreationModal
             } else {
                  // Ak s√∫ kateg√≥rie u≈æ naƒç√≠tan√©, len aktualizujeme dynamick√© selecty (vol√° sa aj v addCategoryCountPair)
                  updateDynamicCategorySelects();
             }


              // Reset message area
              if(teamCreationMessageArea) {
                  teamCreationMessageArea.style.display = 'none';
                  teamCreationMessageArea.className = 'message-area'; // Reset classes
                  teamCreationMessageArea.textContent = '';
              }


             teamCreationModal.style.display = 'block';
             baseTeamNameInput.focus(); // Set focus to the base name input
         }


         // Funkcia na otvorenie mod√°lu pre spr√°vu individu√°lnych t√≠mov
         async function openManageTeamsModal(baseTeamName) {
             if (!manageTeamsModal) { console.error("Manage Teams modal element not found!"); return; }
             if (!baseTeamNameInModalSpan) { console.error("baseTeamNameInModalSpan element not found!"); return; }
              if (!teamsListInModalDiv) { console.error("teamsListInModalDiv element not found!"); return; }


             baseTeamNameInModalSpan.textContent = baseTeamName; // Set the base name in the modal title
             teamsListInModalDiv.innerHTML = 'Naƒç√≠tavam t√≠my...'; // Loading message

             try {
                 // Naƒç√≠taj v≈°etky kluby s dan√Ωm baseTeamName
                 const q = query(clubsCollectionRef, where("baseTeamName", "==", baseTeamName));
                 const querySnapshot = await getDocs(q);
                 const teams = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                 console.log(`Naƒç√≠tan√© individu√°lne t√≠my pre z√°kladn√Ω n√°zov "${baseTeamName}":`, teams);

                 teamsListInModalDiv.innerHTML = ''; // Clear loading message

                 if (teams.length === 0) {
                     teamsListInModalDiv.textContent = '≈Ωiadne t√≠my pre tento n√°zov nen√°jden√©.';
                 } else {
                     // Zoskup t√≠my podƒæa kateg√≥rie
                     const teamsGroupedByCategory = teams.reduce((acc, team) => {
                         const categoryName = allAvailableCategories.find(cat => cat.id === team.categoryId)?.name || 'Nezn√°ma kateg√≥ria';
                         if (!acc[categoryName]) {
                             acc[categoryName] = [];
                         }
                         acc[categoryName].push(team);
                         return acc;
                     }, {});

                     // Zobraz t√≠my v zoskupen√Ωch zoznamoch
                     for (const categoryName in teamsGroupedByCategory) {
                         const categoryTeams = teamsGroupedByCategory[categoryName];
                         const categoryHeading = document.createElement('h3');
                         categoryHeading.textContent = categoryName;
                         teamsListInModalDiv.appendChild(categoryHeading);

                         const ul = document.createElement('ul');
                         ul.style.listStyle = 'none'; // Remove default list styles
                         ul.style.padding = '0'; // Remove default padding

                         categoryTeams.forEach(team => {
                             const li = document.createElement('li');
                             li.classList.add('team-list-item'); // Apply flex styles
                             li.dataset.clubId = team.id; // Store club ID

                              const teamNameSpan = document.createElement('span');
                              teamNameSpan.textContent = team.name;
                              li.appendChild(teamNameSpan);


                             // Upravi≈• a Odstr√°ni≈• tlaƒçidl√°
                             const editButton = document.createElement('button');
                             editButton.textContent = 'Upravi≈•';
                             editButton.classList.add('edit-team-button');
                             editButton.addEventListener('click', () => {
                                 // TODO: Implement editing individual team (e.g., assigning to group/order)
                                 // This would likely open the clubModal in edit mode
                                 console.log("Clicked Edit for team:", team.name, team.id);
                                  // Find the full club data from allAvailableClubs or refetch if not loaded
                                 const fullClubData = allAvailableClubs.find(club => club.id === team.id) || team; // Use team data if not in allAvailableClubs yet
                                  openClubModal(team.id, fullClubData); // Open club modal in edit mode
                                  closeAllModals(); // Close manage teams modal first
                             });

                             const deleteButton = document.createElement('button');
                             deleteButton.textContent = 'Odstr√°ni≈•';
                             deleteButton.classList.add('unassign-team-button'); // Using unassign style, but it's a permanent delete here
                             deleteButton.addEventListener('click', async () => {
                                 if (confirm(`Naozaj chcete odstr√°ni≈• t√≠m "${team.name}"?`)) {
                                     console.log("Clicked Delete for team:", team.name, team.id);
                                     await deleteClub(team.id); // Implement deleteClub function
                                     // Po odstr√°nen√≠ refreshni zoznam t√≠mov v mod√°le
                                     openManageTeamsModal(baseTeamName); // Reload the modal content
                                      // Tie≈æ refreshni zoznam nepriraden√Ωch klubov v #timy-do-skupin sekcii
                                     loadUnassignedClubs();
                                     // A zoznam v≈°etk√Ωch t√≠mov v #zoznam-timov sekcii
                                      loadTeamsList();
                                 }
                             });

                              // Group button container if needed, or append directly
                              li.appendChild(editButton);
                              li.appendChild(deleteButton);

                             ul.appendChild(li);
                         });
                         teamsListInModalDiv.appendChild(ul);
                     }
                 }


             } catch (e) {
                 console.error(`Chyba pri naƒç√≠tan√≠ individu√°lnych t√≠mov pre "${baseTeamName}": `, e);
                 teamsListInModalDiv.textContent = 'Chyba pri naƒç√≠tan√≠ t√≠mov.';
             }


             manageTeamsModal.style.display = 'block';
              // Focus is not typically set on this modal automatically
         }


         // === Funkcie pre CRUD oper√°cie (Create, Read, Update, Delete) ===

         // Kategor√≠ÃÅe
         async function loadCategories() {
             const categoriesTableBody = document.querySelector('#categoriesTable tbody');
             if (!categoriesTableBody) { console.error("Categories table body not found!"); return; }

             categoriesTableBody.innerHTML = '<tr><td colspan="2">Naƒç√≠tavam kateg√≥rie...</td></tr>'; // Loading message

             try {
                 const querySnapshot = await getDocs(query(categoriesCollectionRef));
                 const categories = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                 console.log("Naƒç√≠tan√© kateg√≥rie pre tabuƒæku:", categories);

                 categoriesTableBody.innerHTML = ''; // Clear loading message

                 if (categories.length === 0) {
                     categoriesTableBody.innerHTML = '<tr><td colspan="2">≈Ωiadne kateg√≥rie nen√°jden√©.</td></tr>';
                 } else {
                     categories.forEach(category => {
                         const row = categoriesTableBody.insertRow();
                         row.insertCell(0).textContent = category.name;

                         const actionsCell = row.insertCell(1);

                         const editButton = document.createElement('button');
                         editButton.textContent = 'Upravi≈•';
                         editButton.addEventListener('click', () => {
                             openCategoryModal(category.id, category); // Open modal for editing
                         });

                         const deleteButton = document.createElement('button');
                         deleteButton.textContent = 'Vymaza≈•';
                         deleteButton.addEventListener('click', async () => {
                             if (confirm(`Naozaj chcete vymaza≈• kateg√≥riu "${category.name}"? (T√Ωm sa vyma≈æ√∫ aj v≈°etky skupiny a t√≠my v tejto kateg√≥rii!)`)) {
                                 await deleteCategory(category.id);
                                 loadCategories(); // Refresh table
                             }
                         });

                         actionsCell.appendChild(editButton);
                         actionsCell.appendChild(deleteButton);
                     });
                 }

                  // Po naƒç√≠tan√≠ kateg√≥ri√≠ pre tabuƒæku, znova naƒç√≠tame aj pre dynamick√© selecty
                  // (ak u≈æ neboli naƒç√≠tan√© na zaƒçiatku hashchange)
                 loadAllCategoriesForDynamicSelects(); // Toto vol√° updateDynamicCategorySelects

             } catch (e) {
                 console.error("Chyba pri naƒç√≠tan√≠ kateg√≥ri√≠: ", e);
                 categoriesTableBody.innerHTML = '<tr><td colspan="2">Chyba pri naƒç√≠tan√≠ kateg√≥ri√≠.</td></tr>';
             }
         }

         async function saveCategory(id, data) {
             try {
                 if (id) {
                     // Update existing
                     await updateDoc(doc(categoriesCollectionRef, id), data);
                     console.log("Kateg√≥ria √∫spe≈°ne aktualizovan√°:", id);
                 } else {
                     // Add new
                     const docRef = await addDoc(categoriesCollectionRef, data);
                     console.log("Nov√° kateg√≥ria √∫spe≈°ne pridan√° s ID:", docRef.id);
                 }
                 // Po ulo≈æen√≠ znova naƒç√≠tame kateg√≥rie pre v≈°etky dynamick√© selecty
                 loadAllCategoriesForDynamicSelects(); // Toto vol√° updateDynamicCategorySelects
             } catch (e) {
                 console.error("Chyba pri ukladan√≠ kateg√≥rie: ", e);
                  // Tu by sme mohli prida≈• zobrazenie chybovej spr√°vy pre pou≈æ√≠vateƒæa
                 alert("Nastala chyba pri ukladan√≠ kateg√≥rie.");
             }
         }

         async function deleteCategory(id) {
             try {
                 // Pri mazan√≠ kateg√≥rie je potrebn√© zv√°≈æi≈• mazanie s√∫visiacich skup√≠n a t√≠mov
                 // Toto by malo by≈• implementovan√© ako transakcia alebo cloud funkcia pre robustnos≈•
                 // Pre zjednodu≈°enie zatiaƒæ ma≈æeme len samotn√∫ kateg√≥riu, ale v re√°lnej aplik√°cii by bolo nutn√© vyrie≈°i≈• aj skupiny a t√≠my

                 // Jednoduch√© mazanie len dokumentu kateg√≥rie (potrebn√© roz≈°√≠ri≈•)
                 await deleteDoc(doc(categoriesCollectionRef, id));
                 console.log("Kateg√≥ria √∫spe≈°ne vymazan√°:", id);

                 // Po zmazan√≠ kateg√≥rie, znova naƒç√≠tame kateg√≥rie pre v≈°etky dynamick√© selecty
                 // a tie≈æ znova naƒç√≠tame skupiny a kluby, aby sa zohƒæadnili zmeny
                 loadAllCategoriesForDynamicSelects(); // Toto vol√° updateDynamicCategorySelects
                 loadGroups(); // Znova naƒç√≠ta skupiny
                 loadUnassignedClubs(); // Znova naƒç√≠ta nepriraden√© kluby
                 loadAssignedClubs(); // Znova naƒç√≠ta priraden√© kluby (tie v zmazanej kateg√≥rii zmizn√∫)
                 loadTeamsList(); // Znova naƒç√≠ta zoznam t√≠mov


             } catch (e) {
                 console.error("Chyba pri mazan√≠ kateg√≥rie: ", e);
                 alert("Nastala chyba pri mazan√≠ kateg√≥rie.");
             }
         }


         // Skupiny
         async function loadGroups() {
             const groupsTableBody = document.querySelector('#groupsTable tbody');
             if (!groupsTableBody) { console.error("Groups table body not found!"); return; }

             groupsTableBody.innerHTML = '<tr><td colspan="3">Naƒç√≠tavam skupiny...</td></tr>'; // Loading message

             try {
                 // Pre zobrazenie skup√≠n potrebujeme aj n√°zvy kateg√≥ri√≠,
                 // tak≈æe najprv naƒç√≠tame kateg√≥rie, ak e≈°te nie s√∫
                 if (allAvailableCategories.length === 0) {
                      await loadAllCategoriesForDynamicSelects(); // Toto vol√° updateDynamicCategorySelects
                 }

                 // Naƒç√≠tame skupiny z podkolekci√≠ 'groups' pod ka≈æd√Ωm dokumentom kateg√≥rie
                 let allGroups = [];
                 for (const category of allAvailableCategories) {
                      const groupQuery = query(collection(categoriesCollectionRef, category.id, 'groups'));
                      const querySnapshot = await getDocs(groupQuery);
                     querySnapshot.docs.forEach(doc => {
                         allGroups.push({
                             id: doc.id, // ID dokumentu skupiny
                             categoryId: category.id, // ID rodiƒçovskej kateg√≥rie
                             categoryName: category.name, // N√°zov rodiƒçovskej kateg√≥rie
                             ...doc.data() // Ostatn√© d√°ta skupiny (napr. name)
                         });
                     });
                 }


                 console.log("Naƒç√≠tan√© skupiny pre tabuƒæku:", allGroups);

                 groupsTableBody.innerHTML = ''; // Clear loading message

                 if (allGroups.length === 0) {
                     groupsTableBody.innerHTML = '<tr><td colspan="3">≈Ωiadne skupiny nen√°jden√©.</td></tr>';
                 } else {
                      // Voliteƒæn√©: Zotrieƒè skupiny podƒæa kateg√≥rie a potom podƒæa n√°zvu skupiny
                     allGroups.sort((a, b) => {
                          const categoryCompare = a.categoryName.localeCompare(b.categoryName);
                         if (categoryCompare !== 0) return categoryCompare;
                         return a.name.localeCompare(b.name);
                     });


                     allGroups.forEach(group => {
                         const row = groupsTableBody.insertRow();
                         row.insertCell(0).textContent = group.categoryName; // Zobraz n√°zov kateg√≥rie
                         row.insertCell(1).textContent = group.name; // Zobraz n√°zov skupiny

                         const actionsCell = row.insertCell(2);

                         const editButton = document.createElement('button');
                         editButton.textContent = 'Upravi≈•';
                         editButton.addEventListener('click', () => {
                             // Pri √∫prave skupiny odovzd√°me len ID skupiny (doc.id) a cel√© group d√°ta (vr√°tane categoryId)
                             openGroupModal(group.id, group); // Open modal for editing
                         });


                         const deleteButton = document.createElement('button');
                         deleteButton.textContent = 'Vymaza≈•';
                         deleteButton.addEventListener('click', async () => {
                             if (confirm(`Naozaj chcete vymaza≈• skupinu "${group.name}" v kateg√≥rii "${group.categoryName}"? (T√Ωm sa zru≈°√≠ priradenie v≈°etk√Ωch t√≠mov z tejto skupiny!)`)) {
                                 // Pri mazan√≠ skupiny je potrebn√© zv√°≈æi≈• odpriradenie t√≠mov z tejto skupiny
                                 await deleteGroup(group.categoryId, group.id); // Potrebujeme aj ID kateg√≥rie pre cestu k podkolekcii
                                 loadGroups(); // Refresh table
                             }
                         });

                         actionsCell.appendChild(editButton);
                         actionsCell.appendChild(deleteButton);
                     });
                 }


             } catch (e) {
                 console.error("Chyba pri naƒç√≠tan√≠ skup√≠n: ", e);
                 groupsTableBody.innerHTML = '<tr><td colspan="3">Chyba pri naƒç√≠tan√≠ skup√≠n.</td></tr>';
             }
         }

         async function saveGroup(categoryId, groupId, groupData) { // categoryId needed for path
             try {
                  // Referencia na kolekciu skup√≠n POD konkr√©tnou kateg√≥riou
                 const groupsSubcollectionRef = collection(categoriesCollectionRef, categoryId, 'groups');

                 if (groupId) {
                     // Update existing (need full path including categoryId)
                     await updateDoc(doc(groupsSubcollectionRef, groupId), groupData);
                     console.log("Skupina √∫spe≈°ne aktualizovan√°:", groupId, "v kateg√≥rii:", categoryId);
                 } else {
                     // Add new
                     const docRef = await addDoc(groupsSubcollectionRef, groupData);
                     console.log("Nov√° skupina √∫spe≈°ne pridan√° s ID:", docRef.id, "v kateg√≥rii:", categoryId);
                 }
                  // Po ulo≈æen√≠ znova naƒç√≠tame skupiny pre tabuƒæku a pr√≠padne aj kluby (ak boli priraden√©)
                 loadGroups();
                 loadUnassignedClubs(); // Ak by sa nejak√© t√≠my zru≈°ili/upravili pri √∫prave skupiny (nemalo by), znova ich naƒç√≠tame
                 loadAssignedClubs(); // Znova naƒç√≠ta priraden√© kluby (ak by sa nieƒço zmenilo)

             } catch (e) {
                 console.error("Chyba pri ukladan√≠ skupiny: ", e);
                  // Tu by sme mohli prida≈• zobrazenie chybovej spr√°vy pre pou≈æ√≠vateƒæa
                 alert("Nastala chyba pri ukladan√≠ skupiny.");
             }
         }

         async function deleteGroup(categoryId, groupId) { // categoryId needed for path
              try {
                  // Referencia na konkr√©tnu skupinu
                 const groupDocRef = doc(categoriesCollectionRef, categoryId, 'groups', groupId);

                  // Pred vymazan√≠m skupiny by sme mali "odpriradi≈•" v≈°etky t√≠my, ktor√© boli v tejto skupine
                 const clubsInGroupQuery = query(clubsCollectionRef, where("groupId", "==", groupId));
                 const querySnapshot = await getDocs(clubsInGroupQuery);
                 const batch = writeBatch(db); // Pou≈æijeme batch pre hromadn√∫ oper√°ciu

                  querySnapshot.docs.forEach((clubDoc) => {
                      // Aktualizujeme dokument klubu - nastav√≠me groupId a orderInGroup na null
                      const clubRef = doc(clubsCollectionRef, clubDoc.id);
                      batch.update(clubRef, {
                          groupId: null,
                          orderInGroup: null
                      });
                  });

                 // Vykon√°me batch oper√°ciu na odpriradenie klubov
                 await batch.commit();
                 console.log(`√öspe≈°ne odpriraden√Ωch ${querySnapshot.size} t√≠mov zo skupiny ${groupId}.`);


                  // Teraz m√¥≈æeme vymaza≈• dokument skupiny
                 await deleteDoc(groupDocRef);
                 console.log("Skupina √∫spe≈°ne vymazan√°:", groupId);

                 // Po zmazan√≠ skupiny, znova naƒç√≠tame skupiny pre tabuƒæku
                 loadGroups();
                  // Znova naƒç√≠tame aj nepriraden√© a priraden√© kluby, aby sa zmeny zohƒæadnili
                 loadUnassignedClubs();
                 loadAssignedClubs();

              } catch (e) {
                 console.error("Chyba pri mazan√≠ skupiny: ", e);
                 alert("Nastala chyba pri mazan√≠ skupiny.");
              }
         }


        // T√≠my (Clubs)
        async function loadTeamsList() {
             const teamsListTableBody = document.querySelector('#teamsListTable tbody');
              if (!teamsListTableBody) { console.error("Teams List table body not found!"); return; }

             teamsListTableBody.innerHTML = '<tr><td colspan="4">Naƒç√≠tavam t√≠my...</td></tr>'; // Loading message

             try {
                 // Naƒç√≠taj v≈°etky kluby
                 const querySnapshot = await getDocs(query(clubsCollectionRef));
                 const clubs = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                 console.log("Naƒç√≠tan√© v≈°etky t√≠my pre zoznam:", clubs);

                 teamsListTableBody.innerHTML = ''; // Clear loading message

                 if (clubs.length === 0) {
                     teamsListTableBody.innerHTML = '<tr><td colspan="4">≈Ωiadne t√≠my nen√°jden√©.</td></tr>';
                 } else {
                     // Zoskup t√≠my podƒæa baseTeamName a categoryId a spoƒç√≠taj ich
                     const teamsSummary = clubs.reduce((acc, club) => {
                         const key = `${club.baseTeamName || 'Nezn√°my N√°zov'} - ${club.categoryId || 'Nezn√°ma Kateg√≥ria'}`;
                         if (!acc[key]) {
                             acc[key] = {
                                 baseTeamName: club.baseTeamName || 'Nezn√°my N√°zov',
                                 categoryId: club.categoryId || 'Nezn√°ma Kateg√≥ria',
                                 count: 0,
                                 // Ulo≈æ√≠me si ID aspo≈à jedn√©ho klubu z tejto skupiny pre akcie
                                 sampleClubId: club.id
                             };
                         }
                         acc[key].count++;
                         return acc;
                     }, {});

                     // Prevedieme zhrnutie na pole pre jednoduch≈°ie zobrazenie v tabuƒæke
                     const teamsSummaryArray = Object.values(teamsSummary);

                      // Voliteƒæn√©: Zotrieƒè podƒæa n√°zvu t√≠mu a potom kateg√≥rie
                      teamsSummaryArray.sort((a, b) => {
                         const nameCompare = a.baseTeamName.localeCompare(b.baseTeamName);
                         if (nameCompare !== 0) return nameCompare;
                          // Potrebujeme n√°zov kateg√≥rie pre triedenie, nie ID
                          const categoryNameA = allAvailableCategories.find(cat => cat.id === a.categoryId)?.name || 'Nezn√°ma Kateg√≥ria';
                          const categoryNameB = allAvailableCategories.find(cat => cat.id === b.categoryId)?.name || 'Nezn√°ma Kateg√≥ria';
                          return categoryNameA.localeCompare(categoryNameB);
                      });


                     teamsSummaryArray.forEach(summary => {
                         const row = teamsListTableBody.insertRow();
                         row.insertCell(0).textContent = summary.baseTeamName;
                          // Zobraz n√°zov kateg√≥rie namiesto ID
                         const categoryName = allAvailableCategories.find(cat => cat.id === summary.categoryId)?.name || 'Nezn√°ma Kateg√≥ria';
                         row.insertCell(1).textContent = categoryName;
                         row.insertCell(2).textContent = summary.count;

                         const actionsCell = row.insertCell(3);

                         // Tlaƒçidlo na "Spravova≈•" (otvor√≠ nov√Ω mod√°l so zoznamom individu√°lnych t√≠mov)
                         const manageButton = document.createElement('button');
                         manageButton.textContent = 'Spravova≈•';
                         manageButton.addEventListener('click', () => {
                             // Otvor nov√Ω mod√°l na spr√°vu individu√°lnych t√≠mov pre tento baseTeamName
                             openManageTeamsModal(summary.baseTeamName);
                         });

                          // TODO: Tlaƒçidlo na vymazanie CELEJ skupiny t√≠mov pod t√Ωmto n√°zvom a kateg√≥riou
                         // Vy≈æadovalo by to batch oper√°ciu na vymazanie v≈°etk√Ωch klubov s dan√Ωm baseTeamName a categoryId
                          const deleteAllButton = document.createElement('button');
                          deleteAllButton.textContent = 'Vymaza≈• V≈°etky';
                           deleteAllButton.style.backgroundColor = '#dc3545'; // Red style
                           deleteAllButton.style.marginLeft = '10px';
                          deleteAllButton.addEventListener('click', async () => {
                               if (confirm(`Naozaj chcete vymaza≈• V≈†ETKY t√≠my s n√°zvom "${summary.baseTeamName}" v kateg√≥rii "${categoryName}"?`)) {
                                   console.log(`Mazanie v≈°etk√Ωch t√≠mov s n√°zvom "${summary.baseTeamName}" v kateg√≥rii "${categoryName}"`);
                                   await deleteAllClubsByBaseNameAndCategory(summary.baseTeamName, summary.categoryId); // Implement this function
                                    loadTeamsList(); // Refresh table
                                    loadUnassignedClubs(); // Refresh unassigned list as some might become unassigned if they were assigned
                                    loadAssignedClubs(); // Refresh assigned list
                               }
                          });


                         actionsCell.appendChild(manageButton);
                          actionsCell.appendChild(deleteAllButton);
                     });
                 }

             } catch (e) {
                 console.error("Chyba pri naƒç√≠tan√≠ zoznamu t√≠mov: ", e);
                 teamsListTableBody.innerHTML = '<tr><td colspan="4">Chyba pri naƒç√≠tan√≠ zoznamu t√≠mov.</td></tr>';
             }
        }

        async function deleteAllClubsByBaseNameAndCategory(baseTeamName, categoryId) {
             try {
                 const q = query(clubsCollectionRef,
                     where("baseTeamName", "==", baseTeamName),
                     where("categoryId", "==", categoryId) // Filter also by categoryId
                 );
                 const querySnapshot = await getDocs(q);
                 const batch = writeBatch(db);

                 querySnapshot.docs.forEach((clubDoc) => {
                     const clubRef = doc(clubsCollectionRef, clubDoc.id);
                     batch.delete(clubRef); // Add delete operation to the batch
                 });

                 await batch.commit();
                 console.log(`√öspe≈°ne vymazan√Ωch ${querySnapshot.size} t√≠mov s n√°zvom "${baseTeamName}" v kateg√≥rii "${categoryId}".`);

             } catch (e) {
                 console.error(`Chyba pri mazan√≠ v≈°etk√Ωch t√≠mov s n√°zvom "${baseTeamName}" v kateg√≥rii "${categoryId}": `, e);
                 alert(`Nastala chyba pri mazan√≠ t√≠mov s n√°zvom "${baseTeamName}" v kateg√≥rii "${categoryId}".`);
             }
        }


         async function saveClub(id, data) {
              try {
                 if (id) {
                     // Update existing
                     await updateDoc(doc(clubsCollectionRef, id), data);
                     console.log("Klub √∫spe≈°ne aktualizovan√Ω:", id);
                 } else {
                     // Add new club (should only be used for assigning an unassigned club)
                     // For creating new clubs, use createTeams function
                     // In add-assign mode, we are updating an existing unassigned club
                     console.error("SaveClub v add mode by nemal prid√°va≈• nov√Ω klub, len aktualizova≈• existuj√∫ci nepriraden√Ω!");
                     return; // Prevent adding new clubs via saveClub in this context
                 }
                  // Po ulo≈æen√≠ klubu (priradenie/√∫prava), znova naƒç√≠tame zoznamy klubov
                 loadUnassignedClubs(); // Naƒç√≠ta nepriraden√©
                 loadAssignedClubs(); // Naƒç√≠ta priraden√©
                 loadTeamsList(); // Aktualizuje zoznam t√≠mov (zmen√≠ sa status priradenia)

              } catch (e) {
                 console.error("Chyba pri ukladan√≠ klubu: ", e);
                 alert("Nastala chyba pri ukladan√≠ klubu.");
              }
         }

          // Funkcia na odpriradenie t√≠mu zo skupiny
         async function unassignClub(clubId) {
              try {
                 const clubRef = doc(clubsCollectionRef, clubId);
                  await updateDoc(clubRef, {
                      groupId: null,
                      orderInGroup: null // Also remove order when unassigned
                  });
                  console.log("Klub √∫spe≈°ne odpriraden√Ω:", clubId);

                  // Po odpriraden√≠ znova naƒç√≠tame zoznamy klubov
                 loadUnassignedClubs(); // T√≠m sa vr√°ti do zoznamu nepriraden√Ωch
                 loadAssignedClubs(); // T√≠m zmizne zo zoznamu priraden√Ωch
                  loadTeamsList(); // Aktualizuje zoznam t√≠mov (zmen√≠ sa status priradenia)

              } catch (e) {
                 console.error("Chyba pri odpriraden√≠ klubu: ", e);
                 alert("Nastala chyba pri odpriraden√≠ klubu.");
              }
         }

          // Funkcia na vymazanie individu√°lneho t√≠mu (klubu)
          async function deleteClub(clubId) {
               try {
                  await deleteDoc(doc(clubsCollectionRef, clubId));
                   console.log("Klub √∫spe≈°ne vymazan√Ω:", clubId);

                  // Po vymazan√≠ znova naƒç√≠tame zoznamy klubov
                   loadUnassignedClubs();
                   loadAssignedClubs();
                   loadTeamsList(); // Aktualizuje zoznam t√≠mov
               } catch (e) {
                   console.error("Chyba pri mazan√≠ klubu: ", e);
                   alert("Nastala chyba pri mazan√≠ klubu.");
               }
          }


         // Funkcia na naƒç√≠tanie nepriraden√Ωch klubov (pre tabuƒæku v #timy-do-skupin sekcii)
         async function loadUnassignedClubs() {
             const unassignedClubsTableBody = document.querySelector('#unassignedClubsTable tbody');
             if (!unassignedClubsTableBody) { console.error("Unassigned clubs table body not found!"); return; }

             unassignedClubsTableBody.innerHTML = '<tr><td colspan="3">Naƒç√≠tavam nepriraden√© t√≠my...</td></tr>'; // Loading message


             try {
                 // Naƒç√≠taj v≈°etky kluby, ktor√© nemaj√∫ groupId
                 const q = query(clubsCollectionRef, where("groupId", "==", null)); // Filter for clubs where groupId is null
                 const querySnapshot = await getDocs(q);
                 const unassignedClubs = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                 console.log("Naƒç√≠tan√© nepriraden√© t√≠my pre tabuƒæku:", unassignedClubs);

                 unassignedClubsTableBody.innerHTML = ''; // Clear loading message

                 if (unassignedClubs.length === 0) {
                     unassignedClubsTableBody.innerHTML = '<tr><td colspan="3">≈Ωiadne nepriraden√© t√≠my nen√°jden√©.</td></tr>';
                 } else {
                     // Pre zobrazenie n√°zvu kateg√≥rie potrebujeme ma≈• naƒç√≠tan√© kateg√≥rie
                     if (allAvailableCategories.length === 0) {
                          await loadAllCategoriesForDynamicSelects(); // Toto vol√° updateDynamicCategorySelects
                     }

                     // Voliteƒæn√©: Zotrieƒè nepriraden√© kluby podƒæa kateg√≥rie a potom n√°zvu
                      unassignedClubs.sort((a, b) => {
                         const categoryNameA = allAvailableCategories.find(cat => cat.id === a.categoryId)?.name || 'Nezn√°ma kateg√≥ria';
                         const categoryNameB = allAvailableCategories.find(cat => cat.id === b.categoryId)?.name || 'Nezn√°ma kateg√≥ria';
                          const categoryCompare = categoryNameA.localeCompare(categoryNameB);
                         if (categoryCompare !== 0) return categoryCompare;
                         return a.name.localeCompare(b.name);
                      });


                     unassignedClubs.forEach(club => {
                         const row = unassignedClubsTableBody.insertRow();
                         row.insertCell(0).textContent = club.name;
                          const categoryName = allAvailableCategories.find(cat => cat.id === club.categoryId)?.name || 'Nezn√°ma kateg√≥ria';
                         row.insertCell(1).textContent = categoryName;

                         const actionsCell = row.insertCell(2);

                         // Tlaƒçidlo "Priradi≈• do skupiny" (otvor√≠ clubModal v add-assign m√≥de pre tento klub)
                         const assignButton = document.createElement('button');
                         assignButton.textContent = 'Priradi≈•';
                         assignButton.addEventListener('click', () => {
                             // Otvor clubModal v add-assign m√≥de pre tento konkr√©tny nepriraden√Ω klub
                             // Odovzd√°me jeho ID a d√°ta
                             openClubModal(club.id, club); // openClubModal bez argumentov otv√°ra MODAL pre NOV√ù nepriraden√Ω, s argumentami pre existuj√∫ci nepriraden√Ω/priraden√Ω
                         });

                         actionsCell.appendChild(assignButton);
                     });
                 }

                 // Po naƒç√≠tan√≠ nepriraden√Ωch klubov, znova napln√≠me select box v club modale (ak je otvoren√Ω alebo sa bude otv√°ra≈•)
                 loadUnassignedClubsForSelect();


             } catch (e) {
                 console.error("Chyba pri naƒç√≠tan√≠ nepriraden√Ωch t√≠mov: ", e);
                 unassignedClubsTableBody.innerHTML = '<tr><td colspan="3">Chyba pri naƒç√≠tan√≠ nepriraden√Ωch t√≠mov.</td></tr>';
             }
         }

         // Funkcia na naƒç√≠tanie priraden√Ωch klubov (pre zobrazenie v #timy-do-skupin sekcii)
         async function loadAssignedClubs() {
              const assignedClubsContainer = document.getElementById('assignedClubsContainer');
              if (!assignedClubsContainer) { console.error("Assigned clubs container not found!"); return; }

             assignedClubsContainer.innerHTML = 'Naƒç√≠tavam priraden√© t√≠my...'; // Loading message

              try {
                 // Naƒç√≠taj v≈°etky kluby, ktor√© maj√∫ groupId (tzn. s√∫ priraden√©)
                 const q = query(clubsCollectionRef, where("groupId", "!=", null)); // Filter for clubs where groupId is NOT null
                 const querySnapshot = await getDocs(q);
                 const assignedClubs = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                 console.log("Naƒç√≠tan√© priraden√© t√≠my:", assignedClubs);

                 assignedClubsContainer.innerHTML = ''; // Clear loading message

                 if (assignedClubs.length === 0) {
                     assignedClubsContainer.textContent = '≈Ωiadne kluby priraden√© do skup√≠n nen√°jden√©.'; // <--- P√¥vodn√° logovacia spr√°va bola tu (riadok 1431)
                 } else {
                      // Pre zobrazenie n√°zvov potrebujeme ma≈• naƒç√≠tan√© kateg√≥rie a skupiny
                     if (allAvailableCategories.length === 0) {
                          await loadAllCategoriesForDynamicSelects();
                     }
                     // TODO: Naƒç√≠tanie v≈°etk√Ωch skup√≠n by bolo efekt√≠vnej≈°ie raz namiesto v cykle
                     // Zatiaƒæ predpoklad√°me, ≈æe populateGroupSelect naƒç√≠ta skupiny pre dan√∫ kateg√≥riu

                      // Zoskup t√≠my podƒæa kateg√≥rie a potom podƒæa skupiny
                     const assignedClubsGrouped = assignedClubs.reduce((acc, club) => {
                          const categoryName = allAvailableCategories.find(cat => cat.id === club.categoryId)?.name || 'Nezn√°ma kateg√≥ria';
                         const groupName = club.groupId ? allAvailableCategories.find(cat => cat.id === club.categoryId)?.groups.find(group => group.id === club.groupId)?.name || 'Nezn√°ma skupina' : 'Nepriraden√©'; // Find group name
                         const categoryKey = `${club.categoryId || 'unknown'} - ${categoryName}`;
                         const groupKey = `${club.groupId || 'unassigned'} - ${groupName}`;

                         if (!acc[categoryKey]) {
                             acc[categoryKey] = { name: categoryName, groups: {} };
                         }
                         if (!acc[categoryKey].groups[groupKey]) {
                             acc[categoryKey].groups[groupKey] = { name: groupName, clubs: [], groupDocId: club.groupId, categoryDocId: club.categoryId };
                         }
                         acc[categoryKey].groups[groupKey].clubs.push(club);
                         return acc;
                     }, {});


                     // Zobraz zoskupen√© t√≠my
                     // Sort categories by name
                     const sortedCategories = Object.keys(assignedClubsGrouped).sort((a, b) => assignedClubsGrouped[a].name.localeCompare(assignedClubsGrouped[b].name));


                     sortedCategories.forEach(categoryKey => {
                         const categoryData = assignedClubsGrouped[categoryKey];
                         const categoryHeading = document.createElement('h4');
                         categoryHeading.textContent = `Kateg√≥ria: ${categoryData.name}`;
                         assignedClubsContainer.appendChild(categoryHeading);

                         // Sort groups within the category by name
                         const sortedGroups = Object.keys(categoryData.groups).sort((a, b) => categoryData.groups[a].name.localeCompare(categoryData.groups[b].name));


                         sortedGroups.forEach(groupKey => {
                              const groupData = categoryData.groups[groupKey];
                              const groupHeading = document.createElement('h5');
                             groupHeading.textContent = `Skupina: ${groupData.name}`;
                             assignedClubsContainer.appendChild(groupHeading);

                             // Sort clubs within the group by orderInGroup
                              groupData.clubs.sort((a, b) => (a.orderInGroup || Infinity) - (b.orderInGroup || Infinity));


                              const ul = document.createElement('ul');
                             ul.classList.add('assigned-clubs-list'); // Class for styling and drag/drop
                              ul.dataset.categoryId = groupData.categoryDocId; // Store category ID for drag/drop saving
                             ul.dataset.groupId = groupData.groupDocId; // Store group ID for drag/drop saving

                             // Add drag and drop listeners to the list
                             addDragAndDropListeners(ul);


                              groupData.clubs.forEach(club => {
                                 const li = document.createElement('li');
                                 li.classList.add('team-list-item'); // Apply flex styles
                                 li.dataset.clubId = club.id; // Store club ID for drag/drop
                                 li.draggable = true; // Make list item draggable

                                  const dragHandle = document.createElement('span');
                                  dragHandle.classList.add('drag-handle');
                                  dragHandle.textContent = '‚†ø'; // Drag handle icon
                                  li.appendChild(dragHandle);


                                  const teamNameSpan = document.createElement('span');
                                  teamNameSpan.textContent = `${club.name} (Poradie: ${club.orderInGroup || 'Nenastaven√©'})`; // Display name and order
                                  li.appendChild(teamNameSpan);


                                  // Tlaƒçidl√° Akci√≠ (Upravi≈•, Odpriradi≈•)
                                  const editButton = document.createElement('button');
                                 editButton.textContent = 'Upravi≈•';
                                  editButton.classList.add('edit-team-button'); // Using edit style
                                  editButton.addEventListener('click', () => {
                                     // Otvor clubModal v edit m√≥de pre tento konkr√©tny priraden√Ω klub
                                      openClubModal(club.id, club); // Open club modal in edit mode
                                 });


                                 const unassignButton = document.createElement('button');
                                 unassignButton.textContent = 'Odpriradi≈•';
                                 unassignButton.classList.add('unassign-team-button'); // Using unassign style
                                 unassignButton.addEventListener('click', async () => {
                                     if (confirm(`Naozaj chcete odpriradi≈• t√≠m "${club.name}" zo skupiny "${groupData.name}"?`)) {
                                          console.log("Clicked Unassign for club:", club.name, club.id);
                                         await unassignClub(club.id); // Implement unassignClub function
                                          // loadAssignedClubs() and loadUnassignedClubs() are called inside unassignClub
                                     }
                                 });


                                  li.appendChild(editButton);
                                 li.appendChild(unassignButton);


                                  ul.appendChild(li);
                             });
                             assignedClubsContainer.appendChild(ul);
                         });
                     });
                 }


              } catch (e) {
                 console.error("Chyba pri naƒç√≠tan√≠ priraden√Ωch t√≠mov: ", e);
                 assignedClubsContainer.textContent = 'Chyba pri naƒç√≠tan√≠ priraden√Ωch t√≠mov.';
              }
         }


         // Drag and Drop pre priraden√© t√≠my
         let draggedItem = null;

         function addDragAndDropListeners(listElement) {
             if (!listElement) {
                 console.error("Cannot add drag and drop listeners: list element is null.");
                 return;
             }

             listElement.addEventListener('dragstart', (e) => {
                 // Set the data to be dragged (e.g., club ID)
                 draggedItem = e.target;
                  e.dataTransfer.effectAllowed = 'move';
                 e.dataTransfer.setData('text/plain', draggedItem.dataset.clubId);

                  // Add a class for styling the dragged item
                 setTimeout(() => { // Use timeout to allow the ghost image to be created first
                      draggedItem.classList.add('dragging');
                 }, 0);
             });

             listElement.addEventListener('dragover', (e) => {
                 // Prevent default to allow drop
                 e.preventDefault();
                 e.dataTransfer.dropEffect = 'move';

                 // Add a visual indicator where the item will be dropped
                 const targetItem = e.target.closest('li.team-list-item');
                 if (targetItem && targetItem !== draggedItem) {
                      const rect = targetItem.getBoundingClientRect();
                      const middleY = rect.top + rect.height / 2;

                      // Determine if dropping before or after the target item
                      if (e.clientY < middleY) {
                          targetItem.classList.add('drag-over-top');
                          targetItem.classList.remove('drag-over-bottom');
                      } else {
                           targetItem.classList.add('drag-over-bottom');
                           targetItem.classList.remove('drag-over-top');
                      }
                 } else if (targetItem === null && listElement.children.length === 0) {
                     // Handle dropping into an empty list
                     listElement.classList.add('drag-over-empty');
                 }


             });

              listElement.addEventListener('dragleave', (e) => {
                  // Remove the visual indicator
                   e.target.classList.remove('drag-over-top', 'drag-over-bottom', 'drag-over-empty');
              });


             listElement.addEventListener('drop', async (e) => {
                 // Prevent default action (open as link)
                 e.preventDefault();

                 // Remove the visual indicator
                 e.target.classList.remove('drag-over-top', 'drag-over-bottom', 'drag-over-empty');

                 const targetItem = e.target.closest('li.team-list-item');
                  const dropList = e.target.closest('ul.assigned-clubs-list'); // The list element where dropped

                 if (draggedItem && dropList) {
                     const clubId = draggedItem.dataset.clubId; // Get the ID of the dragged club
                     const newCategoryId = dropList.dataset.categoryId; // Get the category ID of the target list
                     const newGroupId = dropList.dataset.groupId; // Get the group ID of the target list

                      // Determine the new position (order)
                      let newOrder = dropList.children.length + 1; // Default to end if dropping into empty or at the end
                       const items = Array.from(dropList.children);
                       const targetIndex = targetItem ? items.indexOf(targetItem) : items.length; // Index of the target item

                       if (targetItem && targetItem !== draggedItem) {
                            const rect = targetItem.getBoundingClientRect();
                           const middleY = rect.top + rect.height / 2;

                           if (e.clientY < middleY) {
                               // Dropping before targetItem
                                newOrder = targetIndex + 1;
                           } else {
                                // Dropping after targetItem
                                newOrder = targetIndex + 2; // Insert after, so order is target's index + 2
                           }
                       } else if (targetItem === null && items.length > 0) {
                            // Dropping into the whitespace of a non-empty list - default to end
                             newOrder = items.length + 1;
                       } else if (targetItem === null && items.length === 0) {
                            // Dropping into an empty list
                             newOrder = 1;
                       }


                      console.log(`Dropped club ID ${clubId} into Category ID ${newCategoryId}, Group ID ${newGroupId}. Proposed new order: ${newOrder}`);

                     // Update the club's data in Firestore
                     try {
                          const clubRef = doc(clubsCollectionRef, clubId);
                         await updateDoc(clubRef, {
                             categoryId: newCategoryId,
                              groupId: newGroupId,
                             orderInGroup: newOrder
                         });
                          console.log(`Club ${clubId} data updated successfully.`);

                         // After successful update, reload the assigned clubs list to reflect changes
                         loadAssignedClubs(); // This will re-fetch, sort, and display

                     } catch (e) {
                          console.error(`Error updating club ${clubId} data during drag and drop: `, e);
                          alert("Nastala chyba pri pres√∫van√≠ t√≠mu.");
                          // If update fails, refresh to revert the visual change
                          loadAssignedClubs();
                     }

                 }

             });

             listElement.addEventListener('dragend', (e) => {
                 // Remove the dragging class from the dragged item
                  if (draggedItem) {
                     draggedItem.classList.remove('dragging');
                     draggedItem = null; // Clear the dragged item reference
                  }
                 // Clean up any drag-over classes just in case
                  document.querySelectorAll('.drag-over-top, .drag-over-bottom, .drag-over-empty').forEach(el => {
                      el.classList.remove('drag-over-top', 'drag-over-bottom', 'drag-over-empty');
                 });

             });
         }


        // === Funkcie pre hromadn√© vytvorenie t√≠mov ===

         // Glob√°lna premenn√° na ulo≈æenie kateg√≥ri√≠ pre dynamick√© selecty vo formul√°ri vytvorenia t√≠mov
         // allAvailableCategories sa pou≈æ√≠va aj inde, toto je len pre istotu ak by bol nejak√Ω edge case
         let teamCreationCategories = [];

         // Aktualizuje select boxy kateg√≥ri√≠ v dynamicky prid√°van√Ωch dvojiciach kateg√≥ria/poƒçet
         function updateTeamCreationCategorySelects() {
              const selects = teamCategoryCountContainer.querySelectorAll('select[name="teamCategory"]');
              selects.forEach(selectElement => {
                 const currentValue = selectElement.value; // Zapam√§t√°me si aktu√°lnu hodnotu

                 // Clear current options except maybe a default one if needed
                 selectElement.innerHTML = ''; // Clear existing options

                 // Add default option (optional for these selects, but good practice)
                 const defaultOption = document.createElement('option');
                 defaultOption.value = "";
                 defaultOption.textContent = "-- Vyberte kateg√≥riu --";
                 selectElement.appendChild(defaultOption);


                 // Ensure all categories are loaded before populating
                 if (allAvailableCategories.length === 0) {
                      console.warn("updateTeamCreationCategorySelects: Kateg√≥rie e≈°te nie s√∫ naƒç√≠tan√©. Dynamick√© selecty bud√∫ pr√°zdne.");
                      return; // Nem√¥≈æeme naplni≈•, ak nem√°me kateg√≥rie
                 }

                 // Sort categories alphabetically by name
                 allAvailableCategories.sort((a, b) => a.name.localeCompare(b.name));


                 allAvailableCategories.forEach(category => {
                     const option = document.createElement('option');
                     option.value = category.id; // Document ID is the value
                     option.textContent = category.name;
                      // Ak sa aktu√°lna hodnota zhoduje s touto kateg√≥riou, nastav ju ako vybran√∫
                      if (currentValue && category.id === currentValue) {
                          option.selected = true;
                      }
                     selectElement.appendChild(option);
                 });

                  // Ak aktu√°lna hodnota bola nastaven√°, ale u≈æ neexistuje v zozname, zresetujeme ju
                 if (currentValue && !allAvailableCategories.find(cat => cat.id === currentValue)) {
                      selectElement.value = ""; // Reset na predvolen√∫ mo≈ænos≈•
                      console.warn(`updateTeamCreationCategorySelects: Predt√Ωm zvolen√° kateg√≥ria "${currentValue}" u≈æ neexistuje. Resetujem select.`);
                 }


             });

         }


         // Funkcia na pridanie novej dvojice kateg√≥ria/poƒçet t√≠mov do formul√°ra hromadn√©ho vytvorenia
         async function addCategoryCountPair(setFocus = true) {
              if (!teamCategoryCountContainer) { console.error("teamCategoryCountContainer element not found!"); return; }
               if (!allAvailableCategories || allAvailableCategories.length === 0) {
                   console.warn("Nem√¥≈æem prida≈• kateg√≥ria/poƒçet dvojicu - kateg√≥rie nie s√∫ naƒç√≠tan√©.");
                   // Sk√∫s naƒç√≠ta≈• kateg√≥rie a potom znovu zavolaj funkciu? Alebo po≈æiadaj u≈æ√≠vateƒæa, aby sk√∫sil znova
                   // Ak by sme volali loadAllCategoriesForDynamicSelects(), t√° vol√° updateDynamicCategorySelects, ƒço by mohlo vies≈• k rekurzii
                   // Lep≈°ie je zabezpeƒçi≈• naƒç√≠tanie kateg√≥ri√≠ PRED volan√≠m tejto funkcie
                   await loadAllCategoriesForDynamicSelects(); // Zabezpeƒç√≠ naƒç√≠tanie a zavol√° updateDynamicCategorySelects
                   // Po naƒç√≠tan√≠ sk√∫s prida≈• dvojicu znovu (ak s√∫ kateg√≥rie)
                   if (allAvailableCategories.length > 0) {
                       console.log("Kateg√≥rie naƒç√≠tan√©, prid√°vam dvojicu.");
                        addCategoryCountPair(setFocus); // Volaj znovu, teraz by mali by≈• kateg√≥rie dostupn√©
                   }
                   return; // Ukonƒç√≠me aktu√°lne vykon√°vanie, aby sa predi≈°lo duplicitn√©mu pridaniu
               }

              const pairDiv = document.createElement('div');
              pairDiv.classList.add('category-count-pair'); // Apply flex styles

              const categorySelect = document.createElement('select');
              categorySelect.name = 'teamCategory';
              categorySelect.required = true;
               // Napln√≠ tento nov√Ω select kateg√≥riami (vol√° updateDynamicCategorySelects na konci)
               populateCategorySelect(categorySelect, true); // true = include default option


              const countInput = document.createElement('input');
              countInput.type = 'number';
              countInput.name = 'teamCount';
              countInput.required = true;
              countInput.min = '1';
              countInput.value = '1'; // Default value

              const removeButton = document.createElement('button');
              removeButton.type = 'button';
              removeButton.textContent = 'Odstr√°ni≈•';
               removeButton.classList.add('remove-category-pair-button');
              removeButton.addEventListener('click', () => {
                  pairDiv.remove(); // Remove the pair when button is clicked
                  updateRemoveButtonVisibility(); // Check if remove buttons should be visible
                  checkIfAddCategoryButtonShouldBeVisible(); // Check if add button should be visible
              });

              pairDiv.appendChild(categorySelect);
              pairDiv.appendChild(countInput);
              pairDiv.appendChild(removeButton); // Add remove button to the pair

              teamCategoryCountContainer.appendChild(pairDiv);

               // Aktualizujeme viditeƒænos≈• tlaƒçidiel po pridan√≠ novej dvojice
               updateRemoveButtonVisibility();
               checkIfAddCategoryButtonShouldBeVisible(); // Po pridan√≠ dvojice m√¥≈æe by≈• potrebn√© skry≈• + tlaƒçidlo


               // Nastav√≠me focus na nov√∫ pridan√∫ kateg√≥riu, ak je to potrebn√©
               if (setFocus) {
                   categorySelect.focus();
               }

         }

         // Funkcia na aktualiz√°ciu viditeƒænosti tlaƒçidiel "Odstr√°ni≈•" (skry≈• prv√©mu prvku, ak je jedin√Ω)
         function updateRemoveButtonVisibility() {
              const pairs = teamCategoryCountContainer.querySelectorAll('.category-count-pair');
              pairs.forEach((pair, index) => {
                  const removeButton = pair.querySelector('.remove-category-pair-button');
                 if (removeButton) {
                      // Skryjeme tlaƒçidlo odstr√°ni≈•, ak je to jedin√° dvojica
                      removeButton.style.display = pairs.length === 1 ? 'none' : 'inline-block';
                 }
              });
         }

         // Funkcia na kontrolu, ƒçi by malo by≈• viditeƒæn√© tlaƒçidlo "Prida≈• ƒèal≈°iu kateg√≥riu"
         // Zobraz√≠ sa len ak poƒçet pridan√Ωch dvoj√≠c je men≈°√≠ ako celkov√Ω poƒçet dostupn√Ωch kateg√≥ri√≠
         function checkIfAddCategoryButtonShouldBeVisible() {
              if (!addCategoryCountPairButton) { console.error("addCategoryCountPairButton not found!"); return; }
              const currentPairsCount = teamCategoryCountContainer.querySelectorAll('.category-count-pair').length;
              const totalCategoriesCount = allAvailableCategories.length;

              // Tlaƒçidlo sa zobraz√≠, ak je poƒçet dvoj√≠c men≈°√≠ ako poƒçet kateg√≥ri√≠ A kateg√≥rie s√∫ naƒç√≠tan√©
              if (totalCategoriesCount > 0 && currentPairsCount < totalCategoriesCount) {
                  addCategoryCountPairButton.style.display = 'inline-block';
              } else {
                  addCategoryCountPairButton.style.display = 'none'; // Skryjeme tlaƒçidlo ak u≈æ s√∫ v≈°etky kateg√≥rie pridan√© alebo kateg√≥rie nie s√∫ naƒç√≠tan√©
              }
         }


         // Funkcia na hromadn√© vytvorenie t√≠mov
         async function createTeams(baseName, teamCounts) { // teamCounts is an array of { categoryId: '...', count: N }
              if (!baseName || baseName.trim() === "") {
                  console.warn("Z√°kladn√Ω n√°zov t√≠mu ch√Ωba.");
                  displayMessage(teamCreationMessageArea, "Z√°kladn√Ω n√°zov t√≠mu je povinn√Ω.", 'error');
                  return;
              }
              if (!teamCounts || teamCounts.length === 0) {
                  console.warn("Neboli zadan√© ≈æiadne kateg√≥rie alebo poƒçty t√≠mov.");
                   displayMessage(teamCreationMessageArea, "Zadajte aspo≈à jednu kateg√≥riu a poƒçet t√≠mov.", 'error');
                  return;
              }

              // Valid√°cia, ƒçi s√∫ v≈°etky kateg√≥rie vybran√© a poƒçty platn√© (> 0)
              const validTeamCounts = teamCounts.filter(tc => tc.categoryId && tc.count > 0);
              if (validTeamCounts.length !== teamCounts.length) {
                  console.warn("Niektor√© kateg√≥rie nie s√∫ vybran√© alebo poƒçty t√≠mov s√∫ neplatn√©.");
                  displayMessage(teamCreationMessageArea, "Skontrolujte v√Ωber kateg√≥ri√≠ a zadan√© poƒçty t√≠mov.", 'error');
                   // Zv√Ωrazni≈• nevalidn√© polia (voliteƒæn√©, vy≈æadovalo by pridanie logiky pre valid√°ciu UI)
                  return;
              }


               displayMessage(teamCreationMessageArea, "Vytv√°ram t√≠my...", 'success'); // Zobraz√≠me spr√°vu o priebehu
               const batch = writeBatch(db); // Pou≈æijeme batch pre hromadn√© z√°pisy

              let totalTeamsCreated = 0;

              validTeamCounts.forEach(tc => {
                  for (let i = 1; i <= tc.count; i++) {
                      const teamName = tc.count > 1 ? `${baseName} ${String.fromCharCode(64 + i)}` : baseName; // Napr. "T√≠m A", "T√≠m B" alebo len "T√≠m" ak je 1
                      const newClubRef = doc(clubsCollectionRef); // Vytvor√≠me nov√∫ referenciu s automatick√Ωm ID
                      batch.set(newClubRef, { // Pou≈æijeme set s referenciou s ID
                          name: teamName,
                          baseTeamName: baseName, // Ulo≈æ√≠me aj z√°kladn√Ω n√°zov pre zoskupenie
                          categoryId: tc.categoryId,
                          groupId: null, // Nov√© t√≠my s√∫ nepriraden√©
                          orderInGroup: null // Nov√© t√≠my nemaj√∫ poradie
                          // Pr√≠padne ƒèal≈°ie polia, ak bud√∫ potrebn√© (napr. hala, coach, atƒè.)
                      });
                      totalTeamsCreated++;
                  }
              });

              try {
                 await batch.commit(); // Vykonaj hromadn√Ω z√°pis
                  console.log(`√öspe≈°ne vytvoren√Ωch ${totalTeamsCreated} t√≠mov.`);
                  displayMessage(teamCreationMessageArea, `√öspe≈°ne vytvoren√Ωch ${totalTeamsCreated} t√≠mov.`, 'success');

                 // Po √∫spe≈°nom vytvoren√≠, znova naƒç√≠tame zoznam t√≠mov a nepriraden√© t√≠my
                  loadTeamsList();
                  loadUnassignedClubs();

                 // Voliteƒæn√©: Automaticky zatvor mod√°l po √∫spechu (alebo po kliknut√≠ na OK)
                 // setTimeout(() => {
                 //      closeAllModals();
                 // }, 2000); // Zatvor po 2 sekund√°ch

              } catch (e) {
                 console.error("Chyba pri hromadnom vytv√°ran√≠ t√≠mov: ", e);
                  displayMessage(teamCreationMessageArea, "Nastala chyba pri vytv√°ran√≠ t√≠mov. Sk√∫ste to znovu.", 'error');
                  // Tu by sme nemali vola≈• loadFunctions, preto≈æe t√≠my sa nemuseli vytvori≈•
              }
         }

         // Funkcia na zobrazenie spr√°vy v oblasti spr√°v
         function displayMessage(messageAreaElement, message, type) { // type can be 'success' or 'error'
              if (!messageAreaElement) {
                 console.error("Message area element not found!");
                 return;
              }
              messageAreaElement.textContent = message;
              messageAreaElement.className = 'message-area'; // Reset classes
              messageAreaElement.classList.add(type); // Add success or error class
              messageAreaElement.style.display = 'block'; // Show the message area

              // Voliteƒæn√©: Automaticky skry≈• spr√°vu po niekoƒæk√Ωch sekund√°ch (ak nie je chybov√°)
              // if (type !== 'error') {
              //     setTimeout(() => {
              //          messageAreaElement.style.display = 'none';
              //     }, 5000); // Skry≈• po 5 sekund√°ch
              // }
         }


        // === Event Listeners ===

        // Spoloƒçn√° obsluha kliknutia na tlaƒçidlo Prida≈• (+)
        if (addButton) {
            addButton.addEventListener('click', () => {
                const hash = window.location.hash;
                 console.log("Add button clicked in hash:", hash); // Debug log

                switch (hash) {
                    case '#kategorie':
                        openCategoryModal(); // Open modal in add mode
                        break;
                    case '#skupiny':
                        openGroupModal(); // Open modal in add mode
                        break;
                     case '#zoznam-timov':
                         openTeamCreationModal(); // Open modal for creating teams
                        break;
                     case '#timy-do-skupin':
                          // Open club modal in add-assign mode (select an unassigned club)
                         // We open the modal without arguments, loadUnassignedClubsForSelect is called inside
                         openClubModal();
                         console.log("Opening club modal (add-assign mode)."); // Debug log
                        break;
                    // Pridaj ƒèal≈°ie pr√≠pady pre in√© sekcie, ak bud√∫ ma≈• tlaƒçidlo Prida≈•
                    default:
                        console.warn("Add button clicked in section without defined add action.");
                }
            });
        }


        // Event listeners pre zatvorenie mod√°lov na kliknutie na 'X' alebo tlaƒçidlo 'Zru≈°i≈•'
        // Pridan√© nulov√© kontroly, aby sa zabr√°nilo chyb√°m, ak elementy neexistuj√∫
         if (categoryModalCloseBtn) categoryModalCloseBtn.addEventListener('click', closeAllModals);
         if (groupModalCloseBtn) groupModalCloseBtn.addEventListener('click', closeAllModals);
         if (clubModalCloseBtn) clubModalCloseBtn.addEventListener('click', closeAllModals);
         if (teamCreationModalCloseBtn) teamCreationModalCloseBtn.addEventListener('click', closeAllModals);
         if (manageTeamsModalCloseBtn) manageTeamsModalCloseBtn.addEventListener('click', closeAllModals); // Listener pre nov√Ω modal

         // Event listener pre zatvorenie mod√°lov na kliknutie mimo mod√°l content
         window.addEventListener('click', (event) => {
             if (event.target === categoryModal) {
                 closeAllModals();
             }
              if (event.target === groupModal) {
                 closeAllModals();
              }
              if (event.target === clubModal) {
                  closeAllModals();
              }
               if (event.target === teamCreationModal) {
                   closeAllModals();
               }
                if (event.target === manageTeamsModal) {
                   closeAllModals();
               }
         });


        // Event listener pre odoslanie formul√°ra Kateg√≥rie
        if (categoryForm) {
            categoryForm.addEventListener('submit', async (e) => {
                e.preventDefault(); // Prevent default form submission
                const categoryName = categoryNameInput.value.trim();

                if (categoryName) {
                    const categoryData = {
                        name: categoryName
                        // Add any other category properties here
                    };
                     await saveCategory(editingCategoryId, categoryData);
                     closeAllModals(); // Close modal after saving
                     loadCategories(); // Refresh the list
                } else {
                    alert("N√°zov kateg√≥rie nem√¥≈æe by≈• pr√°zdny.");
                }
            });
        }


         // Event listener pre odoslanie formul√°ra Skupiny
         if (groupForm) {
             groupForm.addEventListener('submit', async (e) => {
                 e.preventDefault(); // Prevent default form submission
                 const categoryId = groupCategorySelect.value; // Get selected category ID
                 const groupName = groupNameInput.value.trim();

                  // TODO: Prida≈• valid√°ciu, ƒçi u≈æ skupina s dan√Ωm n√°zvom v danej kateg√≥rii neexistuje


                 if (categoryId && groupName) {
                     const groupData = {
                         name: groupName,
                         // categoryId je u≈æ zn√°me
                         // Add any other group properties here
                     };
                     await saveGroup(categoryId, editingGroupId, groupData); // Pass categoryId as well
                     closeAllModals(); // Close modal after saving
                     // loadGroups() is called inside saveGroup
                 } else {
                     alert("Vyberte kateg√≥riu a zadajte n√°zov skupiny.");
                 }
             });
         }

          // Event listener pre zmenu v√Ωberu kateg√≥rie vo formul√°ri skupiny (napln√≠ select skup√≠n)
          if (groupCategorySelect && groupForm) { // Kontrola, ƒçi existuj√∫ oba elementy a formul√°r
             groupCategorySelect.addEventListener('change', async () => {
                  const categoryId = groupCategorySelect.value;
                   if (groupGroupSelect) { // Kontrola existencie selectu skup√≠n
                       if (categoryId) {
                           await populateGroupSelect(groupGroupSelect, categoryId, true); // Napl≈à select skup√≠n pre vybran√∫ kateg√≥riu
                           groupGroupSelect.disabled = false; // Povoƒæ select skup√≠n
                       } else {
                            // Ak sa nevybrala kateg√≥ria, zablokuj select skup√≠n
                           groupGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kateg√≥riu --</option>';
                           groupGroupSelect.disabled = true;
                       }
                   } else {
                       console.error("Group group select element not found!");
                   }
             });
          } else {
              if (!groupCategorySelect) console.warn("Group category select element not found for change listener.");
              if (!groupForm) console.warn("Group form element not found for change listener.");
          }


         // Event listener pre odoslanie formul√°ra Klubu (pre priradenie/√∫pravu)
         if (clubForm) {
             clubForm.addEventListener('submit', async (e) => {
                 e.preventDefault(); // Prevent default form submission

                  // Valid√°cia vstupov podƒæa aktu√°lneho m√≥du
                  let isValid = true;
                  const clubName = clubNameInput.value.trim(); // Used in edit mode
                  const unassignedClubId = unassignedClubSelect.value; // Used in add-assign mode
                  const categoryId = clubCategorySelect.value;
                  const groupId = clubGroupSelect.value;
                  const orderInGroup = orderInGroupInput.value ? parseInt(orderInGroupInput.value) : null; // Can be null


                  // Reset validation messages
                  clubForm.querySelectorAll('.validation-message').forEach(msg => msg.textContent = '');


                 if (currentClubModalMode === 'add-assign') {
                      // Valid√°cia pre pridanie/priradenie nepriraden√©ho klubu
                     if (!unassignedClubId) {
                         document.getElementById('unassignedClubSelectContainer').querySelector('.validation-message').textContent = 'Vyberte t√≠m.';
                         isValid = false;
                     }
                     if (!categoryId) {
                         document.getElementById('clubCategoryValidationMessage').textContent = 'Vyberte kateg√≥riu.';
                         isValid = false;
                     }
                      // Skupina je povinn√° len ak existuj√∫ skupiny v danej kateg√≥rii A select nie je disabled
                     if (clubGroupSelect && !clubGroupSelect.disabled && !groupId) {
                          document.getElementById('clubGroupValidationMessage').textContent = 'Vyberte skupinu.';
                         isValid = false;
                     }
                      // Poradie je povinn√© len ak je input viditeƒæn√Ω a nie je vyplnen√Ω (napr. pri drag and drop je poradie handled inak)
                      if (orderInputContainer.style.display !== 'none' && (orderInGroup === null || isNaN(orderInGroup))) {
                           document.getElementById('orderInGroupValidationMessage').textContent = 'Zadajte platn√© poradie.';
                           isValid = false;
                       }


                 } else if (currentClubModalMode === 'edit') {
                     // Valid√°cia pre √∫pravu priraden√©ho klubu (meno by nemalo by≈• editable, ale pre istotu)
                      if (!clubName) {
                           document.getElementById('clubNameValidationMessage').textContent = 'N√°zov t√≠mu ch√Ωba.';
                           isValid = false;
                       }
                      if (!categoryId) { // Kateg√≥ria by nemala by≈• editable, ale pre valid√°ciu
                           document.getElementById('clubCategoryValidationMessage').textContent = 'Kateg√≥ria ch√Ωba.';
                           isValid = false;
                       }
                       // Skupina je povinn√° ak je select povolen√Ω
                       if (clubGroupSelect && !clubGroupSelect.disabled && !groupId) {
                            document.getElementById('clubGroupValidationMessage').textContent = 'Vyberte skupinu.';
                           isValid = false;
                       }
                       // Poradie je povinn√© ak je input viditeƒæn√Ω
                       if (orderInputContainer.style.display !== 'none' && (orderInGroup === null || isNaN(orderInGroup))) {
                            document.getElementById('orderInGroupValidationMessage').textContent = 'Zadajte platn√© poradie.';
                           isValid = false;
                       }


                 }


                 if (!isValid) {
                      console.warn("Valid√°cia formul√°ra klubu zlyhala.");
                      // Zobrazenie chybov√Ωch spr√°v je u≈æ handled v r√°mci valid√°cie vy≈°≈°ie
                      return; // Zastav√≠me odoslanie formul√°ra
                 }


                 if (currentClubModalMode === 'add-assign') {
                     // === Logic for ASSIGNING an UNASSIGNED club to a group ===
                     // We need the ID of the UNASSIGNED club selected in the select box
                     const clubToAssignId = unassignedClubSelect.value; // This is the ID of the club document
                     // We need the target group and category IDs
                     const targetCategoryId = clubCategorySelect.value;
                     const targetGroupId = clubGroupSelect.value;
                      const targetOrderInGroup = orderInGroupInput.value ? parseInt(orderInGroupInput.value) : null; // Get order if visible


                     if (clubToAssignId && targetCategoryId && targetGroupId) {
                         // Find the selected unassigned club's data (mainly for its name and baseName)
                         const selectedUnassignedClubData = allAvailableClubs.find(club => club.id === clubToAssignId);
                         if (!selectedUnassignedClubData) {
                             console.error("Selected unassigned club data not found!");
                             alert("Chyba: D√°ta vybran√©ho t√≠mu sa nena≈°li.");
                             return;
                         }

                         // Update the existing club document in Firestore
                         const clubRef = doc(clubsCollectionRef, clubToAssignId);
                         await updateDoc(clubRef, {
                             categoryId: targetCategoryId,
                             groupId: targetGroupId,
                             orderInGroup: targetOrderInGroup // Assign the order
                             // Name, baseTeamName should not change
                         });

                         console.log(`T√≠m ${selectedUnassignedClubData.name} (ID: ${clubToAssignId}) √∫spe≈°ne priraden√Ω do skupiny ${targetGroupId} v kateg√≥rii ${targetCategoryId} s porad√≠m ${targetOrderInGroup}.`);
                         closeAllModals(); // Close modal after successful assignment
                         // loadUnassignedClubs() and loadAssignedClubs() are called inside saveClub (which we are effectively doing with updateDoc)
                          loadUnassignedClubs(); // Refresh nepriraden√© (zmizne z neho)
                          loadAssignedClubs(); // Refresh priraden√© (objav√≠ sa v ≈àom)
                          loadTeamsList(); // Refresh zoznam t√≠mov (zmen√≠ sa status)

                     } else {
                         console.warn("Ch√Ωbaj√∫ √∫daje pre priradenie t√≠mu.");
                         // Valid√°cia vy≈°≈°ie by mala zabr√°ni≈• tomuto stavu, ale pre istotu
                         alert("Vyberte t√≠m, kateg√≥riu a skupinu.");
                     }


                 } else if (currentClubModalMode === 'edit' && editingClubId) {
                     // === Logic for EDITING an ASSIGNED or UNASSIGNED club ===
                     // When editing, we are primarily updating its category, group, and order
                     // Name and baseName are readOnly in edit mode

                     const targetCategoryId = clubCategorySelect.value; // Get category ID (might be disabled, but still has value)
                     const targetGroupId = clubGroupSelect.value; // Get group ID
                     const targetOrderInGroup = orderInGroupInput.value ? parseInt(orderInGroupInput.value) : null; // Get order

                     // Ak u≈æ bol t√≠m priraden√Ω a men√≠me mu skupinu/kateg√≥riu, alebo poradie
                      // Ak bol t√≠m nepriraden√Ω a men√≠me mu (napr.) len kateg√≥riu (ak by bolo povolen√©)
                      // V aktu√°lnej implement√°cii edit m√≥du sa otv√°ra len pre priraden√© t√≠my z #timy-do-skupin sekcie.
                      // Ak editujeme priraden√Ω t√≠m, m√¥≈æeme meni≈• jeho group a order. Kateg√≥riu zatiaƒæ nemen√≠me.

                      console.log(`Edit√°cia klubu ID: ${editingClubId}. Nov√° kateg√≥ria: ${targetCategoryId}, nov√° skupina: ${targetGroupId}, nov√© poradie: ${targetOrderInGroup}`);


                      // Aktualizujeme dokument klubu v Firestore
                      const clubRef = doc(clubsCollectionRef, editingClubId);
                      await updateDoc(clubRef, {
                         // categoryId: targetCategoryId, // Kateg√≥riu zatiaƒæ neumo≈æ≈àujeme meni≈• v edit m√≥de
                          groupId: targetGroupId, // Skupinu m√¥≈æeme zmeni≈•
                          orderInGroup: targetOrderInGroup // Poradie m√¥≈æeme zmeni≈•
                      });

                     console.log(`Klub ID ${editingClubId} √∫spe≈°ne aktualizovan√Ω (skupina/poradie).`);
                      closeAllModals(); // Close modal after successful update
                      // loadAssignedClubs() will refresh the list with the new group/order
                       loadAssignedClubs();
                       // loadUnassignedClubs() will also refresh (though this edit won't change assignment status)
                       loadUnassignedClubs();
                       loadTeamsList(); // Refresh list (status won't change, but good practice)


                 } else {
                      console.error("Club form submitted in unknown mode or without editing ID.");
                      alert("Nastala chyba pri spracovan√≠ formul√°ra klubu.");
                 }
             });
         }

         // Event listener pre zmenu v√Ωberu nepriraden√©ho klubu vo formul√°ri klubu (add-assign m√≥d)
         if (unassignedClubSelect && clubForm) { // Kontrola, ƒçi existuj√∫ oba elementy a formul√°r
              unassignedClubSelect.addEventListener('change', async () => {
                   const selectedClubId = unassignedClubSelect.value;
                   console.log("Unassigned club select changed. Selected ID:", selectedClubId);

                  // Zresetujeme select kateg√≥ri√≠ a skup√≠n a zablokujeme skupinov√Ω select
                   if (clubCategorySelect) {
                        // Nastav√≠me hodnotu kateg√≥rie na z√°klade d√°t selectedUnassignedClubData
                        // Najprv n√°jdeme d√°ta vybran√©ho klubu
                       const selectedUnassignedClubData = allAvailableClubs.find(club => club.id === selectedClubId);
                        if (selectedUnassignedClubData) {
                             console.log("Selected unassigned club data found:", selectedUnassignedClubData);
                             clubCategorySelect.value = selectedUnassignedClubData.categoryId || ''; // Nastav√≠me kateg√≥riu

                             // Po nastaven√≠ kateg√≥rie napln√≠me a povol√≠me select skup√≠n
                             if (clubGroupSelect) {
                                 if (selectedUnassignedClubData.categoryId) {
                                     await populateGroupSelect(clubGroupSelect, selectedUnassignedClubData.categoryId, true);
                                     clubGroupSelect.disabled = false; // Povol√≠me select skup√≠n
                                     orderInputContainer.style.display = 'block'; // Show order input when category/group selected
                                      orderInGroupInput.disabled = false; // Enable order input
                                 } else {
                                      console.warn("Selected unassigned club has no category ID.");
                                      clubGroupSelect.innerHTML = '<option value="">-- Kateg√≥ria nezn√°ma --</option>';
                                      clubGroupSelect.disabled = true;
                                      orderInputContainer.style.display = 'none'; // Hide order input if no category
                                      orderInGroupInput.disabled = true;
                                 }
                             } else {
                                 console.error("Club group select element not found after unassigned club select change.");
                             }

                        } else {
                             console.warn("Data for selected unassigned club not found in allAvailableClubs.");
                             // Reset category/group selects if data is missing
                             if (clubCategorySelect) clubCategorySelect.value = "";
                             if (clubGroupSelect) {
                                 clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kateg√≥riu --</option>';
                                 clubGroupSelect.disabled = true;
                                 orderInputContainer.style.display = 'none'; // Hide order input
                                 orderInGroupInput.disabled = true;
                             }
                        }

                   } else {
                       console.error("Club category select element not found after unassigned club select change.");
                   }


              });
         } else {
              if (!unassignedClubSelect) console.warn("Unassigned club select element not found for change listener.");
               if (!clubForm) console.warn("Club form element not found for change listener.");
         }


          // Event listener pre zmenu v√Ωberu kateg√≥rie vo formul√°ri klubu (add-assign m√≥d)
          // Tento listener je d√¥le≈æit√Ω na naplnenie selectu skup√≠n po zmene kateg√≥rie
         if (clubCategorySelect && clubForm && unassignedClubSelectContainer.style.display !== 'none') { // Uisti sa, ≈æe ide o add-assign m√≥d
              // Prid√°me listener len ak je select kateg√≥rie povolen√Ω (tzn. nie sme v edit m√≥de, kde je disabled)
              if (!clubCategorySelect.disabled) {
                 clubCategorySelect.addEventListener('change', async () => {
                     const categoryId = clubCategorySelect.value;
                      console.log("Club modal category select changed. Selected category ID:", categoryId);

                      // Napln√≠me a povol√≠me select skup√≠n pre vybran√∫ kateg√≥riu
                      if (clubGroupSelect) {
                           if (categoryId) {
                                await populateGroupSelect(clubGroupSelect, categoryId, true);
                                clubGroupSelect.disabled = false; // Povol√≠me select skup√≠n
                                orderInputContainer.style.display = 'block'; // Show order input when category/group selected
                                orderInGroupInput.disabled = false; // Enable order input
                           } else {
                               // Ak sa nevybrala kateg√≥ria, zablokuj select skup√≠n
                               clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kateg√≥riu --</option>';
                               clubGroupSelect.disabled = true;
                               orderInputContainer.style.display = 'none'; // Hide order input
                               orderInGroupInput.disabled = true;
                           }
                      } else {
                          console.error("Club group select element not found after category select change.");
                      }

                 });
              }
          } else {
               if (!clubCategorySelect) console.warn("Club category select element not found for change listener (category in club modal).");
               if (!clubForm) console.warn("Club form element not found for change listener (category in club modal).");
          }


         // Event listener pre odoslanie formul√°ra hromadn√©ho vytvorenia t√≠mov
         if (teamCreationForm) {
              teamCreationForm.addEventListener('submit', async (e) => {
                   e.preventDefault(); // Prevent default form submission

                   const baseName = baseTeamNameInput.value.trim();
                   const teamCounts = []; // Array to store { categoryId, count }

                   const pairs = teamCategoryCountContainer.querySelectorAll('.category-count-pair');
                   let isValid = true;

                   // Valid√°cia a zber d√°t z dynamicky pridan√Ωch dvoj√≠c
                   pairs.forEach(pair => {
                        const categorySelect = pair.querySelector('select[name="teamCategory"]');
                        const countInput = pair.querySelector('input[name="teamCount"]');
                         const validationMessageSpan = pair.querySelector('.validation-message'); // Assuming a span for message per pair

                         // Reset validation message for this pair
                         if (validationMessageSpan) validationMessageSpan.textContent = '';


                        const categoryId = categorySelect ? categorySelect.value : '';
                        const count = countInput ? parseInt(countInput.value) : 0;


                       if (!categoryId) {
                           isValid = false;
                           if (categorySelect) { // Zobraz chybu priamo pri selecte
                                // Ak nie je validation span, pridaj ho
                                if (!validationMessageSpan) {
                                     const span = document.createElement('span');
                                     span.classList.add('validation-message');
                                     pair.appendChild(span);
                                     span.textContent = 'Vyberte kateg√≥riu.';
                                } else {
                                    validationMessageSpan.textContent = 'Vyberte kateg√≥riu.';
                                }
                           }
                       }

                       if (isNaN(count) || count <= 0) {
                           isValid = false;
                           if (countInput) { // Zobraz chybu priamo pri inpute
                                // Ak nie je validation span, pridaj ho
                                 if (!validationMessageSpan) {
                                     const span = document.createElement('span');
                                     span.classList.add('validation-message');
                                     pair.appendChild(span);
                                     span.textContent = 'Zadajte platn√Ω poƒçet (>0).';
                                 } else {
                                     // Ak uz je tam sprava z kateg√≥rie, pridaj aj tuto
                                     validationMessageSpan.textContent += (validationMessageSpan.textContent ? ' / ' : '') + 'Zadajte platn√Ω poƒçet (>0).';
                                 }
                           }
                       }

                       if (isValid && categoryId && count > 0) { // Ak je dan√° dvojica platn√°
                           teamCounts.push({ categoryId, count });
                       }

                   }); // Koniec forEach pairs

                   // Valid√°cia z√°kladn√©ho n√°zvu
                    if (!baseName) {
                         const validationSpan = document.getElementById('baseTeamNameValidationMessage');
                          if (validationSpan) validationSpan.textContent = 'Z√°kladn√Ω n√°zov t√≠mu je povinn√Ω.';
                         isValid = false;
                    }


                   if (!isValid) {
                       console.warn("Valid√°cia formul√°ra hromadn√©ho vytvorenia zlyhala.");
                       displayMessage(teamCreationMessageArea, "Pros√≠m, skontrolujte oznaƒçen√© polia.", 'error'); // Zobraz celkov√∫ chybov√∫ spr√°vu
                       return; // Zastav√≠me odoslanie formul√°ra
                   }

                   if (teamCounts.length === 0) {
                        console.warn("≈Ωiadne platn√© dvojice kateg√≥ria/poƒçet neboli zadan√©.");
                       displayMessage(teamCreationMessageArea, "Zadajte aspo≈à jednu platn√∫ dvojicu kateg√≥ria a poƒçet t√≠mov.", 'error');
                       return; // Zastav√≠me odoslanie formul√°ra
                   }


                  // Ak valid√°cia pre≈°la, vol√°me funkciu na vytvorenie t√≠mov
                  await createTeams(baseName, teamCounts);

                 // Po odoslan√≠ formul√°ra (aj pri chybe z√°pisu do DB) zresetujeme formul√°r
                 // Ak by sme ho zresetovali len pri √∫spechu, pri chybe by u≈æ√≠vateƒæ stratil zadan√© √∫daje
                 // Lep≈°ie je resetova≈• formul√°r len po √∫spe≈°nom zatvoren√≠ mod√°lu
                 // closeAllModals(); // Zatvor mod√°l (voliteƒæn√©)

              });
         }


         // Naƒç√≠ta kateg√≥rie pri prvom naƒç√≠tan√≠ str√°nky, aby boli dostupn√© pre dynamick√© selecty
         // T√°to funkcia sa vol√° aj pri hashchange
        // loadAllCategoriesForDynamicSelects(); // U≈æ sa vol√° v toggleContentDisplay


        // Pri prvom naƒç√≠tan√≠ str√°nky (alebo po refreshi) nastav hash, ak nie je nastaven√Ω
        // window.addEventListener('load', ...) u≈æ to rob√≠ hore


        // === Spustenie aplik√°cie ===
        // Inicializ√°cia a prvotn√© zobrazenie obsahu sa deje cez onAuthStateChanged listener,
        // ktor√Ω vol√° toggleContentDisplay. loadAllCategoriesForDynamicSelects je volan√° v toggleContentDisplay.


        // Pri naƒç√≠tan√≠ str√°nky prid√°me prv√∫ dvojicu kateg√≥ria/poƒçet do formul√°ra hromadn√©ho vytvorenia
        // Toto by sa malo sta≈•, keƒè sa Team Creation Modal otvor√≠ prv√Ωkr√°t, nie hneƒè pri naƒç√≠tan√≠
        // addCategoryCountPair(); // Odstr√°nen√© - vol√° sa teraz pri otvoren√≠ mod√°lu

         // Event listener pre zatvorenie mod√°lu hromadn√©ho vytvorenia - resetuje formul√°r
         // Tento listener je u≈æ pridan√Ω na closeAllModals, len sa uisti, ≈æe TeamCreation form reset je v closeAllModals

         // Ensure the first category/count pair is added when the modal is opened
         // This logic is now inside openTeamCreationModal


         // Update remove button visibility on initial load (if already in #zoznam-timov and has pairs)
         // This is handled by updateRemoveButtonVisibility call inside updateTeamCreationCategorySelects


         // Check if add category button should be visible on initial load
         // This is handled by checkIfAddCategoryButtonShouldBeVisible call inside loadAllCategoriesForDynamicSelects and updateTeamCreationCategorySelects


        // Ensure initial state of remove buttons and add button is set when modal is opened
        // This logic is now within openTeamCreationModal and addCategoryCountPair


         // Example of how to manually trigger loading if needed (for testing)
         // loadCategories();
         // loadGroups();
         // loadTeamsList();
         // loadUnassignedClubs();
         // loadAssignedClubs();

         // Pri prvom zobrazen√≠ sekcie #zoznam-timov by sa mal prida≈• prv√Ω pr√°zdny p√°r
         // Toto je teraz integrovan√© do openTeamCreationModal
         // A zabezpeƒçen√© v hideAllSections pri resete teamCreationForm

    </script>

</body>
</html>
