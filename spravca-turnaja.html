<!-- ... head and basic body structure ... -->

    <style>
        /* ... (Previous CSS remains the same) ... */

        /* Add style for form groups */
        .form-group {
            margin-bottom: 15px; /* Space between form fields */
        }

        .form-group label {
            display: block; /* Labels on their own line */
            margin-bottom: 5px;
            font-weight: bold;
        }

         .modal-content form input[type="text"],
         .modal-content form select { /* Apply input style to select too */
             width: calc(100% - 22px); /* Adjust for padding and border */
             padding: 10px;
             margin-bottom: 10px; /* Less margin here, form-group adds spacing */
             border: 1px solid #ccc;
             border-radius: 4px;
             box-sizing: border-box; /* Include padding and border in element's total width */
         }

         /* Adjust button margin in modal form */
         .modal-content form button[type="submit"] {
             margin-top: 10px; /* Add some space above the submit button */
         }


        /* ... (Rest of the CSS remains the same) ... */
    </style>
</head>
<body>
    <!-- ... (Auth script, h1, add button) ... -->

     <button class="add-button" id="addButton" title="Pridať">+</button> <!-- Renamed ID to be more generic -->


    <!-- Modal for Add/Edit Category/Group -->
    <div class="modal" id="itemModal"> <!-- Renamed ID to be more generic -->
        <div class="modal-content">
            <span class="close" id="closeModal">&times;</span> <!-- Renamed ID -->
            <h2 id="modalTitle">Pridať položku</h2> <!-- Generic title -->
            <form id="itemForm"> <!-- Renamed ID -->
                <!-- Fields for Categories -->
                <div class="form-group category-fields">
                    <label for="categoryName">Názov kategórie:</label>
                    <input type="text" id="categoryName" name="categoryName"> <!-- Removed 'required' here, add via JS if needed -->
                </div>

                <!-- Fields for Groups -->
                 <div class="form-group group-fields" style="display: none;">
                     <label for="groupCategory">Kategória:</label>
                     <select id="groupCategory" name="groupCategory"> <!-- Removed 'required' here, add via JS if needed -->
                         <option value="">-- Vyberte kategóriu --</option>
                         <!-- Options populated by JS -->
                     </select>
                 </div>
                 <div class="form-group group-fields" style="display: none;">
                     <label for="groupName">Názov Skupiny:</label>
                     <input type="text" id="groupName" name="groupName"> <!-- Removed 'required' here, add via JS if needed -->
                 </div>
                 <div class="form-group group-fields" style="display: none;">
                     <label for="groupDetail1">Detail 1:</label>
                     <input type="text" id="groupDetail1" name="groupDetail1">
                 </div>
                 <div class="form-group group-fields" style="display: none;">
                     <label for="groupDetail2">Detail 2:</label>
                     <input type="text" id="groupDetail2" name="groupDetail2">
                 </div>
                 <!-- Hidden input to store item ID (category or group) when editing -->
                <input type="hidden" id="itemId" name="itemId">
                 <!-- Hidden input to track item type being edited/added -->
                <input type="hidden" id="itemType" name="itemType">


                <button type="submit">Uložiť</button>
            </form>
        </div>
    </div>

    <!-- ... (Content wrapper, nav, main) ... -->

        <main>
             <!-- Category Table -->
            <table id="categoryTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Názov kategórie</th>
                        <th style="width: 150px;">Akcie</th> <!-- Changed header text -->
                    </tr>
                </thead>
                <tbody id="categoryTableBody">
                    <!-- Table rows will be added here by JavaScript -->
                </tbody>
            </table>

            <!-- Groups Table -->
            <table id="groupsTable" style="display: none;">
                 <thead>
                     <tr>
                         <!-- Fixed header columns will be added here by JS -->
                     </tr>
                 </thead>
                 <tbody>
                     <!-- Group data rows will be added here by JavaScript -->
                 </tbody>
            </table>

             <!-- Other content for different menu items would go here -->
        </main>
    </div>


    <script type="module">
        // ... (Firebase Imports and Config remain the same) ...

        // Získame referencie na DOM elementy (UPDATED IDs)
        const addButton = document.getElementById('addButton'); // Changed ID
        const modal = document.getElementById('itemModal'); // Changed ID
        const closeModalBtn = document.getElementById('closeModal'); // Changed ID
        const form = document.getElementById('itemForm'); // Changed ID
        const modalTitle = document.getElementById('modalTitle'); // Remains the same

        // Form fields (NEW references)
        const categoryFields = form.querySelectorAll('.category-fields'); // Select the div containing category fields
        const categoryNameInput = document.getElementById('categoryName'); // Specific input

        const groupFields = form.querySelectorAll('.group-fields'); // Select the divs containing group fields
        const groupCategorySelect = document.getElementById('groupCategory');
        const groupNameInput = document.getElementById('groupName');
        const groupDetail1Input = document.getElementById('groupDetail1');
        const groupDetail2Input = document.getElementById('groupDetail2');
        const itemIdInput = document.getElementById('itemId'); // Hidden input for ID
        const itemTypeInput = document.getElementById('itemType'); // Hidden input for type


        const categoryTable = document.getElementById('categoryTable');
        const categoryTableBody = document.getElementById('categoryTableBody');
        const groupsTable = document.getElementById('groupsTable');
        const groupsTableHeadTr = groupsTable.querySelector('thead tr');
        const groupsTableBodyEl = groupsTable.querySelector('tbody');


        // State variable to track the type of item being managed in the modal
        // This replaces the old 'currentModalMode' and 'editingItemRef/Row'
        let currentItemType = null; // 'category' or 'group'
        let editingItemId = null; // ID of the item being edited
        let editingItemRow = null; // Reference to the table row being edited


        // Helper function to show/hide form fields
        function showFormFields(type) {
            // Hide all field groups first
            categoryFields.forEach(el => el.style.display = 'none');
            groupFields.forEach(el => el.style.display = 'none');

            // Show fields based on type
            if (type === 'category') {
                categoryFields.forEach(el => el.style.display = 'block');
            } else if (type === 'group') {
                groupFields.forEach(el => el.style.display = 'block');
            }
            // Reset validation/required states (more robust way needed for production)
             categoryNameInput.required = (type === 'category');
             groupCategorySelect.required = (type === 'group');
             groupNameInput.required = (type === 'group');
        }


        // Funkcia na vytvorenie a pridanie riadku kategórie do tabuľky kategórií
        function addCategoryRowToTable(categoryName, categoryId) { // Added categoryId parameter
             // Find existing row if editing
             const existingRow = editingItemRow && editingItemId === categoryId ? editingItemRow : null;

             if (existingRow) {
                 // Update existing row if in edit mode and it matches
                 existingRow.querySelector('td:first-child').textContent = categoryName;
                 // editingItemRow = null; // Clear editing state after update
                 // editingItemId = null;
                 console.log(`Aktualizovaný riadok pre kategóriu: ${categoryName}`);
                 return; // Stop here, don't add a new row
             }


            const tr = document.createElement('tr');
            // Store the category ID on the row for easier access during delete/edit
            tr.dataset.itemId = categoryId; // Use Firestore document ID

            const nameTd = document.createElement('td');
            nameTd.textContent = categoryName;

            const actionsTd = document.createElement('td');
            actionsTd.style.whiteSpace = 'nowrap';


            // === TLAČIDLO PREMENOVAŤ (pre kategórie) ===
            const renameButton = document.createElement('button');
            renameButton.textContent = 'Premenovať';
            renameButton.classList.add('action-button');

            renameButton.onclick = function() {
                currentItemType = 'category'; // Set type
                editingItemId = this.closest('tr').dataset.itemId; // Get ID from row
                editingItemRow = this.closest('tr'); // Get row reference

                modalTitle.textContent = 'Upraviť kategóriu';
                showFormFields('category'); // Show only category fields

                // Fetch current data to populate modal
                 const currentCategoryName = editingItemRow.querySelector('td:first-child').textContent; // Get name from row
                categoryNameInput.value = currentCategoryName;
                itemIdInput.value = editingItemId; // Store ID in hidden field for submit handler
                itemTypeInput.value = 'category'; // Store type

                modal.style.display = 'block';
                categoryNameInput.focus();
            };


            // === TLAČIDLO ZMAZAŤ (pre kategórie) ===
            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Zmazať';
            deleteButton.classList.add('action-button', 'delete-button');

            deleteButton.onclick = async function() {
                const row = this.closest('tr');
                const categoryIdToDelete = row.dataset.itemId; // Use stored ID
                const categoryNameToDelete = row.querySelector('td:first-child').textContent; // Get name for confirmation

                if (!confirm(`Naozaj chcete zmazať kategóriu "${categoryNameToDelete}"?`)) {
                    return;
                }

                try {
                    await deleteDoc(doc(categoriesCollectionRef, categoryIdToDelete)); // Use ID for deletion
                    row.remove();
                    console.log(`Kategória "${categoryNameToDelete}" (ID: ${categoryIdToDelete}) bola úspešne zmazaná.`);

                    // Optional: Re-render groups table if active, as headers might change
                     if (window.location.hash === '#skupiny') {
                         renderGroupsTableStructure(); // Refresh groups table header
                     }

                } catch (error) {
                    console.error('Chyba pri mazaní kategórie: ', error);
                    alert('Chyba pri mazaní kategórie!');
                }
            };


            actionsTd.appendChild(renameButton);
            actionsTd.appendChild(deleteButton);

            tr.appendChild(nameTd);
            tr.appendChild(actionsTd);

            categoryTableBody.appendChild(tr);
        }


        // Funkcia na načítanie kategórií z Firestore a naplnenie tabuľky KATEGÓRIÍ
        async function loadCategories() {
            try {
                categoryTableBody.innerHTML = ''; // Vyčistiť telo tabuľky

                const querySnapshot = await getDocs(categoriesCollectionRef);

                if (querySnapshot.empty) {
                     console.log("Žiadne kategórie nenájdené pre tabuľku kategórií.");
                } else {
                    querySnapshot.forEach((doc) => {
                        const categoryId = doc.id; // Firestore document ID is the category ID
                        const categoryData = doc.data(); // Get document data if needed
                        const categoryName = categoryData.name || categoryId; // Use a 'name' field if it exists, otherwise use ID

                        addCategoryRowToTable(categoryName, categoryId); // Pass ID to the function
                    });
                    console.log("Kategórie boli načítané pre tabuľku kategórií.");
                }

            } catch (error) {
                console.error('Chyba pri načítaní kategórií: ', error);
                alert('Chyba pri načítaní kategórií!');
            }
        }


        // === Funkcia: Vytvorenie pevnej hlavičky tabuľky SKUPÍN a načítanie dát ===
        // Teraz táto funkcia bude aj načítavať dáta skupín
        async function loadGroupsTable() {
             const groupsTableHeadTr = groupsTable.querySelector('thead tr');
             const groupsTableBodyEl = groupsTable.querySelector('tbody');

             // Vyčistiť existujúci obsah hlavičky a tela tabuľky skupín
             groupsTableHeadTr.innerHTML = '';
             groupsTableBodyEl.innerHTML = '';

             console.log("Pripravujem tabuľku skupín (pevná hlavička + dáta).");

             // --- Vytvorenie pevnej hlavičky ---
             const headers = ['Kategória', 'Názov Skupiny', 'Detail 1', 'Detail 2', 'Akcie']; // Pevná hlavička

             headers.forEach(headerText => {
                 const th = document.createElement('th');
                 th.textContent = headerText;
                  // Optional: Set specific widths
                  if (headerText === 'Akcie') {
                      th.style.width = '150px';
                      th.style.textAlign = 'center';
                  } else if (headerText === 'Kategória') {
                       th.style.width = '150px';
                  } else if (headerText === 'Názov Skupiny') {
                       th.style.width = '200px';
                  }
                 groupsTableHeadTr.appendChild(th);
             });

             // --- Načítanie a zobrazenie dát skupín ---
             try {
                  // 1. Načítaj všetky kategórie na vytvorenie mapy ID -> Názov
                  const categoriesSnapshot = await getDocs(categoriesCollectionRef);
                  const categoryMap = {};
                  categoriesSnapshot.forEach(doc => {
                      const catData = doc.data();
                      categoryMap[doc.id] = catData.name || doc.id; // Store ID -> Name mapping
                  });

                  // 2. Načítaj všetky skupiny
                 const groupsSnapshot = await getDocs(groupsCollectionRef);

                 if (groupsSnapshot.empty) {
                     console.log("Žiadne skupiny nenájdené vo Firestore.");
                      const noDataRow = document.createElement('tr');
                      const td = document.createElement('td');
                      td.colSpan = headers.length; // Span across all headers
                      td.textContent = "Zatiaľ žiadne skupiny nie sú pridané.";
                      td.style.textAlign = 'center';
                      td.style.fontStyle = 'italic';
                      noDataRow.appendChild(td);
                      groupsTableBodyEl.appendChild(noDataRow);
                 } else {
                      console.log("Načítavam a zobrazujem dáta skupín.");
                      groupsSnapshot.forEach((doc) => {
                          const groupId = doc.id;
                          const groupData = doc.data();

                          const tr = document.createElement('tr');
                          tr.dataset.itemId = groupId; // Store group ID on the row

                          // Cell 1: Category Name (using the map)
                          const categoryTd = document.createElement('td');
                          const categoryName = categoryMap[groupData.categoryId] || 'Neznáma kategória'; // Lookup name, handle missing
                          categoryTd.textContent = categoryName;
                          tr.appendChild(categoryTd);

                          // Cell 2: Group Name
                          const groupNameTd = document.createElement('td');
                          groupNameTd.textContent = groupData.name || 'Bez názvu'; // Assuming 'name' field
                          tr.appendChild(groupNameTd);

                          // Cell 3: Detail 1
                          const detail1Td = document.createElement('td');
                          detail1Td.textContent = groupData.detail1 || '-'; // Assuming 'detail1' field
                          tr.appendChild(detail1Td);

                          // Cell 4: Detail 2
                          const detail2Td = document.createElement('td');
                          detail2Td.textContent = groupData.detail2 || '-'; // Assuming 'detail2' field
                          tr.appendChild(detail2Td);

                          // Cell 5: Actions
                          const actionsTd = document.createElement('td');
                          actionsTd.style.whiteSpace = 'nowrap';
                          actionsTd.style.textAlign = 'center'; // Center action buttons


                          // === TLAČIDLO UPRAVIŤ (pre skupiny) ===
                          const editButton = document.createElement('button');
                          editButton.textContent = 'Upraviť';
                          editButton.classList.add('action-button');

                          editButton.onclick = function() {
                               currentItemType = 'group'; // Set type
                               editingItemId = this.closest('tr').dataset.itemId; // Get ID from row
                               editingItemRow = this.closest('tr'); // Get row reference

                               modalTitle.textContent = 'Upraviť skupinu';
                               showFormFields('group'); // Show only group fields

                               // TODO: Populate group form fields with current data (groupData)
                               // This requires fetching the specific group document again or storing data on the row
                               // groupCategorySelect.value = groupData.categoryId;
                               // groupNameInput.value = groupData.name;
                               // groupDetail1Input.value = groupData.detail1;
                               // groupDetail2Input.value = groupData.detail2;
                               itemIdInput.value = editingItemId; // Store ID
                               itemTypeInput.value = 'group'; // Store type

                               modal.style.display = 'block';
                               // Focus on first group input, e.g., groupCategorySelect.focus();
                          };

                          // === TLAČIDLO ZMAZAŤ (pre skupiny) ===
                          const deleteButton = document.createElement('button');
                          deleteButton.textContent = 'Zmazať';
                          deleteButton.classList.add('action-button', 'delete-button');

                          deleteButton.onclick = async function() {
                              const row = this.closest('tr');
                              const groupIdToDelete = row.dataset.itemId; // Use stored ID
                              const groupNameToDelete = row.querySelector('td:nth-child(2)').textContent; // Get name from row

                              if (!confirm(`Naozaj chcete zmazať skupinu "${groupNameToDelete}"?`)) {
                                  return;
                              }

                              try {
                                  await deleteDoc(doc(groupsCollectionRef, groupIdToDelete)); // Use ID for deletion
                                  row.remove();
                                  console.log(`Skupina "${groupNameToDelete}" (ID: ${groupIdToDelete}) bola úspešne zmazaná.`);
                                   // No need to re-load the whole table, just the row is removed
                              } catch (error) {
                                  console.error('Chyba pri mazaní skupiny: ', error);
                                  alert('Chyba pri mazaní skupiny!');
                              }
                          };

                          actionsTd.appendChild(editButton);
                          actionsTd.appendChild(deleteButton);
                          tr.appendChild(actionsTd); // Add the actions cell

                          groupsTableBodyEl.appendChild(tr); // Add row to the table body
                      });
                 }


             } catch (error) {
                 console.error('Chyba pri načítaní dát skupín z Firestore: ', error);
                 alert('Chyba pri načítaní dát skupín!');
                  const errorRow = document.createElement('tr');
                  const td = document.createElement('td');
                  td.colSpan = headers.length;
                  td.textContent = "Chyba pri načítaní dát skupín.";
                  td.style.textAlign = 'center';
                  td.style.fontStyle = 'italic';
                  errorRow.appendChild(td);
                  groupsTableBodyEl.appendChild(errorRow);
             }
         }


        // Funkcia na zobrazenie/skrytie tabuliek a nastavenie tlačidla "+" na základe hašu
        function toggleContentAndButton() { // Renamed function for clarity
            const hash = window.location.hash;
            const isCategoryPage = hash === '#kategorie';
            const isGroupsPage = hash === '#skupiny';

            // Skryť obe tabuľky a resetovať tlačidlo + (pred nastavením novej akcie)
            addButton.style.display = 'none'; // Hide initially
            categoryTable.style.display = 'none';
            groupsTable.style.display = 'none';

             // Clear table content (optional but good practice)
             categoryTableBody.innerHTML = '';
             if(groupsTableHeadTr) groupsTableHeadTr.innerHTML = '';
             if(groupsTableBodyEl) groupsTableBodyEl.innerHTML = '';


            if (isCategoryPage) {
                // Zobraziť prvky špecifické pre kategórie
                addButton.style.display = 'block'; // Show button
                categoryTable.style.display = 'table'; // Show table
                loadCategories(); // Load data

                // Nastaviť akciu tlačidla '+' pre pridávanie kategórie
                 addButton.onclick = function() {
                     currentItemType = 'category'; // Set type
                     editingItemId = null; // Not editing
                     editingItemRow = null;
                     modalTitle.textContent = 'Pridať kategóriu';
                     showFormFields('category'); // Show category fields

                     form.reset(); // Clear form fields
                     // categoryNameInput.required = true; // Ensure required is set

                     modal.style.display = 'block'; // Show modal
                     categoryNameInput.focus(); // Focus input
                 };

            } else if (isGroupsPage) {
                // Zobraziť prvky špecifické pre skupiny
                 addButton.style.display = 'block'; // Show button
                 groupsTable.style.display = 'table'; // Show table
                 loadGroupsTable(); // Load data (includes rendering header)

                 // Nastaviť akciu tlačidla '+' pre pridávanie skupiny
                  addButton.onclick = async function() { // Made async because we need to fetch categories
                      currentItemType = 'group'; // Set type
                      editingItemId = null; // Not editing
                      editingItemRow = null;
                      modalTitle.textContent = 'Pridať skupinu';
                      showFormFields('group'); // Show group fields

                      form.reset(); // Clear form fields
                       // groupCategorySelect.required = true; // Ensure required is set
                       // groupNameInput.required = true;


                      // Populate the category dropdown for the group form
                      try {
                          const categoriesSnapshot = await getDocs(categoriesCollectionRef);
                          groupCategorySelect.innerHTML = '<option value="">-- Vyberte kategóriu --</option>'; // Clear and add default
                          categoriesSnapshot.forEach(doc => {
                              const categoryId = doc.id;
                              const categoryData = doc.data();
                              const categoryName = categoryData.name || categoryId;
                              const option = document.createElement('option');
                              option.value = categoryId; // Use ID as value
                              option.textContent = categoryName;
                              groupCategorySelect.appendChild(option);
                          });
                           console.log("Dropdown kategórií pre skupiny naplnený.");
                      } catch (error) {
                          console.error("Chyba pri načítaní kategórií pre dropdown:", error);
                          // Handle error, maybe disable form or show message
                      }


                      modal.style.display = 'block'; // Show modal
                      groupCategorySelect.focus(); // Focus the first group input
                  };
            }
             // For any other hash, elements remain hidden and tables cleared.
        }


        // === EVENT LISTENERS ===

        // Handle modal close (X button or click outside)
        window.addEventListener('click', (e) => {
             if (e.target === modal || e.target === closeModalBtn) {
                  modal.style.display = 'none';
                  // Reset state after closing
                  currentItemType = null;
                  editingItemId = null;
                  editingItemRow = null;
                  form.reset(); // Clear form fields
                  showFormFields(null); // Hide all fields
              }
          });
          closeModalBtn.addEventListener('click', () => {
             modal.style.display = 'none';
             // Reset state after closing
             currentItemType = null;
             editingItemId = null;
             editingItemRow = null;
             form.reset(); // Clear form fields
             showFormFields(null); // Hide all fields
          });


        // Trigger toggleContentAndButton on page load and hash change
        window.addEventListener('hashchange', toggleContentAndButton);
        window.addEventListener('load', toggleContentAndButton);


        // Handle form submission (for both categories and groups)
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true; // Disable button on submit to prevent double clicks
            submitButton.textContent = 'Ukladám...'; // Provide feedback


            const type = itemTypeInput.value; // Get item type from hidden input
            const itemId = itemIdInput.value || null; // Get item ID (null if adding)


            if (type === 'category') {
                 const categoryName = categoryNameInput.value.trim();
                 if (categoryName === '') { alert('Názov kategórie nemôže byť prázdny.'); submitButton.disabled = false; submitButton.textContent = 'Uložiť'; return; }

                 const docRef = itemId ? doc(categoriesCollectionRef, itemId) : doc(categoriesCollectionRef); // Use ID if editing, let Firestore generate if adding

                 try {
                     if (!itemId) { // Adding Category
                         // Check if category with this name already exists (only when adding)
                          const existingDoc = await getDoc(doc(categoriesCollectionRef, categoryName)); // Check using the name as ID
                          if (existingDoc.exists()) { alert(`Kategória "${categoryName}" už existuje!`); submitButton.disabled = false; submitButton.textContent = 'Uložiť'; return; }

                         // Save new category
                         await setDoc(doc(categoriesCollectionRef, categoryName), { // Use name as document ID
                             createdAt: new Date()
                              // You might want to save the name *inside* the document too, not just as ID
                              // name: categoryName
                         });
                         console.log(`Kategória "${categoryName}" bola úspešne pridaná.`);
                         // Reload the category table after adding
                         loadCategories();

                     } else { // Editing Category (renaming)
                         // Firestore document IDs are immutable. Renaming means deleting the old and creating a new one.
                         const oldCategoryName = editingItemRow.querySelector('td:first-child').textContent; // Get old name from the row
                         if (categoryName === oldCategoryName) {
                            console.log('Nový názov kategórie je rovnaký ako pôvodný. Žiadna zmena.');
                         } else {
                            // Check if a category with the NEW name already exists
                             const existingDoc = await getDoc(doc(categoriesCollectionRef, categoryName)); // Check using the NEW name as ID
                             if (existingDoc.exists()) { alert(`Kategória s názvom "${categoryName}" už existuje!`); submitButton.disabled = false; submitButton.textContent = 'Uložiť'; return; }

                            // Get data from the old document before deleting
                             const oldDocRef = doc(categoriesCollectionRef, itemId); // Use the original ID (which is the old name)
                             const oldDocSnapshot = await getDoc(oldDocRef);
                             if (!oldDocSnapshot.exists()) {
                                  console.error(`Pôvodný dokument kategórie ${itemId} nenájdený pre premenovanie.`);
                                  alert('Chyba: Pôvodná kategória nebola nájdená.');
                                   submitButton.disabled = false; submitButton.textContent = 'Uložiť';
                                  return;
                             }
                             const oldDocData = oldDocSnapshot.data();

                            // Create new document with the new name as ID, copy data
                            await setDoc(doc(categoriesCollectionRef, categoryName), oldDocData);

                            // Delete the old document
                            await deleteDoc(oldDocRef);

                             console.log(`Kategória "${oldCategoryName}" (ID: ${itemId}) úspešne premenovaná na "${categoryName}".`);
                             // Reload the category table after editing
                             loadCategories(); // Simpler to reload than update the row manually after rename

                         }
                     }

                     modal.style.display = 'none';
                     form.reset();
                     // Reset state after successful operation
                     currentItemType = null; editingItemId = null; editingItemRow = null;
                     showFormFields(null); // Hide fields

                     // Re-render groups table if active and categories changed
                     if (window.location.hash === '#skupiny') {
                          loadGroupsTable(); // Reload groups table (its header depends on categories)
                     }


                 } catch (error) {
                     console.error(`Chyba pri ukladaní kategórie (${itemId ? 'úprava' : 'pridávanie'}): `, error);
                     alert(`Chyba pri ukladaní kategórie! ${error.message}`);
                 } finally {
                     submitButton.disabled = false;
                     submitButton.textContent = 'Uložiť';
                 }

            } else if (type === 'group') {
                 // === LOGIKA PRIDÁVANIA/ÚPRAVY SKUPINY (TODO) ===
                 console.log(`TODO: Implementovať logiku ${itemId ? 'úpravy' : 'pridávania'} skupiny.`);

                 const categoryId = groupCategorySelect.value;
                 const groupName = groupNameInput.value.trim();
                 const detail1 = groupDetail1Input.value.trim();
                 const detail2 = groupDetail2Input.value.trim();

                 if (categoryId === '') { alert('Vyberte kategóriu.'); submitButton.disabled = false; submitButton.textContent = 'Uložiť'; return; }
                 if (groupName === '') { alert('Názov skupiny nemôže byť prázdny.'); submitButton.disabled = false; submitButton.textContent = 'Uložiť'; return; }


                 try {
                     if (!itemId) { // Adding Group
                         // Optional: Check for duplicate group name within the same category before adding
                          // You would need a query: where('categoryId', '==', categoryId).where('name', '==', groupName)
                          // const q = query(groupsCollectionRef, where('categoryId', '==', categoryId), where('name', '==', groupName));
                          // const querySnapshot = await getDocs(q);
                          // if (!querySnapshot.empty) { alert(`Skupina s názvom "${groupName}" už v tejto kategórii existuje!`); submitButton.disabled = false; submitButton.textContent = 'Uložiť'; return; }


                         // Add a new group document. Firestore generates the ID.
                         await setDoc(doc(groupsCollectionRef), { // Let Firestore generate ID
                              categoryId: categoryId,
                              name: groupName,
                              detail1: detail1,
                              detail2: detail2,
                             createdAt: new Date()
                         });
                          console.log(`Skupina "${groupName}" pridaná do kategórie ${categoryId}.`);

                     } else { // Editing Group
                          // Update the existing group document using the stored itemId
                          const groupDocRef = doc(groupsCollectionRef, itemId);
                          await setDoc(groupDocRef, { // Use setDoc with merge: true if you only want to update some fields
                               categoryId: categoryId, // Can change category during edit
                               name: groupName,
                               detail1: detail1,
                               detail2: detail2,
                              // Don't update createdAt here
                          }, { merge: true }); // Use merge: true to avoid overwriting the whole document
                           console.log(`Skupina (ID: ${itemId}) úspešne aktualizovaná.`);
                     }

                      // After adding/editing a group, reload the groups table data
                      loadGroupsTable(); // This will re-fetch and re-render the entire table body

                      modal.style.display = 'none';
                      form.reset();
                      // Reset state
                      currentItemType = null; editingItemId = null; editingItemRow = null;
                      showFormFields(null); // Hide fields


                 } catch (error) {
                      console.error(`Chyba pri ukladaní skupiny (${itemId ? 'úprava' : 'pridávanie'}): `, error);
                     alert(`Chyba pri ukladaní skupiny! ${error.message}`);
                 } finally {
                      submitButton.disabled = false;
                      submitButton.textContent = 'Uložiť';
                 }

             } // End of group submit logic
        }); // End of form.addEventListener('submit')


    </script>

</body>
</html>
