<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Správca turnaja</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="style.css">

    <style>
        /* --- General Styles --- */
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-top: 20px;
            margin-bottom: 20px; /* Added margin-bottom for separation */
        }

        h2 {
            margin-top: 0; /* Reset margin-top, controlled by section padding */
            margin-bottom: 10px;
            color: #555;
        }

        .add-button {
            display: block;
            margin: 20px auto;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #28a745;
            color: white;
            font-size: 2em;
            border: none;
            cursor: pointer;
            text-align: center;
            line-height: 50px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.3s ease;
            position: sticky;
            top: 20px;
            z-index: 10;
        }

        .add-button:hover {
            background-color: #218838;
        }

        .content-wrapper {
            display: flex;
            margin-top: 20px;
            padding: 0 20px;
        }

        .left-menu {
            width: 200px;
            margin-right: 20px;
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky;
            top: 90px;
            align-self: flex-start;
            max-height: calc(100vh - 110px);
            overflow-y: auto;
        }

        .left-menu ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .left-menu li {
            margin-bottom: 10px;
        }

        .left-menu a {
            text-decoration: none;
            color: #007bff;
            font-weight: bold;
            display: block;
            padding: 5px 0;
            transition: color 0.3s ease;
        }

        .left-menu a:hover {
            color: #0056b3;
        }

        main {
            flex-grow: 1;
            padding: 0;
            box-shadow: none;
            background-color: transparent;
        }

        /* --- Section Block Style --- */
        .section-block {
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px; /* Space below each block */
        }


        /* --- Table Styles --- */
        /* Styles for the table element itself, regardless of the wrapper */
        #categoryTable, .category-group-table, .group-clubs-table, #clubsTable, #createdTeamsTable {
            border-collapse: collapse;
            width: 100%;
            border: none;
            overflow: hidden;
        }


        /* Style for the section wrapping category heading and group table */
        .category-group-section {
            /* Inherits background, padding, radius, shadow from .section-block */
            /* Flex properties only for group sections when inside #groupsContent */
            min-width: 300px;
            flex-grow: 1;
            flex-basis: 0;
        }

        /* Style for the main container of group sections (the flex container) */
        #groupsContent {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: flex-start;
            padding: 0;
            margin-bottom: 20px;
        }
         #groupsContent .section-block {
             margin-bottom: 0; /* Override margin for flex items */
         }


        /* Remove margin-top from the first element inside a section block */
        .section-block h2:first-child,
        .section-block table:first-child {
            margin-top: 0;
        }


        /* Table Header and Cell Styles - apply to all tables */
        #categoryTable th, #clubsTable th, .category-group-table th, .group-clubs-table th, #createdTeamsTable th {
            background-color: #f2f2f2;
            color: #333;
            font-weight: bold;
            text-align: left;
            padding: 12px 15px;
            border-bottom: 2px solid #ddd;
        }

        #categoryTable td, #clubsTable td, .category-group-table td, .group-clubs-table td, #createdTeamsTable td {
            text-align: left;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
        }

        /* Remove bottom border from last row in tbody for all tables */
        #categoryTable tbody tr:last-child td,
        #clubsTable tbody tr:last-child td,
        .category-group-table tbody tr:last-child td,
        .group-clubs-table tbody tr:last-child td,
        #createdTeamsTable tbody tr:last-child td {
             border-bottom: none;
        }

        /* Hover effect for all table rows */
        #categoryTable tbody tr:hover,
        #clubsTable tbody tr:hover,
        .category-group-table tbody tr:hover,
        .group-clubs-table tbody tr:hover,
        #createdTeamsTable tbody tr:hover {
            background-color: #f9f9f9;
            cursor: pointer;
        }

        /* Ensure last cell in row doesn't wrap buttons */
        #categoryTable td:last-child,
        #clubsTable td:last-child,
        .category-group-table td:last-child,
        .group-clubs-table td:last-child,
        #createdTeamsTable td:last-child {
             white-space: nowrap;
        }

        #clubsContent {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: flex-start;
            padding: 0;
            margin-bottom: 20px;
        }

        /* Style for container divs that wrap club sections when inside #clubsContent */
        #clubsContent .section-block {
            /* Inherits background, padding, radius, shadow from .section-block */
            min-width: 300px;
            flex-grow: 1;
            flex-basis: calc(33.33% - 20px);
            margin-bottom: 0; /* Override the default .section-block margin when inside flex */
        }

        #teamCreationContentSection table {
            /* Ensure table within section block takes full width */
             width: 100%;
        }

        /* Style for number count in the created teams table */
        #createdTeamsTable td {
             text-align: center; /* Center the count numbers */
             width: 50px; /* Give count columns a fixed width */
        }
         #createdTeamsTable td:first-child {
              text-align: left; /* Keep team name left-aligned */
              width: auto; /* Let team name take available width */
         }
          #createdTeamsTable th {
               text-align: center; /* Center header text for categories */
               white-space: nowrap; /* Prevent text wrapping in headers */
          }
          #createdTeamsTable th:first-child {
               text-align: left; /* Keep team name header left-aligned */
          }

          /* Style for the dynamically added sub-rows */
           #createdTeamsTable tr.sub-row td {
                background-color: #e9ecef; /* Slightly different background */
                font-size: 0.9em; /* Smaller font */
                padding-left: 35px; /* Indent the text */
                border-top: none; /* Remove top border */
                border-bottom: 1px dotted #ccc; /* Dotted border below sub-row */
           }

           #createdTeamsTable tr.sub-row:last-child td {
                border-bottom: 1px solid #eee; /* Restore standard border for the last sub-row before next main row */
           }

           #createdTeamsTable tr.sub-row td:not(:first-child) {
                /* Keep category cells empty or add specific info if needed */
                text-align: center; /* Center the '1' or empty */
                font-weight: normal;
           }
            #createdTeamsTable tr.sub-row td:first-child {
                 font-weight: normal; /* Normal font weight for the sub-team name */
            }

           /* Optional: Style for clickable count cells */
           #createdTeamsTable td[data-team-count]:not([data-team-count=""]):not([data-team-count="0"]) {
                cursor: pointer;
                text-decoration: underline;
                color: #007bff;
           }
           #createdTeamsTable td[data-team-count]:not([data-team-count=""]):not([data-team-count="0"]):hover {
                color: #0056b3;
           }

        #createdTeamsTable tbody td.base-name-cell {
            cursor: pointer; /* Zmení kurzor myši na ručičku */
            /* Optional styles, e.g., bold text or different color */
            /* font-weight: bold; */
            /* color: #0056b3; */
        }

        /* Štýly pre klikateľné bunky v tabuľke Vytvorenie Tímov (počet tímov) */
        #createdTeamsTable tbody td[data-team-count] {
            color: #333 !important; /* Nastaví farbu textu na tmavošedú a !important zabezpečí prepísanie iných pravidiel */
            text-decoration: none !important; /* Odstráni podčiarknutie a !important zabezpečí prepísanie */
            cursor: pointer; /* Zmení kurzor myši */

            /* Zabezpečí, že text v bunke nemá žiadne špeciálne štýly odkazov */
            font-weight: normal; /* Zabezpečí normálnu hrúbku písma */
            font-style: normal;  /* Zabezpečí normálny štýl písma (nie kurzívu, ktorá sa niekedy používa pre linky) */

            /* Potlačiť focus outline, ktorý sa môže zobraziť pri kliknutí/tabulovaní a pripomínať link */
            outline: none !important;
        }

        /* Voliteľné: Pridajte efekt pri nabehnutí myšou, ak chcete vizuálne naznačiť, že je to klikateľné */
        #createdTeamsTable tbody td[data-team-count]:hover {
            color: #007bff; /* Príklad: Zmení farbu textu na modrú pri nabehnutí myšou */
            /* text-decoration: underline; */ /* Alebo pridajte podčiarknutie pri nabehnutí myšou */
        }

        #createdTeamsTable thead th.category-header-cell {
            cursor: pointer; /* Zmení kurzor myši na ručičku */
            /* Optional: Add hover effect */
            /* background-color: #e9ecef; */
        }

        /* --- Action Button Styles --- */
        .action-button {
            padding: 5px 10px;
            margin-right: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
        }

        .action-button:not(.delete-button) {
            background-color: #007bff;
            color: white;
        }

        .action-button.delete-button {
            background-color: #dc3545;
            color: white;
        }

        .action-button:not(.delete-button):hover { background-color: #0056b3; }
        .action-button.delete-button:hover { background-color: #c82333; }


        /* --- Modal Styles --- */
         .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            padding-top: 60px;
         }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
            position: relative;
        }

        .close {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover, .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-content form label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

         .modal-content form input[type="text"],
         .modal-content form input[type="number"],
         .modal-content form select {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
         }
         /* Adjust select height for multiple */
         .modal-content form select[multiple] {
              min-height: 100px; /* Or adjust as needed */
         }


        .modal-content form button {
            background-color: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }

         .modal-content form button:hover {
            background-color: #218838;
         }

         /* Style for the container divs around specific form elements */
         .modal-content form div {
             margin-bottom: 20px; /* Add spacing below input groups */
         }
         .modal-content form div:last-of-type {
              margin-bottom: 0; /* Remove bottom margin for the last one before the button */
         }
          .modal-content form label,
          .modal-content form input[type="text"],
          .modal-content form input[type="number"],
          .modal-content form select {
              margin-bottom: 0; /* Remove margin from elements inside the div */
          }

          /* Style for dynamically added field groups */
          .category-count-group {
              border: 1px solid #ddd;
              padding: 15px;
              margin-bottom: 15px;
              border-radius: 4px;
              background-color: #f9f9f9;
              position: relative; /* Needed for absolute positioning of remove button */
          }

          .category-count-group .remove-group-button {
              position: absolute;
              top: 5px;
              right: 5px;
              background: none;
              border: none;
              font-size: 1.2em;
              color: #dc3545;
              cursor: pointer;
          }

          .category-count-group .remove-group-button:hover {
              color: #c82333;
          }


</style>
 </head>
 <body>
     <script>
         // Basic check for admin, redirect if not
         const userName = localStorage.getItem('username');
         if (userName !== 'admin') {
              window.location.href = 'login.html';
         }
     </script>

     <h1>Správca turnaja</h1>

     <button class="add-button" id="addButton" title="Pridať položku">+</button>

     <div class="modal" id="categoryModal">
         <div class="modal-content">
             <span class="close category-modal-close">&times;</span>
             <h2 id="categoryModalTitle">Pridať kategóriu</h2>
             <form id="categoryForm">
                 <div>
                     <label for="categoryName">Názov kategórie:</label>
                     <input type="text" id="categoryName" name="categoryName" required>
                 </div>
                 <button type="submit">Uložiť</button>
             </form>
         </div>
     </div>

      <div class="modal" id="groupModal">
          <div class="modal-content">
                  <span class="close group-modal-close">&times;</span>
                  <h2 id="groupModalTitle">Pridať skupinu</h2>
                  <form id="groupForm">
                      <div>
                           <label for="groupCategory">Kategória:</label>
                           <select id="groupCategory" name="groupCategory" required>
                                <option value="">-- Vyberte kategóriu --</option>
                                </select>
                      </div>

                      <div>
                           <label for="groupName">Názov skupiny:</label>
                           <input type="text" id="groupName" name="groupName" required>
                      </div>

                      <button type="submit">Uložiť</button>
                  </form>
          </div>
      </div>

     <div class="modal" id="clubModal">
          <div class="modal-content">
                  <span class="close club-modal-close">&times;</span>
                  <h2 id="clubModalTitle">Priradiť tím do skupiny</h2> <form id="clubForm">
                        <div id="unassignedClubSelectContainer">
                           <label for="unassignedClubSelect">Vyberte existujúci tím:</label>
                           <select id="unassignedClubSelect"> <option value="">-- Vyberte tím na priradenie --</option>
                                </select>
                       </div>

                       <div id="clubNameInputContainer">
                           <label for="clubName">Názov klubu:</label>
                           <input type="text" id="clubName" name="clubName" required>
                        </div>

                       <div>
                           <label for="clubCategory">Kategória:</label>
                           <select id="clubCategory" name="clubCategory" required>
                                <option value="">-- Vyberte kategóriu --</option>
                                </select>
                       </div>

                       <div>
                            <label for="clubGroup">Skupina:</label>
                            <select id="clubGroup" name="clubGroup" required disabled> <option value="">-- Najprv vyberte kategóriu --</option>
                                 </select>
                       </div>

                        <button type="submit">Uložiť</button>
                   </form>
          </div>
      </div>

     <div class="modal" id="teamCreationModal">
         <div class="modal-content">
             <span class="close team-creation-modal-close">&times;</span>
             <h2 id="teamCreationModalTitle">Vytvoriť tímy</h2>
             <form id="teamCreationForm">
                 <div>
                     <label for="teamNameInput">Názov tímu:</label>
                     <input type="text" id="teamNameInput" name="teamName" required>
                 </div>

                 <div class="category-count-group" id="initialCategoryCountGroup">
                     <label for="teamCategorySelect">Kategória:</label> <select id="teamCategorySelect" name="teamCategory" required> <option value="">-- Vyberte kategóriu --</option>
                     </select>

                     <label for="teamCountInput">Počet tímov:</label> <input type="number" id="teamCountInput" name="teamCount" min="1" value="1" required>
                 </div>

                 <div id="dynamicCategoryCountContainer">
                     </div>

                 <button type="button" id="addCategoryCountPairButton" class="action-button">+ Pridať ďalšiu kategóriu</button>


                 <button type="submit">Vytvoriť</button>
             </form>
         </div>
     </div>


     <div class="content-wrapper">
         <nav class="left-menu">
             <ul>
                 <li><a href="#kategorie">Vytvorenie kategórií</a></li>
                 <li><a href="#skupiny">Vytvorenie skupín</a></li>
                 <li><a href="#vytvorenie-timov">Vytvorenie tímov</a></li> 
                 <li><a href="#timy-do-skupin">Tímy do skupín</a></li>
                 <li><a href="#sportove-haly">Športové haly</a></li>
                 <li><a href="#sprava-turnaja">Správa turnaja</a></li>
                 <li><a href="#nastavenia">Nastavenia</a></li>
             </ul>
         </nav>

         <main>
             <div id="categoriesContentSection" class="section-block" style="display: none;">
                  <h2>Vytvorenie kategórií</h2>
                 <table id="categoryTable">
                     <thead>
                         <tr>
                             <th>Názov</th>
                             <th style="width: 150px;">Upraviť</th>
                         </tr>
                     </thead>
                     <tbody id="categoryTableBody">
                         </tbody>
                 </table>
             </div>

             <div id="groupsContent" style="display: none;">
                 </div>

             <div id="clubsContent" style="display: none;">
                  </div>

              <div id="teamCreationContentSection" class="section-block" style="display: none;">
                  <h2>Vytvorenie tímov</h2>
                  <table id="createdTeamsTable">
                      <thead>
                          </thead>
                      <tbody id="createdTeamsTableBody">
                          </tbody>
                  </table>
             </div>

             </main>
     </div>

    
    <script type="module">
        // === 1. IMPORTS ===
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, query, where, addDoc, updateDoc, writeBatch } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';
        import { FieldPath } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js'; // Pre FieldPath.documentId()


        // === 2. FIREBASE CONFIG AND INITIALIZATION ===
        const firebaseConfig = {
            apiKey: "AIzaSyD0h0rQZiIGi0-UDb4-YU_JihRGpIlfz40", // ZMEŇ ZA SVOJ SKUTOČNÝ API KĽÚČ
            authDomain: "turnaj-a28c5.firebaseapp.com", // ZMEŇ ZA SVOJ SKUTOČNÝ authDomain
            projectId: "turnaj-a28c5", // ZMEŇ ZA SVOJ SKUTOČNÝ projectId
            storageBucket: "turnaj-a28c5.firebaseystorage.app", // ZMEŇ ZA SVOJ SKUTOČNÝ storageBucket
            messagingSenderId: "13732191148", // ZMEŇ ZA SVOJ SKUTOČNÝ messagingSenderId
            appId: "1:13732191148:web:5ad78eaef2ad452a10f809" // ZMEŇ ZA SVOJ SKUTOČNÝ appId
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // === 3. FIREBASE COLLECTION REFERENCES ===
        const categoriesCollectionRef = collection(db, 'tournamentData', 'mainTournamentData', 'categories');
        const groupsCollectionRef = collection(db, 'tournamentData', 'mainTournamentData', 'groups'); // Groups use composite IDs
        const clubsCollectionRef = collection(db, 'tournamentData', 'mainTournamentData', 'clubs'); // Clubs now use auto-generated IDs


        // === 4. DOM ELEMENT REFERENCES ===
        const addButton = document.getElementById('addButton');

        // Modál Kategórie
        const categoryModal = document.getElementById('categoryModal');
        const categoryModalCloseBtn = categoryModal.querySelector('.category-modal-close');
        const categoryForm = document.getElementById('categoryForm');
        const categoryNameInput = document.getElementById('categoryName');
        const categoryModalTitle = document.getElementById('categoryModalTitle');

        // Modál Skupiny
        const groupModal = document.getElementById('groupModal');
        const groupModalCloseBtn = groupModal.querySelector('.group-modal-close');
        const groupForm = document.getElementById('groupForm');
        const groupCategorySelect = document.getElementById('groupCategory');
        const groupNameInput = document.getElementById('groupName');
        const groupModalTitle = document.getElementById('groupModalTitle');
        const groupFormSubmitButton = groupForm.querySelector('button[type="submit"]');

        // Modál Kluby (pre priradenie do skupín)
        const clubModal = document.getElementById('clubModal');
        const clubModalCloseBtn = clubModal.querySelector('.club-modal-close');
        const clubForm = document.getElementById('clubForm');
        const clubNameInput = document.getElementById('clubName'); // Existing name input (used when editing assigned)
        const clubCategorySelect = document.getElementById('clubCategory');
        const clubGroupSelect = document.getElementById('clubGroup');
        const clubModalTitle = document.getElementById('clubModalTitle');
        const clubFormSubmitButton = clubForm.querySelector('button[type="submit"]');

        // NEW REFERENCES FOR CLUB MODAL CHANGES (add/edit assigned)
        const unassignedClubSelectContainer = document.getElementById('unassignedClubSelectContainer');
        const unassignedClubSelect = document.getElementById('unassignedClubSelect');
        const clubNameInputContainer = document.getElementById('clubNameInputContainer');


        // NEW: Modál Vytvorenie Tímov
        const teamCreationModal = document.getElementById('teamCreationModal');
        const teamCreationModalCloseBtn = teamCreationModal.querySelector('.team-creation-modal-close');
        const teamCreationForm = document.getElementById('teamCreationForm');
        const teamNameInput = document.getElementById('teamNameInput'); // Input for base team name

        // References for the initial category/count fields
        const initialCategoryCountGroup = document.getElementById('initialCategoryCountGroup');
        const teamCategorySelect = document.getElementById('teamCategorySelect'); // Initial Category select
        const teamCountInput = document.getElementById('teamCountInput'); // Initial Count input

        // Reference for the container of dynamic fields
        const dynamicCategoryCountContainer = document.getElementById('dynamicCategoryCountContainer');
        // Reference for the button to add more fields
        const addCategoryCountPairButton = document.getElementById('addCategoryCountPairButton');


        const teamCreationModalTitle = document.getElementById('teamCreationModalTitle');


        // Zobrazované sekcie (obalové divy)
        const categoriesContentSection = document.getElementById('categoriesContentSection'); // Obalový div pre kategórie
        const groupsContentDiv = document.getElementById('groupsContent'); // Flex kontajner pre skupiny
        const clubsContentDiv = document.getElementById('clubsContent'); // Flex kontajner pre kluby v skupinách (priradené)
        // NEW: Obalový div pre sekciu Vytvorenie Tímov (nepriradené)
        const teamCreationContentSection = document.getElementById('teamCreationContentSection');


        // Referencie na samotné tabuľky (pre manipuláciu s tbody)
        const categoryTable = document.getElementById('categoryTable');
        const categoryTableBody = document.getElementById('categoryTableBody');

        // NEW: Referencia na tbody tabuľky Vytvorenie Tímov a thead
        const createdTeamsTable = document.getElementById('createdTeamsTable'); // Added reference to the table itself
        const createdTeamsTableHead = createdTeamsTable.querySelector('thead'); // Added reference to thead
        const createdTeamsTableBody = document.getElementById('createdTeamsTableBody');


        // === 5. STATE VARIABLES ===
        let currentCategoryModalMode = 'add';
        let editingCategoryName = null;

        let currentGroupModalMode = 'add';
        let editingGroupId = null;

        let currentClubModalMode = 'add-assign';
        let editingClubId = null;

        let currentTeamCreationModalMode = 'add';

        let allCategories = [];

        let isDisplaying = false; // DEBOUNCE FLAG

        // Premenná na sledovanie aktívneho filtra kategórie pre tabuľku vytvorených tímov
        let currentCategoryFilter = null; // <<< TOTO JE JEDINÁ SPRÁVNA DEKLARÁCIA

        // === 6. HELPER FUNCTIONS (called by display/modal functions) ===

        // Funkcia na pridanie riadku kategórie do tabuľky (používa ju loadCategoriesTable)
        function addCategoryRowToTable(categoryName) {
            const tr = document.createElement('tr');
            const nameTd = document.createElement('td');
            nameTd.textContent = categoryName;
            const actionsTd = document.createElement('td');
            actionsTd.style.whiteSpace = 'nowrap';

            const renameButton = document.createElement('button');
            renameButton.textContent = 'Premenovať';
            renameButton.classList.add('action-button');
            renameButton.onclick = function() {
                currentCategoryModalMode = 'edit';
                editingCategoryName = categoryName;
                categoryModalTitle.textContent = 'Premenovať kategóriu';
                categoryNameInput.value = categoryName;
                categoryModal.style.display = 'block';
                categoryNameInput.focus();
            };

            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Vymazať';
            deleteButton.classList.add('action-button', 'delete-button');
            deleteButton.onclick = async function() {
                const categoryToDelete = this.closest('tr').querySelector('td:first-child').textContent;

                if (!confirm(`Naozaj chcete vymazať kategóriu "${categoryToDelete}"? Akékoľvek priradené skupiny a kluby prídu o svoju kategóriu (categoryId a groupId sa nastavia na null)!`)) {
                    return;
                }

                try {
                    const batch = writeBatch(db);

                    // Nájdi a aktualizuj skupiny s touto kategóriou
                    const groupsQuery = query(groupsCollectionRef, where('categoryId', '==', categoryToDelete));
                    const groupsSnapshot = await getDocs(groupsQuery);

                    const clubUpdates = [];
                    for (const groupDoc of groupsSnapshot.docs) {
                        const clubsInGroupQuery = query(clubsCollectionRef, where('groupId', '==', groupDoc.id));
                        const clubsSnapshot = await getDocs(clubsInGroupQuery);
                        clubsSnapshot.forEach(clubDoc => {
                            clubUpdates.push({
                                ref: clubDoc.ref,
                                updates: {
                                    categoryId: null,
                                    groupId: null
                                }
                            }); // Update club with null categoryId and null groupId
                            console.log(`Klub "${clubDoc.id}" odpriradený kvôli zmazaniu skupiny.`);
                        });
                        batch.delete(groupDoc.ref); // Delete old group doc
                        console.log(`Stará skupina "${groupDoc.id}" zmazaná po premenovaní kategórie.`); // Clarified log
                    }

                    clubUpdates.forEach(item => {
                        batch.update(item.ref, item.updates);
                    });

                    // Nájdi a aktualizuj kluby s touto kategóriou, ktoré už nemusia byť priradené k skupine (groupId == null)
                    const unassignedClubsQuery = query(clubsCollectionRef, where('categoryId', '==', categoryToDelete), where('groupId', '==', null));
                    const unassignedClubsSnapshot = await getDocs(unassignedClubsQuery);
                    unassignedClubsSnapshot.forEach(doc => {
                        batch.update(doc.ref, {
                            categoryId: null
                        }); // Just update categoryId to null
                        console.log(`Nepriradený klub "${doc.id}" aktualizovaný (categoryId).`);
                    });

                    batch.delete(doc(categoriesCollectionRef, categoryToDelete)); // Delete old category doc using old name

                    await batch.commit();

                    console.log(`Kategória "${categoryToDelete}" a súvisiace referencie boli úspešne zmazané/aktualizované.`);

                    loadCategoriesTable(); // Always refresh category table
                    if (window.location.hash === '#skupiny') displayGroupsByCategory();
                    if (window.location.hash === '#timy-do-skupin') displayClubs();
                    if (window.location.hash === '#vytvorenie-timov') displayCreatedTeams();

                    cacheAllCategories(); // Refresh cached categories after deletion


                } catch (error) {
                    console.error('Chyba pri mazaní kategórie a súvisiacich dát: ', error);
                    alert('Chyba pri mazaní kategórie! Prosím, skúste znova.');
                    categoryModal.style.display = 'none';
                    categoryForm.reset();
                    currentCategoryModalMode = 'add';
                    editingCategoryName = null;
                }
            };

            actionsTd.appendChild(renameButton);
            actionsTd.appendChild(deleteButton);
            tr.appendChild(nameTd);
            tr.appendChild(actionsTd);
            categoryTableBody.appendChild(tr); // Append directly to tbody
        }


        // NEW: Cache all categories for dynamic select population
        async function cacheAllCategories() {
            try {
                const querySnapshot = await getDocs(categoriesCollectionRef);
                // Sort categories alphabetically by name (doc.id)
                allCategories = querySnapshot.docs.map(doc => doc.id).sort();
                console.log(`Cached ${allCategories.length} categories.`);
            } catch (error) {
                console.error('Error caching categories:', error);
                allCategories = []; // Clear cache on error
            }
        }


        // Funkcia na načítanie kategórií a naplnenie <select> (používa ju populateGroupSelect, openGroupModal, openClubModal, teamCreationForm logic)
        async function populateCategorySelect(selectElement, selectedCategoryId = null, excludedCategoryIds = []) {
            selectElement.innerHTML = '<option value="">-- Vyberte kategóriu --</option>';
            selectElement.disabled = true; // Disable while loading

            try {
                const categoriesToPopulate = allCategories.length > 0 ? allCategories : (await getDocs(categoriesCollectionRef)).docs.map(doc => doc.id).sort();
                if (allCategories.length === 0 && categoriesToPopulate.length > 0) {
                    console.log("Populating from fresh fetch, caching now.");
                    allCategories = categoriesToPopulate; // Cache if fetched fresh
                }

                if (categoriesToPopulate.length === 0) {
                    console.log("Žiadne kategórie pre naplnenie selectu.");
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "-- Žiadne kategórie --";
                    option.disabled = true;
                    selectElement.appendChild(option);
                    selectElement.disabled = false;
                } else {
                    selectElement.disabled = false;
                    const availableCategories = categoriesToPopulate.filter(catId => !excludedCategoryIds.includes(catId));

                    if (availableCategories.length === 0) {
                        const option = document.createElement('option');
                        option.value = "";
                        option.textContent = "-- Žiadne dostupné kategórie --";
                        option.disabled = true;
                        selectElement.appendChild(option);
                    } else {
                        availableCategories.forEach((categoryName) => {
                            const option = document.createElement('option');
                            option.value = categoryName;
                            option.textContent = categoryName;
                            selectElement.appendChild(option);
                        });

                        if (selectedCategoryId && !Array.isArray(selectedCategoryId)) {
                            if (selectElement.querySelector(`option[value="${selectedCategoryId}"]`)) {
                                selectElement.value = selectedCategoryId;
                            } else {
                                console.warn(`Kategória "${selectedCategoryId}" pre zvolenú položku nenájdená v zozname dostupných kategórií.`);
                                selectElement.value = "";
                            }
                        } else if (Array.isArray(selectedCategoryId)) {
                            console.warn("populateCategorySelect received an array for selectedCategoryId but select is not multiple.");
                            selectElement.value = "";
                        }
                    }
                }
            } catch (error) {
                console.error('Chyba pri načítaní kategórií pre select: ', error);
                selectElement.innerHTML = '<option value="">Chyba pri načítaní kategórií</option>';
                selectElement.disabled = true;
            } finally {
                if (allCategories.length === 0) {
                    cacheAllCategories(); // Attempt to cache after initial load
                }
            }
        }

        // Funkcia na načítanie skupín pre danú kategóriu a naplnenie <select> (používa ju populateUnassignedClubsSelect, openClubModal)
        async function populateGroupSelect(categoryId, selectElement, selectedGroupId = null) {
            selectElement.innerHTML = '<option value="">-- Vyberte skupinu --</option>';
            selectElement.disabled = true;


            if (!categoryId || categoryId === '-- Vyberte kategóriu --') {
                selectElement.innerHTML = '<option value="">-- Najprv vyberte kategóriu --</option>';
                selectElement.disabled = true;
                return;
            }

            selectElement.disabled = true;

            try {
                const q = query(groupsCollectionRef, where('categoryId', '==', categoryId));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    console.log(`Žiadne skupiny nájdené pre kategóriu "${categoryId}".`);
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "-- Žiadne skupiny v kategórii --";
                    option.disabled = true;
                    selectElement.appendChild(option);

                } else {
                    console.log(`Načítané skupín pre kategóriu "${categoryId}".`);
                    const sortedDocs = querySnapshot.docs.sort((a, b) => (a.data().name || '').localeCompare(b.data().name || ''));

                    sortedDocs.forEach((doc) => {
                        const groupData = doc.data();
                        const groupId = doc.id;
                        const groupName = groupData.name;

                        const option = document.createElement('option');
                        option.value = groupId;
                        option.textContent = groupName;
                        selectElement.appendChild(option);
                    });

                    if (selectedGroupId) {
                        if (selectElement.querySelector(`option[value="${selectedGroupId}"]`)) {
                            selectElement.value = selectedGroupId;
                        } else {
                            console.warn(`Skupina "${selectedGroupId}" pre zvolenú položku nenájdená v zozname skupín pre túto kategóriu.`);
                            selectElement.value = "";
                        }
                    }
                }
                selectElement.disabled = false;

            } catch (error) {
                console.error('Chyba pri načítaní skupín pre select: ', error);
                selectElement.innerHTML = '<option value="">Chyba pri načítaní skupín</option>';
                selectElement.disabled = true;
            }
        }


        // NEW: Funkcia na načítanie nepriradených tímov a naplnenie selectu v modáli klubu (používa ju openClubModal)
        async function populateUnassignedClubsSelect(selectElement, selectedClubId = null) {
            selectElement.innerHTML = '<option value="">-- Vyberte tím na priradenie --</option>';
            selectElement.disabled = true;

            try {
                const q = query(clubsCollectionRef, where('groupId', '==', null));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    console.log("Žiadne nepriradené tímy na priradenie.");
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "-- Žiadne tímy na priradenie --";
                    option.disabled = true;
                    selectElement.appendChild(option);
                    selectElement.disabled = false;
                } else {
                    selectElement.disabled = false;
                    const sortedDocs = querySnapshot.docs.sort((a, b) => (a.data().name || '').localeCompare(b.data().name || ''));

                    sortedDocs.forEach((doc) => {
                        const clubData = doc.data();
                        const clubId = doc.id;

                        const option = document.createElement('option');
                        option.value = clubId;
                        option.textContent = clubData.name;
                        selectElement.appendChild(option);
                    });

                    if (selectedClubId) {
                        if (selectElement.querySelector(`option[value="${selectedClubId}"]`)) {
                            selectElement.value = selectedClubId;
                        } else {
                            console.warn(`Nepriradený tím s ID "${selectedClubId}" nenájdený.`);
                            selectElement.value = "";
                        }
                    }
                }
            } catch (error) {
                console.error('Chyba pri načítaní nepriradených tímov pre select: ', error);
                selectElement.innerHTML = '<option value="">Chyba pri načítaní tímov</option>';
                selectElement.disabled = true;
            }
        }

        // NEW: Function to update the available options in all category selects (for Team Creation Modal)
        // Uses populateCategorySelect
        function updateCategorySelectOptions() {
            const selectedCategoryIds = [];
            const initialSelect = initialCategoryCountGroup.querySelector('select');
            if (initialSelect.value !== '') {
                selectedCategoryIds.push(initialSelect.value);
            }

            const dynamicGroups = dynamicCategoryCountContainer.querySelectorAll('.category-count-group');
            dynamicGroups.forEach(groupDiv => {
                const categorySelect = groupDiv.querySelector('select');
                if (categorySelect.value !== '') {
                    selectedCategoryIds.push(categorySelect.value);
                }
            });

            const otherSelectedCategoryIdsForInitial = selectedCategoryIds.filter(id => id !== initialSelect.value);
            populateCategorySelect(initialSelect, initialSelect.value, otherSelectedCategoryIdsForInitial);

            dynamicGroups.forEach(groupDiv => {
                const categorySelect = groupDiv.querySelector('select');
                const otherSelectedCategoryIdsForDynamic = selectedCategoryIds.filter(id => id !== categorySelect.value);
                populateCategorySelect(categorySelect, categorySelect.value, otherSelectedCategoryIdsForDynamic);
            });
        }

        // NEW: Helper function to derive the base name from a full team name (e.g., "Team A" -> "Team")
        // Uses it displayCreatedTeams
         function getBaseTeamName(fullTeamName) {
             if (!fullTeamName) return 'Neznámy názov';
             const parts = fullTeamName.trim().split(' '); // Use trim() to remove leading/trailing spaces
             if (parts.length > 1) {
                  const lastPart = parts[parts.length - 1];
                  // Check if the last part is a single uppercase letter OR a simple number (e.g., "Team 1", "Team 01")
                  // Using a regex for robustness
                  const suffixRegex = /^[A-Z]$|^\d+$/; // Matches a single uppercase letter OR one or more digits

                  if (suffixRegex.test(lastPart)) {
                       // Return the base name (all parts except the last one)
                       return parts.slice(0, -1).join(' ');
                   }
             }
             // If no recognised suffix found, the full name is the base name
             return fullTeamName;
         }


        // === 7. DISPLAY FUNCTIONS (Load and show section content) ===

        // Funkcia na zobrazenie kategórií (používa addCategoryRowToTable)
        async function loadCategoriesTable() {
            try {
                categoryTableBody.innerHTML = ''; // Clear existing rows
                const querySnapshot = await getDocs(categoriesCollectionRef);
                if (querySnapshot.empty) {
                    console.log("Žiadne kategórie nenájdené.");
                    const noDataRow = document.createElement('tr');
                    const td = document.createElement('td');
                    td.colSpan = 2;
                    td.textContent = "Žiadne kategórie zatiaľ pridané.";
                    td.style.textAlign = 'center';
                    noDataRow.appendChild(td);
                    categoryTableBody.appendChild(noDataRow);
                } else {
                    const sortedDocs = querySnapshot.docs.sort((a, b) => a.id.localeCompare(b.id));
                    sortedDocs.forEach((doc) => {
                        const categoryName = doc.id;
                        addCategoryRowToTable(categoryName); // <<< addCategoryRowToTable IS DEFINED BEFORE THIS CALL
                    });
                    console.log(`Načítaných kategórií: ${sortedDocs.length}`);
                }
            } catch (error) {
                console.error('Chyba pri načítaní kategórií: ', error);
                alert('Chyba pri načítaní kategórií!');
                const errorRow = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = 2;
                td.textContent = "Chyba pri načítaní kategórií.";
                td.style.textAlign = 'center';
                errorRow.appendChild(td);
                categoryTableBody.appendChild(errorRow);
            }
        }

        // Funkcia na zobrazenie skupín usporiadaných podľa kategórií (používa openGroupModal)
        async function displayGroupsByCategory() {
            groupsContentDiv.innerHTML = ''; // Clear container

            try {
                const categoriesSnapshot = await getDocs(categoriesCollectionRef);
                const sortedCategoriesDocs = categoriesSnapshot.docs.sort((a, b) => a.id.localeCompare(b.id));
                const categories = sortedCategoriesDocs.map(doc => doc.id);

                if (categories.length === 0) {
                    const message = document.createElement('p');
                    message.textContent = "Pridajte kategórie v sekcii 'Kategórie' pre zobrazenie skupín.";
                    groupsContentDiv.appendChild(message);
                    return;
                }

                const groupsSnapshot = await getDocs(groupsCollectionRef);

                const groupsByCategory = {};
                groupsSnapshot.forEach(doc => {
                    const groupData = doc.data();
                    const groupId = doc.id;
                    const categoryId = groupData.categoryId;

                    if (categoryId && categoryId !== 'null') {
                        if (!groupsByCategory[categoryId]) {
                            groupsByCategory[categoryId] = [];
                        }
                        groupsByCategory[categoryId].push({
                            id: groupId,
                            data: groupData
                        });
                    } else {
                        console.warn(`Skupina ${groupId} nemá priradenú categoryId.`);
                    }
                });

                categories.forEach(categoryName => {
                    const groupsForThisCategory = groupsByCategory[categoryName] || [];

                    const categorySectionDiv = document.createElement('div');
                    categorySectionDiv.classList.add('category-group-section', 'section-block');

                    const categoryHeading = document.createElement('h2');
                    categoryHeading.textContent = `${categoryName}`;
                    categorySectionDiv.appendChild(categoryHeading);

                    const categoryGroupsTable = document.createElement('table');
                    categoryGroupsTable.classList.add('category-group-table');

                    const thead = document.createElement('thead');
                    const headerRow = document.createElement('tr');
                    const groupNameTh = document.createElement('th');
                    groupNameTh.textContent = 'Názov';
                    const actionsTh = document.createElement('th');
                    actionsTh.textContent = 'Akcie';
                    actionsTh.style.width = '150px';

                    headerRow.appendChild(groupNameTh);
                    headerRow.appendChild(actionsTh);
                    thead.appendChild(headerRow);
                    categoryGroupsTable.appendChild(thead);

                    const tbody = document.createElement('tbody');

                    if (groupsForThisCategory.length === 0) {
                        const noGroupsRow = document.createElement('tr');
                        const td = document.createElement('td');
                        td.colSpan = 2;
                        td.textContent = `V kategórii "${categoryName}" zatiaľ nie sú žiadne skupiny.`;
                        td.style.textAlign = 'center';
                        tbody.appendChild(noGroupsRow);
                    } else {
                        groupsForThisCategory.sort((a, b) => (a.data.name || '').localeCompare(b.data.name || ''));

                        groupsForThisCategory.forEach(group => {
                            const groupRow = document.createElement('tr');
                            const groupNameTd = document.createElement('td');
                            groupNameTd.textContent = group.data.name;


                            const groupActionsTd = document.createElement('td');
                            groupActionsTd.style.whiteSpace = 'nowrap';

                            const editGroupButton = document.createElement('button');
                            editGroupButton.textContent = 'Premenovať';
                            editGroupButton.classList.add('action-button');
                            editGroupButton.onclick = () => {
                                openGroupModal(group.id, group.data); // <<< openGroupModal IS DEFINED AFTER THIS BLOCK
                            };

                            const deleteGroupButton = document.createElement('button');
                            deleteGroupButton.textContent = 'Vymazať';
                            deleteGroupButton.classList.add('action-button', 'delete-button');
                            deleteGroupButton.onclick = async () => {
                                if (!confirm(`Naozaj chcete vymazať skupinu "${group.data.name}" z kategórie "${group.data.categoryId}"? Tímy priradené k tejto skupine prídu o priradenie (groupId sa nastaví na null)!`)) {
                                    return;
                                }
                                try {
                                    const batch = writeBatch(db);

                                    const clubsInGroupQuery = query(clubsCollectionRef, where('groupId', '==', group.id));
                                    const clubsSnapshot = await getDocs(clubsInGroupQuery);
                                    clubsSnapshot.forEach(doc => {
                                        batch.update(doc.ref, {
                                            groupId: null
                                        });
                                        console.log(`Klub "${doc.id}" odpriradený zo skupiny "${group.id}".`);
                                    });

                                    batch.delete(doc(groupsCollectionRef, group.id));

                                    await batch.commit();

                                    console.log(`Skupina "${group.data.name}" (ID: ${group.id}) a súvisiace kluby boli úspešne zmazané/aktualizované.`);

                                    displayGroupsByCategory();
                                    if (window.location.hash === '#timy-do-skupin') displayClubs();
                                    if (window.location.hash === '#vytvorenie-timov') displayCreatedTeams();


                                } catch (error) {
                                    console.error('Chyba pri mazaní skupiny a súvisiacich dát: ', error);
                                    alert('Chyba pri mazaní skupiny! Prosím, skúste znova.');
                                }
                            };

                            groupActionsTd.appendChild(editGroupButton);
                            groupActionsTd.appendChild(deleteGroupButton);

                            groupRow.appendChild(groupNameTd);
                            groupRow.appendChild(groupActionsTd);
                            tbody.appendChild(groupRow);
                        });
                    }

                    categoryGroupsTable.appendChild(tbody);
                    categorySectionDiv.appendChild(categoryGroupsTable);
                    groupsContentDiv.appendChild(categorySectionDiv);
                });


            } catch (error) {
                console.error('Chyba pri načítaní alebo zobrazovaní skupín: ', error);
                const errorMessage = document.createElement('p');
                errorMessage.textContent = 'Chyba pri načítaní dát skupín.';
                groupsContentDiv.appendChild(errorMessage);
            }
        }


        // Funkcia na zobrazenie klubov usporiadaných podľa kategórií a skupín (PRIRADENÉ tímy) (používa openClubModal)
        async function displayClubs() {
            clubsContentDiv.innerHTML = ''; // Vyčistiť kontajner

            try {
                const q = query(clubsCollectionRef, where('groupId', '!=', null));
                const clubsSnapshot = await getDocs(q);

                const clubs = clubsSnapshot.docs.map(clubDoc => ({
                    id: clubDoc.id,
                    data: clubDoc.data()
                }));

                if (clubs.length === 0) {
                    console.log("Žiadne kluby priradené do skupín nenájdené.");
                    const message = document.createElement('p');
                    message.textContent = "Žiadne kluby zatiaľ neboli priradené do skupín.";
                    clubsContentDiv.appendChild(message);
                    return;
                }

                const clubsByCategoryAndGroup = {};
                clubs.forEach(club => {
                    const categoryId = club.data.categoryId;
                    const groupId = club.data.groupId;

                    if (categoryId && groupId && categoryId !== 'null' && groupId !== 'null') {
                        if (!clubsByCategoryAndGroup[categoryId]) {
                            clubsByCategoryAndGroup[categoryId] = {};
                        }
                        if (!clubsByCategoryAndGroup[categoryId][groupId]) {
                            clubsByCategoryAndGroup[categoryId][groupId] = [];
                        }
                        clubsByCategoryAndGroup[categoryId][groupId].push(club);
                    } else {
                        console.warn(`Klub ${club.id} priradený do skupiny (groupId != null) nemá platnú categoryId (${categoryId}) alebo groupId (${groupId}).`);
                    }
                });

                const sortedCategories = Object.keys(clubsByCategoryAndGroup).sort();

                if (sortedCategories.length === 0 && clubs.length > 0) {
                    console.warn("Kluby boli nájdené, ale žiadne nemajú platné categoryId/groupId na zobrazenie v skupinách.");
                    const message = document.createElement('p');
                    message.textContent = "Existujú kluby, ale žiadne nemajú priradenú kategóriu a skupinu pre zobrazenie tu.";
                    clubsContentDiv.appendChild(message);
                    return;
                }


                sortedCategories.forEach(categoryId => {
                    const sortedGroups = Object.keys(clubsByCategoryAndGroup[categoryId]).sort();

                    sortedGroups.forEach(groupId => {
                        const clubsInThisGroup = clubsByCategoryAndGroup[categoryId][groupId];

                        const groupClubSectionDiv = document.createElement('div');
                        groupClubSectionDiv.classList.add('section-block');

                        const groupNameParts = groupId.split(' - ');
                        const groupName = groupNameParts.length > 1 ? groupNameParts.slice(1).join(' - ') : groupId;

                        const sectionHeading = document.createElement('h2');
                        sectionHeading.textContent = `${categoryId} - ${groupName}`;
                        groupClubSectionDiv.appendChild(sectionHeading);

                        const clubTable = document.createElement('table');
                        clubTable.classList.add('group-clubs-table');

                        const thead = document.createElement('thead');
                        const headerRow = document.createElement('tr');
                        const clubNameTh = document.createElement('th');
                        clubNameTh.textContent = 'Názov klubu';
                        const actionsTh = document.createElement('th');
                        actionsTh.textContent = 'Akcie';
                        actionsTh.style.width = '150px';

                        headerRow.appendChild(clubNameTh);
                        headerRow.appendChild(actionsTh);
                        thead.appendChild(headerRow);
                        clubTable.appendChild(thead);


                        const tbody = document.createElement('tbody');

                        if (clubsInThisGroup.length === 0) {
                            const noClubsRow = document.createElement('tr');
                            const td = document.createElement('td');
                            td.colSpan = 2;
                            td.textContent = `Žiadne kluby v tejto skupine.`;
                            td.style.textAlign = 'center';
                            tbody.appendChild(noClubsRow);
                        } else {
                            clubsInThisGroup.sort((a, b) => (a.data.name || '').localeCompare(b.data.name || ''));

                            clubsInThisGroup.forEach(club => {
                                const tr = document.createElement('tr');

                                const nameTd = document.createElement('td');
                                nameTd.textContent = club.data.name;

                                const actionsTd = document.createElement('td');
                                actionsTd.style.whiteSpace = 'nowrap';

                                const editClubButton = document.createElement('button');
                                editClubButton.textContent = 'Upraviť';
                                editClubButton.classList.add('action-button');
                                editClubButton.onclick = () => {
                                    openClubModal(club.id, club.data); // <<< openClubModal IS DEFINED AFTER THIS BLOCK
                                };
                                actionsTd.appendChild(editClubButton);

                                const deleteClubButton = document.createElement('button');
                                deleteClubButton.textContent = 'Vymazať';
                                deleteClubButton.classList.add('action-button', 'delete-button');
                                deleteClubButton.onclick = async () => {
                                    if (!confirm(`Naozaj chcete zmazať tím "${club.data.name}" zo skupiny "${groupId}"? Túto akciu nemožno vrátiť späť!`)) {
                                        return;
                                    }
                                    try {
                                        await deleteDoc(doc(clubsCollectionRef, club.id));

                                        console.log(`Tím "${club.data.name}" (ID: ${club.id}) bol úspešne zmazaný.`);

                                        if (window.location.hash === '#timy-do-skupin') displayClubs();
                                        if (window.location.hash === '#vytvorenie-timov') displayCreatedTeams();


                                    } catch (error) {
                                        console.error('Chyba pri mazaní klubu: ', error);
                                        alert('Chyba pri mazaní klubu! Prosím, skúste znova.');
                                    }
                                };
                                actionsTd.appendChild(deleteClubButton);


                                tr.appendChild(nameTd);
                                tr.appendChild(actionsTd);
                                tbody.appendChild(tr);
                            });
                        }

                        clubTable.appendChild(tbody);
                        groupClubSectionDiv.appendChild(clubTable);
                        clubsContentDiv.appendChild(groupClubSectionDiv);
                    });
                });


            } catch (error) {
                console.error('Chyba pri načítaní alebo zobrazovaní priradených klubov: ', error);
                const errorMessage = document.createElement('p');
                errorMessage.textContent = 'Chyba pri načítaní dát priradených klubov.';
                clubsContentDiv.appendChild(errorMessage);
            }
        }

        // Funkcia na zobrazenie vytvorených tímov (klubov, ktoré ešte nie sú priradené do skupiny) (používa getBaseTeamName)
        async function displayCreatedTeams() {
            createdTeamsTableBody.innerHTML = ''; // Clear existing rows
            createdTeamsTableHead.innerHTML = ''; // Clear existing header

            try {
                const q = query(clubsCollectionRef, where('groupId', '==', null));
                const querySnapshot = await getDocs(q);
                const unassignedTeams = querySnapshot.docs.map(doc => ({
                    id: doc.id,
                    data: doc.data()
                }));

                const categoriesToDisplay = allCategories.length > 0 ? allCategories : (await getDocs(categoriesCollectionRef)).docs.map(doc => doc.id).sort();
                if (allCategories.length === 0 && categoriesToDisplay.length > 0) {
                    console.log("Populating categories for display from fresh fetch, caching now.");
                    allCategories = categoriesToDisplay;
                }

                if (unassignedTeams.length === 0) {
                    console.log("Žiadne tímy na priradenie do skupín zatiaľ nenájdené.");
                    const noDataRow = document.createElement('tr');
                    const td = document.createElement('td');
                    td.colSpan = categoriesToDisplay.length + 1; // Názov tímu + počet kategórií
                    td.textContent = "Žiadne tímy na priradenie zatiaľ pridané.";
                    td.style.textAlign = 'center';
                    noDataRow.appendChild(td);
                    createdTeamsTableBody.appendChild(noDataRow);
                    return;
                }

                const teamNames = new Set();
                const teamsByBaseNameAndCategory = {};
                const allSubRowsData = {};

                unassignedTeams.forEach(team => {
                    const fullTeamName = team.data.name;
                    const baseName = getBaseTeamName(fullTeamName);
                    const categoryId = team.data.categoryId || 'Nepriradená';

                    teamNames.add(baseName);

                    if (!teamsByBaseNameAndCategory[baseName]) {
                        teamsByBaseNameAndCategory[baseName] = {};
                    }
                    if (!teamsByBaseNameAndCategory[baseName][categoryId]) {
                        teamsByBaseNameAndCategory[baseName][categoryId] = [];
                    }
                    teamsByBaseNameAndCategory[baseName][categoryId].push(team);

                    if (!allSubRowsData[baseName]) {
                         allSubRowsData[baseName] = [];
                     }
                     allSubRowsData[baseName].push(team);

                });

                const sortedBaseNames = Array.from(teamNames).sort();


                // 4. Vytvoriť hlavičku tabuľky A PRIDAŤ LISTENERY NA KATEGÓRIE
                const headerRow = document.createElement('tr');
                const teamNameHeader = document.createElement('th');
                teamNameHeader.textContent = 'Názov tímu';
                headerRow.appendChild(teamNameHeader);

                const sortedCategoriesForHeader = categoriesToDisplay.sort();

                sortedCategoriesForHeader.forEach((categoryName, index) => {
                    const th = document.createElement('th');
                    th.textContent = categoryName;
                    // NEW: Add class and cursor for clickability
                    th.classList.add('category-header-cell');
                    // Store the category name and its index relative to *other category headers* (starting from 0)
                    th.setAttribute('data-category-name', categoryName);
                    th.setAttribute('data-category-index', index); // Index relative to category headers only

// NEW: Click listener for category headers
                    th.addEventListener('click', function() {
                         const clickedCategory = this.getAttribute('data-category-name');
                         const clickedCategoryIndex = parseInt(this.getAttribute('data-category-index'), 10);

                         // === TÁTO ČASŤ ZABEZPEČUJE SKRYTIE VŠETKÝCH PODRIADENÝCH RIADKOV PRI ZMENE FILTRA ===
                         // Hide all sub-rows when filtering changes
                         createdTeamsTableBody.querySelectorAll('tr.sub-row').forEach(subRow => {
                             subRow.style.display = 'none'; // Skryje všetky podriadené riadky
                         });
                          // Reset base name row visibility state
                          createdTeamsTableBody.querySelectorAll('tr[data-base-name]').forEach(mainRow => {
                              mainRow.setAttribute('data-sub-rows-visible', 'false');
                          });
                         // ===============================================================================


                         if (currentCategoryFilter === clickedCategory) {
                             // Clicking the active filter again - clear filter and show all main rows
                             currentCategoryFilter = null;
                             console.log(`Filter pre kategóriu "${clickedCategory}" zrušený.`);
                             createdTeamsTableBody.querySelectorAll('tr[data-base-name]').forEach(mainRow => {
                                 mainRow.style.display = 'table-row'; // Zobrazí všetky hlavné riadky
                             });
                         } else {
                             // Clicking a new filter header - set filter and show only relevant rows
                             currentCategoryFilter = clickedCategory;
                             console.log(`Filtrovanie podľa kategórie: "${clickedCategory}".`);

                             // === TÁTO ČASŤ FILTRUJE HLAVNÉ RIADKY NA ZÁKLADE POČTU V DANEJ KATEGÓRII ===
                             // Iterate through all main rows and show/hide based on count in the clicked category column
                             createdTeamsTableBody.querySelectorAll('tr[data-base-name]').forEach(mainRow => {
                                  const thElements = Array.from(headerRow.querySelectorAll('th'));
                                  const clickedThIndexInHeader = thElements.indexOf(this);

                                   const countTd = mainRow.querySelectorAll('td')[clickedThIndexInHeader];

                                  // Check if the cell exists and has content (count > 0)
                                  if (countTd && countTd.textContent.trim() !== '' && parseInt(countTd.textContent, 10) > 0) {
                                      mainRow.style.display = 'table-row'; // Zobrazí hlavný riadok
                                  } else {
                                      mainRow.style.display = 'none'; // Skryje hlavný riadok
                                  }
                             });
                             // =========================================================================
                         }
                    });

                    headerRow.appendChild(th);
                });

                createdTeamsTableHead.appendChild(headerRow);


                // 5. Vytvoriť telo tabuľky (ostáva takmer nezmenené, len zobrazenie/skrytie sa riadi filtrami)
                sortedBaseNames.forEach(baseName => {
                    const tr = document.createElement('tr'); // Main row for the base name
                    tr.setAttribute('data-base-name', baseName);
                     tr.setAttribute('data-sub-rows-visible', 'false'); // Initially hidden


                    const nameTd = document.createElement('td');
                    nameTd.textContent = baseName;
                    nameTd.classList.add('base-name-cell');

                    nameTd.addEventListener('click', function() {
                          const mainRow = this.parentElement;
                          const currentBaseName = mainRow.getAttribute('data-base-name');
                          const isVisible = mainRow.getAttribute('data-sub-rows-visible') === 'true';

                          // Hide all sub-rows when toggling base name
                          createdTeamsTableBody.querySelectorAll('tr.sub-row').forEach(subRow => {
                              subRow.style.display = 'none';
                          });
                           // Reset sub-row visibility state on all main rows
                          createdTeamsTableBody.querySelectorAll('tr[data-base-name]').forEach(row => {
                              if (row !== mainRow) row.setAttribute('data-sub-rows-visible', 'false');
                          });


                          if (isVisible) {
                              // Hide sub-rows for this base name
                              mainRow.setAttribute('data-sub-rows-visible', 'false');
                          } else {
                              // Show sub-rows for this base name
                              // We need to CREATE the sub-rows first if they don't exist yet
                              const existingSubRowsForBaseName = createdTeamsTableBody.querySelectorAll(`tr.sub-row[data-base-name="${currentBaseName}"]`);

                              if (existingSubRowsForBaseName.length === 0) {
                                   const teamsDataForBaseName = allSubRowsData[currentBaseName] || [];

                                   teamsDataForBaseName.forEach(team => {
                                       const subRow = document.createElement('tr');
                                       subRow.classList.add('sub-row');
                                       subRow.setAttribute('data-base-name', currentBaseName);
                                       subRow.setAttribute('data-category', team.data.categoryId || 'Nepriradená');

                                       const subNameTd = document.createElement('td');
                                       subNameTd.textContent = team.data.name;
                                       subNameTd.style.paddingLeft = '35px';

                                       sortedCategoriesForHeader.forEach(cat => {
                                           const categoryCell = document.createElement('td');
                                            if (team.data.categoryId === cat) {
                                                categoryCell.textContent = '1';
                                                categoryCell.style.textAlign = 'center';
                                            } else {
                                                categoryCell.textContent = '';
                                            }
                                            subRow.appendChild(categoryCell);
                                        });

                                        subRow.insertBefore(subNameTd, subRow.firstChild);
                                       subRow.style.display = 'table-row'; // Show immediately after creation

                                       mainRow.parentElement.insertBefore(subRow, mainRow.nextSibling);
                                   });

                              } else {
                                  existingSubRowsForBaseName.forEach(subRow => {
                                      subRow.style.display = 'table-row';
                                  });
                              }

                              mainRow.setAttribute('data-sub-rows-visible', 'true');
                          }

                          // Clear any active category filter when base name is clicked
                          currentCategoryFilter = null;
                          // Ensure all main rows are visible when base name is clicked (unless a category filter is active, which we just cleared)
                           createdTeamsTableBody.querySelectorAll('tr[data-base-name]').forEach(row => {
                               row.style.display = 'table-row';
                           });

                     });


                    tr.appendChild(nameTd);

                    // Cells for each category count (EXISTING CLICK FUNCTIONALITY - MODIFIED)
                    sortedCategoriesForHeader.forEach(categoryName => {
                        const countTd = document.createElement('td');
                        const teamsInThisCategory = teamsByBaseNameAndCategory[baseName]?.[categoryName] || [];
                        const teamCount = teamsInThisCategory.length;

                        countTd.textContent = teamCount > 0 ? teamCount : '';
                        countTd.setAttribute('data-team-count', teamCount);
                        countTd.setAttribute('data-category', categoryName);

                        // Add class for styling clickability (already added in previous step)
                         // countTd.classList.add('clickable-count-cell'); // Using attribute selector in CSS now

                        if (teamCount > 0) {
                            countTd.dataset.teams = JSON.stringify(teamsInThisCategory);

                            countTd.addEventListener('click', function() {
                                const clickedCell = this;
                                const mainRow = clickedCell.parentElement;
                                const baseName = mainRow.getAttribute('data-base-name');
                                const category = clickedCell.getAttribute('data-category');

                                // Find sub-rows SPECIFIC to this base name AND category
                                const subRowsForCategory = createdTeamsTableBody.querySelectorAll(`tr.sub-row[data-base-name="${baseName}"][data-category="${category}"]`);

                                // Find ALL sub-rows for this base name (in case other category sub-rows are open)
                                const allSubRowsForBaseName = createdTeamsTableBody.querySelectorAll(`tr.sub-row[data-base-name="${baseName}"]`);

                                 // Hide all sub-rows for this base name FIRST
                                  allSubRowsForBaseName.forEach(subRow => subRow.style.display = 'none');
                                   // Reset base name row visibility state
                                   createdTeamsTableBody.querySelectorAll('tr[data-base-name]').forEach(row => {
                                       if (row !== mainRow) row.setAttribute('data-sub-rows-visible', 'false');
                                    });
                                   mainRow.setAttribute('data-sub-rows-visible', 'false');


                                if (subRowsForCategory.length > 0 && subRowsForCategory[0].style.display !== 'none') {
                                    // Sub-rows for this category were visible (shouldn't happen after hiding all), hide them again
                                    subRowsForCategory.forEach(subRow => subRow.style.display = 'none');
                                    // If they are now hidden, check if *all* sub-rows for the base name are hidden
                                     const areAllHidden = Array.from(allSubRowsForBaseName).every(row => row.style.display === 'none');
                                      if (areAllHidden) {
                                          mainRow.setAttribute('data-sub-rows-visible', 'false');
                                      }


                                } else {
                                     // Sub-rows for this category are hidden, SHOW them

                                    // Get the team data specifically for THIS category
                                    const teamsDataForCategory = JSON.parse(clickedCell.dataset.teams);

                                    // Ensure sub-rows for THIS category exist in the DOM (create if not)
                                    const existingSubRowsForThisCategory = createdTeamsTableBody.querySelectorAll(`tr.sub-row[data-base-name="${baseName}"][data-category="${category}"]`);

                                     if (existingSubRowsForThisCategory.length === 0) {
                                         // Create and insert sub-rows for this specific category and base name
                                         teamsDataForCategory.forEach(team => {
                                             const subRow = document.createElement('tr');
                                             subRow.classList.add('sub-row');
                                             subRow.setAttribute('data-base-name', baseName);
                                             subRow.setAttribute('data-category', category);

                                             const subNameTd = document.createElement('td');
                                             subNameTd.textContent = team.data.name;
                                             subNameTd.style.paddingLeft = '35px';

                                             sortedCategoriesForHeader.forEach(cat => {
                                                 const categoryCell = document.createElement('td');
                                                  if (team.data.categoryId === cat) {
                                                      categoryCell.textContent = '1';
                                                      categoryCell.style.textAlign = 'center';
                                                  } else {
                                                      categoryCell.textContent = '';
                                                  }
                                                  subRow.appendChild(categoryCell);
                                              });

                                             subRow.insertBefore(subNameTd, subRow.firstChild);
                                             subRow.style.display = 'table-row'; // Show immediately after creation

                                             mainRow.parentElement.insertBefore(subRow, mainRow.nextSibling);
                                         });
                                     } else {
                                         // Sub-rows already exist, just show them
                                         existingSubRowsForThisCategory.forEach(subRow => subRow.style.display = 'table-row');
                                     }


                                    // Mark the main row as having visible sub-rows (since *some* sub-rows are now visible)
                                     mainRow.setAttribute('data-sub-rows-visible', 'true');


                                }

                                // Clear any active category filter when a count cell is clicked
                                currentCategoryFilter = null;
                                // Ensure all main rows are visible (since we are showing sub-rows for one base name)
                                // However, if a filter WAS active, clicking a cell should probably just show the sub-rows for *that* row,
                                // and the filter should remain active, hiding other rows.
                                // Let's decide: clicking a cell CLEARS the filter and shows sub-rows for that row.
                                 createdTeamsTableBody.querySelectorAll('tr[data-base-name]').forEach(row => {
                                     row.style.display = 'table-row';
                                 });


                                // Optional: Add/remove a class on the clicked count cell for visual feedback
                                // clickedCell.classList.toggle('selected-category-count');
                            });
                        }


                        tr.appendChild(countTd);
                    });


                    createdTeamsTableBody.appendChild(tr);

                    // Initially create and hide all sub-rows for this base name
                     const teamsDataForBaseName = allSubRowsData[baseName] || [];
                      teamsDataForBaseName.forEach(team => {
                          const subRow = document.createElement('tr');
                          subRow.classList.add('sub-row');
                          subRow.setAttribute('data-base-name', baseName);
                          subRow.setAttribute('data-category', team.data.categoryId || 'Nepriradená');

                           const subNameTd = document.createElement('td');
                           subNameTd.textContent = team.data.name;
                           subNameTd.style.paddingLeft = '35px';

                           sortedCategoriesForHeader.forEach(cat => {
                               const categoryCell = document.createElement('td');
                                if (team.data.categoryId === cat) {
                                    categoryCell.textContent = '1';
                                    categoryCell.style.textAlign = 'center';
                                } else {
                                    categoryCell.textContent = '';
                                }
                                subRow.appendChild(categoryCell);
                            });

                           subRow.insertBefore(subNameTd, subRow.firstChild);
                           subRow.style.display = 'none'; // Initially hidden

                          createdTeamsTableBody.appendChild(subRow); // Append the sub-row (hidden)
                      });
                 });

                 // NEW: After creating the table, apply the filter if one was active before refreshing
                 if (currentCategoryFilter) {
                     // Find the header cell for the active filter
                      const activeHeaderCell = createdTeamsTableHead.querySelector(`th[data-category-name="${currentCategoryFilter}"]`);
                      if (activeHeaderCell) {
                          // Trigger the click listener on the header to re-apply the filter
                          activeHeaderCell.click(); // This will run the filtering logic
                      } else {
                          // If the previously filtered category no longer exists, clear the filter
                          currentCategoryFilter = null;
                           createdTeamsTableBody.querySelectorAll('tr[data-base-name]').forEach(mainRow => {
                                 mainRow.style.display = 'table-row'; // Show all main rows
                             });
                      }
                 }


                console.log(`Načítaných a zoskupených tímov (na priradenie do skupín).`);

            } catch (error) {
                console.error('Chyba pri načítaní alebo zobrazovaní vytvorených tímov v novom formáte: ', error);
                const errorMessage = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = (allCategories.length > 0 ? allCategories.length : 1) + 1;
                td.textContent = 'Chyba pri načítaní dát tímov.';
                td.style.textAlign = 'center';
                errorMessage.appendChild(td);
                createdTeamsTableBody.appendChild(errorMessage);
            }
        }
        // === 8. MODAL OPEN FUNCTIONS (Called by event listeners) ===

        // Funkcia na otvorenie modálu kategórie (používa ju addButton listener)
        function openCategoryModal(categoryName = null) { // parameter categoryName je voliteľný pre úpravu
            categoryModal.style.display = 'block';

            currentCategoryModalMode = 'add';
            editingCategoryName = null;
            categoryForm.reset();
            categoryNameInput.readOnly = false;


            if (categoryName) {
                currentCategoryModalMode = 'edit';
                editingCategoryName = categoryName;
                categoryModalTitle.textContent = 'Premenovať kategóriu';
                categoryNameInput.value = categoryName;
                categoryNameInput.focus();
            } else {
                categoryModalTitle.textContent = 'Pridať kategóriu';
                categoryNameInput.focus();
            }
        }


        // Funkcia na otvorenie modálu skupiny (pre pridanie alebo úpravu) (používa ju addButton listener, displayGroupsByCategory)
        //groupId je kompozitné ID, groupData má name, categoryId
        async function openGroupModal(groupId = null, groupData = null) { //groupId je kompozitné ID
            groupModal.style.display = 'block';

            currentGroupModalMode = 'add';
            editingGroupId = null;
            groupForm.reset();
            groupNameInput.disabled = false;
            groupFormSubmitButton.textContent = 'Uložiť';

            groupCategorySelect.value = "";


            if (groupId && groupData) {
                currentGroupModalMode = 'edit';
                editingGroupId = groupId;
                groupModalTitle.textContent = 'Premenovať skupinu';
                groupFormSubmitButton.textContent = 'Uložiť zmeny';

                await populateCategorySelect(groupCategorySelect, groupData.categoryId, []); // <<< populateCategorySelect IS DEFINED BEFORE THIS CALL

                groupNameInput.value = groupData.name;

            } else {
                groupModalTitle.textContent = 'Pridať skupinu';
                await populateCategorySelect(groupCategorySelect, null, []); // <<< populateCategorySelect IS DEFINED BEFORE THIS CALL
            }

            groupNameInput.focus();
        }


        // Funkcia na otvorenie modálu klubu (pre priradenie do skupiny ALEBO úpravu priradeného) (používa ju addButton listener, displayClubs)
        async function openClubModal(clubId = null, clubData = null) { // clubId is auto-generated ID
            clubModal.style.display = 'block';

            clubForm.reset();
            clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kategóriu --</option>';
            clubGroupSelect.disabled = true;
            clubCategorySelect.value = "";

            unassignedClubSelectContainer.style.display = 'block';
            clubNameInputContainer.style.display = 'none';


            if (clubId && clubData) {
                currentClubModalMode = 'edit-assigned';
                editingClubId = clubId;
                clubModalTitle.textContent = 'Upraviť klub v skupine';
                clubFormSubmitButton.textContent = 'Uložiť zmeny';

                unassignedClubSelectContainer.style.display = 'none';
                clubNameInputContainer.style.display = 'block';
                clubNameInput.readOnly = false;

                await populateCategorySelect(clubCategorySelect, clubData.categoryId, []); // <<< populateCategorySelect IS DEFINED BEFORE THIS CALL

                if (clubData.categoryId) {
                    await populateGroupSelect(clubData.categoryId, clubGroupSelect, clubData.groupId); // <<< populateGroupSelect IS DEFINED BEFORE THIS CALL
                }

                clubNameInput.value = clubData.name;

            } else {
                currentClubModalMode = 'add-assign';
                editingClubId = null;
                clubModalTitle.textContent = 'Priradiť tím do skupiny';
                clubFormSubmitButton.textContent = 'Priradiť';

                await populateUnassignedClubsSelect(unassignedClubSelect, null); // <<< populateUnassignedClubsSelect IS DEFINED BEFORE THIS CALL

                await populateCategorySelect(clubCategorySelect, null, []); // <<< populateCategorySelect IS DEFINED BEFORE THIS CALL
            }

            if (currentClubModalMode === 'add-assign') {
                unassignedClubSelect.focus();
            } else {
                clubNameInput.focus();
            }
        }


        // === 9. SECTION TOGGLING FUNCTION (Uses display functions) ===

        // Funkcia na prepínanie zobrazenia obsahu
        function toggleContentDisplay() {
            // Debounce logika - zabráni viacnásobným spusteniam naraz
            if (isDisplaying) {
                console.log("toggleContentDisplay already running, exiting.");
                return;
            }
            isDisplaying = true;
            console.log("isDisplaying set to true.");


            const hash = window.location.hash;
            console.log("Navigating to hash:", hash);

            // Skryť všetky dynamické oblasti a modály
            addButton.style.display = 'none';
            categoriesContentSection.style.display = 'none';
            groupsContentDiv.style.display = 'none';
            clubsContentDiv.style.display = 'none';
            teamCreationContentSection.style.display = 'none';

            categoryModal.style.display = 'none';
            groupModal.style.display = 'none';
            clubModal.style.display = 'none';
            teamCreationModal.style.display = 'none';


            // Vyčistiť obsah dynamických oblastí
            categoryTableBody.innerHTML = '';
            groupsContentDiv.innerHTML = '';
            clubsContentDiv.innerHTML = '';
            createdTeamsTableBody.innerHTML = '';


            // Reset modal states and forms when navigating away
            currentCategoryModalMode = 'add';
            editingCategoryName = null;
            categoryForm.reset();

            currentGroupModalMode = 'add';
            editingGroupId = null;
            groupForm.reset();

            // Reset club modal state (add/edit assigned)
            currentClubModalMode = 'add-assign';
            editingClubId = null;
            clubForm.reset();
            unassignedClubSelectContainer.style.display = 'block';
            clubNameInputContainer.style.display = 'none';


            // Reset team creation modal state
            currentTeamCreationModalMode = 'add';
            teamCreationForm.reset();
            dynamicCategoryCountContainer.innerHTML = '';


            if (hash === '#kategorie') {
                addButton.style.display = 'block';
                categoriesContentSection.style.display = 'block';
                loadCategoriesTable(); // <<< loadCategoriesTable IS DEFINED BEFORE THIS CALL
                addButton.title = "Pridať kategóriu";
            } else if (hash === '#skupiny') {
                addButton.style.display = 'block';
                groupsContentDiv.style.display = 'flex';
                displayGroupsByCategory(); // <<< displayGroupsByCategory IS DEFINED BEFORE THIS CALL
                addButton.title = "Pridať skupinu";
            } else if (hash === '#vytvorenie-timov') {
                addButton.style.display = 'block';
                teamCreationContentSection.style.display = 'block';
                displayCreatedTeams(); // <<< displayCreatedTeams IS DEFINED BEFORE THIS CALL
                addButton.title = "Vytvoriť tímy";
            } else if (hash === '#timy-do-skupin') {
                addButton.style.display = 'block';
                clubsContentDiv.style.display = 'flex';
                displayClubs(); // <<< displayClubs IS DEFINED BEFORE THIS CALL
                addButton.title = "Priradiť tím do skupiny";
            } else {
                addButton.style.display = 'none';
                addButton.title = "Pridať položku";
                console.log("Neznáma alebo neimplementovaná sekcia, zobrazujem prázdny obsah.");
            }


            // Resetovanie príznaku po krátkej chvíli
            setTimeout(() => {
                isDisplaying = false;
                console.log("isDisplaying flag reset.");
            }, 50); // Doba v milisekundách
        }


        // === 10. EVENT LISTENERS ===

        // Spustíme toggleContentDisplay pri zmene hašu
        window.addEventListener('hashchange', toggleContentDisplay);

        // Spustíme display logic JEDENKRÁT pri načítaní stránky
        window.addEventListener('load', async () => {
            console.log("Window loaded.");
            await cacheAllCategories(); // <<< cacheAllCategories IS DEFINED BEFORE THIS CALL
            console.log("Categories cached on load.");

            if (!window.location.hash || window.location.hash === '#') {
                console.log("No hash found, setting to #kategorie. Relying ONLY on hashchange.");
                window.location.hash = '#kategorie';
            } else {
                console.log("Hash found:", window.location.hash, "Calling toggleContentDisplay directly ONCE on load.");
                toggleContentDisplay(); // <<< toggleContentDisplay IS DEFINED BEFORE THIS CALL
            }
            console.log("Load event logic finished.");
        });

        // Spoločná obsluha kliknutia na tlačidlo Pridať (+)
        addButton.addEventListener('click', async () => {
            const hash = window.location.hash;
            console.log("Add button clicked, current hash:", hash);

            if (hash === '#kategorie') {
                console.log("Opening category modal...");
                openCategoryModal(); // <<< openCategoryModal IS DEFINED BEFORE THIS CALL
            } else if (hash === '#skupiny') {
                console.log("Opening group modal...");
                await openGroupModal(); // <<< openGroupModal IS DEFINED BEFORE THIS CALL
            } else if (hash === '#vytvorenie-timov') {
                console.log("Attempting to open team creation modal...");
                currentTeamCreationModalMode = 'add';
                teamCreationModalTitle.textContent = 'Vytvoriť tímy';
                teamCreationForm.reset();
                dynamicCategoryCountContainer.innerHTML = '';

                console.log("Populating category select in team creation modal...");
                await populateCategorySelect(teamCategorySelect, null, []); // <<< populateCategorySelect IS DEFINED BEFORE THIS CALL
                console.log("Category select in team creation modal populated.");

                teamCreationModal.style.display = 'block';
                console.log("Team creation modal display set.");

                teamNameInput.focus();
                console.log("Focus set on team name input in team creation modal.");


            } else if (hash === '#timy-do-skupin') {
                console.log("Opening club assignment modal...");
                await openClubModal(null, null); // <<< openClubModal IS DEFINED BEFORE THIS CALL
            } else {
                console.log("Add button clicked in unknown or unimplemented section:", hash);
                addButton.style.display = 'none';
                addButton.title = "Pridať položku";
            }
        });


        // Obsluha formulára na pridanie/úpravu kategórie
        categoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const categoryName = categoryNameInput.value.trim();
            if (categoryName === '') {
                alert('Názov kategórie nemôže byť prázdny.');
                return;
            }
            // ... submit logic (uses Firestore functions) ...
            // Calls loadCategoriesTable, displayGroupsByCategory, displayClubs, displayCreatedTeams, cacheAllCategories
            // which are all defined earlier.
            if (currentCategoryModalMode === 'add') {
                const categoryDocRef = doc(categoriesCollectionRef, categoryName);
                try {
                    const existingDoc = await getDoc(categoryDocRef);
                    if (existingDoc.exists()) {
                        alert(`Kategória "${categoryName}" už existuje!`);
                        return;
                    }
                    await setDoc(categoryDocRef, {});
                    console.log(`Kategória "${categoryName}" bola úspešne pridaná.`);
                    categoryModal.style.display = 'none';
                    categoryForm.reset();
                    currentCategoryModalMode = 'add';
                    editingCategoryName = null;
                    loadCategoriesTable();
                    if (window.location.hash === '#skupiny') displayGroupsByCategory();
                    if (window.location.hash === '#timy-do-skupin') displayClubs();
                    if (window.location.hash === '#vytvorenie-timov') displayCreatedTeams();
                    cacheAllCategories();
                } catch (error) {
                    console.error('Chyba pri pridávaní kategórie: ', error);
                    alert('Chyba pri pridávaní kategórie!');
                    categoryModal.style.display = 'none';
                    categoryForm.reset();
                    currentCategoryModalMode = 'add';
                    editingCategoryName = null;
                }
            } else if (currentCategoryModalMode === 'edit') {
                const oldCategoryName = editingCategoryName;
                const newCategoryName = categoryName;
                if (!oldCategoryName) {
                    console.error("Chyba: Chýba pôvodný názov kategórie.");
                    alert("Chyba pri úprave kategórie.");
                    categoryModal.style.display = 'none';
                    categoryForm.reset();
                    currentCategoryModalMode = 'add';
                    editingCategoryName = null;
                    return;
                }
                if (newCategoryName === oldCategoryName) {
                    console.log("Názov kategórie sa nezmenil.");
                    categoryModal.style.display = 'none';
                    categoryForm.reset();
                    return;
                }

                const newCategoryDocRef = doc(categoriesCollectionRef, newCategoryName);
                try {
                    const existingDoc = await getDoc(newCategoryDocRef);
                    if (existingDoc.exists()) {
                        alert(`Kategória s názvom "${newCategoryName}" už existuje!`);
                        return;
                    }

                    const oldCategoryDocRef = doc(categoriesCollectionRef, oldCategoryName);
                    const oldDocSnapshot = await getDoc(oldCategoryDocRef);
                    if (!oldDocSnapshot.exists()) {
                        console.error(`Chyba: Pôvodný dokument kategórie ${oldCategoryName} nenájdený.`);
                        alert("Pôvodná kategória na úpravu nebola nájdená.");
                        categoryModal.style.display = 'none';
                        categoryForm.reset();
                        currentCategoryModalMode = 'add';
                        editingCategoryName = null;
                        loadCategoriesTable();
                        return;
                    }
                    const batch = writeBatch(db);
                    batch.set(newCategoryDocRef, oldDocSnapshot.data()); // Copy data to new doc
                    batch.delete(oldCategoryDocRef);

                    const groupsQuery = query(groupsCollectionRef, where('categoryId', '==', oldCategoryName));
                    const groupsSnapshot = await getDocs(groupsQuery);

                    const clubUpdates = [];
                    for (const groupDoc of groupsSnapshot.docs) {
                        const clubsInGroupQuery = query(clubsCollectionRef, where('groupId', '==', groupDoc.id));
                        const clubsSnapshot = await getDocs(clubsInGroupQuery);
                        clubsSnapshot.forEach(clubDoc => {
                            const groupData = groupDoc.data();
                            const newGroupId = `${newCategoryName} - ${groupData.name}`;
                            clubUpdates.push({
                                ref: clubDoc.ref,
                                updates: {
                                    categoryId: newCategoryName,
                                    groupId: newGroupId
                                }
                            });
                            console.log(`Klub "${clubDoc.id}" aktualizovaný (categoryId, groupId) kvôli zmene kategórie skupiny.`);
                        });
                        batch.delete(groupDoc.ref);
                        console.log(`Stará skupina "${groupDoc.id}" zmazaná po premenovaní kategórie.`);
                    }

                    clubUpdates.forEach(item => {
                        batch.update(item.ref, item.updates);
                    });

                    const unassignedClubsQuery = query(clubsCollectionRef, where('categoryId', '==', oldCategoryName), where('groupId', '==', null));
                    const unassignedClubsSnapshot = await getDocs(unassignedClubsQuery);
                    unassignedClubsSnapshot.forEach(doc => {
                        batch.update(doc.ref, {
                            categoryId: newCategoryName
                        });
                        console.log(`Nepriradený klub "${doc.id}" aktualizovaný (categoryId).`);
                    });

                    await batch.commit();

                    console.log(`Premenovanie kategórie "${oldCategoryName}" na "${newCategoryName}" a aktualizácia referencií bolo úspešné.`);

                    currentCategoryModalMode = 'add';
                    editingCategoryName = null;
                    categoryModal.style.display = 'none';
                    categoryForm.reset();

                    loadCategoriesTable();
                    if (window.location.hash === '#skupiny') displayGroupsByCategory();
                    if (window.location.hash === '#timy-do-skupin') displayClubs();
                    if (window.location.hash === '#vytvorenie-timov') displayCreatedTeams();

                    cacheAllCategories();

                } catch (error) {
                    console.error('Chyba pri premenovaní kategórie a aktualizácii referencií: ', error);
                    alert('Chyba pri premenovaní kategórie! Prosím, skúste znova.');
                    currentCategoryModalMode = 'add';
                    editingCategoryName = null;
                    categoryModal.style.display = 'none';
                    categoryForm.reset();
                }
            }
        });


        // Obsluha formulára Skupiny
        groupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const selectedCategoryId = groupCategorySelect.value;
            const groupName = groupNameInput.value.trim();

            if (selectedCategoryId === '' || selectedCategoryId === '-- Vyberte kategóriu --' || groupCategorySelect.disabled) {
                alert('Prosím, vyberte platnú kategóriu pre skupinu.');
                return;
            }
            if (groupName === '') {
                alert('Názov skupiny nemôže byť prázdny.');
                return;
            }

            const compositeGroupId = `${selectedCategoryId} - ${groupName}`;
            const groupDocRef = doc(groupsCollectionRef, compositeGroupId);

            try {
                const existingDoc = await getDoc(groupDocRef);

                if (currentGroupModalMode === 'add') {
                    if (existingDoc.exists()) {
                        alert(`Skupina s názvom "${groupName}" už v kategórii "${selectedCategoryId}" existuje!`);
                        return;
                    }
                    await setDoc(groupDocRef, {
                        name: groupName,
                        categoryId: selectedCategoryId
                    });
                    console.log(`Skupina "${groupName}" (ID: ${compositeGroupId}) bola úspešne pridaná.`);

                } else if (currentGroupModalMode === 'edit') {
                    const oldGroupId = editingGroupId;
                    if (!oldGroupId) {
                        console.error("Chyba: Režim úpravy skupiny bez platného editingGroupId.");
                        alert("Chyba pri úprave skupiny.");
                        groupModal.style.display = 'none';
                        groupForm.reset();
                        currentGroupModalMode = 'add';
                        editingGroupId = null;
                        return;
                    }

                    const oldGroupDocRef = doc(groupsCollectionRef, oldGroupId);
                    const oldDocSnapshot = await getDoc(oldGroupDocRef);
                    if (!oldDocSnapshot.exists()) {
                        console.error(`Chyba: Pôvodný dokument skupiny ${oldGroupId} nenájdený.`);
                        alert("Pôvodná skupina na úpravu nebola nájdená.");
                        groupModal.style.display = 'none';
                        groupForm.reset();
                        currentGroupModalMode = 'add';
                        editingGroupId = null;
                        displayGroupsByCategory();
                        return;
                    }

                    if (oldGroupId !== compositeGroupId) {
                        console.log(`Premenovanie/presun skupiny z "${oldGroupId}" na "${compositeGroupId}".`);
                        if (existingDoc.exists()) {
                            alert(`Skupina s názvom "${groupName}" už v kategórii "${selectedCategoryId}" existuje (iná skupina)!`);
                            return;
                        }
                        const batch = writeBatch(db);
                        batch.set(groupDocRef, {
                            name: groupName,
                            categoryId: selectedCategoryId
                        });
                        batch.delete(oldGroupDocRef);

                        const clubsInGroupQuery = query(clubsCollectionRef, where('groupId', '==', oldGroupId));
                        const clubsSnapshot = await getDocs(clubsInGroupQuery);
                        clubsSnapshot.forEach(clubDoc => {
                            batch.update(clubDoc.ref, {
                                groupId: compositeGroupId
                            });
                            console.log(`Klub "${clubDoc.id}" aktualizovaný (groupId) kvôli zmene skupiny.`);
                        });
                        await batch.commit();
                        console.log(`Skupina úspešne premenovaná/presunutá z ID "${oldGroupId}" na "${compositeGroupId}" a súvisiace kluby aktualizované.`);

                    } else {
                        console.log(`Úprava údajov pre skupinu s ID "${oldGroupId}".`);
                        await updateDoc(groupDocRef, {
                            name: groupName,
                            categoryId: selectedCategoryId
                        });
                        console.log(`Skupina s ID "${oldGroupId}" úspešne upravená.`);
                    }
                }

                groupModal.style.display = 'none';
                groupForm.reset();
                currentGroupModalMode = 'add';
                editingGroupId = null;

                if (window.location.hash === '#skupiny') displayGroupsByCategory();
                if (window.location.hash === '#timy-do-skupin') displayClubs();
                if (window.location.hash === '#vytvorenie-timov') displayCreatedTeams();


            } catch (error) {
                console.error('Chyba pri ukladaní skupiny: ', error);
                alert(`Chyba pri ukladaní skupiny! Detail: ${error.message}`);
                groupModal.style.display = 'none';
                groupForm.reset();
                currentGroupModalMode = 'add';
                editingGroupId = null;
            }
        });


        // Obsluha formulára Kluby (Priradenie do skupín & Správa priradených)
        clubForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const selectedCategoryId = clubCategorySelect.value;
            const selectedGroupId = clubGroupSelect.value;


            if (clubCategorySelect.disabled === false && (selectedCategoryId === '' || selectedCategoryId === '-- Vyberte kategóriu --')) {
                alert('Prosím, vyberte platnú kategóriu.');
                return;
            }
            if (clubGroupSelect.disabled === false && (selectedGroupId === '' || selectedGroupId === '-- Vyberte skupinu --' || selectedGroupId === '-- Žiadne skupiny v kategórii --')) {
                alert('Prosím, vyberte platnú skupinu.');
                return;
            }


            try {
                if (currentClubModalMode === 'add-assign') {
                    const selectedUnassignedClubId = unassignedClubSelect.value;

                    if (unassignedClubSelectContainer.style.display !== 'none' && selectedUnassignedClubId === '') {
                        alert('Prosím, vyberte tím na priradenie.');
                        return;
                    }

                    const clubRefToAssign = doc(clubsCollectionRef, selectedUnassignedClubId);
                    const clubDocToAssign = await getDoc(clubRefToAssign);

                    if (!clubDocToAssign.exists()) {
                        alert('Vybraný tím nebol nájdený alebo už bol priradený/zmazaný.');
                        populateUnassignedClubsSelect(unassignedClubSelect, null);
                        clubModal.style.display = 'none';
                        clubForm.reset();
                        unassignedClubSelectContainer.style.display = 'block';
                        clubNameInputContainer.style.display = 'none';
                        return;
                    }

                    const clubDataToAssign = clubDocToAssign.data();
                    if (clubDataToAssign.groupId !== null) {
                        alert(`Tím "${clubDataToAssign.name}" je už priradený do skupiny.`);
                        populateUnassignedClubsSelect(unassignedClubSelect, null);
                        clubModal.style.display = 'none';
                        clubForm.reset();
                        unassignedClubSelectContainer.style.display = 'block';
                        clubNameInputContainer.style.display = 'none';
                        return;
                    }

                    const existingClubInGroupQuery = query(clubsCollectionRef,
                        where('groupId', '==', selectedGroupId),
                        where('name', '==', clubDataToAssign.name)
                    );
                    const existingClubInGroupSnapshot = await getDocs(existingClubInGroupQuery);
                    if (!existingClubInGroupSnapshot.empty) {
                        alert(`Tím s názvom "${clubDataToAssign.name}" už v skupine "${selectedGroupId}" existuje!`);
                        return;
                    }

                    await updateDoc(clubRefToAssign, {
                        categoryId: selectedCategoryId,
                        groupId: selectedGroupId,
                    });

                    console.log(`Tím "${clubDataToAssign.name}" (ID: ${selectedUnassignedClubId}) úspešne priradený do skupiny "${selectedGroupId}".`);
                    alert(`Tím "${clubDataToAssign.name}" úspešne priradený.`);


                } else if (currentClubModalMode === 'edit-assigned') {
                    const clubIdToEdit = editingClubId;
                    const updatedClubName = clubNameInput.value.trim();
                    const currentClubDoc = await getDoc(doc(clubsCollectionRef, clubIdToEdit));
                    if (!currentClubDoc.exists()) {
                        console.error("Chyba: Dokument upravovaného klubu neexistuje.");
                        alert("Klub na úpravu nebol nájdený.");
                        clubModal.style.display = 'none';
                        clubForm.reset();
                        currentClubModalMode = 'add-assign';
                        editingClubId = null;
                        unassignedClubSelectContainer.style.display = 'block';
                        clubNameInputContainer.style.display = 'none';
                        displayClubs();
                        return;
                    }

                    if (!clubIdToEdit) {
                        console.error("Chyba: Režim úpravy priradeného klubu bez platného editingClubId.");
                        alert("Chyba pri úprave klubu. Prosím, obnovte stránku.");
                        clubModal.style.display = 'none';
                        clubForm.reset();
                        currentClubModalMode = 'add-assign';
                        editingClubId = null;
                        unassignedClubSelectContainer.style.display = 'block';
                        clubNameInputContainer.style.display = 'none';
                        return;
                    }
                    if (updatedClubName === '') {
                        alert('Názov klubu nemôže byť prázdny.');
                        return;
                    }

                    const existingClubInTargetGroupQuery = query(clubsCollectionRef,
                        where('groupId', '==', selectedGroupId),
                        where('name', '==', updatedClubName),
                        where(FieldPath.documentId(), '!=', clubIdToEdit)
                    );
                    const existingClubInTargetGroupSnapshot = await getDocs(existingClubInTargetGroupQuery);
                    if (!existingClubInTargetGroupSnapshot.empty) {
                        alert(`Klub s názvom "${updatedClubName}" už v skupine "${selectedGroupId}" existuje! Prosím, zvoľte iný názov.`);
                        return;
                    }

                    const clubRefToEdit = doc(clubsCollectionRef, clubIdToEdit);
                    const clubDocToEdit = await getDoc(clubRefToEdit);
                    if (!clubDocToEdit.exists()) {
                        console.error(`Chyba: Dokument priradeného klubu ${clubIdToEdit} nenájdený na úpravu.`);
                        alert("Klub na úpravu nebol nájdený.");
                        clubModal.style.display = 'none';
                        clubForm.reset();
                        currentClubModalMode = 'add-assign';
                        editingClubId = null;
                        displayClubs();
                        return;
                    }
                    const clubDataToEdit = clubDocToEdit.data();

                    if (clubDataToEdit.name === updatedClubName &&
                        clubDataToEdit.categoryId === selectedCategoryId &&
                        clubDataToEdit.groupId === selectedGroupId) {
                        console.log("Žiadne zmeny na klube.", clubIdToEdit);
                        clubModal.style.display = 'none';
                        clubForm.reset();
                        currentClubModalMode = 'add-assign';
                        editingClubId = null;
                        unassignedClubSelectContainer.style.display = 'block';
                        clubNameInputContainer.style.display = 'none';
                        return;
                    }

                    await updateDoc(clubRefToEdit, {
                        name: updatedClubName,
                        categoryId: selectedCategoryId,
                        groupId: selectedGroupId,
                    });

                    console.log(`Klub "${updatedClubName}" (ID: ${clubIdToEdit}) úspešne upravený v skupine "${selectedGroupId}".`);
                    alert(`Klub úspešne upravený.`);

                }

                clubModal.style.display = 'none';
                clubForm.reset();
                currentClubModalMode = 'add-assign';
                editingClubId = null;

                unassignedClubSelectContainer.style.display = 'block';
                clubNameInputContainer.style.display = 'none';

                if (window.location.hash === '#timy-do-skupin') {
                    displayClubs();
                }
                if (window.location.hash === '#vytvorenie-timov') {
                    displayCreatedTeams();
                }


            } catch (error) {
                console.error('Chyba pri ukladaní alebo priradzovaní klubu: ', error);
                alert(`Chyba pri ukladaní alebo priradzovaní klubu! Detail: ${error.message}`);
                clubModal.style.display = 'none';
                clubForm.reset();
                currentClubModalMode = 'add-assign';
                editingClubId = null;
                unassignedClubSelectContainer.style.display = 'block';
                clubNameInputContainer.style.display = 'none';
            }
        });


        // Obsluha formulára Vytvorenie Tímov
        teamCreationForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const teamNameBase = teamNameInput.value.trim();
            const initialCategoryId = teamCategorySelect.value;
            const initialTeamCount = parseInt(teamCountInput.value, 10);

            const teamEntries = [];

            if (teamNameBase === '') {
                alert('Názov tímu nemôže byť prázdny.');
            }
            if (initialCategoryId !== '' && !isNaN(initialTeamCount) && initialTeamCount >= 1) {
                if (initialTeamCount > 26) {
                    alert(`Počet tímov pre kategóriu "${initialCategoryId}" (${initialTeamCount}) v prvom zadaní prekračuje limit pre abecedné označenie (26). Prosím, znížte počet.`);
                    return;
                }
                teamEntries.push({
                    categoryId: initialCategoryId,
                    count: initialTeamCount
                });
            } else if (initialCategoryId !== '' || (teamNameBase !== '' && (isNaN(initialTeamCount) || initialTeamCount < 1))) {
                alert('Prosím, zadajte platnú kategóriu a počet tímov (väčší ako 0) pre prvú položku.');
                return;
            }

            const dynamicGroups = dynamicCategoryCountContainer.querySelectorAll('.category-count-group');
            dynamicGroups.forEach(groupDiv => {
                const categorySelect = groupDiv.querySelector('select');
                const countInput = groupDiv.querySelector('input[type="number"]');

                const categoryId = categorySelect.value;
                const teamCount = parseInt(countInput.value, 10);

                if (categoryId !== '' && !isNaN(teamCount) && teamCount >= 1) {
                    if (teamCount > 26) {
                        alert(`Počet tímov pre kategóriu "${categoryId}" (${teamCount}) v jednom zo zadaní prekračuje limit pre abecedné označenie (26). Prosím, znížte počet.`);
                        return;
                    }
                    teamEntries.push({
                        categoryId: categoryId,
                        count: teamCount
                    });
                } else if (categoryId !== '' || (!isNaN(teamCount) && teamCount >= 1)) {
                    alert('Prosím, zadajte platnú kategóriu a počet tímov (väčší ako 0) pre dynamickú položku.');
                    return;
                }
            });

            if (teamEntries.length === 0) {
                alert('Prosím, zadajte aspoň jednu kategóriu a počet tímov na vytvorenie.');
                return;
            }

            if (teamNameBase === '') {
                alert('Názov tímu nemôže byť prázdny.');
                return;
            }

            try {
                const batch = writeBatch(db);
                let successfullyAddedCount = 0;

                for (const entry of teamEntries) {
                    const categoryId = entry.categoryId;
                    const teamCount = entry.count;

                    for (let i = 1; i <= teamCount; i++) {
                        let teamName;
                        if (teamCount > 1) {
                            const letter = String.fromCharCode(65 + (i - 1));
                            teamName = `${teamNameBase} ${letter}`;
                        } else {
                            teamName = teamNameBase;
                        }

                        const teamDocumentId = `${categoryId} - ${teamName}`;
                        const newTeamRef = doc(clubsCollectionRef, teamDocumentId);

                        batch.set(newTeamRef, {
                            name: teamName,
                            categoryId: categoryId,
                            groupId: null
                        });
                        successfullyAddedCount++;
                    }
                }

                await batch.commit();

                console.log(`Pokus o vytvorenie/aktualizáciu ${successfullyAddedCount} tím(ov) na základe ${teamEntries.length} zadani(í).`);
                alert(`Úspešne spracovaných ${successfullyAddedCount} tím(ov). Skontrolujte zoznam vytvorených tímov.`);

                teamCreationModal.style.display = 'none';
                teamCreationForm.reset();
                dynamicCategoryCountContainer.innerHTML = '';
                populateCategorySelect(teamCategorySelect, null, []);


                if (window.location.hash === '#vytvorenie-timov') {
                    displayCreatedTeams();
                }

            } catch (error) {
                console.error('Chyba pri vytváraní tímov: ', error);
                alert(`Chyba pri vytváraní tímov! Detail: ${error.message}`);
                teamCreationModal.style.display = 'none';
                teamCreationForm.reset();
                dynamicCategoryCountContainer.innerHTML = '';
                populateCategorySelect(teamCategorySelect, null, []);
            }
        });


        // Event listener pre zmenu kategórie v modáli klubu (pre priradenie do skupiny)
        clubCategorySelect.addEventListener('change', async () => {
            const selectedCategoryId = clubCategorySelect.value;
            await populateGroupSelect(selectedCategoryId, clubGroupSelect);
        });

        // NEW: Event listener for change in the unassigned club select (in clubModal)
        unassignedClubSelect.addEventListener('change', async () => {
            const selectedClubId = unassignedClubSelect.value;
            if (selectedClubId) {
                try {
                    const clubDoc = await getDoc(doc(clubsCollectionRef, selectedClubId));
                    if (clubDoc.exists()) {
                        const clubData = clubDoc.data();
                        await populateCategorySelect(clubCategorySelect, clubData.categoryId, []);
                        await populateGroupSelect(clubData.categoryId, clubGroupSelect, clubData.groupId);
                    } else {
                        console.warn(`Vybraný nepriradený tím ${selectedClubId} už neexistuje.`);
                        unassignedClubSelect.value = "";
                        clubCategorySelect.value = "";
                        clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kategóriu --</option>';
                        clubGroupSelect.disabled = true;
                    }
                } catch (error) {
                    console.error('Chyba pri načítaní detailov vybraného nepriradeného tímu:', error);
                    alert('Chyba pri načítaní detailov tímu.');
                    unassignedClubSelect.value = "";
                    clubCategorySelect.value = "";
                    clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kategóriu --</option>';
                    clubGroupSelect.disabled = true;
                }
            } else {
                clubCategorySelect.value = "";
                clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kategóriu --</option>';
                clubGroupSelect.disabled = true;
            }
        });


        // NEW: Event listener for changes in category selects to update other selects (for Team Creation Modal)
        teamCategorySelect.addEventListener('change', updateCategorySelectOptions);

        // NEW: Event listener for changes on dynamic selects (using delegation)
        dynamicCategoryCountContainer.addEventListener('change', function(event) {
            if (event.target.tagName === 'SELECT') {
                updateCategorySelectOptions();
            }
        });


        // NEW: Event listener for the "Add another category" button
        addCategoryCountPairButton.addEventListener('click', () => {
            const groupDiv = document.createElement('div');
            groupDiv.classList.add('category-count-group');

            const categoryLabel = document.createElement('label');
            categoryLabel.textContent = 'Kategória:';

            const categorySelect = document.createElement('select');
            categorySelect.classList.add('dynamic-category-select');
            categorySelect.required = true;

            const countLabel = document.createElement('label');
            countLabel.textContent = 'Počet tímov:';

            const countInput = document.createElement('input');
            countInput.setAttribute('type', 'number');
            countInput.classList.add('dynamic-team-count-input');
            countInput.setAttribute('min', '1');
            countInput.setAttribute('value', '1');
            countInput.required = true;

            const removeButton = document.createElement('button');
            removeButton.setAttribute('type', 'button');
            removeButton.classList.add('remove-group-button');
            removeButton.textContent = 'X';

            groupDiv.appendChild(removeButton);
            groupDiv.appendChild(categoryLabel);
            groupDiv.appendChild(categorySelect);
            groupDiv.appendChild(countLabel);
            groupDiv.appendChild(countInput);

            dynamicCategoryCountContainer.appendChild(groupDiv);

            updateCategorySelectOptions();

            removeButton.addEventListener('click', () => {
                groupDiv.remove();
                updateCategorySelectOptions();
            });

            categorySelect.focus();
        });

        // NEW: Event listener for removing dynamic category/count pairs (using delegation)
        dynamicCategoryCountContainer.addEventListener('click', function(event) {
            if (event.target.classList.contains('remove-group-button')) {
                // Handled by individual button listener
            }
        });


        // === 11. INITIALIZATION ON LOAD ===
        // Robí sa v load event listeneri už s volaním toggleContentDisplay na konci


    </script>

</body>
</html>
