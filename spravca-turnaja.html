<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Správca turnaja</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="style.css">

    <style>
        #categoryTable, #groupsTable {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
            border: none;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #categoryTable th, #groupsTable th {
            background-color: #f2f2f2;
            color: #333;
            font-weight: bold;
            text-align: left;
            padding: 12px 15px;
            border-bottom: 2px solid #ddd;
        }
        #groupsTable th:last-child {
            width: 150px; /* Give some space for action buttons */
            text-align: center; /* Center the header text */
        }
        #categoryTable td, #groupsTable td {
            text-align: left;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
        }
        #categoryTable tbody tr:last-child td,
        #groupsTable tbody tr:last-child td {
             border-bottom: none;
        }
        #categoryTable tbody tr:hover,
        #groupsTable tbody tr:hover {
            background-color: #f9f9f9;
            cursor: pointer;
        }
        .action-button {
            padding: 5px 10px;
            margin-right: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
        }
        .action-button:not(.delete-button) {
            background-color: #007bff;
            color: white;
        }
        .action-button.delete-button {
            background-color: #dc3545;
            color: white;
        }
        .action-button:not(.delete-button):hover {
            background-color: #0056b3;
        }
        .action-button.delete-button:hover {
            background-color: #c82333;
        }
        #categoryTable td:last-child {
             text-align: center; /* Center actions in category table */
             white-space: nowrap;
        }
         #groupsTable td:last-child {
             text-align: center; /* Center action buttons in groups table */
             white-space: nowrap;
         }
         .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top (higher than sticky button) */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            padding-top: 60px; /* Location of the modal box */
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; /* 15% from the top and centered */
            padding: 20px;
            border: 1px solid #888;
            width: 80%; /* Could be more responsive */
            max-width: 500px; /* Maximum width */
            border-radius: 8px;
            position: relative; /* Needed for the close button positioning */
            display: flex; /* Use flexbox for content layout */
            flex-direction: column;
        }
        .close {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .modal-content form {
            display: flex;
            flex-direction: column;
        }
        .modal-content form label {
            display: block; /* Controlled by JS */
            margin-bottom: 8px;
            font-weight: bold;
        }
         .modal-content form input[type="text"],
         .modal-content form select { /* Also style select */
            width: calc(100% - 22px); /* Adjust for padding and border */
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box; /* Include padding and border in element's total width and height */
         }
         .modal-content form button {
            background-color: #28a745; /* Green for save */
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
            align-self: flex-start; /* Align button to the left */
         }
         .modal-content form button:hover {
            background-color: #218838; /* Darker green */
         }
        body {
            font-family: sans-serif; /* Use a common sans-serif font */
            margin: 0;
            padding: 0;
            background-color: #f8f9fa; /* Light background for the page */
        }
        h1 {
            text-align: center;
            color: #333;
            margin-top: 20px;
        }
        .add-button {
            display: block; /* Controlled by JS */
            margin: 20px auto; /* Center the button */
            width: 50px;
            height: 50px;
            border-radius: 50%; /* Round button */
            background-color: #28a745; /* Green */
            color: white;
            font-size: 2em;
            border: none;
            cursor: pointer;
            text-align: center;
            line-height: 50px; /* Vertically center the plus sign */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.3s ease;
            position: sticky; /* Keep button visible */
            top: 20px; /* Distance from the top */
            z-index: 10; /* Ensure it's above other content */
        }
        .add-button:hover {
            background-color: #218838; /* Darker green on hover */
        }
        .content-wrapper {
            display: flex; /* Use flexbox for layout */
            margin-top: 20px;
            padding: 0 20px; /* Add some horizontal padding */
        }
        .left-menu {
            width: 200px; /* Fixed width for the menu */
            margin-right: 20px;
            background-color: #fff; /* White background for menu */
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
             /* Ensure menu is taller than sticky button if needed */
             min-height: calc(100vh - 40px - 20px - 20px); /* Viewport height - h1 margin - button margin - wrapper padding */
             align-self: flex-start; /* Stick to the top */
        }
        .left-menu ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .left-menu li {
            margin-bottom: 10px;
        }
        .left-menu a {
            text-decoration: none;
            color: #007bff; /* Blue links */
            font-weight: bold;
            display: block; /* Make the whole list item clickable */
            padding: 5px 0;
            transition: color 0.3s ease;
        }
        .left-menu a:hover {
            color: #0056b3; /* Darker blue on hover */
        }
        main {
            flex-grow: 1; /* Main content takes up the remaining space */
            background-color: #fff; /* White background for main content */
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .group-category-section {
             margin: 10px; // Odsadenie medzi blokmi kategórií
             padding: 15px;
             background-color: #fff;
             border-radius: 8px;
             box-shadow: 0 2px 5px rgba(0,0,0,0.1);
             flex: 0 1 300px; // Základná šírka a správanie vo flex kontajneri
             box-sizing: border-box;
        }

        .group-category-section h3 {
             text-align: center;
             margin-top: 0;
             margin-bottom: 15px;
             color: #333; // Alebo iná farba nadpisu
        }

        .groups-by-category-table {
             width: 100%;
             border-collapse: collapse;
        }

        .groups-by-category-table th {
             background-color: #f2f2f2;
             color: #333;
             font-weight: bold;
             text-align: left; // Upravte podľa potreby
             padding: 8px 10px; // Menšie odsadenie
             border-bottom: 2px solid #ddd;
        }

         .groups-by-category-table td {
             text-align: left; // Upravte podľa potreby
             padding: 8px 10px; // Menšie odsadenie
             border-bottom: 1px solid #eee;
         }

         .groups-by-category-table tbody tr:last-child td {
             border-bottom: none; // Bez spodného okraja pre posledný riadok
         }

         .groups-by-category-table tbody tr:hover {
              background-color: #f9f9f9;
              cursor: pointer; // Voliteľné, ak riadok nie je klikateľný
         }

         .groups-by-category-table td:last-child {
             text-align: center; // Centrovať akcie
             white-space: nowrap;
         }
        
         #groupsContainer .groups-by-category-table th,
         #groupsContainer .groups-by-category-table td {
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <script>
        const userName = localStorage.getItem('username');
        if (userName !== 'admin') {
            window.location.href = 'login.html';
        } else {
        }
    </script>
    <h1>Správca turnaja</h1>
    <button class="add-button" id="addCategoryButton" title="Pridať">+</button>
    <div class="modal" id="categoryModal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="modalTitle">Pridať kategóriu</h2>
            <form id="categoryForm">
                <label id="labelCategoryName" for="categoryName">Názov kategórie:</label>
                <input type="text" id="categoryName" name="categoryName" required>
                <label id="labelGroupCategory" for="groupCategory" style="display: none;">Kategória:</label>
                <select id="groupCategory" name="groupCategory" required style="display: none;">
                    <option value="">-- Vyberte kategóriu --</option>
                </select>
                <label id="labelGroupName" for="groupName" style="display: none;">Názov skupiny:</label>
                <input type="text" id="groupName" name="groupName" style="display: none;">
                <button type="submit">Uložiť</button>
            </form>
        </div>
    </div>
    <div class="content-wrapper">
        <nav class="left-menu">
            <ul>
                <li><a href="#kluby">Kluby</a></li>
                <li><a href="#kategorie">Kategórie</a></li>
                <li><a href="#skupiny">Skupiny</a></li>
                <li><a href="#sportove-haly">Športové haly</a></li>
                <li><a href="#sprava-turnaja">Správa turnaja</a></li>
                <li><a href="#nastavenia">Nastavenia</a></li>
            </ul>
        </nav>
        <main>
            <table id="categoryTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Názov kategórie</th>
                        <th style="width: 150px;"></th>
                    </tr>
                </thead>
                <tbody id="categoryTableBody">
                </tbody>
            </table>
            <div id="groupsContainer" style="display: none; display: flex; flex-wrap: wrap; gap: 20px;">
            </div>
        </main>
    </div>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
        // Pridané arrayUnion a arrayRemove na manipuláciu s poľami v dokumente
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, updateDoc, arrayUnion, arrayRemove, runTransaction } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';
        // query a where už nebudú potrebné pre skupiny, keďže ich nebudeme filtrovať v samostatnej kolekcii

        const firebaseConfig = {
            apiKey: "AIzaSyD0h0rQZiIGi0-UDb4-YU_JihRGpIlfz40",
            authDomain: "turnaj-a28c5.firebaseapp.com",
            projectId: "turnaj-a28c5",
            storageBucket: "turnaj-a28c5.firebasestorage.app",
            messagingSenderId: "13732191148",
            appId: "1:13732191148:web:5ad78eaef2ad452a10f809"
        };

        // Inicializácia Firebase a Firestore
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Referencie na kolekcie
        const tournamentDataRef = doc(db, 'tournamentData', 'mainTournamentData');
        const categoriesCollectionRef = collection(tournamentDataRef, 'categories');
        // Kolekcia 'groups' už nebude obsahovať samotné skupiny v tejto novej štruktúre.
        // Referenciu ponechávam, ak by sa v nej ukladali iné dáta ako zoznam skupín,
        // ale pre názvy skupín uložené v kategórii ju nebudeme používať.
        const groupsCollectionRef = collection(tournamentDataRef, 'groups'); // Táto referencie sa už nebude používať na ukladanie/čítanie dát skupín v novej štruktúre


        // Referencie na DOM elementy (z vašej pôvodnej časti 1)
        const addButton = document.getElementById('addCategoryButton'); // Tlačidlo '+'
        const modal = document.getElementById('categoryModal'); // Modal okno
        const modalTitle = modal.querySelector('h2'); // Nadpis v modale
        const closeBtn = modal.querySelector('.close'); // Tlačidlo 'X' v modale
        const form = document.getElementById('categoryForm'); // Formulár v modale
        const categoryNameInput = document.getElementById('categoryName'); // Input pre názov kategórie
        const labelCategoryName = document.getElementById('labelCategoryName'); // Label pre názov kategórie
        const groupCategorySelect = document.getElementById('groupCategory'); // Select pre kategóriu skupiny
        const groupNameInput = document.getElementById('groupName'); // Input pre názov skupiny
        const labelGroupCategory = document.getElementById('labelGroupCategory'); // Label pre kategóriu skupiny
        const labelGroupName = document.getElementById('labelGroupName'); // Label pre názov skupiny
        const categoryTable = document.getElementById('categoryTable'); // Tabuľka kategórií
        const categoryTableBody = document.getElementById('categoryTableBody'); // Telo tabuľky kategórií
        const groupsContainerEl = document.getElementById('groupsContainer'); // Kontajner pre skupiny
        const mainContent = document.querySelector('main'); // Hlavný obsah pre skrytie/zobrazenie tabuliek


        // Premenné pre stav modalu
        let currentModalMode = 'addCategory'; // 'addCategory', 'editCategory', 'addGroup', 'editGroup'
        let editingCategoryRef = null; // Firestore Doc Ref pre kategóriu pri úprave kategórie
        let editingCategoryRowElement = null; // Riadok tabuľky kategórie pri úprave/mazaní kategórie
        // Nová premenná pre úpravu skupiny - potrebujeme vedieť ID kategórie a pôvodný názov skupiny
        let editingGroupDetails = null; // { categoryId: '...', groupName: '...' } pri úprave skupiny


        // Funkcie na prepínanie viditeľnosti polí vo formulári (z vašej pôvodnej časti 1, upravené)
        function showCategoryFields(show) {
            categoryNameInput.style.display = show ? 'block' : 'none';
            labelCategoryName.style.display = show ? 'block' : 'none';
            if (show) {
                categoryNameInput.setAttribute('required', 'true');
            } else {
                categoryNameInput.removeAttribute('required');
                categoryNameInput.value = ''; // vyčistiť hodnotu keď sa skryje
            }
        }

        function showGroupFields(show) {
            groupCategorySelect.style.display = show ? 'block' : 'none';
            groupNameInput.style.display = show ? 'block' : 'none';
            labelGroupCategory.style.display = show ? 'block' : 'none';
            labelGroupName.style.display = show ? 'block' : 'none';
            if (show) {
                groupCategorySelect.setAttribute('required', 'true');
                groupNameInput.setAttribute('required', 'true');
            } else {
                groupCategorySelect.removeAttribute('required');
                groupNameInput.removeAttribute('required');
                groupCategorySelect.value = ""; // vyčistiť hodnotu keď sa skryje
                groupNameInput.value = ""; // vyčistiť hodnotu keď sa skryje
            }
        }

        // Funkcia na mazanie KATEGÓRIE (bez kaskádového mazania skupín, keďže sú vnútri)
        // Pôvodná deleteCategoryWithGroups je nahradená touto jednoduchšou verziou
        async function deleteCategory(categoryId, categoryRowElement) {
            // Pôvodná potvrdzovacia správa s kaskádou už nemusí byť, ak skupiny nechceme mazať,
            // ale ak zmiznú z UI, je to zmena. Upravil som správu.
            if (!confirm(`Naozaj chcete zmazať kategóriu "${categoryId}"? Skupiny v tejto kategórii sa už nebudú zobrazovať.`)) {
                return; // Používateľ zrušil akciu
            }

            try {
                const categoryDocRef = doc(categoriesCollectionRef, categoryId);
                await deleteDoc(categoryDocRef);
                console.log(`Kategória "${categoryId}" úspešne zmazaná.`);

                // Odstrániť riadok tabuľky kategórie z UI
                if (categoryRowElement) {
                    categoryRowElement.remove();
                }

                // Ak sme na stránke skupín, obnoviť zobrazenie, lebo jedna kategória zmizla
                if (window.location.hash === '#skupiny') {
                    renderGroupsContent();
                }

                alert(`Kategória "${categoryId}" bola úspešne zmazaná.`);

            } catch (error) {
                console.error(`Chyba pri mazaní kategórie "${categoryId}": `, error);
                alert('Chyba pri mazaní kategórie!');
            }
        }

        // Funkcia na mazanie SKUPINY (odstránenie názvu z poľa v kategórii)
        async function deleteGroup(categoryId, groupName) {
             if (!confirm(`Naozaj chcete zmazať skupinu "${groupName}" z kategórie "${categoryId}"?`)) {
                 return; // Používateľ zrušil akciu
             }

             try {
                 const categoryDocRef = doc(categoriesCollectionRef, categoryId);
                 // Použijeme arrayRemove na odstránenie názvu skupiny z poľa 'groups'
                 await updateDoc(categoryDocRef, {
                     groups: arrayRemove(groupName)
                 });

                 console.log(`Skupina "${groupName}" z kategórie "${categoryId}" úspešne zmazaná.`);

                 // Obnoviť zobrazenie skupín
                 renderGroupsContent();

                 alert(`Skupina "${groupName}" bola úspešne zmazaná.`);

             } catch (error) {
                 console.error(`Chyba pri mazaní skupiny "${groupName}" z kategórie "${categoryId}": `, error);
                 alert('Chyba pri mazaní skupiny!');
             }
        }


        // Funkcia na pridanie riadku do tabuľky kategórií (upravená)
        function addCategoryRowToTable(categoryName) {
            const tr = document.createElement('tr');
            const nameTd = document.createElement('td');
            nameTd.textContent = categoryName;
            const actionsTd = document.createElement('td');
            actionsTd.style.whiteSpace = 'nowrap';
            actionsTd.style.textAlign = 'center';

            // Tlačidlo Premenovať kategóriu (logika zostáva podobná, upraví sa len kam sa uloží ref)
            const renameButton = document.createElement('button');
            renameButton.textContent = 'Premenovať';
            renameButton.classList.add('action-button');
            renameButton.onclick = function() {
                currentModalMode = 'editCategory';
                editingCategoryRef = doc(categoriesCollectionRef, categoryName); // Referencia na dokument kategórie
                editingCategoryRowElement = this.closest('tr'); // Referencia na riadok tabuľky
                modalTitle.textContent = 'Upraviť kategóriu';
                showCategoryFields(true);
                showGroupFields(false);
                categoryNameInput.value = categoryName;
                form.querySelector('button[type="submit"]').textContent = 'Uložiť zmeny';
                modal.style.display = 'block';
                categoryNameInput.focus();
            };

            // Tlačidlo Zmazať kategóriu (použije novú funkciu deleteCategory)
            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Zmazať';
            deleteButton.classList.add('action-button', 'delete-button');
            deleteButton.onclick = async function() {
                 // Zavolať novú funkciu deleteCategory
                await deleteCategory(categoryName, this.closest('tr'));
            };

            actionsTd.appendChild(renameButton);
            actionsTd.appendChild(deleteButton);
            tr.appendChild(nameTd);
            tr.appendChild(actionsTd);
            categoryTableBody.appendChild(tr);
        }


        // Funkcia na načítanie a zobrazenie kategórií v tabuľke (z vašej pôvodnej časti 2, bez zmeny logiky načítania)
        async function loadCategories() {
            console.log("Načítavam kategórie...");
            categoryTableBody.innerHTML = '';

            try {
                const querySnapshot = await getDocs(categoriesCollectionRef);

                if (querySnapshot.empty) {
                    console.log("Žiadne kategórie nenájdené.");
                    const noDataRow = document.createElement('tr');
                    const noDataTd = document.createElement('td');
                    noDataTd.colSpan = 2;
                    noDataTd.textContent = "Zatiaľ neboli pridané žiadne kategórie.";
                    noDataTd.style.textAlign = 'center';
                    noDataTd.style.fontStyle = 'italic';
                    noDataRow.appendChild(noDataTd);
                    categoryTableBody.appendChild(noDataRow);
                } else {
                    querySnapshot.forEach((doc) => {
                        addCategoryRowToTable(doc.id); // Používame ID dokumentu ako názov kategórie
                    });
                    console.log(`Načítaných ${querySnapshot.docs.length} kategórií.`);
                }
            } catch (error) {
                console.error('Chyba pri načítaní kategórií: ', error);
                alert('Chyba pri načítaní kategórií!');
                categoryTableBody.innerHTML = '';
                const errorRow = document.createElement('tr');
                const errorTd = document.createElement('td');
                errorTd.colSpan = 2;
                errorTd.textContent = "Chyba pri načítaní kategórií.";
                errorTd.style.textAlign = 'center';
                errorTd.style.color = 'red';
                errorRow.appendChild(errorTd);
                categoryTableBody.appendChild(errorRow);
            }
        }


        // Funkcia na načítanie a vykreslenie skupín (ZÁSADNE ZMENENÁ pre novú štruktúru)
        async function renderGroupsContent() {
            console.log("Vykresľujem skupiny podľa kategórií...");
            groupsContainerEl.innerHTML = ''; // Vyčistiť obsah kontajnera

            try {
                // Teraz načítavame len kategórie, skupiny sú v nich
                const categoriesSnapshot = await getDocs(categoriesCollectionRef);

                if (categoriesSnapshot.empty) {
                    const messageDiv = document.createElement('div');
                    messageDiv.textContent = "Pre zobrazenie skupín musíte najprv pridať kategórie.";
                    messageDiv.style.textAlign = 'center';
                    messageDiv.style.fontStyle = 'italic';
                    groupsContainerEl.appendChild(messageDiv);
                    console.log("Žiadne kategórie nenájdené, nemožno zobraziť skupiny.");
                    return;
                }

                let totalGroupsCount = 0; // Počítač celkového počtu skupín
                let categoriesWithGroupsCount = 0; // Počet kategórií, ktoré obsahujú skupiny

                // Prejdeme všetky kategórie
                categoriesSnapshot.forEach(doc => {
                    const categoryId = doc.id;
                    const categoryData = doc.data();
                    const categoryName = categoryId; // Predpokladáme, že ID je názov
                    // Získame pole skupín z dokumentu kategórie (alebo prázdne pole, ak pole groups neexistuje)
                    const groupsInCategory = categoryData.groups || [];

                    totalGroupsCount += groupsInCategory.length; // Pridať počet skupín z tejto kategórie k celkovému počtu

                    // Vykresliť sekciu kategórie len ak má nejaké skupiny
                    if (groupsInCategory.length > 0) {
                         categoriesWithGroupsCount++; // Zvýšiť počet kategórií so skupinami

                        const categorySectionDiv = document.createElement('div');
                        categorySectionDiv.classList.add('group-category-section');
                        categorySectionDiv.style.flex = '0 1 300px';
                        categorySectionDiv.style.margin = '10px';
                        categorySectionDiv.style.boxSizing = 'border-box';
                        categorySectionDiv.style.backgroundColor = '#fff';
                        categorySectionDiv.style.borderRadius = '8px';
                        categorySectionDiv.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';
                        categorySectionDiv.style.padding = '15px';


                        const categoryTitle = document.createElement('h3');
                        categoryTitle.textContent = categoryName;
                        categoryTitle.style.textAlign = 'center';
                        categoryTitle.style.marginTop = '0';
                        categoryTitle.style.marginBottom = '15px';

                        categorySectionDiv.appendChild(categoryTitle);

                        const table = document.createElement('table');
                        table.classList.add('groups-by-category-table');
                        table.style.width = '100%';
                        table.style.borderCollapse = 'collapse';

                        const thead = document.createElement('thead');
                        const headerRow = document.createElement('tr');

                        const groupNameTh = document.createElement('th');
                        groupNameTh.textContent = 'Skupina';
                        groupNameTh.style.textAlign = 'left';

                        const actionsTh = document.createElement('th');
                        actionsTh.textContent = 'Akcie';
                        actionsTh.style.width = '120px';
                        actionsTh.style.textAlign = 'center';

                        headerRow.appendChild(groupNameTh);
                        headerRow.appendChild(actionsTh);
                        thead.appendChild(headerRow);
                        table.appendChild(thead);

                        const tbody = document.createElement('tbody');
                        // Prejdeme názvy skupín V POli kategórie
                        groupsInCategory.forEach(groupName => { // groupName je teraz len string
                            const tr = document.createElement('tr');

                            const groupNameTd = document.createElement('td');
                            groupNameTd.textContent = groupName; // groupName je už názov
                            tr.style.borderBottom = '1px solid #eee';
                            tr.style.padding = '10px 0';
                            tr.style.transition = 'background-color 0.3s ease';
                            tr.style.cursor = 'pointer';
                            groupNameTd.style.padding = '10px 15px';
                            groupNameTd.style.textAlign = 'left';


                            const actionsTd = document.createElement('td');
                            actionsTd.style.whiteSpace = 'nowrap';
                            actionsTd.style.textAlign = 'center';
                            actionsTd.style.padding = '10px 15px';

                            // Tlačidlo Upraviť skupinu (logika pre novú štruktúru)
                            const editButton = document.createElement('button');
                            editButton.textContent = 'Upraviť';
                            editButton.classList.add('action-button');
                            editButton.onclick = function() {
                                console.log(`Spúšťam úpravu skupiny "${groupName}" z kategórie "${categoryId}"`);
                                currentModalMode = 'editGroup'; // Režim úpravy skupiny
                                // Uložíme detaily skupiny na úpravu
                                editingGroupDetails = { categoryId: categoryId, groupName: groupName };

                                modalTitle.textContent = 'Upraviť skupinu'; // Nadpis modalu
                                showCategoryFields(false); // Skryť polia kategórie
                                showGroupFields(true); // Zobraziť polia skupiny

                                // Načítať kategórie do dropdownu
                                loadCategoriesToGroupDropdown().then(() => {
                                     // Naplniť inputy aktuálnymi hodnotami
                                     groupCategorySelect.value = categoryId; // Vybrať správnu kategóriu
                                     groupNameInput.value = groupName; // Naplniť názov skupiny

                                     form.querySelector('button[type="submit"]').textContent = 'Uložiť zmeny'; // Zmeniť text tlačidla
                                     modal.style.display = 'block'; // Zobraziť modal
                                     // Nastaviť focus
                                     if (groupCategorySelect.style.display !== 'none') {
                                        groupCategorySelect.focus();
                                    } else if (groupNameInput.style.display !== 'none') {
                                        groupNameInput.focus();
                                    }
                                }).catch(error => {
                                     console.error("Chyba pri načítaní kategórií pre úpravu skupiny:", error);
                                     alert("Nepodarilo sa načítať kategórie pre úpravu skupiny.");
                                     // V prípade chyby zatvoriť modal? Alebo zablokovať formulár?
                                });
                            };

                            // Tlačidlo Zmazať skupinu (logika pre novú štruktúru)
                            const deleteButton = document.createElement('button');
                            deleteButton.textContent = 'Zmazať';
                            deleteButton.classList.add('action-button', 'delete-button');
                            deleteButton.onclick = async function() {
                                // Zavolať novú funkciu deleteGroup s ID kategórie a názvom skupiny
                                await deleteGroup(categoryId, groupName);
                            };

                            actionsTd.appendChild(editButton);
                            actionsTd.appendChild(deleteButton);

                            tr.appendChild(groupNameTd);
                            tr.appendChild(actionsTd);

                            tbody.appendChild(tr);
                        });
                        table.appendChild(tbody);
                        categorySectionDiv.appendChild(table);
                        groupsContainerEl.appendChild(categorySectionDiv);
                        console.log(`Vykreslená sekcia pre kategóriu "${categoryName}" s ${groupsInCategory.length} skupinami.`);
                    } else {
                         console.log(`Kategória "${categoryName}" nemá zatiaľ žiadne skupiny na zobrazenie.`);
                         // Ak nechcete zobrazovať prázdne sekcie kategórií, nerobte nič
                         // Ak chcete zobraziť prázdnu sekciu, kód by bol podobný, len by chýbal tbody s riadkami skupín
                    }
                });

                 // Zobraziť správu, ak neboli nájdené žiadne skupiny V ŽIADNEJ kategórii, ale kategórie existujú
                if (totalGroupsCount === 0 && categoriesSnapshot.docs.length > 0) {
                    const messageDiv = document.createElement('div');
                    messageDiv.textContent = "Zatiaľ neboli pridané žiadne skupiny do žiadnej kategórie.";
                    messageDiv.style.textAlign = 'center';
                    messageDiv.style.fontStyle = 'italic';
                    groupsContainerEl.appendChild(messageDiv);
                    console.log("Kategórie existujú, ale žiadne skupiny nenájdené.");
                }
                // Prípad, keď nie sú žiadne kategórie, je ošetrený na začiatku funkcie.


            } catch (error) {
                console.error('Chyba pri načítaní a vykresľovaní skupín: ', error);
                alert('Chyba pri načítaní dát skupín!');
                groupsContainerEl.innerHTML = ''; // Vyčistiť aj pri chybe
                const errorDiv = document.createElement('div');
                errorDiv.textContent = "Chyba pri načítaní dát skupín.";
                errorDiv.style.textAlign = 'center';
                errorDiv.style.color = 'red';
                groupsContainerEl.appendChild(errorDiv);
            }
        }


        // Funkcia na načítanie kategórií do dropdownu (bez zmeny, načítava ID/názvy kategórií)
        async function loadCategoriesToGroupDropdown() {
            console.log("Načítavam kategórie pre dropdown skupín...");
            groupCategorySelect.innerHTML = '<option value="">-- Vyberte kategóriu --</option>'; // Vyčistiť a pridať default option
            groupCategorySelect.disabled = true; // Zablokovať, kým sa nenačítajú dáta
            groupCategorySelect.style.color = '#888'; // Sivý text, kým je zablokovaný

            try {
                const querySnapshot = await getDocs(categoriesCollectionRef);

                if (!querySnapshot.empty) {
                    querySnapshot.forEach((doc) => {
                        const option = document.createElement('option');
                        option.value = doc.id; // Použi ID dokumentu (názov kategórie) ako hodnotu
                        option.textContent = doc.id; // Zobraz názov kategórie
                        groupCategorySelect.appendChild(option);
                    });
                    groupCategorySelect.disabled = false; // Odblokovať po načítaní
                    groupCategorySelect.style.color = '#000'; // Vrátiť čierny text
                    console.log(`Načítaných ${querySnapshot.docs.length} kategórií pre dropdown.`);
                } else {
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "-- Žiadne kategórie (najprv pridajte kategóriu) --";
                    groupCategorySelect.appendChild(option);
                    groupCategorySelect.style.color = '#888';
                    console.log("Žiadne kategórie na načítanie do dropdownu.");
                }
            } catch (error) {
                console.error('Chyba pri načítaní kategórií pre dropdown: ', error);
                alert('Chyba pri načítaní kategórií pre výber.');
                groupCategorySelect.disabled = true;
                groupCategorySelect.style.color = 'red';
                const option = document.createElement('option');
                option.value = "";
                option.textContent = "-- Chyba načítania kategórií --";
                groupCategorySelect.appendChild(option);
            }
        }


        // Funkcia na prepínanie viditeľnosti obsahu (bez zmeny)
        function toggleContentVisibility() {
            console.log("Prepínam zobrazenie obsahu...");
            const hash = window.location.hash;
            const isCategoryPage = hash === '#kategorie';
            const isGroupsPage = hash === '#skupiny';
            const isOtherPage = hash !== '#kategorie' && hash !== '#skupiny';

            categoryTable.style.display = 'none';
            groupsContainerEl.style.display = 'none';
            addButton.style.display = 'none';

            categoryTableBody.innerHTML = '';
            groupsContainerEl.innerHTML = '';
            if(mainContent) mainContent.innerHTML = ''; // Vyčistiť main content pred zobrazením tabuľky

            if (isCategoryPage) {
                console.log("Zobrazujem kategórie.");
                categoryTable.style.display = 'table';
                addButton.style.display = 'block';
                addButton.onclick = function() {
                    console.log("Klik na '+' na stránke kategórií.");
                    currentModalMode = 'addCategory';
                    editingCategoryRef = null;
                    editingCategoryRowElement = null; // Resetovať aj túto premennú
                    modalTitle.textContent = 'Pridať kategóriu';
                    showCategoryFields(true);
                    showGroupFields(false);
                    form.reset();
                    form.querySelector('button[type="submit"]').textContent = 'Uložiť';
                    modal.style.display = 'block';
                    categoryNameInput.focus();
                };
                loadCategories();
            } else if (isGroupsPage) {
                console.log("Zobrazujem skupiny.");
                groupsContainerEl.style.display = 'flex';
                addButton.style.display = 'block';
                addButton.onclick = function() {
                    console.log("Klik na '+' na stránke skupín.");
                    currentModalMode = 'addGroup';
                    editingGroupDetails = null; // Resetovať pre úpravu skupiny
                    modalTitle.textContent = 'Pridať skupinu';
                    showCategoryFields(false);
                    showGroupFields(true);
                    form.reset();
                    form.querySelector('button[type="submit"]').textContent = 'Uložiť';
                    loadCategoriesToGroupDropdown();
                    modal.style.display = 'block';
                    if (groupCategorySelect.style.display !== 'none') {
                        groupCategorySelect.focus();
                    } else if (groupNameInput.style.display !== 'none') {
                        groupNameInput.focus();
                    }
                };
                renderGroupsContent();
            } else {
                 console.log(`Neznámy hash: ${hash}. Zobrazujem prázdnu stránku alebo defaultný obsah.`);
                 // Zobraziť úvodnú správu
                 if(mainContent) mainContent.innerHTML = '<h2>Vitajte v správcovi turnaja</h2><p>Vyberte možnosť z ľavého menu.</p>';
                 // Ak nie je mainContent, vypíše sa aspoň do konzoly.
            }
        }


        // Event listener pre klik mimo modalu alebo na 'X' (upravený pre nový stav)
        window.addEventListener('click', (e) => {
            if (e.target === modal || e.target.classList.contains('close')) {
                modal.style.display = 'none';
                // Resetovať stav modalu a formulára po zatvorení
                currentModalMode = 'addCategory';
                editingCategoryRef = null; // Resetovať aj ref kategórie
                editingCategoryRowElement = null; // Resetovať aj riadok kategórie
                editingGroupDetails = null; // Resetovať detaily skupiny
                form.reset();
                form.querySelector('button[type="submit"]').textContent = 'Uložiť';
                showCategoryFields(false);
                showGroupFields(false);
                groupCategorySelect.disabled = false; // Odblokovať dropdown pre istotu
            }
        });


        // Event listener pre zmeny v URL hashi (bez zmeny)
        window.addEventListener('hashchange', toggleContentVisibility);


        // Event listener pre submit formulára modalu (ZÁSADNE ZMENENÝ pre novú štruktúru a úpravy)
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'Ukladám...';


            try {
                if (currentModalMode === 'addCategory') {
                    console.log("Spracúvam pridanie kategórie...");
                    const categoryName = categoryNameInput.value.trim();
                    if (categoryName === '') {
                        alert('Názov kategórie nemôže byť prázdny.');
                        return;
                    }

                    const categoryDocRef = doc(categoriesCollectionRef, categoryName);
                    const existingDoc = await getDoc(categoryDocRef);
                    if (existingDoc.exists()) {
                        alert(`Kategória "${categoryName}" už existuje!`);
                        return;
                    }

                    // Uloženie kategórie s prázdnym poľom pre skupiny
                    await setDoc(categoryDocRef, {
                        createdAt: new Date(),
                        groups: [] // <-- Inicializujeme prázdne pole pre skupiny
                    });
                    console.log(`Kategória "${categoryName}" bola úspešne pridaná s prázdnym zoznamom skupín.`);

                    modal.style.display = 'none';
                    form.reset();
                    // Reset stavu po úspešnej operácii
                    currentModalMode = 'addCategory'; editingCategoryRef = null; editingCategoryRowElement = null; editingGroupDetails = null;
                    showCategoryFields(false); showGroupFields(false);


                    // Obnoviť zobrazenie
                    loadCategories(); // Znova načítať tabuľku kategórií
                    if (window.location.hash === '#skupiny') {
                         renderGroupsContent(); // Ak sme na stránke skupín, obnoviť aj ich zobrazenie
                    }


                } else if (currentModalMode === 'editCategory') {
                    console.log("Spracúvam úpravu kategórie...");
                    const oldCategoryName = editingCategoryRef ? editingCategoryRef.id : null;
                    const newCategoryName = categoryNameInput.value.trim();
                    const rowToUpdate = editingCategoryRowElement;

                    if (!oldCategoryName || !rowToUpdate) {
                        console.error("Chyba: Chýba referencia na pôvodnú kategóriu alebo riadok pri úprave.");
                        alert("Chyba pri úprave kategórie. Prosím, obnovte stránku a skúste znova.");
                        return;
                    }
                    if (newCategoryName === '') {
                        alert('Nový názov kategórie nemôže byť prázdny.');
                        return;
                    }
                    if (newCategoryName === oldCategoryName) {
                        console.log('Nový názov je rovnaký ako pôvodný. Žiadna zmena.');
                        alert('Názov kategórie nebol zmenený.');
                        modal.style.display = 'none';
                        return;
                    }

                    const newCategoryDocRef = doc(categoriesCollectionRef, newCategoryName);
                    const existingDoc = await getDoc(newCategoryDocRef);
                    if (existingDoc.exists()) {
                        alert(`Kategória s názvom "${newCategoryName}" už existuje!`);
                        return;
                    }

                    // --- Vykonanie premenovania v Firestore (vytvoriť nový dok, zmazať starý) ---
                    // Keďže skupiny sú V POli v dokumente kategórie, netreba ich samostatne aktualizovať!
                    // Dáta (vrátane poľa groups) sa skopírujú pri vytvorení nového dokumentu.
                    const oldDocSnapshot = await getDoc(editingCategoryRef);
                     if (!oldDocSnapshot.exists()) {
                        console.error(`Pôvodná kategória "${oldCategoryName}" nenájdená pre premenovanie.`);
                        alert('Chyba: Pôvodná kategória nebola nájdená.');
                        return;
                    }
                    const oldDocData = oldDocSnapshot.data();

                    await setDoc(newCategoryDocRef, oldDocData); // Vytvoriť nový dokument s novým ID a starými dátami (vrátane skupín)
                    await deleteDoc(editingCategoryRef); // Zmazať starý dokument

                    console.log(`Kategória "${oldCategoryName}" úspešne premenovaná na "${newCategoryName}".`);

                    // --- Aktualizácia UI a stavu ---
                     // Aktualizovať názov kategórie priamo v existujúcom riadku tabuľky
                    rowToUpdate.querySelector('td:first-child').textContent = newCategoryName;
                    console.log(`Názov v tabuľke kategórií aktualizovaný.`);


                    // Zatvoriť modal a resetovať formulár a stav
                    modal.style.display = 'none';
                    form.reset();
                    currentModalMode = 'addCategory'; editingCategoryRef = null; editingCategoryRowElement = null; editingGroupDetails = null; // Reset stavu
                    showCategoryFields(false); showGroupFields(false);

                    // Obnoviť zobrazenie skupín, ak sme na ich stránke, lebo sa zmenili názvy kategórií
                    if (window.location.hash === '#skupiny') {
                         renderGroupsContent();
                    }


                } else if (currentModalMode === 'addGroup') {
                    console.log("Spracúvam pridanie skupiny...");
                    const categoryId = groupCategorySelect.value;
                    const groupName = groupNameInput.value.trim();

                    if (!categoryId) {
                        alert('Prosím, vyberte kategóriu.');
                        return;
                    }
                     if (groupName === '') {
                        alert('Názov skupiny nemôže byť prázdny.');
                        return;
                    }

                     // Voliteľné: Kontrola duplicity názvu skupiny V DANEJ KATEGÓRII
                     const categoryDocRef = doc(categoriesCollectionRef, categoryId);
                     const categorySnapshot = await getDoc(categoryDocRef);
                     if (categorySnapshot.exists()) {
                          const existingGroups = categorySnapshot.data().groups || [];
                          if (existingGroups.includes(groupName)) {
                               alert(`Skupina s názvom "${groupName}" už v kategórii "${categoryId}" existuje!`);
                               return;
                          }
                     } else {
                          // Toto by sa nemalo stať, ak je kategória v dropdown, ale pre istotu
                          alert(`Vybraná kategória "${categoryId}" neexistuje!`);
                          return;
                     }


                    // Pridanie názvu skupiny do poľa 'groups' v dokumente kategórie
                    // Použijeme arrayUnion pre bezpečné pridanie (ak názov už existuje, nepridá sa znova)
                    await updateDoc(categoryDocRef, {
                        groups: arrayUnion(groupName)
                    });

                    console.log(`Skupina "${groupName}" pridaná do kategórie "${categoryId}".`);

                    // Zatvoriť modal a resetovať formulár a stav
                    modal.style.display = 'none';
                    form.reset();
                    currentModalMode = 'addCategory'; editingCategoryRef = null; editingCategoryRowElement = null; editingGroupDetails = null;
                    showCategoryFields(false); showGroupFields(false);


                    // Obnoviť zobrazenie skupín
                    renderGroupsContent();


                } else if (currentModalMode === 'editGroup') {
                    console.log("Spracúvam úpravu skupiny...");
                     // Získať pôvodné a nové hodnoty z premenných stavu a formulára
                    const oldCategoryId = editingGroupDetails ? editingGroupDetails.categoryId : null;
                    const oldGroupName = editingGroupDetails ? editingGroupDetails.groupName : null;
                    const newCategoryId = groupCategorySelect.value;
                    const newGroupName = groupNameInput.value.trim();

                    // Základné kontroly
                    if (!oldCategoryId || !oldGroupName) {
                        console.error("Chyba: Chýbajú detaily pôvodnej skupiny pri úprave.");
                        alert("Chyba pri úprave skupiny. Prosím, obnovte stránku a skúste znova.");
                        return;
                    }
                    if (!newCategoryId) {
                        alert('Prosím, vyberte kategóriu.');
                        return;
                    }
                     if (newGroupName === '') {
                        alert('Názov skupiny nemôže byť prázdny.');
                        return;
                    }

                    // Ak sa nezmenila ani kategória ani názov
                    if (oldCategoryId === newCategoryId && oldGroupName === newGroupName) {
                         console.log('Názov a kategória skupiny neboli zmenené.');
                         alert('Zmeny skupiny neboli uložené, lebo sa nič nezmenilo.');
                         modal.style.display = 'none';
                         return;
                    }


                     // Kontrola duplicity nového názvu v novej kategórii (ak sa zmenila kategória alebo názov)
                     if (oldCategoryId !== newCategoryId || oldGroupName !== newGroupName) {
                        const newCategorySnapshot = await getDoc(doc(categoriesCollectionRef, newCategoryId));
                        if (newCategorySnapshot.exists()) {
                             const newCategoryGroups = newCategorySnapshot.data().groups || [];
                             // Skontrolujeme, či nový názov už existuje v cieľovej kategórii.
                             // Ak sa nezmenila kategória, musíme dovoliť, aby tam starý názov už bol (upravujeme ho).
                             // Ak sa zmenila kategória, nový názov nesmie existovať.
                             const isDuplicate = newCategoryGroups.includes(newGroupName);

                             if (isDuplicate && (oldCategoryId !== newCategoryId || (oldCategoryId === newCategoryId && oldGroupName !== newGroupName))) {
                                  alert(`Skupina s názvom "${newGroupName}" už v kategórii "${newCategoryId}" existuje!`);
                                  return;
                             }
                        } else {
                            alert(`Cieľová kategória "${newCategoryId}" neexistuje!`);
                            return;
                        }
                     }


                    // --- Vykonanie úpravy skupiny ---
                    // Toto vyžaduje transakciu, ak sa mení kategória, aby to bolo atomické
                    await runTransaction(db, async (transaction) => {
                         const oldCategoryDocRef = doc(categoriesCollectionRef, oldCategoryId);
                         const newCategoryDocRef = doc(categoriesCollectionRef, newCategoryId);

                         // Prečítať obe kategórie v rámci transakcie
                         const oldCategoryDoc = await transaction.get(oldCategoryDocRef);
                         // Novú kategóriu čítame len ak sa kategória mení
                         const newCategoryDoc = (oldCategoryId !== newCategoryId) ? await transaction.get(newCategoryDocRef) : oldCategoryDoc; // Ak sa nemení, nová je rovnaká ako stará

                         if (!oldCategoryDoc.exists()) {
                              throw "Pôvodná kategória pre skupinu nebola nájdená!";
                         }
                          if (oldCategoryId !== newCategoryId && !newCategoryDoc.exists()) {
                              throw "Cieľová kategória pre presunutie skupiny nebola nájdená!";
                          }


                         const oldGroups = oldCategoryDoc.data().groups || [];
                         let newGroups = (oldCategoryId !== newCategoryId) ? (newCategoryDoc.data().groups || []) : oldGroups; // Inicializácia poľa novej kategórie

                         // 1. Odstrániť starý názov z pôvodného poľa
                         const updatedOldGroups = oldGroups.filter(name => name !== oldGroupName);

                         // 2. Pridať nový názov do nového poľa
                         // Ak sa kategória nemení, pracujeme s rovnakým poľom
                         if (oldCategoryId === newCategoryId) {
                             const index = updatedOldGroups.indexOf(oldGroupName); // Nájdeme, kde bol pôvodný názov (už odstránený vo filtri)
                             // Pre jednoduchú zmenu názvu v poli: odstráň pôvodný a pridaj nový
                              if (updatedOldGroups.includes(newGroupName)) { // Skontrolujte duplicity aj tu, ak ste nekontrolovali predtým
                                throw `Skupina s názvom "${newGroupName}" už v tejto kategórii existuje!`;
                              }
                             updatedOldGroups.push(newGroupName); // Pridaj nový názov na koniec (alebo inde ak potrebujete poradie)
                             newGroups = updatedOldGroups; // Nové pole je to isté ako upravené staré
                         } else {
                             // Ak sa kategória mení, pridaj nový názov do poľa novej kategórie
                              if (newGroups.includes(newGroupName)) { // Skontrolujte duplicity aj tu
                                throw `Skupina s názvom "${newGroupName}" už v cieľovej kategórii existuje!`;
                              }
                              newGroups.push(newGroupName); // Pridaj nový názov do nového poľa
                         }

                         // 3. Aktualizovať dokumenty
                         transaction.update(oldCategoryDocRef, { groups: updatedOldGroups }); // Aktualizuj pôvodnú kategóriu (s odstráneným názvom)

                         if (oldCategoryId !== newCategoryId) {
                             transaction.update(newCategoryDocRef, { groups: newGroups }); // Aktualizuj novú kategóriu (s pridaným názvom)
                         } else {
                             // Ak sa kategória nemenila, aktualizujeme len jeden dokument (pôvodný)
                             // Tento prípad je už pokrytý prvým updateDoc, len jeho pole je "updatedOldGroups"
                             // Netreba volať transaction.update(newCategoryDocRef) znova ak newCategoryDocRef === oldCategoryDocRef
                         }
                    });

                    console.log(`Skupina "${oldGroupName}" (kategória "${oldCategoryId}") úspešne upravená na "${newGroupName}" (kategória "${newCategoryId}").`);

                    // --- Aktualizácia UI a stavu ---
                    modal.style.display = 'none';
                    form.reset();
                    currentModalMode = 'addCategory'; editingCategoryRef = null; editingCategoryRowElement = null; editingGroupDetails = null; // Reset stavu
                    showCategoryFields(false); showGroupFields(false);

                    // Obnoviť zobrazenie skupín
                    renderGroupsContent();


                }

            } catch (error) {
                console.error('Všeobecná chyba pri spracovaní formulára:', error);
                // Ak chyba pochádza z transakcie, error.message môže obsahovať správu, ktorú sme throwli
                 const errorMessage = typeof error === 'string' ? error : (error.message || 'Došlo k chybe pri ukladaní dát.');
                alert('Chyba pri ukladaní dát: ' + errorMessage);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Uložiť';
            }
        });


        // Pri načítaní stránky... (bez zmeny, len pridaný konzolový log)
        window.addEventListener('load', () => {
            if (!window.location.hash) {
                window.location.hash = '#kategorie';
            } else {
                 toggleContentVisibility();
            }
            console.log("Inicializácia stránky dokončená.");
        });

        // Kontrola prihlásenia (bez zmeny)
         const userName = localStorage.getItem('username');
         if (userName !== 'admin') {
             window.location.href = 'login.html';
         } else {
              console.log("Používateľ prihlásený ako admin. Načítavam obsah...");
         }
    </script>
</body>
</html>
