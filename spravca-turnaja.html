<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spr√°vca turnaja</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="style.css">

    <style>
        /* --- General Styles --- */
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-top: 20px;
            margin-bottom: 20px; /* Added margin-bottom for separation */
        }

        h2 {
            margin-top: 0; /* Reset margin-top, controlled by section padding */
            margin-bottom: 10px;
            color: #555;
        }

         h3 { /* Style for category headings in Manage Teams modal */
            margin-top: 15px;
            margin-bottom: 8px;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
         }


        .add-button {
            display: block;
            margin: 20px auto;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #28a745;
            color: white;
            font-size: 2em;
            border: none;
            cursor: pointer;
            text-align: center;
            line-height: 50px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.3s ease;
            position: sticky;
            top: 20px;
            z-index: 10;
        }

        .add-button:hover {
            background-color: #218838;
        }

        .content-wrapper {
            display: flex;
            margin-top: 20px;
            padding: 0 20px;
        }

        .left-menu {
            width: 200px;
            margin-right: 20px;
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky;
            top: 90px;
            align-self: flex-start;
            max-height: calc(100vh - 110px);
            overflow-y: auto;
        }

        .left-menu ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .left-menu li {
            margin-bottom: 10px;
        }

        .left-menu a {
            text-decoration: none;
            color: #007bff;
            font-weight: bold;
            display: block;
            padding: 5px 0;
            transition: color 0.3s ease;
        }

        .left-menu a:hover {
            color: #0056b3;
        }

        main {
            flex-grow: 1;
            padding: 0;
            box-shadow: none;
            background-color: transparent;
        }

        /* --- Section Block Style --- */
        .section-block {
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px; /* Space below each block */
        }


        /* --- Table Styles --- */
        /* Styles for the table element itself, regardless of the wrapper */
        #categoryTable, .category-group-table, .group-clubs-table, #clubsTable, #createdTeamsTable {
            border-collapse: collapse;
            width: 100%;
            border: none;
            overflow: hidden;
        }


        /* Style for the section wrapping category heading and group table */
        .category-group-section {
            /* Inherits background, padding, radius, shadow from .section-block */
            /* Flex properties only for group sections when inside #groupsContent */
            min-width: 300px;
            flex-grow: 1;
            flex-basis: 0;
        }

        /* Style for the main container of group sections (the flex container) */
        #groupsContent {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: flex-start;
            padding: 0;
            margin-bottom: 20px;
        }
         #groupsContent .section-block {
             margin-bottom: 0; /* Override margin for flex items */
         }


        /* Remove margin-top from the first element inside a section block */
        .section-block h2:first-child,
        .section-block table:first-child {
            margin-top: 0;
        }

         /* Style for tables within the manage teams modal */
         #manageTeamsModal .group-clubs-table {
             margin-bottom: 15px; /* Space below each category table in the modal */
         }


        /* Table Header and Cell Styles - apply to all tables */
        #categoryTable th, #clubsTable th, .category-group-table th, .group-clubs-table th, #createdTeamsTable th {
            background-color: #f2f2f2;
            color: #333;
            font-weight: bold;
            text-align: left;
            padding: 12px 15px;
            border-bottom: 2px solid #ddd;
        }

        #categoryTable td, #clubsTable td, .category-group-table td, .group-clubs-table td, #createdTeamsTable td {
            text-align: left;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
        }

        /* Center align quantity cells in Created Teams table */
         #createdTeamsTable tbody td:not(:first-child):not(:last-child) {
              text-align: center;
         }


        /* Remove bottom border from last row in tbody for all tables */
        #categoryTable tbody tr:last-child td,
        #clubsTable tbody tr:last-child td,
        .category-group-table tbody tr:last-child td,
        .group-clubs-table tbody tr:last-child td,
        #createdTeamsTable tbody tr:last-child td {
             border-bottom: none;
        }

        /* Hover effect for all table rows */
        #categoryTable tbody tr:hover,
        #clubsTable tbody tr:hover,
        .category-group-table tbody tr:hover,
        .group-clubs-table tbody tr:hover,
        #createdTeamsTable tbody tr:hover {
            background-color: #f9f9f9;
            cursor: pointer;
        }

        /* Ensure last cell in row doesn't wrap buttons */
        #categoryTable td:last-child,
        #clubsTable td:last-child,
        .category-group-table td:last-child,
        .group-clubs-table td:last-child,
        #createdTeamsTable td:last-child,
         #manageTeamsModal .group-clubs-table td:last-child /* Also for tables in modal */
         {
             white-space: nowrap;
        }

        #clubsContent {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: flex-start;
            padding: 0;
            margin-bottom: 20px;
        }

        /* Style for container divs that wrap club sections when inside #clubsContent */
        #clubsContent .section-block {
            /* Inherits background, padding, radius, shadow from .section-block */
            min-width: 300px;
            flex-grow: 1;
            flex-basis: calc(33.33% - 20px);
            margin-bottom: 0; /* Override the default .section-block margin when inside flex */
        }

        #teamCreationContentSection table {
            /* Ensure table within section block takes full width */
             width: 100%;
        }


        /* --- Action Button Styles --- */
        .action-button {
            padding: 5px 10px;
            margin-right: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
        }

        .action-button:not(.delete-button) {
            background-color: #007bff;
            color: white;
        }

        .action-button.delete-button {
            background-color: #dc3545;
            color: white;
        }

        .action-button:not(.delete-button):hover { background-color: #0056b3; }
        .action-button.delete-button:hover { background-color: #c82333; }


        /* --- Modal Styles --- */
         .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            padding-top: 60px;
         }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
            position: relative;
        }

        .close {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover, .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-content form label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

         .modal-content form input[type="text"],
         .modal-content form input[type="number"],
         .modal-content form select {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
         }
         /* Adjust select height for multiple */
         .modal-content form select[multiple] {
              min-height: 100px; /* Or adjust as needed */
         }


        .modal-content form button[type="submit"] { /* Target the submit button */
            background-color: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }

         .modal-content form button[type="submit"]:hover { /* Target the submit button */
            background-color: #218838;
         }

         /* Style for the container divs around specific form elements */
         .modal-content form div {
             margin-bottom: 20px; /* Add spacing below input groups */
         }
         .modal-content form div:last-of-type {
              margin-bottom: 0; /* Remove bottom margin for the last one before the button */
         }
          .modal-content form label,
          .modal-content form input[type="text"],
          .modal-content form input[type="number"],
          .modal-content form select {
              margin-bottom: 0; /* Remove margin from elements inside the div */
          }

          /* Optional CSS for dynamically added category/count pairs */
            .category-count-pair {
                border: 1px solid #eee;
                padding: 10px;
                margin-bottom: 15px; /* Space below each pair */
                border-radius: 5px;
                background-color: #f9f9f9;
            }

            .category-count-pair label {
                display: inline-block; /* Make labels inline */
                margin-bottom: 5px;
                margin-right: 10px; /* Space between label and input/select */
                font-weight: normal; /* Less bold than section titles */
                min-width: 80px; /* Align labels (adjust as needed) */
            }

            .category-count-pair select,
            .category-count-pair input[type="number"] {
                 display: inline-block; /* Make inputs/selects inline */
                 width: auto; /* Allow size based on content/min-width */
                 margin-bottom: 0; /* Remove bottom margin */
                 margin-right: 10px; /* Space between elements */
                 padding: 5px; /* Smaller padding */
            }

            /* Style for the remove button within the pair */
            .category-count-pair .action-button.delete-button {
                padding: 3px 8px; /* Smaller padding */
                font-size: 0.8em; /* Smaller font */
            }

            /* Adjust spacing within the container div */
            #teamCategoryCountContainer div {
                margin-bottom: 10px; /* Space between inner divs (label+element) */
            }

            /* Ensure remove button is not on a new line if space allows */
            .category-count-pair div:last-of-type { /* This targets the last div within a pairDiv */
                 margin-bottom: 0;
            }


    </style>
</head>
<body>
    <script>
        // Basic check for admin, redirect if not
        const userName = localStorage.getItem('username');
        if (userName !== 'admin') {
             window.location.href = 'login.html';
        }
    </script>

    <h1>Spr√°vca turnaja</h1>

    <button class="add-button" id="addButton" title="Prida≈• polo≈æku">+</button>

    <div class="modal" id="categoryModal">
        <div class="modal-content">
            <span class="close category-modal-close">&times;</span>
            <h2 id="categoryModalTitle">Prida≈• kateg√≥riu</h2>
            <form id="categoryForm">
                <div>
                    <label for="categoryName">N√°zov kateg√≥rie:</label>
                    <input type="text" id="categoryName" name="categoryName" required>
                </div>
                <button type="submit">Ulo≈æi≈•</button>
            </form>
        </div>
    </div>

     <div class="modal" id="groupModal">
         <div class="modal-content">
                 <span class="close group-modal-close">&times;</span>
                 <h2 id="groupModalTitle">Prida≈• skupinu</h2>
                 <form id="groupForm">
                     <div>
                          <label for="groupCategory">Kateg√≥ria:</label>
                          <select id="groupCategory" name="groupCategory" required>
                               <option value="">-- Vyberte kateg√≥riu --</option>
                               </select>
                     </div>

                     <div>
                          <label for="groupName">N√°zov skupiny:</label>
                          <input type="text" id="groupName" name="groupName" required>
                     </div>

                     <button type="submit">Ulo≈æi≈•</button>
                 </form>
         </div>
     </div>

    <div class="modal" id="clubModal">
         <div class="modal-content">
                 <span class="close club-modal-close">&times;</span>
                 <h2 id="clubModalTitle">Priradi≈• t√≠m do skupiny</h2>
                 <form id="clubForm">
                       <div id="unassignedClubSelectContainer">
                          <label for="unassignedClubSelect">Vyberte existuj√∫ci t√≠m:</label>
                          <select id="unassignedClubSelect">
                               <option value="">-- Vyberte t√≠m na priradenie --</option>
                           </select>
                      </div>

                      <div id="clubNameInputContainer">
                          <label for="clubName">N√°zov klubu:</label>
                          <input type="text" id="clubName" name="clubName" required>
                       </div>

                      <div>
                          <label for="clubCategory">Kateg√≥ria:</label>
                          <select id="clubCategory" name="clubCategory" required>
                               <option value="">-- Vyberte kateg√≥riu --</option>
                               </select>
                      </div>

                      <div>
                           <label for="clubGroup">Skupina:</label>
                           <select id="clubGroup" name="clubGroup" required disabled>
                                <option value="">-- Najprv vyberte kateg√≥riu --</option>
                            </select>
                      </div>

                       <div id="orderInputContainer">
                            <label for="orderInGroup">Poradov√© ƒç√≠slo v skupine:</label>
                            <input type="number" id="orderInGroup" name="orderInGroup" min="1">
                       </div>

                       <button type="submit">Ulo≈æi≈•</button>
                  </form>
         </div>
     </div>

    <div class="modal" id="teamCreationModal">
        <div class="modal-content">
            <span class="close team-creation-modal-close">&times;</span>
            <h2 id="teamCreationModalTitle">Vytvori≈• t√≠my</h2>
            <form id="teamCreationForm">
                <div>
                    <label for="teamNameInput">Z√°kladn√Ω n√°zov t√≠mu:</label>
                    <input type="text" id="teamNameInput" name="teamName" required>
                </div>

                <div id="teamCategoryCountContainer">
                     </div>

                 <button type="button" id="addCategoryCountPairButton" class="action-button" style="margin-bottom: 15px;">Prida≈• ƒèal≈°iu kateg√≥riu</button> <button type="submit">Vytvori≈• t√≠my</button> </form>
        </div>
    </div>

    <div class="modal" id="manageTeamsModal">
        <div class="modal-content" style="max-width: 700px;"> <span class="close manage-teams-modal-close">&times;</span>
            <h2 id="manageTeamsModalTitle"><span id="baseTeamNameInModal"></span></h2>

            <div id="teamsListInModal">
                <p>Naƒç√≠tavam t√≠my...</p> </div>

            <div style="text-align: right; margin-top: 20px;">
                 <button class="action-button" onclick="closeManageTeamsModal()">Zatvori≈•</button>
            </div>
        </div>
    </div>


    <div class="content-wrapper">
        <nav class="left-menu">
            <ul>
                <li><a href="#kategorie">Vytvorenie kateg√≥ri√≠</a></li>
                <li><a href="#skupiny">Vytvorenie skup√≠n</a></li>
                <li><a href="#zoznam-timov">Zoznam t√≠mov</a></li>
                <li><a href="#timy-do-skupin">T√≠my do skup√≠n</a></li>
                <li><a href="#sportove-haly">≈†portov√© haly</a></li>
                <li><a href="#sprava-turnaja">Spr√°va turnaja</a></li>
                <li><a href="#nastavenia">Nastavenia</a></li>
            </ul>
        </nav>

        <main>
            <div id="categoriesContentSection" class="section-block" style="display: none;">
                 <h2>Vytvorenie kateg√≥ri√≠</h2>
                <table id="categoryTable">
                    <thead>
                        <tr>
                            <th>N√°zov</th>
                            <th style="width: 150px;"></th>
                        </tr>
                    </thead>
                    <tbody id="categoryTableBody">
                        </tbody>
                </table>
            </div>

            <div id="groupsContent" style="display: none;">
                </div>

            <div id="clubsContent" style="display: none;">
                 </div>

             <div id="teamCreationContentSection" class="section-block" style="display: none;">
                 <h2>Zoznam t√≠mov</h2>
                 <table id="createdTeamsTable">
                     <thead>
                         <tr id="createdTeamsTableHeader"> <th>N√°zov t√≠mu</th>
                             <th style="width: 150px;"></th>
                         </tr>
                     </thead>
                     <tbody id="createdTeamsTableBody">
                         </tbody>
                 </table>
            </div>

            </main>
    </div>


    <script type="module">
        // Import potrebn√Ωch Firebase Firestore funkci√≠ priamo z CDN
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, query, where, addDoc, updateDoc, writeBatch } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';
        // Import FieldPath pre query podƒæa ID dokumentu v clubForm submit handleri
        // ODSTR√ÅNEN√ù IMPORT FieldPath PRETO≈ΩE SP√îSOBOVAL CHYBU
        // import { FieldPath } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';


        // Tvoja Firebase konfigur√°cia
        const firebaseConfig = {
            apiKey: "AIzaSyD0h0rQZiIGi0-UDb4-YU_JihRGpIlfz40", // ZME≈á ZA SVOJ SKUTOƒåN√ù API KƒΩ√öƒå
            authDomain: "turnaj-a28c5.firebaseapp.com", // ZME≈á ZA SVOJ SKUTOƒåN√ù authDomain
            projectId: "turnaj-a28c5", // ZME≈á ZA SVOJ SKUTOƒåN√ù projectId
            storageBucket: "turnaj-a28c5.firebasestorage.app", // ZME≈á ZA SVOJ SKUTOƒåN√ù storageBucket
            messagingSenderId: "13732191148", // ZME≈á ZA SVOJ SKUTOƒåN√ù messagingSenderId
            appId: "1:13732191148:web:5ad78eaef2ad452a10f809" // ZME≈á ZA SVOJ SKUTOƒåN√ù appId
        };

        // Inicializ√°cia Firebase aplik√°cie
        const app = initializeApp(firebaseConfig);
        // Z√≠skanie in≈°tancie Firestore datab√°zy
        const db = getFirestore(app);

        // Referencia na kolekcie
        const categoriesCollectionRef = collection(db, 'tournamentData', 'mainTournamentData', 'categories');
        const groupsCollectionRef = collection(db, 'tournamentData', 'mainTournamentData', 'groups'); // Groups use composite IDs
        const clubsCollectionRef = collection(db, 'tournamentData', 'mainTournamentData', 'clubs'); // Clubs now use auto-generated IDs


        // Z√≠skame referencie na DOM elementy
        const addButton = document.getElementById('addButton');

        // Mod√°l Kateg√≥rie
        const categoryModal = document.getElementById('categoryModal');
        const categoryModalCloseBtn = categoryModal.querySelector('.category-modal-close');
        const categoryForm = document.getElementById('categoryForm');
        const categoryNameInput = document.getElementById('categoryName');
        const categoryModalTitle = document.getElementById('categoryModalTitle');

        // Mod√°l Skupiny
        const groupModal = document.getElementById('groupModal');
        const groupModalCloseBtn = groupModal.querySelector('.group-modal-close');
        const groupForm = document.getElementById('groupForm');
        const groupCategorySelect = document.getElementById('groupCategory');
        const groupNameInput = document.getElementById('groupName');
        const groupModalTitle = document.getElementById('groupModalTitle');
        const groupFormSubmitButton = groupForm.querySelector('button[type="submit"]');

        // Mod√°l Kluby (pre priradenie do skup√≠n / √∫pravu priraden√Ωch)
        const clubModal = document.getElementById('clubModal');
        const clubModalCloseBtn = clubModal.querySelector('.club-modal-close');
        const clubForm = document.getElementById('clubForm');
        const clubNameInput = document.getElementById('clubName'); // Existing name input (used when editing assigned)
        const clubCategorySelect = document.getElementById('clubCategory');
        const clubGroupSelect = document.getElementById('clubGroup');
        const clubModalTitle = document.getElementById('clubModalTitle');
        const clubFormSubmitButton = clubForm.querySelector('button[type="submit"]');

        // REFERENCES FOR CLUB MODAL CHANGES (add/edit assigned)
        const unassignedClubSelectContainer = document.getElementById('unassignedClubSelectContainer');
        const unassignedClubSelect = document.getElementById('unassignedClubSelect');
        const clubNameInputContainer = document.getElementById('clubNameInputContainer');
         const orderInputContainer = document.getElementById('orderInputContainer'); // Reference to the new order input container
        const orderInGroupInput = document.getElementById('orderInGroup'); // Reference to the new order input field


        // Mod√°l Vytvorenie T√≠mov
        const teamCreationModal = document.getElementById('teamCreationModal');
        const teamCreationModalCloseBtn = teamCreationModal.querySelector('.team-creation-modal-close');
        const teamCreationForm = document.getElementById('teamCreationForm');
        // Removed teamCategorySelect and teamCountInput as they are now dynamic
        const teamNameInput = document.getElementById('teamNameInput'); // Input for base team name
        // New references for dynamic elements container and add button
        const teamCategoryCountContainer = document.getElementById('teamCategoryCountContainer');
        const addCategoryCountPairButton = document.getElementById('addCategoryCountPairButton');


        // Nov√Ω Modal pre spr√°vu individu√°lnych t√≠mov
        const manageTeamsModal = document.getElementById('manageTeamsModal');
        const manageTeamsModalCloseBtn = manageTeamsModal.querySelector('.manage-teams-modal-close');
        const baseTeamNameInModalSpan = document.getElementById('baseTeamNameInModal');
        const teamsListInModalDiv = document.getElementById('teamsListInModal');


        // Zobrazovan√© sekcie (obalov√© divy)
        const categoriesContentSection = document.getElementById('categoriesContentSection'); // Obalov√Ω div pre kateg√≥rie
        const groupsContentDiv = document.getElementById('groupsContent'); // Flex kontajner pre skupiny
        const clubsContentDiv = document.getElementById('clubsContent'); // Flex kontajner pre kluby v skupin√°ch (priraden√©)
        // Obalov√Ω div pre sekciu Vytvorenie T√≠mov (nepriraden√©)
        const teamCreationContentSection = document.getElementById('teamCreationContentSection');


        // Referencie na samotn√© tabuƒæky (pre manipul√°ciu s tbody)
        const categoryTable = document.getElementById('categoryTable');
        const categoryTableBody = document.getElementById('categoryTableBody');

        // Referencia na tbody tabuƒæky Vytvorenie T√≠mov
        const createdTeamsTableBody = document.getElementById('createdTeamsTableBody');
        // Referencia na hlaviƒçku tabuƒæky Vytvorenie T√≠mov (pre dynamick√© stƒ∫pce)
        const createdTeamsTableHeader = document.getElementById('createdTeamsTableHeader');


        // Premenn√© stavu mod√°lov
        let currentCategoryModalMode = 'add';
        let editingCategoryName = null;

        let currentGroupModalMode = 'add';
        let editingGroupId = null; // Kompozitn√© ID upravovanej skupiny

        // Premenn√© stavu pre mod√°l Kluby (Priradenie/√öprava)
        let currentClubModalMode = 'add-assign'; // Default mode: 'add-assign' or 'edit-assigned'
        let editingClubId = null; // Auto-generated ID of the club document being edited


        // Premenn√© stavu pre mod√°l Vytvorenie T√≠mov (zatiaƒæ len 'add')
        let currentTeamCreationModalMode = 'add';

        // Premenn√° na ulo≈æenie v≈°etk√Ωch dostupn√Ωch kateg√≥ri√≠ pre dynamick√© selecty
        let allAvailableCategories = [];


        // --- Funkcie pre Kateg√≥rie ---
        function addCategoryRowToTable(categoryName) {
             const tr = document.createElement('tr');
             const nameTd = document.createElement('td');
             nameTd.textContent = categoryName;
             const actionsTd = document.createElement('td');
             actionsTd.style.whiteSpace = 'nowrap';

             const renameButton = document.createElement('button');
             renameButton.textContent = 'Premenova≈•';
             renameButton.classList.add('action-button');
             renameButton.onclick = function() {
                 currentCategoryModalMode = 'edit';
                 editingCategoryName = categoryName;
                 categoryModalTitle.textContent = 'Premenova≈• kateg√≥riu';
                 categoryNameInput.value = categoryName;
                 categoryModal.style.display = 'block';
                 categoryNameInput.focus();
             };


             const deleteButton = document.createElement('button');
             deleteButton.textContent = 'Vymaza≈•';
             deleteButton.classList.add('action-button', 'delete-button');
             deleteButton.onclick = async function() {
                  const categoryToDelete = this.closest('tr').querySelector('td:first-child').textContent;

                  if (!confirm(`Naozaj chcete vymaza≈• kateg√≥riu "${categoryToDelete}"? Ak√©koƒævek priraden√© skupiny a kluby pr√≠du o svoju kateg√≥riu (categoryId a groupId sa nastavia na null)!`)) {
                      return;
                  }

                  try {
                      // Pred zmazan√≠m kateg√≥rie, n√°jdi a aktualizuj v≈°etky kluby a skupiny, ktor√© na ≈àu odkazuj√∫
                      const batch = writeBatch(db);

                      // N√°jdi a aktualizuj skupiny s touto kateg√≥riou
                      const groupsQuery = query(groupsCollectionRef, where('categoryId', '==', categoryToDelete));
                      const groupsSnapshot = await getDocs(groupsQuery);

                       // Fetch clubs related to groups being deleted *before* starting the batch queries within the loop
                       const clubUpdates = [];
                       for (const groupDoc of groupsSnapshot.docs) {
                           const clubsInGroupQuery = query(clubsCollectionRef, where('groupId', '==', groupDoc.id));
                           const clubsSnapshot = await getDocs(clubsInGroupQuery);
                           clubsSnapshot.forEach(clubDoc => {
                                // Let's simplify: if category deleted, clubs lose both references.
                               batch.update(clubDoc.ref, { categoryId: null, groupId: null, orderInGroup: null }); // Update club with null references
                                console.log(`Klub "${clubDoc.id}" odpriraden√Ω kv√¥li zmazaniu skupiny "${groupDoc.id}".`); // Clarified log
                           });
                            // Add group deletion to batch
                           batch.delete(groupDoc.ref); // Delete old group doc
                           console.log(`Star√° skupina "${groupDoc.id}" zmazan√° pri mazan√≠ kateg√≥rie.`); // Clarified log
                       }

                       // N√°jdi a aktualizuj kluby s touto kateg√≥riou, ktor√© u≈æ nemusia by≈• priraden√© k skupine (groupId == null)
                       const unassignedClubsQuery = query(clubsCollectionRef, where('categoryId', '==', categoryToDelete), where('groupId', '==', null));
                        const unassignedClubsSnapshot = await getDocs(unassignedClubsQuery);
                        unassignedClubsSnapshot.forEach(doc => {
                           batch.update(doc.ref, { categoryId: null }); // Just update categoryId to null
                           console.log(`Nepriraden√Ω klub "${doc.id}" aktualizovan√Ω (categoryId = null).`);
                        });


                      // Nakoniec zma≈æ samotn√∫ kateg√≥riu
                      batch.delete(doc(categoriesCollectionRef, categoryToDelete)); // Delete old category doc using old name

                      await batch.commit();

                      console.log(`Kateg√≥ria "${categoryToDelete}" a s√∫visiace referencie boli √∫spe≈°ne zmazan√©/aktualizovan√©.`);

                      // Refresh displays that might be affected
                       loadCategoriesTable(); // Always refresh category table
                       if (window.location.hash === '#skupiny') {
                           groupsContentDiv.innerHTML = '';
                           displayGroupsByCategory();
                       }
                       if (window.location.hash === '#timy-do-skupin') displayClubs();
                       if (window.location.hash === '#zoznam-timov') {
                           // Refresh created teams list, which depends on categories
                           displayCreatedTeams();
                           // Aj po zmazan√≠ kateg√≥rie treba aktualizova≈• ponuky v Team Creation Modale
                           if (teamCreationModal.style.display === 'block') {
                                loadAllCategoriesForDynamicSelects();
                           }
                       }


                  } catch (error) {
                      console.error('Chyba pri mazan√≠ kateg√≥rie a s√∫visiacich d√°t: ', error);
                      alert('Chyba pri mazan√≠ kateg√≥rie! Pros√≠m, sk√∫ste znova.');
                      // Close modal and reset state on error
                      categoryModal.style.display = 'none'; categoryForm.reset();
                      currentCategoryModalMode = 'add'; editingCategoryName = null;
                  }
             };

             actionsTd.appendChild(renameButton);
             actionsTd.appendChild(deleteButton);
             tr.appendChild(nameTd);
             tr.appendChild(actionsTd);
             categoryTableBody.appendChild(tr); // Append directly to tbody
         }

         async function loadCategoriesTable() {
             try {
                 categoryTableBody.innerHTML = ''; // Clear existing rows
                 const querySnapshot = await getDocs(categoriesCollectionRef);
                 if (querySnapshot.empty) {
                     console.log("≈Ωiadne kateg√≥rie nen√°jden√©.");
                     const noDataRow = document.createElement('tr');
                     const td = document.createElement('td');
                     td.colSpan = 2;
                     td.textContent = "≈Ωiadne kateg√≥rie zatiaƒæ pridan√©.";
                     td.style.textAlign = 'center';
                     noDataRow.appendChild(td);
                     categoryTableBody.appendChild(noDataRow);
                 } else {
                     // Sort categories alphabetically by name (doc.id)
                     const sortedDocs = querySnapshot.docs.sort((a, b) => a.id.localeCompare(b.id));
                     sortedDocs.forEach((doc) => {
                         const categoryName = doc.id;
                         addCategoryRowToTable(categoryName);
                     });
                     console.log(`Naƒç√≠tan√Ωch kateg√≥ri√≠: ${sortedDocs.length}`);
                 }
             } catch (error) {
                 console.error('Chyba pri naƒç√≠tan√≠ kateg√≥ri√≠: ', error);
                 alert('Chyba pri naƒç√≠tan√≠ kateg√≥ri√≠!');
                  const errorRow = document.createElement('tr');
                  const td = document.createElement('td');
                  td.colSpan = 2;
                  td.textContent = "Chyba pri naƒç√≠tan√≠ kateg√≥ri√≠.";
                  td.style.textAlign = 'center';
                  errorRow.appendChild(td);
                  categoryTableBody.appendChild(errorRow);
             }
         }


         // --- Funkcie pre Skupiny (logika z√°pisu pou≈æ√≠va kompozitn√© ID) ---

         // Funkcia na naƒç√≠tanie kateg√≥ri√≠ a naplnenie <select>
         // Pou≈æiteƒæn√° pre groupModal, clubModal a teamCreationModal
         async function populateCategorySelect(selectElement, selectedCategoryId = null) {
              // Handle multiple select placeholder differently (Removed multiple select logic from here)
              selectElement.innerHTML = '<option value="">-- Vyberte kateg√≥riu --</option>';


               selectElement.disabled = true; // Disable while loading


              try {
                  const querySnapshot = await getDocs(categoriesCollectionRef);
                  if (querySnapshot.empty) {
                      console.log("≈Ωiadne kateg√≥rie pre naplnenie selectu.");
                      const option = document.createElement('option');
                      option.value = "";
                      option.textContent = "-- ≈Ωiadne kateg√≥rie --";
                      option.disabled = true;
                      selectElement.appendChild(option);
                       selectElement.disabled = false; // Re-enable even if empty, unless truly errored
                  } else {
                       selectElement.disabled = false; // Enable the select
                       // Sort categories alphabetically by name (doc.id)
                       const sortedDocs = querySnapshot.docs.sort((a, b) => a.id.localeCompare(b.id));
                       sortedDocs.forEach((doc) => {
                            const categoryName = doc.id;
                            const option = document.createElement('option');
                            option.value = categoryName;
                            option.textContent = categoryName;
                            selectElement.appendChild(option);
                       });

                       // Select the provided category ID(s) (Simplified for single select)
                       if (selectedCategoryId) {
                            if (selectElement.querySelector(`option[value="${selectedCategoryId}"]`)) {
                                 selectElement.value = selectedCategoryId;
                            } else {
                                 console.warn(`Kateg√≥ria "${selectedCategoryId}" pre zvolen√∫ polo≈æku nen√°jden√° v zozname kateg√≥ri√≠.`);
                                 selectElement.value = ""; // Reset to default if selected category not found
                            }
                       }
                   }
               } catch (error) {
                   console.error('Chyba pri naƒç√≠tan√≠ kateg√≥ri√≠ pre select: ', error);
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "Chyba pri naƒç√≠tan√≠ kateg√≥ri√≠";
                    option.disabled = true;
                    selectElement.appendChild(option);
                    selectElement.disabled = true; // Keep disabled on error
               }
            }


             // Funkcia na naƒç√≠tanie skup√≠n pre dan√∫ kateg√≥riu a naplnenie <select> (pou≈æ√≠va kompozitn√© ID)
             // Pou≈æiteƒæn√° pre clubModal
             async function populateGroupSelect(categoryId, selectElement, selectedGroupId = null) { // selectElement, selectedGroupId
                 selectElement.innerHTML = '<option value="">-- Vyberte skupinu --</option>';
                 selectElement.disabled = true; // Disable until category is selected or loading is complete


                 if (!categoryId || categoryId === '-- Vyberte kateg√≥riu --') { // Also check placeholder value
                     selectElement.innerHTML = '<option value="">-- Najprv vyberte kateg√≥riu --</option>';
                     selectElement.disabled = true;
                     return; // No category selected, cannot load groups
                 }

                  selectElement.disabled = true; // Re-disable during loading

                 try {
                     // Query groups that belong to the selected category
                     const q = query(groupsCollectionRef, where('categoryId', '==', categoryId));
                     const querySnapshot = await getDocs(q);

                     if (querySnapshot.empty) {
                         console.log(`≈Ωiadne skupiny n√°jden√© pre kateg√≥riu "${categoryId}".`);
                         const option = document.createElement('option');
                         option.value = "";
                         option.textContent = "-- ≈Ωiadne skupiny v kateg√≥rii --";
                         option.disabled = true;
                         selectElement.appendChild(option);

                     } else {
                         console.log(`Naƒç√≠tan√© skup√≠n pre kateg√≥riu "${categoryId}".`);
                         // Sort groups alphabetically by name
                         const sortedDocs = querySnapshot.docs.sort((a, b) => (a.data().name || '').localeCompare(b.data().name || ''));

                         sortedDocs.forEach((doc) => {
                              const groupData = doc.data();
                              // The group ID is the composite ID "Category - Group Name"
                              const groupId = doc.id; // This is the composite ID
                              const groupName = groupData.name; // Get the actual group name field

                              const option = document.createElement('option');
                               // Use the composite ID as the option value
                              option.value = groupId;
                               // Display the group name
                              option.textContent = groupName;
                              selectElement.appendChild(option);
                           });

                            // Select the provided group ID if in edit mode and it exists
                            if (selectedGroupId) {
                                  if (selectElement.querySelector(`option[value="${selectedGroupId}"]`)) {
                                       selectElement.value = selectedGroupId;
                                  } else {
                                       console.warn(`Skupina "${selectedGroupId}" pre zvolen√∫ polo≈æku nen√°jden√° v zozname skup√≠n pre t√∫to kateg√≥riu.`);
                                       selectElement.value = ""; // Reset to default if selected group not found
                                  }
                            }
                     }
                     selectElement.disabled = false; // Enable after loading (even if empty)

                 } catch (error) {
                     console.error('Chyba pri naƒç√≠tan√≠ skup√≠n pre select: ', error);
                      selectElement.innerHTML = '<option value="">Chyba pri naƒç√≠tan√≠ skup√≠n</option>'; // Indicate error
                      selectElement.disabled = true; // Keep disabled on error
                }
             }


 // Funkcia na otvorenie mod√°lu skupiny (pre pridanie alebo √∫pravu)
  //groupId je kompozitn√© ID, groupData m√° name, categoryId
 async function openGroupModal(groupId = null, groupData = null) {
      groupModal.style.display = 'block';

      // Resetuj stav mod√°lu a formul√°r
      currentGroupModalMode = 'add';
      editingGroupId = null; // Vyma≈æ ID upravovanej skupiny
      groupForm.reset(); // Vyƒçisti polia formul√°ra
      groupNameInput.disabled = false; // Uisti sa, ≈æe vstup pre n√°zov je povolen√Ω
      groupFormSubmitButton.textContent = 'Ulo≈æi≈•'; // Default button text


      // Napl≈à select kateg√≥ri√≠ pre mod√°l skupiny
      groupCategorySelect.value = ""; // Resetuj v√Ωber kateg√≥rie


      if (groupId && groupData) {
          // Re≈æim √∫pravy
          currentGroupModalMode = 'edit';
          editingGroupId = groupId; // Ulo≈æ kompozitn√© ID skupiny, ktor√° sa upravuje
          groupModalTitle.textContent = 'Premenova≈• skupinu';
          groupFormSubmitButton.textContent = 'Ulo≈æi≈• zmeny';

          // Napl≈à select kateg√≥ri√≠ a potom nastav zvolen√∫ hodnotu
          await populateCategorySelect(groupCategorySelect, groupData.categoryId); // Pass select element first

          // Vypl≈à polia formul√°ra
          groupNameInput.value = groupData.name; // Pou≈æi pole 'name' z d√°t
          // Hodnota groupCategorySelect sa nastav√≠ funkciou populateCategorySelect

      } else {
          // Re≈æim pridania (poƒçiatoƒçn√Ω stav u≈æ nastaven√Ω vy≈°≈°ie)
          groupModalTitle.textContent = 'Prida≈• skupinu';

          await populateCategorySelect(groupCategorySelect, null); // Napl≈à select kateg√≥ri√≠
      }

      groupNameInput.focus(); // Nastav focus na pole pre n√°zov
     }


             // Funkcia na zobrazenie skup√≠n usporiadan√Ωch podƒæa kateg√≥ri√≠
             async function displayGroupsByCategory() {
                  groupsContentDiv.innerHTML = ''; // Clear container

                  try {
                     // 1. Naƒç√≠ta≈• v≈°etky kateg√≥rie
                     const categoriesSnapshot = await getDocs(categoriesCollectionRef);
                     // Sort categories by name (doc.id)
                     const sortedCategoriesDocs = categoriesSnapshot.docs.sort((a, b) => a.id.localeCompare(b.id));
                     const categories = sortedCategoriesDocs.map(doc => doc.id);


                     if (categories.length === 0) {
                          const message = document.createElement('p');
                          message.textContent = "Pridajte kateg√≥rie v sekcii 'Kateg√≥rie' pre zobrazenie skup√≠n.";
                          groupsContentDiv.appendChild(message);
                          return;
                     }

                     // 2. Naƒç√≠ta≈• v≈°etky skupiny
                     const groupsSnapshot = await getDocs(groupsCollectionRef);

                     // 3. Zoskupi≈• skupiny podƒæa categoryId
                     const groupsByCategory = {};
                     groupsSnapshot.forEach(doc => {
                          const groupData = doc.data();
                          const groupId = doc.id; // This je kompozitn√© ID
                          const categoryId = groupData.categoryId;

                          if (categoryId) {
                              if (!groupsByCategory[categoryId]) {
                                  // OPRAVEN√â: Inicializuj ako pr√°zdne POLE
                                  groupsByCategory[categoryId] = [];
                              }
                              // Ulo≈æ√≠me ID a d√°ta do poƒæa
                              groupsByCategory[categoryId].push({ id: groupId, data: groupData });
                          } else {
                              console.warn(`Skupina ${groupId} nem√° priraden√∫ categoryId.`);
                              // Optional: Handle groups without a category
                          }
                     });

                     // 4. Pre ka≈æd√∫ kateg√≥riu vytvori≈• sekciu (div) s nadpisom a tabuƒækou so skupinami
                     categories.forEach(categoryName => {
                          const groupsForThisCategory = groupsByCategory[categoryName] || [];

                          // Pou≈æijeme triedu section-block pre konzistentn√Ω vzhƒæad
                          const categorySectionDiv = document.createElement('div');
                          categorySectionDiv.classList.add('category-group-section', 'section-block');

                          const categoryHeading = document.createElement('h2');
                          categoryHeading.textContent = `${categoryName}`;
                          categorySectionDiv.appendChild(categoryHeading);

                          const categoryGroupsTable = document.createElement('table');
                          categoryGroupsTable.classList.add('category-group-table');

                          const thead = document.createElement('thead');
                          const headerRow = document.createElement('tr');
                          const groupNameTh = document.createElement('th');
                          groupNameTh.textContent = 'N√°zov';
                          const actionsTh = document.createElement('th');
                          actionsTh.textContent = ''; // Changed to Akcie
                          actionsTh.style.width = '150px';

                          headerRow.appendChild(groupNameTh);
                          headerRow.appendChild(actionsTh);
                          thead.appendChild(headerRow);
                          categoryGroupsTable.appendChild(thead);

                          const tbody = document.createElement('tbody');

                          if (groupsForThisCategory.length === 0) {
                              const noGroupsRow = document.createElement('tr');
                              const td = document.createElement('td');
                              td.colSpan = 2;
                              td.textContent = `V kateg√≥rii "${categoryName}" zatiaƒæ nie s√∫ ≈æiadne skupiny.`;
                              td.style.textAlign = 'center';
                              noGroupsRow.appendChild(td);
                              tbody.appendChild(noGroupsRow);
                          } else {
                              // Sort groups by name before displaying
                              groupsForThisCategory.sort((a, b) => (a.data.name || '').localeCompare(b.data.name || ''));

                              groupsForThisCategory.forEach(group => {
                                   const groupRow = document.createElement('tr');
                                   const groupNameTd = document.createElement('td');
                                   groupNameTd.textContent = group.data.name; // Pou≈æi pole 'name' z d√°t


                                   const groupActionsTd = document.createElement('td');
                                   groupActionsTd.style.whiteSpace = 'nowrap';

                                   // TLAƒåIDLO √öPRAVA SKUPINY - VOL√Å openGroupModal
                                    const editGroupButton = document.createElement('button');
                                    editGroupButton.textContent = 'Premenova≈•';
                                    editGroupButton.classList.add('action-button');
                                    editGroupButton.onclick = () => {
                                         openGroupModal(group.id, group.data); // Pass the composite group ID and its data
                                    };


                                   // TLAƒåIDLO VYMAZA≈§ SKUPINU
                                    const deleteGroupButton = document.createElement('button'); // Corrected variable name
                                    deleteGroupButton.textContent = 'Vymaza≈•';
                                    deleteGroupButton.classList.add('action-button', 'delete-button');
                                    deleteGroupButton.onclick = async () => {
                                         if (!confirm(`Naozaj chcete vymaza≈• skupinu "${group.data.name}" z kateg√≥rie "${group.data.categoryId}"? T√≠my priraden√© k tejto skupine pr√≠du o priradenie (groupId a orderInGroup sa nastavia na null)!`)) { // Updated warning
                                              return;
                                         }
                                         try {
                                              // Pred zmazan√≠m skupiny n√°jdi v≈°etky kluby, ktor√© na ≈àu odkazuj√∫ a aktualizuj ich
                                              const batch = writeBatch(db);

                                              const clubsInGroupQuery = query(clubsCollectionRef, where('groupId', '==', group.id));
                                              const clubsSnapshot = await getDocs(clubsInGroupQuery); // Use await here
                                              clubsSnapshot.forEach(doc => {
                                                   batch.update(doc.ref, { groupId: null, orderInGroup: null }); // Nastav groupId a orderInGroup na null
                                                   console.log(`Klub "${doc.id}" odpriraden√Ω zo skupiny "${group.id}".`);
                                              });

                                              // Nakoniec zma≈æ samotn√∫ skupinu
                                              batch.delete(doc(groupsCollectionRef, group.id));

                                              await batch.commit();

                                              console.log(`Skupina "${group.data.name}" (ID: ${group.id}) a s√∫visiace kluby boli √∫spe≈°ne zmazan√©/aktualizovan√©.`);

                                              // Refresh displays that might be affected
                                              displayGroupsByCategory(); // Reload display
                                              if (window.location.hash === '#timy-do-skupin') displayClubs();
                                              if (window.location.hash === '#zoznam-timov') displayCreatedTeams();


                                          } catch (error) {
                                              console.error('Chyba pri mazan√≠ skupiny a s√∫visiacich d√°t: ', error);
                                              alert('Chyba pri mazan√≠ skupiny! Pros√≠m, sk√∫ste znova.');
                                          }
                                     };

                                     groupActionsTd.appendChild(editGroupButton);
                                     groupActionsTd.appendChild(deleteGroupButton); // Corrected variable name

                                     groupRow.appendChild(groupNameTd);
                                     groupRow.appendChild(groupActionsTd);
                                     tbody.appendChild(groupRow);
                               });
                            }

                            categoryGroupsTable.appendChild(tbody);
                            categorySectionDiv.appendChild(categoryGroupsTable);
                            groupsContentDiv.appendChild(categorySectionDiv); // Append the section div to the main container
                         });


                      } catch (error) {
                          console.error('Chyba pri naƒç√≠tan√≠ alebo zobrazovan√≠ skup√≠n: ', error);
                          const errorMessage = document.createElement('p');
                          errorMessage.textContent = 'Chyba pri naƒç√≠tan√≠ d√°t skup√≠n.';
                          groupsContentDiv.appendChild(errorMessage);
                      }
             }


             // --- Funkcie pre Kluby (Priradenie do skup√≠n & Spr√°va priraden√Ωch) ---

             // Funkcia na naƒç√≠tanie nepriraden√Ωch t√≠mov a naplnenie selectu v mod√°li klubu
             async function populateUnassignedClubsSelect(selectElement, selectedClubId = null) {
                  selectElement.innerHTML = '<option value="">-- Vyberte t√≠m na priradenie --</option>';
                  selectElement.disabled = true; // Disable until clubs are loaded


                  try {
                      // Query clubs where groupId is null (unassigned teams)
                      const q = query(clubsCollectionRef, where('groupId', '==', null));
                      const querySnapshot = await getDocs(q);

                      if (querySnapshot.empty) {
                          console.log("≈Ωiadne nepriraden√© t√≠my na priradenie.");
                          const option = document.createElement('option');
                          option.value = "";
                          option.textContent = "-- ≈Ωiadne t√≠my na priradenie --";
                          option.disabled = true;
                          selectElement.appendChild(option);
                          selectElement.disabled = false; // Re-enable even if empty
                      } else {
                           selectElement.disabled = false; // Enable the select
                           // Sort unassigned teams alphabetically by name
                            const sortedDocs = querySnapshot.docs.sort((a, b) => (a.data().name || '').localeCompare(b.data().name || ''));

                            sortedDocs.forEach((doc) => {
                                 const clubData = doc.data();
                                 const clubId = doc.id; // Auto-generated ID

                                 const option = document.createElement('option');
                                 option.value = clubId; // Use the auto-generated ID as value
                                 option.textContent = clubData.name; // Display the club name
                                 selectElement.appendChild(option);
                            });

                            // Select the provided club ID if needed (e.g., if modal is reused for something like re-assigning)
                            if (selectedClubId) {
                                 if (selectElement.querySelector(`option[value="${selectedClubId}"]`)) {
                                      selectElement.value = selectedClubId;
                                 } else {
                                      console.warn(`Nepriraden√Ω t√≠m s ID "${selectedClubId}" nen√°jden√Ω.`);
                                      selectElement.value = ""; // Reset to default if selected club not found
                                  }
                            }
                         }
                     } catch (error) {
                         console.error('Chyba pri naƒç√≠tan√≠ nepriraden√Ωch t√≠mov pre select: ', error);
                         selectElement.innerHTML = '<option value="">Chyba pri naƒç√≠tan√≠ t√≠mov</option>'; // Indicate error
                         selectElement.disabled = true; // Keep disabled on error
                    }
                 }


             // Funkcia na otvorenie mod√°lu klubu (pre priradenie do skupiny ALEBO √∫pravu priraden√©ho/nepriraden√©ho)
             // clubId je auto-generovan√© ID dokumentu
             async function openClubModal(clubId = null, clubData = null) { // clubId is auto-generated ID
                  clubModal.style.display = 'block';

                  // Reset form fields including the new select and order input
                  clubForm.reset();
                  clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kateg√≥riu --</option>'; // Clear groups
                  clubGroupSelect.disabled = true;
                  clubCategorySelect.value = ""; // Reset category select
                  orderInGroupInput.value = ''; // Reset order input value


                  // Reset visibility of name input vs select and order input
                  unassignedClubSelectContainer.style.display = 'block'; // Default to showing select for add-assign
                  clubNameInputContainer.style.display = 'none';
                  orderInputContainer.style.display = 'none'; // Hide order input by default

                  // Reset group select visibility and disabled state
                  clubGroupSelect.parentElement.style.display = 'block'; // Default to showing group select
                  clubGroupSelect.disabled = true;

                  // *** Pridan√° logika pre atrib√∫t 'required' na clubNameInput a orderInGroupInput ***
                  clubNameInput.required = false; // Nastav defaultne na false
                  orderInGroupInput.required = false; // Order input is not required by default
                  // ***********************************************************


                  if (clubId && clubData) {
                     // Edit mode (Editing an ALREADY ASSIGNED club OR an UNASSIGNED club from Manage Modal)
                     currentClubModalMode = 'edit-assigned'; // St√°le pou≈æijeme 'edit-assigned' re≈æim
                     editingClubId = clubId; // Store the auto-generated ID of the club being edited
                      clubModalTitle.textContent = 'Upravi≈• t√≠m'; // Zmen√≠me nadpis, je to v≈°eobecnej≈°ie pre edit√°ciu
                     clubFormSubmitButton.textContent = 'Ulo≈æi≈• zmeny';

                     // Hide the unassigned clubs select, show the name input
                     unassignedClubSelectContainer.style.display = 'none';
                     clubNameInputContainer.style.display = 'block';
                     clubNameInput.readOnly = false; // Allow editing name

                     // *** V re≈æime √∫pravy nastav√≠me clubNameInput ako povinn√Ω ***
                     clubNameInput.required = true;
                     // ********************************************************

                     // Populate the category select and then set the value
                     await populateCategorySelect(clubCategorySelect, clubData.categoryId); // Pass select element first

                     // Check if the club is assigned or unassigned
                     if(clubData.groupId) { // If club has a groupId, it's assigned
                          // Show and populate the group select
                          clubGroupSelect.parentElement.style.display = 'block';
                          clubGroupSelect.disabled = false; // Enable group select for assigned teams
                          // Populate the group select based on the selected category and then set the group value
                          await populateGroupSelect(clubData.categoryId, clubGroupSelect, clubData.groupId);

                           // Show the order input and set its value
                           orderInputContainer.style.display = 'block';
                           // Set the order value if it exists, otherwise leave blank
                           orderInGroupInput.value = clubData.orderInGroup || '';
                           orderInGroupInput.required = true; // Make order required for assigned teams

                     } else { // If groupId is null, it's unassigned
                          // Hide and disable the group select
                          clubGroupSelect.parentElement.style.display = 'none';
                          clubGroupSelect.disabled = true;
                          clubGroupSelect.value = ''; // Clear any previous selection
                          // Note: In 'edit-assigned' mode for an UNASSIGNED club, the group select is hidden.
                          // This is correct behavior based on the current logic.

                           // Hide the order input for unassigned teams
                           orderInputContainer.style.display = 'none';
                           orderInGroupInput.value = ''; // Clear value
                           orderInGroupInput.required = false; // Not required for unassigned

                     }


                     // Fill the form fields
                     clubNameInput.value = clubData.name; // Use the 'name' field from data
                     // Category and Group selects are set by populate functions

                 } else {
                     // Add mode (Assigning an UNASSIGNED club to a group)
                     currentClubModalMode = 'add-assign';
                     editingClubId = null; // No specific club ID selected yet via edit button
                     clubModalTitle.textContent = 'Priradi≈• t√≠m do skupiny'; // Specific title
                     clubFormSubmitButton.textContent = 'Priradi≈•'; // Specific button text

                     // Show the unassigned clubs select, hide the name input
                     unassignedClubSelectContainer.style.display = 'block';
                     clubNameInputContainer.style.display = 'none';
                     clubNameInput.value = ''; // Clear the name input just in case

                      // *** V re≈æime priradenia clubNameInput NIE JE povinn√Ω ***
                      clubNameInput.required = false; // Toto sme u≈æ nastavili na zaƒçiatku, ale pre istotu

                      // Show and disable the group select initially
                      clubGroupSelect.parentElement.style.display = 'block';
                      clubGroupSelect.disabled = true; // Disable until category is chosen
                      clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kateg√≥riu --</option>'; // Reset group options

                       // Show the order input and make it required for assignment
                       orderInputContainer.style.display = 'block';
                       orderInGroupInput.value = ''; // Clear value
                       orderInGroupInput.required = true; // Required for assignment


                    // Populate the unassigned clubs select
                    await populateUnassignedClubsSelect(unassignedClubSelect, null); // Pass select element
                    // Populate the category select (no category pre-selected initially for assignment)
                    await populateCategorySelect(clubCategorySelect, null);
                }

                // Set focus based on mode with timeout and visibility check
                // Pou≈æijeme setTimeout na mal√© oneskorenie A skontrolujeme viditeƒænos≈• pred nastaven√≠m focusu
                if (currentClubModalMode === 'add-assign') {
                     setTimeout(() => {
                          // Skontrolujeme, ƒçi je kontajner v√Ωberov√©ho poƒæa viditeƒæn√Ω
                          if (unassignedClubSelectContainer.offsetParent !== null) {
                               // Kontrola, ƒçi je select povolen√Ω a nie je disabled
                               if (!unassignedClubSelect.disabled) {
                                   unassignedClubSelect.focus();
                               } else {
                                   console.warn("openClubModal: Nem√¥≈æem nastavi≈• focus na unassignedClubSelect, je disabled.");
                                   clubModalCloseBtn.focus(); // Fallback focus
                               }
                          } else {
                               console.warn("openClubModal: Nem√¥≈æem nastavi≈• focus na unassignedClubSelect, jeho kontajner nie je viditeƒæn√Ω.");
                               // N√∫dzov√© rie≈°enie: nastav√≠me focus na tlaƒçidlo zatvorenia mod√°lu
                               clubModalCloseBtn.focus();
                          }
                     }, 200); // Zv√§ƒç≈°en√© oneskorenie na 100ms
                } else { // edit-assigned
                     setTimeout(() => {
                          // Skontrolujeme, ƒçi je kontajner textov√©ho poƒæa viditeƒæn√Ω
                          if (clubNameInputContainer.offsetParent !== null) {
                              // Kontrola, ƒçi je input povolen√Ω a nie je disabled/readOnly
                               if (!clubNameInput.disabled && !clubNameInput.readOnly) {
                                   clubNameInput.focus();
                               } else {
                                   console.warn("openClubModal: Nem√¥≈æem nastavi≈• focus na clubNameInput, je disabled alebo readOnly.");
                                    clubModalCloseBtn.focus(); // Fallback focus
                               }
                           } else {
                               console.warn("openClubModal: Nem√¥≈æem nastavi≈• focus na clubNameInput, jeho kontajner nie je viditeƒæn√Ω.");
                                // N√∫dzov√© rie≈°enie: nastav√≠me focus na tlaƒçidlo zatvorenia mod√°lu
                               clubModalCloseBtn.focus();
                           }
                     }, 200); // Zv√§ƒç≈°en√© oneskorenie na 100ms
                }
           }

            // Funkcia na zobrazenie klubov usporiadan√Ωch podƒæa kateg√≥ri√≠ a skup√≠n (PRIRADEN√â t√≠my)
            // fetchuje kluby s groupId != null
            async function displayClubs() {
                clubsContentDiv.innerHTML = ''; // Vyƒçisti≈• kontajner

                try {
                    // Naƒç√≠ta≈• v≈°etky kluby, ktor√© S√ö priraden√© do skup√≠n (groupId != null)
                     const q = query(clubsCollectionRef, where('groupId', '!=', null));
                    const clubsSnapshot = await getDocs(q);

                    const clubs = clubsSnapshot.docs.map(clubDoc => ({ id: clubDoc.id, data: clubDoc.data() })); // Get club data with auto-generated ID

                    if (clubs.length === 0) {
                        console.log("≈Ωiadne kluby priraden√© do skup√≠n nen√°jden√©.");
                        const message = document.createElement('p');
                        message.textContent = "≈Ωiadne kluby zatiaƒæ neboli priraden√© do skup√≠n.";
                        clubsContentDiv.appendChild(message); // Spr√°vu prid√°me do kontajnera div
                        return;
                    }

                    // Zoskupenie klubov najprv podƒæa categoryId a potom podƒæa groupId
                    const clubsByCategoryAndGroup = {};
                    clubs.forEach(club => {
                        const categoryId = club.data.categoryId;
                        const groupId = club.data.groupId; // Toto je kompozitn√© ID skupiny (N√°zovKateg√≥rie - N√°zovSkupiny)

                        // Ensure categoryId and groupId exist for grouping
                         if (categoryId && groupId && categoryId !== 'null' && groupId !== 'null') { // Added check against 'null' strings
                             if (!clubsByCategoryAndGroup[categoryId]) {
                                 clubsByCategoryAndGroup[categoryId] = {};
                             }
                             if (!clubsByCategoryAndGroup[categoryId][groupId]) {
                                 clubsByCategoryAndGroup[categoryId][groupId] = [];
                             }
                              clubsByCategoryAndGroup[categoryId][groupId].push(club); // Ulo≈æ√≠me cel√Ω objekt { id: auto-generated, data }
                         } else {
                             console.warn(`Klub ${club.id} priraden√Ω do skupiny (groupId != null) nem√° platn√∫ categoryId (${categoryId}) alebo groupId (${groupId}).`);
                         }
                    });

                    // Z√≠skaj zotrieden√© n√°zvy kateg√≥ri√≠
                    const sortedCategories = Object.keys(clubsByCategoryAndGroup).sort();

                     if (sortedCategories.length === 0 && clubs.length > 0) {
                         // This case happens if clubs exist but none have valid categoryId/groupId for grouping
                          console.warn("Kluby boli n√°jden√©, ale ≈æiadne nemaj√∫ platn√© categoryId/groupId na zobrazenie v skupin√°ch.");
                          const message = document.createElement('p');
                          message.textContent = "Existuj√∫ kluby, ale ≈æiadne nemaj√∫ priraden√∫ kateg√≥riu a skupinu pre zobrazenie tu.";
                          clubsContentDiv.appendChild(message);
                          return;
                     }


                    // Iteruj cez kateg√≥rie a skupiny, aby si vytvoril/a sekcie a tabuƒæky
                    sortedCategories.forEach(categoryId => {
                        // Z√≠skaj zotrieden√© kompozitn√© ID skup√≠n v danej kateg√≥rii
                        const sortedGroups = Object.keys(clubsByCategoryAndGroup[categoryId]).sort();

                        sortedGroups.forEach(groupId => {
                            const clubsInThisGroup = clubsByCategoryAndGroup[categoryId][groupId];

                            // Vytvor section block pre t√∫to kombin√°ciu kateg√≥ria-skupina
                            const groupClubSectionDiv = document.createElement('div');
                            groupClubSectionDiv.classList.add('section-block');

                            // Vytvor nadpis pre t√∫to sekciu
                            const groupNameParts = groupId.split(' - ');
                            const groupName = groupNameParts.length > 1 ? groupNameParts.slice(1).join(' - ') : groupId;

                            const sectionHeading = document.createElement('h2');
                            sectionHeading.textContent = `${categoryId} - ${groupName}`;
                            groupClubSectionDiv.appendChild(sectionHeading);

                            // Vytvor tabuƒæku pre kluby v tejto skupine
                            const clubTable = document.createElement('table');
                       // M√¥≈æete pou≈æi≈• existuj√∫ce ≈°t√Ωly tabuliek alebo prida≈• nov√©
                      categoryTeamsTable.classList.add('group-clubs-table'); // Re-use class for basic styling


                            // Vytvor hlaviƒçku tabuƒæky - PRIDAN√ù STƒπPEC PORADIE
                            const thead = document.createElement('thead');
                            const headerRow = document.createElement('tr');
                            const orderTh = document.createElement('th'); // New header for order
                            orderTh.textContent = 'Poradie';
                            orderTh.style.width = '80px'; // Adjust width as needed
                            const clubNameTh = document.createElement('th');
                            clubNameTh.textContent = 'N√°zov klubu';
                             const actionsTh = document.createElement('th');
                             actionsTh.textContent = ''; // Changed header to Akcie
                             actionsTh.style.width = '150px'; // Ensure width for 2 buttons

                             headerRow.appendChild(orderTh); // Add order header
                             headerRow.appendChild(clubNameTh);
                             headerRow.appendChild(actionsTh);
                             thead.appendChild(headerRow);
                             clubTable.appendChild(thead);


                            // Vytvor telo tabuƒæky
                            const tbody = document.createElement('tbody');

                            if (clubsInThisGroup.length === 0) {
                                 const noClubsRow = document.createElement('tr');
                                 const td = document.createElement('td');
                                 td.colSpan = 3; // Adjusted colspan
                                 td.textContent = `≈Ωiadne kluby v tejto skupine.`;
                                 td.style.textAlign = 'center';
                                 tbody.appendChild(noClubsRow); // Corrected this line
                            } else {
                                 // Sort clubs WITHIN THIS GROUP by orderInGroup (numeric)
                                 // Fallback: if orderInGroup is missing, treat as larger than any number to sort last
                                 clubsInThisGroup.sort((a, b) => {
                                     const orderA = a.data.orderInGroup;
                                     const orderB = b.data.orderInGroup;

                                     // Convert to number, handle non-numeric or missing values
                                     const numA = typeof orderA === 'number' ? orderA : Infinity;
                                     const numB = typeof orderB === 'number' ? orderB : Infinity;

                                     if (numA !== numB) {
                                          return numA - numB; // Sort numerically
                                     } else {
                                          // If order is the same or both are non-numeric/missing, sort by name as a fallback
                                         return (a.data.name || '').localeCompare(b.data.name || '');
                                     }
                                 });


                                 // Pridaj riadky pre ka≈æd√Ω klub v tejto skupine
                                 clubsInThisGroup.forEach(club => {
                                     const tr = document.createElement('tr');

                                     const orderTd = document.createElement('td'); // New cell for order
                                      // Display order number, or '-' if not set
                                     orderTd.textContent = typeof club.data.orderInGroup === 'number' ? club.data.orderInGroup : '-';
                                     orderTd.style.textAlign = 'center';

                                     const nameTd = document.createElement('td');
                                     nameTd.textContent = club.data.name; // Zobraz n√°zov klubu z d√°t

                                     const actionsTd = document.createElement('td');
                                     actionsTd.style.whiteSpace = 'nowrap';

                                     // === TLAƒåIDLO √öPRAVA KLUBU (ZMENI≈§ SKUPINU/KATEG√ìRIU/N√ÅZOV) ===
                                     // Otvor√≠ clubModal v re≈æime √∫pravy priraden√©ho
                                      const editClubButton = document.createElement('button');
                                      editClubButton.textContent = 'Upravi≈•';
                                      editClubButton.classList.add('action-button');
                                      editClubButton.onclick = () => {
                                           // Open the club modal with the current club data for editing
                                          // Pass the auto-generated ID and data
                                           openClubModal(club.id, club.data);
                                       };


                                     // === TLAƒåIDLO ODPRIRADI≈§ KLUBU (ZMAZA≈§ PRIRADENIE) ===
                                     // ZMENEN√â SPR√ÅVANIE: NEMA≈ΩE DOKUMENT, IBA ODSTR√ÅNI PRIRADENIE K SKUPINE
                                       const unassignClubButton = document.createElement('button');
                                       unassignClubButton.textContent = 'Odpriradi≈•'; // Changed text
                                       unassignClubButton.classList.add('action-button', 'delete-button'); // Reusing delete-button style
                                       unassignClubButton.onclick = async () => {
                                           if (!confirm(`Naozaj chcete odpriradi≈• klub "${club.data.name}" zo skupiny "${groupName}" v kateg√≥rii "${categoryId}"? T√≠m sa vr√°ti medzi nepriraden√© t√≠my.`)) { // Updated confirmation
                                               return;
                                           }
                                           try {
                                                // Update the existing club document to remove group and order assignment
                                                await updateDoc(doc(clubsCollectionRef, club.id), {
                                                    groupId: null, // Set groupId to null
                                                    orderInGroup: null // Set orderInGroup to null
                                                });
                                                console.log(`Klub "${club.data.name}" (ID: ${club.id}) √∫spe≈°ne odpriraden√Ω.`); // Updated log message

                                                // Refresh displays that might be affected
                                                displayClubs(); // Refresh assigned clubs display (this team will disappear)
                                                // Refresh main 'Created Teams' display because an unassigned team was created (it will reappear there)
                                                if (window.location.hash === '#zoznam-timov') displayCreatedTeams();


                                           } catch (error) {
                                                console.error('Chyba pri odpriradzovan√≠ klubu: ', error); // Updated error message
                                                alert('Chyba pri odpriradzovan√≠ klubu! Pros√≠m, sk√∫ste znova.'); // Updated alert
                                           }
                                       };

                                        actionsTd.appendChild(editClubButton);
                                        actionsTd.appendChild(unassignClubButton); // Use the new unassign button

                                       tr.appendChild(orderTd); // Add order cell
                                       tr.appendChild(nameTd);
                                       tr.appendChild(actionsTd);

                                       tbody.appendChild(tr);
                                    });
                                 }

                                 clubTable.appendChild(tbody);
                                 groupClubSectionDiv.appendChild(clubTable);
                                 clubsContentDiv.appendChild(groupClubSectionDiv); // Pridaj sekciu do hlavn√©ho kontajnera klubov
                              });
                         });

                         console.log("Kluby priraden√© do skup√≠n boli naƒç√≠tan√© a zobrazen√©.");

                    } catch (error) {
                        console.error('Chyba pri naƒç√≠tan√≠ alebo zobrazovan√≠ klubov: ', error);
                        const errorMessage = document.createElement('p');
                        errorMessage.textContent = 'Chyba pri naƒç√≠tan√≠ d√°t klubov priraden√Ωch do skup√≠n.';
                        clubsContentDiv.appendChild(errorMessage);
                    }
             }

             // Funkcia na zobrazenie vytvoren√Ωch t√≠mov (klubov, ktor√© e≈°te nie s√∫ priraden√© do skupiny)
             async function displayCreatedTeams() {
                  createdTeamsTableBody.innerHTML = ''; // Clear existing rows
                  createdTeamsTableHeader.innerHTML = ''; // Clear existing header (except first and last columns)


                  try {
                      // 1. Naƒç√≠ta≈• v≈°etky kateg√≥rie pre dynamick√∫ hlaviƒçku
                      const categoriesSnapshot = await getDocs(categoriesCollectionRef);
                      const categories = categoriesSnapshot.docs.map(doc => doc.id).sort(); // Z√≠skaj a zotried n√°zvy kateg√≥ri√≠

                      // Vytvori≈• prv√Ω stƒ∫pec hlaviƒçky
                      const teamNameTh = document.createElement('th');
                      teamNameTh.textContent = 'N√°zov t√≠mu';
                      createdTeamsTableHeader.appendChild(teamNameTh);

                      // Vytvori≈• stƒ∫pce hlaviƒçky pre ka≈æd√∫ kateg√≥riu
                      categories.forEach(categoryName => {
                          const categoryTh = document.createElement('th');
                          categoryTh.textContent = categoryName;
                          categoryTh.style.textAlign = 'center'; // Zarovnanie pre poƒçty
                          createdTeamsTableHeader.appendChild(categoryTh);
                      });

                      // Vytvori≈• posledn√Ω stƒ∫pec hlaviƒçky
                      const actionsTh = document.createElement('th');
                      actionsTh.textContent = ''; // Changed header to Akcie
                      actionsTh.style.width = '150px';
                      createdTeamsTableHeader.appendChild(actionsTh);


                      // 2. Naƒç√≠ta≈• v≈°etky nepriraden√© t√≠my (groupId == null)
                      const q = query(clubsCollectionRef, where('groupId', '==', null));
                      const querySnapshot = await getDocs(q);

                      // 3. Zoskupi≈• t√≠my podƒæa z√°kladn√©ho n√°zvu a spoƒç√≠ta≈• pre kateg√≥rie
                      const teamsByBaseName = {};
                      querySnapshot.docs.forEach(doc => {
                          const clubData = doc.data();
                           // OPRAVEN√Å LOGIKA EXTRAKCIE Z√ÅKLADN√âHO N√ÅZVU PRE ZOSKUPENIE
                           // Pre nov√Ω form√°t ID "Kateg√≥ria - Z√°kladn√Ω N√°zov T√≠mu [Suffix]"
                          let baseTeamName = 'Nezn√°my n√°zov'; // Default
                           const idParts = doc.id.split(' - ');
                           if (idParts.length >= 2) {
                               const secondPart = idParts.slice(1).join(' - '); // Get the part after the first ' - ' (e.g., "HC Tatran Stupava A")
                                // Attempt to remove trailing space + single uppercase letter (like " A")
                               const suffixMatch = secondPart.match(/^(.*)\s[A-Z]$/);
                                baseTeamName = suffixMatch ? suffixMatch[1] : secondPart; // Use the part before suffix if found, otherwise use the whole second part
                           } else {
                                // Fallback pre star√© ID form√°ty alebo neoƒçak√°van√© ID: sk√∫s extrahova≈• suffix z n√°zvu t√≠mu
                               const fullTeamName = clubData.name || 'Nezn√°my n√°zov';
                               const nameSuffixMatch = fullTeamName.match(/^(.*)\s[A-Z]$/);
                                baseTeamName = nameSuffixMatch ? nameSuffixMatch[1] : fullTeamName;
                           }


                          const categoryId = clubData.categoryId || 'Nepriraden√°'; // Ak t√≠m nem√° kateg√≥riu


                          if (!teamsByBaseName[baseTeamName]) {
                              teamsByBaseName[baseTeamName] = {
                                  categories: {},
                                  originalTeams: [] // Ulo≈æ√≠me origin√°lne dokumenty pre akcie
                              };
                          }

                          if (!teamsByBaseName[baseTeamName].categories[categoryId]) {
                               teamsByBaseName[baseTeamName].categories[categoryId] = 0;
                          }
                          teamsByBaseName[baseTeamName].categories[categoryId]++;
                          teamsByBaseName[baseTeamName].originalTeams.push({ id: doc.id, data: clubData }); // Ulo≈æ√≠me info o p√¥vodnom t√≠me
                      });

                       console.log("Zoskupen√© t√≠my:", teamsByBaseName);


                      // 4. Vygenerova≈• riadky tabuƒæky na z√°klade zoskupen√Ωch d√°t
                      // POU≈ΩITIE localeCompare PRE ZORADENIE SO SLOVENSKOU DIAKRITIKOU
                      const sortedBaseNames = Object.keys(teamsByBaseName).sort((a, b) => a.localeCompare(b, 'sk-SK'));

                      if (sortedBaseNames.length === 0) {
                          const noDataRow = document.createElement('tr');
                          const td = document.createElement('td');
                          td.colSpan = 2 + categories.length; // N√°zov + Poƒçet kateg√≥ri√≠ + Akcie
                          td.textContent = "≈Ωiadne t√≠my na priradenie zatiaƒæ pridan√©.";
                          td.style.textAlign = 'center';
                          noDataRow.appendChild(td);
                          createdTeamsTableBody.appendChild(noDataRow);
                      } else {
                          sortedBaseNames.forEach(baseTeamName => {
                              const teamSummary = teamsByBaseName[baseTeamName];
                              const tr = document.createElement('tr');

                              // Bunka pre n√°zov t√≠mu
                              const nameTd = document.createElement('td');
                              nameTd.textContent = baseTeamName; // Zobraz z√°kladn√Ω n√°zov
                              tr.appendChild(nameTd);

                              // Bunky pre poƒçty t√≠mov v kateg√≥ri√°ch
                              categories.forEach(categoryName => {
                                  const countTd = document.createElement('td');
                                  // Zobraz poƒçet t√≠mov pre t√∫to kateg√≥riu a tento z√°kladn√Ω n√°zov
                                  const count = teamSummary.categories[categoryName] || 0;
                                  countTd.textContent = count > 0 ? count : '-'; // Zobraz '-' ak je poƒçet 0
                                  countTd.style.textAlign = 'center'; // Zarovnanie pre poƒçty
                                  tr.appendChild(countTd);
                              });

                              // Bunka pre akcie
                              const actionsTd = document.createElement('td');
                              actionsTd.style.whiteSpace = 'nowrap';

                              // === Akcie (Spravova≈• t√≠my / Vymaza≈• V≈†ETKY) ===
                               const manageTeamsButton = document.createElement('button');
                               manageTeamsButton.textContent = 'Spravova≈• t√≠my';
                               manageTeamsButton.classList.add('action-button');
                               manageTeamsButton.onclick = () => {
                                   // Otvori≈• nov√Ω mod√°l a zobrazi≈• v ≈àom individu√°lne t√≠my
                                   openManageTeamsModal(baseTeamName, teamSummary.originalTeams);
                               };
                               actionsTd.appendChild(manageTeamsButton);


                               // Tlaƒçidlo na hromadn√© vymazanie v≈°etk√Ωch t√≠mov s t√Ωmto z√°kladn√Ωm n√°zvom
                               const deleteAllButton = document.createElement('button');
                               deleteAllButton.textContent = 'Vymaza≈•';
                               deleteAllButton.classList.add('action-button', 'delete-button');
                               deleteAllButton.onclick = async () => {
                                   if (!confirm(`Naozaj chcete vymaza≈• V≈†ETKY t√≠my s n√°zvom "${baseTeamName}" (${teamSummary.originalTeams.length} ks)?`)) {
                                       return;
                                   }
                                   try {
                                        const batch = writeBatch(db);
                                        // Pre ka≈æd√Ω origin√°lny t√≠m dokument pod t√Ωmto z√°kladn√Ωm n√°zvom, pridaj oper√°ciu mazania do batchu
                                        teamSummary.originalTeams.forEach(team => {
                                            batch.delete(doc(clubsCollectionRef, team.id)); // Pou≈æi auto-generovan√© ID
                                        });

                                       await batch.commit();
                                       console.log(`V≈°etky t√≠my s n√°zvom "${baseTeamName}" (${teamSummary.originalTeams.length} ks) boli √∫spe≈°ne zmazan√©.`);
                                       displayCreatedTeams(); // Refresh the list
                                        // Refresh clubs-in-groups display if visible (shouldn't affect it directly as these are unassigned)
                                       // if (window.location.hash === '#timy-do-skupin') { displayClubs(); }

                                        // Po zmazan√≠ t√≠mov m√¥≈æe by≈• potrebn√© aktualizova≈• aj ponuky kateg√≥ri√≠
                                        if (teamCreationModal.style.display === 'block') {
                                             loadAllCategoriesForDynamicSelects(); // Naƒç√≠taj znovu kateg√≥rie, ƒço zavol√° aj updateDynamicSelects a checkIfAddCategoryButtonShouldBeVisible
                                        }


                                   } catch (error) {
                                       console.error(`Chyba pri mazan√≠ t√≠mov s n√°zvom "${baseTeamName}": `, error);
                                       alert('Chyba pri mazan√≠ t√≠mov!');
                                   }
                                };
                                actionsTd.appendChild(deleteAllButton);


                              tr.appendChild(actionsTd);
                              createdTeamsTableBody.appendChild(tr);
                          });
                      }

                      console.log(`Naƒç√≠tan√Ωch z√°kladn√Ωch n√°zvov t√≠mov (na priradenie do skup√≠n): ${sortedBaseNames.length}`);

                  } catch (error) {
                      console.error('Chyba pri naƒç√≠tan√≠ alebo zobrazovan√≠ vytvoren√Ωch t√≠mov: ', error);
                      const errorMessage = document.createElement('tr'); // Use tr to fit in table body
                      const td = document.createElement('td');
                      // V√Ωpoƒçet colspan: 1 (N√°zov t√≠mu) + poƒçet kateg√≥ri√≠ + 1 (Akcie)
                      td.colSpan = 2 + categories.length;
                      td.textContent = 'Chyba pri naƒç√≠tan√≠ d√°t t√≠mov.';
                      td.style.textAlign = 'center';
                      errorMessage.appendChild(td);
                      createdTeamsTableBody.appendChild(errorMessage);
                  }
             }

             // Funkcia na zatvorenie mod√°lu pre spr√°vu individu√°lnych t√≠mov
              function closeManageTeamsModal() {
                  manageTeamsModal.style.display = 'none';
                  teamsListInModalDiv.innerHTML = ''; // Vyƒçisti≈• obsah pri zatvoren√≠
              }

             // Funkcia na otvorenie mod√°lu a zobrazenie individu√°lnych t√≠mov
             // baseTeamName: z√°kladn√Ω n√°zov t√≠mu (string)
             // individualTeams: pole objektov { id: teamId, data: teamData } pre t√≠my s t√Ωmto n√°zvom
             async function openManageTeamsModal(baseTeamName, individualTeams) {
                  manageTeamsModal.style.display = 'block';
                  baseTeamNameInModalSpan.textContent = baseTeamName; // Nastav z√°kladn√Ω n√°zov v nadpise mod√°lu
                  teamsListInModalDiv.innerHTML = ''; // Vyƒçisti≈• pred naplnen√≠m

                  if (!individualTeams || individualTeams.length === 0) {
                      teamsListInModalDiv.innerHTML = '<p>≈Ωiadne individu√°lne t√≠my n√°jden√© pre tento n√°zov.</p>';
                      return;
                  }

                  // Zoskupi≈• individu√°lne t√≠my podƒæa kateg√≥rie pre zobrazenie
                  const teamsByCategory = {};
                  individualTeams.forEach(team => {
                      const category = team.data.categoryId || 'Nepriraden√°';
                      if (!teamsByCategory[category]) {
                          teamsByCategory[category] = [];
                      }
                      teamsByCategory[category].push(team);
                  });

                  // Z√≠skaj zotrieden√© n√°zvy kateg√≥ri√≠
                  const sortedCategories = Object.keys(teamsByCategory).sort();

                  // Pre ka≈æd√∫ kateg√≥riu vytvori≈• men≈°iu tabuƒæku alebo zoznam v mod√°li
                  sortedCategories.forEach(categoryName => {
                      const teamsInThisCategory = teamsByCategory[categoryName];

                      const categoryHeading = document.createElement('h3');
                      categoryHeading.textContent = `${categoryName}`;
                      teamsListInModalDiv.appendChild(categoryHeading);

                      // Vytvori≈• men≈°iu tabuƒæku pre t√≠my v tejto kateg√≥rii
                      const categoryTeamsTable = document.createElement('table');
                       // M√¥≈æete pou≈æi≈• existuj√∫ce ≈°t√Ωly tabuliek alebo prida≈• nov√©
                      categoryTeamsTable.classList.add('group-clubs-table'); // Re-use class for basic styling


                      const thead = document.createElement('thead');
                      const headerRow = document.createElement('tr');
                      const teamNameTh = document.createElement('th');
                      teamNameTh.textContent = 'N√°zov t√≠mu (cel√Ω)'; // Indicate it's the full name
                       const actionsTh = document.createElement('th');
                       actionsTh.textContent = ''; // Changed header to Akcie
                       actionsTh.style.width = '150px'; // Ensure width for buttons

                       headerRow.appendChild(teamNameTh);
                       headerRow.appendChild(actionsTh);
                       thead.appendChild(headerRow);
                       categoryTeamsTable.appendChild(thead);


                      const tbody = document.createElement('tbody');

                      // Zotriedi≈• t√≠my v kateg√≥rii podƒæa n√°zvu
                      teamsInThisCategory.sort((a, b) => (a.data.name || '').localeCompare(b.data.name || ''));


                      teamsInThisCategory.forEach(team => {
                          const tr = document.createElement('tr');

                          const nameTd = document.createElement('td');
                          nameTd.textContent = team.data.name || 'Nezn√°my n√°zov';
                          tr.appendChild(nameTd);

                          const actionsTd = document.createElement('td');
                          actionsTd.style.whiteSpace = 'nowrap';


                          // === TLAƒåIDLO √öPRAVA INDIVIDU√ÅLNEHO T√çMU ===
                           // Toto by malo otvori≈• existuj√∫ci clubModal, ale v ≈°pecifickom re≈æime
                           // pre √∫pravu NEPRIRADEN√âHO t√≠mu (zmeni≈• n√°zov, pr√≠padne kateg√≥riu)
                          const editIndividualTeamButton = document.createElement('button');
                          editIndividualTeamButton.textContent = 'Upravi≈•';
                          editIndividualTeamButton.classList.add('action-button');
                          editIndividualTeamButton.onclick = () => {
                              // Pred otvoren√≠m clubModal mus√≠me nastavi≈• jeho stav a d√°ta
                              // clubModal je prim√°rne na priradzovanie do skup√≠n/√∫pravu priraden√Ωch.
                              // Potrebujeme re≈æim √∫pravy nepriraden√©ho t√≠mu.
                              // Mus√≠me si by≈• ist√≠, ≈æe clubModal formul√°r a logika to zvl√°dne.
                              console.log("Pokus o √∫pravu individu√°lneho t√≠mu:", team);

                              // Zatvori≈• manageTeamsModal pred otvoren√≠m clubModal
                              closeManageTeamsModal();

                              // Otvor√≠me existuj√∫ci clubModal s d√°tami tohto t√≠mu
                              // Potrebujeme ho otvori≈• v re≈æime, kde sa ned√° vybra≈• skupina, len zmeni≈• n√°zov/kateg√≥ria.
                              // Pou≈æijeme re≈æim 'edit-assigned', ale prisp√¥sob√≠me ho v openClubModal
                              openClubModal(team.id, team.data); // Zavol√°me openClubModal s ID a d√°tami

                          };
                          actionsTd.appendChild(editIndividualTeamButton);


                          // === TLAƒåIDLO VYMAZA≈§ INDIVIDU√ÅLNY T√çM ===
                          // Tento button v tomto modali ZMA≈ΩE dokument √∫plne
                          const deleteIndividualTeamButton = document.createElement('button');
                          deleteIndividualTeamButton.textContent = 'Vymaza≈•';
                          deleteIndividualTeamButton.classList.add('action-button', 'delete-button');
                          deleteIndividualTeamButton.onclick = async () => {
                              if (!confirm(`Naozaj chcete vymaza≈• t√≠m "${team.data.name}" z kateg√≥rie "${categoryName}"? T√°to akcia vyma≈æe t√≠m √∫plne.`)) { // Clarified confirmation
                                  return;
                              }
                              try {
                                  // Na zmazanie pou≈æi auto-generovan√© ID tohto konkr√©tneho t√≠mu
                                  await deleteDoc(doc(clubsCollectionRef, team.id));
                                  console.log(`Individu√°lny t√≠m "${team.data.name}" (ID: ${team.id}) √∫spe≈°ne zmazan√Ω.`);

                                  // Po zmazan√≠ refreshn√∫≈• ZOBRAZENIE v manageTeamsModal
                                  // a tie≈æ zobrazenie v hlavnej sekcii #zoznam-timov
                                   // A simpler approach: close the modal and force refresh of the main #zoznam-timov list
                                   closeManageTeamsModal(); // Zatvor mod√°l

                                  // Refresh the main 'Created Teams' section display
                                   if (window.location.hash === '#zoznam-timov') {
                                        displayCreatedTeams();
                                         // Aj po zmazan√≠ individu√°lneho t√≠mu je mo≈æn√©, ≈æe sa uvoƒænila kateg√≥ria
                                         // pre ostatn√© dynamick√© selecty
                                         if (teamCreationModal.style.display === 'block') {
                                            loadAllCategoriesForDynamicSelects(); // Naƒç√≠taj znovu kateg√≥rie, ƒço zavol√° aj updateDynamicSelects a checkIfAddCategoryButtonShouldBeVisible
                                         }
                                   }
                                    // Refresh clubs-in-groups display if visible (shouldn't affect it directly as these are unassigned)
                                   // if (window.location.hash === '#timy-do-skupin') { displayClubs(); }


                              } catch (error) {
                                  console.error(`Chyba pri mazan√≠ individu√°lneho t√≠mu "${team.data.name}" (ID: ${team.id}): `, error);
                                  alert('Chyba pri mazan√≠ t√≠mu!');
                              }
                          };
                          actionsTd.appendChild(deleteIndividualTeamButton);

                          tr.appendChild(actionsTd); // Add actions cell

                          tbody.appendChild(tr);
                      });

                      categoryTeamsTable.appendChild(tbody);
                      teamsListInModalDiv.appendChild(categoryTeamsTable);
                  });

                  // M√¥≈æete nastavi≈• focus na prv√© tlaƒçidlo alebo prv√Ω input v mod√°li, ak je to potrebn√©
                  // manageTeamsModalCloseBtn.focus();
             }

             // --- Funkcia na naƒç√≠tanie v≈°etk√Ωch kateg√≥ri√≠ pre dynamick√© selecty v mod√°li Vytvorenie T√≠mov ---
             async function loadAllCategoriesForDynamicSelects() {
                 try {
                     const querySnapshot = await getDocs(categoriesCollectionRef);
                     allAvailableCategories = querySnapshot.docs.map(doc => doc.id).sort((a, b) => a.localeCompare(b, 'sk-SK')); // Sort alphabetically
                     console.log("Naƒç√≠tan√© kateg√≥rie pre dynamick√© selecty:", allAvailableCategories);
                     // Po naƒç√≠tan√≠, ak je mod√°l otvoren√Ω, aktualizova≈• selecty
                      if (teamCreationModal.style.display === 'block') {
                           updateDynamicCategorySelects();
                           checkIfAddCategoryButtonShouldBeVisible(); // Aj po naƒç√≠tan√≠ kateg√≥ri√≠ treba skontrolova≈• viditeƒænos≈• tlaƒçidla
                      }
                 } catch (error) {
                     console.error('Chyba pri naƒç√≠tan√≠ kateg√≥ri√≠ pre dynamick√© selecty: ', error);
                     allAvailableCategories = []; // Vyƒçisti≈• na chybu
                      // Ak nastala chyba pri naƒç√≠tan√≠, skry≈• tlaƒçidlo na pridanie kateg√≥rie
                      checkIfAddCategoryButtonShouldBeVisible(); // Kontrola viditeƒænosti tlaƒçidla
                 }
            }

            // Pomocn√° funkcia na naplnenie jedn√©ho dynamick√©ho selectu kateg√≥ri√≠
            // s vyl√∫ƒçen√≠m kateg√≥ri√≠, ktor√© s√∫ u≈æ vybrat√© v in√Ωch selectoch
            function populateDynamicCategorySelect(selectElement, currentSelectedId, allCategories, categoriesToExclude) {
                 selectElement.innerHTML = '<option value="">-- Vyberte kateg√≥riu --</option>'; // Reset
                 selectElement.disabled = allCategories.length === 0; // Disable if no categories

                 // Pridaj mo≈ænos≈• pre aktu√°lne vybran√∫ kateg√≥riu, ak existuje a nie je null/pr√°zdna
                 if (currentSelectedId && allCategories.includes(currentSelectedId)) {
                      const currentOption = document.createElement('option');
                      currentOption.value = currentSelectedId;
                      currentOption.textContent = currentSelectedId;
                      currentOption.selected = true;
                      selectElement.appendChild(currentOption);
                 }


                 allCategories.forEach(categoryName => {
                     // Pridaj kateg√≥riu ako mo≈ænos≈•, ak to nie je aktu√°lne vybran√° kateg√≥ria
                     // A ak nie je v zozname kateg√≥ri√≠ na vyl√∫ƒçenie
                     if (categoryName !== currentSelectedId && !categoriesToExclude.includes(categoryName)) {
                         const option = document.createElement('option');
                         option.value = categoryName;
                         option.textContent = categoryName;
                         selectElement.appendChild(option);
                     }
                 });

                 // Ak po pridan√≠ mo≈ænost√≠ nie je ≈æiadna vybran√° (napr. currentSelectedId u≈æ neexistuje),
                 // zabezpeƒç√≠me, ≈æe select m√° defaultn√∫ hodnotu
                  if (!selectElement.value) {
                      selectElement.value = ""; // Nastav√≠ na pr√°zdnu mo≈ænos≈•/placeholder
                  }
            }

            // Funkcia na aktualiz√°ciu v≈°etk√Ωch dynamick√Ωch selectov kateg√≥ri√≠ v mod√°li Vytvorenie T√≠mov
            function updateDynamicCategorySelects() {
                 const allSelectElements = teamCategoryCountContainer.querySelectorAll('.team-category-select-dynamic');
                 // Z√≠skaj aktu√°lne vybrat√© kateg√≥rie zo V≈†ETK√ùCH selectov
                 const currentSelections = Array.from(allSelectElements)
                     .map(select => select.value)
                     .filter(value => value !== ''); // Ignoruj pr√°zdne hodnoty


                 console.log("Aktu√°lne vybrat√© kateg√≥rie pre vyl√∫ƒçenie:", currentSelections);


                 allSelectElements.forEach(selectElement => {
                     const currentSelectedIdInThisSelect = selectElement.value; // Kateg√≥ria vybrat√° v tomto konkr√©tnom selecte

                      // V≈°etky vybrat√© kateg√≥rie od ostatn√Ωch selectov (okrem tej, ƒço je v tomto selecte)
                     const categoriesToExcludeForThisSelect = currentSelections.filter(cat => cat !== currentSelectedIdInThisSelect);

                      // Znovu napl≈à tento select s vyl√∫ƒçen√≠m potrebn√Ωch kateg√≥ri√≠
                     populateDynamicCategorySelect(
                         selectElement,
                         currentSelectedIdInThisSelect, // Aktu√°lne vybran√° ID
                         allAvailableCategories,      // Zoznam v≈°etk√Ωch kateg√≥ri√≠
                         categoriesToExcludeForThisSelect // Kateg√≥rie na vyl√∫ƒçenie
                     );
                 });

                 // Po aktualiz√°cii selectov skontroluj, ƒçi zobrazi≈•/skry≈• tlaƒçidlo Prida≈• ƒèal≈°iu kateg√≥riu
                 checkIfAddCategoryButtonShouldBeVisible();
            }


             // --- Funkcia na mana≈æovanie viditeƒænosti tlaƒçidiel "Odstr√°ni≈•" ---
             function updateRemoveButtonVisibility() {
                  const allRemoveButtons = teamCategoryCountContainer.querySelectorAll('.category-count-pair .delete-button');
                  if (allRemoveButtons.length > 0) {
                       // Skry≈• tlaƒçidlo na prvom riadku, zobrazi≈• na ostatn√Ωch
                       allRemoveButtons.forEach((button, index) => {
                            if (index === 0) {
                                 button.style.display = 'none';
                            } else {
                                 button.style.display = 'inline-block'; // Alebo 'block' podƒæa ≈æelan√©ho rozlo≈æenia
                            }
                       });
                  }
             }


             // --- Funkcia na kontrolu, ƒçi m√° by≈• viditeƒæn√© tlaƒçidlo "Prida≈• ƒèal≈°iu kateg√≥riu" ---
             function checkIfAddCategoryButtonShouldBeVisible() {
                  const allSelectElements = teamCategoryCountContainer.querySelectorAll('.team-category-select-dynamic');
                  const currentSelections = Array.from(allSelectElements)
                      .map(select => select.value)
                      .filter(value => value !== ''); // Z√≠skaj nepr√°zdne zvolen√© hodnoty

                  // Ak je poƒçet zvolen√Ωch kateg√≥ri√≠ rovn√Ω celkov√©mu poƒçtu dostupn√Ωch kateg√≥ri√≠,
                  // skry≈• tlaƒçidlo 'Prida≈• ƒèal≈°iu kateg√≥riu'. Inak ho zobrazi≈•.
                  // Tie≈æ skontroluj, ƒçi allAvailableCategories nie je pr√°zdne (napr. chyba naƒç√≠tania)
                  if (allAvailableCategories.length > 0 && currentSelections.length >= allAvailableCategories.length) {
                       addCategoryCountPairButton.style.display = 'none';
                       console.log("V≈°etky kateg√≥rie s√∫ u≈æ vybrat√©, tlaƒçidlo 'Prida≈• ƒèal≈°iu kateg√≥riu' skryt√©.");
                  } else if (allAvailableCategories.length === 0) {
                       // Ak nie s√∫ ≈æiadne dostupn√© kateg√≥rie, tie≈æ skry≈• tlaƒçidlo
                       addCategoryCountPairButton.style.display = 'none';
                       console.log("≈Ωiadne dostupn√© kateg√≥rie, tlaƒçidlo 'Prida≈• ƒèal≈°iu kateg√≥riu' skryt√©.");
                  }
                   else {
                       addCategoryCountPairButton.style.display = 'inline-block'; // Alebo 'block'
                       console.log(`Vybrat√Ωch kateg√≥ri√≠: ${currentSelections.length}, celkovo dostupn√Ωch: ${allAvailableCategories.length}. Tlaƒçidlo 'Prida≈• ƒèal≈°iu kateg√≥riu' zobrazen√©.`);
                   }
             }


             // --- Funkcia na dynamick√© pridanie dvojice select kateg√≥ria + input poƒçet t√≠mov ---
             async function addCategoryCountPair(initialCategory = null) { // Optional: pre-select category if provided
                 const container = document.getElementById('teamCategoryCountContainer');

                 const pairDiv = document.createElement('div');
                 pairDiv.classList.add('category-count-pair'); // Optional class for styling


                 // Vytvorenie selectboxu pre kateg√≥riu
                 const categorySelectLabel = document.createElement('label');
                 categorySelectLabel.textContent = 'Kateg√≥ria:';
                 const categorySelect = document.createElement('select');
                 categorySelect.classList.add('team-category-select-dynamic');
                 categorySelect.name = 'category';
                 categorySelect.required = true;

                 // Prida≈• event listener na zmenu, ktor√Ω spust√≠ aktualiz√°ciu ostatn√Ωch selectov
                 categorySelect.addEventListener('change', updateDynamicCategorySelects);


                 // Vytvorenie inputu pre poƒçet t√≠mov
                 const teamCountLabel = document.createElement('label');
                 teamCountLabel.textContent = 'Poƒçet t√≠mov:';
                 const teamCountInput = document.createElement('input');
                 teamCountInput.classList.add('team-count-input-dynamic');
                 teamCountInput.type = 'number';
                 teamCountInput.name = 'count';
                 teamCountInput.min = '1';
                 teamCountInput.value = '1'; // Default value
                 teamCountInput.required = true;


                 // Tlaƒçidlo na odstr√°nenie tejto dvojice
                 const removeButton = document.createElement('button');
                 removeButton.textContent = 'Odstr√°ni≈•';
                 removeButton.classList.add('action-button', 'delete-button');
                 removeButton.type = 'button'; // D√¥le≈æit√©: aby sa nespustil submit formul√°ra
                 removeButton.style.marginLeft = '10px'; // Add some spacing


                  removeButton.onclick = () => {
                      pairDiv.remove();
                      updateDynamicCategorySelects(); // Aktualizuje selecty (vol√° checkIfAddCategoryButtonShouldBeVisible)
                      updateRemoveButtonVisibility(); // Aktualizuje viditeƒænos≈• tlaƒçidiel Odstr√°ni≈•
                  };


                 // Posklada≈• elementy do divu
                 const selectContainer = document.createElement('div');
                 selectContainer.style.marginBottom = '10px'; // Spacing between select/input pairs
                 selectContainer.appendChild(categorySelectLabel);
                 selectContainer.appendChild(categorySelect);

                  const inputContainer = document.createElement('div');
                  inputContainer.style.marginBottom = '10px'; // Spacing below input
                 inputContainer.appendChild(teamCountLabel);
                 inputContainer.appendChild(teamCountInput);


                  pairDiv.appendChild(selectContainer);
                  pairDiv.appendChild(inputContainer);
                  pairDiv.appendChild(removeButton); // Prid√°me tlaƒçidlo, jeho viditeƒænos≈• sa nastav√≠ nesk√¥r

                 container.appendChild(pairDiv);

                 // Napl≈à nov√Ω select s ohƒæadom na u≈æ vybrat√© kateg√≥rie v ostatn√Ωch selectoch
                 // Z√≠skaj aktu√°lne vybrat√© kateg√≥rie zo V≈†ETK√ùCH EXISTUJ√öCICH selectov pred pridan√≠m nov√©ho
                 const allSelectElementsBeforeAdding = container.querySelectorAll('.team-category-select-dynamic');
                 const categoriesSelectedInOthers = Array.from(allSelectElementsBeforeAdding)
                     .map(select => select.value)
                     .filter(value => value !== '' && value !== initialCategory); // Ignoruj pr√°zdne a poƒçiatoƒçn√∫ kateg√≥riu tohto selectu


                 populateDynamicCategorySelect(
                    categorySelect,
                    initialCategory, // Poƒçiatoƒçne zvolen√° kateg√≥ria (ak je)
                    allAvailableCategories, // Zoznam v≈°etk√Ωch kateg√≥ri√≠
                    categoriesSelectedInOthers // Kateg√≥rie vybrat√© v in√Ωch selectoch
                 );

                  // Po pridan√≠ novej dvojice a jej naplnen√≠ aktualizova≈• v≈°etky ostatn√© selecty a tlaƒçidl√°
                  // updateDynamicCategorySelects(); // T√°to funkcia vol√° aj checkIfAddCategoryButtonShouldBeVisible()
                  updateRemoveButtonVisibility(); // Aktualizuje viditeƒænos≈• tlaƒçidiel Odstr√°ni≈•
                  // updateDynamicCategorySelects() je volan√© event listenerom change na categorySelect alebo v openTeamCreationModal
                  // Ak prid√°vame prv√Ω riadok, updateDynamicCategorySelects sa zavol√° v openTeamCreationModal
                  // Ak prid√°vame ƒèal≈°ie riadky, updateDynamicCategorySelects sa zavol√° pri zmene v√Ωberu v novom selecte
                  // alebo by sa malo zavola≈• explicitne, aby sa ostatn√© selecty hneƒè aktualizovali.
                   // Zvol√≠me explicitn√© volanie tu, aby sa ostatn√© selecty aktualizovali ihneƒè po pridan√≠ nov√©ho riadku.
                   updateDynamicCategorySelects(); // Explicitne volanie
            }


            // Funkcia na otvorenie mod√°lu Vytvorenie T√≠mov
            async function openTeamCreationModal() {
                 teamCreationModal.style.display = 'block';

                 // Resetuj stav mod√°lu a formul√°r
                 currentTeamCreationModalMode = 'add'; // Zatiaƒæ len 'add'
                 teamCreationModalTitle.textContent = 'Vytvori≈• t√≠my';
                 teamCreationForm.reset();

                 // Vyƒçisti kontajner dynamick√Ωch pol√≠ a pridaj prv√∫ dvojicu
                 teamCategoryCountContainer.innerHTML = '';
                 // Zabezpeƒç, ≈æe v≈°etky kateg√≥rie s√∫ naƒç√≠tan√© pred pridan√≠m prvej dvojice
                 if (allAvailableCategories.length === 0) {
                      await loadAllCategoriesForDynamicSelects(); // Naƒç√≠taj kateg√≥rie ak e≈°te nie s√∫ (vol√° updateDynamicSelects a checkIfAddCategoryButtonShouldBeVisible)
                 } else {
                       // Ak u≈æ s√∫ kateg√≥rie naƒç√≠tan√©, len aktualizuj selecty a tlaƒçidl√°
                       updateDynamicCategorySelects(); // Vol√° checkIfAddCategoryButtonShouldBeVisible
                       updateRemoveButtonVisibility(); // Vol√° sa po pridan√≠ prvej dvojice
                   }

                 // V≈ædy pridaj prv√∫ dvojicu pri otvoren√≠ mod√°lu
                 await addCategoryCountPair(); // T√°to funkcia vol√° updateDynamicSelects a updateRemoveButtonVisibility na konci

                 teamNameInput.focus(); // Nastav focus na n√°zov t√≠mu
            }


            // --- Funkcia na prep√≠nanie zobrazenia obsahu ---

            function toggleContentDisplay() {
                 const hash = window.location.hash;
                 console.log("Navigating to hash:", hash);

                 // Skry≈• v≈°etky dynamick√© oblasti a mod√°ly
                 addButton.style.display = 'none';
                 categoriesContentSection.style.display = 'none';
                 groupsContentDiv.style.display = 'none';
                 clubsContentDiv.style.display = 'none';
                 teamCreationContentSection.style.display = 'none';

                 categoryModal.style.display = 'none';
                 groupModal.style.display = 'none';
                 clubModal.style.display = 'none';
                 teamCreationModal.style.display = 'none';
                 manageTeamsModal.style.display = 'none'; // Skry≈• aj nov√Ω mod√°l


                 // Vyƒçisti≈• obsah dynamick√Ωch oblast√≠
                 categoryTableBody.innerHTML = '';
                 groupsContentDiv.innerHTML = '';
                 clubsContentDiv.innerHTML = '';
                 createdTeamsTableBody.innerHTML = '';
                 createdTeamsTableHeader.innerHTML = ''; // Clear header for dynamic generation
                 teamsListInModalDiv.innerHTML = ''; // Clear manage teams modal content
                 //teamCategoryCountContainer.innerHTML = ''; // NEƒåISTI≈§ pri prep√≠nan√≠, aby sa zachoval stav mod√°lu
                                                          // Ak by sa mod√°l pri prepnut√≠ ha≈°u zatv√°ral (ƒço sa deje),
                                                          // potom by sa vyƒçistilo pri zatvoren√≠ mod√°lu.


                 // Reset modal states and forms when navigating away
                  currentCategoryModalMode = 'add'; editingCategoryName = null;
                  categoryForm.reset();

                  currentGroupModalMode = 'add'; editingGroupId = null;
                  groupForm.reset();

                  // Reset club modal state (add/edit assigned)
                  currentClubModalMode = 'add-assign'; editingClubId = null; // Reset to add-assign mode
                  clubForm.reset();
                  // Ensure the correct input/select is shown/hidden when modal opens next time
                  unassignedClubSelectContainer.style.display = 'block';
                  clubNameInputContainer.style.display = 'none';
                  // Reset group select visibility for club modal
                  clubGroupSelect.parentElement.style.display = 'block';
                   // Reset order input visibility for club modal
                  orderInputContainer.style.display = 'none';
                  orderInGroupInput.required = false;


                  // Reset team creation modal state and clear dynamic fields
                  currentTeamCreationModalMode = 'add';
                  teamCreationForm.reset();
                   // Vyƒçisti≈• dynamick√© polia len pri zmene sekcie/zatvoren√≠ mod√°lu
                  teamCategoryCountContainer.innerHTML = '';
                   // Reset allAvailableCategories when leaving the section
                  allAvailableCategories = [];
                   // Skry≈• tlaƒçidlo Prida≈• ƒèal≈°iu kateg√≥riu pri odchode zo sekcie
                  addCategoryCountPairButton.style.display = 'none';


                 if (hash === '#kategorie') {
                     addButton.style.display = 'block';
                     categoriesContentSection.style.display = 'block';
                     loadCategoriesTable();
                     addButton.title = "Prida≈• kateg√≥riu";
                 } else if (hash === '#skupiny') {
                     addButton.style.display = 'block';
                     groupsContentDiv.style.display = 'flex';
                     groupsContentDiv.innerHTML = '';
                     displayGroupsByCategory();
                     addButton.title = "Prida≈• skupinu";
                 } else if (hash === '#zoznam-timov') {
                     addButton.style.display = 'block';
                     teamCreationContentSection.style.display = 'block';
                     displayCreatedTeams();
                     addButton.title = "Vytvori≈• t√≠my";
                     // Naƒç√≠taj kateg√≥rie pri vstupe do sekcie "Vytvorenie t√≠mov"
                     loadAllCategoriesForDynamicSelects(); // Vol√° updateDynamicSelects a checkIfAddCategoryButtonShouldBeVisible
                 }
                 else if (hash === '#timy-do-skupin') {
                     addButton.style.display = 'block';
                     clubsContentDiv.style.display = 'flex';
                     displayClubs(); // Load and display assigned clubs
                     // The '+' button in this section is for assigning an UNASSIGNED team
                     addButton.title = "Priradi≈• t√≠m do skupiny";
                 }
                 // Add cases for other sections if needed (#sportove-haly, #sprava-turnaja, #nastavenia)
                 // else if (hash === '#sportove-haly') { ... }
                 // else if (hash === '#sprava-turnaja') { ... }
                 // else if (hash === '#nastavenia') { ... }
                 else {
                     // Default or unimplemented sections
                     addButton.style.display = 'none';
                     addButton.title = "Prida≈• polo≈æku"; // Default title
                     console.log("Nezn√°ma alebo neimplementovan√° sekcia, zobrazujem pr√°zdny obsah.");
                 }
            }


            // --- Event Listeners ---

            // Spoloƒçn√° obsluha kliknutia na tlaƒçidlo Prida≈• (+)
            addButton.addEventListener('click', () => {
                const hash = window.location.hash;
                if (hash === '#kateg√≥rie') { // Opraven√Ω hash pre kateg√≥rie
                     // Open category modal in add mode
                     currentCategoryModalMode = 'add';
                     editingCategoryName = null;
                     categoryModalTitle.textContent = 'Prida≈• kateg√≥riu';
                     categoryForm.reset();
                     categoryModal.style.display = 'block';
                     categoryNameInput.focus();
                } else if (hash === '#skupiny') {
                     // Open group modal in add mode
                     openGroupModal(); // Call openGroupModal without arguments for add mode
                } else if (hash === '#zoznam-timov') {
                     // Open team creation modal
                     openTeamCreationModal(); // Call the updated function
                }
                else if (hash === '#timy-do-skupin') {
                     // Open club modal in add-assign mode (to assign an unassigned team)
                     openClubModal(); // Call openClubModal without arguments for add-assign mode
                }
            });


            // Obsluha zatvorenia mod√°lov (kliknutie na X)
            categoryModalCloseBtn.addEventListener('click', () => {
                 categoryModal.style.display = 'none';
                 currentCategoryModalMode = 'add'; editingCategoryName = null;
                 categoryForm.reset();
                 // Ak sa zatv√°ra kateg√≥ria mod√°l a bol otvoren√Ω Team Creation Modal, aktualizuj jeho selecty
                  if (teamCreationModal.style.display === 'block') {
                      loadAllCategoriesForDynamicSelects(); // Pre istotu znovu naƒç√≠taj kateg√≥rie (vol√° updateDynamicSelects a checkIfAddCategoryButtonShouldBeVisible)
                  }
            });

            groupModalCloseBtn.addEventListener('click', () => {
                 groupModal.style.display = 'none';
                 currentGroupModalMode = 'add'; editingGroupId = null;
                 groupForm.reset();
            });

             clubModalCloseBtn.addEventListener('click', () => { // Club Modal Close
                 clubModal.style.display = 'none';
                 currentClubModalMode = 'add-assign'; editingClubId = null; // Reset club modal state
                 clubForm.reset();
                  // Reset visibility of name input vs select
                  unassignedClubSelectContainer.style.display = 'block';
                  clubNameInputContainer.style.display = 'none';
                   // Reset group select visibility for club modal
                  clubGroupSelect.parentElement.style.display = 'block';
                   // Reset order input visibility for club modal
                  orderInputContainer.style.display = 'none';
                  orderInGroupInput.required = false;
             });

             // Team Creation Modal Close
             teamCreationModalCloseBtn.addEventListener('click', () => {
                 teamCreationModal.style.display = 'none';
                 currentTeamCreationModalMode = 'add';
                 teamCreationForm.reset();
                 teamCategoryCountContainer.innerHTML = ''; // Clear dynamic fields on close
                  // Skry≈• tlaƒçidlo Prida≈• ƒèal≈°iu kateg√≥riu pri zatvoren√≠ mod√°lu
                 addCategoryCountPairButton.style.display = 'none';
                  // Optional: add back an initial empty pair for next open
                  // addCategoryCountPair(); // If you want one pair ready on open
             });

            // Nov√Ω Modal pre spr√°vu individu√°lnych t√≠mov - Zatvorenie na X
            manageTeamsModalCloseBtn.addEventListener('click', closeManageTeamsModal);


            // Obsluha zatvorenia mod√°lov (kliknutie mimo modal)
            window.addEventListener('click', (e) => {
                if (e.target === categoryModal) {
                     categoryModal.style.display = 'none';
                     currentCategoryModalMode = 'add'; editingCategoryName = null;
                     categoryForm.reset();
                     // Ak sa zatv√°ra kateg√≥ria mod√°l a bol otvoren√Ω Team Creation Modal, aktualizuj jeho selecty
                      if (teamCreationModal.style.display === 'block') {
                          loadAllCategoriesForDynamicSelects(); // Pre istotu znovu naƒç√≠taj kateg√≥rie (vol√° updateDynamicSelects a checkIfAddCategoryButtonShouldBeVisible)
                      }
                }
                if (e.target === groupModal) {
                     groupModal.style.display = 'none';
                     currentGroupModalMode = 'add'; editingGroupId = null;
                     groupForm.reset();
                }
                 if (e.target === clubModal) { // Club Modal Close
                     clubModal.style.display = 'none';
                     currentClubModalMode = 'add-assign'; editingClubId = null; // Reset club modal state
                     clubForm.reset();
                      // Reset visibility of name input vs select
                     unassignedClubSelectContainer.style.display = 'block';
                     clubNameInputContainer.style.display = 'none';
                      // Reset group select visibility for club modal
                     clubGroupSelect.parentElement.style.display = 'block';
                      // Reset order input visibility for club modal
                     orderInputContainer.style.display = 'none';
                     orderInGroupInput.required = false;
                 }
                 // Team Creation Modal Close
                 if (e.target === teamCreationModal) {
                     teamCreationModal.style.display = 'none';
                     currentTeamCreationModalMode = 'add';
                     teamCreationForm.reset();
                      teamCategoryCountContainer.innerHTML = ''; // Clear dynamic fields on close
                       // Skry≈• tlaƒçidlo Prida≈• ƒèal≈°iu kateg√≥riu pri zatvoren√≠ mod√°lu
                      addCategoryCountPairButton.style.display = 'none';
                      // Optional: add back an initial empty pair for next open
                      // addCategoryCountPair(); // If you want one pair ready on open
                 }
                 // Nov√Ω Modal pre spr√°vu individu√°lnych t√≠mov - Zatvorenie kliknut√≠m mimo
                 if (e.target === manageTeamsModal) {
                      closeManageTeamsModal();
                 }
            });


            // Spust√≠me toggleContentDisplay pri naƒç√≠tan√≠ str√°nky a zmene ha≈°u
            window.addEventListener('hashchange', toggleContentDisplay);
            window.addEventListener('load', () => {
                 // Set initial hash if none is present, e.g., to #kategorie
                 if (!window.location.hash || window.location.hash === '#') { // Also handle empty hash
                      window.location.hash = '#kateg√≥rie'; // Opraven√Ω hash pre poƒçiatoƒçn√∫ str√°nku
                 } else {
                     // If hash is present, call toggleContentDisplay
                     toggleContentDisplay();
                 }
            });


            // Obsluha formul√°ra na pridanie/√∫pravu kateg√≥rie
            categoryForm.addEventListener('submit', async (e) => {
                 e.preventDefault();
                 const categoryName = categoryNameInput.value.trim();
                 if (categoryName === '') { alert('N√°zov kateg√≥rie nem√¥≈æe by≈• pr√°zdny.'); return; }

                 if (currentCategoryModalMode === 'add') {
                      const categoryDocRef = doc(categoriesCollectionRef, categoryName);
                      try {
                           const existingDoc = await getDoc(categoryDocRef);
                           if (existingDoc.exists()) { alert(`Kateg√≥ria "${categoryName}" u≈æ existuje!`); return; }
                           await setDoc(categoryDocRef, { /* optional data like createdAt: new Date() */ });
                           console.log(`Kateg√≥ria "${categoryName}" bola √∫spe≈°ne pridan√°.`);
                           categoryModal.style.display = 'none'; categoryForm.reset();
                           currentCategoryModalMode = 'add'; editingCategoryName = null;
                           // Refresh displays that might be affected
                           loadCategoriesTable(); // Always refresh category table
                           if (window.location.hash === '#skupiny') {
                               groupsContentDiv.innerHTML = '';
                               displayGroupsByCategory();
                           }
                           if (window.location.hash === '#timy-do-skupin') displayClubs();
                           if (window.location.hash === '#zoznam-timov') {
                                // Refresh created teams list, which depends on categories
                                displayCreatedTeams();
                                // Aj po pridan√≠ kateg√≥rie treba aktualizova≈• ponuky v Team Creation Modale
                                if (teamCreationModal.style.display === 'block') {
                                     loadAllCategoriesForDynamicSelects(); // Naƒç√≠taj znovu kateg√≥rie, ƒço zavol√° aj updateDynamicSelects a checkIfAddCategoryButtonShouldBeVisible
                                }
                           }


                      } catch (error) {
                           console.error('Chyba pri prid√°van√≠ kateg√≥rie: ', error);
                           alert('Chyba pri prid√°van√≠ kateg√≥rie!');
                           // Close modal and reset state on error
                           categoryModal.style.display = 'none'; categoryForm.reset();
                           currentCategoryModalMode = 'add'; editingCategoryName = null;
                      }
                 } else if (currentCategoryModalMode === 'edit') {
                      const oldCategoryName = editingCategoryName;
                      const newCategoryName = categoryName;
                      if (!oldCategoryName) { console.error("Chyba: Ch√Ωba p√¥vodn√Ω n√°zov kateg√≥rie."); alert("Chyba pri √∫prave kateg√≥rie."); categoryModal.style.display = 'none'; categoryForm.reset(); currentCategoryModalMode = 'add'; editingCategoryName = null; return; }
                      if (newCategoryName === oldCategoryName) { console.log("N√°zov kateg√≥rie sa nezmenil."); categoryModal.style.display = 'none'; categoryForm.reset(); return; }

                      const newCategoryDocRef = doc(categoriesCollectionRef, newCategoryName);
                      try {
                           const existingDoc = await getDoc(newCategoryDocRef);
                           if (existingDoc.exists()) { alert(`Kateg√≥ria s n√°zvom "${newCategoryName}" u≈æ existuje!`); return; }

                           const oldCategoryDocRef = doc(categoriesCollectionRef, oldCategoryName);
                           const oldDocSnapshot = await getDoc(oldCategoryDocRef);
                           if (!oldDocSnapshot.exists()) { console.error(`Chyba: P√¥vodn√Ω dokument kateg√≥rie ${oldCategoryName} nen√°jden√Ω.`); alert("P√¥vodn√° kateg√≥ria na √∫pravu nebola n√°jden√°."); categoryModal.style.display = 'none'; categoryForm.reset(); currentCategoryModalMode = 'add'; editingCategoryName = null; loadCategoriesTable(); return; }
                           const oldDocData = oldDocSnapshot.data();

                           const batch = writeBatch(db);
                           batch.set(newCategoryDocRef, oldDocData); // Create new doc with new ID
                           // Note: We delete the old doc after processing references to ensure it exists during lookups
                           // Update group and club references before deleting the old category document

                           // Groups first
                           const groupsQuery = query(groupsCollectionRef, where('categoryId', '==', oldCategoryName));
                           const groupsSnapshot = await getDocs(groupsQuery);

                       // Fetch clubs related to groups being deleted *before* starting the batch queries within the loop
                       const clubUpdates = [];
                       for (const groupDoc of groupsSnapshot.docs) {
                           const clubsInGroupQuery = query(clubsCollectionRef, where('groupId', '==', groupDoc.id));
                           const clubsSnapshot = await getDocs(clubsInGroupQuery);
                           clubsSnapshot.forEach(clubDoc => {
                                // Use the new composite group ID for the update
                               const oldGroupId = groupDoc.id; // e.g., "OldCategory - GroupA"
                               const groupData = groupDoc.data(); // Get group data to reconstruct the name part
                               const newGroupId = `${newCategoryName} - ${groupData.name}`; // Construct new group ID using new category name and old group name

                               batch.update(clubDoc.ref, { categoryId: newCategoryName, groupId: newGroupId }); // Update club with new categoryId and new groupId
                                console.log(`Klub "${clubDoc.id}" aktualizovan√Ω (categoryId, groupId) kv√¥li zmene kateg√≥rie skupiny.`);
                           });
                            // Add group deletion to batch
                           batch.delete(groupDoc.ref); // Delete old group doc
                           console.log(`Star√° skupina "${groupDoc.id}" zmazan√° po premenovan√≠ kateg√≥rie.`); // Clarified log
                       }

                       // N√°jdi a aktualizuj kluby s touto kateg√≥riou, ktor√© u≈æ nemusia by≈• priraden√© k skupine (groupId == null)
                       const unassignedClubsQuery = query(clubsCollectionRef, where('categoryId', '==', oldCategoryName), where('groupId', '==', null));
                        const unassignedClubsSnapshot = await getDocs(unassignedClubsQuery);
                        unassignedClubsSnapshot.forEach(doc => {
                           batch.update(doc.ref, { categoryId: newCategoryName }); // Just update categoryId to new name
                           console.log(`Nepriraden√Ω klub "${doc.id}" aktualizovan√Ω (categoryId).`);
                        });


                       // Nakoniec zma≈æ samotn√∫ p√¥vodn√∫ kateg√≥riu
                       batch.delete(oldCategoryDocRef); // Delete old category doc using old name


                       await batch.commit();

                       console.log(`Premenovanie kateg√≥rie "${oldCategoryName}" na "${newCategoryName}" a aktualiz√°cia referenci√≠ bolo √∫spe≈°n√©.`);

                       currentCategoryModalMode = 'add'; editingCategoryName = null;
                       categoryModal.style.display = 'none'; categoryForm.reset();

                       // Refresh displays that might be affected
                       loadCategoriesTable();
                       if (window.location.hash === '#skupiny') displayGroupsByCategory();
                       if (window.location.hash === '#timy-do-skupin') displayClubs();
                       if (window.location.hash === '#zoznam-timov') {
                            displayCreatedTeams();
                             // Aj po premenovan√≠ kateg√≥rie treba aktualizova≈• ponuky v Team Creation Modale
                             if (teamCreationModal.style.display === 'block') {
                                loadAllCategoriesForDynamicSelects(); // Naƒç√≠taj znovu kateg√≥rie, ƒço zavol√° aj updateDynamicSelects a checkIfAddCategoryButtonShouldBeVisible
                            }
                       }


                       } catch (error) {
                            console.error('Chyba pri premenovan√≠ kateg√≥rie a aktualiz√°cii referenci√≠: ', error);
                            alert('Chyba pri premenovan√≠ kateg√≥rie! Pros√≠m, sk√∫ste znova.');
                            // Reset state and close modal on error
                            currentCategoryModalMode = 'add'; editingCategoryName = null;
                            categoryModal.style.display = 'none'; categoryForm.reset();
                       }
                  }
            });


             // --- Obsluha formul√°ra Skupiny (pou≈æ√≠va kompozitn√© ID) ---
              groupForm.addEventListener('submit', async (e) => {
                  e.preventDefault();
                  const selectedCategoryId = groupCategorySelect.value;
                  const groupName = groupNameInput.value.trim();

                  if (selectedCategoryId === '' || selectedCategoryId === '-- Vyberte kateg√≥riu --' || groupCategorySelect.disabled) { alert('Pros√≠m, vyberte platn√∫ kateg√≥riu pre skupinu.'); return; }
                  if (groupName === '') { alert('N√°zov skupiny nem√¥≈æe by≈• pr√°zdny.'); return; }

                  const compositeGroupId = `${selectedCategoryId} - ${groupName}`;
                  const groupDocRef = doc(groupsCollectionRef, compositeGroupId);

                  try {
                      const existingDoc = await getDoc(groupDocRef);

                      if (currentGroupModalMode === 'add') {
                          // === LOGIKA PRID√ÅVANIA SKUPINY ===
                          if (existingDoc.exists()) {
                               alert(`Skupina s n√°zvom "${groupName}" u≈æ v kateg√≥rii "${selectedCategoryId}" existuje! N√°zvy skup√≠n musia by≈• unik√°tne v r√°mci kateg√≥rie.`);
                               return;
                          }
                          await setDoc(groupDocRef, { name: groupName, categoryId: selectedCategoryId });
                          console.log(`Skupina "${groupName}" (ID: ${compositeGroupId}) bola √∫spe≈°ne pridan√° do kateg√≥rie "${selectedCategoryId}".`);

                      } else if (currentGroupModalMode === 'edit') {
                          // === LOGIKA √öPRAVY SKUPINY (PREMENOVANIE / ZMENA KATEG√ìRIE) ===
                          const oldGroupId = editingGroupId;
                          if (!oldGroupId) { console.error("Chyba: Re≈æim √∫pravy skupiny bez platn√©ho editingGroupId."); alert("Chyba pri √∫prave skupiny. Pros√≠m, obnovte str√°nku."); groupModal.style.display = 'none'; groupForm.reset(); currentGroupModalMode = 'add'; editingGroupId = null; return; }

                          const oldGroupDocRef = doc(groupsCollectionRef, oldGroupId);
                          const oldDocSnapshot = await getDoc(oldGroupDocRef);
                          if (!oldDocSnapshot.exists()) { console.error(`Chyba: P√¥vodn√Ω dokument skupiny ${oldGroupId} nen√°jden√Ω.`); alert("P√¥vodn√° skupina na √∫pravu nebola n√°jden√°."); groupModal.style.display = 'none'; groupForm.reset(); currentGroupModalMode = 'add'; editingGroupId = null; displayGroupsByCategory(); return; }
                          const oldGroupData = oldDocSnapshot.data();


                          // Check if the composite ID has changed (name or category)
                          if (oldGroupId !== compositeGroupId) {
                               console.log(`Premenovanie/presun skupiny z "${oldGroupId}" na "${compositeGroupId}".`);
                               // Check if the NEW composite ID already exists (another group with this name/category)
                               if (existingDoc.exists()) {
                                  alert(`Skupina s n√°zvom "${groupName}" u≈æ v kateg√≥rii "${selectedCategoryId}" existuje (in√° skupina)! N√°zvy skup√≠n musia by≈• unik√°tne v r√°mci kateg√≥rie.`);
                                  return;
                               }
                               // If ID changes, we need to delete the old document and create a new one
                               const batch = writeBatch(db);
                               // Use the current data from the form for the new document
                               batch.set(groupDocRef, { name: groupName, categoryId: selectedCategoryId }); // Create new group doc with new ID
                               // Note: Delete the old doc after processing references
                               // batch.delete(oldGroupDocRef); // This will be done after club updates below

                               // Update clubs that referenced the OLD group ID
                               const clubsInGroupQuery = query(clubsCollectionRef, where('groupId', '==', oldGroupId));
                               const clubsSnapshot = await getDocs(clubsInGroupQuery); // Use await here
                               clubsSnapshot.forEach(clubDoc => {
                                    // Update the club's groupId to the new composite ID
                                    // Keep the original orderInGroup if it exists, only update groupId and categoryId
                                    batch.update(clubDoc.ref, { groupId: compositeGroupId, categoryId: selectedCategoryId }); // Ensure categoryId is also updated on club
                                    console.log(`Klub "${clubDoc.id}" aktualizovan√Ω (groupId, categoryId) kv√¥li zmene skupiny.`);
                               });

                                // Now delete the old group document
                                batch.delete(oldGroupDocRef);


                               await batch.commit();

                               console.log(`Skupina √∫spe≈°ne premenovan√°/presunut√° z ID "${oldGroupId}" na "${compositeGroupId}" a s√∫visiace kluby aktualizovan√©.`);

                           } else {
                               // If the composite ID hasn't changed, just update the existing document
                               console.log(`√öprava √∫dajov pre skupinu s ID "${oldGroupId}". Kompozitn√© ID sa nemen√≠.`);
                               // Use updateDoc on the document with the current ID
                               await updateDoc(groupDocRef, {
                                   name: groupName,
                                   categoryId: selectedCategoryId
                               });
                               console.log(`Skupina s ID "${oldGroupId}" √∫spe≈°ne upraven√°.`);
                           }
                      }

                      // --- Common logic after successful add or edit ---
                      groupModal.style.display = 'none'; groupForm.reset();
                      currentGroupModalMode = 'add'; editingGroupId = null;

                      // Refresh displays that might be affected
                      if (window.location.hash === '#skupiny') displayGroupsByCategory();
                      if (window.location.hash === '#timy-do-skupin') displayClubs();
                      if (window.location.hash === '#zoznam-timov') displayCreatedTeams();


                   } catch (error) {
                       console.error('Chyba pri ukladan√≠ skupiny: ', error);
                       alert(`Chyba pri ukladan√≠ skupiny! Detail: ${error.message}`);
                        // Reset state and close modal on error
                       groupModal.style.display = 'none';
                       groupForm.reset();
                       currentGroupModalMode = 'add'; editingGroupId = null;
                    }
               });

            // --- Obsluha formul√°ra Kluby (Priradenie do skup√≠n & √öprava priraden√Ωch/nepriraden√Ωch) ---
             clubForm.addEventListener('submit', async (e) => {
                 e.preventDefault();

                 const selectedCategoryId = clubCategorySelect.value;
                 // Get the selected group ID only if the group select is NOT disabled
                 const selectedGroupId = !clubGroupSelect.disabled ? clubGroupSelect.value : null;
                 // Get the order number value, convert to number. Use null if empty or invalid.
                 const orderInGroupValue = parseInt(orderInGroupInput.value, 10);
                 const orderInGroup = isNaN(orderInGroupValue) || orderInGroupValue < 1 ? null : orderInGroupValue;


                 // Validate selects based on mode and visibility
                 if (clubCategorySelect.disabled === false && (selectedCategoryId === '' || selectedCategoryId === '-- Vyberte kateg√≥riu --')) {
                     alert('Pros√≠m, vyberte platn√∫ kateg√≥riu.');
                     return;
                 }
                  // Validate group selection only if the group select is visible and enabled
                 if (clubGroupSelect.parentElement.style.display !== 'none' && clubGroupSelect.disabled === false && (selectedGroupId === '' || selectedGroupId === '-- Vyberte skupinu --' || selectedGroupId === '-- ≈Ωiadne skupiny v kateg√≥rii --')) {
                      alert('Pros√≠m, vyberte platn√∫ skupinu.');
                      return;
                  }
                 // Validate order number if the input is required (which is true for assigned teams in this logic)
                  if (orderInGroupInput.required && orderInGroup === null) {
                       alert('Pros√≠m, zadajte platn√© poradov√© ƒç√≠slo v√§ƒç≈°ie ako 0.');
                       return;
                  }


                 try {
                     if (currentClubModalMode === 'add-assign') {
                         // === LOGIKA PRIRADENIA T√çMU DO SKUPINY ===
                         const selectedUnassignedClubId = unassignedClubSelect.value;

                         // Validate the selected unassigned club
                         if (unassignedClubSelectContainer.style.display !== 'none' && selectedUnassignedClubId === '') { // Only validate if the select je viditeƒæn√Ω
                             alert('Pros√≠m, vyberte t√≠m na priradenie.');
                             return;
                         }
                          // We also need a valid group selected for assignment
                          if (!selectedGroupId) {
                               alert('Pre priradenie t√≠mu je potrebn√© vybra≈• kateg√≥riu aj skupinu.');
                               return; // Should not happen if previous group select validation works, but double-check
                          }


                         // Fetch the selected unassigned club document to confirm it exists and is unassigned
                         const clubRefToAssign = doc(clubsCollectionRef, selectedUnassignedClubId);
                         const clubDocToAssign = await getDoc(clubRefToAssign);

                         if (!clubDocToAssign.exists()) {
                             alert('Vybran√Ω t√≠m nebol n√°jden√Ω alebo u≈æ bol priraden√Ω/zmazan√Ω.');
                             // Refresh the unassigned list and close modal
                             populateUnassignedClubsSelect(unassignedClubSelect, null);
                             clubModal.style.display = 'none';
                             clubForm.reset();
                              // Reset visibility
                             unassignedClubSelectContainer.style.display = 'block';
                             clubNameInputContainer.style.display = 'none';
                             clubGroupSelect.parentElement.style.display = 'block'; // Reset group visibility
                             orderInputContainer.style.display = 'none'; // Reset order visibility
                             orderInGroupInput.required = false;
                             return;
                         }

                         const clubDataToAssign = clubDocToAssign.data();
                         if (clubDataToAssign.groupId !== null) {
                             alert(`T√≠m "${clubDataToAssign.name}" je u≈æ priraden√Ω do skupiny "${clubDataToAssign.groupId}".`);
                             // Refresh the unassigned list and close modal
                             populateUnassignedClubsSelect(unassignedClubSelect, null);
                             clubModal.style.display = 'none';
                             clubForm.reset();
                              // Reset visibility
                             unassignedClubSelectContainer.style.display = 'block';
                             clubNameInputContainer.style.display = 'none';
                             clubGroupSelect.parentElement.style.display = 'block'; // Reset group visibility
                             orderInputContainer.style.display = 'none'; // Reset order visibility
                             orderInGroupInput.required = false;
                             return;
                         }

                         // Check if a club with the exact same name already exists IN THIS TARGET GROUP
                         const existingClubInGroupQuery = query(clubsCollectionRef,
                              where('groupId', '==', selectedGroupId),
                              where('name', '==', clubDataToAssign.name)
                         );
                         const existingClubInGroupSnapshot = await getDocs(existingClubInGroupQuery);
                         if (!existingClubInGroupSnapshot.empty) {
                             alert(`T√≠m s n√°zvom "${clubDataToAssign.name}" u≈æ v skupine "${selectedGroupId}" existuje!`);
                             return;
                         }

                         // Check if another team with the same order number already exists IN THIS TARGET GROUP
                          // Only perform this check if an order number was provided
                         if (orderInGroup !== null) {
                              const existingOrderQuery = query(clubsCollectionRef,
                                   where('groupId', '==', selectedGroupId),
                                   where('orderInGroup', '==', orderInGroup)
                              );
                              const existingOrderSnapshot = await getDocs(existingOrderQuery);
                              if (!existingOrderSnapshot.empty) {
                                   alert(`T√≠m s poradov√Ωm ƒç√≠slom "${orderInGroup}" u≈æ v skupine "${selectedGroupId}" existuje! Pros√≠m, zvoƒæte in√© poradov√© ƒç√≠slo.`);
                                   return;
                              }
                         }


                         // Update the existing unassigned club document to assign it to the group
                         await updateDoc(clubRefToAssign, {
                             categoryId: selectedCategoryId, // Update categoryId based on selected group's category
                             groupId: selectedGroupId, // Store the composite group ID
                             orderInGroup: orderInGroup // Save the order number (will be null if not required/provided)
                             // Keep the original name
                         });

                         console.log(`T√≠m "${clubDataToAssign.name}" (ID: ${selectedUnassignedClubId}) √∫spe≈°ne priraden√Ω do skupiny "${selectedGroupId}" s porad√≠m ${orderInGroup}.`);
                         alert(`T√≠m "${clubDataToassign.name}" √∫spe≈°ne priraden√Ω.`);


                     } else if (currentClubModalMode === 'edit-assigned') {
                         // === LOGIKA √öPRAVY PRIRADEN√âHO ALEBO NEPRIRADEN√âHO KLUBU ===
                         // editingClubId holds the auto-generated ID of the club being edited
                         const clubIdToEdit = editingClubId;
                         const updatedClubName = clubNameInput.value.trim(); // Get the potentially updated name


                         if (!clubIdToEdit) {
                               console.error("Chyba: Re≈æim √∫pravy priraden√©ho klubu bez platn√©ho editingClubId.");
                               alert("Chyba pri √∫prave klubu. Pros√≠m, obnovte str√°nku.");
                               clubModal.style.display = 'none'; clubForm.reset(); currentClubModalMode = 'add-assign'; editingClubId = null;
                                // Reset visibility
                               unassignedClubSelectContainer.style.display = 'block';
                               clubNameInputContainer.style.display = 'none';
                               clubGroupSelect.parentElement.style.display = 'block'; // Reset group visibility
                                orderInputContainer.style.display = 'none'; // Reset order visibility
                                orderInGroupInput.required = false;
                               return;
                          }
                          if (updatedClubName === '') {
                               alert('N√°zov klubu nem√¥≈æe by≈• pr√°zdny.');
                               return;
                          }


                         const clubRefToEdit = doc(clubsCollectionRef, clubIdToEdit);
                         const clubDocToEdit = await getDoc(clubRefToEdit);
                         if (!clubDocToEdit.exists()) {
                             console.error(`Chyba: Dokument klubu ${clubIdToEdit} nen√°jden√Ω na √∫pravu.`);
                             alert("Klub na √∫pravu nebol n√°jden√Ω.");
                             clubModal.style.display = 'none'; clubForm.reset(); currentClubModalMode = 'add-assign'; editingClubId = null;
                             displayClubs(); // Refresh display as the club je preƒç
                             return;
                         }
                         const originalClubData = clubDocToEdit.data(); // Get original data


                         // === Podmienen√° kontrola duplicitn√©ho n√°zvu ===
                          // Kontrolujeme, ak sa klub priradzuje do skupiny (mal null groupId, teraz m√° value)
                          // ALEBO ak men√≠ skupinu (mal groupId, men√≠ sa na in√© groupId)
                          // ALEBO ak zost√°va v tej istej skupine A men√≠ sa jeho n√°zov
                          // ALEBO ak zost√°va nepriraden√Ω (groupId je a zost√°va null) A men√≠ sa jeho n√°zov
                          const targetGroupIdForCheck = selectedGroupId; // This is the new groupId (could be null)
                          const originalGroupId = originalClubData.groupId;
                          const originalName = originalClubData.name;
                          const originalOrder = originalClubData.orderInGroup;

                          // Check if the targetGroupId is NOT null (it's assigned or moved to a group)
                           if (targetGroupIdForCheck !== null) {
                                // Check if a *different* club with the same updated name already exists IN THE TARGET GROUP
                                // This check is needed if the target group is not null OR if the target group IS null but the name changed
                                // Simplified: Check if name exists in target group, excluding the current club if group didn't change
                                if (updatedClubName !== originalName || targetGroupIdForCheck !== originalGroupId) { // Only check if name changed OR group changed
                                     const existingClubInTargetGroupQuery = query(clubsCollectionRef,
                                          where('groupId', '==', targetGroupIdForCheck), // Cieƒæov√° skupina (m√¥≈æe by≈• rovnak√° ako p√¥vodn√°)
                                          where('name', '==', updatedClubName),     // Nov√Ω n√°zov
                                          // POU≈ΩITIE '__name__' MIESTO FieldPath.documentId()
                                          ...(targetGroupIdForCheck === originalGroupId ? [where('__name__', '!=', clubIdToEdit)] : [])
                                     );
                                     const existingClubInTargetGroupSnapshot = await getDocs(existingClubInTargetGroupQuery);
                                     if (!existingClubInTargetGroupSnapshot.empty) {
                                          alert(`Klub s n√°zvom "${updatedClubName}" u≈æ v cieƒæovej skupine "${targetGroupIdForCheck}" existuje! Pros√≠m, zvoƒæte in√Ω n√°zov alebo skupinu.`);
                                          return;
                                     }
                                }

                                // Check if a *different* team with the same updated order number already exists IN THE TARGET GROUP
                                // Only perform this check if an order number was provided (is not null) AND the target group is not null
                                if (orderInGroup !== null) {
                                      if (orderInGroup !== originalOrder || targetGroupIdForCheck !== originalGroupId) { // Only check if order changed OR group changed
                                           const existingOrderQuery = query(clubsCollectionRef,
                                                where('groupId', '==', targetGroupIdForCheck), // Cieƒæov√° skupina (m√¥≈æe by≈• rovnak√° ako p√¥vodn√°)
                                                where('orderInGroup', '==', orderInGroup),
                                                // POU≈ΩITIE '__name__' MIESTO FieldPath.documentId()
                                                ...(targetGroupIdForCheck === originalGroupId ? [where('__name__', '!=', clubIdToEdit)] : [])
                                           );
                                           const existingOrderSnapshot = await getDocs(existingOrderQuery);
                                           if (!existingOrderSnapshot.empty) {
                                                alert(`T√≠m s poradov√Ωm ƒç√≠slom "${orderInGroup}" u≈æ v skupine "${targetGroupIdForCheck}" existuje! Pros√≠m, zvoƒæte in√© poradov√© ƒç√≠slo.`);
                                                return;
                                           }
                                      }
                                }


                            } else { // The targetGroupId IS null (remains unassigned or is being unassigned)
                                 // Optional: Check if another UNASSIGNED club with the same new name exists
                                 // This might not be strictly necessary depending on desired uniqueness constraints for unassigned teams.
                                  if (updatedClubName !== originalName) { // Only check if name changed
                                       /*
                                       const existingUnassignedClubQuery = query(clubsCollectionRef,
                                            where('groupId', '==', null),
                                            where('name', '==', updatedClubName),
                                            // POU≈ΩITIE '__name__' MIESTO FieldPath.documentId() - Ak by sa to pou≈æ√≠valo
                                            // where('__name__', '!=', clubIdToEdit)
                                       );
                                       const existingUnassignedClubSnapshot = await getDocs(existingUnassignedClubQuery);
                                       if (!existingUnassignedClubSnapshot.empty) {
                                           alert(`In√Ω nepriraden√Ω klub s n√°zvom "${updatedClubName}" u≈æ existuje!`);
                                           return;
                                       }
                                       */
                                  }
                                   // Order number is not relevant for unassigned teams, no duplication check needed here
                            }


                          // Update the assigned/unassigned club document
                          await updateDoc(clubRefToEdit, {
                               name: updatedClubName, // Update name
                              categoryId: selectedCategoryId, // Allow changing category even for unassigned
                              groupId: selectedGroupId, // This will be null if the group select was hidden/disabled
                               orderInGroup: selectedGroupId !== null ? orderInGroup : null // Save order only if assigned to a group
                              // Update other fields if they were in the form
                          });

                          console.log(`Klub "${updatedClubName}" (ID: ${clubIdToEdit}) √∫spe≈°ne upraven√Ω. Nov√° skupina: ${selectedGroupId}, Nov√© poradie: ${orderInGroup}.`);
                          alert(`Klub √∫spe≈°ne upraven√Ω.`);

                      }

                      // --- Common logic after successful add/assign or edit ---
                      clubModal.style.display = 'none';
                      clubForm.reset();
                      currentClubModalMode = 'add-assign'; // Reset state to add-assign
                      editingClubId = null; // Clear editing ID

                      // Reset visibility of name input vs select for next time
                       unassignedClubSelectContainer.style.display = 'block';
                       clubNameInputContainer.style.display = 'none';
                       // Reset group select visibility for club modal
                       clubGroupSelect.parentElement.style.display = 'block';
                       // Reset order input visibility for club modal
                       orderInputContainer.style.display = 'none';
                       orderInGroupInput.required = false; // Ensure required is false by default


                      // Refresh displays that might be affected
                      // Refresh main 'Created Teams' display because an unassigned team was edited (name/category)
                       if (window.location.hash === '#zoznam-timov') {
                            displayCreatedTeams(); // Refresh main list
                             // Ak sa upravoval/priraƒèoval t√≠m, m√¥≈æe to ovplyvni≈• dostupn√© kateg√≥rie
                            // pre dynamick√© selecty vo Team Creation Modale
                             if (teamCreationModal.style.display === 'block') {
                                loadAllCategoriesForDynamicSelects(); // Naƒç√≠taj znovu kateg√≥rie, ƒço zavol√° aj updateDynamicSelects a checkIfAddCategoryButtonShouldBeVisible
                             }
                       }
                      // Refresh clubs-in-groups display if visible, as an assigned team was edited/assigned
                       if (window.location.hash === '#timy-do-skupin') {
                            displayClubs(); // Refresh assigned clubs display
                       }

                       // If coming from manage teams modal, re-open it? Or just refresh the main lists?
                       // For now, just refresh the main lists.

                  } catch (error) {
                      console.error('Chyba pri ukladan√≠ alebo priradzovan√≠ klubu: ', error);
                      alert(`Chyba pri ukladan√≠ alebo priradzovan√≠ klubu! Detail: ${error.message}`);
                       // Zatvor mod√°l a resetuj stav pri chybe
                       clubModal.style.display = 'none';
                       clubForm.reset();
                       currentClubModalMode = 'add-assign'; editingClubId = null;
                        // Reset visibility of name input vs select on error
                       unassignedClubSelectContainer.style.display = 'block';
                       clubNameInputContainer.style.display = 'none';
                        // Reset group select visibility for club modal on error
                       clubGroupSelect.parentElement.style.display = 'block';
                        // Reset order input visibility on error
                       orderInputContainer.style.display = 'none';
                       orderInGroupInput.required = false; // Ensure required is false on error
                  }
             });


            // --- Event Listener pre zmenu kateg√≥rie v mod√°li klubu (pre priradenie do skupiny) ---
             clubCategorySelect.addEventListener('change', async () => { // Made async to use await for populateGroupSelect
                 const selectedCategoryId = clubCategorySelect.value;
                 // Populate the group select based on the newly selected category
                  // Only populate if in add-assign mode or if group select is currently visible (editing an assigned club)
                  if (currentClubModalMode === 'add-assign' || clubGroupSelect.parentElement.style.display !== 'none') {
                       await populateGroupSelect(selectedCategoryId, clubGroupSelect); // Pass category ID and select element
                       // Reset order input when category changes
                       orderInGroupInput.value = '';
                  } else {
                       // If in edit-assigned mode and group select is hidden (editing unassigned)
                       // Changing category doesn't affect group select visibility/options or order input
                  }
             });

             // Event listener for change in the unassigned club select (in clubModal) - handles category/group selects update
             unassignedClubSelect.addEventListener('change', async () => {
                  const selectedClubId = unassignedClubSelect.value;
                  // When an unassigned club is selected in add-assign mode, populate the category select with its category
                  // and then populate the group select.
                  if (currentClubModalMode === 'add-assign' && selectedClubId) {
                       try {
                           const clubDoc = await getDoc(doc(clubsCollectionRef, selectedClubId));
                           if (clubDoc.exists()) {
                               const clubData = clubDoc.data();
                               await populateCategorySelect(clubCategorySelect, clubData.categoryId); // Populate and select category
                               // Populate group select based on the selected category
                               // No selected group initially for assignment, so selectedGroupId is null
                               await populateGroupSelect(clubData.categoryId, clubGroupSelect, null); // Pass category ID and select element
                               // Clear order input when a new team is selected for assignment
                               orderInGroupInput.value = '';
                           } else {
                                console.warn(`Vybran√Ω nepriraden√Ω t√≠m ${selectedClubId} u≈æ neexistuje.`);
                                // Reset selects if the selected team is no longer found
                                unassignedClubSelect.value = "";
                                clubCategorySelect.value = "";
                                clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kateg√≥riu --</option>';
                                clubGroupSelect.disabled = true;
                                orderInGroupInput.value = ''; // Clear order input
                            }
                        } catch (error) {
                           console.error('Chyba pri naƒç√≠tan√≠ detailov vybran√©ho nepriraden√©ho t√≠mu:', error);
                           alert('Chyba pri naƒç√≠tan√≠ detailov t√≠mu.');
                           unassignedClubSelect.value = "";
                           clubCategorySelect.value = "";
                           clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kateg√≥riu --</option>';
                           clubGroupSelect.disabled = true;
                           orderInGroupInput.value = ''; // Clear order input
                        }
                   } else if (currentClubModalMode === 'add-assign' && !selectedClubId) {
                       // No team selected in unassigned select (back to placeholder), reset category and group selects and order input
                       clubCategorySelect.value = "";
                       clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kateg√≥riu --</option>';
                       clubGroupSelect.disabled = true;
                       orderInGroupInput.value = ''; // Clear order input
                   }
                    // If not in add-assign mode, this listener should not trigger changes
             });


            // --- Obsluha formul√°ra Vytvorenie T√≠mov - UPRAVEN√â PRE VIAC KATEG√ìRI√ç S POƒåTOM ---
            teamCreationForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const teamNameBase = teamNameInput.value.trim();
                if (teamNameBase === '') {
                    alert('Z√°kladn√Ω n√°zov t√≠mu nem√¥≈æe by≈• pr√°zdny.');
                    return;
                }

                // Z√≠ska≈• v≈°etky dynamicky pridan√© dvojice kateg√≥ria + poƒçet
                const categoryCountPairs = teamCategoryCountContainer.querySelectorAll('.category-count-pair');

                if (categoryCountPairs.length === 0) {
                    alert('Pridajte aspo≈à jednu kateg√≥riu a poƒçet t√≠mov.');
                    return;
                }

                // Zbieranie d√°t a valid√°cia pre ka≈æd√∫ dvojicu
                const teamsToProcess = []; // Pole pre uchovanie { categoryId, count } pre ka≈æd√∫ platn√∫ dvojicu
                const seenCategories = new Set(); // Na kontrolu duplicitn√Ωch kateg√≥ri√≠

                for (const pairDiv of categoryCountPairs) {
                     const categorySelect = pairDiv.querySelector('.team-category-select-dynamic');
                     const teamCountInput = pairDiv.querySelector('.team-count-input-dynamic');

                     const categoryId = categorySelect.value;
                     const teamCount = parseInt(teamCountInput.value, 10);

                     // Valid√°cia dvojice
                     if (categoryId === '' || categorySelect.disabled) {
                         alert('Pros√≠m, vyberte kateg√≥riu pre ka≈æd√Ω riadok.');
                         // M√¥≈æete voliteƒæne prida≈• oznaƒçenie chybn√©ho riadku
                         return; // Zastavi≈• spracovanie pri prvej chybe
                     }
                      if (isNaN(teamCount) || teamCount < 1) {
                         alert('Poƒçet t√≠mov mus√≠ by≈• platn√© ƒç√≠slo v√§ƒç≈°ie ako 0 pre ka≈æd√∫ kateg√≥riu.');
                         // M√¥≈æete voliteƒæne prida≈• oznaƒçenie chybn√©ho riadku
                         return; // Zastavi≈• spracovanie pri prvej chybe
                      }
                      // Kontrola duplicitnej kateg√≥rie v r√°mci formul√°ra
                       if (seenCategories.has(categoryId)) {
                           alert(`Kateg√≥ria "${categoryId}" bola vybran√° viackr√°t. Pre ka≈æd√∫ kateg√≥riu m√¥≈æete zada≈• iba jeden poƒçet.`);
                            // M√¥≈æete voliteƒæne prida≈• oznaƒçenie chybn√©ho riadku
                           return; // Zastavi≈• spracovanie pri prvej chybe
                       }
                       seenCategories.add(categoryId);

                      // Kontrola, ƒçi poƒçet t√≠mov neprekroƒç√≠ poƒçet p√≠smen abecedy (A-Z)
                       if (teamCount > 26) {
                            alert(`Pre kateg√≥riu "${categoryId}": Pre abecedn√© oznaƒçenie je mo≈æn√© vytvori≈• maxim√°lne 26 t√≠mov naraz (A-Z).`);
                             // M√¥≈æete voliteƒæne prida≈• oznaƒçenie chybn√©ho riadku
                            return; // Zastavi≈• spracovanie pri prvej chybe
                       }


                     // Ak je dvojica platn√°, pridaj ju do zoznamu na vytvorenie
                     teamsToProcess.push({ categoryId: categoryId, count: teamCount });
                }

                console.log("Pl√°novan√© vytvorenie t√≠mov:", teamNameBase, teamsToProcess);


                const batch = writeBatch(db);
                let successfullyAddedCount = 0;
                const failedCreations = []; // To store details of teams that failed creation


                try {
                    // Iterova≈• cez pl√°novan√© t√≠my na vytvorenie ({ categoryId, count })
                    for (const teamPlan of teamsToProcess) {
                         const categoryId = teamPlan.categoryId;
                         const teamCount = teamPlan.count;

                         // Pre ka≈æd√∫ kateg√≥riu a poƒçet, vytvori≈• ≈°pecifikovan√Ω poƒçet t√≠mov
                         for (let i = 1; i <= teamCount; i++) {
                              // Vytvori≈• n√°zov t√≠mu (napr. "H√°dzan√° Trenƒç√≠n A")
                              let teamName;
                              if (teamCount > 1) {
                                   const letter = String.fromCharCode(65 + (i - 1));
                                   teamName = `${teamNameBase} ${letter}`;
                              } else {
                                   teamName = teamNameBase; // Ak je poƒçet 1, n√°zov je len z√°kladn√Ω n√°zov
                              }

                              // *** KON≈†TRUKCIA ID DOKUMENTU PODƒΩA PO≈ΩIADAVKY ***
                              // P√¥vodn√Ω form√°t: "Kateg√≥ria [Suffix] - Z√°kladn√Ω N√°zov T√≠mu"
                              // const teamSuffix = teamCount > 1 ? ' ' + String.fromCharCode(65 + (i - 1)) : ''; // " A", " B", ... alebo ""
                              // const documentId = `${categoryId}${teamSuffix} - ${teamNameBase}`;

                              // *** NOV√ù FORM√ÅT: "Kateg√≥ria - Z√°kladn√Ω N√°zov T√≠mu [Suffix]" ***
                              const teamSuffixForId = teamCount > 1 ? ' ' + String.fromCharCode(65 + (i - 1)) : ''; // " A", " B", ... alebo ""
                              const documentId = `${categoryId} - ${teamNameBase}${teamSuffixForId}`;


                              const teamDocRef = doc(clubsCollectionRef, documentId);

                              // *** KONTROLA EXISTENCIE DOKUMENTU PRED PRIDAN√çM DO BATCHU ***
                              const existingDoc = await getDoc(teamDocRef);

                               if (existingDoc.exists()) {
                                   console.warn(`Dokument s ID "${documentId}" u≈æ existuje. T√≠m sa nebude znovu vytv√°ra≈•.`);
                                   failedCreations.push({ id: documentId, reason: 'U≈æ existuje' });
                                   continue; // Skip to the next iteration
                               }


                              // Ak dokument neexistuje, pridaj oper√°ciu setDoc do batchu
                              batch.set(teamDocRef, {
                                  name: teamName, // Ulo≈æ√≠me pln√Ω n√°zov (napr. "H√°dzan√° Trenƒç√≠n A")
                                  categoryId: categoryId,
                                  groupId: null, // P√¥vodne nepriraden√Ω
                                  orderInGroup: null // Novovytvoren√© t√≠my nemaj√∫ poradie
                                  // voliteƒæn√© polia
                              });
                              successfullyAddedCount++; // Inkremetova≈• poƒç√≠tadlo √∫spe≈°ne pridan√Ωch
                         }
                    }


                    await batch.commit(); // Odosla≈• batch oper√°cie

                     // --- Zobrazenie v√Ωsledku po batchi ---
                     let resultMessage = `Pokus o vytvorenie t√≠mov dokonƒçen√Ω. √öspe≈°ne vytvoren√Ωch: ${successfullyAddedCount}.`;
                     if (failedCreations.length > 0) {
                         resultMessage += ` Niektor√© t√≠my boli preskoƒçen√©, preto≈æe dokumenty s pr√≠slu≈°n√Ωmi ID u≈æ existovali (${failedCreations.length} ks).`;
                         console.warn("Preskoƒçen√© t√≠my:", failedCreations);
                         // M√¥≈æete voliteƒæne zobrazi≈• detailnej≈°√≠ zoznam preskoƒçen√Ωch t√≠mov u≈æ√≠vateƒæovi
                         // alert(resultMessage + "\nPreskoƒçen√© ID: " + failedCreations.map(f => f.id).join(", "));
                     } else {
                         resultMessage += " V≈°etky pl√°novan√© t√≠my boli √∫spe≈°ne vytvoren√©.";
                     }

                     // alert(resultMessage); // Zachov√°me alert pre sp√§tn√∫ v√§zbu


                    // --- Spoloƒçn√° logika po √∫spe≈°nom vytvoren√≠ ---
                    teamCreationModal.style.display = 'none';
                    teamCreationForm.reset();
                    teamCategoryCountContainer.innerHTML = '';
                    await addCategoryCountPair(); // Toto u≈æ vol√° updateDynamicCategorySelects a updateRemoveButtonVisibility vo vn√∫tri

                    // --- NOV√Å LOGIKA: Zabr√°ni≈• dial√≥gov√©mu oknu "Spr√°va z webu" ---
                    history.replaceState({}, '', window.location.href); // Nahrad√≠ aktu√°lny z√°znam v hist√≥rii


                    // Obnovi≈• zobrazenia, ktor√© m√¥≈æu by≈• ovplyvnen√©
                    if (window.location.hash === '#zoznam-timov') {
                         displayCreatedTeams(); // Obnovi≈• zoznam vytvoren√Ωch t√≠mov
                    }
                     // Zobrazenie priraden√Ωch klubov (timy-do-skupin) sa nemen√≠, lebo boli vytvoren√© nepriraden√© t√≠my
                     // if (window.location.hash === '#timy-do-skupin') { displayClubs(); }


                } catch (error) {
                    console.error('Chyba pri vytv√°ran√≠ t√≠mov: ', error);
                    alert(`Chyba pri vytv√°ran√≠ t√≠mov! Detail: ${error.message}`);
                     // Close modal and reset state on error (nemus√≠me ƒçisti≈• dynamick√© polia, aby u≈æ√≠vateƒæ videl, ƒço zadal)
                     teamCreationModal.style.display = 'none';
                     teamCreationForm.reset(); // Vyƒçist√≠ aspo≈à z√°kladn√Ω n√°zov
                     // Neƒçist√≠me teamCategoryCountContainer, aby u≈æ√≠vateƒæ videl, ƒço zadal
                     // Ak nastane chyba, m√¥≈æeme znova naƒç√≠tat kateg√≥rie a aktualizova≈• selecty
                     loadAllCategoriesForDynamicSelects(); // Pre istotu znovu naƒç√≠taj kateg√≥rie (vol√° updateDynamicSelects a checkIfAddCategoryButtonShouldBeVisible)
                }
            });

             // Event listener pre tlaƒçidlo "Prida≈• ƒèal≈°iu kateg√≥riu" - PRIDAN√ù KDE S√ö OSTATN√â LISTENERY
            addCategoryCountPairButton.addEventListener('click', async () => {
                 // Pred pridan√≠m novej dvojice zabezpeƒçi≈•, ≈æe kateg√≥rie s√∫ naƒç√≠tan√©
                 if (allAvailableCategories.length === 0) {
                      await loadAllCategoriesForDynamicSelects(); // Naƒç√≠taj kateg√≥rie ak e≈°te nie s√∫ (vol√° updateDynamicSelects a checkIfAddCategoryButtonShouldBeVisible)
                 }
                 await addCategoryCountPair(); // Volaj funkciu na pridanie ƒèal≈°ej dvojice (vol√° updateDynamicSelects a updateRemoveButtonVisibility)
            });

    </script>
    
</body>
</html>
