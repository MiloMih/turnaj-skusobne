<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Správca turnaja</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="style.css">

    <style>
        /* --- Modern Table Styles for #categoryTable and generated group tables --- */

        /* Apply general table styles to the category table and any generated tables with class .category-group-table */
        #categoryTable, .category-group-table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
            border: none;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

         /* Add margin between generated category-group tables */
        .category-group-table + .category-group-table {
             margin-top: 40px; /* More space between tables */
        }


        /* Style header cells for all relevant tables */
        #categoryTable th, .category-group-table th {
            background-color: #f2f2f2;
            color: #333;
            font-weight: bold;
            text-align: left;
            padding: 12px 15px;
            border-bottom: 2px solid #ddd;
        }

        /* Specific style for the first header column in groups table (e.g., "Názov Skupiny") */
        /* This applies to the first column of each generated category-group table */
        .category-group-table th:first-child {
             /* width: 200px; */ /* Can be set in JS or here */
        }

        /* Style data cells for all relevant tables */
        #categoryTable td, .category-group-table td {
            text-align: left;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
        }

        /* Style the last row's data cells for all relevant tables (optional: remove bottom border) */
        #categoryTable tbody tr:last-child td,
        .category-group-table tbody tr:last-child td {
             border-bottom: none;
        }

        /* Add a hover effect to rows in all relevant tables */
        #categoryTable tbody tr:hover,
        .category-group-table tbody tr:hover {
            background-color: #f9f9f9;
            cursor: pointer; /* Indicate interactivity */
        }

        /* Style the action buttons within the table */
        .action-button {
            padding: 5px 10px;
            margin-right: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
        }

        /* Specific style for Rename/Edit button (default action-button) */
        .action-button:not(.delete-button) {
            background-color: #007bff;
            color: white;
        }

        /* Specific style for Delete button */
        .action-button.delete-button {
            background-color: #dc3545;
            color: white;
        }

        /* Hover effects for buttons */
        .action-button:not(.delete-button):hover {
            background-color: #0056b3;
        }

        .action-button.delete-button:hover {
            background-color: #c82333;
        }

        /* Optional: Style for the cell containing the buttons */
        #categoryTable td:last-child,
        .category-group-table td:last-child {
             /* text-align: center; If you want buttons centered */
             white-space: nowrap; /* Ensure buttons stay on one line */
        }


        /* Basic modal styling */
         .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            padding-top: 60px; /* Location of the modal box */
         }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; /* 15% from the top and centered */
            padding: 20px;
            border: 1px solid #888;
            width: 80%; /* Could be more responsive */
            max-width: 500px; /* Maximum width */
            border-radius: 8px;
            position: relative; /* Needed for the close button positioning */
        }

        .close {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-content form label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

         .modal-content form input[type="text"],
         .modal-content form select { /* Style for select as well */
            width: calc(100% - 22px); /* Adjust for padding and border */
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box; /* Include padding and border in element's total width and height */
         }

         .modal-content form button {
            background-color: #28a745; /* Green for save */
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
         }

         .modal-content form button:hover {
            background-color: #218838; /* Darker green */
         }

        /* Basic layout adjustments (if not already in style.css) */
        body {
            font-family: sans-serif; /* Use a common sans-serif font */
            margin: 0;
            padding: 0;
            background-color: #f8f9fa; /* Light background for the page */
        }

        h1 {
            text-align: center;
            color: #333;
            margin-top: 20px;
        }

        h2 {
            margin-top: 30px;
            margin-bottom: 10px;
            color: #555;
        }


        .add-button {
             /* Style for the main add button */
            display: block; /* Controlled by JS */
            margin: 20px auto; /* Center the button */
            width: 50px;
            height: 50px;
            border-radius: 50%; /* Round button */
            background-color: #28a745; /* Green */
            color: white;
            font-size: 2em;
            border: none;
            cursor: pointer;
            text-align: center;
            line-height: 50px; /* Vertically center the plus sign */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.3s ease;
            position: sticky; /* Keep button visible */
            top: 20px; /* Distance from the top */
            z-index: 10; /* Ensure it's above other content */
        }

        .add-button:hover {
            background-color: #218838; /* Darker green on hover */
        }


        .content-wrapper {
            display: flex; /* Use flexbox for layout */
            margin-top: 20px;
            padding: 0 20px; /* Add some horizontal padding */
        }

        .left-menu {
            width: 200px; /* Fixed width for the menu */
            margin-right: 20px;
            background-color: #fff; /* White background for menu */
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
             /* Make menu sticky if desired */
            position: sticky;
            top: 90px; /* Adjust based on h1 and add button height */
            align-self: flex-start; /* Stick to the top of the flex container */
            max-height: calc(100vh - 110px); /* Prevent menu from overflowing viewport */
            overflow-y: auto; /* Add scroll if menu is too long */
        }

        .left-menu ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .left-menu li {
            margin-bottom: 10px;
        }

        .left-menu a {
            text-decoration: none;
            color: #007bff; /* Blue links */
            font-weight: bold;
            display: block; /* Make the whole list item clickable */
            padding: 5px 0;
            transition: color 0.3s ease;
        }

        .left-menu a:hover {
            color: #0056b3; /* Darker blue on hover */
        }


        main {
            flex-grow: 1; /* Main content takes up the remaining space */
            background-color: #fff; /* White background for main content */
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

         /* Style for the container that will hold group tables */
         #groupsContent {
             /* Add padding or margins if needed */
         }


    </style>
</head>
<body>
    <script>
        // Basic check for admin, redirect if not
        const userName = localStorage.getItem('username');
        if (userName !== 'admin') {
             window.location.href = 'login.html';
        }
    </script>

    <h1>Správca turnaja</h1>

    <!-- This button is used for adding Categories or Groups depending on the page -->
    <button class="add-button" id="addButton" title="Pridať položku">+</button>

    <!-- Modal for adding/editing Categories -->
    <div class="modal" id="categoryModal">
        <div class="modal-content">
            <span class="close category-modal-close">&times;</span>
            <h2 id="categoryModalTitle">Pridať kategóriu</h2>
            <form id="categoryForm">
                <label for="categoryName">Názov kategórie:</label>
                <input type="text" id="categoryName" name="categoryName" required>
                <button type="submit">Uložiť</button>
            </form>
        </div>
    </div>

     <!-- Modal for adding/editing Groups -->
     <div class="modal" id="groupModal">
         <div class="modal-content">
              <span class="close group-modal-close">&times;</span>
              <h2 id="groupModalTitle">Pridať skupinu</h2>
              <form id="groupForm">
                  <label for="groupCategory">Kategória:</label>
                  <select id="groupCategory" name="groupCategory" required>
                       <option value="">-- Vyberte kategóriu --</option>
                       <!-- Options will be populated by JavaScript -->
                  </select>

                  <label for="groupName">Názov skupiny:</label>
                  <input type="text" id="groupName" name="groupName" required>

                  <button type="submit">Uložiť</button>
              </form>
         </div>
     </div>


    <div class="content-wrapper">
        <nav class="left-menu">
            <ul>
                <li><a href="#kluby">Kluby</a></li>
                <li><a href="#kategorie">Kategórie</a></li>
                <li><a href="#skupiny">Skupiny</a></li>
                <li><a href="#sportove-haly">Športové haly</a></li>
                <li><a href="#sprava-turnaja">Správa turnaja</a></li>
                <li><a href="#nastavenia">Nastavenia</a></li>
            </ul>
        </nav>

        <main>
            <!-- Table for displaying Categories -->
             <table id="categoryTable" style="display: none;">
                 <thead>
                     <tr>
                         <th>Názov kategórie</th>
                         <th style="width: 150px;">Akcie</th>
                     </tr>
                 </thead>
                 <tbody id="categoryTableBody">
                     <!-- Category rows will be added here by JavaScript -->
                 </tbody>
             </table>

             <!-- Container for generated Group tables (one table per category) -->
             <div id="groupsContent" style="display: none;">
                 <!-- Category headings (<h2>) and tables (<table class="category-group-table">) will be added here by JavaScript -->
             </div>

             <!-- Add other content areas for Kluby, Haly, etc. if needed -->
             <!-- <div id="klubyContent" style="display: none;">...</div> -->


         </main>
    </div>


    <script type="module">
        // Import potrebných Firebase Firestore funkcií priamo z CDN
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
        // Pridané 'writeBatch' pre atomické operácie (napr. premenovanie = zmazanie + vytvorenie)
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, query, where, addDoc, writeBatch } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';

        // Tvoja Firebase konfigurácia
        const firebaseConfig = {
            apiKey: "AIzaSyD0h0rQZiIGi0-UDb4-YU_JihRGpIlfz40",
            authDomain: "turnaj-a28c5.firebaseapp.com",
            projectId: "turnaj-a28c5",
            storageBucket: "turnaj-a28c5.firebasestorage.app",
            messagingSenderId: "13732191148",
            appId: "1:13732191148:web:5ad78eaef2ad452a10f809"
        };

        // Inicializácia Firebase aplikácie
        const app = initializeApp(firebaseConfig);
        // Získanie inštancie Firestore databázy
        const db = getFirestore(app);

        // Referencia na kolekciu kategórií
        const categoriesCollectionRef = collection(db, 'tournamentData', 'mainTournamentData', 'categories');
        // Referencia na kolekciu skupín
        const groupsCollectionRef = collection(db, 'tournamentData', 'mainTournamentData', 'groups');


        // Získame referencie na DOM elementy
        const addButton = document.getElementById('addButton'); // Spoločné tlačidlo "+"

        // Elementy modálu Kategórie
        const categoryModal = document.getElementById('categoryModal');
        const categoryModalCloseBtn = categoryModal.querySelector('.category-modal-close');
        const categoryForm = document.getElementById('categoryForm');
        const categoryNameInput = document.getElementById('categoryName');
        const categoryModalTitle = document.getElementById('categoryModalTitle');

        // Elementy modálu Skupiny
        const groupModal = document.getElementById('groupModal');
        const groupModalCloseBtn = groupModal.querySelector('.group-modal-close');
        const groupForm = document.getElementById('groupForm');
        const groupCategorySelect = document.getElementById('groupCategory');
        const groupNameInput = document.getElementById('groupName');
        const groupModalTitle = document.getElementById('groupModalTitle');
        const groupFormSubmitButton = groupForm.querySelector('button[type="submit"]'); // Reference to the submit button


        // Elementy zobrazovaných sekcií
        const categoryTable = document.getElementById('categoryTable');
        const categoryTableBody = document.getElementById('categoryTableBody');
        const groupsContentDiv = document.getElementById('groupsContent');


        // Premenné na sledovanie stavu modálneho okna kategórie
        let currentCategoryModalMode = 'add'; // 'add' alebo 'edit'
        let editingCategoryName = null;
        let editingCategoryRow = null;

        // Premenné na sledovanie stavu modálneho okna skupiny
        let currentGroupModalMode = 'add'; // 'add' alebo 'edit'
        let editingGroupId = null; // Uchová ID skupiny pri úprave (čo je v tomto prípade názov skupiny)


        // --- Funkcie pre Kategórie (bez zmien oproti predošlej verzii) ---

        // Funkcia na vytvorenie a pridanie riadku kategórie do tabuľky
        function addCategoryRowToTable(categoryName) {
             const tr = document.createElement('tr');
             const nameTd = document.createElement('td');
             nameTd.textContent = categoryName;
             const actionsTd = document.createElement('td');
             actionsTd.style.whiteSpace = 'nowrap';

             const renameButton = document.createElement('button');
             renameButton.textContent = 'Premenovať';
             renameButton.classList.add('action-button');
             renameButton.onclick = function() {
                 currentCategoryModalMode = 'edit';
                 editingCategoryName = categoryName;
                 editingCategoryRow = this.closest('tr');
                 categoryModalTitle.textContent = 'Upraviť kategóriu';
                 categoryNameInput.value = categoryName;
                 categoryModal.style.display = 'block';
                 categoryNameInput.focus();
             };

             const deleteButton = document.createElement('button');
             deleteButton.textContent = 'Zmazať';
             deleteButton.classList.add('action-button', 'delete-button');
             deleteButton.onclick = async function() {
                 const row = this.closest('tr');
                 const categoryToDelete = row.querySelector('td:first-child').textContent;

                 if (!confirm(`Naozaj chcete zmazať kategóriu "${categoryToDelete}"? Skupiny priradené k tejto kategórii zostanú bez priradenia!`)) {
                     return;
                 }

                 try {
                     await deleteDoc(doc(categoriesCollectionRef, categoryToDelete));
                     row.remove();
                     console.log(`Kategória "${categoryToDelete}" bola úspešne zmazaná.`);

                      if (window.location.hash === '#skupiny') {
                          displayGroupsByCategory();
                      }

                 } catch (error) {
                     console.error('Chyba pri mazaní kategórie: ', error);
                     alert('Chyba pri mazaní kategórie!');
                 }
             };

             actionsTd.appendChild(renameButton);
             actionsTd.appendChild(deleteButton);
             tr.appendChild(nameTd);
             tr.appendChild(actionsTd);
             categoryTableBody.appendChild(tr);
         }


        // Funkcia na načítanie kategórií do tabuľky KATEGÓRIÍ
        async function loadCategoriesTable() {
             try {
                 categoryTableBody.innerHTML = '';

                 const querySnapshot = await getDocs(categoriesCollectionRef);

                 if (querySnapshot.empty) {
                     console.log("Žiadne kategórie nenájdené.");
                     const noDataRow = document.createElement('tr');
                     const td = document.createElement('td');
                     td.colSpan = 2;
                     td.textContent = "Žiadne kategórie zatiaľ pridané.";
                     td.style.textAlign = 'center';
                     noDataRow.appendChild(td);
                     categoryTableBody.appendChild(noDataRow);

                 } else {
                     querySnapshot.forEach((doc) => {
                         const categoryName = doc.id;
                         addCategoryRowToTable(categoryName);
                     });
                     console.log("Kategórie boli načítané a zobrazené.");
                 }

             } catch (error) {
                 console.error('Chyba pri načítaní kategórií: ', error);
                 alert('Chyba pri načítaní kategórií!');
                  const errorRow = document.createElement('tr');
                  const td = document.createElement('td');
                  td.colSpan = 2;
                  td.textContent = "Chyba pri načítaní kategórií.";
                  td.style.textAlign = 'center';
                  errorRow.appendChild(td);
                  categoryTableBody.appendChild(errorRow);
             }
         }


         // --- Funkcie pre Skupiny ---

         // Funkcia na načítanie kategórií a naplnenie <select> v modáli skupiny
         async function populateCategorySelect(selectedCategoryId = null) {
             groupCategorySelect.innerHTML = '<option value="">-- Vyberte kategóriu --</option>';

             try {
                  const querySnapshot = await getDocs(categoriesCollectionRef);
                  if (querySnapshot.empty) {
                      console.log("Žiadne kategórie pre naplnenie selectu skupín.");
                  } else {
                      querySnapshot.forEach((doc) => {
                          const categoryName = doc.id;
                          const option = document.createElement('option');
                          option.value = categoryName;
                          option.textContent = categoryName;
                          groupCategorySelect.appendChild(option);
                      });

                      // Select the provided category ID if in edit mode and it exists in the options
                      if (selectedCategoryId) {
                           // Check if the option actually exists before trying to set it
                           if (groupCategorySelect.querySelector(`option[value="${selectedCategoryId}"]`)) {
                                groupCategorySelect.value = selectedCategoryId;
                           } else {
                                console.warn(`Kategória "${selectedCategoryId}" pre upravovanú skupinu nenájdená v zozname kategórií.`);
                                // Optionally keep the "-- Vyberte kategóriu --" selected or add a warning to the user
                           }
                      }
                  }
             } catch (error) {
                 console.error('Chyba pri načítaní kategórií pre select: ', error);
                  const option = document.createElement('option');
                  option.value = "";
                  option.textContent = "Chyba pri načítaní kategórií";
                  option.disabled = true;
                  groupCategorySelect.appendChild(option);
             }
         }

        // Funkcia na otvorenie modálu skupiny (pre pridanie alebo úpravu)
        async function openGroupModal(groupId = null, groupData = null) { // groupId and groupData are null for 'add' mode
            groupModal.style.display = 'block';

            // Reset modal state and form first
            currentGroupModalMode = 'add';
            editingGroupId = null;
            groupForm.reset();
            groupNameInput.disabled = false; // Ensure name input is enabled by default
            groupNameInput.oninput = null; // Remove previous input listener if any

            if (groupId && groupData) {
                // Edit mode
                currentGroupModalMode = 'edit';
                editingGroupId = groupId; // Store the current group ID (which is its name)
                groupModalTitle.textContent = 'Upraviť skupinu';
                groupFormSubmitButton.textContent = 'Uložiť zmeny'; // Change button text

                // Populate the select and then set the value
                await populateCategorySelect(groupData.categoryId);

                // Fill the form fields
                groupNameInput.value = groupData.name || groupId; // Use name field from data or ID if name is missing

                // Add a warning listener if name is changed, as it changes the ID
                 // This listener is added *only* in edit mode
                 groupNameInput.oninput = () => {
                      if (groupNameInput.value.trim() !== editingGroupId) {
                           console.warn("Zmenou názvu skupiny sa zmení aj jej ID vo Firestore. Bude vytvorený nový dokument a starý zmazaný.");
                           // Optional: display a warning message to the user in the modal
                      } else {
                           // If they changed it back, remove the warning
                           console.log("Názov skupiny sa zhoduje s pôvodným ID. Nebude vytvorený nový dokument.");
                           // Optional: remove the warning message from the modal
                      }
                 };


            } else {
                // Add mode (initial state already set above, but re-iterate for clarity)
                groupModalTitle.textContent = 'Pridať skupinu';
                groupFormSubmitButton.textContent = 'Uložiť';

                await populateCategorySelect(); // Populate select (no category selected initially)

            }

            groupNameInput.focus(); // Set focus
        }


        // Funkcia na zobrazenie skupín usporiadaných podľa kategórií
        async function displayGroupsByCategory() {
             groupsContentDiv.innerHTML = '';

             try {
                 // 1. Načítať všetky kategórie
                 const categoriesSnapshot = await getDocs(categoriesCollectionRef);
                 const categories = categoriesSnapshot.docs.map(doc => doc.id);

                 if (categories.length === 0) {
                     const message = document.createElement('p');
                     message.textContent = "Pridajte kategórie v sekcii 'Kategórie' pre zobrazenie skupín.";
                     groupsContentDiv.appendChild(message);
                     return;
                 }

                 // 2. Načítať všetky skupiny
                 const groupsSnapshot = await getDocs(groupsCollectionRef);

                 // 3. Zoskupiť skupiny podľa categoryId
                 const groupsByCategory = {};
                 groupsSnapshot.forEach(doc => {
                     const groupData = doc.data();
                     const groupId = doc.id;
                     const categoryId = groupData.categoryId;

                     if (categoryId) {
                         if (!groupsByCategory[categoryId]) {
                             groupsByCategory[categoryId] = [];
                         }
                         groupsByCategory[categoryId].push({ id: groupId, data: groupData });
                     } else {
                         console.warn(`Skupina ${groupId} nemá priradenú categoryId.`);
                     }
                 });

                 // 4. Pre každú kategóriu vytvoriť nadpis a tabuľku so skupinami
                 categories.forEach(categoryName => {
                     const groupsForThisCategory = groupsByCategory[categoryName] || [];

                     const categoryHeading = document.createElement('h2');
                     categoryHeading.textContent = `Skupiny - ${categoryName}`;
                     groupsContentDiv.appendChild(categoryHeading);

                     const categoryGroupsTable = document.createElement('table');
                     categoryGroupsTable.classList.add('category-group-table');

                     const thead = document.createElement('thead');
                     const headerRow = document.createElement('tr');
                     const groupNameTh = document.createElement('th');
                     groupNameTh.textContent = 'Názov skupiny';
                     const actionsTh = document.createElement('th');
                     actionsTh.textContent = 'Akcie';
                     actionsTh.style.width = '150px';

                     headerRow.appendChild(groupNameTh);
                     headerRow.appendChild(actionsTh);
                     thead.appendChild(headerRow);
                     categoryGroupsTable.appendChild(thead);

                     const tbody = document.createElement('tbody');

                     if (groupsForThisCategory.length === 0) {
                         const noGroupsRow = document.createElement('tr');
                         const td = document.createElement('td');
                         td.colSpan = 2;
                         td.textContent = `V kategórii "${categoryName}" zatiaľ nie sú žiadne skupiny.`;
                         td.style.textAlign = 'center';
                         noGroupsRow.appendChild(td);
                         tbody.appendChild(noGroupsRow);
                     } else {
                         groupsForThisCategory.forEach(group => {
                             const groupRow = document.createElement('tr');
                             const groupNameTd = document.createElement('td');
                             groupNameTd.textContent = group.data.name || group.id;


                             const groupActionsTd = document.createElement('td');
                             groupActionsTd.style.whiteSpace = 'nowrap';

                             // TLAČIDLO ÚPRAVA SKUPINY - VOLÁ openGroupModal
                             const editGroupButton = document.createElement('button');
                             editGroupButton.textContent = 'Upraviť Skupinu';
                             editGroupButton.classList.add('action-button');
                             editGroupButton.onclick = () => {
                                  openGroupModal(group.id, group.data); // Pass group ID and data to open modal
                             };


                             // TLAČIDLO ZMAZAŤ SKUPINU
                             const deleteGroupButton = document.createElement('button');
                             deleteGroupButton.textContent = 'Zmazať Skupinu';
                             deleteGroupButton.classList.add('action-button', 'delete-button');
                             deleteGroupButton.onclick = async () => {
                                  if (!confirm(`Naozaj chcete zmazať skupinu "${group.data.name || group.id}"?`)) {
                                      return;
                                  }
                                  try {
                                      await deleteDoc(doc(groupsCollectionRef, group.id));
                                      console.log(`Skupina "${group.data.name || group.id}" (ID: ${group.id}) bola úspešne zmazaná.`);
                                       displayGroupsByCategory(); // Reload display
                                  } catch (error) {
                                      console.error('Chyba pri mazaní skupiny: ', error);
                                      alert('Chyba pri mazaní skupiny!');
                                  }
                              };

                             groupActionsTd.appendChild(editGroupButton);
                             groupActionsTd.appendChild(deleteGroupButton);

                             groupRow.appendChild(groupNameTd);
                             groupRow.appendChild(groupActionsTd);
                             tbody.appendChild(groupRow);
                         });
                     }

                     categoryGroupsTable.appendChild(tbody);
                     groupsContentDiv.appendChild(categoryGroupsTable);
                 });


             } catch (error) {
                 console.error('Chyba pri načítaní alebo zobrazovaní skupín: ', error);
                 const errorMessage = document.createElement('p');
                 errorMessage.textContent = 'Chyba pri načítaní dát skupín.';
                 groupsContentDiv.appendChild(errorMessage);
             }
         }


        // --- Funkcia na prepínanie zobrazenia obsahu ---

        // Funkcia na zobrazenie/skrytie tlačidla "+" a príslušného obsahu na základe hašu
        function toggleContentDisplay() {
            const hash = window.location.hash;
            console.log("Navigating to hash:", hash);

            // Skryť všetky dynamické oblasti a modály
            addButton.style.display = 'none';
            categoryTable.style.display = 'none';
            groupsContentDiv.style.display = 'none';
            categoryModal.style.display = 'none';
            groupModal.style.display = 'none';

            // Vyčistiť obsah dynamických oblastí
            categoryTableBody.innerHTML = '';
            groupsContentDiv.innerHTML = '';

            // Reset modal states and forms when navigating away
            currentCategoryModalMode = 'add'; editingCategoryName = null; editingCategoryRow = null;
            categoryForm.reset();
            currentGroupModalMode = 'add'; editingGroupId = null;
            groupForm.reset();
            groupNameInput.oninput = null; // Remove listener on name input


            if (hash === '#kategorie') {
                addButton.style.display = 'block';
                categoryTable.style.display = 'table';
                loadCategoriesTable();
                addButton.title = "Pridať kategóriu";
            } else if (hash === '#skupiny') {
                addButton.style.display = 'block';
                groupsContentDiv.style.display = 'block';
                displayGroupsByCategory();
                addButton.title = "Pridať skupinu";
            } else {
                addButton.style.display = 'none';
                addButton.title = "Pridať položku";
                console.log("Neznáma sekcia, zobrazujem prázdny obsah.");
            }
        }


        // --- Event Listeners ---

        // Spoločná obsluha kliknutia na tlačidlo Pridať (+)
        addButton.addEventListener('click', () => {
            const hash = window.location.hash;
            if (hash === '#kategorie') {
                 // Open category modal in add mode
                 currentCategoryModalMode = 'add';
                 editingCategoryName = null;
                 editingCategoryRow = null;
                 categoryModalTitle.textContent = 'Pridať kategóriu';
                 categoryForm.reset();
                 categoryModal.style.display = 'block';
                 categoryNameInput.focus();
            } else if (hash === '#skupiny') {
                 // Open group modal in add mode
                 openGroupModal(); // Call openGroupModal without arguments for add mode
            }
        });


        // Obsluha zatvorenia modálov (kliknutie na X)
        categoryModalCloseBtn.addEventListener('click', () => {
            categoryModal.style.display = 'none';
            // Reset state on close
            currentCategoryModalMode = 'add'; editingCategoryName = null; editingCategoryRow = null;
            categoryForm.reset();
        });

        groupModalCloseBtn.addEventListener('click', () => {
            groupModal.style.display = 'none';
            // Reset state on close
            currentGroupModalMode = 'add'; editingGroupId = null;
            groupForm.reset();
             groupNameInput.oninput = null; // Remove the input listener for name change warning
        });


        // Obsluha zatvorenia modálov (kliknutie mimo modal)
        window.addEventListener('click', (e) => {
            if (e.target === categoryModal) {
                 categoryModal.style.display = 'none';
                 // Reset state on close
                 currentCategoryModalMode = 'add'; editingCategoryName = null; editingCategoryRow = null;
                 categoryForm.reset();
            }
            if (e.target === groupModal) {
                 groupModal.style.display = 'none';
                 // Reset state on close
                 currentGroupModalMode = 'add'; editingGroupId = null;
                 groupForm.reset();
                  groupNameInput.oninput = null; // Remove the input listener for name change warning
            }
        });


        // Spustíme toggleContentDisplay pri načítaní stránky a zmene hašu
        window.addEventListener('hashchange', toggleContentDisplay);
        window.addEventListener('load', toggleContentDisplay);


        // Obsluha formulára na pridanie/úpravu kategórie (zostáva rovnaká)
        categoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const categoryName = categoryNameInput.value.trim();

            if (categoryName === '') {
                alert('Názov kategórie nemôže byť prázdny.');
                return;
            }

            if (currentCategoryModalMode === 'add') {
                // === LOGIKA PRIDÁVANIA KATEGÓRIE ===
                const categoryDocRef = doc(categoriesCollectionRef, categoryName);

                try {
                    const existingDoc = await getDoc(categoryDocRef);
                    if (existingDoc.exists()) {
                        alert(`Kategória "${categoryName}" už existuje!`);
                        return;
                    }

                    await setDoc(categoryDocRef, { createdAt: new Date() }); // Keep createdAt for categories? Or remove as well? Removed in prev step. Let's keep for now.

                    addCategoryRowToTable(categoryName);

                    console.log(`Kategória "${categoryName}" bola úspešne pridaná.`);
                    categoryModal.style.display = 'none';
                    categoryForm.reset();
                    currentCategoryModalMode = 'add'; editingCategoryName = null; editingCategoryRow = null;

                     if (window.location.hash === '#skupiny') {
                          // Re-display groups to update the category select dropdown if it's open/reopened
                          displayGroupsByCategory(); // This also implicitly allows repopulating the select
                     }


                } catch (error) {
                    console.error('Chyba pri pridávaní kategórie: ', error);
                    alert('Chyba pri pridávaní kategórie!');
                }

            } else if (currentCategoryModalMode === 'edit') {
                // === LOGIKA ÚPRAVY (PREMENOVANIA) KATEGÓRIE ===
                const oldCategoryName = editingCategoryName;
                const rowToUpdate = editingCategoryRow;
                const newCategoryName = categoryName; // Use new variable name

                if (!oldCategoryName || !rowToUpdate) {
                     console.error("Chyba: Úprava kategórie v režime 'edit' bez pôvodného názvu alebo referencie na riadok.");
                     alert("Chyba pri úprave kategórie. Prosím, obnovte stránku a skúste znova.");
                     currentCategoryModalMode = 'add'; editingCategoryName = null; editingCategoryRow = null;
                     categoryModal.style.display = 'none'; categoryForm.reset();
                     return;
                }

                if (newCategoryName === oldCategoryName) {
                    console.log('Nový názov kategórie je rovnaký ako pôvodný. Žiadna zmena.');
                    currentCategoryModalMode = 'add'; editingCategoryName = null; editingCategoryRow = null;
                    categoryModal.style.display = 'none'; categoryForm.reset();
                    return;
                }

                 // Check if the new name already exists as a category
                 const newCategoryDocRef = doc(categoriesCollectionRef, newCategoryName);
                 try {
                      const existingDoc = await getDoc(newCategoryDocRef);
                      if (existingDoc.exists()) {
                           alert(`Kategória s názvom "${newCategoryName}" už existuje!`);
                           return;
                      }
                 } catch (error) {
                      console.error('Chyba pri kontrole existencie novej kategórie pri úprave:', error);
                      alert('Chyba pri kontrole nového názvu kategórie. Prosím, skúste znova.');
                      return;
                 }

                 // --- Kategória premenovanie: Vytvoriť novú, zmazať starú ---
                const oldCategoryDocRef = doc(categoriesCollectionRef, oldCategoryName);
                try {
                    const oldDocSnapshot = await getDoc(oldCategoryDocRef);
                    if (!oldDocSnapshot.exists()) {
                        console.error(`Stará kategória "${oldCategoryName}" nenájdená pre premenovanie.`);
                        alert('Chyba: Pôvodná kategória nebola nájdená pre úpravu.');
                        currentCategoryModalMode = 'add'; editingCategoryName = null; editingCategoryRow = null;
                        categoryModal.style.display = 'none'; categoryForm.reset();
                        return;
                    }
                    const oldDocData = oldDocSnapshot.data();

                    // Use a batch write for atomicity for rename+delete
                    const batch = writeBatch(db);

                    // Set data for the new document ID (new category name)
                    batch.set(newCategoryDocRef, oldDocData); // Copy all original data

                    // Delete the old document (old category name)
                    batch.delete(oldCategoryDocRef);

                    // Commit the batch
                    await batch.commit();


                    rowToUpdate.querySelector('td:first-child').textContent = newCategoryName;

                    // TODO: DÔLEŽITÁ POZNÁMKA: Skupiny odkazujúce na starý názov kategórie (`oldCategoryName`)
                    // pomocou poľa `categoryId` NEBUDÚ automaticky aktualizované na nový názov kategórie (`newCategoryName`).
                    // Ak je to potrebné, je nutné vyhľadať všetky skupiny s `categoryId == oldCategoryName`
                    // a aktualizovať ich pole `categoryId` na `newCategoryName`. Táto logika nie je zahrnutá.
                    console.warn(`Premenovanie kategórie "${oldCategoryName}" na "${newCategoryName}" bolo úspešné.`);
                    console.warn(`POZNÁMKA: Skupiny s categoryId "${oldCategoryName}" NEBOLI automaticky aktualizované na "${newCategoryName}".`);


                    currentCategoryModalMode = 'add'; editingCategoryName = null; editingCategoryRow = null;
                    categoryModal.style.display = 'none'; categoryForm.reset();

                     if (window.location.hash === '#skupiny') {
                         // Re-display groups to reflect the category name change in headings and potentially update select options
                          displayGroupsByCategory();
                     }


                } catch (error) {
                    console.error('Chyba pri premenovaní kategórie: ', error);
                    alert('Chyba pri premenovaní kategórie! Prosím, skúste znova.');
                    currentCategoryModalMode = 'add'; editingCategoryName = null; editingCategoryRow = null;
                    categoryModal.style.display = 'none'; form.reset();
                }
            }
        });


         // --- Upravená obsluha formulára na pridanie/úpravu skupiny ---
         groupForm.addEventListener('submit', async (e) => {
             e.preventDefault();

             const selectedCategoryId = groupCategorySelect.value;
             const groupName = groupNameInput.value.trim(); // New/edited group name

             if (selectedCategoryId === '') {
                 alert('Prosím, vyberte kategóriu pre skupinu.');
                 return;
             }
             if (groupName === '') {
                 alert('Názov skupiny nemôže byť prázdny.');
                 return;
             }

             if (currentGroupModalMode === 'add') {
                 // === LOGIKA PRIDÁVANIA SKUPINY s názvom skupiny ako ID ===
                 const groupDocRef = doc(groupsCollectionRef, groupName); // Reference using group name as ID

                 try {
                     // 1. Check if a document with this ID (name) already exists
                     const existingDoc = await getDoc(groupDocRef);

                     if (existingDoc.exists()) {
                         // If document with this name already exists, alert user
                         alert(`Skupina s názvom "${groupName}" už existuje! Skupiny musia mať unikátne názvy (aj naprieč kategóriami).`);
                         return; // Stop process
                     }

                     // 2. If it doesn't exist, use setDoc to write data to the document with the specified ID
                     await setDoc(groupDocRef, {
                         name: groupName,            // Store the name inside the document too
                         categoryId: selectedCategoryId // Store the ID of the selected category
                         // No createdAt field as requested in previous step
                     });

                     console.log(`Skupina "${groupName}" bola úspešne pridaná do kategórie "${selectedCategoryId}" (použitý názov ako ID dokumentu).`);

                     groupModal.style.display = 'none';
                     groupForm.reset();
                     // Reset state
                     currentGroupModalMode = 'add';
                     editingGroupId = null;
                     groupNameInput.oninput = null; // Remove the input listener

                     // After adding, refresh display
                     if (window.location.hash === '#skupiny') {
                         displayGroupsByCategory();
                     }

                 } catch (error) {
                     console.error('Chyba pri pridávaní skupiny: ', error);
                     alert('Chyba pri pridávaní skupiny!');
                 }

             } else if (currentGroupModalMode === 'edit') {
                 // === LOGIKA ÚPRAVY SKUPINY ===
                 const oldGroupId = editingGroupId; // This is the original name/ID
                 const newGroupName = groupName; // The potentially new name
                 const newCategoryId = selectedCategoryId; // The potentially new category

                 if (!oldGroupId) {
                     console.error("Chyba: Režim úpravy skupiny bez platného editingGroupId.");
                     alert("Chyba pri úprave skupiny. Prosím, obnovte stránku.");
                     groupModal.style.display = 'none';
                     groupForm.reset();
                     currentGroupModalMode = 'add'; editingGroupId = null; groupNameInput.oninput = null;
                     return;
                 }

                 const oldGroupDocRef = doc(groupsCollectionRef, oldGroupId);
                 const newGroupDocRef = doc(groupsCollectionRef, newGroupName); // Reference for the potential new document

                 try {
                     if (oldGroupId === newGroupName) {
                         // Scenario 1: Group name (ID) has NOT changed. Just update data.
                         console.log(`Úprava údajov pre skupinu "${oldGroupId}". Názov (ID) sa nemení.`);
                          // Update existing document data using setDoc
                          await setDoc(oldGroupDocRef, {
                              name: newGroupName, // Ensure name field is also up-to-date
                              categoryId: newCategoryId
                          }, { merge: true }); // Use merge: true just in case other fields exist

                     } else {
                         // Scenario 2: Group name (ID) HAS changed. Need to create new doc and delete old one.
                         console.log(`Premenovanie skupiny z "${oldGroupId}" na "${newGroupName}".`);

                         // Check if the new name (potential new ID) already exists
                         const existingDocWithNewName = await getDoc(newGroupDocRef);
                         if (existingDocWithNewName.exists()) {
                              alert(`Skupina s novým názvom "${newGroupName}" už existuje! Skupiny musia mať unikátne názvy (aj naprieč kategóriami).`);
                              return; // Stop if new ID conflicts
                         }

                          // Get current data from the old document (optional but good for copying other fields)
                         const oldDocSnapshot = await getDoc(oldGroupDocRef);
                         if (!oldDocSnapshot.exists()) {
                              console.error(`Pôvodná skupina "${oldGroupId}" nenájdená pre premenovanie.`);
                              alert("Chyba: Pôvodná skupina nebola nájdená pre úpravu.");
                              groupModal.style.display = 'none';
                              groupForm.reset();
                              currentGroupModalMode = 'add'; editingGroupId = null; groupNameInput.oninput = null;
                              return;
                         }
                          const oldGroupData = oldDocSnapshot.data();

                         // Use a batch write for atomicity (optional but recommended for rename+delete)
                         const batch = writeBatch(db);

                         // Set data for the new document ID (new group name)
                         batch.set(newGroupDocRef, {
                              ...oldGroupData, // Copy existing fields if any
                              name: newGroupName, // Ensure the name field is the new name
                              categoryId: newCategoryId // Use the potentially updated category ID
                         });

                         // Delete the old document (old group name)
                         batch.delete(oldGroupDocRef);

                         // Commit the batch
                         await batch.commit();

                         console.log(`Skupina "${oldGroupId}" úspešne premenovaná na "${newGroupName}".`);

                          // DÔLEŽITÁ POZNÁMKA: Ak iné dokumenty (napr. zápasy, hráči)
                          // odkazujú na túto skupinu cez jej ID, tieto odkazy musia
                          // byť aktualizované, aby odkazovali na nové ID dokumentu (`newGroupName`).
                          // Logika na vyhľadanie a aktualizáciu týchto odkazov tu nie je zahrnutá.
                          console.warn("POZNÁMKA: Premenovaním skupiny sa zmenilo jej ID vo Firestore. Ak iné dáta odkazujú na túto skupinu pomocou jej ID, musia byť aktualizované manuálne!");


                     }

                     // Common logic after successful add or edit/rename
                     groupModal.style.display = 'none';
                     groupForm.reset();
                     currentGroupModalMode = 'add';
                     editingGroupId = null;
                     groupNameInput.oninput = null; // Remove the input listener

                     // Refresh display after any change
                     if (window.location.hash === '#skupiny') {
                         displayGroupsByCategory();
                     }


                 } catch (error) {
                     console.error('Chyba pri úprave/premenovaní skupiny: ', error);
                     alert('Chyba pri úprave skupiny! Prosím, skúste znova.');
                      // Close modal and reset state on error
                      groupModal.style.display = 'none';
                      groupForm.reset();
                      currentGroupModalMode = 'add'; editingGroupId = null; groupNameInput.oninput = null;
                 }
             }
         });


    </script>

</body>
</html>
