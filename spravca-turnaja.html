<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Správca turnaja</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="style.css">

    <style>
        /* --- General Styles --- */
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        h2 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #555;
        }

        .container {
            max-width: 1200px; /* Example max width */
            margin: 0 auto; /* Center the container */
            padding: 0 15px; /* Add some padding on the sides */
        }

        /* --- Navigation Styles --- */
        nav ul {
            list-style: none;
            padding: 0;
            text-align: center;
            background-color: #e9ecef;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        nav ul li {
            display: inline-block;
            margin: 0 15px;
        }

        nav ul li a {
            text-decoration: none;
            color: #007bff;
            font-weight: bold;
            padding: 10px 0;
            display: inline-block; /* Make padding work */
        }

        nav ul li a:hover {
            color: #0056b3;
        }

        /* --- Section Styles --- */
        .content-section {
            display: none; /* Hidden by default */
            margin-bottom: 20px;
        }

         /* Use flexbox for sections that contain blocks of content */
        #groupsContent,
        #clubsContent {
            display: none; /* Overridden by JS on toggle */
            flex-direction: column;
            gap: 20px; /* Space between blocks */
        }


        .section-block {
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            overflow-x: auto; /* Allow horizontal scrolling for content block if needed */
        }


        /* --- Table Styles --- */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            border: 1px solid #dee2e6;
            padding: 10px;
            text-align: left;
            vertical-align: top;
        }

        th {
            background-color: #e9ecef;
            font-weight: bold;
            white-space: nowrap; /* Prevent header text wrapping */
        }

        tbody tr:nth-child(odd) {
            background-color: #f8f9fa;
        }

        tbody tr:hover {
            background-color: #e2e6ea;
        }

        .action-button, .delete-button {
            padding: 5px 10px;
            margin-right: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .action-button {
            background-color: #007bff;
            color: white;
        }

        .action-button:hover {
            background-color: #0056b3;
        }

        .delete-button {
            background-color: #dc3545;
            color: white;
        }

        .delete-button:hover {
            background-color: #c82333;
        }

        /* --- Modal Styles --- */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 1000; /* High z-index to be on top */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4); /* Semi-transparent background */
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto; /* 15% from the top and centered */
            padding: 20px;
            border: 1px solid #888;
            width: 80%; /* Could be adjusted */
            max-width: 500px; /* Max width for larger screens */
            border-radius: 8px;
            position: relative; /* Needed for close button absolute positioning */
        }

        .modal-close {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 28px;
            font-weight: bold;
        }

        .modal-close:hover,
        .modal-close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-content h2 {
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .modal-content form {
            display: flex;
            flex-direction: column;
            gap: 15px; /* Space between form groups */
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group select {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1em;
        }

         .form-group input[type="number"] {
             width: auto; /* Adjust width for number input */
         }


        .form-actions {
            display: flex;
            justify-content: flex-end; /* Align buttons to the right */
            gap: 10px; /* Space between buttons */
            margin-top: 15px;
        }

        .form-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
        }

        .form-actions button[type="submit"] {
            background-color: #28a745;
            color: white;
        }

        .form-actions button[type="submit"]:hover {
            background-color: #218838;
        }

        .form-actions button:not([type="submit"]) {
            background-color: #6c757d;
            color: white;
        }

        .form-actions button:not([type="submit"]):hover {
            background-color: #5a6268;
        }

        /* --- Team Creation Specific Styles --- */
         #teamCreationForm .category-count-group {
            display: flex;
            gap: 10px;
            align-items: flex-end; /* Align items to the bottom */
            border: 1px solid #eee;
            padding: 10px;
            border-radius: 4px;
            position: relative; /* For remove button positioning */
         }

        #teamCreationForm .category-count-group .remove-group-button {
             position: absolute;
             top: -10px;
             right: -10px;
             background-color: #dc3545;
             color: white;
             border: none;
             border-radius: 50%;
             width: 20px;
             height: 20px;
             font-size: 0.8em;
             text-align: center;
             line-height: 20px; /* Vertically center the 'X' */
             padding: 0;
             cursor: pointer;
         }

         #teamCreationForm .category-count-group label {
            margin-bottom: 0; /* Reset label margin in flex group */
         }

         #teamCreationForm .category-count-group select,
         #teamCreationForm .category-count-group input[type="number"] {
             flex-grow: 1; /* Allow inputs/selects to grow */
         }


        /* Styles for the created teams table */
        #createdTeamsTable .sub-row {
            display: none; /* Initially hidden */
            background-color: #f1f1f1; /* Different background for sub-rows */
        }

        #createdTeamsTable .sub-row td {
            font-size: 0.9em;
            padding-top: 5px;
            padding-bottom: 5px;
             border-top: none; /* Remove top border for sub-rows */
        }

         /* Style for clickable count cells (removed link appearance) */
        #createdTeamsTable tbody td[data-team-count] {
            color: #333 !important; /* Ensure color is not blue */
            text-decoration: none !important; /* Remove underline */
            cursor: pointer; /* Indicate clickability */
            font-weight: normal;
            font-style: normal;
            outline: none !important; /* Remove focus outline */
        }

         /* Optional: Hover effect for clickable count cells */
        #createdTeamsTable tbody td[data-team-count]:hover {
            color: #007bff; /* Example: Change color on hover */
        }

         /* Style for the clickable base name cell */
        #createdTeamsTable tbody td.base-name-cell {
             cursor: pointer; /* Indicate clickability */
             font-weight: bold; /* Make base name bold */
        }

         /* Optional: Hover effect for base name cell */
         #createdTeamsTable tbody td.base-name-cell:hover {
             text-decoration: underline; /* Add underline on hover */
         }

         /* Style for the clickable category header cells */
         #createdTeamsTable thead th.category-header-cell {
             cursor: pointer; /* Indicate clickability */
             /* Optional: Add background or underline on hover */
             /* &:hover { background-color: #e2e6ea; } */
         }

         /* Style for the clickable "Názov tímu" header cell */
         #createdTeamsTable thead th.base-name-header-cell {
             cursor: pointer; /* Indicate clickability */
             /* Optional: Add hover effect */
             /* &:hover { text-decoration: underline; } */
         }


    </style>
</head>
<body>

    <h1>Správca turnaja</h1>

    <nav class="container">
        <ul>
            <li><a href="#kategorie">Kategórie</a></li>
            <li><a href="#skupiny">Skupiny</a></li>
            <li><a href="#timy-do-skupin">Tímy do skupín (priradené)</a></li>
            <li><a href="#vytvorenie-timov">Vytvorenie Tímov (na priradenie)</a></li>
        </ul>
    </nav>

    <main class="container">
        <button id="addButton" class="add-button" title="Pridať položku">+</button>

        <section id="categoriesContentSection" class="content-section">
            <h2>Kategórie</h2>
            <div class="section-block">
                <table id="categoryTable">
                    <thead>
                        <tr>
                            <th>Názov kategórie</th>
                            <th>Akcie</th>
                        </tr>
                    </thead>
                    <tbody id="categoryTableBody">
                        </tbody>
                </table>
            </div>
        </section>

        <section id="groupsContentSection" class="content-section">
            <h2>Skupiny</h2>
             <div id="groupsContent">
                 </div>
        </section>

        <section id="clubsContentSection" class="content-section">
             <h2>Tímy v Skupinách</h2>
              <div id="clubsContent">
                 </div>
        </section>

         <section id="teamCreationContentSection" class="content-section">
             <h2>Vytvorenie Tímov (Nepriradené)</h2>
              <div class="section-block">
                 <table id="createdTeamsTable">
                     <thead>
                         </thead>
                     <tbody id="createdTeamsTableBody">
                         </tbody>
                 </table>
              </div>
         </section>


    </main>

    <div id="categoryModal" class="modal">
        <div class="modal-content">
            <span class="modal-close category-modal-close">&times;</span>
            <h2 id="categoryModalTitle">Pridať kategóriu</h2>
            <form id="categoryForm">
                <div class="form-group">
                    <label for="categoryName">Názov kategórie:</label>
                    <input type="text" id="categoryName" required>
                </div>
                <div class="form-actions">
                     <button type="submit">Uložiť</button>
                </div>
            </form>
        </div>
    </div>

    <div id="groupModal" class="modal">
        <div class="modal-content">
            <span class="modal-close group-modal-close">&times;</span>
            <h2 id="groupModalTitle">Pridať skupinu</h2>
            <form id="groupForm">
                 <div class="form-group">
                     <label for="groupCategory">Kategória:</label>
                     <select id="groupCategory" required>
                         <option value="">-- Načítavam kategórie --</option>
                     </select>
                 </div>
                <div class="form-group">
                    <label for="groupName">Názov skupiny:</label>
                    <input type="text" id="groupName" required>
                </div>
                <div class="form-actions">
                    <button type="submit">Uložiť</button>
                </div>
            </form>
        </div>
    </div>

    <div id="clubModal" class="modal">
        <div class="modal-content">
            <span class="modal-close club-modal-close">&times;</span>
            <h2 id="clubModalTitle">Priradiť tím do skupiny</h2>
            <form id="clubForm">
                 <div id="unassignedClubSelectContainer" class="form-group">
                      <label for="unassignedClubSelect">Vyberte tím na priradenie:</label>
                      <select id="unassignedClubSelect" required>
                          <option value="">-- Načítavam tímy --</option>
                      </select>
                 </div>

                 <div id="clubNameInputContainer" class="form-group" style="display: none;">
                       <label for="clubName">Názov klubu:</label>
                       <input type="text" id="clubName" required readonly> </div>


                 <div class="form-group">
                     <label for="clubCategory">Kategória:</label>
                     <select id="clubCategory" required>
                         <option value="">-- Vyberte kategóriu --</option>
                     </select>
                 </div>
                 <div class="form-group">
                    <label for="clubGroup">Skupina:</label>
                    <select id="clubGroup" required>
                        <option value="">-- Najprv vyberte kategóriu --</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="submit">Priradiť</button>
                </div>
            </form>
        </div>
    </div>

     <div id="teamCreationModal" class="modal">
        <div class="modal-content">
            <span class="modal-close team-creation-modal-close">&times;</span>
            <h2 id="teamCreationModalTitle">Vytvoriť tímy</h2>
            <form id="teamCreationForm">
                 <div class="form-group">
                     <label for="teamNameInput">Základný názov tímu (napr. MŠK IUVENTA Michalovce):</label>
                     <input type="text" id="teamNameInput" required>
                 </div>

                 <div id="initialCategoryCountGroup" class="form-group category-count-group">
                      <label for="teamCategorySelect">Kategória:</label>
                      <select id="teamCategorySelect" required>
                          <option value="">-- Vyberte kategóriu --</option>
                      </select>
                       <label for="teamCountInput">Počet tímov:</label>
                       <input type="number" id="teamCountInput" value="1" min="1" required>
                 </div>

                 <div id="dynamicCategoryCountContainer">
                     </div>

                 <button type="button" id="addCategoryCountPairButton" class="action-button" style="align-self: flex-start;">Pridať ďalšiu kategóriu</button>


                <div class="form-actions">
                    <button type="submit">Vytvoriť</button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        // === 1. IMPORTS ===
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, query, where, addDoc, updateDoc, writeBatch } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';
        import { FieldPath } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';


        // === 2. FIREBASE CONFIG AND INITIALIZATION ===
        const firebaseConfig = {
            apiKey: "AIzaSyD0h0rQZiIGi0-UDb4-YU_JihRGpIlfz40", // ZMEŇ ZA SVOJ SKUTOČNÝ API KĽÚČ
            authDomain: "turnaj-a28c5.firebaseapp.com", // ZMEŇ ZA SVOJ SKUTOČNÝ authDomain
            projectId: "turnaj-a28c5", // ZMEŇ ZA SVOJ SKUTOČNÝ projectId
            storageBucket: "turnaj-a28c5.firebaseystorage.app", // ZMEŇ ZA SVOJ SKUTOČNÝ storageBucket
            messagingSenderId: "13732191148", // ZMEŇ ZA SVOJ SKUTOČNÝ messagingSenderId
            appId: "1:13732191148:web:5ad78eaef2ad452a10f809" // ZMEŇ ZA SVOJ SKUTOČNÝ appId
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // === 3. FIREBASE COLLECTION REFERENCES ===
        const categoriesCollectionRef = collection(db, 'tournamentData', 'mainTournamentData', 'categories');
        const groupsCollectionRef = collection(db, 'tournamentData', 'mainTournamentData', 'groups'); // Groups use composite IDs
        const clubsCollectionRef = collection(db, 'tournamentData', 'mainTournamentData', 'clubs'); // Clubs now use auto-generated IDs


        // === 4. DOM ELEMENT REFERENCES ===
        const addButton = document.getElementById('addButton');

        // Modál Kategórie
        const categoryModal = document.getElementById('categoryModal');
        const categoryModalCloseBtn = categoryModal.querySelector('.modal-close');
        const categoryForm = document.getElementById('categoryForm');
        const categoryNameInput = document.getElementById('categoryName');
        const categoryModalTitle = document.getElementById('categoryModalTitle');

        // Modál Skupiny
        const groupModal = document.getElementById('groupModal');
        const groupModalCloseBtn = groupModal.querySelector('.modal-close');
        const groupForm = document.getElementById('groupForm');
        const groupCategorySelect = document.getElementById('groupCategory');
        const groupNameInput = document.getElementById('groupName');
        const groupModalTitle = document.getElementById('groupModalTitle');
        const groupFormSubmitButton = groupForm.querySelector('button[type="submit"]');

        // Modál Kluby (pre priradenie do skupín)
        const clubModal = document.getElementById('clubModal');
        const clubModalCloseBtn = clubModal.querySelector('.modal-close');
        const clubForm = document.getElementById('clubForm');
        const clubNameInput = document.getElementById('clubName'); // Existing name input (used when editing assigned)
        const clubCategorySelect = document.getElementById('clubCategory');
        const clubGroupSelect = document.getElementById('clubGroup');
        const clubModalTitle = document.getElementById('clubModalTitle');
        const clubFormSubmitButton = clubForm.querySelector('button[type="submit"]');

        // NEW REFERENCES FOR CLUB MODAL CHANGES (add/edit assigned)
        const unassignedClubSelectContainer = document.getElementById('unassignedClubSelectContainer');
        const unassignedClubSelect = document.getElementById('unassignedClubSelect');
        const clubNameInputContainer = document.getElementById('clubNameInputContainer');


        // NEW: Modál Vytvorenie Tímov
        const teamCreationModal = document.getElementById('teamCreationModal');
        const teamCreationModalCloseBtn = teamCreationModal.querySelector('.modal-close');
        const teamCreationForm = document.getElementById('teamCreationForm');
        const teamNameInput = document.getElementById('teamNameInput'); // Input for base team name

        // References for the initial category/count fields
        const initialCategoryCountGroup = document.getElementById('initialCategoryCountGroup');
        const teamCategorySelect = document.getElementById('teamCategorySelect'); // Initial Category select
        const teamCountInput = document.getElementById('teamCountInput'); // Initial Count input

        // Reference for the container of dynamic fields
        const dynamicCategoryCountContainer = document.getElementById('dynamicCategoryCountContainer');
        // Reference for the button to add more fields
        const addCategoryCountPairButton = document.getElementById('addCategoryCountPairButton');


        const teamCreationModalTitle = document.getElementById('teamCreationModalTitle');


        // Zobrazované sekcie (obalové divy)
        const categoriesContentSection = document.getElementById('categoriesContentSection'); // Obalový div pre kategórie
        const groupsContentDiv = document.getElementById('groupsContent'); // Flex kontajner pre skupiny
        const clubsContentDiv = document.getElementById('clubsContent'); // Flex kontajner pre kluby v skupinách (priradené)
        // NEW: Obalový div pre sekciu Vytvorenie Tímov (nepriradené)
        const teamCreationContentSection = document.getElementById('teamCreationContentSection');


        // Referencie na samotné tabuľky (pre manipuláciu s tbody)
        const categoryTable = document.getElementById('categoryTable');
        const categoryTableBody = document.getElementById('categoryTableBody');

        // NEW: Referencia na tbody tabuľky Vytvorenie Tímov a thead
        const createdTeamsTable = document.getElementById('createdTeamsTable'); // Added reference to the table itself
        const createdTeamsTableHead = createdTeamsTable.querySelector('thead'); // Added reference to thead
        const createdTeamsTableBody = document.getElementById('createdTeamsTableBody');


        // === 5. STATE VARIABLES ===
        let currentCategoryModalMode = 'add';
        let editingCategoryName = null;

        let currentGroupModalMode = 'add';
        let editingGroupId = null; // Kompozitné ID upravovanej skupiny

        // NEW: Premenné stavu pre modál Kluby (Priradenie/Úprava)
        let currentClubModalMode = 'add-assign'; // Default mode: 'add-assign' or 'edit-assigned'
        let editingClubId = null; // Auto-generated ID of the club document being edited

        // NEW: Premenné stavu pre modál Vytvorenie Tímov (zatiaľ len 'add')
        let currentTeamCreationModalMode = 'add';

        // NEW: Cache pre zoznam všetkých kategórií
        let allCategories = [];

        // Premenná príznaku pre debounce toggleContentDisplay
        let isDisplaying = false;

        // Premenná na sledovanie aktívneho filtra kategórie pre tabuľku vytvorených tímov
        let currentCategoryFilter = null;


        // === 6. HELPER FUNCTIONS (called by display/modal functions) ===

        // Funkcia na pridanie riadku kategórie do tabuľky (používa ju loadCategoriesTable)
        function addCategoryRowToTable(categoryName) {
            const tr = document.createElement('tr');
            const nameTd = document.createElement('td');
            nameTd.textContent = categoryName;
            const actionsTd = document.createElement('td');
            actionsTd.style.whiteSpace = 'nowrap';

            const renameButton = document.createElement('button');
            renameButton.textContent = 'Premenovať';
            renameButton.classList.add('action-button');
            renameButton.onclick = function() {
                currentCategoryModalMode = 'edit';
                editingCategoryName = categoryName;
                categoryModalTitle.textContent = 'Premenovať kategóriu';
                categoryNameInput.value = categoryName;
                categoryModal.style.display = 'block';
                categoryNameInput.focus();
            };

            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Vymazať';
            deleteButton.classList.add('action-button', 'delete-button');
            deleteButton.onclick = async function() {
                const categoryToDelete = this.closest('tr').querySelector('td:first-child').textContent;

                if (!confirm(`Naozaj chcete vymazať kategóriu "${categoryToDelete}"? Akékoľvek priradené skupiny a kluby prídu o svoju kategóriu (categoryId a groupId sa nastavia na null)!`)) {
                    return;
                }

                try {
                    const batch = writeBatch(db);

                    // Nájdi a aktualizuj skupiny s touto kategóriou
                    const groupsQuery = query(groupsCollectionRef, where('categoryId', '==', categoryToDelete));
                    const groupsSnapshot = await getDocs(groupsQuery);

                    const clubUpdates = [];
                    for (const groupDoc of groupsSnapshot.docs) {
                        const clubsInGroupQuery = query(clubsCollectionRef, where('groupId', '==', groupDoc.id));
                        const clubsSnapshot = await getDocs(clubsInGroupQuery);
                        clubsSnapshot.forEach(clubDoc => {
                            clubUpdates.push({
                                ref: clubDoc.ref,
                                updates: {
                                    categoryId: null,
                                    groupId: null
                                }
                            }); // Update club with null categoryId and null groupId
                            console.log(`Klub "${clubDoc.id}" odpriradený kvôli zmazaniu skupiny.`);
                        });
                        batch.delete(groupDoc.ref); // Delete old group doc
                        console.log(`Stará skupina "${groupDoc.id}" zmazaná po premenovaní kategórie.`); // Clarified log
                    }

                    clubUpdates.forEach(item => {
                        batch.update(item.ref, item.updates);
                    });

                    // Nájdi a aktualizuj kluby s touto kategóriou, ktoré už nemusia byť priradené k skupine (groupId == null)
                    const unassignedClubsQuery = query(clubsCollectionRef, where('categoryId', '==', categoryToDelete), where('groupId', '==', null));
                    const unassignedClubsSnapshot = await getDocs(unassignedClubsQuery);
                    unassignedClubsSnapshot.forEach(doc => {
                        batch.update(doc.ref, {
                            categoryId: null
                        }); // Just update categoryId to null
                        console.log(`Nepriradený klub "${doc.id}" aktualizovaný (categoryId).`);
                    });

                    batch.delete(doc(categoriesCollectionRef, categoryToDelete)); // Delete old category doc using old name

                    await batch.commit();

                    console.log(`Kategória "${categoryToDelete}" a súvisiace referencie boli úspešne zmazané/aktualizované.`);

                    loadCategoriesTable(); // Always refresh category table
                    if (window.location.hash === '#skupiny') displayGroupsByCategory();
                    if (window.location.hash === '#timy-do-skupin') displayClubs();
                    if (window.location.hash === '#vytvorenie-timov') displayCreatedTeams();

                    cacheAllCategories(); // Refresh cached categories after deletion


                } catch (error) {
                    console.error('Chyba pri mazaní kategórie a súvisiacich dát: ', error);
                    alert('Chyba pri mazaní kategórie! Prosím, skúste znova.');
                    categoryModal.style.display = 'none';
                    categoryForm.reset();
                    currentCategoryModalMode = 'add';
                    editingCategoryName = null;
                }
            };

            actionsTd.appendChild(renameButton);
            actionsTd.appendChild(deleteButton);
            tr.appendChild(nameTd);
            tr.appendChild(actionsTd);
            categoryTableBody.appendChild(tr); // Append directly to tbody
        }


        // NEW: Cache all categories for dynamic select population
        async function cacheAllCategories() {
            try {
                const querySnapshot = await getDocs(categoriesCollectionRef);
                // Sort categories alphabetically by name (doc.id)
                allCategories = querySnapshot.docs.map(doc => doc.id).sort();
                console.log(`Cached ${allCategories.length} categories.`);
            } catch (error) {
                console.error('Error caching categories:', error);
                allCategories = []; // Clear cache on error
            }
        }


        // Funkcia na načítanie kategórií a naplnenie <select> (používa ju populateGroupSelect, openGroupModal, openClubModal, teamCreationForm logic)
        async function populateCategorySelect(selectElement, selectedCategoryId = null, excludedCategoryIds = []) {
            selectElement.innerHTML = '<option value="">-- Vyberte kategóriu --</option>';
            selectElement.disabled = true; // Disable while loading

            try {
                const categoriesToPopulate = allCategories.length > 0 ? allCategories : (await getDocs(categoriesCollectionRef)).docs.map(doc => doc.id).sort();
                if (allCategories.length === 0 && categoriesToPopulate.length > 0) {
                    console.log("Populating from fresh fetch, caching now.");
                    allCategories = categoriesToPopulate; // Cache if fetched fresh
                }

                if (categoriesToPopulate.length === 0) {
                    console.log("Žiadne kategórie pre naplnenie selectu.");
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "-- Žiadne kategórie --";
                    option.disabled = true;
                    selectElement.appendChild(option);
                    selectElement.disabled = false;
                } else {
                    selectElement.disabled = false;
                    const availableCategories = categoriesToPopulate.filter(catId => !excludedCategoryIds.includes(catId));

                    if (availableCategories.length === 0) {
                        const option = document.createElement('option');
                        option.value = "";
                        option.textContent = "-- Žiadne dostupné kategórie --";
                        option.disabled = true;
                        selectElement.appendChild(option);
                    } else {
                        availableCategories.forEach((categoryName) => {
                            const option = document.createElement('option');
                            option.value = categoryName;
                            option.textContent = categoryName;
                            selectElement.appendChild(option);
                        });

                        if (selectedCategoryId && !Array.isArray(selectedCategoryId)) {
                            if (selectElement.querySelector(`option[value="${selectedCategoryId}"]`)) {
                                selectElement.value = selectedCategoryId;
                            } else {
                                console.warn(`Kategória "${selectedCategoryId}" pre zvolenú položku nenájdená v zozname dostupných kategórií.`);
                                selectElement.value = "";
                            }
                        } else if (Array.isArray(selectedCategoryId)) {
                            console.warn("populateCategorySelect received an array for selectedCategoryId but select is not multiple.");
                            selectElement.value = "";
                        }
                    }
                }
            } catch (error) {
                console.error('Chyba pri načítaní kategórií pre select: ', error);
                selectElement.innerHTML = '<option value="">Chyba pri načítaní kategórií</option>';
                selectElement.disabled = true;
            } finally {
                if (allCategories.length === 0) {
                    cacheAllCategories(); // Attempt to cache after initial load
                }
            }
        }

        // Funkcia na načítanie skupín pre danú kategóriu a naplnenie <select> (používa ju populateUnassignedClubsSelect, openClubModal)
        async function populateGroupSelect(categoryId, selectElement, selectedGroupId = null) {
            selectElement.innerHTML = '<option value="">-- Vyberte skupinu --</option>';
            selectElement.disabled = true;


            if (!categoryId || categoryId === '-- Vyberte kategóriu --') {
                selectElement.innerHTML = '<option value="">-- Najprv vyberte kategóriu --</option>';
                selectElement.disabled = true;
                return;
            }

            selectElement.disabled = true;

            try {
                const q = query(groupsCollectionRef, where('categoryId', '==', categoryId));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    console.log(`Žiadne skupiny nájdené pre kategóriu "${categoryId}".`);
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "-- Žiadne skupiny v kategórii --";
                    option.disabled = true;
                    selectElement.appendChild(option);

                } else {
                    console.log(`Načítané skupín pre kategóriu "${categoryId}".`);
                    const sortedDocs = querySnapshot.docs.sort((a, b) => (a.data().name || '').localeCompare(b.data().name || ''));

                    sortedDocs.forEach((doc) => {
                        const groupData = doc.data();
                        const groupId = doc.id;
                        const groupName = groupData.name;

                        const option = document.createElement('option');
                        option.value = groupId;
                        option.textContent = groupName;
                        selectElement.appendChild(option);
                    });

                    if (selectedGroupId) {
                        if (selectElement.querySelector(`option[value="${selectedGroupId}"]`)) {
                            selectElement.value = selectedGroupId;
                        } else {
                            console.warn(`Skupina "${selectedGroupId}" pre zvolenú položku nenájdená v zozname skupín pre túto kategóriu.`);
                            selectElement.value = "";
                        }
                    }
                }
                selectElement.disabled = false;

            } catch (error) {
                console.error('Chyba pri načítaní skupín pre select: ', error);
                selectElement.innerHTML = '<option value="">Chyba pri načítaní skupín</option>';
                selectElement.disabled = true;
            }
        }


        // NEW: Funkcia na načítanie nepriradených tímov a naplnenie selectu v modáli klubu (používa ju openClubModal)
        async function populateUnassignedClubsSelect(selectElement, selectedClubId = null) {
            selectElement.innerHTML = '<option value="">-- Vyberte tím na priradenie --</option>';
            selectElement.disabled = true;

            try {
                const q = query(clubsCollectionRef, where('groupId', '==', null));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    console.log("Žiadne nepriradené tímy na priradenie.");
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "-- Žiadne tímy na priradenie --";
                    option.disabled = true;
                    selectElement.appendChild(option);
                    selectElement.disabled = false;
                } else {
                    selectElement.disabled = false;
                    const sortedDocs = querySnapshot.docs.sort((a, b) => (a.data.name || '').localeCompare(b.data.name || ''));

                    sortedDocs.forEach((doc) => {
                        const clubData = doc.data();
                        const clubId = doc.id;

                        const option = document.createElement('option');
                        option.value = clubId;
                        option.textContent = clubData.name;
                        selectElement.appendChild(option);
                    });

                    if (selectedClubId) {
                        if (selectElement.querySelector(`option[value="${selectedClubId}"]`)) {
                            selectElement.value = selectedClubId;
                        } else {
                            console.warn(`Nepriradený tím s ID "${selectedClubId}" nenájdený.`);
                            selectElement.value = "";
                        }
                    }
                }
            } catch (error) {
                console.error('Chyba pri načítaní nepriradených tímov pre select: ', error);
                selectElement.innerHTML = '<option value="">Chyba pri načítaní tímov</option>';
                selectElement.disabled = true;
            }
        }

        // NEW: Function to update the available options in all category selects (for Team Creation Modal)
        // Uses populateCategorySelect
        function updateCategorySelectOptions() {
            const selectedCategoryIds = [];
            const initialSelect = initialCategoryCountGroup.querySelector('select');
            if (initialSelect.value !== '') {
                selectedCategoryIds.push(initialSelect.value);
            }

            const dynamicGroups = dynamicCategoryCountContainer.querySelectorAll('.category-count-group');
            dynamicGroups.forEach(groupDiv => {
                const categorySelect = groupDiv.querySelector('select');
                if (categorySelect.value !== '') {
                    selectedCategoryIds.push(categorySelect.value);
                }
            });

            const otherSelectedCategoryIdsForInitial = selectedCategoryIds.filter(id => id !== initialSelect.value);
            populateCategorySelect(initialSelect, initialSelect.value, otherSelectedCategoryIdsForInitial);

            dynamicGroups.forEach(groupDiv => {
                const categorySelect = groupDiv.querySelector('select');
                const otherSelectedCategoryIdsForDynamic = selectedCategoryIds.filter(id => id !== categorySelect.value);
                populateCategorySelect(categorySelect, categorySelect.value, otherSelectedCategoryIdsForDynamic);
            });
        }

        // NEW: Helper function to derive the base name from a full team name (e.g., "Team A" -> "Team")
        // Uses it displayCreatedTeams
         function getBaseTeamName(fullTeamName) {
             if (!fullTeamName) return 'Neznámy názov';
             const parts = fullTeamName.trim().split(' ');
             if (parts.length > 1) {
                  const lastPart = parts[parts.length - 1];
                  const suffixRegex = /^[A-Z]$|^\d+$/;

                  if (suffixRegex.test(lastPart)) {
                       return parts.slice(0, -1).join(' ');
                   }
             }
             return fullTeamName;
         }


        // === 7. DISPLAY FUNCTIONS (Load and show section content) ===

        // Funkcia na zobrazenie kategórií (používa addCategoryRowToTable)
        async function loadCategoriesTable() {
            try {
                categoryTableBody.innerHTML = ''; // Clear existing rows
                const querySnapshot = await getDocs(categoriesCollectionRef);
                if (querySnapshot.empty) {
                    console.log("Žiadne kategórie nenájdené.");
                    const noDataRow = document.createElement('tr');
                    const td = document.createElement('td');
                    td.colSpan = 2;
                    td.textContent = "Žiadne kategórie zatiaľ pridané.";
                    td.style.textAlign = 'center';
                    noDataRow.appendChild(td);
                    categoryTableBody.appendChild(noDataRow);
                } else {
                    const sortedDocs = querySnapshot.docs.sort((a, b) => a.id.localeCompare(b.id));
                    sortedDocs.forEach((doc) => {
                        const categoryName = doc.id;
                        addCategoryRowToTable(categoryName);
                    });
                    console.log(`Načítaných kategórií: ${sortedDocs.length}`);
                }
            } catch (error) {
                console.error('Chyba pri načítaní kategórií: ', error);
                alert('Chyba pri načítaní kategórií!');
                const errorRow = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = 2;
                td.textContent = "Chyba pri načítaní kategórií.";
                td.style.textAlign = 'center';
                errorRow.appendChild(td);
                categoryTableBody.appendChild(errorRow);
            }
        }

        // Funkcia na zobrazenie skupín usporiadaných podľa kategórií (používa openGroupModal)
        async function displayGroupsByCategory() {
            groupsContentDiv.innerHTML = ''; // Clear container

            try {
                const categoriesSnapshot = await getDocs(categoriesCollectionRef);
                const sortedCategoriesDocs = categoriesSnapshot.docs.sort((a, b) => a.id.localeCompare(b.id));
                const categories = sortedCategoriesDocs.map(doc => doc.id);

                if (categories.length === 0) {
                    const message = document.createElement('p');
                    message.textContent = "Pridajte kategórie v sekcii 'Kategórie' pre zobrazenie skupín.";
                    groupsContentDiv.appendChild(message);
                    return;
                }

                const groupsSnapshot = await getDocs(groupsCollectionRef);

                const groupsByCategory = {};
                groupsSnapshot.forEach(doc => {
                    const groupData = doc.data();
                    const groupId = doc.id;
                    const categoryId = groupData.categoryId;

                    if (categoryId && categoryId !== 'null') {
                        if (!groupsByCategory[categoryId]) {
                            groupsByCategory[categoryId] = [];
                        }
                        groupsByCategory[categoryId].push({
                            id: groupId,
                            data: groupData
                        });
                    } else {
                        console.warn(`Skupina ${groupId} nemá priradenú categoryId.`);
                    }
                });

                categories.forEach(categoryName => {
                    const groupsForThisCategory = groupsByCategory[categoryName] || [];

                    const categorySectionDiv = document.createElement('div');
                    categorySectionDiv.classList.add('category-group-section', 'section-block');

                    const categoryHeading = document.createElement('h2');
                    categoryHeading.textContent = `${categoryName}`;
                    categorySectionDiv.appendChild(categoryHeading);

                    const categoryGroupsTable = document.createElement('table');
                    categoryGroupsTable.classList.add('category-group-table');

                    const thead = document.createElement('thead');
                    const headerRow = document.createElement('tr');
                    const groupNameTh = document.createElement('th');
                    groupNameTh.textContent = 'Názov';
                    const actionsTh = document.createElement('th');
                    actionsTh.textContent = 'Akcie';
                    actionsTh.style.width = '150px';

                    headerRow.appendChild(groupNameTh);
                    headerRow.appendChild(actionsTh);
                    thead.appendChild(headerRow);
                    categoryGroupsTable.appendChild(thead);

                    const tbody = document.createElement('tbody');

                    if (groupsForThisCategory.length === 0) {
                        const noGroupsRow = document.createElement('tr');
                        const td = document.createElement('td');
                        td.colSpan = 2;
                        td.textContent = `V kategórii "${categoryName}" zatiaľ nie sú žiadne skupiny.`;
                        td.style.textAlign = 'center';
                        tbody.appendChild(noGroupsRow);
                    } else {
                        groupsForThisCategory.sort((a, b) => (a.data.name || '').localeCompare(b.data.name || ''));

                        groupsForThisCategory.forEach(group => {
                            const groupRow = document.createElement('tr');
                            const groupNameTd = document.createElement('td');
                            groupNameTd.textContent = group.data.name;


                            const groupActionsTd = document.createElement('td');
                            groupActionsTd.style.whiteSpace = 'nowrap';

                            const editGroupButton = document.createElement('button');
                            editGroupButton.textContent = 'Premenovať';
                            editGroupButton.classList.add('action-button');
                            editGroupButton.onclick = () => {
                                openGroupModal(group.id, group.data);
                            };

                            const deleteGroupButton = document.createElement('button');
                            deleteGroupButton.textContent = 'Vymazať';
                            deleteGroupButton.classList.add('action-button', 'delete-button');
                            deleteGroupButton.onclick = async () => {
                                if (!confirm(`Naozaj chcete vymazať skupinu "${group.data.name}" z kategórie "${group.data.categoryId}"? Tímy priradené k tejto skupine prídu o priradenie (groupId sa nastaví na null)!`)) {
                                    return;
                                }
                                try {
                                    const batch = writeBatch(db);

                                    const clubsInGroupQuery = query(clubsCollectionRef, where('groupId', '==', group.id));
                                    const clubsSnapshot = await getDocs(clubsInGroupQuery);
                                    clubsSnapshot.forEach(doc => {
                                        batch.update(doc.ref, {
                                            groupId: null
                                        });
                                        console.log(`Klub "${doc.id}" odpriradený zo skupiny "${group.id}".`);
                                    });

                                    batch.delete(doc(groupsCollectionRef, group.id));

                                    await batch.commit();

                                    console.log(`Skupina "${group.data.name}" (ID: ${group.id}) a súvisiace kluby boli úspešne zmazané/aktualizované.`);

                                    displayGroupsByCategory();
                                    if (window.location.hash === '#timy-do-skupin') displayClubs();
                                    if (window.location.hash === '#vytvorenie-timov') displayCreatedTeams();


                                } catch (error) {
                                    console.error('Chyba pri mazaní skupiny a súvisiacich dát: ', error);
                                    alert('Chyba pri mazaní skupiny! Prosím, skúste znova.');
                                }
                            };

                            groupActionsTd.appendChild(editGroupButton);
                            groupActionsTd.appendChild(deleteGroupButton);

                            groupRow.appendChild(groupNameTd);
                            groupRow.appendChild(groupActionsTd);
                            tbody.appendChild(groupRow);
                        });
                    }

                    categoryGroupsTable.appendChild(tbody);
                    categorySectionDiv.appendChild(categoryGroupsTable);
                    groupsContentDiv.appendChild(categorySectionDiv);
                });


            } catch (error) {
                console.error('Chyba pri načítaní alebo zobrazovaní skupín: ', error);
                const errorMessage = document.createElement('p');
                errorMessage.textContent = 'Chyba pri načítaní dát skupín.';
                groupsContentDiv.appendChild(errorMessage);
            }
        }


        // Funkcia na zobrazenie klubov usporiadaných podľa kategórií a skupín (PRIRADENÉ tímy) (používa openClubModal)
        async function displayClubs() {
            clubsContentDiv.innerHTML = ''; // Vyčistiť kontajner

            try {
                const q = query(clubsCollectionRef, where('groupId', '!=', null));
                const clubsSnapshot = await getDocs(q);

                const clubs = clubsSnapshot.docs.map(clubDoc => ({
                    id: clubDoc.id,
                    data: clubDoc.data()
                }));

                if (clubs.length === 0) {
                    console.log("Žiadne kluby priradené do skupín nenájdené.");
                    const message = document.createElement('p');
                    message.textContent = "Žiadne kluby zatiaľ neboli priradené do skupín.";
                    clubsContentDiv.appendChild(message);
                    return;
                }

                const clubsByCategoryAndGroup = {};
                clubs.forEach(club => {
                    const categoryId = club.data.categoryId;
                    const groupId = club.data.groupId;

                    if (categoryId && groupId && categoryId !== 'null' && groupId !== 'null') {
                        if (!clubsByCategoryAndGroup[categoryId]) {
                            clubsByCategoryAndGroup[categoryId] = {};
                        }
                        if (!clubsByCategoryAndGroup[categoryId][groupId]) {
                            clubsByCategoryAndGroup[categoryId][groupId] = [];
                        }
                        clubsByCategoryAndGroup[categoryId][groupId].push(club);
                    } else {
                        console.warn(`Klub ${club.id} priradený do skupiny (groupId != null) nemá platnú categoryId (${categoryId}) alebo groupId (${groupId}).`);
                    }
                });

                const sortedCategories = Object.keys(clubsByCategoryAndGroup).sort();

                if (sortedCategories.length === 0 && clubs.length > 0) {
                    console.warn("Kluby boli nájdené, ale žiadne nemajú platné categoryId/groupId na zobrazenie v skupinách.");
                    const message = document.createElement('p');
                    message.textContent = "Existujú kluby, ale žiadne nemajú priradenú kategóriu a skupinu pre zobrazenie tu.";
                    clubsContentDiv.appendChild(message);
                    return;
                }


                sortedCategories.forEach(categoryId => {
                    const sortedGroups = Object.keys(clubsByCategoryAndGroup[categoryId]).sort();

                    sortedGroups.forEach(groupId => {
                        const clubsInThisGroup = clubsByCategoryAndGroup[categoryId][groupId];

                        const groupClubSectionDiv = document.createElement('div');
                        groupClubSectionDiv.classList.add('section-block');

                        const groupNameParts = groupId.split(' - ');
                        const groupName = groupNameParts.length > 1 ? groupNameParts.slice(1).join(' - ') : groupId;

                        const sectionHeading = document.createElement('h2');
                        sectionHeading.textContent = `${categoryId} - ${groupName}`;
                        groupClubSectionDiv.appendChild(sectionHeading);

                        const clubTable = document.createElement('table');
                        clubTable.classList.add('group-clubs-table');

                        const thead = document.createElement('thead');
                        const headerRow = document.createElement('tr');
                        const clubNameTh = document.createElement('th');
                        clubNameTh.textContent = 'Názov klubu';
                        const actionsTh = document.createElement('th');
                        actionsTh.textContent = 'Akcie';
                        actionsTh.style.width = '150px';

                        headerRow.appendChild(clubNameTh);
                        headerRow.appendChild(actionsTh);
                        thead.appendChild(headerRow);
                        clubTable.appendChild(thead);


                        const tbody = document.createElement('tbody');

                        if (clubsInThisGroup.length === 0) {
                            const noClubsRow = document.createElement('tr');
                            const td = document.createElement('td');
                            td.colSpan = 2;
                            td.textContent = `Žiadne kluby v tejto skupine.`;
                            td.style.textAlign = 'center';
                            tbody.appendChild(noClubsRow);
                        } else {
                            clubsInThisGroup.sort((a, b) => (a.data.name || '').localeCompare(b.data.name || ''));

                            clubsInThisGroup.forEach(club => {
                                const tr = document.createElement('tr');

                                const nameTd = document.createElement('td');
                                nameTd.textContent = club.data.name;

                                const actionsTd = document.createElement('td');
                                actionsTd.style.whiteSpace = 'nowrap';

                                const editClubButton = document.createElement('button');
                                editClubButton.textContent = 'Upraviť';
                                editClubButton.classList.add('action-button');
                                editClubButton.onclick = () => {
                                    openClubModal(club.id, club.data);
                                };
                                actionsTd.appendChild(editClubButton);

                                const deleteClubButton = document.createElement('button');
                                deleteClubButton.textContent = 'Vymazať';
                                deleteClubButton.classList.add('action-button', 'delete-button');
                                deleteClubButton.onclick = async () => {
                                    if (!confirm(`Naozaj chcete zmazať tím "${club.data.name}" zo skupiny "${groupId}"? Túto akciu nemožno vrátiť späť!`)) {
                                        return;
                                    }
                                    try {
                                        await deleteDoc(doc(clubsCollectionRef, club.id));

                                        console.log(`Tím "${club.data.name}" (ID: ${club.id}) bol úspešne zmazaný.`);

                                        if (window.location.hash === '#timy-do-skupin') displayClubs();
                                        if (window.location.hash === '#vytvorenie-timov') displayCreatedTeams();


                                    } catch (error) {
                                        console.error('Chyba pri mazaní klubu: ', error);
                                        alert('Chyba pri mazaní klubu! Prosím, skúste znova.');
                                    }
                                };
                                actionsTd.appendChild(deleteClubButton);


                                tr.appendChild(nameTd);
                                tr.appendChild(actionsTd);
                                tbody.appendChild(tr);
                            });
                        }

                        clubTable.appendChild(tbody);
                        groupClubSectionDiv.appendChild(clubTable);
                        clubsContentDiv.appendChild(groupClubSectionDiv);
                    });
                });


            } catch (error) {
                console.error('Chyba pri načítaní alebo zobrazovaní priradených klubov: ', error);
                const errorMessage = document.createElement('p');
                errorMessage.textContent = 'Chyba pri načítaní dát priradených klubov.';
                clubsContentDiv.appendChild(errorMessage);
            }
        }

        // Funkcia na zobrazenie vytvorených tímov (klubov, ktoré ešte nie sú priradené do skupiny) (používa getBaseTeamName)
        async function displayCreatedTeams() {
            console.log("displayCreatedTeams called.");
            createdTeamsTableBody.innerHTML = '';
            createdTeamsTableHead.innerHTML = '';

            try {
                const q = query(clubsCollectionRef, where('groupId', '==', null));
                const querySnapshot = await getDocs(q);
                const unassignedTeams = querySnapshot.docs.map(doc => ({
                    id: doc.id,
                    data: doc.data()
                }));
                 console.log(`Workspaceed ${unassignedTeams.length} unassigned teams.`);

                const categoriesToDisplay = allCategories.length > 0 ? allCategories : (await getDocs(categoriesCollectionRef)).docs.map(doc => doc.id).sort();
                 console.log(`Categories for display: ${categoriesToDisplay.join(', ')}`);

                if (unassignedTeams.length === 0) {
                    console.log("Žiadne tímy na priradenie do skupín zatiaľ nenájdené.");
                    const noDataRow = document.createElement('tr');
                    const td = document.createElement('td');
                    td.colSpan = categoriesToDisplay.length + 1;
                    td.textContent = "Žiadne tímy na priradenie zatiaľ pridané.";
                    td.style.textAlign = 'center';
                    noDataRow.appendChild(td);
                    createdTeamsTableBody.appendChild(noDataRow);
                    return;
                }

                const teamNames = new Set();
                const teamsByBaseNameAndCategory = {};
                const allSubRowsData = {};

                unassignedTeams.forEach(team => {
                    const fullTeamName = team.data.name;
                    const baseName = getBaseTeamName(fullTeamName);
                    const categoryId = team.data.categoryId || 'Nepriradená';

                    teamNames.add(baseName);

                    if (!teamsByBaseNameAndCategory[baseName]) {
                        teamsByBaseNameAndCategory[baseName] = {};
                    }
                    if (!teamsByBaseNameAndCategory[baseName][categoryId]) {
                        teamsByBaseNameAndCategory[baseName][categoryId] = [];
                    }
                    teamsByBaseNameAndCategory[baseName][categoryId].push(team);

                    if (!allSubRowsData[baseName]) {
                         allSubRowsData[baseName] = [];
                     }
                     allSubRowsData[baseName].push(team);

                });

                const sortedBaseNames = Array.from(teamNames).sort();
                 console.log(`Sorted base names: ${sortedBaseNames.join(', ')}`);


                // 4. Vytvoriť hlavičku tabuľky
                const headerRow = document.createElement('tr');
                const teamNameHeader = document.createElement('th');
                teamNameHeader.textContent = 'Názov tímu';
                teamNameHeader.classList.add('base-name-header-cell');
                teamNameHeader.style.cursor = 'pointer';
                 teamNameHeader.addEventListener('click', function() {
                      console.log('"Názov tímu" header clicked.');
                       const allMainRows = createdTeamsTableBody.querySelectorAll('tr[data-base-name]');
                       const isFirstRowVisible = allMainRows.length > 0 ? allMainRows[0].style.display !== 'none' : false;

                       allMainRows.forEach(mainRow => {
                            mainRow.style.display = isFirstRowVisible ? 'none' : 'table-row';
                            mainRow.setAttribute('data-sub-rows-visible', 'false');
                       });

                       createdTeamsTableBody.querySelectorAll('tr.sub-row').forEach(subRow => {
                           subRow.style.display = 'none';
                       });

                       currentCategoryFilter = null;
                       console.log(`All rows ${isFirstRowVisible ? 'hidden' : 'shown'}. Category filter cleared.`);
                 });


                headerRow.appendChild(teamNameHeader);

                const sortedCategoriesForHeader = categoriesToDisplay.sort();
                const categoryThElements = [];

                sortedCategoriesForHeader.forEach(categoryName => {
                    const th = document.createElement('th');
                    th.textContent = categoryName;
                    th.classList.add('category-header-cell');
                    th.setAttribute('data-category-name', categoryName);
                    th.style.cursor = 'pointer';
                    headerRow.appendChild(th);
                    categoryThElements.push(th);
                });

                createdTeamsTableHead.appendChild(headerRow);


                // === ADD LISTENERS TO THE CATEGORY TH ELEMENTS ===
                const fullHeaderThs = Array.from(headerRow.querySelectorAll('th'));

                categoryThElements.forEach(th => {
                     th.addEventListener('click', function() {
                          console.log("Category header clicked:", this.textContent);

                          createdTeamsTableBody.querySelectorAll('tr.sub-row').forEach(subRow => {
                              subRow.style.display = 'none';
                          });
                           createdTeamsTableBody.querySelectorAll('tr[data-base-name]').forEach(mainRow => {
                               mainRow.setAttribute('data-sub-rows-visible', 'false');
                           });

                          const clickedCategory = this.getAttribute('data-category-name');


                          if (currentCategoryFilter === clickedCategory) {
                              currentCategoryFilter = null;
                              console.log(`Filter for category "${clickedCategory}" cleared.`);
                              createdTeamsTableBody.querySelectorAll('tr[data-base-name]').forEach(mainRow => {
                                  mainRow.style.display = 'table-row';
                              });
                          } else {
                              currentCategoryFilter = clickedCategory;
                              console.log(`Filtering by category: "${clickedCategory}".`);

                              // Find the index of the clicked TH within the entire header row
                              const clickedThIndexInFullHeader = fullHeaderThs.indexOf(this);
                               console.log(`Clicked TH index in full header: ${clickedThIndexInFullHeader}`);


                              createdTeamsTableBody.querySelectorAll('tr[data-base-name]').forEach(mainRow => {
                                   const mainRowTds = mainRow.querySelectorAll('td');

                                   if (clickedThIndexInFullHeader < mainRowTds.length) {
                                       const countTd = mainRowTds[clickedThIndexInFullHeader];

                                        const countText = countTd ? countTd.textContent.trim() : '';
                                        const countValue = countText !== '' ? parseInt(countText, 10) : 0;
                                        const baseNameForLog = mainRow.querySelector('td.base-name-cell') ? mainRow.querySelector('td.base-name-cell').textContent : 'Unknown Base Name';

                                        console.group(`--- Processing row: "${baseNameForLog}" ---`);
                                        console.log(`    Checking category "${clickedCategory}" (TH index ${clickedThIndexInFullHeader}).`);
                                        console.log(`    Row has ${mainRowTds.length} TD cells.`);
                                        console.log(`    Target TD content: "${countText}". Parsed count: ${countValue}.`);
                                        const showRowCondition = countTd && countValue > 0;
                                        console.log(`    Condition (countTd && countValue > 0): ${showRowCondition}`);


                                        if (showRowCondition) {
                                            console.log("    Condition met: Setting display to 'table-row'.");
                                            mainRow.style.display = 'table-row';
                                        } else {
                                            console.log("    Condition not met: Setting display to 'none'.");
                                            mainRow.style.display = 'none';
                                        }
                                        console.log(`    Current display style after setting: ${mainRow.style.display}`);

                                        console.groupEnd();
                                   } else {
                                       const baseNameForLog = mainRow.querySelector('td.base-name-cell') ? mainRow.querySelector('td.base-name-cell').textContent : 'Unknown Base Name';
                                       console.warn(`--- Row: "${baseNameForLog}" ---`);
                                       console.warn(`    Does not have enough cells (has ${mainRowTds.length}, needs index ${clickedThIndexInFullHeader}) for category "${clickedCategory}". Hiding row.`);
                                       mainRow.style.display = 'none';
                                   }
                              });
                           }
                      });
                 });


            // 5. Vytvoriť telo tabuľky
            sortedBaseNames.forEach(baseName => {
                const tr = document.createElement('tr');
                tr.setAttribute('data-base-name', baseName);
                tr.setAttribute('data-sub-rows-visible', 'false');


                // First cell: Team Base Name - MAKE IT CLICKABLE
                const nameTd = document.createElement('td');
                nameTd.textContent = baseName;
                nameTd.classList.add('base-name-cell');
                nameTd.style.cursor = 'pointer';


                // Click listener for the base name cell (Toggles sub-rows for this base name)
                nameTd.addEventListener('click', function() {
                     console.log(`Base name cell clicked: "${this.textContent}"`);
                     const mainRow = this.parentElement;
                     const currentBaseName = mainRow.getAttribute('data-base-name');
                     const isVisible = mainRow.getAttribute('data-sub-rows-visible') === 'true';

                     createdTeamsTableBody.querySelectorAll('tr.sub-row').forEach(subRow => {
                         subRow.style.display = 'none';
                     });
                      createdTeamsTableBody.querySelectorAll('tr[data-base-name]').forEach(row => {
                         if (row !== mainRow) row.setAttribute('data-sub-rows-visible', 'false');
                     });


                     if (isVisible) {
                         mainRow.setAttribute('data-sub-rows-visible', 'false');
                         console.log(`Sub-rows for "${currentBaseName}" hidden.`);
                     } else {
                         const existingSubRowsForBaseName = createdTeamsTableBody.querySelectorAll(`tr.sub-row[data-base-name="${currentBaseName}"]`);

                         if (existingSubRowsForBaseName.length === 0) {
                              const teamsDataForBaseName = allSubRowsData[currentBaseName] || [];
                              console.log(`Sub-rows for "${currentBaseName}" not found in DOM, creating and showing.`);

                              teamsDataForBaseName.forEach(team => {
                                  const subRow = document.createElement('tr');
                                  subRow.classList.add('sub-row');
                                  subRow.setAttribute('data-base-name', currentBaseName);
                                  subRow.setAttribute('data-category', team.data.categoryId || 'Nepriradená');

                                  const subNameTd = document.createElement('td');
                                  subNameTd.textContent = team.data.name;
                                  subNameTd.style.paddingLeft = '35px';

                                  sortedCategoriesForHeader.forEach(cat => {
                                      const categoryCell = document.createElement('td');
                                       if (team.data.categoryId === cat) {
                                           categoryCell.textContent = '1';
                                           categoryCell.style.textAlign = 'center';
                                       } else {
                                           categoryCell.textContent = '';
                                       }
                                       subRow.appendChild(categoryCell);
                                   });


                                  subRow.insertBefore(subNameTd, subRow.firstChild);
                                 subRow.style.display = 'table-row';

                                 mainRow.parentElement.insertBefore(subRow, mainRow.nextSibling);
                              });
                         } else {
                              console.log(`Sub-rows for "${currentBaseName}" found in DOM, showing.`);
                             existingSubRowsForBaseName.forEach(subRow => {
                                 subRow.style.display = 'table-row';
                             });
                         }

                         mainRow.setAttribute('data-sub-rows-visible', 'true');

                         currentCategoryFilter = null;
                          createdTeamsTableBody.querySelectorAll('tr[data-base-name]').forEach(row => {
                              row.style.display = 'table-row';
                          });

                    });


                tr.appendChild(nameTd);

                // Cells for each category count (EXISTING CLICK FUNCTIONALITY - MODIFIED)
                sortedCategoriesForHeader.forEach(categoryName => {
                    const countTd = document.createElement('td');
                    const teamsInThisCategory = teamsByBaseNameAndCategory[baseName]?.[categoryName] || [];
                    const teamCount = teamsInThisCategory.length;

                    countTd.textContent = teamCount > 0 ? teamCount : '';
                    countTd.setAttribute('data-team-count', teamCount);
                    countTd.setAttribute('data-category', categoryName);

                    if (teamCount > 0) {
                        countTd.dataset.teams = JSON.stringify(teamsInThisCategory);
                         countTd.style.cursor = 'pointer';

                        countTd.addEventListener('click', function() {
                             console.log(`Count cell clicked for category "${categoryName}" on base name "${baseName}".`);
                             const clickedCell = this;
                             const mainRow = clickedCell.parentElement;
                             const baseName = mainRow.getAttribute('data-base-name');
                             const category = clickedCell.getAttribute('data-category');

                             createdTeamsTableBody.querySelectorAll(`tr.sub-row[data-base-name="${baseName}"]`).forEach(subRow => subRow.style.display = 'none');
                              createdTeamsTableBody.querySelectorAll('tr[data-base-name]').forEach(row => {
                                  if (row !== mainRow) row.setAttribute('data-sub-rows-visible', 'false');
                               });
                              mainRow.setAttribute('data-sub-rows-visible', 'false');


                             const existingSubRowsForThisCategory = createdTeamsTableBody.querySelectorAll(`tr.sub-row[data-base-name="${baseName}"][data-category="${category}"]`);

                             if (existingSubRowsForThisCategory.length === 0) {
                                  const teamsDataForCategory = JSON.parse(clickedCell.dataset.teams);
                                   console.log(`Sub-rows for "${baseName}" in category "${category}" not found in DOM, creating.`);

                                   teamsDataForCategory.forEach(team => {
                                       const subRow = document.createElement('tr');
                                       subRow.classList.add('sub-row');
                                       subRow.setAttribute('data-base-name', baseName);
                                       subRow.setAttribute('data-category', category);

                                       const subNameTd = document.createElement('td');
                                       subNameTd.textContent = team.data.name;
                                       subNameTd.style.paddingLeft = '35px';

                                       sortedCategoriesForHeader.forEach(cat => {
                                           const categoryCell = document.createElement('td');
                                            if (team.data.categoryId === cat) {
                                                categoryCell.textContent = '1';
                                                categoryCell.style.textAlign = 'center';
                                            } else {
                                                categoryCell.textContent = '';
                                            }
                                            subRow.appendChild(categoryCell);
                                        });

                                       subRow.insertBefore(subNameTd, subRow.firstChild);
                                        subRow.style.display = 'table-row';

                                        mainRow.parentElement.insertBefore(subRow, mainRow.nextSibling);
                                    });
                             } else {
                                 console.log(`Sub-rows for "${baseName}" in category "${category}" found in DOM, showing.`);
                                 existingSubRowsForThisCategory.forEach(subRow => subRow.style.display = 'table-row');
                             }

                             mainRow.setAttribute('data-sub-rows-visible', 'true');

                             currentCategoryFilter = null;
                              createdTeamsTableBody.querySelectorAll('tr[data-base-name]').forEach(row => {
                                  row.style.display = 'table-row';
                              });

                        });
                    }

                    tr.appendChild(countTd);
                });

                createdTeamsTableBody.appendChild(tr);

            });


              if (currentCategoryFilter) {
                  console.log(`Applying active filter: "${currentCategoryFilter}" after display.`);
                   const activeHeaderCell = createdTeamsTableHead.querySelector(`th[data-category-name="${currentCategoryFilter}"]`);
                   if (activeHeaderCell) {
                       setTimeout(() => {
                            activeHeaderCell.click();
                            console.log("Triggered click on active filter header.");
                       }, 0);

                   } else {
                       currentCategoryFilter = null;
                        createdTeamsTableBody.querySelectorAll('tr[data-base-name]').forEach(mainRow => {
                              mainRow.style.display = 'table-row';
                          });
                        console.log("Active filter category not found after display, filter cleared.");
                   }
              }


            console.log(`Finished displaying created teams table.`);

        }


        // === 8. MODAL OPEN FUNCTIONS (Called by event listeners) ===

        // Funkcia na otvorenie modálu kategórie (používa ju addButton listener)
        function openCategoryModal(categoryName = null) { // parameter categoryName je voliteľný pre úpravu
            categoryModal.style.display = 'block';

            currentCategoryModalMode = 'add';
            editingCategoryName = null;
            categoryForm.reset();
            categoryNameInput.readOnly = false;


            if (categoryName) {
                currentCategoryModalMode = 'edit';
                editingCategoryName = categoryName;
                categoryModalTitle.textContent = 'Premenovať kategóriu';
                categoryNameInput.value = categoryName;
                categoryNameInput.focus();
            } else {
                categoryModalTitle.textContent = 'Pridať kategóriu';
                categoryNameInput.focus();
            }
        }


        // Funkcia na otvorenie modálu skupiny (pre pridanie alebo úpravu) (používa ju addButton listener, displayGroupsByCategory)
        //groupId je kompozitné ID, groupData má name, categoryId
        async function openGroupModal(groupId = null, groupData = null) { //groupId je kompozitné ID
            groupModal.style.display = 'block';

            currentGroupModalMode = 'add';
            editingGroupId = null;
            groupForm.reset();
            groupNameInput.disabled = false;
            groupFormSubmitButton.textContent = 'Uložiť';

            groupCategorySelect.value = "";


            if (groupId && groupData) {
                currentGroupModalMode = 'edit';
                editingGroupId = groupId;
                groupModalTitle.textContent = 'Premenovať skupinu';
                groupFormSubmitButton.textContent = 'Uložiť zmeny';

                await populateCategorySelect(groupCategorySelect, groupData.categoryId, []);

                groupNameInput.value = groupData.name;

            } else {
                groupModalTitle.textContent = 'Pridať skupinu';
                await populateCategorySelect(groupCategorySelect, null, []);
            }

            groupNameInput.focus();
        }


        // Funkcia na otvorenie modálu klubu (pre priradenie do skupiny ALEBO úpravu priradeného) (používa ju addButton listener, displayClubs)
        async function openClubModal(clubId = null, clubData = null) { // clubId is auto-generated ID
            clubModal.style.display = 'block';

            clubForm.reset();
            clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kategóriu --</option>';
            clubGroupSelect.disabled = true;
            clubCategorySelect.value = "";

            unassignedClubSelectContainer.style.display = 'block';
            clubNameInputContainer.style.display = 'none';


            if (clubId && clubData) {
                currentClubModalMode = 'edit-assigned';
                editingClubId = clubId;
                clubModalTitle.textContent = 'Upraviť klub v skupine';
                clubFormSubmitButton.textContent = 'Uložiť zmeny';

                unassignedClubSelectContainer.style.display = 'none';
                clubNameInputContainer.style.display = 'block';
                clubNameInput.readOnly = false;

                await populateCategorySelect(clubCategorySelect, clubData.categoryId, []);

                if (clubData.categoryId) {
                    await populateGroupSelect(clubData.categoryId, clubGroupSelect, clubData.groupId);
                }

                clubNameInput.value = clubData.name;

            } else {
                currentClubModalMode = 'add-assign';
                editingClubId = null;
                clubModalTitle.textContent = 'Priradiť tím do skupiny';
                clubFormSubmitButton.textContent = 'Priradiť';

                await populateUnassignedClubsSelect(unassignedClubSelect, null);

                await populateCategorySelect(clubCategorySelect, null, []);
            }

            if (currentClubModalMode === 'add-assign') {
                unassignedClubSelect.focus();
            } else {
                clubNameInput.focus();
            }
        }


        // === 9. SECTION TOGGLING FUNCTION (Uses display functions) ===

        // Funkcia na prepínanie zobrazenia obsahu
        function toggleContentDisplay() {
            // Debounce logika - zabráni viacnásobným spusteniam naraz
            if (isDisplaying) {
                console.log("toggleContentDisplay already running, exiting.");
                return;
            }
            isDisplaying = true;
            console.log("isDisplaying set to true.");


            const hash = window.location.hash;
            console.log("Navigating to hash:", hash);

            // Skryť všetky dynamické oblasti a modály
            addButton.style.display = 'none';
            categoriesContentSection.style.display = 'none';
            groupsContentDiv.style.display = 'none';
            clubsContentDiv.style.display = 'none';
            teamCreationContentSection.style.display = 'none';

            categoryModal.style.display = 'none';
            groupModal.style.display = 'none';
            clubModal.style.display = 'none';
            teamCreationModal.style.display = 'none';


            // Vyčistiť obsah dynamických oblastí
            categoryTableBody.innerHTML = '';
            groupsContentDiv.innerHTML = '';
            clubsContentDiv.innerHTML = '';
            createdTeamsTableBody.innerHTML = ''; // Clear table body
            createdTeamsTableHead.innerHTML = ''; // Clear table head


            // Reset modal states and forms when navigating away
            currentCategoryModalMode = 'add';
            editingCategoryName = null;
            categoryForm.reset();

            currentGroupModalMode = 'add';
            editingGroupId = null;
            groupForm.reset();

            // Reset club modal state (add/edit assigned)
            currentClubModalMode = 'add-assign';
            editingClubId = null;
            clubForm.reset();
            unassignedClubSelectContainer.style.display = 'block';
            clubNameInputContainer.style.display = 'none';


            // Reset team creation modal state
            currentTeamCreationModalMode = 'add';
            teamCreationForm.reset();
            dynamicCategoryCountContainer.innerHTML = '';


            // Reset category filter when changing sections
             currentCategoryFilter = null;
             console.log("Category filter reset due to section change.");


            if (hash === '#kategorie') {
                addButton.style.display = 'block';
                categoriesContentSection.style.display = 'block';
                loadCategoriesTable();
                addButton.title = "Pridať kategóriu";
            } else if (hash === '#skupiny') {
                addButton.style.display = 'block';
                groupsContentDiv.style.display = 'flex';
                displayGroupsByCategory();
                addButton.title = "Pridať skupinu";
            } else if (hash === '#vytvorenie-timov') {
                addButton.style.display = 'block';
                teamCreationContentSection.style.display = 'block';
                displayCreatedTeams();
                addButton.title = "Vytvoriť tímy";
            } else if (hash === '#timy-do-skupin') {
                addButton.style.display = 'block';
                clubsContentDiv.style.display = 'flex';
                displayClubs();
                addButton.title = "Priradiť tím do skupiny";
            } else {
                addButton.style.display = 'none';
                addButton.title = "Pridať položku";
                console.log("Neznáma alebo neimplementovaná sekcia, zobrazujem prázdny obsah.");
            }


            // Resetovanie príznaku po krátkej chvíli
            setTimeout(() => {
                isDisplaying = false;
                console.log("isDisplaying flag reset.");
            }, 50);
        }


        // === 10. EVENT LISTENERS ===

        // Spustíme toggleContentDisplay pri zmene hašu
        window.addEventListener('hashchange', toggleContentDisplay);

        // Spustíme display logic JEDENKRÁT pri načítaní stránky
        window.addEventListener('load', async () => {
            console.log("Window loaded.");
            await cacheAllCategories();
            console.log("Categories cached on load.");

            if (!window.location.hash || window.location.hash === '#') {
                console.log("No hash found, setting to #kategorie.");
                // Setting hash triggers hashchange event, which calls toggleContentDisplay
                window.location.hash = '#kategorie';
            } else {
                console.log("Hash found:", window.location.hash, "Calling toggleContentDisplay directly ONCE on load.");
                toggleContentDisplay(); // Call directly if hash is already set
            }
            console.log("Load event logic finished.");
        });


        // Spoločná obsluha kliknutia na tlačidlo Pridať (+)
        addButton.addEventListener('click', async () => {
            const hash = window.location.hash;
            console.log("Add button clicked, current hash:", hash);

            if (hash === '#kategorie') {
                console.log("Opening category modal...");
                openCategoryModal();
            } else if (hash === '#skupiny') {
                console.log("Opening group modal...");
                await openGroupModal();
            } else if (hash === '#vytvorenie-timov') {
                console.log("Opening team creation modal...");
                currentTeamCreationModalMode = 'add';
                teamCreationModalTitle.textContent = 'Vytvoriť tímy';
                teamCreationForm.reset();
                dynamicCategoryCountContainer.innerHTML = '';

                console.log("Populating category select in team creation modal...");
                await populateCategorySelect(teamCategorySelect, null, []);
                console.log("Category select in team creation modal populated.");

                teamCreationModal.style.display = 'block';
                console.log("Team creation modal display set.");

                teamNameInput.focus();
                console.log("Focus set on team name input in team creation modal.");


            } else if (hash === '#timy-do-skupin') {
                console.log("Opening club assignment modal...");
                await openClubModal(null, null);
            } else {
                console.log("Add button clicked in unknown or unimplemented section:", hash);
                addButton.style.display = 'none';
                addButton.title = "Pridať položku";
            }
        });


        // Obsluha formulára na pridanie/úpravu kategórie
        categoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const categoryName = categoryNameInput.value.trim();
            if (categoryName === '') {
                alert('Názov kategórie nemôže byť prázdny.');
                return;
            }
            if (currentCategoryModalMode === 'add') {
                const categoryDocRef = doc(categoriesCollectionRef, categoryName);
                try {
                    const existingDoc = await getDoc(categoryDocRef);
                    if (existingDoc.exists()) {
                        alert(`Kategória "${categoryName}" už existuje!`);
                        return;
                    }
                    await setDoc(categoryDocRef, {});
                    console.log(`Kategória "${categoryName}" bola úspešne pridaná.`);
                    categoryModal.style.display = 'none';
                    categoryForm.reset();
                    currentCategoryModalMode = 'add';
                    editingCategoryName = null;
                    loadCategoriesTable();
                    if (window.location.hash === '#skupiny') displayGroupsByCategory();
                    if (window.location.hash === '#timy-do-skupin') displayClubs();
                    if (window.location.hash === '#vytvorenie-timov') displayCreatedTeams();
                    cacheAllCategories();
                } catch (error) {
                    console.error('Chyba pri pridávaní kategórie: ', error);
                    alert('Chyba pri pridávaní kategórie!');
                    categoryModal.style.display = 'none';
                    categoryForm.reset();
                    currentCategoryModalMode = 'add';
                    editingCategoryName = null;
                }
            } else if (currentCategoryModalMode === 'edit') {
                const oldCategoryName = editingCategoryName;
                const newCategoryName = categoryName;
                if (!oldCategoryName) {
                    console.error("Chyba: Chýba pôvodný názov kategórie.");
                    alert("Chyba pri úprave kategórie.");
                    categoryModal.style.display = 'none';
                    categoryForm.reset();
                    currentCategoryModalMode = 'add';
                    editingCategoryName = null;
                    return;
                }
                if (newCategoryName === oldCategoryName) {
                    console.log("Názov kategórie sa nezmenil.");
                    categoryModal.style.display = 'none';
                    categoryForm.reset();
                    return;
                }

                const newCategoryDocRef = doc(categoriesCollectionRef, newCategoryName);
                try {
                    const existingDoc = await getDoc(newCategoryDocRef);
                    if (existingDoc.exists()) {
                        alert(`Kategória s názvom "${newCategoryName}" už existuje!`);
                        return;
                    }

                    const oldCategoryDocRef = doc(categoriesCollectionRef, oldCategoryName);
                    const oldDocSnapshot = await getDoc(oldCategoryDocRef);
                    if (!oldDocSnapshot.exists()) {
                        console.error(`Chyba: Pôvodný dokument kategórie ${oldCategoryName} nenájdený.`);
                        alert("Pôvodná kategória na úpravu nebola nájdená.");
                        categoryModal.style.display = 'none';
                        categoryForm.reset();
                        currentCategoryModalMode = 'add';
                        editingCategoryName = null;
                        loadCategoriesTable();
                        return;
                    }
                    const batch = writeBatch(db);
                    batch.set(newCategoryDocRef, oldDocSnapshot.data()); // Copy data to new doc
                    batch.delete(oldCategoryDocRef);

                    const groupsQuery = query(groupsCollectionRef, where('categoryId', '==', oldCategoryName));
                    const groupsSnapshot = await getDocs(groupsQuery);

                    const clubUpdates = [];
                    for (const groupDoc of groupsSnapshot.docs) {
                        const clubsInGroupQuery = query(clubsCollectionRef, where('groupId', '==', groupDoc.id));
                        const clubsSnapshot = await getDocs(clubsInGroupQuery);
                        clubsSnapshot.forEach(clubDoc => {
                            const groupData = groupDoc.data();
                            const newGroupId = `${newCategoryName} - ${groupData.name}`;
                            clubUpdates.push({
                                ref: clubDoc.ref,
                                updates: {
                                    categoryId: newCategoryName,
                                    groupId: newGroupId
                                }
                            });
                            console.log(`Klub "${clubDoc.id}" aktualizovaný (categoryId, groupId) kvôli zmene kategórie skupiny.`);
                        });
                        batch.delete(groupDoc.ref);
                        console.log(`Stará skupina "${groupDoc.id}" zmazaná po premenovaní kategórie.`);
                    }

                    clubUpdates.forEach(item => {
                        batch.update(item.ref, item.updates);
                    });

                    const unassignedClubsQuery = query(clubsCollectionRef, where('categoryId', '==', oldCategoryName), where('groupId', '==', null));
                    const unassignedClubsSnapshot = await getDocs(unassignedClubsQuery);
                    unassignedClubsSnapshot.forEach(doc => {
                        batch.update(doc.ref, {
                            categoryId: newCategoryName
                        });
                        console.log(`Nepriradený klub "${doc.id}" aktualizovaný (categoryId).`);
                    });

                    await batch.commit();

                    console.log(`Premenovanie kategórie "${oldCategoryName}" na "${newCategoryName}" a aktualizácia referencií bolo úspešné.`);

                    currentCategoryModalMode = 'add';
                    editingCategoryName = null;
                    categoryModal.style.display = 'none';
                    categoryForm.reset();

                    loadCategoriesTable();
                    if (window.location.hash === '#skupiny') displayGroupsByCategory();
                    if (window.location.hash === '#timy-do-skupin') displayClubs();
                    if (window.location.hash === '#vytvorenie-timov') displayCreatedTeams();

                    cacheAllCategories();

                } catch (error) {
                    console.error('Chyba pri premenovaní kategórie a aktualizácii referencií: ', error);
                    alert('Chyba pri premenovaní kategórie! Prosím, skúste znova.');
                    currentCategoryModalMode = 'add';
                    editingCategoryName = null;
                    categoryModal.style.display = 'none';
                    categoryForm.reset();
                }
            }
        });


        // Obsluha formulára Skupiny
        groupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const selectedCategoryId = groupCategorySelect.value;
            const groupName = groupNameInput.value.trim();

            if (selectedCategoryId === '' || selectedCategoryId === '-- Vyberte kategóriu --' || groupCategorySelect.disabled) {
                alert('Prosím, vyberte platnú kategóriu pre skupinu.');
                return;
            }
            if (groupName === '') {
                alert('Názov skupiny nemôže byť prázdny.');
                return;
            }

            const compositeGroupId = `${selectedCategoryId} - ${groupName}`;
            const groupDocRef = doc(groupsCollectionRef, compositeGroupId);

            try {
                const existingDoc = await getDoc(groupDocRef);

                if (currentGroupModalMode === 'add') {
                    if (existingDoc.exists()) {
                        alert(`Skupina s názvom "${groupName}" už v kategórii "${selectedCategoryId}" existuje!`);
                        return;
                    }
                    await setDoc(groupDocRef, {
                        name: groupName,
                        categoryId: selectedCategoryId
                    });
                    console.log(`Skupina "${groupName}" (ID: ${compositeGroupId}) bola úspešne pridaná.`);

                } else if (currentGroupModalMode === 'edit') {
                    const oldGroupId = editingGroupId;
                    if (!oldGroupId) {
                        console.error("Chyba: Režim úpravy skupiny bez platného editingGroupId.");
                        alert("Chyba pri úprave skupiny.");
                        groupModal.style.display = 'none';
                        groupForm.reset();
                        currentGroupModalMode = 'add';
                        editingGroupId = null;
                        return;
                    }

                    const oldGroupDocRef = doc(groupsCollectionRef, oldGroupId);
                    const oldDocSnapshot = await getDoc(oldGroupDocRef);
                    if (!oldDocSnapshot.exists()) {
                        console.error(`Chyba: Pôvodný dokument skupiny ${oldGroupId} nenájdený.`);
                        alert("Pôvodná skupina na úpravu nebola nájdená.");
                        groupModal.style.display = 'none';
                        groupForm.reset();
                        currentGroupModalMode = 'add';
                        editingGroupId = null;
                        displayGroupsByCategory();
                        return;
                    }

                    if (oldGroupId !== compositeGroupId) {
                        console.log(`Premenovanie/presun skupiny z "${oldGroupId}" na "${compositeGroupId}".`);
                        if (existingDoc.exists()) {
                            alert(`Skupina s názvom "${groupName}" už v kategórii "${selectedCategoryId}" existuje (iná skupina)!`);
                            return;
                        }
                        const batch = writeBatch(db);
                        batch.set(groupDocRef, {
                            name: groupName,
                            categoryId: selectedCategoryId
                        });
                        batch.delete(oldGroupDocRef);

                        const clubsInGroupQuery = query(clubsCollectionRef, where('groupId', '==', oldGroupId));
                        const clubsSnapshot = await getDocs(clubsInGroupQuery);
                        clubsSnapshot.forEach(clubDoc => {
                            batch.update(clubDoc.ref, {
                                groupId: compositeGroupId
                            });
                            console.log(`Klub "${clubDoc.id}" aktualizovaný (groupId) kvôli zmene skupiny.`);
                        });
                        await batch.commit();
                        console.log(`Skupina úspešne premenovaná/presunutá z ID "${oldGroupId}" na "${compositeGroupId}" a súvisiace kluby aktualizované.`);

                    } else {
                        console.log(`Úprava údajov pre skupinu s ID "${oldGroupId}".`);
                        await updateDoc(groupDocRef, {
                            name: groupName,
                            categoryId: selectedCategoryId
                        });
                        console.log(`Skupina s ID "${oldGroupId}" úspešne upravená.`);
                    }
                }

                groupModal.style.display = 'none';
                groupForm.reset();
                currentGroupModalMode = 'add';
                editingGroupId = null;

                if (window.location.hash === '#skupiny') displayGroupsByCategory();
                if (window.location.hash === '#timy-do-skupin') displayClubs();
                if (window.location.hash === '#vytvorenie-timov') displayCreatedTeams();


            } catch (error) {
                console.error('Chyba pri ukladaní skupiny: ', error);
                alert(`Chyba pri ukladaní skupiny! Detail: ${error.message}`);
                groupModal.style.display = 'none';
                groupForm.reset();
                currentGroupModalMode = 'add';
                editingGroupId = null;
            }
        });


        // Obsluha formulára Kluby (Priradenie do skupín & Správa priradených)
        clubForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const selectedCategoryId = clubCategorySelect.value;
            const selectedGroupId = clubGroupSelect.value;


            if (clubCategorySelect.disabled === false && (selectedCategoryId === '' || selectedCategoryId === '-- Vyberte kategóriu --')) {
                alert('Prosím, vyberte platnú kategóriu.');
                return;
            }
            if (clubGroupSelect.disabled === false && (selectedGroupId === '' || selectedGroupId === '-- Vyberte skupinu --' || selectedGroupId === '-- Žiadne skupiny v kategórii --')) {
                alert('Prosím, vyberte platnú skupinu.');
                return;
            }


            try {
                if (currentClubModalMode === 'add-assign') {
                    const selectedUnassignedClubId = unassignedClubSelect.value;

                    if (unassignedClubSelectContainer.style.display !== 'none' && selectedUnassignedClubId === '') {
                        alert('Prosím, vyberte tím na priradenie.');
                        return;
                    }

                    const clubRefToAssign = doc(clubsCollectionRef, selectedUnassignedClubId);
                    const clubDocToAssign = await getDoc(clubRefToAssign);

                    if (!clubDocToAssign.exists()) {
                        alert('Vybraný tím nebol nájdený alebo už bol priradený/zmazaný.');
                        populateUnassignedClubsSelect(unassignedClubSelect, null);
                        clubModal.style.display = 'none';
                        clubForm.reset();
                        unassignedClubSelectContainer.style.display = 'block';
                        clubNameInputContainer.style.display = 'none';
                        return;
                    }

                    const clubDataToAssign = clubDocToAssign.data();
                    if (clubDataToAssign.groupId !== null) {
                        alert(`Tím "${clubDataToAssign.name}" je už priradený do skupiny.`);
                        populateUnassignedClubsSelect(unassignedClubSelect, null);
                        clubModal.style.display = 'none';
                        clubForm.reset();
                        unassignedClubSelectContainer.style.display = 'block';
                        clubNameInputContainer.style.display = 'none';
                        return;
                    }

                    const existingClubInGroupQuery = query(clubsCollectionRef,
                        where('groupId', '==', selectedGroupId),
                        where('name', '==', clubDataToAssign.name)
                    );
                    const existingClubInGroupSnapshot = await getDocs(existingClubInGroupQuery);
                    if (!existingClubInGroupSnapshot.empty) {
                        alert(`Tím s názvom "${clubDataToAssign.name}" už v skupine "${selectedGroupId}" existuje!`);
                        return;
                    }

                    await updateDoc(clubRefToAssign, {
                        categoryId: selectedCategoryId,
                        groupId: selectedGroupId,
                    });

                    console.log(`Tím "${clubDataToAssign.name}" (ID: ${selectedUnassignedClubId}) úspešne priradený do skupiny "${selectedGroupId}".`);
                    alert(`Tím "${clubDataToAssign.name}" úspešne priradený.`);


                } else if (currentClubModalMode === 'edit-assigned') {
                    const clubIdToEdit = editingClubId;
                    const updatedClubName = clubNameInput.value.trim();
                    const currentClubDoc = await getDoc(doc(clubsCollectionRef, clubIdToEdit));
                    if (!currentClubDoc.exists()) {
                        console.error("Chyba: Dokument upravovaného klubu neexistuje.");
                        alert("Klub na úpravu nebol nájdený.");
                        clubModal.style.display = 'none';
                        clubForm.reset();
                        currentClubModalMode = 'add-assign';
                        editingClubId = null;
                        unassignedClubSelectContainer.style.display = 'block';
                        clubNameInputContainer.style.display = 'none';
                        displayClubs();
                        return;
                    }

                    if (!clubIdToEdit) {
                        console.error("Chyba: Režim úpravy priradeného klubu bez platného editingClubId.");
                        alert("Chyba pri úprave klubu. Prosím, obnovte stránku.");
                        clubModal.style.display = 'none';
                        clubForm.reset();
                        currentClubModalMode = 'add-assign';
                        editingClubId = null;
                        unassignedClubSelectContainer.style.display = 'block';
                        clubNameInputContainer.style.display = 'none';
                        return;
                    }
                    if (updatedClubName === '') {
                        alert('Názov klubu nemôže byť prázdny.');
                        return;
                    }

                    const existingClubInTargetGroupQuery = query(clubsCollectionRef,
                        where('groupId', '==', selectedGroupId),
                        where('name', '==', updatedClubName),
                        where(FieldPath.documentId(), '!=', clubIdToEdit)
                    );
                    const existingClubInTargetGroupSnapshot = await getDocs(existingClubInTargetGroupQuery);
                    if (!existingClubInTargetGroupSnapshot.empty) {
                        alert(`Klub s názvom "${updatedClubName}" už v skupine "${selectedGroupId}" existuje! Prosím, zvoľte iný názov.`);
                        return;
                    }

                    const clubRefToEdit = doc(clubsCollectionRef, clubIdToEdit);
                    const clubDocToEdit = await getDoc(clubRefToEdit);
                    if (!clubDocToEdit.exists()) {
                        console.error(`Chyba: Dokument priradeného klubu ${clubIdToEdit} nenájdený na úpravu.`);
                        alert("Klub na úpravu nebol nájdený.");
                        clubModal.style.display = 'none';
                        clubForm.reset();
                        currentClubModalMode = 'add-assign';
                        editingClubId = null;
                        displayClubs();
                        return;
                    }
                    const clubDataToEdit = clubDocToEdit.data();

                    if (clubDataToEdit.name === updatedClubName &&
                        clubDataToEdit.categoryId === selectedCategoryId &&
                        clubDataToEdit.groupId === selectedGroupId) {
                        console.log("Žiadne zmeny na klube.", clubIdToEdit);
                        clubModal.style.display = 'none';
                        clubForm.reset();
                        currentClubModalMode = 'add-assign';
                        editingClubId = null;
                        unassignedClubSelectContainer.style.display = 'block';
                        clubNameInputContainer.style.display = 'none';
                        return;
                    }

                    await updateDoc(clubRefToEdit, {
                        name: updatedClubName,
                        categoryId: selectedCategoryId,
                        groupId: selectedGroupId,
                    });

                    console.log(`Klub "${updatedClubName}" (ID: ${clubIdToedit}) úspešne upravený v skupine "${selectedGroupId}".`);
                    alert(`Klub úspešne upravený.`);

                }

                clubModal.style.display = 'none';
                clubForm.reset();
                currentClubModalMode = 'add-assign';
                editingClubId = null;

                unassignedClubSelectContainer.style.display = 'block';
                clubNameInputContainer.style.display = 'none';

                if (window.location.hash === '#timy-do-skupin') {
                    displayClubs();
                }
                if (window.location.hash === '#vytvorenie-timov') {
                    displayCreatedTeams();
                }


            } catch (error) {
                console.error('Chyba pri ukladaní alebo priradzovaní klubu: ', error);
                alert(`Chyba pri ukladaní alebo priradzovaní klubu! Detail: ${error.message}`);
                clubModal.style.display = 'none';
                clubForm.reset();
                currentClubModalMode = 'add-assign';
                editingClubId = null;
                unassignedClubSelectContainer.style.display = 'block';
                clubNameInputContainer.style.display = 'none';
            }
        });


        // Obsluha formulára Vytvorenie Tímov
        teamCreationForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const teamNameBase = teamNameInput.value.trim();
            const initialCategoryId = teamCategorySelect.value;
            const initialTeamCount = parseInt(teamCountInput.value, 10);

            const teamEntries = [];

            if (teamNameBase === '') {
                alert('Názov tímu nemôže byť prázdny.');
                return; // Pridané return
            }
            if (initialCategoryId !== '' && !isNaN(initialTeamCount) && initialTeamCount >= 1) {
                if (initialTeamCount > 26) {
                    alert(`Počet tímov pre kategóriu "${initialCategoryId}" (${initialTeamCount}) v prvom zadaní prekračuje limit pre abecedné označenie (26). Prosím, znížte počet.`);
                    return;
                }
                teamEntries.push({
                    categoryId: initialCategoryId,
                    count: initialTeamCount
                });
            } else if (initialCategoryId !== '' || (teamNameBase !== '' && (isNaN(initialTeamCount) || initialTeamCount < 1))) {
                alert('Prosím, zadajte platnú kategóriu a počet tímov (väčší ako 0) pre prvú položku.');
                 return; // Pridané return
            }

            const dynamicGroups = dynamicCategoryCountContainer.querySelectorAll('.category-count-group');
            dynamicGroups.forEach(groupDiv => {
                const categorySelect = groupDiv.querySelector('select');
                const countInput = groupDiv.querySelector('input[type="number"]');

                const categoryId = categorySelect.value;
                const teamCount = parseInt(countInput.value, 10);

                if (categoryId !== '' && !isNaN(teamCount) && teamCount >= 1) {
                    if (teamCount > 26) {
                        alert(`Počet tímov pre kategóriu "${categoryId}" (${teamCount}) v jednom zo zadaní prekračuje limit pre abecedné označenie (26). Prosím, znížte počet.`);
                        return;
                    }
                    teamEntries.push({
                        categoryId: categoryId,
                        count: teamCount
                    });
                } else if (categoryId !== '' || (!isNaN(teamCount) && teamCount >= 1)) {
                    alert('Prosím, zadajte platnú kategóriu a počet tímov (väčší ako 0) pre dynamickú položku.');
                     return; // Pridané return
                }
            });

            if (teamEntries.length === 0) {
                alert('Prosím, zadajte aspoň jednu kategóriu a počet tímov na vytvorenie.');
                return; // Pridané return
            }

            // Pridaná kontrola prázdneho názvu aj tu pre istotu
             if (teamNameBase === '') {
                 alert('Názov tímu nemôže byť prázdny.');
                 return;
             }


            try {
                const batch = writeBatch(db);
                let successfullyAddedCount = 0;

                for (const entry of teamEntries) {
                    const categoryId = entry.categoryId;
                    const teamCount = entry.count;

                    for (let i = 1; i <= teamCount; i++) {
                        let teamName;
                        // Použitie A, B, C... pre tímy, ak je ich viac ako 1 v rámci ZADANIA kategórie
                        if (teamCount > 1) {
                             // Abecedné označenie (A, B, C...)
                            const letter = String.fromCharCode(65 + (i - 1));
                            teamName = `${teamNameBase} ${letter}`;
                        } else {
                             // Ak je len jeden tím v rámci ZADANIA kategórie, použije sa iba základný názov
                            teamName = teamNameBase;
                        }

                        // ID dokumentu v Firestore bude kombinácia Kategória - Názov tímu
                        const teamDocumentId = `${categoryId} - ${teamName}`;
                        const newTeamRef = doc(clubsCollectionRef, teamDocumentId);

                        // Kontrola, či tím s takýmto ID už existuje (Firestore automaticky prepíše, ale pre info používateľovi)
                         const existingTeamDoc = await getDoc(newTeamRef);
                          if (existingTeamDoc.exists()) {
                              console.warn(`Tím s ID "${teamDocumentId}" už existuje. Bude prepísaný.`);
                              // Tu by ste mohli pridať logiku na ošetrenie duplicitných ID, ak nechcete prepisovať.
                              // Pre tento príklad predpokladáme prepísanie.
                          }


                        batch.set(newTeamRef, {
                            name: teamName,
                            categoryId: categoryId,
                            groupId: null // Novovytvorené tímy nie sú priradené k skupine
                        });
                        successfullyAddedCount++;
                    }
                }

                await batch.commit();

                console.log(`Pokus o vytvorenie/aktualizáciu ${successfullyAddedCount} tím(ov) na základe ${teamEntries.length} zadani(í).`);
                alert(`Úspešne spracovaných ${successfullyAddedCount} tím(ov). Skontrolujte zoznam vytvorených tímov.`);

                teamCreationModal.style.display = 'none';
                teamCreationForm.reset();
                dynamicCategoryCountContainer.innerHTML = '';
                populateCategorySelect(teamCategorySelect, null, []); // Naplniť počiatočný select znova


                if (window.location.hash === '#vytvorenie-timov') {
                    displayCreatedTeams(); // Obnoviť zobrazenie vytvorených tímov
                }

            } catch (error) {
                console.error('Chyba pri vytváraní tímov: ', error);
                alert(`Chyba pri vytváraní tímov! Detail: ${error.message}`);
                teamCreationModal.style.display = 'none';
                teamCreationForm.reset();
                dynamicCategoryCountContainer.innerHTML = '';
                populateCategorySelect(teamCategorySelect, null, []);
            }
        });


        // Event listener pre zmenu kategórie v modáli klubu (pre priradenie do skupiny)
        clubCategorySelect.addEventListener('change', async () => {
            const selectedCategoryId = clubCategorySelect.value;
            await populateGroupSelect(selectedCategoryId, clubGroupSelect);
        });

        // NEW: Event listener for change in the unassigned club select (in clubModal)
        unassignedClubSelect.addEventListener('change', async () => {
            const selectedClubId = unassignedClubSelect.value;
            if (selectedClubId) {
                try {
                    const clubDoc = await getDoc(doc(clubsCollectionRef, selectedClubId));
                    if (clubDoc.exists()) {
                        const clubData = clubDoc.data();
                        await populateCategorySelect(clubCategorySelect, clubData.categoryId, []);
                        // Populate group select only if a category is already assigned to the unassigned club
                         if(clubData.categoryId) {
                            await populateGroupSelect(clubData.categoryId, clubGroupSelect, clubData.groupId);
                         } else {
                              clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kategóriu --</option>';
                              clubGroupSelect.disabled = true;
                         }

                    } else {
                        console.warn(`Vybraný nepriradený tím ${selectedClubId} už neexistuje.`);
                        unassignedClubSelect.value = "";
                        clubCategorySelect.value = "";
                        clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kategóriu --</option>';
                        clubGroupSelect.disabled = true;
                    }
                } catch (error) {
                    console.error('Chyba pri načítaní detailov vybraného nepriradeného tímu:', error);
                    alert('Chyba pri načítaní detailov tímu.');
                    unassignedClubSelect.value = "";
                    clubCategorySelect.value = "";
                    clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kategóriu --</option>';
                    clubGroupSelect.disabled = true;
                }
            } else {
                clubCategorySelect.value = "";
                clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kategóriu --</option>';
                clubGroupSelect.disabled = true;
            }
        });


        // NEW: Event listener for changes in category selects to update other selects (for Team Creation Modal)
        teamCategorySelect.addEventListener('change', updateCategorySelectOptions);

        // NEW: Event listener for the "Add another category" button
        addCategoryCountPairButton.addEventListener('click', () => {
            // Create elements (div, labels, selects, inputs, button)
            const groupDiv = document.createElement('div');
            groupDiv.classList.add('category-count-group');

            const categoryLabel = document.createElement('label');
            categoryLabel.textContent = 'Kategória:';

            const categorySelect = document.createElement('select');
            categorySelect.classList.add('dynamic-category-select');
            categorySelect.required = true;

            const countLabel = document.createElement('label');
            countLabel.textContent = 'Počet tímov:';

            const countInput = document.createElement('input');
            countInput.setAttribute('type', 'number');
            countInput.classList.add('dynamic-team-count-input');
            countInput.setAttribute('min', '1');
            countInput.setAttribute('value', '1');
            countInput.required = true;

            const removeButton = document.createElement('button');
            removeButton.setAttribute('type', 'button');
            removeButton.classList.add('remove-group-button');
            removeButton.textContent = 'X';

            // Append elements
            groupDiv.appendChild(removeButton);
            groupDiv.appendChild(categoryLabel);
            groupDiv.appendChild(categorySelect);
            groupDiv.appendChild(countLabel);
            groupDiv.appendChild(countInput);

            // Append group to container
            dynamicCategoryCountContainer.appendChild(groupDiv);

            // Update category select options (includes the new select)
            updateCategorySelectOptions();

             // Add change listener directly to the newly created category select
             categorySelect.addEventListener('change', updateCategorySelectOptions);

            // Add event listener to the remove button
            removeButton.addEventListener('click', () => {
                groupDiv.remove(); // Remove the entire group div
                updateCategorySelectOptions(); // Update options in remaining selects
            });

            // Focus the new select element
            categorySelect.focus();
        });


        // === 11. INITIALIZATION ON LOAD ===
        // Robí sa v load event listeneri už s volaním toggleContentDisplay na konci


    </script>

</body>
</html>
