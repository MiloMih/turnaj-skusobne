<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Správca turnaja</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="style.css">

    <style>
        /* --- General Styles --- */
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-top: 20px;
        }

        h2 {
            margin-top: 0; /* Reset margin-top, controlled by section padding */
            margin-bottom: 10px;
            color: #555;
        }

        .add-button {
            display: block;
            margin: 20px auto;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #28a745;
            color: white;
            font-size: 2em;
            border: none;
            cursor: pointer;
            text-align: center;
            line-height: 50px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.3s ease;
            position: sticky;
            top: 20px;
            z-index: 10;
        }

        .add-button:hover {
            background-color: #218838;
        }

        .content-wrapper {
            display: flex;
            margin-top: 20px;
            padding: 0 20px;
        }

        .left-menu {
            width: 200px;
            margin-right: 20px;
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky;
            top: 90px;
            align-self: flex-start;
            max-height: calc(100vh - 110px);
            overflow-y: auto;
        }

        .left-menu ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .left-menu li {
            margin-bottom: 10px;
        }

        .left-menu a {
            text-decoration: none;
            color: #007bff;
            font-weight: bold;
            display: block;
            padding: 5px 0;
            transition: color 0.3s ease;
        }

        .left-menu a:hover {
            color: #0056b3;
        }

        main {
            flex-grow: 1;
            padding: 0; /* Padding moved to content containers */
            box-shadow: none; /* Shadow moved to content containers */
            background-color: transparent; /* Ensure main background is transparent */
        }


        /* --- Table Styles --- */
        /* Styles for category and clubs tables (standard table format) */
        #categoryTable, #clubsTable {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px; /* Add margin below heading/container */
            border: none;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            background-color: #fff; /* White background for the table itself */
             border-radius: 8px; /* Rounded corners for the table */
             padding: 15px; /* Inner padding for the table */
             box-sizing: border-box; /* Include padding in width */
        }


         /* Style for the section wrapping category heading and group tables (now multiple tables) */
         .category-group-section {
             background-color: #fff; /* White background for section */
             padding: 15px; /* Add padding inside the section */
             border-radius: 8px; /* Rounded corners for the section */
             box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* Shadow for the section */
             margin-bottom: 0; /* Gap handles spacing between sections */

             /* Flex properties for the section item within #groupsContent */
             min-width: 300px; /* Minimum width before wrapping */
             flex-grow: 1; /* Allow sections to grow */
             flex-basis: 0; /* Distribute space based on grow factor */
             /* Optional: max-width: 500px; */
         }

         /* Style for the individual table representing a single group (Key-Value style) */
         .group-card-table {
             border-collapse: collapse;
             width: 100%; /* Table takes full width of its parent section */
             margin-top: 0; /* No margin at the top inside the section */
             margin-bottom: 15px; /* Space between individual group tables */
             border: 1px solid #eee; /* Subtle border around the group table */
             border-radius: 4px; /* Rounded corners for the group table */
             overflow: hidden; /* Ensure content respects border-radius */
             background-color: #fff; /* White background */
         }

         /* Remove bottom margin from the last group table in a section */
         .category-group-section .group-card-table:last-child {
              margin-bottom: 0;
         }


        /* Remove margin-top from the first element inside a section */
        .category-group-section h2:first-child,
        .category-group-section .group-card-table:first-child { /* Apply to the first group table */
            margin-top: 0;
        }


        /* Header cells in standard tables (#categoryTable, #clubsTable) and the old group table header (if any remains) */
        #categoryTable th, #clubsTable th {
             background-color: #f2f2f2;
             color: #333;
             font-weight: bold;
             text-align: left;
             padding: 12px 15px;
             border-bottom: 2px solid #ddd;
        }

        /* Header cells within the individual group tables (labels like "Názov:", "Akcie:") */
         .group-card-table th {
             background-color: #f9f9f9; /* Lighter background for labels */
             color: #555;
             font-weight: bold;
             text-align: left;
             padding: 8px 12px; /* Smaller padding */
             width: 80px; /* Fixed width for the label column */
             border-bottom: 1px solid #eee;
         }


        /* Data cells in standard tables (#categoryTable, #clubsTable) */
        #categoryTable td, #clubsTable td {
            text-align: left;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
        }

        /* Data cells within the individual group tables */
         .group-card-table td {
             text-align: left;
             padding: 8px 12px; /* Smaller padding */
             border-bottom: 1px solid #eee;
         }


        /* Remove border-bottom from the last row in any table body */
        #categoryTable tbody tr:last-child td,
        #clubsTable tbody tr:last-child td,
        .group-card-table tbody tr:last-child td,
         .group-card-table tbody tr:last-child th { /* Also remove from the last header cell in the key-value format */
             border-bottom: none;
         }

        /* Add hover effect to rows in any table body */
        #categoryTable tbody tr:hover,
        #clubsTable tbody tr:hover,
        .group-card-table tbody tr:hover {
            background-color: #f9f9f9;
            cursor: pointer;
        }

        /* Style for cells containing action buttons */
        #categoryTable td:last-child,
        #clubsTable td:last-child,
        .group-card-table td:last-child { /* Apply to the data cell containing buttons in group tables */
             white-space: nowrap;
        }

        /* Action button styles (already defined, ensure they apply) */
        .action-button { /* ... (styles remain) ... */ }
        .action-button:not(.delete-button) { /* ... (styles remain) ... */ }
        .action-button.delete-button { /* ... (styles remain) ... */ }
        .action-button:not(.delete-button):hover { /* ... (styles remain) ... */ }
        .action-button.delete-button:hover { /* ... (styles remain) ... */ }


        /* --- Modal Styles --- */
         .modal { /* ... (styles remain) ... */ }
         .modal-content { /* ... (styles remain) ... */ }
         .close { /* ... (styles remain) ... */ }
         .close:hover, .close:focus { /* ... (styles remain) ... */ }
         .modal-content form label { /* ... (styles remain) ... */ }
         .modal-content form input[type="text"], .modal-content form select { /* ... (styles remain) ... */ }
         .modal-content form button { /* ... (styles remain) ... */ }
         .modal-content form button:hover { /* ... (styles remain) ... */ }


        /* --- Specific Layout Containers --- */
        #groupsContent {
             display: flex;
             flex-wrap: wrap;
             gap: 20px; /* Space between sections */
             align-items: flex-start;
             padding: 20px; /* Padding around flex items */
             background-color: #f8f9fa; /* Background for the whole flex area */
             border-radius: 8px; /* Rounded corners for the flex area */
             box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* Shadow for the flex area */
        }

         #clubsContent {
              /* Simple block layout for clubs table */
             padding: 20px;
             background-color: #fff;
             border-radius: 8px;
             box-shadow: 0 2px 5px rgba(0,0,0,0.1);
             box-sizing: border-box;
         }


    </style>
</head>
<body>
    <script>
        // Basic check for admin, redirect if not
        const userName = localStorage.getItem('username');
        if (userName !== 'admin') {
             window.location.href = 'login.html';
        }
    </script>

    <h1>Správca turnaja</h1>

    <!-- This button is used for adding Categories or Groups depending on the page -->
    <button class="add-button" id="addButton" title="Pridať položku">+</button>

    <!-- Modal for adding/editing Categories -->
    <div class="modal" id="categoryModal">
        <div class="modal-content">
            <span class="close category-modal-close">&times;</span>
            <h2 id="categoryModalTitle">Pridať kategóriu</h2>
            <form id="categoryForm">
                <label for="categoryName">Názov kategórie:</label>
                <input type="text" id="categoryName" name="categoryName" required>
                <button type="submit">Uložiť</button>
            </form>
        </div>
    </div>

     <!-- Modal for adding/editing Groups -->
     <div class="modal" id="groupModal">
         <div class="modal-content">
              <span class="close group-modal-close">&times;</span>
              <h2 id="groupModalTitle">Pridať skupinu</h2>
              <form id="groupForm">
                  <label for="groupCategory">Kategória:</label>
                  <select id="groupCategory" name="groupCategory" required>
                       <option value="">-- Vyberte kategóriu --</option>
                       <!-- Options will be populated by JavaScript -->
                  </select>

                  <label for="groupName">Názov skupiny:</label>
                  <input type="text" id="groupName" name="groupName" required>

                  <button type="submit">Uložiť</button>
              </form>
         </div>
     </div>

    <!-- Modal for adding/editing Clubs -->
     <div class="modal" id="clubModal">
         <div class="modal-content">
              <span class="close club-modal-close">&times;</span>
              <h2 id="clubModalTitle">Pridať klub</h2>
              <form id="clubForm">
                  <label for="clubName">Názov klubu:</label>
                  <input type="text" id="clubName" name="clubName" required>

                  <label for="clubCategory">Kategória:</label>
                  <select id="clubCategory" name="clubCategory" required>
                       <option value="">-- Vyberte kategóriu --</option>
                       <!-- Options will be populated by JavaScript -->
                  </select>

                   <label for="clubGroup">Skupina:</label>
                  <select id="clubGroup" name="clubGroup" required disabled> <!-- Disabled until category is selected -->
                       <option value="">-- Najprv vyberte kategóriu --</option>
                       <!-- Options will be populated by JavaScript after category selection -->
                  </select>

                  <button type="submit">Uložiť</button>
              </form>
         </div>
     </div>


    <div class="content-wrapper">
        <nav class="left-menu">
            <ul>
                <li><a href="#kluby">Kluby</a></li>
                <li><a href="#kategorie">Kategórie</a></li>
                <li><a href="#skupiny">Skupiny</a></li>
                <li><a href="#sportove-haly">Športové haly</a></li>
                <li><a href="#sprava-turnaja">Správa turnaja</a></li>
                <li><a href="#nastavenia">Nastavenia</a></li>
            </ul>
        </nav>

        <main>
            <!-- Table for displaying Categories -->
             <table id="categoryTable" style="display: none;">
                 <thead>
                     <tr>
                         <th>Názov kategórie</th>
                         <th style="width: 150px;">Akcie</th>
                     </tr>
                 </thead>
                 <tbody id="categoryTableBody">
                     <!-- Category rows will be added here by JavaScript -->
                 </tbody>
             </table>

             <!-- Container for generated Group tables (now multiple tables per category section) -->
             <!-- This div is a flex container for category sections -->
             <div id="groupsContent" style="display: none;">
                 <!-- Category sections (div.category-group-section) will be added here by JavaScript -->
                  <!-- Inside each section: h2 (category name) and multiple table.group-card-table (one per group) -->
             </div>

             <!-- Table for displaying Clubs -->
             <table id="clubsTable" style="display: none;">
                 <thead>
                     <tr>
                         <th>Názov klubu</th>
                         <th>Kategória</th>
                         <th>Skupina</th>
                         <th style="width: 150px;">Akcie</th>
                     </tr>
                 </thead>
                 <tbody id="clubsTableBody">
                     <!-- Club rows will be added here by JavaScript -->
                 </tbody>
             </table>

             <!-- Add other content areas for Haly, Správa turnaja, Nastavenia if needed -->
             <!-- <div id="halyContent" style="display: none;">...</div> -->


         </main>
    </div>


    <script type="module">
        // Import potrebných Firebase Firestore funkcií priamo z CDN
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, query, where, addDoc, updateDoc, writeBatch } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';

        // Tvoja Firebase konfigurácia
        const firebaseConfig = {
            apiKey: "AIzaSyD0h0rQZiIGi0-UDb4-YU_JihRGpIlfz40",
            authDomain: "turnaj-a28c5.firebaseapp.com",
            projectId: "turnaj-a28c5",
            storageBucket: "turnaj-a28c5.firebasestorage.app",
            messagingSenderId: "13732191148",
            appId: "1:13732191148:web:5ad78eaef2ad452a10f809"
        };

        // Inicializácia Firebase aplikácie
        const app = initializeApp(firebaseConfig);
        // Získanie inštancie Firestore databázy
        const db = getFirestore(app);

        // Referencia na kolekcie
        const categoriesCollectionRef = collection(db, 'tournamentData', 'mainTournamentData', 'categories');
        const groupsCollectionRef = collection(db, 'tournamentData', 'mainTournamentData', 'groups'); // Groups now have composite IDs
        const clubsCollectionRef = collection(db, 'tournamentData', 'mainTournamentData', 'clubs'); // New collection for Clubs


        // Získame referencie na DOM elementy
        const addButton = document.getElementById('addButton');

        // Modál Kategórie
        const categoryModal = document.getElementById('categoryModal');
        const categoryModalCloseBtn = categoryModal.querySelector('.category-modal-close');
        const categoryForm = document.getElementById('categoryForm');
        const categoryNameInput = document.getElementById('categoryName');
        const categoryModalTitle = document.getElementById('categoryModalTitle');

        // Modál Skupiny
        const groupModal = document.getElementById('groupModal');
        const groupModalCloseBtn = groupModal.querySelector('.group-modal-close');
        const groupForm = document.getElementById('groupForm');
        const groupCategorySelect = document.getElementById('groupCategory');
        const groupNameInput = document.getElementById('groupName');
        const groupModalTitle = document.getElementById('groupModalTitle');
        const groupFormSubmitButton = groupForm.querySelector('button[type="submit"]');

        // Modál Kluby
        const clubModal = document.getElementById('clubModal');
        const clubModalCloseBtn = clubModal.querySelector('.club-modal-close');
        const clubForm = document.getElementById('clubForm');
        const clubNameInput = document.getElementById('clubName');
        const clubCategorySelect = document.getElementById('clubCategory');
        const clubGroupSelect = document.getElementById('clubGroup');
        const clubModalTitle = document.getElementById('clubModalTitle');
        const clubFormSubmitButton = clubForm.querySelector('button[type="submit"]');

        // Zobrazované sekcie
        const categoryTable = document.getElementById('categoryTable');
        const categoryTableBody = document.getElementById('categoryTableBody');
        const groupsContentDiv = document.getElementById('groupsContent'); // Flex container for category sections
        const clubsTable = document.getElementById('clubsTable'); // Table for clubs
        const clubsTableBody = document.getElementById('clubsTableBody');


        // Premenné stavu modálov
        let currentCategoryModalMode = 'add';
        let editingCategoryName = null;
        let editingCategoryRow = null;

        let currentGroupModalMode = 'add';
        let editingGroupId = null; // Composite group ID

        let currentClubModalMode = 'add'; // New state variable for clubs
        let editingClubId = null; // Club's auto-generated ID


        // --- Funkcie pre Kategórie (bez zmien v logike) ---
        function addCategoryRowToTable(categoryName) {
             const tr = document.createElement('tr');
             const nameTd = document.createElement('td');
             nameTd.textContent = categoryName;
             const actionsTd = document.createElement('td');
             actionsTd.style.whiteSpace = 'nowrap';

             const renameButton = document.createElement('button');
             renameButton.textContent = 'Premenovať';
             renameButton.classList.add('action-button');
             renameButton.onclick = function() {
                 currentCategoryModalMode = 'edit';
                 editingCategoryName = categoryName;
                 editingCategoryRow = this.closest('tr');
                 categoryModalTitle.textContent = 'Upraviť kategóriu';
                 categoryNameInput.value = categoryName;
                 categoryModal.style.display = 'block';
                 categoryNameInput.focus();
             };

             const deleteButton = document.createElement('button');
             deleteButton.textContent = 'Zmazať';
             deleteButton.classList.add('action-button', 'delete-button');
             deleteButton.onclick = async function() {
                 const row = this.closest('tr');
                 const categoryToDelete = row.querySelector('td:first-child').textContent;

                 if (!confirm(`Naozaj chcete zmazať kategóriu "${categoryToDelete}"? Skupiny a kluby priradené k tejto kategórii/skupinám zostanú bez priradenia!`)) {
                     return;
                 }

                 try {
                     await deleteDoc(doc(categoriesCollectionRef, categoryToDelete));
                     row.remove();
                     console.log(`Kategória "${categoryToDelete}" bola úspešne zmazaná.`);

                      // Refresh displays that might be affected
                      if (window.location.hash === '#skupiny') displayGroupsByCategory();
                      if (window.location.hash === '#kluby') displayClubs(); // Added clubs display refresh

                 } catch (error) {
                     console.error('Chyba pri mazaní kategórie: ', error);
                     alert('Chyba pri mazaní kategórie!');
                 }
             };

             actionsTd.appendChild(renameButton);
             actionsTd.appendChild(deleteButton);
             tr.appendChild(nameTd);
             tr.appendChild(actionsTd);
             categoryTableBody.appendChild(tr);
         }

        async function loadCategoriesTable() { /* ... (unchanged logic) ... */
             try {
                 categoryTableBody.innerHTML = '';
                 const querySnapshot = await getDocs(categoriesCollectionRef);
                 if (querySnapshot.empty) {
                     console.log("Žiadne kategórie nenájdené.");
                     const noDataRow = document.createElement('tr');
                     const td = document.createElement('td');
                     td.colSpan = 2;
                     td.textContent = "Žiadne kategórie zatiaľ pridané.";
                     td.style.textAlign = 'center';
                     noDataRow.appendChild(td);
                     categoryTableBody.appendChild(noDataRow);
                 } else {
                     querySnapshot.forEach((doc) => {
                         const categoryName = doc.id;
                         addCategoryRowToTable(categoryName);
                     });
                     console.log("Kategórie boli načítané a zobrazené.");
                 }
             } catch (error) {
                 console.error('Chyba pri načítaní kategórií: ', error);
                 alert('Chyba pri načítaní kategórií!');
                  const errorRow = document.createElement('tr');
                  const td = document.createElement('td');
                  td.colSpan = 2;
                  td.textContent = "Chyba pri načítaní kategórií.";
                  td.style.textAlign = 'center';
                  errorRow.appendChild(td);
                  categoryTableBody.appendChild(errorRow);
             }
         }


         // --- Funkcie pre Skupiny (logika zápisu používa kompozitné ID, ZMENENÉ ZOBRAZENIE) ---

         // Funkcia na načítanie kategórií a naplnenie <select> v modáli skupiny/klubu
         async function populateCategorySelect(selectedCategoryId = null, selectElement) { // Added selectElement parameter
             selectElement.innerHTML = '<option value="">-- Vyberte kategóriu --</option>';

             try {
                  const querySnapshot = await getDocs(categoriesCollectionRef);
                  if (querySnapshot.empty) {
                      console.log("Žiadne kategórie pre naplnenie selectu.");
                      selectElement.disabled = true; // Disable if no categories
                      const option = document.createElement('option');
                      option.value = "";
                      option.textContent = "-- Najprv pridajte kategórie --";
                      option.disabled = true;
                      selectElement.appendChild(option);

                  } else {
                       selectElement.disabled = false; // Enable if categories exist
                      querySnapshot.forEach((doc) => {
                          const categoryName = doc.id;
                          const option = document.createElement('option');
                          option.value = categoryName;
                          option.textContent = categoryName;
                          selectElement.appendChild(option);
                      });

                      if (selectedCategoryId) {
                           if (selectElement.querySelector(`option[value="${selectedCategoryId}"]`)) {
                                selectElement.value = selectedCategoryId;
                           } else {
                                console.warn(`Kategória "${selectedCategoryId}" pre zvolenú položku nenájdená v zozname kategórií.`);
                                // Optionally keep the "-- Vyberte kategóriu --" selected or add a warning to the user
                           }
                      }
                  }
             } catch (error) {
                 console.error('Chyba pri načítaní kategórií pre select: ', error);
                  selectElement.disabled = true; // Disable on error
                  const option = document.createElement('option');
                  option.value = "";
                  option.textContent = "Chyba pri načítaní kategórií";
                  option.disabled = true;
                  selectElement.appendChild(option);
             }
         }

         // Funkcia na načítanie skupín pre danú kategóriu a naplnenie <select> (používa kompozitné ID)
         async function populateGroupSelect(categoryId, selectElement, selectedGroupId = null) { // Added selectElement, selectedGroupId
             selectElement.innerHTML = '<option value="">-- Vyberte skupinu --</option>';
             selectElement.disabled = true; // Disable until category is selected

             if (!categoryId || categoryId === '-- Vyberte kategóriu --') { // Also check for default option value
                  const option = document.createElement('option');
                  option.value = "";
                  option.textContent = "-- Najprv vyberte kategóriu --";
                  option.disabled = true;
                  selectElement.appendChild(option);
                 return; // No valid category selected, cannot load groups
             }

             selectElement.disabled = false; // Enable the select

             try {
                  const q = query(groupsCollectionRef, where('categoryId', '==', categoryId));
                  const querySnapshot = await getDocs(q);

                  if (querySnapshot.empty) {
                      console.log(`Žiadne skupiny nájdené pre kategóriu "${categoryId}".`);
                      const option = document.createElement('option');
                      option.value = ""; // Use empty value so form validation can trigger
                      option.textContent = "-- Žiadne skupiny v kategórii --";
                      // option.disabled = true; // Don't disable, just indicate
                      selectElement.appendChild(option);

                  } else {
                      console.log(`Načítané skupiny pre kategóriu "${categoryId}".`);
                      querySnapshot.forEach((doc) => {
                          const groupData = doc.data();
                          const groupId = doc.id; // This is the composite ID
                          const groupName = groupData.name;

                          const option = document.createElement('option');
                          option.value = groupId; // Use the composite ID as the option value
                          option.textContent = groupName; // Display the group name
                          selectElement.appendChild(option);
                      });

                      // Select the provided group ID if in edit mode and it exists
                      if (selectedGroupId) {
                           if (selectElement.querySelector(`option[value="${selectedGroupId}"]`)) {
                                selectElement.value = selectedGroupId;
                           } else {
                                console.warn(`Skupina "${selectedGroupId}" pre zvolenú položku nenájdená v zozname skupín pre túto kategóriu.`);
                                // Keep the default "-- Vyberte skupinu --" selected
                           }
                      }
                  }
             } catch (error) {
                 console.error('Chyba pri načítaní skupín pre select: ', error);
                  selectElement.disabled = true; // Disable on error
                  const option = document.createElement('option');
                  option.value = "";
                  option.textContent = "Chyba pri načítaní skupín";
                  option.disabled = true;
                  selectElement.appendChild(option);
             }
         }


        // Funkcia na otvorenie modálu skupiny (pre pridanie alebo úpravu)
        async function openGroupModal(groupId = null, groupData = null) { // groupId is composite ID, groupData has name, categoryId
            groupModal.style.display = 'block';

            // Reset modal state and form first
            currentGroupModalMode = 'add';
            editingGroupId = null; // Clear editing ID
            groupForm.reset(); // Clear form fields
            groupNameInput.disabled = false; // Ensure name input is enabled

            // Disable group select initially and clear it
            // This is handled by populateCategorySelect and its change listener

            if (groupId && groupData) {
                // Edit mode
                currentGroupModalMode = 'edit';
                editingGroupId = groupId; // Store the composite ID of the group being edited
                groupModalTitle.textContent = 'Upraviť skupinu';
                groupFormSubmitButton.textContent = 'Uložiť zmeny'; // Change button text

                // Populate the category select and then set the value
                await populateCategorySelect(groupData.categoryId, groupCategorySelect);

                // Populate the group select based on the selected category and then set the group value
                 if(groupData.categoryId) {
                      // Pass the composite ID (groupId) to populateGroupSelect to select it
                      await populateGroupSelect(groupData.categoryId, groupGroupSelect, groupId);
                 }

                // Fill the form fields
                groupNameInput.value = groupData.name; // Use the 'name' field from data


            } else {
                // Add mode (initial state already set above)
                groupModalTitle.textContent = 'Pridať skupinu';
                groupFormSubmitButton.textContent = 'Uložiť';

                await populateCategorySelect(null, groupCategorySelect); // Populate category select
                 // The group select will be populated when a category is chosen via the change listener
            }

            groupNameInput.focus(); // Set focus
        }

        // Funkcia na zobrazenie skupín usporiadaných podľa kategórií (ZMENENÉ ZOBRAZENIE)
        async function displayGroupsByCategory() {
             groupsContentDiv.innerHTML = ''; // Clear container

             try {
                 // 1. Načítať všetky kategórie
                 const categoriesSnapshot = await getDocs(categoriesCollectionRef);
                 const categories = categoriesSnapshot.docs.map(doc => ({ id: doc.id, data: doc.data() })); // Get ID and data

                 if (categories.length === 0) {
                     const message = document.createElement('p');
                     message.textContent = "Pridajte kategórie v sekcii 'Kategórie' pre zobrazenie skupín.";
                     groupsContentDiv.appendChild(message);
                     return;
                 }

                 // 2. Načítať všetky skupiny
                 const groupsSnapshot = await getDocs(groupsCollectionRef);

                 // 3. Zoskupiť skupiny podľa categoryId
                 const groupsByCategory = {};
                 groupsSnapshot.forEach(doc => {
                     const groupData = doc.data();
                     const groupId = doc.id; // This is the composite ID
                     const categoryId = groupData.categoryId;

                     if (categoryId && categories.some(cat => cat.id === categoryId)) { // Check if category exists
                         if (!groupsByCategory[categoryId]) {
                             groupsByCategory[categoryId] = [];
                         }
                         groupsByCategory[categoryId].push({ id: groupId, data: groupData });
                     } else {
                         console.warn(`Skupina ${groupId} má neplatnú alebo nepriradenú categoryId "${categoryId}".`);
                         // Optional: Add these to a "Unassigned" category
                     }
                 });

                 // 4. Pre každú kategóriu vytvoriť sekciu (div) a v nej samostatnú tabuľku pre každú skupinu
                 categories.forEach(category => {
                     const categoryName = category.id; // Category ID is the name
                     const groupsForThisCategory = groupsByCategory[categoryName] || [];

                     const categorySectionDiv = document.createElement('div');
                     categorySectionDiv.classList.add('category-group-section');

                     const categoryHeading = document.createElement('h2');
                     categoryHeading.textContent = `Skupiny - ${categoryName}`;
                     categorySectionDiv.appendChild(categoryHeading);

                     if (groupsForThisCategory.length === 0) {
                         const message = document.createElement('p'); // Use p instead of empty table row
                         message.textContent = `V kategórii "${categoryName}" zatiaľ nie sú žiadne skupiny.`;
                          message.style.fontSize = '0.9em';
                          message.style.color = '#777';
                          message.style.padding = '5px 12px'; // Match table padding
                         categorySectionDiv.appendChild(message);
                     } else {
                         // Sort groups by name before displaying (optional)
                         groupsForThisCategory.sort((a, b) => (a.data.name || '').localeCompare(b.data.name || ''));

                         groupsForThisCategory.forEach(group => {
                             // --- Create a new table for EACH group ---
                             const groupCardTable = document.createElement('table');
                             groupCardTable.classList.add('group-card-table'); // Apply the new style class

                             const tbody = document.createElement('tbody'); // Use tbody for key-value rows

                             // Row for Group Name
                             const nameRow = document.createElement('tr');
                             const nameHeader = document.createElement('th');
                             nameHeader.textContent = 'Názov:';
                             const nameData = document.createElement('td');
                             nameData.textContent = group.data.name;
                             nameRow.appendChild(nameHeader);
                             nameRow.appendChild(nameData);
                             tbody.appendChild(nameRow);


                             // Row for Actions
                             const actionsRow = document.createElement('tr');
                             const actionsHeader = document.createElement('th');
                             actionsHeader.textContent = 'Akcie:';
                             const actionsData = document.createElement('td');
                             actionsData.style.whiteSpace = 'nowrap';


                             // TLAČIDLO ÚPRAVA SKUPINY - VOLÁ openGroupModal
                             const editGroupButton = document.createElement('button');
                             editGroupButton.textContent = 'Upraviť'; // Shorter text for card style
                             editGroupButton.classList.add('action-button');
                             editGroupButton.onclick = () => {
                                  openGroupModal(group.id, group.data); // Pass the composite group ID and its data
                             };


                             // TLAČIDLO ZMAZAŤ SKUPINU
                             const deleteGroupButton = document.createElement('button');
                             deleteGroupButton.textContent = 'Zmazať'; // Shorter text
                             deleteGroupButton.classList.add('action-button', 'delete-button');
                             deleteGroupButton.onclick = async () => {
                                  if (!confirm(`Naozaj chcete zmazať skupinu "${group.data.name}" z kategórie "${group.data.categoryId}"?`)) {
                                      return;
                                  }
                                  try {
                                       // Use the composite group ID to delete
                                      await deleteDoc(doc(groupsCollectionRef, group.id));
                                      console.log(`Skupina "${group.data.name}" (ID: ${group.id}) bola úspešne zmazaná.`);
                                       displayGroupsByCategory(); // Reload display
                                  } catch (error) {
                                      console.error('Chyba pri mazaní skupiny: ', error);
                                      alert('Chyba pri mazaní skupiny!');
                                  }
                              };

                             actionsData.appendChild(editGroupButton);
                             actionsData.appendChild(deleteGroupButton);
                             actionsRow.appendChild(actionsHeader);
                             actionsRow.appendChild(actionsData);
                             tbody.appendChild(actionsRow);

                             groupCardTable.appendChild(tbody); // Add tbody to the table
                             categorySectionDiv.appendChild(groupCardTable); // Append the group's table to the section div
                         }); // End of groups loop
                     }

                     groupsContentDiv.appendChild(categorySectionDiv); // Append the category section div to the main container
                 }); // End of categories loop


             } catch (error) {
                 console.error('Chyba pri načítaní alebo zobrazovaní skupín: ', error);
                 const errorMessage = document.createElement('p');
                 errorMessage.textContent = 'Chyba pri načítaní dát skupín.';
                 groupsContentDiv.appendChild(errorMessage);
             }
         }


         // --- Funkcie pre Kluby (NOVÉ, bez zmeny logiky zápisu) ---

         // Funkcia na otvorenie modálu klubu
         async function openClubModal(clubId = null, clubData = null) {
             clubModal.style.display = 'block';

             // Reset modal state and form first
             currentClubModalMode = 'add';
             editingClubId = null;
             clubForm.reset();
             clubNameInput.disabled = false;

             // Populate category select (awaits categories)
             await populateCategorySelect(null, clubCategorySelect);

             // Reset and disable group select initially
             clubGroupSelect.innerHTML = '<option value="">-- Najprv vyberte kategóriu --</option>';
             clubGroupSelect.disabled = true;


             if (clubId && clubData) {
                 // Edit mode
                 currentClubModalMode = 'edit';
                 editingClubId = clubId;
                 clubModalTitle.textContent = 'Upraviť klub';
                 clubFormSubmitButton.textContent = 'Uložiť zmeny';

                 // Populate category select and set value
                 // populateCategorySelect was already awaited above
                 clubCategorySelect.value = clubData.categoryId || '';
                 // Check if value setting worked, if not, maybe add a warning


                 // Populate group select based on selected category and set value
                 if(clubData.categoryId) {
                      await populateGroupSelect(clubData.categoryId, clubGroupSelect, clubData.groupId); // Pass composite group ID to select
                 }

                 // Fill the form fields
                 clubNameInput.value = clubData.name;


             } else {
                 // Add mode (initial state already set above)
                 clubModalTitle.textContent = 'Pridať klub';
                 clubFormSubmitButton.textContent = 'Uložiť';

                  // populateCategorySelect was already awaited above
                 // Group select remains disabled until category is chosen
             }

             clubNameInput.focus(); // Set focus
         }

         // Funkcia na zobrazenie klubov (logika sa nemení, len formátovanie)
         async function displayClubs() {
             clubsTableBody.innerHTML = '';

             try {
                 const clubsSnapshot = await getDocs(clubsCollectionRef);

                 if (clubsSnapshot.empty) {
                     console.log("Žiadne kluby nenájdené.");
                     const noDataRow = document.createElement('tr');
                     const td = document.createElement('td');
                     td.colSpan = 4;
                     td.textContent = "Žiadne kluby zatiaľ pridané.";
                     td.style.textAlign = 'center';
                     noDataRow.appendChild(td);
                     clubsTableBody.appendChild(noDataRow);
                 } else {
                     console.log("Načítavam kluby.");
                      // Optional: Sort clubs by name or category
                      const sortedClubs = clubsSnapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
                       sortedClubs.sort((a, b) => (a.data.name || '').localeCompare(b.data.name || ''));


                      sortedClubs.forEach((club) => { // Iterate through sorted clubs
                         const clubData = club.data;
                         const clubId = club.id;

                         const tr = document.createElement('tr');

                         const nameTd = document.createElement('td');
                         nameTd.textContent = clubData.name;

                         const categoryTd = document.createElement('td');
                         categoryTd.textContent = clubData.categoryId || 'Nezaradené';

                         const groupTd = document.createElement('td');
                         // Extract group name from composite ID "Category - GroupName"
                          const groupNameFromId = clubData.groupId ? clubData.groupId.split(' - ')[1] || clubData.groupId : 'Nezaradená';
                          groupTd.textContent = groupNameFromId;


                         const actionsTd = document.createElement('td');
                         actionsTd.style.whiteSpace = 'nowrap';

                         // === TLAČIDLO ÚPRAVA KLUBU ===
                         const editClubButton = document.createElement('button');
                         editClubButton.textContent = 'Upraviť';
                         editClubButton.classList.add('action-button');
                         editClubButton.onclick = () => {
                              openClubModal(clubId, clubData);
                         };

                         // === TLAČIDLO ZMAZAŤ KLUBU ===
                         const deleteClubButton = document.createElement('button');
                         deleteClubButton.textContent = 'Zmazať';
                         deleteClubButton.classList.add('action-button', 'delete-button');
                         deleteClubButton.onclick = async () => {
                              if (!confirm(`Naozaj chcete zmazať klub "${clubData.name}"?`)) {
                                  return;
                              }
                              try {
                                  await deleteDoc(doc(clubsCollectionRef, clubId));
                                  console.log(`Klub "${clubData.name}" (ID: ${clubId}) bol úspešne zmazaný.`);
                                   displayClubs();
                              } catch (error) {
                                  console.error('Chyba pri mazaní klubu: ', error);
                                  alert('Chyba pri mazaní klubu!');
                              }
                          };

                         actionsTd.appendChild(editClubButton);
                         actionsTd.appendChild(deleteClubButton);

                         tr.appendChild(nameTd);
                         tr.appendChild(categoryTd);
                         tr.appendChild(groupTd);
                         tr.appendChild(actionsTd);

                         clubsTableBody.appendChild(tr);
                     });
                     console.log("Kluby boli načítané a zobrazené.");
                 }

             } catch (error) {
                 console.error('Chyba pri načítaní alebo zobrazovaní klubov: ', error);
                 const errorMessage = document.createElement('tr');
                 const td = document.createElement('td');
                 td.colSpan = 4;
                 td.textContent = 'Chyba pri načítaní dát klubov.';
                 td.style.textAlign = 'center';
                 errorMessage.appendChild(td);
                 clubsTableBody.appendChild(errorMessage);
             }
         }


        // --- Funkcia na prepínanie zobrazenia obsahu ---
        function toggleContentDisplay() {
            const hash = window.location.hash;
            console.log("Navigating to hash:", hash);

            // Skryť všetky dynamické oblasti a modály
            addButton.style.display = 'none';
            categoryTable.style.display = 'none';
            groupsContentDiv.style.display = 'none'; // Hide groups flex container
            clubsTable.style.display = 'none'; // Hide clubs table

            categoryModal.style.display = 'none'; // Hide modals
            groupModal.style.display = 'none';
            clubModal.style.display = 'none'; // Hide club modal

            // Vyčistiť obsah dynamických oblastí
            categoryTableBody.innerHTML = '';
            groupsContentDiv.innerHTML = ''; // Clear groups flex container
            clubsTableBody.innerHTML = ''; // Clear clubs table body


            // Reset modal states and forms when navigating away
            currentCategoryModalMode = 'add'; editingCategoryName = null; editingCategoryRow = null;
            categoryForm.reset();

            currentGroupModalMode = 'add'; editingGroupId = null;
            groupForm.reset();

            currentClubModalMode = 'add'; editingClubId = null;
            clubForm.reset();


            if (hash === '#kategorie') {
                addButton.style.display = 'block';
                categoryTable.style.display = 'table';
                loadCategoriesTable();
                addButton.title = "Pridať kategóriu";
            } else if (hash === '#skupiny') {
                addButton.style.display = 'block';
                groupsContentDiv.style.display = 'flex'; // Show groups as flex container
                displayGroupsByCategory();
                addButton.title = "Pridať skupinu";
            } else if (hash === '#kluby') {
                 addButton.style.display = 'block';
                 clubsTable.style.display = 'table';
                 displayClubs();
                 addButton.title = "Pridať klub";
            } else {
                addButton.style.display = 'none';
                addButton.title = "Pridať položku";
                console.log("Neznáma sekcia, zobrazujem prázdny obsah.");
            }
        }


        // --- Event Listeners ---

        // Spoločná obsluha kliknutia na tlačidlo Pridať (+)
        addButton.addEventListener('click', () => {
            const hash = window.location.hash;
            if (hash === '#kategorie') {
                 currentCategoryModalMode = 'add'; editingCategoryName = null; editingCategoryRow = null;
                 categoryModalTitle.textContent = 'Pridať kategóriu'; categoryForm.reset();
                 categoryModal.style.display = 'block'; categoryNameInput.focus();
            } else if (hash === '#skupiny') {
                 openGroupModal();
            } else if (hash === '#kluby') {
                 openClubModal();
            }
        });


        // Obsluha zatvorenia modálov (kliknutie na X)
        categoryModalCloseBtn.addEventListener('click', () => {
            categoryModal.style.display = 'none';
            currentCategoryModalMode = 'add'; editingCategoryName = null; editingCategoryRow = null;
            categoryForm.reset();
        });

        groupModalCloseBtn.addEventListener('click', () => {
            groupModal.style.display = 'none';
            currentGroupModalMode = 'add'; editingGroupId = null;
            groupForm.reset();
        });

         clubModalCloseBtn.addEventListener('click', () => {
            clubModal.style.display = 'none';
            currentClubModalMode = 'add'; editingClubId = null;
            clubForm.reset();
        });


        // Obsluha zatvorenia modálov (kliknutie mimo modal)
        window.addEventListener('click', (e) => {
            if (e.target === categoryModal) {
                 categoryModal.style.display = 'none';
                 currentCategoryModalMode = 'add'; editingCategoryName = null; editingCategoryRow = null;
                 categoryForm.reset();
            }
            if (e.target === groupModal) {
                 groupModal.style.display = 'none';
                 currentGroupModalMode = 'add'; editingGroupId = null;
                 groupForm.reset();
            }
             if (e.target === clubModal) {
                 clubModal.style.display = 'none';
                 currentClubModalMode = 'add'; editingClubId = null;
                 clubForm.reset();
             }
        });


        // Spustíme toggleContentDisplay pri načítaní stránky a zmene hašu
        window.addEventListener('hashchange', toggleContentDisplay);
        window.addEventListener('load', toggleContentDisplay);


        // Obsluha formulára na pridanie/úpravu kategórie
        categoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const categoryName = categoryNameInput.value.trim();
            if (categoryName === '') { alert('Názov kategórie nemôže byť prázdny.'); return; }

            if (currentCategoryModalMode === 'add') {
                 const categoryDocRef = doc(categoriesCollectionRef, categoryName);
                 try {
                     const existingDoc = await getDoc(categoryDocRef);
                     if (existingDoc.exists()) { alert(`Kategória "${categoryName}" už existuje!`); return; }
                     await setDoc(categoryDocRef, { createdAt: new Date() });
                     addCategoryRowToTable(categoryName);
                     console.log(`Kategória "${categoryName}" bola úspešne pridaná.`);
                     categoryModal.style.display = 'none'; categoryForm.reset();
                     currentCategoryModalMode = 'add'; editingCategoryName = null; editingCategoryRow = null;
                      if (window.location.hash === '#skupiny') displayGroupsByCategory();
                      if (window.location.hash === '#kluby') displayClubs();
                 } catch (error) {
                     console.error('Chyba pri pridávaní kategórie: ', error);
                     alert('Chyba pri pridávaní kategórie!');
                 }
            } else if (currentCategoryModalMode === 'edit') {
                 const oldCategoryName = editingCategoryName;
                 const rowToUpdate = editingCategoryRow;
                 const newCategoryName = categoryName;
                 if (!oldCategoryName || !rowToUpdate) { console.error("Chyba: Úprava kategórie v režime 'edit' bez pôvodného názvu alebo referencie na riadok."); alert("Chyba pri úprave kategórie. Prosím, obnovte stránku a skúste znova."); currentCategoryModalMode = 'add'; editingCategoryName = null; editingCategoryRow = null; categoryModal.style.display = 'none'; categoryForm.reset(); return; }
                 if (newCategoryName === oldCategoryName) { console.log('Nový názov kategórie je rovnaký ako pôvodný. Žiadna zmena.'); currentCategoryModalMode = 'add'; editingCategoryName = null; editingCategoryRow = null; categoryModal.style.display = 'none'; categoryForm.reset(); return; }
                 const newCategoryDocRef = doc(categoriesCollectionRef, newCategoryName);
                 try {
                      const existingDoc = await getDoc(newCategoryDocRef);
                      if (existingDoc.exists()) { alert(`Kategória s názvom "${newCategoryName}" už existuje!`); return; }
                      const oldCategoryDocRef = doc(categoriesCollectionRef, oldCategoryName);
                      const oldDocSnapshot = await getDoc(oldCategoryDocRef); if (!oldDocSnapshot.exists()) { console.error(`Stará kategória "${oldCategoryName}" nenájdená pre premenovanie.`); alert('Chyba: Pôvodná kategória nebola nájdená pre úpravu.'); currentCategoryModalMode = 'add'; editingCategoryName = null; editingCategoryRow = null; categoryModal.style.display = 'none'; categoryForm.reset(); return; }
                      const oldDocData = oldDocSnapshot.data();
                      const batch = writeBatch(db);
                      batch.set(newCategoryDocRef, oldDocData);
                      batch.delete(oldCategoryDocRef);
                      await batch.commit();
                      rowToUpdate.querySelector('td:first-child').textContent = newCategoryName;
                      console.warn(`Premenovanie kategórie "${oldCategoryName}" na "${newCategoryName}" bolo úspešné.`);
                      console.warn(`POZNÁMKA: Skupiny s categoryId "${oldCategoryName}" NEBOLI automaticky aktualizované na "${newCategoryName}".`);
                      currentCategoryModalMode = 'add'; editingCategoryName = null; editingCategoryRow = null;
                      categoryModal.style.display = 'none'; categoryForm.reset();
                       if (window.location.hash === '#skupiny') displayGroupsByCategory();
                       if (window.location.hash === '#kluby') displayClubs();
                 } catch (error) {
                     console.error('Chyba pri premenovaní kategórie: ', error);
                     alert('Chyba pri premenovaní kategórie! Prosím, skúste znova.');
                     currentCategoryModalMode = 'add'; editingCategoryName = null; editingCategoryRow = null;
                     categoryModal.style.display = 'none'; form.reset();
                 }
            }
         });


         // --- Obsluha formulára Skupiny (používa kompozitné ID) ---
         groupForm.addEventListener('submit', async (e) => {
             e.preventDefault();

             const selectedCategoryId = groupCategorySelect.value;
             const groupName = groupNameInput.value.trim();

             if (selectedCategoryId === '' || selectedCategoryId === '-- Vyberte kategóriu --') { alert('Prosím, vyberte platnú kategóriu pre skupinu.'); return; }
             if (groupName === '') { alert('Názov skupiny nemôže byť prázdny.'); return; }

             const compositeGroupId = `${selectedCategoryId} - ${groupName}`;
             const groupDocRef = doc(groupsCollectionRef, compositeGroupId);

             try {
                 const existingDoc = await getDoc(groupDocRef);

                 if (currentGroupModalMode === 'add') {
                     if (existingDoc.exists()) {
                         alert(`Skupina s názvom "${groupName}" už v kategórii "${selectedCategoryId}" existuje! Názvy skupín musia byť unikátne v rámci kategórie.`);
                         return;
                     }
                     await setDoc(groupDocRef, { name: groupName, categoryId: selectedCategoryId });
                     console.log(`Skupina "${groupName}" (ID: ${compositeGroupId}) bola úspešne pridaná do kategórie "${selectedCategoryId}".`);

                 } else if (currentGroupModalMode === 'edit') {
                     const oldGroupId = editingGroupId;
                     if (!oldGroupId) { console.error("Chyba: Režim úpravy skupiny bez platného editingGroupId."); alert("Chyba pri úprave skupiny. Prosím, obnovte stránku."); groupModal.style.display = 'none'; groupForm.reset(); currentGroupModalMode = 'add'; editingGroupId = null; return; }

                     if (oldGroupId !== compositeGroupId) {
                          console.log(`Premenovanie/presun skupiny z "${oldGroupId}" na "${compositeGroupId}".`);
                          if (existingDoc.exists()) {
                               alert(`Skupina s názvom "${groupName}" už v kategórii "${selectedCategoryId}" existuje (iná skupina)! Názvy skupín musia byť unikátne v rámci kategórie.`);
                               return;
                          }
                          const oldGroupDocRef = doc(groupsCollectionRef, oldGroupId);
                           const batch = writeBatch(db);
                           batch.set(groupDocRef, { name: groupName, categoryId: selectedCategoryId });
                           batch.delete(oldGroupDocRef);
                           await batch.commit();
                           console.log(`Skupina úspešne premenovaná/presunutá z ID "${oldGroupId}" na "${compositeGroupId}".`);
                           console.warn("POZNÁMKA: Premenovaním/presunom skupiny sa zmenilo jej ID vo Firestore. Ak iné dáta odkazujú na túto skupinu pomocou jej ID, musia byť aktualizované manuálne!");

                     } else {
                         console.log(`Úprava údajov pre skupinu s ID "${oldGroupId}". Kompozitné ID sa nemení.`);
                         await updateDoc(groupDocRef, { name: groupName, categoryId: selectedCategoryId });
                         console.log(`Skupina s ID "${oldGroupId}" úspešne upravená.`);
                     }
                 }

                 groupModal.style.display = 'none'; groupForm.reset();
                 currentGroupModalMode = 'add'; editingGroupId = null;

                 if (window.location.hash === '#skupiny') displayGroupsByCategory();
                 if (window.location.hash === '#kluby') displayClubs(); // Added refresh for clubs

             } catch (error) {
                 console.error('Chyba pri kontrole unikátnosti alebo zápise skupiny: ', error);
                 alert(`Chyba pri ukladaní skupiny! Detail: ${error.message}`);
                 groupModal.style.display = 'none'; groupForm.reset();
                 currentGroupModalMode = 'add'; editingGroupId = null;
             }
         });

         // --- Obsluha formulára Kluby ---
         clubForm.addEventListener('submit', async (e) => {
             e.preventDefault();

             const clubName = clubNameInput.value.trim();
             const selectedCategoryId = clubCategorySelect.value;
             const selectedGroupId = clubGroupSelect.value; // This is the composite group ID

             if (clubName === '') {
                 alert('Názov klubu nemôže byť prázdny.');
                 return;
             }
              if (clubCategorySelect.disabled === false && (selectedCategoryId === '' || selectedCategoryId === '-- Vyberte kategóriu --' || selectedCategoryId === '-- Najprv pridajte kategórie --')) { // Ensure valid category value
                  alert('Prosím, vyberte platnú kategóriu pre klub.');
                  return;
             }
              if (clubGroupSelect.disabled === false && (selectedGroupId === '' || selectedGroupId === '-- Vyberte skupinu --' || selectedGroupId === '-- Žiadne skupiny v kategórii --' || selectedGroupId === '-- Najprv vyberte kategóriu --')) { // Ensure valid group value
                  alert('Prosím, vyberte platnú skupinu pre klub.');
                  return;
             }


             try {
                 if (currentClubModalMode === 'add') {
                      const newClubRef = await addDoc(clubsCollectionRef, {
                         name: clubName,
                         categoryId: selectedCategoryId,
                         groupId: selectedGroupId
                     });

                     console.log(`Klub "${clubName}" (ID: ${newClubRef.id}) úspešne pridaný do kategórie "${selectedCategoryId}" a skupiny "${selectedGroupId}".`);

                 } else if (currentClubModalMode === 'edit') {
                     const clubId = editingClubId;
                     if (!clubId) { console.error("Chyba: Režim úpravy klubu bez platného editingClubId."); alert("Chyba pri úprave klubu. Prosím, obnovte stránku."); clubModal.style.display = 'none'; clubForm.reset(); currentClubModalMode = 'add'; editingClubId = null; return; }

                     const clubDocRef = doc(clubsCollectionRef, clubId);
                     await updateDoc(clubDocRef, {
                         name: clubName,
                         categoryId: selectedCategoryId,
                         groupId: selectedGroupId
                     });

                     console.log(`Klub s ID "${clubId}" úspešne upravený (názov "${clubName}", kategória "${selectedCategoryId}", skupina "${selectedGroupId}").`);
                 }

                 clubModal.style.display = 'none'; clubForm.reset();
                 currentClubModalMode = 'add'; editingClubId = null;

                 if (window.location.hash === '#kluby') displayClubs();

             } catch (error) {
                 console.error('Chyba pri ukladaní klubu: ', error);
                 alert(`Chyba pri ukladaní klubu! Detail: ${error.message}`);
                 clubModal.style.display = 'none'; clubForm.reset();
                 currentClubModalMode = 'add'; editingClubId = null;
             }
         });

         // --- Event Listener pre zmenu kategórie v modáli klubu ---
         clubCategorySelect.addEventListener('change', () => {
             const selectedCategoryId = clubCategorySelect.value;
             // Pass the select element reference
             populateGroupSelect(selectedCategoryId, clubGroupSelect);
         });

         // --- Event Listener pre zmenu kategórie v modáli skupiny ---
         groupCategorySelect.addEventListener('change', () => {
             const selectedCategoryId = groupCategorySelect.value;
             // Pass the select element reference
             populateGroupSelect(selectedCategoryId, groupGroupSelect); // Note: Pass groupGroupSelect here
         });


    </script>

</body>
</html>
